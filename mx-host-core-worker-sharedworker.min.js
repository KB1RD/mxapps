!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("mx-host-core-worker",[],t):"object"==typeof exports?exports["mx-host-core-worker"]=t():e["mx-host-core-worker"]=t()}("undefined"!=typeof self?self:this,(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=181)}([function(e,t,r){"undefined"!=typeof self&&self,e.exports=function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=78)}([function(e,t,r){var n=r(33),o=r(34),i=r(18),s=r(35);e.exports=function(e){return n(e)||o(e)||i(e)||s()}},function(e,t){e.exports=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}},function(e,t){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},function(e,t,r){e.exports=r(39)},function(e,t,r){"use strict";function n(e,t,r,n){var o=n?" !== ":" === ",i=n?" || ":" && ",s=n?"!":"",a=n?"":"!";switch(e){case"null":return t+o+"null";case"array":return s+"Array.isArray("+t+")";case"object":return"("+s+t+i+"typeof "+t+o+'"object"'+i+a+"Array.isArray("+t+"))";case"integer":return"(typeof "+t+o+'"number"'+i+a+"("+t+" % 1)"+i+t+o+t+(r?i+s+"isFinite("+t+")":"")+")";case"number":return"(typeof "+t+o+'"'+e+'"'+(r?i+s+"isFinite("+t+")":"")+")";default:return"typeof "+t+o+'"'+e+'"'}}e.exports={copy:function(e,t){for(var r in t=t||{},e)t[r]=e[r];return t},checkDataType:n,checkDataTypes:function(e,t,r){switch(e.length){case 1:return n(e[0],t,r,!0);default:var o="",s=i(e);for(var a in s.array&&s.object&&(o=s.null?"(":"(!"+t+" || ",o+="typeof "+t+' !== "object")',delete s.null,delete s.array,delete s.object),s.number&&delete s.integer,s)o+=(o?" && ":"")+n(a,t,r,!0);return o}},coerceToTypes:function(e,t){if(Array.isArray(t)){for(var r=[],n=0;n<t.length;n++){var i=t[n];(o[i]||"array"===e&&"array"===i)&&(r[r.length]=i)}if(r.length)return r}else{if(o[t])return[t];if("array"===e&&"array"===t)return["array"]}},toHash:i,getProperty:c,escapeQuotes:u,equal:r(14),ucs2length:r(47),varOccurences:function(e,t){t+="[^0-9]";var r=e.match(new RegExp(t,"g"));return r?r.length:0},varReplace:function(e,t,r){return t+="([^0-9])",r=r.replace(/\$/g,"$$$$"),e.replace(new RegExp(t,"g"),r+"$1")},schemaHasRules:function(e,t){if("boolean"==typeof e)return!e;for(var r in e)if(t[r])return!0},schemaHasRulesExcept:function(e,t,r){if("boolean"==typeof e)return!e&&"not"!=r;for(var n in e)if(n!=r&&t[n])return!0},schemaUnknownRules:function(e,t){if("boolean"!=typeof e)for(var r in e)if(!t[r])return r},toQuotedString:l,getPathExpr:function(e,t,r,n){return p(e,r?"'/' + "+t+(n?"":".replace(/~/g, '~0').replace(/\\//g, '~1')"):n?"'[' + "+t+" + ']'":"'[\\'' + "+t+" + '\\']'")},getPath:function(e,t,r){return p(e,l(r?"/"+f(t):c(t)))},getData:function(e,t,r){var n,o,i,s;if(""===e)return"rootData";if("/"==e[0]){if(!d.test(e))throw new Error("Invalid JSON-pointer: "+e);o=e,i="rootData"}else{if(!(s=e.match(h)))throw new Error("Invalid JSON-pointer: "+e);if(n=+s[1],"#"==(o=s[2])){if(n>=t)throw new Error("Cannot access property/index "+n+" levels up, current level is "+t);return r[t-n]}if(n>t)throw new Error("Cannot access data "+n+" levels up, current level is "+t);if(i="data"+(t-n||""),!o)return i}for(var a=i,u=o.split("/"),l=0;l<u.length;l++){var p=u[l];p&&(a+=" && "+(i+=c(m(p))))}return a},unescapeFragment:function(e){return m(decodeURIComponent(e))},unescapeJsonPointer:m,escapeFragment:function(e){return encodeURIComponent(f(e))},escapeJsonPointer:f};var o=i(["string","number","integer","boolean","null"]);function i(e){for(var t={},r=0;r<e.length;r++)t[e[r]]=!0;return t}var s=/^[a-z$_][a-z$_0-9]*$/i,a=/'|\\/g;function c(e){return"number"==typeof e?"["+e+"]":s.test(e)?"."+e:"['"+u(e)+"']"}function u(e){return e.replace(a,"\\$&").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\f/g,"\\f").replace(/\t/g,"\\t")}function l(e){return"'"+u(e)+"'"}var d=/^\/(?:[^~]|~0|~1)*$/,h=/^([0-9]+)(#|\/(?:[^~]|~0|~1)*)?$/;function p(e,t){return'""'==e?t:(e+" + "+t).replace(/([^\\])' \+ '/g,"$1")}function f(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}function m(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}},function(e,t){function r(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}e.exports=function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}},function(e,t){e.exports=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}},function(e,t){function r(t){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?e.exports=r=function(e){return typeof e}:e.exports=r=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(t)}e.exports=r},function(e,t){function r(t){return e.exports=r=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},r(t)}e.exports=r},function(e,t,r){var n=r(12);e.exports=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&n(e,t)}},function(e,t,r){var n=r(8),o=r(12),i=r(41),s=r(42);function a(t){var r="function"==typeof Map?new Map:void 0;return e.exports=a=function(e){if(null===e||!i(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,t)}function t(){return s(e,arguments,n(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),o(t,e)},a(t)}e.exports=a},function(e,t,r){"use strict";var n=r(45),o=r(13),i=r(49),s=r(20),a=r(21),c=r(50),u=r(51),l=r(72),d=r(4);e.exports=v,v.prototype.validate=function(e,t){var r;if("string"==typeof e){if(!(r=this.getSchema(e)))throw new Error('no schema with key or ref "'+e+'"')}else{var n=this._addSchema(e);r=n.validate||this._compile(n)}var o=r(t);return!0!==r.$async&&(this.errors=r.errors),o},v.prototype.compile=function(e,t){var r=this._addSchema(e,void 0,t);return r.validate||this._compile(r)},v.prototype.addSchema=function(e,t,r,n){if(Array.isArray(e)){for(var i=0;i<e.length;i++)this.addSchema(e[i],void 0,r,n);return this}var s=this._getId(e);if(void 0!==s&&"string"!=typeof s)throw new Error("schema id must be string");return w(this,t=o.normalizeId(t||s)),this._schemas[t]=this._addSchema(e,r,n,!0),this},v.prototype.addMetaSchema=function(e,t,r){return this.addSchema(e,t,r,!0),this},v.prototype.validateSchema=function(e,t){var r=e.$schema;if(void 0!==r&&"string"!=typeof r)throw new Error("$schema must be a string");if(!(r=r||this._opts.defaultMeta||function(e){var t=e._opts.meta;return e._opts.defaultMeta="object"==typeof t?e._getId(t)||t:e.getSchema(f)?f:void 0,e._opts.defaultMeta}(this)))return this.logger.warn("meta-schema not available"),this.errors=null,!0;var n=this.validate(r,e);if(!n&&t){var o="schema is invalid: "+this.errorsText();if("log"!=this._opts.validateSchema)throw new Error(o);this.logger.error(o)}return n},v.prototype.getSchema=function(e){var t=y(this,e);switch(typeof t){case"object":return t.validate||this._compile(t);case"string":return this.getSchema(t);case"undefined":return function(e,t){var r=o.schema.call(e,{schema:{}},t);if(r){var i=r.schema,a=r.root,c=r.baseId,u=n.call(e,i,a,void 0,c);return e._fragments[t]=new s({ref:t,fragment:!0,schema:i,root:a,baseId:c,validate:u}),u}}(this,e)}},v.prototype.removeSchema=function(e){if(e instanceof RegExp)return _(this,this._schemas,e),_(this,this._refs,e),this;switch(typeof e){case"undefined":return _(this,this._schemas),_(this,this._refs),this._cache.clear(),this;case"string":var t=y(this,e);return t&&this._cache.del(t.cacheKey),delete this._schemas[e],delete this._refs[e],this;case"object":var r=this._opts.serialize,n=r?r(e):e;this._cache.del(n);var i=this._getId(e);i&&(i=o.normalizeId(i),delete this._schemas[i],delete this._refs[i])}return this},v.prototype.addFormat=function(e,t){return"string"==typeof t&&(t=new RegExp(t)),this._formats[e]=t,this},v.prototype.errorsText=function(e,t){if(!(e=e||this.errors))return"No errors";for(var r=void 0===(t=t||{}).separator?", ":t.separator,n=void 0===t.dataVar?"data":t.dataVar,o="",i=0;i<e.length;i++){var s=e[i];s&&(o+=n+s.dataPath+" "+s.message+r)}return o.slice(0,-r.length)},v.prototype._addSchema=function(e,t,r,n){if("object"!=typeof e&&"boolean"!=typeof e)throw new Error("schema should be object or boolean");var i=this._opts.serialize,a=i?i(e):e,c=this._cache.get(a);if(c)return c;n=n||!1!==this._opts.addUsedSchema;var u=o.normalizeId(this._getId(e));u&&n&&w(this,u);var l,d=!1!==this._opts.validateSchema&&!t;d&&!(l=u&&u==o.normalizeId(e.$schema))&&this.validateSchema(e,!0);var h=o.ids.call(this,e),p=new s({id:u,schema:e,localRefs:h,cacheKey:a,meta:r});return"#"!=u[0]&&n&&(this._refs[u]=p),this._cache.put(a,p),d&&l&&this.validateSchema(e,!0),p},v.prototype._compile=function(e,t){if(e.compiling)return e.validate=i,i.schema=e.schema,i.errors=null,i.root=t||i,!0===e.schema.$async&&(i.$async=!0),i;var r,o;e.compiling=!0,e.meta&&(r=this._opts,this._opts=this._metaOpts);try{o=n.call(this,e.schema,t,e.localRefs)}catch(t){throw delete e.validate,t}finally{e.compiling=!1,e.meta&&(this._opts=r)}return e.validate=o,e.refs=o.refs,e.refVal=o.refVal,e.root=o.root,o;function i(){var t=e.validate,r=t.apply(this,arguments);return i.errors=t.errors,r}},v.prototype.compileAsync=r(73);var h=r(74);v.prototype.addKeyword=h.add,v.prototype.getKeyword=h.get,v.prototype.removeKeyword=h.remove,v.prototype.validateKeyword=h.validate;var p=r(15);v.ValidationError=p.Validation,v.MissingRefError=p.MissingRef,v.$dataMetaSchema=l;var f="http://json-schema.org/draft-07/schema",m=["removeAdditional","useDefaults","coerceTypes","strictDefaults"],g=["/properties"];function v(e){if(!(this instanceof v))return new v(e);e=this._opts=d.copy(e)||{},function(e){var t=e._opts.logger;if(!1===t)e.logger={log:R,warn:R,error:R};else{if(void 0===t&&(t=console),!("object"==typeof t&&t.log&&t.warn&&t.error))throw new Error("logger must implement log, warn and error methods");e.logger=t}}(this),this._schemas={},this._refs={},this._fragments={},this._formats=c(e.format),this._cache=e.cache||new i,this._loadingSchemas={},this._compilations=[],this.RULES=u(),this._getId=function(e){switch(e.schemaId){case"auto":return S;case"id":return b;default:return E}}(e),e.loopRequired=e.loopRequired||1/0,"property"==e.errorDataPath&&(e._errorDataPathProperty=!0),void 0===e.serialize&&(e.serialize=a),this._metaOpts=function(e){for(var t=d.copy(e._opts),r=0;r<m.length;r++)delete t[m[r]];return t}(this),e.formats&&function(e){for(var t in e._opts.formats){var r=e._opts.formats[t];e.addFormat(t,r)}}(this),e.keywords&&function(e){for(var t in e._opts.keywords){var r=e._opts.keywords[t];e.addKeyword(t,r)}}(this),function(e){var t;if(e._opts.$data&&(t=r(77),e.addMetaSchema(t,t.$id,!0)),!1!==e._opts.meta){var n=r(27);e._opts.$data&&(n=l(n,g)),e.addMetaSchema(n,f,!0),e._refs["http://json-schema.org/schema"]=f}}(this),"object"==typeof e.meta&&this.addMetaSchema(e.meta),e.nullable&&this.addKeyword("nullable",{metaSchema:{type:"boolean"}}),function(e){var t=e._opts.schemas;if(t)if(Array.isArray(t))e.addSchema(t);else for(var r in t)e.addSchema(t[r],r)}(this)}function y(e,t){return t=o.normalizeId(t),e._schemas[t]||e._refs[t]||e._fragments[t]}function _(e,t,r){for(var n in t){var o=t[n];o.meta||r&&!r.test(n)||(e._cache.del(o.cacheKey),delete t[n])}}function b(e){return e.$id&&this.logger.warn("schema $id ignored",e.$id),e.id}function E(e){return e.id&&this.logger.warn("schema id ignored",e.id),e.$id}function S(e){if(e.$id&&e.id&&e.$id!=e.id)throw new Error("schema $id is different from id");return e.$id||e.id}function w(e,t){if(e._schemas[t]||e._refs[t])throw new Error('schema with key or id "'+t+'" already exists')}function R(){}},function(e,t){function r(t,n){return e.exports=r=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},r(t,n)}e.exports=r},function(e,t,r){"use strict";var n=r(46),o=r(14),i=r(4),s=r(20),a=r(48);function c(e,t,r){var n=this._refs[r];if("string"==typeof n){if(!this._refs[n])return c.call(this,e,t,n);n=this._refs[n]}if((n=n||this._schemas[r])instanceof s)return f(n.schema,this._opts.inlineRefs)?n.schema:n.validate||this._compile(n);var o,i,a,l=u.call(this,t,r);return l&&(o=l.schema,t=l.root,a=l.baseId),o instanceof s?i=o.validate||e.call(this,o.schema,t,void 0,a):void 0!==o&&(i=f(o,this._opts.inlineRefs)?o:e.call(this,o,t,void 0,a)),i}function u(e,t){var r=n.parse(t),o=g(r),i=m(this._getId(e.schema));if(0===Object.keys(e.schema).length||o!==i){var a=y(o),c=this._refs[a];if("string"==typeof c)return l.call(this,e,c,r);if(c instanceof s)c.validate||this._compile(c),e=c;else{if(!((c=this._schemas[a])instanceof s))return;if(c.validate||this._compile(c),a==y(t))return{schema:c,root:e,baseId:i};e=c}if(!e.schema)return;i=m(this._getId(e.schema))}return h.call(this,r,i,e.schema,e)}function l(e,t,r){var n=u.call(this,e,t);if(n){var o=n.schema,i=n.baseId;e=n.root;var s=this._getId(o);return s&&(i=_(i,s)),h.call(this,r,i,o,e)}}e.exports=c,c.normalizeId=y,c.fullPath=m,c.url=_,c.ids=function(e){var t=y(this._getId(e)),r={"":t},s={"":m(t,!1)},c={},u=this;return a(e,{allKeys:!0},(function(e,t,a,l,d,h,p){if(""!==t){var f=u._getId(e),m=r[l],g=s[l]+"/"+d;if(void 0!==p&&(g+="/"+("number"==typeof p?p:i.escapeFragment(p))),"string"==typeof f){f=m=y(m?n.resolve(m,f):f);var v=u._refs[f];if("string"==typeof v&&(v=u._refs[v]),v&&v.schema){if(!o(e,v.schema))throw new Error('id "'+f+'" resolves to more than one schema')}else if(f!=y(g))if("#"==f[0]){if(c[f]&&!o(e,c[f]))throw new Error('id "'+f+'" resolves to more than one schema');c[f]=e}else u._refs[f]=g}r[t]=m,s[t]=g}})),c},c.inlineRef=f,c.schema=u;var d=i.toHash(["properties","patternProperties","enum","dependencies","definitions"]);function h(e,t,r,n){if(e.fragment=e.fragment||"","/"==e.fragment.slice(0,1)){for(var o=e.fragment.split("/"),s=1;s<o.length;s++){var a=o[s];if(a){if(void 0===(r=r[a=i.unescapeFragment(a)]))break;var c;if(!d[a]&&((c=this._getId(r))&&(t=_(t,c)),r.$ref)){var l=_(t,r.$ref),h=u.call(this,n,l);h&&(r=h.schema,n=h.root,t=h.baseId)}}}return void 0!==r&&r!==n.schema?{schema:r,root:n,baseId:t}:void 0}}var p=i.toHash(["type","format","pattern","maxLength","minLength","maxProperties","minProperties","maxItems","minItems","maximum","minimum","uniqueItems","multipleOf","required","enum"]);function f(e,t){return!1!==t&&(void 0===t||!0===t?function e(t){var r;if(Array.isArray(t)){for(var n=0;n<t.length;n++)if("object"==typeof(r=t[n])&&!e(r))return!1}else for(var o in t){if("$ref"==o)return!1;if("object"==typeof(r=t[o])&&!e(r))return!1}return!0}(e):t?function e(t){var r,n=0;if(Array.isArray(t)){for(var o=0;o<t.length;o++)if("object"==typeof(r=t[o])&&(n+=e(r)),n==1/0)return 1/0}else for(var i in t){if("$ref"==i)return 1/0;if(p[i])n++;else if("object"==typeof(r=t[i])&&(n+=e(r)+1),n==1/0)return 1/0}return n}(e)<=t:void 0)}function m(e,t){return!1!==t&&(e=y(e)),g(n.parse(e))}function g(e){return n.serialize(e).split("#")[0]+"#"}var v=/#\/?$/;function y(e){return e?e.replace(v,""):""}function _(e,t){return t=y(t),n.resolve(e,t)}},function(e,t,r){"use strict";e.exports=function e(t,r){if(t===r)return!0;if(t&&r&&"object"==typeof t&&"object"==typeof r){if(t.constructor!==r.constructor)return!1;var n,o,i;if(Array.isArray(t)){if((n=t.length)!=r.length)return!1;for(o=n;0!=o--;)if(!e(t[o],r[o]))return!1;return!0}if(t.constructor===RegExp)return t.source===r.source&&t.flags===r.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===r.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===r.toString();if((n=(i=Object.keys(t)).length)!==Object.keys(r).length)return!1;for(o=n;0!=o--;)if(!Object.prototype.hasOwnProperty.call(r,i[o]))return!1;for(o=n;0!=o--;){var s=i[o];if(!e(t[s],r[s]))return!1}return!0}return t!=t&&r!=r}},function(e,t,r){"use strict";var n=r(13);function o(e,t,r){this.message=r||o.message(e,t),this.missingRef=n.url(e,t),this.missingSchema=n.normalizeId(n.fullPath(this.missingRef))}function i(e){return e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,e}e.exports={Validation:i((function(e){this.message="validation failed",this.errors=e,this.ajv=this.validation=!0})),MissingRef:i(o)},o.message=function(e,t){return"can't resolve reference "+t+" from id "+e}},function(e,t){function r(e,t,r,n,o,i,s){try{var a=e[i](s),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(n,o)}e.exports=function(e){return function(){var t=this,n=arguments;return new Promise((function(o,i){var s=e.apply(t,n);function a(e){r(s,o,i,a,c,"next",e)}function c(e){r(s,o,i,a,c,"throw",e)}a(void 0)}))}}},function(e,t){e.exports=function(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}},function(e,t,r){var n=r(17);e.exports=function(e,t){if(e){if("string"==typeof e)return n(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?n(e,t):void 0}}},function(e,t){e.exports=function(e){this.wrapped=e}},function(e,t,r){"use strict";var n=r(4);e.exports=function(e){n.copy(e,this)}},function(e,t,r){"use strict";e.exports=function(e,t){t||(t={}),"function"==typeof t&&(t={cmp:t});var r,n="boolean"==typeof t.cycles&&t.cycles,o=t.cmp&&(r=t.cmp,function(e){return function(t,n){var o={key:t,value:e[t]},i={key:n,value:e[n]};return r(o,i)}}),i=[];return function e(t){if(t&&t.toJSON&&"function"==typeof t.toJSON&&(t=t.toJSON()),void 0!==t){if("number"==typeof t)return isFinite(t)?""+t:"null";if("object"!=typeof t)return JSON.stringify(t);var r,s;if(Array.isArray(t)){for(s="[",r=0;r<t.length;r++)r&&(s+=","),s+=e(t[r])||"null";return s+"]"}if(null===t)return"null";if(-1!==i.indexOf(t)){if(n)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}var a=i.push(t)-1,c=Object.keys(t).sort(o&&o(t));for(s="",r=0;r<c.length;r++){var u=c[r],l=e(t[u]);l&&(s&&(s+=","),s+=JSON.stringify(u)+":"+l)}return i.splice(a,1),"{"+s+"}"}}(e)}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n="",o=!0===e.schema.$async,i=e.util.schemaHasRulesExcept(e.schema,e.RULES.all,"$ref"),s=e.self._getId(e.schema);if(e.opts.strictKeywords){var a=e.util.schemaUnknownRules(e.schema,e.RULES.keywords);if(a){var c="unknown keyword: "+a;if("log"!==e.opts.strictKeywords)throw new Error(c);e.logger.warn(c)}}if(e.isTop&&(n+=" var validate = ",o&&(e.async=!0,n+="async "),n+="function(data, dataPath, parentData, parentDataProperty, rootData) { 'use strict'; ",s&&(e.opts.sourceCode||e.opts.processCode)&&(n+=" /*# sourceURL="+s+" */ ")),"boolean"==typeof e.schema||!i&&!e.schema.$ref){var u=e.level,l=e.dataLevel,d=e.schema["false schema"],h=e.schemaPath+e.util.getProperty("false schema"),p=e.errSchemaPath+"/false schema",f=!e.opts.allErrors,m="data"+(l||""),g="valid"+u;if(!1===e.schema){e.isTop?f=!0:n+=" var "+g+" = false; ",(H=H||[]).push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'false schema' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(p)+" , params: {} ",!1!==e.opts.messages&&(n+=" , message: 'boolean schema is false' "),e.opts.verbose&&(n+=" , schema: false , parentSchema: validate.schema"+e.schemaPath+" , data: "+m+" "),n+=" } "):n+=" {} ";var v=n;n=H.pop(),!e.compositeRule&&f?e.async?n+=" throw new ValidationError(["+v+"]); ":n+=" validate.errors = ["+v+"]; return false; ":n+=" var err = "+v+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; "}else e.isTop?n+=o?" return data; ":" validate.errors = null; return true; ":n+=" var "+g+" = true; ";return e.isTop&&(n+=" }; return validate; "),n}if(e.isTop){var y=e.isTop;if(u=e.level=0,l=e.dataLevel=0,m="data",e.rootId=e.resolve.fullPath(e.self._getId(e.root.schema)),e.baseId=e.baseId||e.rootId,delete e.isTop,e.dataPathArr=[void 0],void 0!==e.schema.default&&e.opts.useDefaults&&e.opts.strictDefaults){var _="default is ignored in the schema root";if("log"!==e.opts.strictDefaults)throw new Error(_);e.logger.warn(_)}n+=" var vErrors = null; ",n+=" var errors = 0;     ",n+=" if (rootData === undefined) rootData = data; "}else{if(u=e.level,m="data"+((l=e.dataLevel)||""),s&&(e.baseId=e.resolve.url(e.baseId,s)),o&&!e.async)throw new Error("async schema in sync schema");n+=" var errs_"+u+" = errors;"}g="valid"+u,f=!e.opts.allErrors;var b="",E="",S=e.schema.type,w=Array.isArray(S);if(S&&e.opts.nullable&&!0===e.schema.nullable&&(w?-1==S.indexOf("null")&&(S=S.concat("null")):"null"!=S&&(S=[S,"null"],w=!0)),w&&1==S.length&&(S=S[0],w=!1),e.schema.$ref&&i){if("fail"==e.opts.extendRefs)throw new Error('$ref: validation keywords used in schema at path "'+e.errSchemaPath+'" (see option extendRefs)');!0!==e.opts.extendRefs&&(i=!1,e.logger.warn('$ref: keywords ignored in schema at path "'+e.errSchemaPath+'"'))}if(e.schema.$comment&&e.opts.$comment&&(n+=" "+e.RULES.all.$comment.code(e,"$comment")),S){if(e.opts.coerceTypes)var R=e.util.coerceToTypes(e.opts.coerceTypes,S);var I=e.RULES.types[S];if(R||w||!0===I||I&&!J(I)){h=e.schemaPath+".type",p=e.errSchemaPath+"/type",h=e.schemaPath+".type",p=e.errSchemaPath+"/type";var k=w?"checkDataTypes":"checkDataType";if(n+=" if ("+e.util[k](S,m,e.opts.strictNumbers,!0)+") { ",R){var P="dataType"+u,T="coerced"+u;n+=" var "+P+" = typeof "+m+"; ","array"==e.opts.coerceTypes&&(n+=" if ("+P+" == 'object' && Array.isArray("+m+")) "+P+" = 'array'; "),n+=" var "+T+" = undefined; ";var O="",A=R;if(A)for(var D,C=-1,x=A.length-1;C<x;)D=A[C+=1],C&&(n+=" if ("+T+" === undefined) { ",O+="}"),"array"==e.opts.coerceTypes&&"array"!=D&&(n+=" if ("+P+" == 'array' && "+m+".length == 1) { "+T+" = "+m+" = "+m+"[0]; "+P+" = typeof "+m+";  } "),"string"==D?n+=" if ("+P+" == 'number' || "+P+" == 'boolean') "+T+" = '' + "+m+"; else if ("+m+" === null) "+T+" = ''; ":"number"==D||"integer"==D?(n+=" if ("+P+" == 'boolean' || "+m+" === null || ("+P+" == 'string' && "+m+" && "+m+" == +"+m+" ","integer"==D&&(n+=" && !("+m+" % 1)"),n+=")) "+T+" = +"+m+"; "):"boolean"==D?n+=" if ("+m+" === 'false' || "+m+" === 0 || "+m+" === null) "+T+" = false; else if ("+m+" === 'true' || "+m+" === 1) "+T+" = true; ":"null"==D?n+=" if ("+m+" === '' || "+m+" === 0 || "+m+" === false) "+T+" = null; ":"array"==e.opts.coerceTypes&&"array"==D&&(n+=" if ("+P+" == 'string' || "+P+" == 'number' || "+P+" == 'boolean' || "+m+" == null) "+T+" = ["+m+"]; ");n+=" "+O+" if ("+T+" === undefined) {   ",(H=H||[]).push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'type' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(p)+" , params: { type: '",n+=w?""+S.join(","):""+S,n+="' } ",!1!==e.opts.messages&&(n+=" , message: 'should be ",n+=w?""+S.join(","):""+S,n+="' "),e.opts.verbose&&(n+=" , schema: validate.schema"+h+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+m+" "),n+=" } "):n+=" {} ",v=n,n=H.pop(),!e.compositeRule&&f?e.async?n+=" throw new ValidationError(["+v+"]); ":n+=" validate.errors = ["+v+"]; return false; ":n+=" var err = "+v+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",n+=" } else {  ";var M=l?"data"+(l-1||""):"parentData";n+=" "+m+" = "+T+"; ",l||(n+="if ("+M+" !== undefined)"),n+=" "+M+"["+(l?e.dataPathArr[l]:"parentDataProperty")+"] = "+T+"; } "}else(H=H||[]).push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'type' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(p)+" , params: { type: '",n+=w?""+S.join(","):""+S,n+="' } ",!1!==e.opts.messages&&(n+=" , message: 'should be ",n+=w?""+S.join(","):""+S,n+="' "),e.opts.verbose&&(n+=" , schema: validate.schema"+h+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+m+" "),n+=" } "):n+=" {} ",v=n,n=H.pop(),!e.compositeRule&&f?e.async?n+=" throw new ValidationError(["+v+"]); ":n+=" validate.errors = ["+v+"]; return false; ":n+=" var err = "+v+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ";n+=" } "}}if(e.schema.$ref&&!i)n+=" "+e.RULES.all.$ref.code(e,"$ref")+" ",f&&(n+=" } if (errors === ",n+=y?"0":"errs_"+u,n+=") { ",E+="}");else{var j=e.RULES;if(j)for(var U=-1,N=j.length-1;U<N;)if(J(I=j[U+=1])){if(I.type&&(n+=" if ("+e.util.checkDataType(I.type,m,e.opts.strictNumbers)+") { "),e.opts.useDefaults)if("object"==I.type&&e.schema.properties){d=e.schema.properties;var F=Object.keys(d);if(F)for(var L,K=-1,B=F.length-1;K<B;)if(void 0!==(V=d[L=F[K+=1]]).default){var q=m+e.util.getProperty(L);if(e.compositeRule){if(e.opts.strictDefaults){if(_="default is ignored for: "+q,"log"!==e.opts.strictDefaults)throw new Error(_);e.logger.warn(_)}}else n+=" if ("+q+" === undefined ","empty"==e.opts.useDefaults&&(n+=" || "+q+" === null || "+q+" === '' "),n+=" ) "+q+" = ","shared"==e.opts.useDefaults?n+=" "+e.useDefault(V.default)+" ":n+=" "+JSON.stringify(V.default)+" ",n+="; "}}else if("array"==I.type&&Array.isArray(e.schema.items)){var $=e.schema.items;if($){C=-1;for(var V,G=$.length-1;C<G;)if(void 0!==(V=$[C+=1]).default)if(q=m+"["+C+"]",e.compositeRule){if(e.opts.strictDefaults){if(_="default is ignored for: "+q,"log"!==e.opts.strictDefaults)throw new Error(_);e.logger.warn(_)}}else n+=" if ("+q+" === undefined ","empty"==e.opts.useDefaults&&(n+=" || "+q+" === null || "+q+" === '' "),n+=" ) "+q+" = ","shared"==e.opts.useDefaults?n+=" "+e.useDefault(V.default)+" ":n+=" "+JSON.stringify(V.default)+" ",n+="; "}}var H,z=I.rules;if(z)for(var W,Q=-1,Y=z.length-1;Q<Y;)if(Z(W=z[Q+=1])){var X=W.code(e,W.keyword,I.type);X&&(n+=" "+X+" ",f&&(b+="}"))}f&&(n+=" "+b+" ",b=""),I.type&&(n+=" } ",S&&S===I.type&&!R)&&(n+=" else { ",h=e.schemaPath+".type",p=e.errSchemaPath+"/type",(H=H||[]).push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'type' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(p)+" , params: { type: '",n+=w?""+S.join(","):""+S,n+="' } ",!1!==e.opts.messages&&(n+=" , message: 'should be ",n+=w?""+S.join(","):""+S,n+="' "),e.opts.verbose&&(n+=" , schema: validate.schema"+h+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+m+" "),n+=" } "):n+=" {} ",v=n,n=H.pop(),!e.compositeRule&&f?e.async?n+=" throw new ValidationError(["+v+"]); ":n+=" validate.errors = ["+v+"]; return false; ":n+=" var err = "+v+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",n+=" } "),f&&(n+=" if (errors === ",n+=y?"0":"errs_"+u,n+=") { ",E+="}")}}function J(e){for(var t=e.rules,r=0;r<t.length;r++)if(Z(t[r]))return!0}function Z(t){return void 0!==e.schema[t.keyword]||t.implements&&function(t){for(var r=t.implements,n=0;n<r.length;n++)if(void 0!==e.schema[r[n]])return!0}(t)}return f&&(n+=" "+E+" "),y?(o?(n+=" if (errors === 0) return data;           ",n+=" else throw new ValidationError(vErrors); "):(n+=" validate.errors = vErrors; ",n+=" return errors === 0;       "),n+=" }; return validate;"):n+=" var "+g+" = errors === errs_"+u+";",n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n,o=" ",i=e.level,s=e.dataLevel,a=e.schema[t],c=e.schemaPath+e.util.getProperty(t),u=e.errSchemaPath+"/"+t,l=!e.opts.allErrors,d="data"+(s||""),h=e.opts.$data&&a&&a.$data;h?(o+=" var schema"+i+" = "+e.util.getData(a.$data,s,e.dataPathArr)+"; ",n="schema"+i):n=a;var p="maximum"==t,f=p?"exclusiveMaximum":"exclusiveMinimum",m=e.schema[f],g=e.opts.$data&&m&&m.$data,v=p?"<":">",y=p?">":"<",_=void 0;if(!h&&"number"!=typeof a&&void 0!==a)throw new Error(t+" must be number");if(!g&&void 0!==m&&"number"!=typeof m&&"boolean"!=typeof m)throw new Error(f+" must be number or boolean");if(g){var b,E=e.util.getData(m.$data,s,e.dataPathArr),S="exclusive"+i,w="exclType"+i,R="exclIsNumber"+i,I="' + "+(P="op"+i)+" + '";o+=" var schemaExcl"+i+" = "+E+"; ",o+=" var "+S+"; var "+w+" = typeof "+(E="schemaExcl"+i)+"; if ("+w+" != 'boolean' && "+w+" != 'undefined' && "+w+" != 'number') { ",_=f,(b=b||[]).push(o),o="",!1!==e.createErrors?(o+=" { keyword: '"+(_||"_exclusiveLimit")+"' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(u)+" , params: {} ",!1!==e.opts.messages&&(o+=" , message: '"+f+" should be boolean' "),e.opts.verbose&&(o+=" , schema: validate.schema"+c+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+d+" "),o+=" } "):o+=" {} ";var k=o;o=b.pop(),!e.compositeRule&&l?e.async?o+=" throw new ValidationError(["+k+"]); ":o+=" validate.errors = ["+k+"]; return false; ":o+=" var err = "+k+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",o+=" } else if ( ",h&&(o+=" ("+n+" !== undefined && typeof "+n+" != 'number') || "),o+=" "+w+" == 'number' ? ( ("+S+" = "+n+" === undefined || "+E+" "+v+"= "+n+") ? "+d+" "+y+"= "+E+" : "+d+" "+y+" "+n+" ) : ( ("+S+" = "+E+" === true) ? "+d+" "+y+"= "+n+" : "+d+" "+y+" "+n+" ) || "+d+" !== "+d+") { var op"+i+" = "+S+" ? '"+v+"' : '"+v+"='; ",void 0===a&&(_=f,u=e.errSchemaPath+"/"+f,n=E,h=g)}else if(I=v,(R="number"==typeof m)&&h){var P="'"+I+"'";o+=" if ( ",h&&(o+=" ("+n+" !== undefined && typeof "+n+" != 'number') || "),o+=" ( "+n+" === undefined || "+m+" "+v+"= "+n+" ? "+d+" "+y+"= "+m+" : "+d+" "+y+" "+n+" ) || "+d+" !== "+d+") { "}else R&&void 0===a?(S=!0,_=f,u=e.errSchemaPath+"/"+f,n=m,y+="="):(R&&(n=Math[p?"min":"max"](m,a)),m===(!R||n)?(S=!0,_=f,u=e.errSchemaPath+"/"+f,y+="="):(S=!1,I+="=")),P="'"+I+"'",o+=" if ( ",h&&(o+=" ("+n+" !== undefined && typeof "+n+" != 'number') || "),o+=" "+d+" "+y+" "+n+" || "+d+" !== "+d+") { ";return _=_||t,(b=b||[]).push(o),o="",!1!==e.createErrors?(o+=" { keyword: '"+(_||"_limit")+"' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(u)+" , params: { comparison: "+P+", limit: "+n+", exclusive: "+S+" } ",!1!==e.opts.messages&&(o+=" , message: 'should be "+I+" ",o+=h?"' + "+n:n+"'"),e.opts.verbose&&(o+=" , schema:  ",o+=h?"validate.schema"+c:""+a,o+="         , parentSchema: validate.schema"+e.schemaPath+" , data: "+d+" "),o+=" } "):o+=" {} ",k=o,o=b.pop(),!e.compositeRule&&l?e.async?o+=" throw new ValidationError(["+k+"]); ":o+=" validate.errors = ["+k+"]; return false; ":o+=" var err = "+k+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",o+=" } ",l&&(o+=" else { "),o}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n,o=" ",i=e.level,s=e.dataLevel,a=e.schema[t],c=e.schemaPath+e.util.getProperty(t),u=e.errSchemaPath+"/"+t,l=!e.opts.allErrors,d="data"+(s||""),h=e.opts.$data&&a&&a.$data;if(h?(o+=" var schema"+i+" = "+e.util.getData(a.$data,s,e.dataPathArr)+"; ",n="schema"+i):n=a,!h&&"number"!=typeof a)throw new Error(t+" must be number");o+="if ( ",h&&(o+=" ("+n+" !== undefined && typeof "+n+" != 'number') || "),o+=" "+d+".length "+("maxItems"==t?">":"<")+" "+n+") { ";var p=t,f=f||[];f.push(o),o="",!1!==e.createErrors?(o+=" { keyword: '"+(p||"_limitItems")+"' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(u)+" , params: { limit: "+n+" } ",!1!==e.opts.messages&&(o+=" , message: 'should NOT have ",o+="maxItems"==t?"more":"fewer",o+=" than ",o+=h?"' + "+n+" + '":""+a,o+=" items' "),e.opts.verbose&&(o+=" , schema:  ",o+=h?"validate.schema"+c:""+a,o+="         , parentSchema: validate.schema"+e.schemaPath+" , data: "+d+" "),o+=" } "):o+=" {} ";var m=o;return o=f.pop(),!e.compositeRule&&l?e.async?o+=" throw new ValidationError(["+m+"]); ":o+=" validate.errors = ["+m+"]; return false; ":o+=" var err = "+m+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",o+="} ",l&&(o+=" else { "),o}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n,o=" ",i=e.level,s=e.dataLevel,a=e.schema[t],c=e.schemaPath+e.util.getProperty(t),u=e.errSchemaPath+"/"+t,l=!e.opts.allErrors,d="data"+(s||""),h=e.opts.$data&&a&&a.$data;if(h?(o+=" var schema"+i+" = "+e.util.getData(a.$data,s,e.dataPathArr)+"; ",n="schema"+i):n=a,!h&&"number"!=typeof a)throw new Error(t+" must be number");var p="maxLength"==t?">":"<";o+="if ( ",h&&(o+=" ("+n+" !== undefined && typeof "+n+" != 'number') || "),!1===e.opts.unicode?o+=" "+d+".length ":o+=" ucs2length("+d+") ",o+=" "+p+" "+n+") { ";var f=t,m=m||[];m.push(o),o="",!1!==e.createErrors?(o+=" { keyword: '"+(f||"_limitLength")+"' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(u)+" , params: { limit: "+n+" } ",!1!==e.opts.messages&&(o+=" , message: 'should NOT be ",o+="maxLength"==t?"longer":"shorter",o+=" than ",o+=h?"' + "+n+" + '":""+a,o+=" characters' "),e.opts.verbose&&(o+=" , schema:  ",o+=h?"validate.schema"+c:""+a,o+="         , parentSchema: validate.schema"+e.schemaPath+" , data: "+d+" "),o+=" } "):o+=" {} ";var g=o;return o=m.pop(),!e.compositeRule&&l?e.async?o+=" throw new ValidationError(["+g+"]); ":o+=" validate.errors = ["+g+"]; return false; ":o+=" var err = "+g+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",o+="} ",l&&(o+=" else { "),o}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n,o=" ",i=e.level,s=e.dataLevel,a=e.schema[t],c=e.schemaPath+e.util.getProperty(t),u=e.errSchemaPath+"/"+t,l=!e.opts.allErrors,d="data"+(s||""),h=e.opts.$data&&a&&a.$data;if(h?(o+=" var schema"+i+" = "+e.util.getData(a.$data,s,e.dataPathArr)+"; ",n="schema"+i):n=a,!h&&"number"!=typeof a)throw new Error(t+" must be number");o+="if ( ",h&&(o+=" ("+n+" !== undefined && typeof "+n+" != 'number') || "),o+=" Object.keys("+d+").length "+("maxProperties"==t?">":"<")+" "+n+") { ";var p=t,f=f||[];f.push(o),o="",!1!==e.createErrors?(o+=" { keyword: '"+(p||"_limitProperties")+"' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(u)+" , params: { limit: "+n+" } ",!1!==e.opts.messages&&(o+=" , message: 'should NOT have ",o+="maxProperties"==t?"more":"fewer",o+=" than ",o+=h?"' + "+n+" + '":""+a,o+=" properties' "),e.opts.verbose&&(o+=" , schema:  ",o+=h?"validate.schema"+c:""+a,o+="         , parentSchema: validate.schema"+e.schemaPath+" , data: "+d+" "),o+=" } "):o+=" {} ";var m=o;return o=f.pop(),!e.compositeRule&&l?e.async?o+=" throw new ValidationError(["+m+"]); ":o+=" validate.errors = ["+m+"]; return false; ":o+=" var err = "+m+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",o+="} ",l&&(o+=" else { "),o}},function(e){e.exports=JSON.parse('{"$schema":"http://json-schema.org/draft-07/schema#","$id":"http://json-schema.org/draft-07/schema#","title":"Core schema meta-schema","definitions":{"schemaArray":{"type":"array","minItems":1,"items":{"$ref":"#"}},"nonNegativeInteger":{"type":"integer","minimum":0},"nonNegativeIntegerDefault0":{"allOf":[{"$ref":"#/definitions/nonNegativeInteger"},{"default":0}]},"simpleTypes":{"enum":["array","boolean","integer","null","number","object","string"]},"stringArray":{"type":"array","items":{"type":"string"},"uniqueItems":true,"default":[]}},"type":["object","boolean"],"properties":{"$id":{"type":"string","format":"uri-reference"},"$schema":{"type":"string","format":"uri"},"$ref":{"type":"string","format":"uri-reference"},"$comment":{"type":"string"},"title":{"type":"string"},"description":{"type":"string"},"default":true,"readOnly":{"type":"boolean","default":false},"examples":{"type":"array","items":true},"multipleOf":{"type":"number","exclusiveMinimum":0},"maximum":{"type":"number"},"exclusiveMaximum":{"type":"number"},"minimum":{"type":"number"},"exclusiveMinimum":{"type":"number"},"maxLength":{"$ref":"#/definitions/nonNegativeInteger"},"minLength":{"$ref":"#/definitions/nonNegativeIntegerDefault0"},"pattern":{"type":"string","format":"regex"},"additionalItems":{"$ref":"#"},"items":{"anyOf":[{"$ref":"#"},{"$ref":"#/definitions/schemaArray"}],"default":true},"maxItems":{"$ref":"#/definitions/nonNegativeInteger"},"minItems":{"$ref":"#/definitions/nonNegativeIntegerDefault0"},"uniqueItems":{"type":"boolean","default":false},"contains":{"$ref":"#"},"maxProperties":{"$ref":"#/definitions/nonNegativeInteger"},"minProperties":{"$ref":"#/definitions/nonNegativeIntegerDefault0"},"required":{"$ref":"#/definitions/stringArray"},"additionalProperties":{"$ref":"#"},"definitions":{"type":"object","additionalProperties":{"$ref":"#"},"default":{}},"properties":{"type":"object","additionalProperties":{"$ref":"#"},"default":{}},"patternProperties":{"type":"object","additionalProperties":{"$ref":"#"},"propertyNames":{"format":"regex"},"default":{}},"dependencies":{"type":"object","additionalProperties":{"anyOf":[{"$ref":"#"},{"$ref":"#/definitions/stringArray"}]}},"propertyNames":{"$ref":"#"},"const":true,"enum":{"type":"array","items":true,"minItems":1,"uniqueItems":true},"type":{"anyOf":[{"$ref":"#/definitions/simpleTypes"},{"type":"array","items":{"$ref":"#/definitions/simpleTypes"},"minItems":1,"uniqueItems":true}]},"format":{"type":"string"},"contentMediaType":{"type":"string"},"contentEncoding":{"type":"string"},"if":{"$ref":"#"},"then":{"$ref":"#"},"else":{"$ref":"#"},"allOf":{"$ref":"#/definitions/schemaArray"},"anyOf":{"$ref":"#/definitions/schemaArray"},"oneOf":{"$ref":"#/definitions/schemaArray"},"not":{"$ref":"#"}},"default":true}')},function(e,t,r){var n=r(36),o=r(37),i=r(18),s=r(38);e.exports=function(e,t){return n(e)||o(e,t)||i(e,t)||s()}},function(e,t,r){var n=r(7),o=r(6);e.exports=function(e,t){return!t||"object"!==n(t)&&"function"!=typeof t?o(e):t}},function(e,t){e.exports=function(e){var t;if("undefined"!=typeof Symbol){if(Symbol.asyncIterator&&null!=(t=e[Symbol.asyncIterator]))return t.call(e);if(Symbol.iterator&&null!=(t=e[Symbol.iterator]))return t.call(e)}throw new TypeError("Object is not async iterable")}},function(e,t,r){var n=r(19);e.exports=function(e){return new n(e)}},function(e,t,r){var n=r(44);e.exports=function(e){return function(){return new n(e.apply(this,arguments))}}},function(e,t,r){var n=r(17);e.exports=function(e){if(Array.isArray(e))return n(e)}},function(e,t){e.exports=function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}},function(e,t){e.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}},function(e,t){e.exports=function(e){if(Array.isArray(e))return e}},function(e,t){e.exports=function(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var r=[],n=!0,o=!1,i=void 0;try{for(var s,a=e[Symbol.iterator]();!(n=(s=a.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){o=!0,i=e}finally{try{n||null==a.return||a.return()}finally{if(o)throw i}}return r}}},function(e,t){e.exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}},function(e,t,r){var n=function(){return this}()||Function("return this")(),o=n.regeneratorRuntime&&Object.getOwnPropertyNames(n).indexOf("regeneratorRuntime")>=0,i=o&&n.regeneratorRuntime;if(n.regeneratorRuntime=void 0,e.exports=r(40),o)n.regeneratorRuntime=i;else try{delete n.regeneratorRuntime}catch(e){n.regeneratorRuntime=void 0}},function(e,t){!function(t){"use strict";var r=Object.prototype,n=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",a=o.toStringTag||"@@toStringTag",c="object"==typeof e,u=t.regeneratorRuntime;if(u)c&&(e.exports=u);else{(u=t.regeneratorRuntime=c?e.exports:{}).wrap=m;var l={},d={};d[i]=function(){return this};var h=Object.getPrototypeOf,p=h&&h(h(k([])));p&&p!==r&&n.call(p,i)&&(d=p);var f=_.prototype=v.prototype=Object.create(d);y.prototype=f.constructor=_,_.constructor=y,_[a]=y.displayName="GeneratorFunction",u.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},u.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,_):(e.__proto__=_,a in e||(e[a]="GeneratorFunction")),e.prototype=Object.create(f),e},u.awrap=function(e){return{__await:e}},b(E.prototype),E.prototype[s]=function(){return this},u.AsyncIterator=E,u.async=function(e,t,r,n){var o=new E(m(e,t,r,n));return u.isGeneratorFunction(t)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},b(f),f[a]="Generator",f[i]=function(){return this},f.toString=function(){return"[object Generator]"},u.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},u.values=k,I.prototype={constructor:I,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(R),!e)for(var t in this)"t"===t.charAt(0)&&n.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(r,n){return s.type="throw",s.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],s=i.completion;if("root"===i.tryLoc)return r("end");if(i.tryLoc<=this.prev){var a=n.call(i,"catchLoc"),c=n.call(i,"finallyLoc");if(a&&c){if(this.prev<i.catchLoc)return r(i.catchLoc,!0);if(this.prev<i.finallyLoc)return r(i.finallyLoc)}else if(a){if(this.prev<i.catchLoc)return r(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return r(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var s=i?i.completion:{};return s.type=e,s.arg=t,i?(this.method="next",this.next=i.finallyLoc,l):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),R(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;R(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:k(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}}}function m(e,t,r,n){var o=t&&t.prototype instanceof v?t:v,i=Object.create(o.prototype),s=new I(n||[]);return i._invoke=function(e,t,r){var n="suspendedStart";return function(o,i){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===o)throw i;return{value:void 0,done:!0}}for(r.method=o,r.arg=i;;){var s=r.delegate;if(s){var a=S(s,r);if(a){if(a===l)continue;return a}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=g(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,s),i}function g(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}function v(){}function y(){}function _(){}function b(e){["next","throw","return"].forEach((function(t){e[t]=function(e){return this._invoke(t,e)}}))}function E(e){var t;this._invoke=function(r,o){function i(){return new Promise((function(t,i){!function t(r,o,i,s){var a=g(e[r],e,o);if("throw"!==a.type){var c=a.arg,u=c.value;return u&&"object"==typeof u&&n.call(u,"__await")?Promise.resolve(u.__await).then((function(e){t("next",e,i,s)}),(function(e){t("throw",e,i,s)})):Promise.resolve(u).then((function(e){c.value=e,i(c)}),s)}s(a.arg)}(r,o,t,i)}))}return t=t?t.then(i,i):i()}}function S(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,S(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=g(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var o=n.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function w(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function R(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function I(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(w,this),this.reset(!0)}function k(e){if(e){var t=e[i];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,o=function t(){for(;++r<e.length;)if(n.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t};return o.next=o}}return{next:P}}function P(){return{value:void 0,done:!0}}}(function(){return this}()||Function("return this")())},function(e,t){e.exports=function(e){return-1!==Function.toString.call(e).indexOf("[native code]")}},function(e,t,r){var n=r(12),o=r(43);function i(t,r,s){return o()?e.exports=i=Reflect.construct:e.exports=i=function(e,t,r){var o=[null];o.push.apply(o,t);var i=new(Function.bind.apply(e,o));return r&&n(i,r.prototype),i},i.apply(null,arguments)}e.exports=i},function(e,t){e.exports=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}},function(e,t,r){var n=r(19);function o(e){var t,r;function o(t,r){try{var s=e[t](r),a=s.value,c=a instanceof n;Promise.resolve(c?a.wrapped:a).then((function(e){c?o("return"===t?"return":"next",e):i(s.done?"return":"normal",e)}),(function(e){o("throw",e)}))}catch(e){i("throw",e)}}function i(e,n){switch(e){case"return":t.resolve({value:n,done:!0});break;case"throw":t.reject(n);break;default:t.resolve({value:n,done:!1})}(t=t.next)?o(t.key,t.arg):r=null}this._invoke=function(e,n){return new Promise((function(i,s){var a={key:e,arg:n,resolve:i,reject:s,next:null};r?r=r.next=a:(t=r=a,o(e,n))}))},"function"!=typeof e.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(o.prototype[Symbol.asyncIterator]=function(){return this}),o.prototype.next=function(e){return this._invoke("next",e)},o.prototype.throw=function(e){return this._invoke("throw",e)},o.prototype.return=function(e){return this._invoke("return",e)},e.exports=o},function(e,t,r){"use strict";var n=r(13),o=r(4),i=r(15),s=r(21),a=r(22),c=o.ucs2length,u=r(14),l=i.Validation;function d(e,t,r){var n=p.call(this,e,t,r);return n>=0?{index:n,compiling:!0}:(n=this._compilations.length,this._compilations[n]={schema:e,root:t,baseId:r},{index:n,compiling:!1})}function h(e,t,r){var n=p.call(this,e,t,r);n>=0&&this._compilations.splice(n,1)}function p(e,t,r){for(var n=0;n<this._compilations.length;n++){var o=this._compilations[n];if(o.schema==e&&o.root==t&&o.baseId==r)return n}return-1}function f(e,t){return"var pattern"+e+" = new RegExp("+o.toQuotedString(t[e])+");"}function m(e){return"var default"+e+" = defaults["+e+"];"}function g(e,t){return void 0===t[e]?"":"var refVal"+e+" = refVal["+e+"];"}function v(e){return"var customRule"+e+" = customRules["+e+"];"}function y(e,t){if(!e.length)return"";for(var r="",n=0;n<e.length;n++)r+=t(n,e);return r}e.exports=function e(t,r,p,_){var b=this,E=this._opts,S=[void 0],w={},R=[],I={},k=[],P={},T=[];r=r||{schema:t,refVal:S,refs:w};var O=d.call(this,t,r,_),A=this._compilations[O.index];if(O.compiling)return A.callValidate=function e(){var t=A.validate,r=t.apply(this,arguments);return e.errors=t.errors,r};var D=this._formats,C=this.RULES;try{var x=j(t,r,p,_);A.validate=x;var M=A.callValidate;return M&&(M.schema=x.schema,M.errors=null,M.refs=x.refs,M.refVal=x.refVal,M.root=x.root,M.$async=x.$async,E.sourceCode&&(M.source=x.source)),x}finally{h.call(this,t,r,_)}function j(t,s,d,h){var p=!s||s&&s.schema==t;if(s.schema!=r.schema)return e.call(b,t,s,d,h);var _,I=!0===t.$async,P=a({isTop:!0,schema:t,isRoot:p,baseId:h,root:s,schemaPath:"",errSchemaPath:"#",errorPath:'""',MissingRefError:i.MissingRef,RULES:C,validate:a,util:o,resolve:n,resolveRef:U,usePattern:L,useDefault:K,useCustomRule:B,opts:E,formats:D,logger:b.logger,self:b});P=y(S,g)+y(R,f)+y(k,m)+y(T,v)+P,E.processCode&&(P=E.processCode(P,t));try{_=new Function("self","RULES","formats","root","refVal","defaults","customRules","equal","ucs2length","ValidationError",P)(b,C,D,r,S,k,T,u,c,l),S[0]=_}catch(e){throw b.logger.error("Error compiling schema, function code:",P),e}return _.schema=t,_.errors=null,_.refs=w,_.refVal=S,_.root=p?_:s,I&&(_.$async=!0),!0===E.sourceCode&&(_.source={code:P,patterns:R,defaults:k}),_}function U(t,o,i){o=n.url(t,o);var s,a,c=w[o];if(void 0!==c)return F(s=S[c],a="refVal["+c+"]");if(!i&&r.refs){var u=r.refs[o];if(void 0!==u)return F(s=r.refVal[u],a=N(o,s))}a=N(o);var l=n.call(b,j,r,o);if(void 0===l){var d=p&&p[o];d&&(l=n.inlineRef(d,E.inlineRefs)?d:e.call(b,d,r,p,t))}if(void 0!==l)return function(e,t){var r=w[e];S[r]=t}(o,l),F(l,a);!function(e){delete w[e]}(o)}function N(e,t){var r=S.length;return S[r]=t,w[e]=r,"refVal"+r}function F(e,t){return"object"==typeof e||"boolean"==typeof e?{code:t,schema:e,inline:!0}:{code:t,$async:e&&!!e.$async}}function L(e){var t=I[e];return void 0===t&&(t=I[e]=R.length,R[t]=e),"pattern"+t}function K(e){switch(typeof e){case"boolean":case"number":return""+e;case"string":return o.toQuotedString(e);case"object":if(null===e)return"null";var t=s(e),r=P[t];return void 0===r&&(r=P[t]=k.length,k[r]=e),"default"+r}}function B(e,t,r,n){if(!1!==b._opts.validateSchema){var o=e.definition.dependencies;if(o&&!o.every((function(e){return Object.prototype.hasOwnProperty.call(r,e)})))throw new Error("parent schema must have all required keywords: "+o.join(","));var i=e.definition.validateSchema;if(i&&!i(t)){var s="keyword schema is invalid: "+b.errorsText(i.errors);if("log"!=b._opts.validateSchema)throw new Error(s);b.logger.error(s)}}var a,c=e.definition.compile,u=e.definition.inline,l=e.definition.macro;if(c)a=c.call(b,t,r,n);else if(l)a=l.call(b,t,r,n),!1!==E.validateSchema&&b.validateSchema(a,!0);else if(u)a=u.call(b,n,e.keyword,t,r);else if(!(a=e.definition.validate))return;if(void 0===a)throw new Error('custom keyword "'+e.keyword+'"failed to compile');var d=T.length;return T[d]=a,{code:"customRule"+d,validate:a}}}},function(e,t,r){
/** @license URI.js v4.2.1 (c) 2011 Gary Court. License: http://github.com/garycourt/uri-js */
!function(e){"use strict";function t(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];if(t.length>1){t[0]=t[0].slice(0,-1);for(var n=t.length-1,o=1;o<n;++o)t[o]=t[o].slice(1,-1);return t[n]=t[n].slice(1),t.join("")}return t[0]}function r(e){return"(?:"+e+")"}function n(e){return void 0===e?"undefined":null===e?"null":Object.prototype.toString.call(e).split(" ").pop().split("]").shift().toLowerCase()}function o(e){return e.toUpperCase()}function i(e){var n=t("[0-9]","[A-Fa-f]"),o=r(r("%[EFef]"+n+"%"+n+n+"%"+n+n)+"|"+r("%[89A-Fa-f]"+n+"%"+n+n)+"|"+r("%"+n+n)),i="[\\!\\$\\&\\'\\(\\)\\*\\+\\,\\;\\=]",s=t("[\\:\\/\\?\\#\\[\\]\\@]",i),a=e?"[\\uE000-\\uF8FF]":"[]",c=t("[A-Za-z]","[0-9]","[\\-\\.\\_\\~]",e?"[\\xA0-\\u200D\\u2010-\\u2029\\u202F-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF]":"[]"),u=r("[A-Za-z]"+t("[A-Za-z]","[0-9]","[\\+\\-\\.]")+"*"),l=r(r(o+"|"+t(c,i,"[\\:]"))+"*"),d=(r(r("25[0-5]")+"|"+r("2[0-4][0-9]")+"|"+r("1[0-9][0-9]")+"|"+r("[1-9][0-9]")+"|[0-9]"),r(r("25[0-5]")+"|"+r("2[0-4][0-9]")+"|"+r("1[0-9][0-9]")+"|"+r("0?[1-9][0-9]")+"|0?0?[0-9]")),h=r(d+"\\."+d+"\\."+d+"\\."+d),p=r(n+"{1,4}"),f=r(r(p+"\\:"+p)+"|"+h),m=r(r(p+"\\:")+"{6}"+f),g=r("\\:\\:"+r(p+"\\:")+"{5}"+f),v=r(r(p)+"?\\:\\:"+r(p+"\\:")+"{4}"+f),y=r(r(r(p+"\\:")+"{0,1}"+p)+"?\\:\\:"+r(p+"\\:")+"{3}"+f),_=r(r(r(p+"\\:")+"{0,2}"+p)+"?\\:\\:"+r(p+"\\:")+"{2}"+f),b=r(r(r(p+"\\:")+"{0,3}"+p)+"?\\:\\:"+p+"\\:"+f),E=r(r(r(p+"\\:")+"{0,4}"+p)+"?\\:\\:"+f),S=r(r(r(p+"\\:")+"{0,5}"+p)+"?\\:\\:"+p),w=r(r(r(p+"\\:")+"{0,6}"+p)+"?\\:\\:"),R=r([m,g,v,y,_,b,E,S,w].join("|")),I=r(r(c+"|"+o)+"+"),k=(r(R+"\\%25"+I),r(R+r("\\%25|\\%(?!"+n+"{2})")+I)),P=r("[vV]"+n+"+\\."+t(c,i,"[\\:]")+"+"),T=r("\\["+r(k+"|"+R+"|"+P)+"\\]"),O=r(r(o+"|"+t(c,i))+"*"),A=r(T+"|"+h+"(?!"+O+")|"+O),D=r("[0-9]*"),C=r(r(l+"@")+"?"+A+r("\\:"+D)+"?"),x=r(o+"|"+t(c,i,"[\\:\\@]")),M=r(x+"*"),j=r(x+"+"),U=r(r(o+"|"+t(c,i,"[\\@]"))+"+"),N=r(r("\\/"+M)+"*"),F=r("\\/"+r(j+N)+"?"),L=r(U+N),K=r(j+N),B="(?!"+x+")",q=(r(N+"|"+F+"|"+L+"|"+K+"|"+B),r(r(x+"|"+t("[\\/\\?]",a))+"*")),$=r(r(x+"|[\\/\\?]")+"*"),V=r(r("\\/\\/"+C+N)+"|"+F+"|"+K+"|"+B),G=r(u+"\\:"+V+r("\\?"+q)+"?"+r("\\#"+$)+"?"),H=r(r("\\/\\/"+C+N)+"|"+F+"|"+L+"|"+B),z=r(H+r("\\?"+q)+"?"+r("\\#"+$)+"?");return r(G+"|"+z),r(u+"\\:"+V+r("\\?"+q)+"?"),r(r("\\/\\/("+r("("+l+")@")+"?("+A+")"+r("\\:("+D+")")+"?)")+"?("+N+"|"+F+"|"+K+"|"+B+")"),r("\\?("+q+")"),r("\\#("+$+")"),r(r("\\/\\/("+r("("+l+")@")+"?("+A+")"+r("\\:("+D+")")+"?)")+"?("+N+"|"+F+"|"+L+"|"+B+")"),r("\\?("+q+")"),r("\\#("+$+")"),r(r("\\/\\/("+r("("+l+")@")+"?("+A+")"+r("\\:("+D+")")+"?)")+"?("+N+"|"+F+"|"+K+"|"+B+")"),r("\\?("+q+")"),r("\\#("+$+")"),r("("+l+")@"),r("\\:("+D+")"),{NOT_SCHEME:new RegExp(t("[^]","[A-Za-z]","[0-9]","[\\+\\-\\.]"),"g"),NOT_USERINFO:new RegExp(t("[^\\%\\:]",c,i),"g"),NOT_HOST:new RegExp(t("[^\\%\\[\\]\\:]",c,i),"g"),NOT_PATH:new RegExp(t("[^\\%\\/\\:\\@]",c,i),"g"),NOT_PATH_NOSCHEME:new RegExp(t("[^\\%\\/\\@]",c,i),"g"),NOT_QUERY:new RegExp(t("[^\\%]",c,i,"[\\:\\@\\/\\?]",a),"g"),NOT_FRAGMENT:new RegExp(t("[^\\%]",c,i,"[\\:\\@\\/\\?]"),"g"),ESCAPE:new RegExp(t("[^]",c,i),"g"),UNRESERVED:new RegExp(c,"g"),OTHER_CHARS:new RegExp(t("[^\\%]",c,s),"g"),PCT_ENCODED:new RegExp(o,"g"),IPV4ADDRESS:new RegExp("^("+h+")$"),IPV6ADDRESS:new RegExp("^\\[?("+R+")"+r(r("\\%25|\\%(?!"+n+"{2})")+"("+I+")")+"?\\]?$")}}var s=i(!1),a=i(!0),c=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],n=!0,o=!1,i=void 0;try{for(var s,a=e[Symbol.iterator]();!(n=(s=a.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){o=!0,i=e}finally{try{!n&&a.return&&a.return()}finally{if(o)throw i}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},u=2147483647,l=/^xn--/,d=/[^\0-\x7E]/,h=/[\x2E\u3002\uFF0E\uFF61]/g,p={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},f=Math.floor,m=String.fromCharCode;function g(e){throw new RangeError(p[e])}function v(e,t){var r=e.split("@"),n="";r.length>1&&(n=r[0]+"@",e=r[1]);var o=function(e,t){for(var r=[],n=e.length;n--;)r[n]=t(e[n]);return r}((e=e.replace(h,".")).split("."),t).join(".");return n+o}var y=function(e,t){return e+22+75*(e<26)-((0!=t)<<5)},_=function(e,t,r){var n=0;for(e=r?f(e/700):e>>1,e+=f(e/t);e>455;n+=36)e=f(e/35);return f(n+36*e/(e+38))},b=function(e){return v(e,(function(e){return d.test(e)?"xn--"+function(e){var t=[],r=(e=function(e){for(var t=[],r=0,n=e.length;r<n;){var o=e.charCodeAt(r++);if(o>=55296&&o<=56319&&r<n){var i=e.charCodeAt(r++);56320==(64512&i)?t.push(((1023&o)<<10)+(1023&i)+65536):(t.push(o),r--)}else t.push(o)}return t}(e)).length,n=128,o=0,i=72,s=!0,a=!1,c=void 0;try{for(var l,d=e[Symbol.iterator]();!(s=(l=d.next()).done);s=!0){var h=l.value;h<128&&t.push(m(h))}}catch(e){a=!0,c=e}finally{try{!s&&d.return&&d.return()}finally{if(a)throw c}}var p=t.length,v=p;for(p&&t.push("-");v<r;){var b=u,E=!0,S=!1,w=void 0;try{for(var R,I=e[Symbol.iterator]();!(E=(R=I.next()).done);E=!0){var k=R.value;k>=n&&k<b&&(b=k)}}catch(e){S=!0,w=e}finally{try{!E&&I.return&&I.return()}finally{if(S)throw w}}var P=v+1;b-n>f((u-o)/P)&&g("overflow"),o+=(b-n)*P,n=b;var T=!0,O=!1,A=void 0;try{for(var D,C=e[Symbol.iterator]();!(T=(D=C.next()).done);T=!0){var x=D.value;if(x<n&&++o>u&&g("overflow"),x==n){for(var M=o,j=36;;j+=36){var U=j<=i?1:j>=i+26?26:j-i;if(M<U)break;var N=M-U,F=36-U;t.push(m(y(U+N%F,0))),M=f(N/F)}t.push(m(y(M,0))),i=_(o,P,v==p),o=0,++v}}}catch(e){O=!0,A=e}finally{try{!T&&C.return&&C.return()}finally{if(O)throw A}}++o,++n}return t.join("")}(e):e}))},E=function(e){return v(e,(function(e){return l.test(e)?function(e){var t,r=[],n=e.length,o=0,i=128,s=72,a=e.lastIndexOf("-");a<0&&(a=0);for(var c=0;c<a;++c)e.charCodeAt(c)>=128&&g("not-basic"),r.push(e.charCodeAt(c));for(var l=a>0?a+1:0;l<n;){for(var d=o,h=1,p=36;;p+=36){l>=n&&g("invalid-input");var m=(t=e.charCodeAt(l++))-48<10?t-22:t-65<26?t-65:t-97<26?t-97:36;(m>=36||m>f((u-o)/h))&&g("overflow"),o+=m*h;var v=p<=s?1:p>=s+26?26:p-s;if(m<v)break;var y=36-v;h>f(u/y)&&g("overflow"),h*=y}var b=r.length+1;s=_(o-d,b,0==d),f(o/b)>u-i&&g("overflow"),i+=f(o/b),o%=b,r.splice(o++,0,i)}return String.fromCodePoint.apply(String,r)}(e.slice(4).toLowerCase()):e}))},S={};function w(e){var t=e.charCodeAt(0);return t<16?"%0"+t.toString(16).toUpperCase():t<128?"%"+t.toString(16).toUpperCase():t<2048?"%"+(t>>6|192).toString(16).toUpperCase()+"%"+(63&t|128).toString(16).toUpperCase():"%"+(t>>12|224).toString(16).toUpperCase()+"%"+(t>>6&63|128).toString(16).toUpperCase()+"%"+(63&t|128).toString(16).toUpperCase()}function R(e){for(var t="",r=0,n=e.length;r<n;){var o=parseInt(e.substr(r+1,2),16);if(o<128)t+=String.fromCharCode(o),r+=3;else if(o>=194&&o<224){if(n-r>=6){var i=parseInt(e.substr(r+4,2),16);t+=String.fromCharCode((31&o)<<6|63&i)}else t+=e.substr(r,6);r+=6}else if(o>=224){if(n-r>=9){var s=parseInt(e.substr(r+4,2),16),a=parseInt(e.substr(r+7,2),16);t+=String.fromCharCode((15&o)<<12|(63&s)<<6|63&a)}else t+=e.substr(r,9);r+=9}else t+=e.substr(r,3),r+=3}return t}function I(e,t){function r(e){var r=R(e);return r.match(t.UNRESERVED)?r:e}return e.scheme&&(e.scheme=String(e.scheme).replace(t.PCT_ENCODED,r).toLowerCase().replace(t.NOT_SCHEME,"")),void 0!==e.userinfo&&(e.userinfo=String(e.userinfo).replace(t.PCT_ENCODED,r).replace(t.NOT_USERINFO,w).replace(t.PCT_ENCODED,o)),void 0!==e.host&&(e.host=String(e.host).replace(t.PCT_ENCODED,r).toLowerCase().replace(t.NOT_HOST,w).replace(t.PCT_ENCODED,o)),void 0!==e.path&&(e.path=String(e.path).replace(t.PCT_ENCODED,r).replace(e.scheme?t.NOT_PATH:t.NOT_PATH_NOSCHEME,w).replace(t.PCT_ENCODED,o)),void 0!==e.query&&(e.query=String(e.query).replace(t.PCT_ENCODED,r).replace(t.NOT_QUERY,w).replace(t.PCT_ENCODED,o)),void 0!==e.fragment&&(e.fragment=String(e.fragment).replace(t.PCT_ENCODED,r).replace(t.NOT_FRAGMENT,w).replace(t.PCT_ENCODED,o)),e}function k(e){return e.replace(/^0*(.*)/,"$1")||"0"}function P(e,t){var r=e.match(t.IPV4ADDRESS)||[],n=c(r,2)[1];return n?n.split(".").map(k).join("."):e}function T(e,t){var r=e.match(t.IPV6ADDRESS)||[],n=c(r,3),o=n[1],i=n[2];if(o){for(var s=o.toLowerCase().split("::").reverse(),a=c(s,2),u=a[0],l=a[1],d=l?l.split(":").map(k):[],h=u.split(":").map(k),p=t.IPV4ADDRESS.test(h[h.length-1]),f=p?7:8,m=h.length-f,g=Array(f),v=0;v<f;++v)g[v]=d[v]||h[m+v]||"";p&&(g[f-1]=P(g[f-1],t));var y=g.reduce((function(e,t,r){if(!t||"0"===t){var n=e[e.length-1];n&&n.index+n.length===r?n.length++:e.push({index:r,length:1})}return e}),[]).sort((function(e,t){return t.length-e.length}))[0],_=void 0;if(y&&y.length>1){var b=g.slice(0,y.index),E=g.slice(y.index+y.length);_=b.join(":")+"::"+E.join(":")}else _=g.join(":");return i&&(_+="%"+i),_}return e}var O=/^(?:([^:\/?#]+):)?(?:\/\/((?:([^\/?#@]*)@)?(\[[^\/?#\]]+\]|[^\/?#:]*)(?:\:(\d*))?))?([^?#]*)(?:\?([^#]*))?(?:#((?:.|\n|\r)*))?/i,A=void 0==="".match(/(){0}/)[1];function D(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r={},n=!1!==t.iri?a:s;"suffix"===t.reference&&(e=(t.scheme?t.scheme+":":"")+"//"+e);var o=e.match(O);if(o){A?(r.scheme=o[1],r.userinfo=o[3],r.host=o[4],r.port=parseInt(o[5],10),r.path=o[6]||"",r.query=o[7],r.fragment=o[8],isNaN(r.port)&&(r.port=o[5])):(r.scheme=o[1]||void 0,r.userinfo=-1!==e.indexOf("@")?o[3]:void 0,r.host=-1!==e.indexOf("//")?o[4]:void 0,r.port=parseInt(o[5],10),r.path=o[6]||"",r.query=-1!==e.indexOf("?")?o[7]:void 0,r.fragment=-1!==e.indexOf("#")?o[8]:void 0,isNaN(r.port)&&(r.port=e.match(/\/\/(?:.|\n)*\:(?:\/|\?|\#|$)/)?o[4]:void 0)),r.host&&(r.host=T(P(r.host,n),n)),void 0!==r.scheme||void 0!==r.userinfo||void 0!==r.host||void 0!==r.port||r.path||void 0!==r.query?void 0===r.scheme?r.reference="relative":void 0===r.fragment?r.reference="absolute":r.reference="uri":r.reference="same-document",t.reference&&"suffix"!==t.reference&&t.reference!==r.reference&&(r.error=r.error||"URI is not a "+t.reference+" reference.");var i=S[(t.scheme||r.scheme||"").toLowerCase()];if(t.unicodeSupport||i&&i.unicodeSupport)I(r,n);else{if(r.host&&(t.domainHost||i&&i.domainHost))try{r.host=b(r.host.replace(n.PCT_ENCODED,R).toLowerCase())}catch(e){r.error=r.error||"Host's domain name can not be converted to ASCII via punycode: "+e}I(r,s)}i&&i.parse&&i.parse(r,t)}else r.error=r.error||"URI can not be parsed.";return r}function C(e,t){var r=!1!==t.iri?a:s,n=[];return void 0!==e.userinfo&&(n.push(e.userinfo),n.push("@")),void 0!==e.host&&n.push(T(P(String(e.host),r),r).replace(r.IPV6ADDRESS,(function(e,t,r){return"["+t+(r?"%25"+r:"")+"]"}))),"number"==typeof e.port&&(n.push(":"),n.push(e.port.toString(10))),n.length?n.join(""):void 0}var x=/^\.\.?\//,M=/^\/\.(\/|$)/,j=/^\/\.\.(\/|$)/,U=/^\/?(?:.|\n)*?(?=\/|$)/;function N(e){for(var t=[];e.length;)if(e.match(x))e=e.replace(x,"");else if(e.match(M))e=e.replace(M,"/");else if(e.match(j))e=e.replace(j,"/"),t.pop();else if("."===e||".."===e)e="";else{var r=e.match(U);if(!r)throw new Error("Unexpected dot segment condition");var n=r[0];e=e.slice(n.length),t.push(n)}return t.join("")}function F(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=t.iri?a:s,n=[],o=S[(t.scheme||e.scheme||"").toLowerCase()];if(o&&o.serialize&&o.serialize(e,t),e.host)if(r.IPV6ADDRESS.test(e.host));else if(t.domainHost||o&&o.domainHost)try{e.host=t.iri?E(e.host):b(e.host.replace(r.PCT_ENCODED,R).toLowerCase())}catch(r){e.error=e.error||"Host's domain name can not be converted to "+(t.iri?"Unicode":"ASCII")+" via punycode: "+r}I(e,r),"suffix"!==t.reference&&e.scheme&&(n.push(e.scheme),n.push(":"));var i=C(e,t);if(void 0!==i&&("suffix"!==t.reference&&n.push("//"),n.push(i),e.path&&"/"!==e.path.charAt(0)&&n.push("/")),void 0!==e.path){var c=e.path;t.absolutePath||o&&o.absolutePath||(c=N(c)),void 0===i&&(c=c.replace(/^\/\//,"/%2F")),n.push(c)}return void 0!==e.query&&(n.push("?"),n.push(e.query)),void 0!==e.fragment&&(n.push("#"),n.push(e.fragment)),n.join("")}function L(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments[3],o={};return n||(e=D(F(e,r),r),t=D(F(t,r),r)),!(r=r||{}).tolerant&&t.scheme?(o.scheme=t.scheme,o.userinfo=t.userinfo,o.host=t.host,o.port=t.port,o.path=N(t.path||""),o.query=t.query):(void 0!==t.userinfo||void 0!==t.host||void 0!==t.port?(o.userinfo=t.userinfo,o.host=t.host,o.port=t.port,o.path=N(t.path||""),o.query=t.query):(t.path?("/"===t.path.charAt(0)?o.path=N(t.path):(void 0===e.userinfo&&void 0===e.host&&void 0===e.port||e.path?e.path?o.path=e.path.slice(0,e.path.lastIndexOf("/")+1)+t.path:o.path=t.path:o.path="/"+t.path,o.path=N(o.path)),o.query=t.query):(o.path=e.path,void 0!==t.query?o.query=t.query:o.query=e.query),o.userinfo=e.userinfo,o.host=e.host,o.port=e.port),o.scheme=e.scheme),o.fragment=t.fragment,o}function K(e,t){return e&&e.toString().replace(t&&t.iri?a.PCT_ENCODED:s.PCT_ENCODED,R)}var B={scheme:"http",domainHost:!0,parse:function(e,t){return e.host||(e.error=e.error||"HTTP URIs must have a host."),e},serialize:function(e,t){return e.port!==("https"!==String(e.scheme).toLowerCase()?80:443)&&""!==e.port||(e.port=void 0),e.path||(e.path="/"),e}},q={scheme:"https",domainHost:B.domainHost,parse:B.parse,serialize:B.serialize},$={},V="[A-Za-z0-9\\-\\.\\_\\~\\xA0-\\u200D\\u2010-\\u2029\\u202F-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF]",G="[0-9A-Fa-f]",H=r(r("%[EFef]"+G+"%"+G+G+"%"+G+G)+"|"+r("%[89A-Fa-f]"+G+"%"+G+G)+"|"+r("%"+G+G)),z=t("[\\!\\$\\%\\'\\(\\)\\*\\+\\,\\-\\.0-9\\<\\>A-Z\\x5E-\\x7E]",'[\\"\\\\]'),W=new RegExp(V,"g"),Q=new RegExp(H,"g"),Y=new RegExp(t("[^]","[A-Za-z0-9\\!\\$\\%\\'\\*\\+\\-\\^\\_\\`\\{\\|\\}\\~]","[\\.]",'[\\"]',z),"g"),X=new RegExp(t("[^]",V,"[\\!\\$\\'\\(\\)\\*\\+\\,\\;\\:\\@]"),"g"),J=X;function Z(e){var t=R(e);return t.match(W)?t:e}var ee={scheme:"mailto",parse:function(e,t){var r=e,n=r.to=r.path?r.path.split(","):[];if(r.path=void 0,r.query){for(var o=!1,i={},s=r.query.split("&"),a=0,c=s.length;a<c;++a){var u=s[a].split("=");switch(u[0]){case"to":for(var l=u[1].split(","),d=0,h=l.length;d<h;++d)n.push(l[d]);break;case"subject":r.subject=K(u[1],t);break;case"body":r.body=K(u[1],t);break;default:o=!0,i[K(u[0],t)]=K(u[1],t)}}o&&(r.headers=i)}r.query=void 0;for(var p=0,f=n.length;p<f;++p){var m=n[p].split("@");if(m[0]=K(m[0]),t.unicodeSupport)m[1]=K(m[1],t).toLowerCase();else try{m[1]=b(K(m[1],t).toLowerCase())}catch(e){r.error=r.error||"Email address's domain name can not be converted to ASCII via punycode: "+e}n[p]=m.join("@")}return r},serialize:function(e,t){var r,n=e,i=null!=(r=e.to)?r instanceof Array?r:"number"!=typeof r.length||r.split||r.setInterval||r.call?[r]:Array.prototype.slice.call(r):[];if(i){for(var s=0,a=i.length;s<a;++s){var c=String(i[s]),u=c.lastIndexOf("@"),l=c.slice(0,u).replace(Q,Z).replace(Q,o).replace(Y,w),d=c.slice(u+1);try{d=t.iri?E(d):b(K(d,t).toLowerCase())}catch(e){n.error=n.error||"Email address's domain name can not be converted to "+(t.iri?"Unicode":"ASCII")+" via punycode: "+e}i[s]=l+"@"+d}n.path=i.join(",")}var h=e.headers=e.headers||{};e.subject&&(h.subject=e.subject),e.body&&(h.body=e.body);var p=[];for(var f in h)h[f]!==$[f]&&p.push(f.replace(Q,Z).replace(Q,o).replace(X,w)+"="+h[f].replace(Q,Z).replace(Q,o).replace(J,w));return p.length&&(n.query=p.join("&")),n}},te=/^([^\:]+)\:(.*)/,re={scheme:"urn",parse:function(e,t){var r=e.path&&e.path.match(te),n=e;if(r){var o=t.scheme||n.scheme||"urn",i=r[1].toLowerCase(),s=r[2],a=o+":"+(t.nid||i),c=S[a];n.nid=i,n.nss=s,n.path=void 0,c&&(n=c.parse(n,t))}else n.error=n.error||"URN can not be parsed.";return n},serialize:function(e,t){var r=t.scheme||e.scheme||"urn",n=e.nid,o=r+":"+(t.nid||n),i=S[o];i&&(e=i.serialize(e,t));var s=e,a=e.nss;return s.path=(n||t.nid)+":"+a,s}},ne=/^[0-9A-Fa-f]{8}(?:\-[0-9A-Fa-f]{4}){3}\-[0-9A-Fa-f]{12}$/,oe={scheme:"urn:uuid",parse:function(e,t){var r=e;return r.uuid=r.nss,r.nss=void 0,t.tolerant||r.uuid&&r.uuid.match(ne)||(r.error=r.error||"UUID is not valid."),r},serialize:function(e,t){var r=e;return r.nss=(e.uuid||"").toLowerCase(),r}};S[B.scheme]=B,S[q.scheme]=q,S[ee.scheme]=ee,S[re.scheme]=re,S[oe.scheme]=oe,e.SCHEMES=S,e.pctEncChar=w,e.pctDecChars=R,e.parse=D,e.removeDotSegments=N,e.serialize=F,e.resolveComponents=L,e.resolve=function(e,t,r){var n=function(e,t){var r={scheme:"null"};if(t)for(var n in t)r[n]=t[n];return r}(0,r);return F(L(D(e,n),D(t,n),n,!0),n)},e.normalize=function(e,t){return"string"==typeof e?e=F(D(e,t),t):"object"===n(e)&&(e=D(F(e,t),t)),e},e.equal=function(e,t,r){return"string"==typeof e?e=F(D(e,r),r):"object"===n(e)&&(e=F(e,r)),"string"==typeof t?t=F(D(t,r),r):"object"===n(t)&&(t=F(t,r)),e===t},e.escapeComponent=function(e,t){return e&&e.toString().replace(t&&t.iri?a.ESCAPE:s.ESCAPE,w)},e.unescapeComponent=K,Object.defineProperty(e,"__esModule",{value:!0})}(t)},function(e,t,r){"use strict";e.exports=function(e){for(var t,r=0,n=e.length,o=0;o<n;)r++,(t=e.charCodeAt(o++))>=55296&&t<=56319&&o<n&&56320==(64512&(t=e.charCodeAt(o)))&&o++;return r}},function(e,t,r){"use strict";var n=e.exports=function(e,t,r){"function"==typeof t&&(r=t,t={}),function e(t,r,o,i,s,a,c,u,l,d){if(i&&"object"==typeof i&&!Array.isArray(i)){for(var h in r(i,s,a,c,u,l,d),i){var p=i[h];if(Array.isArray(p)){if(h in n.arrayKeywords)for(var f=0;f<p.length;f++)e(t,r,o,p[f],s+"/"+h+"/"+f,a,s,h,i,f)}else if(h in n.propsKeywords){if(p&&"object"==typeof p)for(var m in p)e(t,r,o,p[m],s+"/"+h+"/"+m.replace(/~/g,"~0").replace(/\//g,"~1"),a,s,h,i,m)}else(h in n.keywords||t.allKeys&&!(h in n.skipKeywords))&&e(t,r,o,p,s+"/"+h,a,s,h,i)}o(i,s,a,c,u,l,d)}}(t,"function"==typeof(r=t.cb||r)?r:r.pre||function(){},r.post||function(){},e,"",e)};n.keywords={additionalItems:!0,items:!0,contains:!0,additionalProperties:!0,propertyNames:!0,not:!0},n.arrayKeywords={items:!0,allOf:!0,anyOf:!0,oneOf:!0},n.propsKeywords={definitions:!0,properties:!0,patternProperties:!0,dependencies:!0},n.skipKeywords={default:!0,enum:!0,const:!0,required:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0}},function(e,t,r){"use strict";var n=e.exports=function(){this._cache={}};n.prototype.put=function(e,t){this._cache[e]=t},n.prototype.get=function(e){return this._cache[e]},n.prototype.del=function(e){delete this._cache[e]},n.prototype.clear=function(){this._cache={}}},function(e,t,r){"use strict";var n=r(4),o=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,i=[0,31,28,31,30,31,30,31,31,30,31,30,31],s=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,a=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,c=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,u=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,l=/^(?:(?:http[s\u017F]?|ftp):\/\/)(?:(?:[\0-\x08\x0E-\x1F!-\x9F\xA1-\u167F\u1681-\u1FFF\u200B-\u2027\u202A-\u202E\u2030-\u205E\u2060-\u2FFF\u3001-\uD7FF\uE000-\uFEFE\uFF00-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])+(?::(?:[\0-\x08\x0E-\x1F!-\x9F\xA1-\u167F\u1681-\u1FFF\u200B-\u2027\u202A-\u202E\u2030-\u205E\u2060-\u2FFF\u3001-\uD7FF\uE000-\uFEFE\uFF00-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*)?@)?(?:(?!10(?:\.[0-9]{1,3}){3})(?!127(?:\.[0-9]{1,3}){3})(?!169\.254(?:\.[0-9]{1,3}){2})(?!192\.168(?:\.[0-9]{1,3}){2})(?!172\.(?:1[6-9]|2[0-9]|3[01])(?:\.[0-9]{1,3}){2})(?:[1-9][0-9]?|1[0-9][0-9]|2[01][0-9]|22[0-3])(?:\.(?:1?[0-9]{1,2}|2[0-4][0-9]|25[0-5])){2}(?:\.(?:[1-9][0-9]?|1[0-9][0-9]|2[0-4][0-9]|25[0-4]))|(?:(?:(?:[0-9KSa-z\xA1-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])+-?)*(?:[0-9KSa-z\xA1-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])+)(?:\.(?:(?:[0-9KSa-z\xA1-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])+-?)*(?:[0-9KSa-z\xA1-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])+)*(?:\.(?:(?:[KSa-z\xA1-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]){2,})))(?::[0-9]{2,5})?(?:\/(?:[\0-\x08\x0E-\x1F!-\x9F\xA1-\u167F\u1681-\u1FFF\u200B-\u2027\u202A-\u202E\u2030-\u205E\u2060-\u2FFF\u3001-\uD7FF\uE000-\uFEFE\uFF00-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*)?$/i,d=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,h=/^(?:\/(?:[^~/]|~0|~1)*)*$/,p=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,f=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/;function m(e){return e="full"==e?"full":"fast",n.copy(m[e])}function g(e){var t=e.match(o);if(!t)return!1;var r=+t[1],n=+t[2],s=+t[3];return n>=1&&n<=12&&s>=1&&s<=(2==n&&function(e){return e%4==0&&(e%100!=0||e%400==0)}(r)?29:i[n])}function v(e,t){var r=e.match(s);if(!r)return!1;var n=r[1],o=r[2],i=r[3],a=r[5];return(n<=23&&o<=59&&i<=59||23==n&&59==o&&60==i)&&(!t||a)}e.exports=m,m.fast={date:/^\d\d\d\d-[0-1]\d-[0-3]\d$/,time:/^(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)?$/i,"date-time":/^\d\d\d\d-[0-1]\d-[0-3]\d[t\s](?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)$/i,uri:/^(?:[a-z][a-z0-9+-.]*:)(?:\/?\/)?[^\s]*$/i,"uri-reference":/^(?:(?:[a-z][a-z0-9+-.]*:)?\/?\/)?(?:[^\\\s#][^\s#]*)?(?:#[^\\\s]*)?$/i,"uri-template":u,url:l,email:/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?)*$/i,hostname:a,ipv4:/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,ipv6:/^\s*(?:(?:(?:[0-9a-f]{1,4}:){7}(?:[0-9a-f]{1,4}|:))|(?:(?:[0-9a-f]{1,4}:){6}(?::[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(?:(?:[0-9a-f]{1,4}:){5}(?:(?:(?::[0-9a-f]{1,4}){1,2})|:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(?:(?:[0-9a-f]{1,4}:){4}(?:(?:(?::[0-9a-f]{1,4}){1,3})|(?:(?::[0-9a-f]{1,4})?:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(?:(?:[0-9a-f]{1,4}:){3}(?:(?:(?::[0-9a-f]{1,4}){1,4})|(?:(?::[0-9a-f]{1,4}){0,2}:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(?:(?:[0-9a-f]{1,4}:){2}(?:(?:(?::[0-9a-f]{1,4}){1,5})|(?:(?::[0-9a-f]{1,4}){0,3}:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(?:(?:[0-9a-f]{1,4}:){1}(?:(?:(?::[0-9a-f]{1,4}){1,6})|(?:(?::[0-9a-f]{1,4}){0,4}:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(?::(?:(?:(?::[0-9a-f]{1,4}){1,7})|(?:(?::[0-9a-f]{1,4}){0,5}:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(?:%.+)?\s*$/i,regex:E,uuid:d,"json-pointer":h,"json-pointer-uri-fragment":p,"relative-json-pointer":f},m.full={date:g,time:v,"date-time":function(e){var t=e.split(y);return 2==t.length&&g(t[0])&&v(t[1],!0)},uri:function(e){return _.test(e)&&c.test(e)},"uri-reference":/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,"uri-template":u,url:l,email:/^[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$/i,hostname:a,ipv4:/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,ipv6:/^\s*(?:(?:(?:[0-9a-f]{1,4}:){7}(?:[0-9a-f]{1,4}|:))|(?:(?:[0-9a-f]{1,4}:){6}(?::[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(?:(?:[0-9a-f]{1,4}:){5}(?:(?:(?::[0-9a-f]{1,4}){1,2})|:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(?:(?:[0-9a-f]{1,4}:){4}(?:(?:(?::[0-9a-f]{1,4}){1,3})|(?:(?::[0-9a-f]{1,4})?:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(?:(?:[0-9a-f]{1,4}:){3}(?:(?:(?::[0-9a-f]{1,4}){1,4})|(?:(?::[0-9a-f]{1,4}){0,2}:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(?:(?:[0-9a-f]{1,4}:){2}(?:(?:(?::[0-9a-f]{1,4}){1,5})|(?:(?::[0-9a-f]{1,4}){0,3}:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(?:(?:[0-9a-f]{1,4}:){1}(?:(?:(?::[0-9a-f]{1,4}){1,6})|(?:(?::[0-9a-f]{1,4}){0,4}:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(?::(?:(?:(?::[0-9a-f]{1,4}){1,7})|(?:(?::[0-9a-f]{1,4}){0,5}:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(?:%.+)?\s*$/i,regex:E,uuid:d,"json-pointer":h,"json-pointer-uri-fragment":p,"relative-json-pointer":f};var y=/t|\s/i,_=/\/|:/,b=/[^\\]\\Z/;function E(e){if(b.test(e))return!1;try{return new RegExp(e),!0}catch(e){return!1}}},function(e,t,r){"use strict";var n=r(52),o=r(4).toHash;e.exports=function(){var e=[{type:"number",rules:[{maximum:["exclusiveMaximum"]},{minimum:["exclusiveMinimum"]},"multipleOf","format"]},{type:"string",rules:["maxLength","minLength","pattern","format"]},{type:"array",rules:["maxItems","minItems","items","contains","uniqueItems"]},{type:"object",rules:["maxProperties","minProperties","required","dependencies","propertyNames",{properties:["additionalProperties","patternProperties"]}]},{rules:["$ref","const","enum","not","anyOf","oneOf","allOf","if"]}],t=["type","$comment"];return e.all=o(t),e.types=o(["number","integer","string","array","object","boolean","null"]),e.forEach((function(r){r.rules=r.rules.map((function(r){var o;if("object"==typeof r){var i=Object.keys(r)[0];o=r[i],r=i,o.forEach((function(r){t.push(r),e.all[r]=!0}))}return t.push(r),e.all[r]={keyword:r,code:n[r],implements:o}})),e.all.$comment={keyword:"$comment",code:n.$comment},r.type&&(e.types[r.type]=r)})),e.keywords=o(t.concat(["$schema","$id","id","$data","$async","title","description","default","definitions","examples","readOnly","writeOnly","contentMediaType","contentEncoding","additionalItems","then","else"])),e.custom={},e}},function(e,t,r){"use strict";e.exports={$ref:r(53),allOf:r(54),anyOf:r(55),$comment:r(56),const:r(57),contains:r(58),dependencies:r(59),enum:r(60),format:r(61),if:r(62),items:r(63),maximum:r(23),minimum:r(23),maxItems:r(24),minItems:r(24),maxLength:r(25),minLength:r(25),maxProperties:r(26),minProperties:r(26),multipleOf:r(64),not:r(65),oneOf:r(66),pattern:r(67),properties:r(68),propertyNames:r(69),required:r(70),uniqueItems:r(71),validate:r(22)}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n,o,i=" ",s=e.level,a=e.dataLevel,c=e.schema[t],u=e.errSchemaPath+"/"+t,l=!e.opts.allErrors,d="data"+(a||""),h="valid"+s;if("#"==c||"#/"==c)e.isRoot?(n=e.async,o="validate"):(n=!0===e.root.schema.$async,o="root.refVal[0]");else{var p=e.resolveRef(e.baseId,c,e.isRoot);if(void 0===p){var f=e.MissingRefError.message(e.baseId,c);if("fail"==e.opts.missingRefs){e.logger.error(f),(y=y||[]).push(i),i="",!1!==e.createErrors?(i+=" { keyword: '$ref' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(u)+" , params: { ref: '"+e.util.escapeQuotes(c)+"' } ",!1!==e.opts.messages&&(i+=" , message: 'can\\'t resolve reference "+e.util.escapeQuotes(c)+"' "),e.opts.verbose&&(i+=" , schema: "+e.util.toQuotedString(c)+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+d+" "),i+=" } "):i+=" {} ";var m=i;i=y.pop(),!e.compositeRule&&l?e.async?i+=" throw new ValidationError(["+m+"]); ":i+=" validate.errors = ["+m+"]; return false; ":i+=" var err = "+m+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",l&&(i+=" if (false) { ")}else{if("ignore"!=e.opts.missingRefs)throw new e.MissingRefError(e.baseId,c,f);e.logger.warn(f),l&&(i+=" if (true) { ")}}else if(p.inline){var g=e.util.copy(e);g.level++;var v="valid"+g.level;g.schema=p.schema,g.schemaPath="",g.errSchemaPath=c,i+=" "+e.validate(g).replace(/validate\.schema/g,p.code)+" ",l&&(i+=" if ("+v+") { ")}else n=!0===p.$async||e.async&&!1!==p.$async,o=p.code}if(o){var y;(y=y||[]).push(i),i="",e.opts.passContext?i+=" "+o+".call(this, ":i+=" "+o+"( ",i+=" "+d+", (dataPath || '')",'""'!=e.errorPath&&(i+=" + "+e.errorPath);var _=i+=" , "+(a?"data"+(a-1||""):"parentData")+" , "+(a?e.dataPathArr[a]:"parentDataProperty")+", rootData)  ";if(i=y.pop(),n){if(!e.async)throw new Error("async schema referenced by sync schema");l&&(i+=" var "+h+"; "),i+=" try { await "+_+"; ",l&&(i+=" "+h+" = true; "),i+=" } catch (e) { if (!(e instanceof ValidationError)) throw e; if (vErrors === null) vErrors = e.errors; else vErrors = vErrors.concat(e.errors); errors = vErrors.length; ",l&&(i+=" "+h+" = false; "),i+=" } ",l&&(i+=" if ("+h+") { ")}else i+=" if (!"+_+") { if (vErrors === null) vErrors = "+o+".errors; else vErrors = vErrors.concat("+o+".errors); errors = vErrors.length; } ",l&&(i+=" else { ")}return i}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.schema[t],i=e.schemaPath+e.util.getProperty(t),s=e.errSchemaPath+"/"+t,a=!e.opts.allErrors,c=e.util.copy(e),u="";c.level++;var l="valid"+c.level,d=c.baseId,h=!0,p=o;if(p)for(var f,m=-1,g=p.length-1;m<g;)f=p[m+=1],(e.opts.strictKeywords?"object"==typeof f&&Object.keys(f).length>0:e.util.schemaHasRules(f,e.RULES.all))&&(h=!1,c.schema=f,c.schemaPath=i+"["+m+"]",c.errSchemaPath=s+"/"+m,n+="  "+e.validate(c)+" ",c.baseId=d,a&&(n+=" if ("+l+") { ",u+="}"));return a&&(n+=h?" if (true) { ":" "+u.slice(0,-1)+" "),n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="valid"+o,h="errs__"+o,p=e.util.copy(e),f="";p.level++;var m="valid"+p.level;if(s.every((function(t){return e.opts.strictKeywords?"object"==typeof t&&Object.keys(t).length>0:e.util.schemaHasRules(t,e.RULES.all)}))){var g=p.baseId;n+=" var "+h+" = errors; var "+d+" = false;  ";var v=e.compositeRule;e.compositeRule=p.compositeRule=!0;var y=s;if(y)for(var _,b=-1,E=y.length-1;b<E;)_=y[b+=1],p.schema=_,p.schemaPath=a+"["+b+"]",p.errSchemaPath=c+"/"+b,n+="  "+e.validate(p)+" ",p.baseId=g,n+=" "+d+" = "+d+" || "+m+"; if (!"+d+") { ",f+="}";e.compositeRule=p.compositeRule=v,n+=" "+f+" if (!"+d+") {   var err =   ",!1!==e.createErrors?(n+=" { keyword: 'anyOf' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: {} ",!1!==e.opts.messages&&(n+=" , message: 'should match some schema in anyOf' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ",n+=";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",!e.compositeRule&&u&&(e.async?n+=" throw new ValidationError(vErrors); ":n+=" validate.errors = vErrors; return false; "),n+=" } else {  errors = "+h+"; if (vErrors !== null) { if ("+h+") vErrors.length = "+h+"; else vErrors = null; } ",e.opts.allErrors&&(n+=" } ")}else u&&(n+=" if (true) { ");return n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.schema[t],i=e.errSchemaPath+"/"+t,s=(e.opts.allErrors,e.util.toQuotedString(o));return!0===e.opts.$comment?n+=" console.log("+s+");":"function"==typeof e.opts.$comment&&(n+=" self._opts.$comment("+s+", "+e.util.toQuotedString(i)+", validate.root.schema);"),n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="valid"+o,h=e.opts.$data&&s&&s.$data;h&&(n+=" var schema"+o+" = "+e.util.getData(s.$data,i,e.dataPathArr)+"; "),h||(n+=" var schema"+o+" = validate.schema"+a+";"),n+="var "+d+" = equal("+l+", schema"+o+"); if (!"+d+") {   ";var p=p||[];p.push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'const' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { allowedValue: schema"+o+" } ",!1!==e.opts.messages&&(n+=" , message: 'should be equal to constant' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ";var f=n;return n=p.pop(),!e.compositeRule&&u?e.async?n+=" throw new ValidationError(["+f+"]); ":n+=" validate.errors = ["+f+"]; return false; ":n+=" var err = "+f+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",n+=" }",u&&(n+=" else { "),n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="valid"+o,h="errs__"+o,p=e.util.copy(e);p.level++;var f="valid"+p.level,m="i"+o,g=p.dataLevel=e.dataLevel+1,v="data"+g,y=e.baseId,_=e.opts.strictKeywords?"object"==typeof s&&Object.keys(s).length>0:e.util.schemaHasRules(s,e.RULES.all);if(n+="var "+h+" = errors;var "+d+";",_){var b=e.compositeRule;e.compositeRule=p.compositeRule=!0,p.schema=s,p.schemaPath=a,p.errSchemaPath=c,n+=" var "+f+" = false; for (var "+m+" = 0; "+m+" < "+l+".length; "+m+"++) { ",p.errorPath=e.util.getPathExpr(e.errorPath,m,e.opts.jsonPointers,!0);var E=l+"["+m+"]";p.dataPathArr[g]=m;var S=e.validate(p);p.baseId=y,e.util.varOccurences(S,v)<2?n+=" "+e.util.varReplace(S,v,E)+" ":n+=" var "+v+" = "+E+"; "+S+" ",n+=" if ("+f+") break; }  ",e.compositeRule=p.compositeRule=b,n+="  if (!"+f+") {"}else n+=" if ("+l+".length == 0) {";var w=w||[];w.push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'contains' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: {} ",!1!==e.opts.messages&&(n+=" , message: 'should contain a valid item' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ";var R=n;return n=w.pop(),!e.compositeRule&&u?e.async?n+=" throw new ValidationError(["+R+"]); ":n+=" validate.errors = ["+R+"]; return false; ":n+=" var err = "+R+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",n+=" } else { ",_&&(n+="  errors = "+h+"; if (vErrors !== null) { if ("+h+") vErrors.length = "+h+"; else vErrors = null; } "),e.opts.allErrors&&(n+=" } "),n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="errs__"+o,h=e.util.copy(e),p="";h.level++;var f="valid"+h.level,m={},g={},v=e.opts.ownProperties;for(E in s)if("__proto__"!=E){var y=s[E],_=Array.isArray(y)?g:m;_[E]=y}n+="var "+d+" = errors;";var b=e.errorPath;for(var E in n+="var missing"+o+";",g)if((_=g[E]).length){if(n+=" if ( "+l+e.util.getProperty(E)+" !== undefined ",v&&(n+=" && Object.prototype.hasOwnProperty.call("+l+", '"+e.util.escapeQuotes(E)+"') "),u){n+=" && ( ";var S=_;if(S)for(var w=-1,R=S.length-1;w<R;)A=S[w+=1],w&&(n+=" || "),n+=" ( ( "+(M=l+(x=e.util.getProperty(A)))+" === undefined ",v&&(n+=" || ! Object.prototype.hasOwnProperty.call("+l+", '"+e.util.escapeQuotes(A)+"') "),n+=") && (missing"+o+" = "+e.util.toQuotedString(e.opts.jsonPointers?A:x)+") ) ";n+=")) {  ";var I="missing"+o,k="' + "+I+" + '";e.opts._errorDataPathProperty&&(e.errorPath=e.opts.jsonPointers?e.util.getPathExpr(b,I,!0):b+" + "+I);var P=P||[];P.push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'dependencies' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { property: '"+e.util.escapeQuotes(E)+"', missingProperty: '"+k+"', depsCount: "+_.length+", deps: '"+e.util.escapeQuotes(1==_.length?_[0]:_.join(", "))+"' } ",!1!==e.opts.messages&&(n+=" , message: 'should have ",1==_.length?n+="property "+e.util.escapeQuotes(_[0]):n+="properties "+e.util.escapeQuotes(_.join(", ")),n+=" when property "+e.util.escapeQuotes(E)+" is present' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ";var T=n;n=P.pop(),!e.compositeRule&&u?e.async?n+=" throw new ValidationError(["+T+"]); ":n+=" validate.errors = ["+T+"]; return false; ":n+=" var err = "+T+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; "}else{n+=" ) { ";var O=_;if(O)for(var A,D=-1,C=O.length-1;D<C;){A=O[D+=1];var x=e.util.getProperty(A),M=(k=e.util.escapeQuotes(A),l+x);e.opts._errorDataPathProperty&&(e.errorPath=e.util.getPath(b,A,e.opts.jsonPointers)),n+=" if ( "+M+" === undefined ",v&&(n+=" || ! Object.prototype.hasOwnProperty.call("+l+", '"+e.util.escapeQuotes(A)+"') "),n+=") {  var err =   ",!1!==e.createErrors?(n+=" { keyword: 'dependencies' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { property: '"+e.util.escapeQuotes(E)+"', missingProperty: '"+k+"', depsCount: "+_.length+", deps: '"+e.util.escapeQuotes(1==_.length?_[0]:_.join(", "))+"' } ",!1!==e.opts.messages&&(n+=" , message: 'should have ",1==_.length?n+="property "+e.util.escapeQuotes(_[0]):n+="properties "+e.util.escapeQuotes(_.join(", ")),n+=" when property "+e.util.escapeQuotes(E)+" is present' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ",n+=";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; } "}}n+=" }   ",u&&(p+="}",n+=" else { ")}e.errorPath=b;var j=h.baseId;for(var E in m)y=m[E],(e.opts.strictKeywords?"object"==typeof y&&Object.keys(y).length>0:e.util.schemaHasRules(y,e.RULES.all))&&(n+=" "+f+" = true; if ( "+l+e.util.getProperty(E)+" !== undefined ",v&&(n+=" && Object.prototype.hasOwnProperty.call("+l+", '"+e.util.escapeQuotes(E)+"') "),n+=") { ",h.schema=y,h.schemaPath=a+e.util.getProperty(E),h.errSchemaPath=c+"/"+e.util.escapeFragment(E),n+="  "+e.validate(h)+" ",h.baseId=j,n+=" }  ",u&&(n+=" if ("+f+") { ",p+="}"));return u&&(n+="   "+p+" if ("+d+" == errors) {"),n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="valid"+o,h=e.opts.$data&&s&&s.$data;h&&(n+=" var schema"+o+" = "+e.util.getData(s.$data,i,e.dataPathArr)+"; ");var p="i"+o,f="schema"+o;h||(n+=" var "+f+" = validate.schema"+a+";"),n+="var "+d+";",h&&(n+=" if (schema"+o+" === undefined) "+d+" = true; else if (!Array.isArray(schema"+o+")) "+d+" = false; else {"),n+=d+" = false;for (var "+p+"=0; "+p+"<"+f+".length; "+p+"++) if (equal("+l+", "+f+"["+p+"])) { "+d+" = true; break; }",h&&(n+="  }  "),n+=" if (!"+d+") {   ";var m=m||[];m.push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'enum' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { allowedValues: schema"+o+" } ",!1!==e.opts.messages&&(n+=" , message: 'should be equal to one of the allowed values' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ";var g=n;return n=m.pop(),!e.compositeRule&&u?e.async?n+=" throw new ValidationError(["+g+"]); ":n+=" validate.errors = ["+g+"]; return false; ":n+=" var err = "+g+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",n+=" }",u&&(n+=" else { "),n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||"");if(!1===e.opts.format)return u&&(n+=" if (true) { "),n;var d,h=e.opts.$data&&s&&s.$data;h?(n+=" var schema"+o+" = "+e.util.getData(s.$data,i,e.dataPathArr)+"; ",d="schema"+o):d=s;var p=e.opts.unknownFormats,f=Array.isArray(p);if(h)n+=" var "+(m="format"+o)+" = formats["+d+"]; var "+(g="isObject"+o)+" = typeof "+m+" == 'object' && !("+m+" instanceof RegExp) && "+m+".validate; var "+(v="formatType"+o)+" = "+g+" && "+m+".type || 'string'; if ("+g+") { ",e.async&&(n+=" var async"+o+" = "+m+".async; "),n+=" "+m+" = "+m+".validate; } if (  ",h&&(n+=" ("+d+" !== undefined && typeof "+d+" != 'string') || "),n+=" (","ignore"!=p&&(n+=" ("+d+" && !"+m+" ",f&&(n+=" && self._opts.unknownFormats.indexOf("+d+") == -1 "),n+=") || "),n+=" ("+m+" && "+v+" == '"+r+"' && !(typeof "+m+" == 'function' ? ",e.async?n+=" (async"+o+" ? await "+m+"("+l+") : "+m+"("+l+")) ":n+=" "+m+"("+l+") ",n+=" : "+m+".test("+l+"))))) {";else{var m;if(!(m=e.formats[s])){if("ignore"==p)return e.logger.warn('unknown format "'+s+'" ignored in schema at path "'+e.errSchemaPath+'"'),u&&(n+=" if (true) { "),n;if(f&&p.indexOf(s)>=0)return u&&(n+=" if (true) { "),n;throw new Error('unknown format "'+s+'" is used in schema at path "'+e.errSchemaPath+'"')}var g,v=(g="object"==typeof m&&!(m instanceof RegExp)&&m.validate)&&m.type||"string";if(g){var y=!0===m.async;m=m.validate}if(v!=r)return u&&(n+=" if (true) { "),n;if(y){if(!e.async)throw new Error("async format in sync schema");n+=" if (!(await "+(_="formats"+e.util.getProperty(s)+".validate")+"("+l+"))) { "}else{n+=" if (! ";var _="formats"+e.util.getProperty(s);g&&(_+=".validate"),n+="function"==typeof m?" "+_+"("+l+") ":" "+_+".test("+l+") ",n+=") { "}}var b=b||[];b.push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'format' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { format:  ",n+=h?""+d:""+e.util.toQuotedString(s),n+="  } ",!1!==e.opts.messages&&(n+=" , message: 'should match format \"",n+=h?"' + "+d+" + '":""+e.util.escapeQuotes(s),n+="\"' "),e.opts.verbose&&(n+=" , schema:  ",n+=h?"validate.schema"+a:""+e.util.toQuotedString(s),n+="         , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ";var E=n;return n=b.pop(),!e.compositeRule&&u?e.async?n+=" throw new ValidationError(["+E+"]); ":n+=" validate.errors = ["+E+"]; return false; ":n+=" var err = "+E+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",n+=" } ",u&&(n+=" else { "),n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="valid"+o,h="errs__"+o,p=e.util.copy(e);p.level++;var f="valid"+p.level,m=e.schema.then,g=e.schema.else,v=void 0!==m&&(e.opts.strictKeywords?"object"==typeof m&&Object.keys(m).length>0:e.util.schemaHasRules(m,e.RULES.all)),y=void 0!==g&&(e.opts.strictKeywords?"object"==typeof g&&Object.keys(g).length>0:e.util.schemaHasRules(g,e.RULES.all)),_=p.baseId;if(v||y){var b;p.createErrors=!1,p.schema=s,p.schemaPath=a,p.errSchemaPath=c,n+=" var "+h+" = errors; var "+d+" = true;  ";var E=e.compositeRule;e.compositeRule=p.compositeRule=!0,n+="  "+e.validate(p)+" ",p.baseId=_,p.createErrors=!0,n+="  errors = "+h+"; if (vErrors !== null) { if ("+h+") vErrors.length = "+h+"; else vErrors = null; }  ",e.compositeRule=p.compositeRule=E,v?(n+=" if ("+f+") {  ",p.schema=e.schema.then,p.schemaPath=e.schemaPath+".then",p.errSchemaPath=e.errSchemaPath+"/then",n+="  "+e.validate(p)+" ",p.baseId=_,n+=" "+d+" = "+f+"; ",v&&y?n+=" var "+(b="ifClause"+o)+" = 'then'; ":b="'then'",n+=" } ",y&&(n+=" else { ")):n+=" if (!"+f+") { ",y&&(p.schema=e.schema.else,p.schemaPath=e.schemaPath+".else",p.errSchemaPath=e.errSchemaPath+"/else",n+="  "+e.validate(p)+" ",p.baseId=_,n+=" "+d+" = "+f+"; ",v&&y?n+=" var "+(b="ifClause"+o)+" = 'else'; ":b="'else'",n+=" } "),n+=" if (!"+d+") {   var err =   ",!1!==e.createErrors?(n+=" { keyword: 'if' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { failingKeyword: "+b+" } ",!1!==e.opts.messages&&(n+=" , message: 'should match \"' + "+b+" + '\" schema' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ",n+=";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",!e.compositeRule&&u&&(e.async?n+=" throw new ValidationError(vErrors); ":n+=" validate.errors = vErrors; return false; "),n+=" }   ",u&&(n+=" else { ")}else u&&(n+=" if (true) { ");return n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="valid"+o,h="errs__"+o,p=e.util.copy(e),f="";p.level++;var m="valid"+p.level,g="i"+o,v=p.dataLevel=e.dataLevel+1,y="data"+v,_=e.baseId;if(n+="var "+h+" = errors;var "+d+";",Array.isArray(s)){var b=e.schema.additionalItems;if(!1===b){n+=" "+d+" = "+l+".length <= "+s.length+"; ";var E=c;c=e.errSchemaPath+"/additionalItems",n+="  if (!"+d+") {   ";var S=S||[];S.push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'additionalItems' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { limit: "+s.length+" } ",!1!==e.opts.messages&&(n+=" , message: 'should NOT have more than "+s.length+" items' "),e.opts.verbose&&(n+=" , schema: false , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ";var w=n;n=S.pop(),!e.compositeRule&&u?e.async?n+=" throw new ValidationError(["+w+"]); ":n+=" validate.errors = ["+w+"]; return false; ":n+=" var err = "+w+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",n+=" } ",c=E,u&&(f+="}",n+=" else { ")}var R=s;if(R)for(var I,k=-1,P=R.length-1;k<P;)if(I=R[k+=1],e.opts.strictKeywords?"object"==typeof I&&Object.keys(I).length>0:e.util.schemaHasRules(I,e.RULES.all)){n+=" "+m+" = true; if ("+l+".length > "+k+") { ";var T=l+"["+k+"]";p.schema=I,p.schemaPath=a+"["+k+"]",p.errSchemaPath=c+"/"+k,p.errorPath=e.util.getPathExpr(e.errorPath,k,e.opts.jsonPointers,!0),p.dataPathArr[v]=k;var O=e.validate(p);p.baseId=_,e.util.varOccurences(O,y)<2?n+=" "+e.util.varReplace(O,y,T)+" ":n+=" var "+y+" = "+T+"; "+O+" ",n+=" }  ",u&&(n+=" if ("+m+") { ",f+="}")}"object"==typeof b&&(e.opts.strictKeywords?"object"==typeof b&&Object.keys(b).length>0:e.util.schemaHasRules(b,e.RULES.all))&&(p.schema=b,p.schemaPath=e.schemaPath+".additionalItems",p.errSchemaPath=e.errSchemaPath+"/additionalItems",n+=" "+m+" = true; if ("+l+".length > "+s.length+") {  for (var "+g+" = "+s.length+"; "+g+" < "+l+".length; "+g+"++) { ",p.errorPath=e.util.getPathExpr(e.errorPath,g,e.opts.jsonPointers,!0),T=l+"["+g+"]",p.dataPathArr[v]=g,O=e.validate(p),p.baseId=_,e.util.varOccurences(O,y)<2?n+=" "+e.util.varReplace(O,y,T)+" ":n+=" var "+y+" = "+T+"; "+O+" ",u&&(n+=" if (!"+m+") break; "),n+=" } }  ",u&&(n+=" if ("+m+") { ",f+="}"))}else(e.opts.strictKeywords?"object"==typeof s&&Object.keys(s).length>0:e.util.schemaHasRules(s,e.RULES.all))&&(p.schema=s,p.schemaPath=a,p.errSchemaPath=c,n+="  for (var "+g+" = 0; "+g+" < "+l+".length; "+g+"++) { ",p.errorPath=e.util.getPathExpr(e.errorPath,g,e.opts.jsonPointers,!0),T=l+"["+g+"]",p.dataPathArr[v]=g,O=e.validate(p),p.baseId=_,e.util.varOccurences(O,y)<2?n+=" "+e.util.varReplace(O,y,T)+" ":n+=" var "+y+" = "+T+"; "+O+" ",u&&(n+=" if (!"+m+") break; "),n+=" }");return u&&(n+=" "+f+" if ("+h+" == errors) {"),n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n,o=" ",i=e.level,s=e.dataLevel,a=e.schema[t],c=e.schemaPath+e.util.getProperty(t),u=e.errSchemaPath+"/"+t,l=!e.opts.allErrors,d="data"+(s||""),h=e.opts.$data&&a&&a.$data;if(h?(o+=" var schema"+i+" = "+e.util.getData(a.$data,s,e.dataPathArr)+"; ",n="schema"+i):n=a,!h&&"number"!=typeof a)throw new Error(t+" must be number");o+="var division"+i+";if (",h&&(o+=" "+n+" !== undefined && ( typeof "+n+" != 'number' || "),o+=" (division"+i+" = "+d+" / "+n+", ",e.opts.multipleOfPrecision?o+=" Math.abs(Math.round(division"+i+") - division"+i+") > 1e-"+e.opts.multipleOfPrecision+" ":o+=" division"+i+" !== parseInt(division"+i+") ",o+=" ) ",h&&(o+="  )  "),o+=" ) {   ";var p=p||[];p.push(o),o="",!1!==e.createErrors?(o+=" { keyword: 'multipleOf' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(u)+" , params: { multipleOf: "+n+" } ",!1!==e.opts.messages&&(o+=" , message: 'should be multiple of ",o+=h?"' + "+n:n+"'"),e.opts.verbose&&(o+=" , schema:  ",o+=h?"validate.schema"+c:""+a,o+="         , parentSchema: validate.schema"+e.schemaPath+" , data: "+d+" "),o+=" } "):o+=" {} ";var f=o;return o=p.pop(),!e.compositeRule&&l?e.async?o+=" throw new ValidationError(["+f+"]); ":o+=" validate.errors = ["+f+"]; return false; ":o+=" var err = "+f+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",o+="} ",l&&(o+=" else { "),o}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="errs__"+o,h=e.util.copy(e);h.level++;var p="valid"+h.level;if(e.opts.strictKeywords?"object"==typeof s&&Object.keys(s).length>0:e.util.schemaHasRules(s,e.RULES.all)){h.schema=s,h.schemaPath=a,h.errSchemaPath=c,n+=" var "+d+" = errors;  ";var f,m=e.compositeRule;e.compositeRule=h.compositeRule=!0,h.createErrors=!1,h.opts.allErrors&&(f=h.opts.allErrors,h.opts.allErrors=!1),n+=" "+e.validate(h)+" ",h.createErrors=!0,f&&(h.opts.allErrors=f),e.compositeRule=h.compositeRule=m,n+=" if ("+p+") {   ";var g=g||[];g.push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'not' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: {} ",!1!==e.opts.messages&&(n+=" , message: 'should NOT be valid' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ";var v=n;n=g.pop(),!e.compositeRule&&u?e.async?n+=" throw new ValidationError(["+v+"]); ":n+=" validate.errors = ["+v+"]; return false; ":n+=" var err = "+v+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",n+=" } else {  errors = "+d+"; if (vErrors !== null) { if ("+d+") vErrors.length = "+d+"; else vErrors = null; } ",e.opts.allErrors&&(n+=" } ")}else n+="  var err =   ",!1!==e.createErrors?(n+=" { keyword: 'not' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: {} ",!1!==e.opts.messages&&(n+=" , message: 'should NOT be valid' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ",n+=";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",u&&(n+=" if (false) { ");return n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="valid"+o,h="errs__"+o,p=e.util.copy(e),f="";p.level++;var m="valid"+p.level,g=p.baseId,v="prevValid"+o,y="passingSchemas"+o;n+="var "+h+" = errors , "+v+" = false , "+d+" = false , "+y+" = null; ";var _=e.compositeRule;e.compositeRule=p.compositeRule=!0;var b=s;if(b)for(var E,S=-1,w=b.length-1;S<w;)E=b[S+=1],(e.opts.strictKeywords?"object"==typeof E&&Object.keys(E).length>0:e.util.schemaHasRules(E,e.RULES.all))?(p.schema=E,p.schemaPath=a+"["+S+"]",p.errSchemaPath=c+"/"+S,n+="  "+e.validate(p)+" ",p.baseId=g):n+=" var "+m+" = true; ",S&&(n+=" if ("+m+" && "+v+") { "+d+" = false; "+y+" = ["+y+", "+S+"]; } else { ",f+="}"),n+=" if ("+m+") { "+d+" = "+v+" = true; "+y+" = "+S+"; }";return e.compositeRule=p.compositeRule=_,n+=f+"if (!"+d+") {   var err =   ",!1!==e.createErrors?(n+=" { keyword: 'oneOf' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { passingSchemas: "+y+" } ",!1!==e.opts.messages&&(n+=" , message: 'should match exactly one schema in oneOf' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ",n+=";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",!e.compositeRule&&u&&(e.async?n+=" throw new ValidationError(vErrors); ":n+=" validate.errors = vErrors; return false; "),n+="} else {  errors = "+h+"; if (vErrors !== null) { if ("+h+") vErrors.length = "+h+"; else vErrors = null; }",e.opts.allErrors&&(n+=" } "),n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n,o=" ",i=e.level,s=e.dataLevel,a=e.schema[t],c=e.schemaPath+e.util.getProperty(t),u=e.errSchemaPath+"/"+t,l=!e.opts.allErrors,d="data"+(s||""),h=e.opts.$data&&a&&a.$data;h?(o+=" var schema"+i+" = "+e.util.getData(a.$data,s,e.dataPathArr)+"; ",n="schema"+i):n=a,o+="if ( ",h&&(o+=" ("+n+" !== undefined && typeof "+n+" != 'string') || "),o+=" !"+(h?"(new RegExp("+n+"))":e.usePattern(a))+".test("+d+") ) {   ";var p=p||[];p.push(o),o="",!1!==e.createErrors?(o+=" { keyword: 'pattern' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(u)+" , params: { pattern:  ",o+=h?""+n:""+e.util.toQuotedString(a),o+="  } ",!1!==e.opts.messages&&(o+=" , message: 'should match pattern \"",o+=h?"' + "+n+" + '":""+e.util.escapeQuotes(a),o+="\"' "),e.opts.verbose&&(o+=" , schema:  ",o+=h?"validate.schema"+c:""+e.util.toQuotedString(a),o+="         , parentSchema: validate.schema"+e.schemaPath+" , data: "+d+" "),o+=" } "):o+=" {} ";var f=o;return o=p.pop(),!e.compositeRule&&l?e.async?o+=" throw new ValidationError(["+f+"]); ":o+=" validate.errors = ["+f+"]; return false; ":o+=" var err = "+f+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",o+="} ",l&&(o+=" else { "),o}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="errs__"+o,h=e.util.copy(e),p="";h.level++;var f="valid"+h.level,m="key"+o,g="idx"+o,v=h.dataLevel=e.dataLevel+1,y="data"+v,_="dataProperties"+o,b=Object.keys(s||{}).filter(x),E=e.schema.patternProperties||{},S=Object.keys(E).filter(x),w=e.schema.additionalProperties,R=b.length||S.length,I=!1===w,k="object"==typeof w&&Object.keys(w).length,P=e.opts.removeAdditional,T=I||k||P,O=e.opts.ownProperties,A=e.baseId,D=e.schema.required;if(D&&(!e.opts.$data||!D.$data)&&D.length<e.opts.loopRequired)var C=e.util.toHash(D);function x(e){return"__proto__"!==e}if(n+="var "+d+" = errors;var "+f+" = true;",O&&(n+=" var "+_+" = undefined;"),T){if(n+=O?" "+_+" = "+_+" || Object.keys("+l+"); for (var "+g+"=0; "+g+"<"+_+".length; "+g+"++) { var "+m+" = "+_+"["+g+"]; ":" for (var "+m+" in "+l+") { ",R){if(n+=" var isAdditional"+o+" = !(false ",b.length)if(b.length>8)n+=" || validate.schema"+a+".hasOwnProperty("+m+") ";else{var M=b;if(M)for(var j=-1,U=M.length-1;j<U;)Q=M[j+=1],n+=" || "+m+" == "+e.util.toQuotedString(Q)+" "}if(S.length){var N=S;if(N)for(var F=-1,L=N.length-1;F<L;)ie=N[F+=1],n+=" || "+e.usePattern(ie)+".test("+m+") "}n+=" ); if (isAdditional"+o+") { "}if("all"==P)n+=" delete "+l+"["+m+"]; ";else{var K=e.errorPath,B="' + "+m+" + '";if(e.opts._errorDataPathProperty&&(e.errorPath=e.util.getPathExpr(e.errorPath,m,e.opts.jsonPointers)),I)if(P)n+=" delete "+l+"["+m+"]; ";else{n+=" "+f+" = false; ";var q=c;c=e.errSchemaPath+"/additionalProperties",(re=re||[]).push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'additionalProperties' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { additionalProperty: '"+B+"' } ",!1!==e.opts.messages&&(n+=" , message: '",e.opts._errorDataPathProperty?n+="is an invalid additional property":n+="should NOT have additional properties",n+="' "),e.opts.verbose&&(n+=" , schema: false , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ";var $=n;n=re.pop(),!e.compositeRule&&u?e.async?n+=" throw new ValidationError(["+$+"]); ":n+=" validate.errors = ["+$+"]; return false; ":n+=" var err = "+$+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",c=q,u&&(n+=" break; ")}else if(k)if("failing"==P){n+=" var "+d+" = errors;  ";var V=e.compositeRule;e.compositeRule=h.compositeRule=!0,h.schema=w,h.schemaPath=e.schemaPath+".additionalProperties",h.errSchemaPath=e.errSchemaPath+"/additionalProperties",h.errorPath=e.opts._errorDataPathProperty?e.errorPath:e.util.getPathExpr(e.errorPath,m,e.opts.jsonPointers);var G=l+"["+m+"]";h.dataPathArr[v]=m;var H=e.validate(h);h.baseId=A,e.util.varOccurences(H,y)<2?n+=" "+e.util.varReplace(H,y,G)+" ":n+=" var "+y+" = "+G+"; "+H+" ",n+=" if (!"+f+") { errors = "+d+"; if (validate.errors !== null) { if (errors) validate.errors.length = errors; else validate.errors = null; } delete "+l+"["+m+"]; }  ",e.compositeRule=h.compositeRule=V}else h.schema=w,h.schemaPath=e.schemaPath+".additionalProperties",h.errSchemaPath=e.errSchemaPath+"/additionalProperties",h.errorPath=e.opts._errorDataPathProperty?e.errorPath:e.util.getPathExpr(e.errorPath,m,e.opts.jsonPointers),G=l+"["+m+"]",h.dataPathArr[v]=m,H=e.validate(h),h.baseId=A,e.util.varOccurences(H,y)<2?n+=" "+e.util.varReplace(H,y,G)+" ":n+=" var "+y+" = "+G+"; "+H+" ",u&&(n+=" if (!"+f+") break; ");e.errorPath=K}R&&(n+=" } "),n+=" }  ",u&&(n+=" if ("+f+") { ",p+="}")}var z=e.opts.useDefaults&&!e.compositeRule;if(b.length){var W=b;if(W)for(var Q,Y=-1,X=W.length-1;Y<X;){var J=s[Q=W[Y+=1]];if(e.opts.strictKeywords?"object"==typeof J&&Object.keys(J).length>0:e.util.schemaHasRules(J,e.RULES.all)){var Z=e.util.getProperty(Q),ee=(G=l+Z,z&&void 0!==J.default);if(h.schema=J,h.schemaPath=a+Z,h.errSchemaPath=c+"/"+e.util.escapeFragment(Q),h.errorPath=e.util.getPath(e.errorPath,Q,e.opts.jsonPointers),h.dataPathArr[v]=e.util.toQuotedString(Q),H=e.validate(h),h.baseId=A,e.util.varOccurences(H,y)<2){H=e.util.varReplace(H,y,G);var te=G}else te=y,n+=" var "+y+" = "+G+"; ";if(ee)n+=" "+H+" ";else{if(C&&C[Q]){n+=" if ( "+te+" === undefined ",O&&(n+=" || ! Object.prototype.hasOwnProperty.call("+l+", '"+e.util.escapeQuotes(Q)+"') "),n+=") { "+f+" = false; ",K=e.errorPath,q=c;var re,ne=e.util.escapeQuotes(Q);e.opts._errorDataPathProperty&&(e.errorPath=e.util.getPath(K,Q,e.opts.jsonPointers)),c=e.errSchemaPath+"/required",(re=re||[]).push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'required' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { missingProperty: '"+ne+"' } ",!1!==e.opts.messages&&(n+=" , message: '",e.opts._errorDataPathProperty?n+="is a required property":n+="should have required property \\'"+ne+"\\'",n+="' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ",$=n,n=re.pop(),!e.compositeRule&&u?e.async?n+=" throw new ValidationError(["+$+"]); ":n+=" validate.errors = ["+$+"]; return false; ":n+=" var err = "+$+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",c=q,e.errorPath=K,n+=" } else { "}else u?(n+=" if ( "+te+" === undefined ",O&&(n+=" || ! Object.prototype.hasOwnProperty.call("+l+", '"+e.util.escapeQuotes(Q)+"') "),n+=") { "+f+" = true; } else { "):(n+=" if ("+te+" !== undefined ",O&&(n+=" &&   Object.prototype.hasOwnProperty.call("+l+", '"+e.util.escapeQuotes(Q)+"') "),n+=" ) { ");n+=" "+H+" } "}}u&&(n+=" if ("+f+") { ",p+="}")}}if(S.length){var oe=S;if(oe)for(var ie,se=-1,ae=oe.length-1;se<ae;)J=E[ie=oe[se+=1]],(e.opts.strictKeywords?"object"==typeof J&&Object.keys(J).length>0:e.util.schemaHasRules(J,e.RULES.all))&&(h.schema=J,h.schemaPath=e.schemaPath+".patternProperties"+e.util.getProperty(ie),h.errSchemaPath=e.errSchemaPath+"/patternProperties/"+e.util.escapeFragment(ie),n+=O?" "+_+" = "+_+" || Object.keys("+l+"); for (var "+g+"=0; "+g+"<"+_+".length; "+g+"++) { var "+m+" = "+_+"["+g+"]; ":" for (var "+m+" in "+l+") { ",n+=" if ("+e.usePattern(ie)+".test("+m+")) { ",h.errorPath=e.util.getPathExpr(e.errorPath,m,e.opts.jsonPointers),G=l+"["+m+"]",h.dataPathArr[v]=m,H=e.validate(h),h.baseId=A,e.util.varOccurences(H,y)<2?n+=" "+e.util.varReplace(H,y,G)+" ":n+=" var "+y+" = "+G+"; "+H+" ",u&&(n+=" if (!"+f+") break; "),n+=" } ",u&&(n+=" else "+f+" = true; "),n+=" }  ",u&&(n+=" if ("+f+") { ",p+="}"))}return u&&(n+=" "+p+" if ("+d+" == errors) {"),n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="errs__"+o,h=e.util.copy(e);h.level++;var p="valid"+h.level;if(n+="var "+d+" = errors;",e.opts.strictKeywords?"object"==typeof s&&Object.keys(s).length>0:e.util.schemaHasRules(s,e.RULES.all)){h.schema=s,h.schemaPath=a,h.errSchemaPath=c;var f="key"+o,m="idx"+o,g="i"+o,v="' + "+f+" + '",y="data"+(h.dataLevel=e.dataLevel+1),_="dataProperties"+o,b=e.opts.ownProperties,E=e.baseId;b&&(n+=" var "+_+" = undefined; "),n+=b?" "+_+" = "+_+" || Object.keys("+l+"); for (var "+m+"=0; "+m+"<"+_+".length; "+m+"++) { var "+f+" = "+_+"["+m+"]; ":" for (var "+f+" in "+l+") { ",n+=" var startErrs"+o+" = errors; ";var S=f,w=e.compositeRule;e.compositeRule=h.compositeRule=!0;var R=e.validate(h);h.baseId=E,e.util.varOccurences(R,y)<2?n+=" "+e.util.varReplace(R,y,S)+" ":n+=" var "+y+" = "+S+"; "+R+" ",e.compositeRule=h.compositeRule=w,n+=" if (!"+p+") { for (var "+g+"=startErrs"+o+"; "+g+"<errors; "+g+"++) { vErrors["+g+"].propertyName = "+f+"; }   var err =   ",!1!==e.createErrors?(n+=" { keyword: 'propertyNames' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { propertyName: '"+v+"' } ",!1!==e.opts.messages&&(n+=" , message: 'property name \\'"+v+"\\' is invalid' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ",n+=";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",!e.compositeRule&&u&&(e.async?n+=" throw new ValidationError(vErrors); ":n+=" validate.errors = vErrors; return false; "),u&&(n+=" break; "),n+=" } }"}return u&&(n+="  if ("+d+" == errors) {"),n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="valid"+o,h=e.opts.$data&&s&&s.$data;h&&(n+=" var schema"+o+" = "+e.util.getData(s.$data,i,e.dataPathArr)+"; ");var p="schema"+o;if(!h)if(s.length<e.opts.loopRequired&&e.schema.properties&&Object.keys(e.schema.properties).length){var f=[],m=s;if(m)for(var g,v=-1,y=m.length-1;v<y;){g=m[v+=1];var _=e.schema.properties[g];_&&(e.opts.strictKeywords?"object"==typeof _&&Object.keys(_).length>0:e.util.schemaHasRules(_,e.RULES.all))||(f[f.length]=g)}}else f=s;if(h||f.length){var b=e.errorPath,E=h||f.length>=e.opts.loopRequired,S=e.opts.ownProperties;if(u)if(n+=" var missing"+o+"; ",E){h||(n+=" var "+p+" = validate.schema"+a+"; ");var w="' + "+(O="schema"+o+"["+(P="i"+o)+"]")+" + '";e.opts._errorDataPathProperty&&(e.errorPath=e.util.getPathExpr(b,O,e.opts.jsonPointers)),n+=" var "+d+" = true; ",h&&(n+=" if (schema"+o+" === undefined) "+d+" = true; else if (!Array.isArray(schema"+o+")) "+d+" = false; else {"),n+=" for (var "+P+" = 0; "+P+" < "+p+".length; "+P+"++) { "+d+" = "+l+"["+p+"["+P+"]] !== undefined ",S&&(n+=" &&   Object.prototype.hasOwnProperty.call("+l+", "+p+"["+P+"]) "),n+="; if (!"+d+") break; } ",h&&(n+="  }  "),n+="  if (!"+d+") {   ",(I=I||[]).push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'required' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { missingProperty: '"+w+"' } ",!1!==e.opts.messages&&(n+=" , message: '",e.opts._errorDataPathProperty?n+="is a required property":n+="should have required property \\'"+w+"\\'",n+="' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ";var R=n;n=I.pop(),!e.compositeRule&&u?e.async?n+=" throw new ValidationError(["+R+"]); ":n+=" validate.errors = ["+R+"]; return false; ":n+=" var err = "+R+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",n+=" } else { "}else{n+=" if ( ";var I,k=f;if(k)for(var P=-1,T=k.length-1;P<T;)D=k[P+=1],P&&(n+=" || "),n+=" ( ( "+(j=l+(M=e.util.getProperty(D)))+" === undefined ",S&&(n+=" || ! Object.prototype.hasOwnProperty.call("+l+", '"+e.util.escapeQuotes(D)+"') "),n+=") && (missing"+o+" = "+e.util.toQuotedString(e.opts.jsonPointers?D:M)+") ) ";n+=") {  ",w="' + "+(O="missing"+o)+" + '",e.opts._errorDataPathProperty&&(e.errorPath=e.opts.jsonPointers?e.util.getPathExpr(b,O,!0):b+" + "+O),(I=I||[]).push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'required' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { missingProperty: '"+w+"' } ",!1!==e.opts.messages&&(n+=" , message: '",e.opts._errorDataPathProperty?n+="is a required property":n+="should have required property \\'"+w+"\\'",n+="' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ",R=n,n=I.pop(),!e.compositeRule&&u?e.async?n+=" throw new ValidationError(["+R+"]); ":n+=" validate.errors = ["+R+"]; return false; ":n+=" var err = "+R+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",n+=" } else { "}else if(E){var O;h||(n+=" var "+p+" = validate.schema"+a+"; "),w="' + "+(O="schema"+o+"["+(P="i"+o)+"]")+" + '",e.opts._errorDataPathProperty&&(e.errorPath=e.util.getPathExpr(b,O,e.opts.jsonPointers)),h&&(n+=" if ("+p+" && !Array.isArray("+p+")) {  var err =   ",!1!==e.createErrors?(n+=" { keyword: 'required' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { missingProperty: '"+w+"' } ",!1!==e.opts.messages&&(n+=" , message: '",e.opts._errorDataPathProperty?n+="is a required property":n+="should have required property \\'"+w+"\\'",n+="' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ",n+=";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; } else if ("+p+" !== undefined) { "),n+=" for (var "+P+" = 0; "+P+" < "+p+".length; "+P+"++) { if ("+l+"["+p+"["+P+"]] === undefined ",S&&(n+=" || ! Object.prototype.hasOwnProperty.call("+l+", "+p+"["+P+"]) "),n+=") {  var err =   ",!1!==e.createErrors?(n+=" { keyword: 'required' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { missingProperty: '"+w+"' } ",!1!==e.opts.messages&&(n+=" , message: '",e.opts._errorDataPathProperty?n+="is a required property":n+="should have required property \\'"+w+"\\'",n+="' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ",n+=";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; } } ",h&&(n+="  }  ")}else{var A=f;if(A)for(var D,C=-1,x=A.length-1;C<x;){D=A[C+=1];var M=e.util.getProperty(D),j=(w=e.util.escapeQuotes(D),l+M);e.opts._errorDataPathProperty&&(e.errorPath=e.util.getPath(b,D,e.opts.jsonPointers)),n+=" if ( "+j+" === undefined ",S&&(n+=" || ! Object.prototype.hasOwnProperty.call("+l+", '"+e.util.escapeQuotes(D)+"') "),n+=") {  var err =   ",!1!==e.createErrors?(n+=" { keyword: 'required' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { missingProperty: '"+w+"' } ",!1!==e.opts.messages&&(n+=" , message: '",e.opts._errorDataPathProperty?n+="is a required property":n+="should have required property \\'"+w+"\\'",n+="' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ",n+=";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; } "}}e.errorPath=b}else u&&(n+=" if (true) {");return n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n,o=" ",i=e.level,s=e.dataLevel,a=e.schema[t],c=e.schemaPath+e.util.getProperty(t),u=e.errSchemaPath+"/"+t,l=!e.opts.allErrors,d="data"+(s||""),h="valid"+i,p=e.opts.$data&&a&&a.$data;if(p?(o+=" var schema"+i+" = "+e.util.getData(a.$data,s,e.dataPathArr)+"; ",n="schema"+i):n=a,(a||p)&&!1!==e.opts.uniqueItems){p&&(o+=" var "+h+"; if ("+n+" === false || "+n+" === undefined) "+h+" = true; else if (typeof "+n+" != 'boolean') "+h+" = false; else { "),o+=" var i = "+d+".length , "+h+" = true , j; if (i > 1) { ";var f=e.schema.items&&e.schema.items.type,m=Array.isArray(f);if(!f||"object"==f||"array"==f||m&&(f.indexOf("object")>=0||f.indexOf("array")>=0))o+=" outer: for (;i--;) { for (j = i; j--;) { if (equal("+d+"[i], "+d+"[j])) { "+h+" = false; break outer; } } } ";else{o+=" var itemIndices = {}, item; for (;i--;) { var item = "+d+"[i]; ";var g="checkDataType"+(m?"s":"");o+=" if ("+e.util[g](f,"item",e.opts.strictNumbers,!0)+") continue; ",m&&(o+=" if (typeof item == 'string') item = '\"' + item; "),o+=" if (typeof itemIndices[item] == 'number') { "+h+" = false; j = itemIndices[item]; break; } itemIndices[item] = i; } "}o+=" } ",p&&(o+="  }  "),o+=" if (!"+h+") {   ";var v=v||[];v.push(o),o="",!1!==e.createErrors?(o+=" { keyword: 'uniqueItems' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(u)+" , params: { i: i, j: j } ",!1!==e.opts.messages&&(o+=" , message: 'should NOT have duplicate items (items ## ' + j + ' and ' + i + ' are identical)' "),e.opts.verbose&&(o+=" , schema:  ",o+=p?"validate.schema"+c:""+a,o+="         , parentSchema: validate.schema"+e.schemaPath+" , data: "+d+" "),o+=" } "):o+=" {} ";var y=o;o=v.pop(),!e.compositeRule&&l?e.async?o+=" throw new ValidationError(["+y+"]); ":o+=" validate.errors = ["+y+"]; return false; ":o+=" var err = "+y+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",o+=" } ",l&&(o+=" else { ")}else l&&(o+=" if (true) { ");return o}},function(e,t,r){"use strict";var n=["multipleOf","maximum","exclusiveMaximum","minimum","exclusiveMinimum","maxLength","minLength","pattern","additionalItems","maxItems","minItems","uniqueItems","maxProperties","minProperties","required","additionalProperties","enum","format","const"];e.exports=function(e,t){for(var r=0;r<t.length;r++){e=JSON.parse(JSON.stringify(e));var o,i=t[r].split("/"),s=e;for(o=1;o<i.length;o++)s=s[i[o]];for(o=0;o<n.length;o++){var a=n[o],c=s[a];c&&(s[a]={anyOf:[c,{$ref:"https://raw.githubusercontent.com/ajv-validator/ajv/master/lib/refs/data.json#"}]})}}return e}},function(e,t,r){"use strict";var n=r(15).MissingRef;e.exports=function e(t,r,o){var i=this;if("function"!=typeof this._opts.loadSchema)throw new Error("options.loadSchema should be a function");"function"==typeof r&&(o=r,r=void 0);var s=a(t).then((function(){var e=i._addSchema(t,void 0,r);return e.validate||function e(t){try{return i._compile(t)}catch(e){if(e instanceof n)return o(e);throw e}function o(n){var o=n.missingSchema;if(u(o))throw new Error("Schema "+o+" is loaded but "+n.missingRef+" cannot be resolved");var s=i._loadingSchemas[o];return s||(s=i._loadingSchemas[o]=i._opts.loadSchema(o)).then(c,c),s.then((function(e){if(!u(o))return a(e).then((function(){u(o)||i.addSchema(e,o,void 0,r)}))})).then((function(){return e(t)}));function c(){delete i._loadingSchemas[o]}function u(e){return i._refs[e]||i._schemas[e]}}}(e)}));return o&&s.then((function(e){o(null,e)}),o),s;function a(t){var r=t.$schema;return r&&!i.getSchema(r)?e.call(i,{$ref:r},!0):Promise.resolve()}}},function(e,t,r){"use strict";var n=/^[a-z_$][a-z0-9_$-]*$/i,o=r(75),i=r(76);e.exports={add:function(e,t){var r=this.RULES;if(r.keywords[e])throw new Error("Keyword "+e+" is already defined");if(!n.test(e))throw new Error("Keyword "+e+" is not a valid identifier");if(t){this.validateKeyword(t,!0);var i=t.type;if(Array.isArray(i))for(var s=0;s<i.length;s++)c(e,i[s],t);else c(e,i,t);var a=t.metaSchema;a&&(t.$data&&this._opts.$data&&(a={anyOf:[a,{$ref:"https://raw.githubusercontent.com/ajv-validator/ajv/master/lib/refs/data.json#"}]}),t.validateSchema=this.compile(a,!0))}function c(e,t,n){for(var i,s=0;s<r.length;s++){var a=r[s];if(a.type==t){i=a;break}}i||(i={type:t,rules:[]},r.push(i));var c={keyword:e,definition:n,custom:!0,code:o,implements:n.implements};i.rules.push(c),r.custom[e]=c}return r.keywords[e]=r.all[e]=!0,this},get:function(e){var t=this.RULES.custom[e];return t?t.definition:this.RULES.keywords[e]||!1},remove:function(e){var t=this.RULES;delete t.keywords[e],delete t.all[e],delete t.custom[e];for(var r=0;r<t.length;r++)for(var n=t[r].rules,o=0;o<n.length;o++)if(n[o].keyword==e){n.splice(o,1);break}return this},validate:function e(t,r){e.errors=null;var n=this._validateKeyword=this._validateKeyword||this.compile(i,!0);if(n(t))return!0;if(e.errors=n.errors,r)throw new Error("custom keyword definition is invalid: "+this.errorsText(n.errors));return!1}}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n,o,i=" ",s=e.level,a=e.dataLevel,c=e.schema[t],u=e.schemaPath+e.util.getProperty(t),l=e.errSchemaPath+"/"+t,d=!e.opts.allErrors,h="data"+(a||""),p="valid"+s,f="errs__"+s,m=e.opts.$data&&c&&c.$data;m?(i+=" var schema"+s+" = "+e.util.getData(c.$data,a,e.dataPathArr)+"; ",o="schema"+s):o=c;var g,v,y,_,b,E="definition"+s,S=this.definition,w="";if(m&&S.$data){b="keywordValidate"+s;var R=S.validateSchema;i+=" var "+E+" = RULES.custom['"+t+"'].definition; var "+b+" = "+E+".validate;"}else{if(!(_=e.useCustomRule(this,c,e.schema,e)))return;o="validate.schema"+u,b=_.code,g=S.compile,v=S.inline,y=S.macro}var I=b+".errors",k="i"+s,P="ruleErr"+s,T=S.async;if(T&&!e.async)throw new Error("async keyword in sync schema");if(v||y||(i+=I+" = null;"),i+="var "+f+" = errors;var "+p+";",m&&S.$data&&(w+="}",i+=" if ("+o+" === undefined) { "+p+" = true; } else { ",R&&(w+="}",i+=" "+p+" = "+E+".validateSchema("+o+"); if ("+p+") { ")),v)S.statements?i+=" "+_.validate+" ":i+=" "+p+" = "+_.validate+"; ";else if(y){var O=e.util.copy(e);w="",O.level++;var A="valid"+O.level;O.schema=_.validate,O.schemaPath="";var D=e.compositeRule;e.compositeRule=O.compositeRule=!0;var C=e.validate(O).replace(/validate\.schema/g,b);e.compositeRule=O.compositeRule=D,i+=" "+C}else{(U=U||[]).push(i),i="",i+="  "+b+".call( ",e.opts.passContext?i+="this":i+="self",g||!1===S.schema?i+=" , "+h+" ":i+=" , "+o+" , "+h+" , validate.schema"+e.schemaPath+" ",i+=" , (dataPath || '')",'""'!=e.errorPath&&(i+=" + "+e.errorPath);var x=a?"data"+(a-1||""):"parentData",M=a?e.dataPathArr[a]:"parentDataProperty",j=i+=" , "+x+" , "+M+" , rootData )  ";i=U.pop(),!1===S.errors?(i+=" "+p+" = ",T&&(i+="await "),i+=j+"; "):i+=T?" var "+(I="customErrors"+s)+" = null; try { "+p+" = await "+j+"; } catch (e) { "+p+" = false; if (e instanceof ValidationError) "+I+" = e.errors; else throw e; } ":" "+I+" = null; "+p+" = "+j+"; "}if(S.modifying&&(i+=" if ("+x+") "+h+" = "+x+"["+M+"];"),i+=""+w,S.valid)d&&(i+=" if (true) { ");else{var U;i+=" if ( ",void 0===S.valid?(i+=" !",i+=y?""+A:""+p):i+=" "+!S.valid+" ",i+=") { ",n=this.keyword,(U=U||[]).push(i),i="",(U=U||[]).push(i),i="",!1!==e.createErrors?(i+=" { keyword: '"+(n||"custom")+"' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(l)+" , params: { keyword: '"+this.keyword+"' } ",!1!==e.opts.messages&&(i+=" , message: 'should pass \""+this.keyword+"\" keyword validation' "),e.opts.verbose&&(i+=" , schema: validate.schema"+u+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+h+" "),i+=" } "):i+=" {} ";var N=i;i=U.pop(),!e.compositeRule&&d?e.async?i+=" throw new ValidationError(["+N+"]); ":i+=" validate.errors = ["+N+"]; return false; ":i+=" var err = "+N+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ";var F=i;i=U.pop(),v?S.errors?"full"!=S.errors&&(i+="  for (var "+k+"="+f+"; "+k+"<errors; "+k+"++) { var "+P+" = vErrors["+k+"]; if ("+P+".dataPath === undefined) "+P+".dataPath = (dataPath || '') + "+e.errorPath+"; if ("+P+".schemaPath === undefined) { "+P+'.schemaPath = "'+l+'"; } ',e.opts.verbose&&(i+=" "+P+".schema = "+o+"; "+P+".data = "+h+"; "),i+=" } "):!1===S.errors?i+=" "+F+" ":(i+=" if ("+f+" == errors) { "+F+" } else {  for (var "+k+"="+f+"; "+k+"<errors; "+k+"++) { var "+P+" = vErrors["+k+"]; if ("+P+".dataPath === undefined) "+P+".dataPath = (dataPath || '') + "+e.errorPath+"; if ("+P+".schemaPath === undefined) { "+P+'.schemaPath = "'+l+'"; } ',e.opts.verbose&&(i+=" "+P+".schema = "+o+"; "+P+".data = "+h+"; "),i+=" } } "):y?(i+="   var err =   ",!1!==e.createErrors?(i+=" { keyword: '"+(n||"custom")+"' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(l)+" , params: { keyword: '"+this.keyword+"' } ",!1!==e.opts.messages&&(i+=" , message: 'should pass \""+this.keyword+"\" keyword validation' "),e.opts.verbose&&(i+=" , schema: validate.schema"+u+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+h+" "),i+=" } "):i+=" {} ",i+=";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",!e.compositeRule&&d&&(e.async?i+=" throw new ValidationError(vErrors); ":i+=" validate.errors = vErrors; return false; ")):!1===S.errors?i+=" "+F+" ":(i+=" if (Array.isArray("+I+")) { if (vErrors === null) vErrors = "+I+"; else vErrors = vErrors.concat("+I+"); errors = vErrors.length;  for (var "+k+"="+f+"; "+k+"<errors; "+k+"++) { var "+P+" = vErrors["+k+"]; if ("+P+".dataPath === undefined) "+P+".dataPath = (dataPath || '') + "+e.errorPath+";  "+P+'.schemaPath = "'+l+'";  ',e.opts.verbose&&(i+=" "+P+".schema = "+o+"; "+P+".data = "+h+"; "),i+=" } } else { "+F+" } "),i+=" } ",d&&(i+=" else { ")}return i}},function(e,t,r){"use strict";var n=r(27);e.exports={$id:"https://github.com/ajv-validator/ajv/blob/master/lib/definition_schema.js",definitions:{simpleTypes:n.definitions.simpleTypes},type:"object",dependencies:{schema:["validate"],$data:["validate"],statements:["inline"],valid:{not:{required:["macro"]}}},properties:{type:n.properties.type,schema:{type:"boolean"},statements:{type:"boolean"},dependencies:{type:"array",items:{type:"string"}},metaSchema:{type:"object"},modifying:{type:"boolean"},valid:{type:"boolean"},$data:{type:"boolean"},async:{type:"boolean"},errors:{anyOf:[{type:"boolean"},{const:"full"}]}}}},function(e){e.exports=JSON.parse('{"$schema":"http://json-schema.org/draft-07/schema#","$id":"https://raw.githubusercontent.com/ajv-validator/ajv/master/lib/refs/data.json#","description":"Meta-schema for $data reference (JSON Schema extension proposal)","type":"object","required":["$data"],"properties":{"$data":{"type":"string","anyOf":[{"format":"relative-json-pointer"},{"format":"json-pointer"}]}},"additionalProperties":false}')},function(e,t,r){"use strict";r.r(t),r.d(t,"RpcHandlerRegistry",(function(){return X})),r.d(t,"RpcChannel",(function(){return re})),r.d(t,"RpcMessage",(function(){return H})),r.d(t,"rpcSerialize",(function(){return G})),r.d(t,"toRpcSerialized",(function(){return $})),r.d(t,"AccessPolicy",(function(){return J})),r.d(t,"RpcFunction",(function(){})),r.d(t,"RpcRemappedFunction",(function(){return W})),r.d(t,"RpcAddress",(function(){return Q})),r.d(t,"RemapArguments",(function(){return Y})),r.d(t,"RpcFunctionAddress",(function(){return z})),r.d(t,"InvalidChannelError",(function(){return Z})),r.d(t,"AccessDeniedError",(function(){return ee})),r.d(t,"ForwardedError",(function(){return te})),r.d(t,"SerializableData",(function(){})),r.d(t,"SerializedData",(function(){})),r.d(t,"BaseRegisteredObject",(function(){})),r.d(t,"EnforceArgumentSchema",(function(){return se})),r.d(t,"EnforceMethodArgSchema",(function(){return ae})),r.d(t,"MultistringAddress",(function(){})),r.d(t,"WildcardMultistringAddress",(function(){})),r.d(t,"AddressMap",(function(){return L}));var n=r(0),o=r.n(n),i=r(28),s=r.n(i),a=r(3),c=r.n(a),u=r(16),l=r.n(u),d=r(6),h=r.n(d),p=r(9),f=r.n(p),m=r(29),g=r.n(m),v=r(8),y=r.n(v),_=r(10),b=r.n(_),E=r(2),S=r.n(E),w=r(5),R=r.n(w),I=r(1),k=r.n(I),P=r(7),T=r.n(P),O=r(30),A=r.n(O),D=r(31),C=r.n(D),x=r(32),M=r.n(x);function j(e){return void 0!==e&&null!=e}function U(e){return!j(e)}var N=Symbol("DefaultEntry"),F=Symbol("WildcardEntry"),L=function(){function e(){S()(this,e),k()(this,"table",{})}return R()(e,[{key:"put",value:function(e,t){var r=this.table;e.forEach((function(e){var t=e||F;U(r[t])&&(r[t]={}),r=r[t]})),U(t)?delete r[N]:r[N]=t}},{key:"get",value:function(e,t){var r=function e(t,r,n){var o=r.shift();if(!o)return t[N];var i=void 0;return t[o]&&(i=e(t[o],r,n)),!i&&t[F]&&(n&&n.push(o),i=e(t[F],r,n)),r.unshift(o),i}(this.table,e,t);return U(r)?this.table[N]:r}},{key:"toString",value:function(){var e=[],t=[];return function r(n){n[N]&&e.push("".concat(t.join("."),": ").concat(n[N])),n[F]&&(t.push("*"),r(n[F]),t.pop()),Object.keys(n).forEach((function(e){n[e]&&(t.push("[".concat(e,"]")),r(n[e]),t.pop())}))}(this.table),"AddrMap [\n".concat(e.map((function(e){return"  "+e})).join("\n"),"\n]")}}]),e}();function K(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=y()(e);if(t){var o=y()(this).constructor;r=Reflect.construct(n,arguments,o)}else r=n.apply(this,arguments);return g()(this,r)}}function B(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return q(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?q(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,i=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw i}}}}function q(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var $=Symbol("ChannelRpcSerialize"),V=["undefined"!=typeof MessagePort&&MessagePort,"undefined"!=typeof ImageBitmap&&ImageBitmap,"undefined"!=typeof OffscreenCanvas&&OffscreenCanvas,"undefined"!=typeof ArrayBuffer&&ArrayBuffer,"undefined"!=typeof Int8Array&&Int8Array,"undefined"!=typeof Int16Array&&Int16Array,"undefined"!=typeof Int32Array&&Int32Array,"undefined"!=typeof BigInt64Array&&BigInt64Array,"undefined"!=typeof Uint8Array&&Uint8Array,"undefined"!=typeof Uint8ClampedArray&&Uint8ClampedArray,"undefined"!=typeof Uint16Array&&Uint16Array,"undefined"!=typeof Uint32Array&&Uint32Array,"undefined"!=typeof BigUint64Array&&BigUint64Array,"undefined"!=typeof Float32Array&&Float32Array,"undefined"!=typeof Float64Array&&Float64Array].filter((function(e){return e}));function G(e,t){if(e&&e[$])return e[$](e,t);switch(T()(e)){case"undefined":case"bigint":case"boolean":case"number":case"string":return e;case"symbol":throw new TypeError("Symbols cannot be serialized");case"function":throw new TypeError("Functions cannot be serialized");case"object":if(null===e)return null;if(V.some((function(t){return e instanceof t})))return t.push(e),e;if(e instanceof Error)return{name:e.name,message:e.message,stack:"Stack trace redacted for security reasons",columnNumber:e.columnNumber,lineNumber:e.lineNumber,fileName:e.fileName};if(Array.isArray(e))return e.map((function(e){return G(e,t)}));var r={};return Object.keys(e).forEach((function(n){r[n]=G(e[n],t)})),r;default:throw new TypeError("Cannot serialize unknown type ".concat(T()(e)))}}var H,z=Symbol("RpcFunctionAddress"),W=Symbol("RpcRemappedFunction");function Q(e){return function(t,r,n){var o=n.value;if("function"!=typeof o)throw new TypeError("Cannot mark non-function as RPC function");o[z]=e}}function Y(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:W;return function(r,n,o){var i=o.value;if("function"!=typeof i)throw new TypeError("Cannot remap arguments for non-function");return o.value[t]=function(){for(var t=e[Symbol.iterator](),r=void 0,n=arguments.length,o=new Array(n),s=0;s<n;s++)o[s]=arguments[s];return i.apply(this,o.flatMap((function(e){if(!r){var n=t.next();r=n.value}switch(r){default:case"pass":return r=void 0,[e];case"drop":return r=void 0,[];case"expand":var o=[];if(!e[Symbol.iterator])throw new TypeError("Attempted to expand non-iterable");var i=e[Symbol.iterator]();do{var s,a=i.next();if(a.done)throw new TypeError("Expand reached end of array");o.push(a.value)}while("expand"===(s=t.next(),r=s.value,s).value);return o}})))},o}}(H||(H={})).Schema={type:"object",properties:{to:{type:"array",items:{type:"string"}},args:{type:"array"},return_addr:{type:"array",items:{type:"string"}},return_type:{type:"string",enum:["promise","generator"]}},required:["to","args"]};var X=function(){function e(){S()(this,e),k()(this,"map",new L),k()(this,"return_seq_id",0)}return R()(e,[{key:"register",value:function(e,t){for(;t[W];)t=t[W];this.map.put(e,t)}},{key:"unregister",value:function(e){this.map.put(e,void 0)}},{key:"registerAll",value:function(e){var t=this,r=e;do{var n,o=B(Object.getOwnPropertyNames(r));try{for(o.s();!(n=o.n()).done;){var i=r[n.value];i&&i[z]&&"function"==typeof i&&function(){for(var r=i;r[W];)r=r[W];t.register(i[z],(function(){for(var t=arguments.length,n=new Array(t),o=0;o<t;o++)n[o]=arguments[o];return r.apply(e,n)}))}()}}catch(e){o.e(e)}finally{o.f()}}while(r=Object.getPrototypeOf(r))}},{key:"unregisterAll",value:function(e){var t=e;do{var r,n=B(Object.getOwnPropertyNames(t));try{for(n.s();!(r=n.n()).done;){var o=t[r.value];o&&o[z]&&"function"==typeof o&&this.unregister(o[z])}}catch(e){n.e(e)}finally{n.f()}}while(t=Object.getPrototypeOf(t))}},{key:"nextSeqAddr",value:function(){return["_","ret","id".concat(this.return_seq_id++)]}}]),e}(),J={ALLOW:!0,DENY:!1},Z=function(e){f()(r,e);var t=K(r);function r(){var e;S()(this,r);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return e=t.call.apply(t,[this].concat(o)),k()(h()(e),"name","InvalidChannelError"),e}return r}(b()(Error)),ee=function(e){f()(r,e);var t=K(r);function r(){var e;S()(this,r);for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return e=t.call.apply(t,[this].concat(o)),k()(h()(e),"name","AccessDeniedError"),e}return r}(b()(Error)),te=function(e){f()(r,e);var t=K(r);function r(){return S()(this,r),t.apply(this,arguments)}return r}(b()(Error)),re=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:J.ALLOW,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new X;S()(this,e),k()(this,"access",new L),k()(this,"_i_reg",new X),this.c_send=t,this.reg=n,this.access.put([],r)}return R()(e,[{key:"register",value:function(e,t){this.reg.register(e,t)}},{key:"unregister",value:function(e){this.reg.unregister(e)}},{key:"registerAll",value:function(e){this.reg.registerAll(e)}},{key:"unregisterAll",value:function(e){this.reg.unregisterAll(e)}},{key:"setPolicy",value:function(e,t){this.access.put(e,t)}},{key:"clearPolicy",value:function(e){this.access.put(e,void 0)}},{key:"send",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2?arguments[2]:void 0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"promise",o=[],i={to:e,args:t.map((function(e){return G(e,o)})),return_addr:r,return_type:n};this.c_send(i,o)}},{key:"call",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=this._i_reg.nextSeqAddr();return new Promise((function(o,i){t._i_reg.register(n,(function(e,r,s,a){e!==t?i(new Z("Return value was sent through the wrong channel")):a?a.name?i(Object.assign(new te,a)):i(a):o(s),t.unregister(n)})),t.send(e,r,n)}))}},{key:"generate",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=this._i_reg.nextSeqAddr();this.send(e,r,n,"generator");var i,a=[],u=function(){return t._i_reg.unregister(n)};this._i_reg.register(n,(function(e,r,n,o,s){var c;e!==t?(u(),a.push([void 0,new Z("Yield value was sent through the wrong channel"),!0])):(o&&u(),(null===(c=o)||void 0===c?void 0:c.name)?a.push([n,Object.assign(new te,o),Boolean(s)]):a.push([n,o,Boolean(s)])),i&&i()}));var d=function(){var e=l()(c.a.mark((function e(){return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a.length){e.next=4;break}return e.next=3,new Promise((function(e){return i=e}));case 3:i=void 0;case 4:return e.abrupt("return",a.shift());case 5:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),h=M()(c.a.mark((function e(){var t,r,n,o,i;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=3,C()(d());case 3:if(t=e.sent,r=s()(t,3),n=r[0],o=r[1],i=r[2],!o){e.next=13;break}throw u(),o;case 13:if(!i){e.next=18;break}return u(),e.abrupt("return");case 18:return e.next=20,n;case 20:e.next=0;break;case 22:case"end":return e.stop()}}),e)})))(),p=function(){t.send(["_","stopgen"].concat(o()(n)),[]),u()},f=h.return,m=h.throw;return Object.assign(h,{return:function(){return p(),f.apply(h,[void 0])},throw:function(e){return p(),m.apply(h,[e])}})}},{key:"receive",value:function(e){var t=this,r=function(r,n){var i=function(e){return e&&e[Symbol.asyncIterator]&&"function"==typeof e.next};if(e.return_addr){var s=e.return_addr;switch(e.return_type){case"generator":if(n)return void t.send(s,[void 0,n,!0]);var a=!1,u=function(){a=!0,t.unregister(["_","stopgen"].concat(o()(s)))},d=function(e,r,n){var o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];a||t.send(e,[r,n,o||Boolean(n)]),(n||o)&&u()};return void(r instanceof Promise?r.then((function(e){d(s,e,void 0,!1),d(s,void 0,void 0,!0)}),(function(e){return d(s,void 0,e)})):i(r)?(t._i_reg.register(["_","stopgen"].concat(o()(s)),u),l()(c.a.mark((function e(){var t,n,o,i,u,l;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,t=!0,n=!1,e.prev=3,i=A()(r);case 5:return e.next=7,i.next();case 7:return u=e.sent,t=u.done,e.next=11,u.value;case 11:if(l=e.sent,t){e.next=20;break}if(d(s,l,void 0,!1),!a){e.next=17;break}return e.abrupt("return");case 17:t=!0,e.next=5;break;case 20:e.next=26;break;case 22:e.prev=22,e.t0=e.catch(3),n=!0,o=e.t0;case 26:if(e.prev=26,e.prev=27,t||null==i.return){e.next=31;break}return e.next=31,i.return();case 31:if(e.prev=31,!n){e.next=34;break}throw o;case 34:return e.finish(31);case 35:return e.finish(26);case 36:d(s,void 0,void 0,!0),e.next=42;break;case 39:e.prev=39,e.t1=e.catch(0),d(s,void 0,e.t1);case 42:case"end":return e.stop()}}),e,null,[[0,39],[3,22,26,36],[27,,31,35]])})))()):(d(s,r,void 0,!1),d(s,void 0,void 0,!0)));default:case"promise":if(n)return void t.send(s,[void 0,n]);var h=function(e){e.then((function(e){return t.send(s,[e,void 0])}),(function(e){return t.send(s,[void 0,e])}))};return void(r instanceof Promise?h(r):i(r)?h(new Promise((function(e,t){return r.next().then((function(t){var r=t.value;return e(r)}),(function(e){return t(e)}))}))):t.send(s,[r,void 0]))}}},n=this.access.get(e.to);if(j(n)&&n===J.DENY)r(void 0,new ee("Access denied"));else{var i,s=[],a=this._i_reg.map.get(e.to,s)||this.reg.map.get(e.to,s);try{if(!a)throw new TypeError("Function at address is undefined");i=a.apply(void 0,[this,s].concat(o()(e.args)))}catch(e){return void r(void 0,e)}r(i)}}},{key:"call_obj",get:function(){var e=this;return function e(t,r){return new Proxy((function(){return new Promise((function(e){return e()}))}),{apply:function(e,n,o){return r(t,o)},get:function(n,i){if("string"==typeof i)return e([].concat(o()(t),[i]),r)}})}([],(function(t,r){return e.call(t,r)}))}}]),e}(),ne=r(11),oe=r.n(ne),ie=new oe.a;function se(e,t){var r=ie.compile(e);return function(){for(var e,n=arguments.length,i=new Array(n),s=0;s<n;s++)i[s]=arguments[s];if(r(i),null===(e=r.errors)||void 0===e?void 0:e.length){var a=new oe.a.ValidationError(o()(r.errors));throw r.errors.length=0,a}return t.apply(void 0,i)}}function ae(e){return function(t,r,n){var i=n.value;if("function"!=typeof i)throw new TypeError("Cannot validate schema for non-function");var s=ie.compile(e);return n.value=function(){for(var e,t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];if(s(r),null===(e=s.errors)||void 0===e?void 0:e.length){var a=new oe.a.ValidationError(o()(s.errors));throw s.errors.length=0,a}return i.apply(this,r)},n}}}])},function(e,t,r){e.exports=r(177)},function(e,t){e.exports=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}},function(e,t,r){"use strict";var n=r(14);Object.defineProperty(t,"__esModule",{value:!0}),t.logger=void 0;var o=n(r(26));o.default.methodFactory=function(e,t,r){return function(...t){return"error"===e||"warn"===e||"trace"===e||"info"===e?console[e](...t):console.log(...t)}};const i=o.default.getLogger("matrix");t.logger=i,i.setLevel(o.default.levels.DEBUG)},function(e,t){e.exports=function(e,t,r,n,o){var i={};return Object.keys(n).forEach((function(e){i[e]=n[e]})),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=r.slice().reverse().reduce((function(r,n){return n(e,t,r)||r}),i),o&&void 0!==i.initializer&&(i.value=i.initializer?i.initializer.call(o):void 0,i.initializer=void 0),void 0===i.initializer&&(Object.defineProperty(e,t,i),i=null),i}},function(e,t,r){var n=r(50);function o(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return o=function(){return e},e}e.exports=function(e){if(e&&e.__esModule)return e;if(null===e||"object"!==n(e)&&"function"!=typeof e)return{default:e};var t=o();if(t&&t.has(e))return t.get(e);var r={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if(Object.prototype.hasOwnProperty.call(e,s)){var a=i?Object.getOwnPropertyDescriptor(e,s):null;a&&(a.get||a.set)?Object.defineProperty(r,s,a):r[s]=e[s]}return r.default=e,t&&t.set(e,r),r}},function(e,t,r){"use strict";var n=r(14);Object.defineProperty(t,"__esModule",{value:!0}),t.encodeParams=function(e){let t="";for(const r in e)e.hasOwnProperty(r)&&(t+="&"+encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t.substring(1)},t.encodeUri=function(e,t){for(const r in t)t.hasOwnProperty(r)&&(e=e.replace(r,encodeURIComponent(t[r])));return e},t.map=function(e,t){const r=new Array(e.length);for(let n=0;n<e.length;n++)r[n]=t(e[n]);return r},t.filter=function(e,t){const r=[];for(let n=0;n<e.length;n++)t(e[n],n,e)&&r.push(e[n]);return r},t.keys=function(e){const t=[];for(const r in e)e.hasOwnProperty(r)&&t.push(r);return t},t.values=function(e){const t=[];for(const r in e)e.hasOwnProperty(r)&&t.push(e[r]);return t},t.forEach=function(e,t){for(let r=0;r<e.length;r++)t(e[r],r)},t.findElement=function(e,t,r){let n;if(r){for(n=e.length-1;n>=0;n--)if(t(e[n],n,e))return e[n]}else for(n=0;n<e.length;n++)if(t(e[n],n,e))return e[n]},t.removeElement=function(e,t,r){let n,o;if(r){for(n=e.length-1;n>=0;n--)if(t(e[n],n,e))return o=e[n],e.splice(n,1),o}else for(n=0;n<e.length;n++)if(t(e[n],n,e))return o=e[n],e.splice(n,1),o;return!1},t.isFunction=function(e){return"[object Function]"===Object.prototype.toString.call(e)},t.isArray=function(e){return Array.isArray?Array.isArray(e):Boolean(e&&e.constructor===Array)},t.checkObjectHasKeys=function(e,t){for(let r=0;r<t.length;r++)if(!e.hasOwnProperty(t[r]))throw new Error("Missing required key: "+t[r])},t.checkObjectHasNoAdditionalKeys=function(e,t){for(const r in e)if(e.hasOwnProperty(r)&&-1===t.indexOf(r))throw new Error("Unknown key: "+r)},t.deepCopy=function(e){return JSON.parse(JSON.stringify(e))},t.deepCompare=function e(t,r){if(t===r)return!0;if(typeof t!=typeof r)return!1;if("number"==typeof t&&isNaN(t)&&isNaN(r))return!0;if(null===t||null===r)return t===r;if(!(t instanceof Object))return!1;if(t.constructor!==r.constructor||t.prototype!==r.prototype)return!1;if(t instanceof RegExp||t instanceof Date)return t.toString()===r.toString();if(t instanceof Array){if(t.length!==r.length)return!1;for(let n=0;n<t.length;n++)if(!e(t[n],r[n]))return!1}else{let n;for(n in r)if(r.hasOwnProperty(n)!==t.hasOwnProperty(n))return!1;for(n in r){if(r.hasOwnProperty(n)!==t.hasOwnProperty(n))return!1;if(!e(t[n],r[n]))return!1}}return!0},t.extend=function(){const e=arguments[0]||{};for(let t=1;t<arguments.length;t++){const r=arguments[t];if(r)for(const t in r)e[t]=r[t]}return e},t.runPolyfills=function(){Array.prototype.filter||(Array.prototype.filter=function(e){if(null==this)throw new TypeError;const t=Object(this),r=t.length>>>0;if("function"!=typeof e)throw new TypeError;const n=[],o=arguments.length>=2?arguments[1]:void 0;for(let i=0;i<r;i++)if(i in t){const r=t[i];e.call(o,r,i,t)&&n.push(r)}return n});Array.prototype.map||(Array.prototype.map=function(e,t){let r,n;if(null==this)throw new TypeError(" this is null or not defined");const o=Object(this),i=o.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");arguments.length>1&&(r=t);const s=new Array(i);for(n=0;n<i;){let t,i;n in o&&(t=o[n],i=e.call(r,t,n,o),s[n]=i),n++}return s});Array.prototype.forEach||(Array.prototype.forEach=function(e,t){let r,n;if(null==this)throw new TypeError(" this is null or not defined");const o=Object(this),i=o.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(arguments.length>1&&(r=t),n=0;n<i;){let t;n in o&&(t=o[n],e.call(r,t,n,o)),n++}})},t.inherits=function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})},t.polyfillSuper=function(e,t,...r){try{t.call(e,...r)}catch(n){const o=new t(...r);Object.assign(e,o)}},t.isNumber=function(e){return"number"==typeof e&&isFinite(e)},t.removeHiddenChars=function(e){return(0,o.default)(e.normalize("NFD").replace(i,""))},t.escapeRegExp=s,t.globToRegexp=function(e,t){t="boolean"!=typeof t||t;let r=s(e);r=r.replace(/\\\*/g,".*"),r=r.replace(/\?/g,"."),t&&(r=r.replace(/\\\[(!|)(.*)\\]/g,(function(e,t,r,n,o){return"["+(t?"^":"")+r.replace(/\\-/,"-")+"]"})));return r},t.ensureNoTrailingSlash=function(e){return e&&e.endsWith("/")?e.substr(0,e.length-1):e},t.sleep=function(e,t){return new Promise(r=>{setTimeout(r,e,t)})},t.isNullOrUndefined=function(e){return null==e},t.defer=function(){let e,t;const r=new Promise((r,n)=>{e=r,t=n});return{resolve:e,reject:t,promise:r}},t.promiseMapSeries=async function(e,t){for(const r of await e)await t(await r)},t.promiseTry=function(e){return new Promise(t=>t(e()))},t.setCrypto=function(e){a=e},t.getCrypto=function(){return a};var o=n(r(91));const i=/[\u2000-\u200F\u202A-\u202F\u0300-\u036f\uFEFF\s]/g;function s(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}let a},function(e,t,r){var n=r(82);e.exports=function(e){return new n(e)}},function(e,t){var r;r=function(){return this}();try{r=r||new Function("return this")()}catch(e){"object"==typeof window&&(r=window)}e.exports=r},function(e,t){function r(e,t,r,n,o,i,s){try{var a=e[i](s),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(n,o)}e.exports=function(e){return function(){var t=this,n=arguments;return new Promise((function(o,i){var s=e.apply(t,n);function a(e){r(s,o,i,a,c,"next",e)}function c(e){r(s,o,i,a,c,"throw",e)}a(void 0)}))}}},function(e,t,r){"use strict";var n,o="object"==typeof Reflect?Reflect:null,i=o&&"function"==typeof o.apply?o.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)};n=o&&"function"==typeof o.ownKeys?o.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var s=Number.isNaN||function(e){return e!=e};function a(){a.init.call(this)}e.exports=a,a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var c=10;function u(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function l(e){return void 0===e._maxListeners?a.defaultMaxListeners:e._maxListeners}function d(e,t,r,n){var o,i,s,a;if(u(r),void 0===(i=e._events)?(i=e._events=Object.create(null),e._eventsCount=0):(void 0!==i.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),i=e._events),s=i[t]),void 0===s)s=i[t]=r,++e._eventsCount;else if("function"==typeof s?s=i[t]=n?[r,s]:[s,r]:n?s.unshift(r):s.push(r),(o=l(e))>0&&s.length>o&&!s.warned){s.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=s.length,a=c,console&&console.warn&&console.warn(a)}return e}function h(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function p(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},o=h.bind(n);return o.listener=r,n.wrapFn=o,o}function f(e,t,r){var n=e._events;if(void 0===n)return[];var o=n[t];return void 0===o?[]:"function"==typeof o?r?[o.listener||o]:[o]:r?function(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(o):g(o,o.length)}function m(e){var t=this._events;if(void 0!==t){var r=t[e];if("function"==typeof r)return 1;if(void 0!==r)return r.length}return 0}function g(e,t){for(var r=new Array(t),n=0;n<t;++n)r[n]=e[n];return r}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");c=e}}),a.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},a.prototype.getMaxListeners=function(){return l(this)},a.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var n="error"===e,o=this._events;if(void 0!==o)n=n&&void 0===o.error;else if(!n)return!1;if(n){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var c=o[e];if(void 0===c)return!1;if("function"==typeof c)i(c,this,t);else{var u=c.length,l=g(c,u);for(r=0;r<u;++r)i(l[r],this,t)}return!0},a.prototype.addListener=function(e,t){return d(this,e,t,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(e,t){return d(this,e,t,!0)},a.prototype.once=function(e,t){return u(t),this.on(e,p(this,e,t)),this},a.prototype.prependOnceListener=function(e,t){return u(t),this.prependListener(e,p(this,e,t)),this},a.prototype.removeListener=function(e,t){var r,n,o,i,s;if(u(t),void 0===(n=this._events))return this;if(void 0===(r=n[e]))return this;if(r===t||r.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(o=-1,i=r.length-1;i>=0;i--)if(r[i]===t||r[i].listener===t){s=r[i].listener,o=i;break}if(o<0)return this;0===o?r.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(r,o),1===r.length&&(n[e]=r[0]),void 0!==n.removeListener&&this.emit("removeListener",e,s||t)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(e){var t,r,n;if(void 0===(r=this._events))return this;if(void 0===r.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete r[e]),this;if(0===arguments.length){var o,i=Object.keys(r);for(n=0;n<i.length;++n)"removeListener"!==(o=i[n])&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},a.prototype.listeners=function(e){return f(this,e,!0)},a.prototype.rawListeners=function(e){return f(this,e,!1)},a.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):m.call(e,t)},a.prototype.listenerCount=m,a.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]}},function(e,t){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},function(e,t){function r(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}e.exports=function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}},function(e,t,r){var n=r(178);e.exports=function(e){return function(){return new n(e.apply(this,arguments))}}},function(e,t){e.exports=function(e){return e&&e.__esModule?e:{default:e}}},function(e,t,r){var n=r(140),o=r(141),i=r(142),s=r(143);e.exports=function(e){return n(e)||o(e)||i(e)||s()}},function(e,t,r){"use strict";var n=r(144),o=r(47),i=r(148),s=r(74),a=r(75),c=r(149),u=r(150),l=r(171),d=r(25);e.exports=v,v.prototype.validate=function(e,t){var r;if("string"==typeof e){if(!(r=this.getSchema(e)))throw new Error('no schema with key or ref "'+e+'"')}else{var n=this._addSchema(e);r=n.validate||this._compile(n)}var o=r(t);!0!==r.$async&&(this.errors=r.errors);return o},v.prototype.compile=function(e,t){var r=this._addSchema(e,void 0,t);return r.validate||this._compile(r)},v.prototype.addSchema=function(e,t,r,n){if(Array.isArray(e)){for(var i=0;i<e.length;i++)this.addSchema(e[i],void 0,r,n);return this}var s=this._getId(e);if(void 0!==s&&"string"!=typeof s)throw new Error("schema id must be string");return w(this,t=o.normalizeId(t||s)),this._schemas[t]=this._addSchema(e,r,n,!0),this},v.prototype.addMetaSchema=function(e,t,r){return this.addSchema(e,t,r,!0),this},v.prototype.validateSchema=function(e,t){var r=e.$schema;if(void 0!==r&&"string"!=typeof r)throw new Error("$schema must be a string");if(!(r=r||this._opts.defaultMeta||function(e){var t=e._opts.meta;return e._opts.defaultMeta="object"==typeof t?e._getId(t)||t:e.getSchema(f)?f:void 0,e._opts.defaultMeta}(this)))return this.logger.warn("meta-schema not available"),this.errors=null,!0;var n=this.validate(r,e);if(!n&&t){var o="schema is invalid: "+this.errorsText();if("log"!=this._opts.validateSchema)throw new Error(o);this.logger.error(o)}return n},v.prototype.getSchema=function(e){var t=y(this,e);switch(typeof t){case"object":return t.validate||this._compile(t);case"string":return this.getSchema(t);case"undefined":return function(e,t){var r=o.schema.call(e,{schema:{}},t);if(r){var i=r.schema,a=r.root,c=r.baseId,u=n.call(e,i,a,void 0,c);return e._fragments[t]=new s({ref:t,fragment:!0,schema:i,root:a,baseId:c,validate:u}),u}}(this,e)}},v.prototype.removeSchema=function(e){if(e instanceof RegExp)return _(this,this._schemas,e),_(this,this._refs,e),this;switch(typeof e){case"undefined":return _(this,this._schemas),_(this,this._refs),this._cache.clear(),this;case"string":var t=y(this,e);return t&&this._cache.del(t.cacheKey),delete this._schemas[e],delete this._refs[e],this;case"object":var r=this._opts.serialize,n=r?r(e):e;this._cache.del(n);var i=this._getId(e);i&&(i=o.normalizeId(i),delete this._schemas[i],delete this._refs[i])}return this},v.prototype.addFormat=function(e,t){"string"==typeof t&&(t=new RegExp(t));return this._formats[e]=t,this},v.prototype.errorsText=function(e,t){if(!(e=e||this.errors))return"No errors";for(var r=void 0===(t=t||{}).separator?", ":t.separator,n=void 0===t.dataVar?"data":t.dataVar,o="",i=0;i<e.length;i++){var s=e[i];s&&(o+=n+s.dataPath+" "+s.message+r)}return o.slice(0,-r.length)},v.prototype._addSchema=function(e,t,r,n){if("object"!=typeof e&&"boolean"!=typeof e)throw new Error("schema should be object or boolean");var i=this._opts.serialize,a=i?i(e):e,c=this._cache.get(a);if(c)return c;n=n||!1!==this._opts.addUsedSchema;var u=o.normalizeId(this._getId(e));u&&n&&w(this,u);var l,d=!1!==this._opts.validateSchema&&!t;d&&!(l=u&&u==o.normalizeId(e.$schema))&&this.validateSchema(e,!0);var h=o.ids.call(this,e),p=new s({id:u,schema:e,localRefs:h,cacheKey:a,meta:r});"#"!=u[0]&&n&&(this._refs[u]=p);this._cache.put(a,p),d&&l&&this.validateSchema(e,!0);return p},v.prototype._compile=function(e,t){if(e.compiling)return e.validate=i,i.schema=e.schema,i.errors=null,i.root=t||i,!0===e.schema.$async&&(i.$async=!0),i;var r,o;e.compiling=!0,e.meta&&(r=this._opts,this._opts=this._metaOpts);try{o=n.call(this,e.schema,t,e.localRefs)}catch(t){throw delete e.validate,t}finally{e.compiling=!1,e.meta&&(this._opts=r)}return e.validate=o,e.refs=o.refs,e.refVal=o.refVal,e.root=o.root,o;function i(){var t=e.validate,r=t.apply(this,arguments);return i.errors=t.errors,r}},v.prototype.compileAsync=r(172);var h=r(173);v.prototype.addKeyword=h.add,v.prototype.getKeyword=h.get,v.prototype.removeKeyword=h.remove,v.prototype.validateKeyword=h.validate;var p=r(49);v.ValidationError=p.Validation,v.MissingRefError=p.MissingRef,v.$dataMetaSchema=l;var f="http://json-schema.org/draft-07/schema",m=["removeAdditional","useDefaults","coerceTypes","strictDefaults"],g=["/properties"];function v(e){if(!(this instanceof v))return new v(e);e=this._opts=d.copy(e)||{},function(e){var t=e._opts.logger;if(!1===t)e.logger={log:R,warn:R,error:R};else{if(void 0===t&&(t=console),!("object"==typeof t&&t.log&&t.warn&&t.error))throw new Error("logger must implement log, warn and error methods");e.logger=t}}(this),this._schemas={},this._refs={},this._fragments={},this._formats=c(e.format),this._cache=e.cache||new i,this._loadingSchemas={},this._compilations=[],this.RULES=u(),this._getId=function(e){switch(e.schemaId){case"auto":return S;case"id":return b;default:return E}}(e),e.loopRequired=e.loopRequired||1/0,"property"==e.errorDataPath&&(e._errorDataPathProperty=!0),void 0===e.serialize&&(e.serialize=a),this._metaOpts=function(e){for(var t=d.copy(e._opts),r=0;r<m.length;r++)delete t[m[r]];return t}(this),e.formats&&function(e){for(var t in e._opts.formats){var r=e._opts.formats[t];e.addFormat(t,r)}}(this),e.keywords&&function(e){for(var t in e._opts.keywords){var r=e._opts.keywords[t];e.addKeyword(t,r)}}(this),function(e){var t;e._opts.$data&&(t=r(176),e.addMetaSchema(t,t.$id,!0));if(!1===e._opts.meta)return;var n=r(81);e._opts.$data&&(n=l(n,g));e.addMetaSchema(n,f,!0),e._refs["http://json-schema.org/schema"]=f}(this),"object"==typeof e.meta&&this.addMetaSchema(e.meta),e.nullable&&this.addKeyword("nullable",{metaSchema:{type:"boolean"}}),function(e){var t=e._opts.schemas;if(!t)return;if(Array.isArray(t))e.addSchema(t);else for(var r in t)e.addSchema(t[r],r)}(this)}function y(e,t){return t=o.normalizeId(t),e._schemas[t]||e._refs[t]||e._fragments[t]}function _(e,t,r){for(var n in t){var o=t[n];o.meta||r&&!r.test(n)||(e._cache.del(o.cacheKey),delete t[n])}}function b(e){return e.$id&&this.logger.warn("schema $id ignored",e.$id),e.id}function E(e){return e.id&&this.logger.warn("schema id ignored",e.id),e.$id}function S(e){if(e.$id&&e.id&&e.$id!=e.id)throw new Error("schema $id is different from id");return e.$id||e.id}function w(e,t){if(e._schemas[t]||e._refs[t])throw new Error('schema with key or id "'+t+'" already exists')}function R(){}},function(e,t){e.exports=function(e){var t;if("undefined"!=typeof Symbol){if(Symbol.asyncIterator&&null!=(t=e[Symbol.asyncIterator]))return t.call(e);if(Symbol.iterator&&null!=(t=e[Symbol.iterator]))return t.call(e)}throw new TypeError("Object is not async iterable")}},function(e,t,r){"use strict";var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixEvent=t.EventStatus=void 0;var o=r(10),i=n(r(6)),s=r(3);t.EventStatus={NOT_SENT:"not_sent",ENCRYPTING:"encrypting",SENDING:"sending",QUEUED:"queued",SENT:"sent",CANCELLED:"cancelled"};const a={};function c(e){return a[e]||(a[e]=e),a[e]}const u=function(e){["state_key","type","sender","room_id","membership"].forEach(t=>{e[t]&&(e[t]=c(e[t]))}),["membership","avatar_url","displayname"].forEach(t=>{e.content&&e.content[t]&&(e.content[t]=c(e.content[t]))}),["rel_type"].forEach(t=>{e.content&&e.content["m.relates_to"]&&e.content["m.relates_to"][t]&&(e.content["m.relates_to"][t]=c(e.content["m.relates_to"][t]))}),this.event=e||{},this.sender=null,this.target=null,this.status=null,this.error=null,this.forwardLooking=!0,this._pushActions=null,this._replacingEvent=null,this._localRedactionEvent=null,this._isCancelled=!1,this._clearEvent={},this._senderCurve25519Key=null,this._claimedEd25519Key=null,this._forwardingCurve25519KeyChain=[],this._untrusted=null,this._decryptionPromise=null,this._retryDecryption=!1,this.verificationRequest=null};t.MatrixEvent=u,i.inherits(u,o.EventEmitter),i.extend(u.prototype,{getId:function(){return this.event.event_id},getSender:function(){return this.event.sender||this.event.user_id},getType:function(){return this._clearEvent.type||this.event.type},getWireType:function(){return this.event.type},getRoomId:function(){return this.event.room_id},getTs:function(){return this.event.origin_server_ts},getDate:function(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null},getOriginalContent:function(){return this._localRedactionEvent?{}:this._clearEvent.content||this.event.content||{}},getContent:function(){return this._localRedactionEvent?{}:this._replacingEvent?this._replacingEvent.getContent()["m.new_content"]||{}:this.getOriginalContent()},getWireContent:function(){return this.event.content||{}},getPrevContent:function(){return this.getUnsigned().prev_content||this.event.prev_content||{}},getDirectionalContent:function(){return this.forwardLooking?this.getContent():this.getPrevContent()},getAge:function(){return this.getUnsigned().age||this.event.age},getLocalAge:function(){return Date.now()-this.getTs()},getStateKey:function(){return this.event.state_key},isState:function(){return void 0!==this.event.state_key},makeEncrypted:function(e,t,r,n){this._clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this._senderCurve25519Key=r,this._claimedEd25519Key=n},isBeingDecrypted:function(){return null!=this._decryptionPromise},isDecryptionFailure:function(){return this._clearEvent&&this._clearEvent.content&&"m.bad.encrypted"===this._clearEvent.content.msgtype},attemptDecryption:async function(e,t){if(!this.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");if(this._clearEvent&&this._clearEvent.content&&"m.bad.encrypted"!==this._clearEvent.content.msgtype)throw new Error("Attempt to decrypt event which has already been decrypted");return this._decryptionPromise?(s.logger.log(`Event ${this.getId()} already being decrypted; queueing a retry`),this._retryDecryption=!0,this._decryptionPromise):(this._decryptionPromise=this._decryptionLoop(e,t),this._decryptionPromise)},cancelAndResendKeyRequest:function(e,t){const r=this.getWireContent();return e.requestRoomKey({algorithm:r.algorithm,room_id:this.getRoomId(),session_id:r.session_id,sender_key:r.sender_key},this.getKeyRequestRecipients(t),!0)},getKeyRequestRecipients:function(e){const t=this.getWireContent(),r=[{userId:e,deviceId:"*"}],n=this.getSender();return n!==e&&r.push({userId:n,deviceId:t.device_id}),r},_decryptionLoop:async function(e,t){for(await Promise.resolve();;){let r,n;this._retryDecryption=!1;try{e?(r=await e.decryptEvent(this),t&&s.logger.info(`Decrypted event on retry (id=${this.getId()})`)):r=this._badEncryptedMessage("Encryption not enabled")}catch(e){if("DecryptionError"!==e.name){const r=t?"re":"";return s.logger.error(`Error ${r}decrypting event (id=${this.getId()}): ${e.stack||e}`),this._decryptionPromise=null,void(this._retryDecryption=!1)}if(n=e,this._retryDecryption){s.logger.log(`Got error decrypting event (id=${this.getId()}: `+e+"), but retrying");continue}s.logger.warn(`Error decrypting event (id=${this.getId()}): ${e.detailedString}`),r=this._badEncryptedMessage(e.message)}return this._decryptionPromise=null,this._retryDecryption=!1,this._setClearData(r),this.setPushActions(null),void this.emit("Event.decrypted",this,n)}},_badEncryptedMessage:function(e){return{clearEvent:{type:"m.room.message",content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: "+e+" **"}}}},_setClearData:function(e){this._clearEvent=e.clearEvent,this._senderCurve25519Key=e.senderCurve25519Key||null,this._claimedEd25519Key=e.claimedEd25519Key||null,this._forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[],this._untrusted=e.untrusted||!1},getClearContent:function(){const e=this._clearEvent;return e&&e.content?e.content:null},isEncrypted:function(){return"m.room.encrypted"===this.event.type},getSenderKey:function(){return this._senderCurve25519Key},getKeysClaimed:function(){return{ed25519:this._claimedEd25519Key}},getClaimedEd25519Key:function(){return this._claimedEd25519Key},getForwardingCurve25519KeyChain:function(){return this._forwardingCurve25519KeyChain},isKeySourceUntrusted:function(){return this._untrusted},getUnsigned:function(){return this.event.unsigned||{}},unmarkLocallyRedacted:function(){const e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=null),!!e},markLocallyRedacted:function(e){this._localRedactionEvent||(this.emit("Event.beforeRedaction",this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)},makeRedacted:function(e){if(!e.event)throw new Error("invalid redaction_event in makeRedacted");let t;for(t in this._localRedactionEvent=null,this.emit("Event.beforeRedaction",this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event,this.event)this.event.hasOwnProperty(t)&&(l[t]||delete this.event[t]);const r=d[this.getType()]||{},n=this.getContent();for(t in n)n.hasOwnProperty(t)&&(r[t]||delete n[t])},isRedacted:function(){return Boolean(this.getUnsigned().redacted_because)},isRedaction:function(){return"m.room.redaction"===this.getType()},getPushActions:function(){return this._pushActions},setPushActions:function(e){this._pushActions=e},handleRemoteEcho:function(e){const t=this.getUnsigned(),r=this.getId();this.event=e,t.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=t.redacted_because),this.setStatus(null),this.getId()!==r&&this.emit("Event.localEventIdReplaced",this)},isSending(){return!!this.status},setStatus(e){this.status=e,this.emit("Event.status",this,e)},replaceLocalEventId(e){this.event.event_id=e,this.emit("Event.localEventIdReplaced",this)},isRelation(e){const t=this.getWireContent(),r=t&&t["m.relates_to"];return r&&r.rel_type&&r.event_id&&(e&&r.rel_type===e||!e)},getRelation(){return this.isRelation()?this.getWireContent()["m.relates_to"]:null},makeReplaced(e){this.isRedacted()&&e||this._replacingEvent!==e&&(this._replacingEvent=e,this.emit("Event.replaced",this))},getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status},getServerAggregatedRelation(e){const t=this.getUnsigned()["m.relations"];if(t)return t[e]},replacingEventId(){const e=this.getServerAggregatedRelation("m.replace");return e?e.event_id:this._replacingEvent?this._replacingEvent.getId():void 0},replacingEvent(){return this._replacingEvent},replacingEventDate(){const e=this.getServerAggregatedRelation("m.replace");if(e){const t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent)return this._replacingEvent.getDate()},localRedactionEvent(){return this._localRedactionEvent},getAssociatedId(){const e=this.getRelation();return e?e.event_id:this.isRedaction()?this.event.redacts:void 0},hasAssocation(){return!!this.getAssociatedId()},updateAssociatedId(e){const t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)},flagCancelled(e=!0){this._isCancelled=e},isCancelled(){return this._isCancelled},toJSON(){const e={type:this.getType(),sender:this.getSender(),content:this.getContent(),event_id:this.getId(),origin_server_ts:this.getTs(),unsigned:this.getUnsigned(),room_id:this.getRoomId()};return this.isRedaction()&&(e.redacts=this.event.redacts),this.isEncrypted()?{decrypted:e,encrypted:this.event}:e},setVerificationRequest:function(e){this.verificationRequest=e}});const l=["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"].reduce((function(e,t){return e[t]=1,e}),{}),d={"m.room.member":{membership:1},"m.room.create":{creator:1},"m.room.join_rules":{join_rule:1},"m.room.power_levels":{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1},"m.room.aliases":{aliases:1}}},function(e,t,r){"use strict";(function(e,n){var o=r(14),i=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.encryptMessageForDevice=async function(e,t,r,n,o,i,c){const u=i.getIdentityKey(),l=await n.getSessionIdForDevice(u);if(null===l)return;s.logger.log("Using sessionid "+l+" for device "+o+":"+i.deviceId);const d={sender:t,sender_device:r,keys:{ed25519:n.deviceEd25519Key},recipient:o,recipient_keys:{ed25519:i.getFingerprint()}};a.extend(d,c),e[u]=await n.encryptMessage(u,l,JSON.stringify(d))},t.getExistingOlmSessions=async function(e,t,r){const n={},o={},i=[];for(const[t,s]of Object.entries(r))for(const r of s){const s=r.deviceId,a=r.getIdentityKey();i.push((async()=>{const i=await e.getSessionIdForDevice(a,!0);null===i?(n[t]=n[t]||[],n[t].push(r)):(o[t]=o[t]||{},o[t][s]={device:r,sessionId:i})})())}return await Promise.all(i),[n,o]},t.ensureOlmSessionsForDevices=async function(e,t,r,n,o,i){"number"==typeof n&&(i=o,o=n,n=!1);const a=[],c={},l={};for(const[t,o]of Object.entries(r)){c[t]={};for(const r of o){const o=r.deviceId,i=r.getIdentityKey();if(i===e.deviceCurve25519Key){s.logger.info("Attempted to start session with ourself! Ignoring"),c[t][o]={device:r,sessionId:null};continue}e._sessionsInProgress[i]||(e._sessionsInProgress[i]=new Promise((t,r)=>{l[i]={resolve:(...r)=>{delete e._sessionsInProgress[i],t(...r)},reject:(...t)=>{delete e._sessionsInProgress[i],r(...t)}}}));const u=await e.getSessionIdForDevice(i,l[i]);null!==u&&l[i]&&(delete e._sessionsInProgress[i],l[i].resolve(),delete l[i]),(null===u||n)&&(n?s.logger.info("Forcing new Olm session for "+t+":"+o):s.logger.info("Making new Olm session for "+t+":"+o),a.push([t,o])),c[t][o]={device:r,sessionId:u}}}if(0===a.length)return c;let d;try{d=await t.claimOneTimeKeys(a,"signed_curve25519",o)}catch(e){for(const e of Object.values(l))e.resolve();throw s.logger.log("failed to claim one-time keys",e,a),e}i&&"failures"in d&&i.push(...Object.keys(d.failures));const h=d.one_time_keys||{},p=[];for(const[t,o]of Object.entries(r)){const r=h[t]||{};for(let i=0;i<o.length;i++){const a=o[i],d=a.deviceId,h=a.getIdentityKey();if(h===e.deviceCurve25519Key)continue;if(c[t][d].sessionId&&!n)continue;const f=r[d]||{};let m=null;for(const e in f)0===e.indexOf("signed_curve25519:")&&(m=f[e]);if(m)p.push(u(e,m,t,a).then(e=>{l[h]&&l[h].resolve(e),c[t][d].sessionId=e},e=>{throw l[h]&&l[h].resolve(),e}));else{const e="No one-time keys (alg=signed_curve25519) for device "+t+":"+d;s.logger.warn(e),l[h]&&l[h].resolve()}}}return await Promise.all(p),c},t.verifySignature=l,t.pkSign=function(t,r,n,o){let i=!1;if(r instanceof Uint8Array){const t=new e.Olm.PkSigning;o=t.init_with_seed(r),r=t,i=!0}const s=t.signatures||{};delete t.signatures;const a=t.unsigned;t.unsigned&&delete t.unsigned;try{const e=s[n]||{};return s[n]=e,e["ed25519:"+o]=r.sign(c.default.stringify(t))}finally{t.signatures=s,a&&(t.unsigned=a),i&&r.free()}},t.pkVerify=function(t,r,n){const o="ed25519:"+r;if(!(t.signatures&&t.signatures[n]&&t.signatures[n][o]))throw new Error("No signature");const i=t.signatures[n][o],s=new e.Olm.Utility,a=t.signatures;delete t.signatures;const u=t.unsigned;t.unsigned&&delete t.unsigned;try{s.ed25519_verify(r,c.default.stringify(t),i)}finally{t.signatures=a,u&&(t.unsigned=u),s.free()}},t.encodeBase64=d,t.encodeUnpaddedBase64=function(e){return d(e).replace(/=+$/g,"")},t.decodeBase64=function(e){return n.from(e,"base64")},t.MEGOLM_BACKUP_ALGORITHM=t.MEGOLM_ALGORITHM=t.OLM_ALGORITHM=void 0;var s=r(3),a=i(r(6)),c=o(r(41));t.OLM_ALGORITHM="m.olm.v1.curve25519-aes-sha2";t.MEGOLM_ALGORITHM="m.megolm.v1.aes-sha2";async function u(e,t,r,n){const o=n.deviceId;try{await l(e,t,r,o,n.getFingerprint())}catch(e){return s.logger.error("Unable to verify signature on one-time key for device "+r+":"+o+":",e),null}let i;try{i=await e.createOutboundSession(n.getIdentityKey(),t.key)}catch(e){return s.logger.error("Error starting olm session with device "+r+":"+o+": "+e),null}return s.logger.log("Started new olm sessionid "+i+" for device "+r+":"+o),i}async function l(e,t,r,n,o){const i="ed25519:"+n,s=((t.signatures||{})[r]||{})[i];if(!s)throw Error("No signature");const a=Object.assign({},t);delete a.unsigned,delete a.signatures;const u=c.default.stringify(a);e.verifySignature(o,u,s)}function d(e){return n.from(e).toString("base64")}t.MEGOLM_BACKUP_ALGORITHM="m.megolm_backup.v1.curve25519-aes-sha2"}).call(this,r(8),r(22).Buffer)},function(e,t,r){"use strict";(function(e){var n=r(14);Object.defineProperty(t,"__esModule",{value:!0});var o={ContentHelpers:!0,request:!0,getRequest:!0,wrapRequest:!0,setCryptoStoreFactory:!0,createClient:!0,createNewMatrixCall:!0,setMatrixCallAudioOutput:!0,setMatrixCallAudioInput:!0,setMatrixCallVideoInput:!0};t.request=function(e){C=e},t.getRequest=function(){return C},t.wrapRequest=function(e){const t=C;C=function(r,n){return e(t,r,n)}},t.setCryptoStoreFactory=function(e){x=e},t.createClient=function(t){"string"==typeof t&&(t={baseUrl:t});return t.request=t.request||C,t.store=t.store||new a.MemoryStore({localStorage:e.localStorage}),t.scheduler=t.scheduler||new c.MatrixScheduler,t.cryptoStore=t.cryptoStore||x(),new u.MatrixClient(t)},Object.defineProperty(t,"createNewMatrixCall",{enumerable:!0,get:function(){return A.createNewMatrixCall}}),Object.defineProperty(t,"setMatrixCallAudioOutput",{enumerable:!0,get:function(){return A.setAudioOutput}}),Object.defineProperty(t,"setMatrixCallAudioInput",{enumerable:!0,get:function(){return A.setAudioInput}}),Object.defineProperty(t,"setMatrixCallVideoInput",{enumerable:!0,get:function(){return A.setVideoInput}}),t.ContentHelpers=void 0;var i=n(r(5)),s=r(35);Object.keys(s).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))}));var a=r(56);Object.keys(a).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))}));var c=r(93);Object.keys(c).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return c[e]}}))}));var u=r(94);Object.keys(u).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return u[e]}}))}));var l=r(29);Object.keys(l).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}}))}));var d=r(70);Object.keys(d).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}}))}));var h=r(71);Object.keys(h).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return h[e]}}))}));var p=r(31);Object.keys(p).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return p[e]}}))}));var f=r(18);Object.keys(f).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return f[e]}}))}));var m=r(58);Object.keys(m).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return m[e]}}))}));var g=r(61);Object.keys(g).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return g[e]}}))}));var v=r(24);Object.keys(v).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return v[e]}}))}));var y=r(59);Object.keys(y).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return y[e]}}))}));var _=r(39);Object.keys(_).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return _[e]}}))}));var b=r(60);Object.keys(b).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return b[e]}}))}));var E=r(27);Object.keys(E).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return E[e]}}))}));var S=r(38);Object.keys(S).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return S[e]}}))}));var w=r(130);Object.keys(w).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return w[e]}}))}));var R=r(131);Object.keys(R).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return R[e]}}))}));var I=r(57);Object.keys(I).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return I[e]}}))}));var k=r(132);Object.keys(k).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return k[e]}}))}));var P=r(135);Object.keys(P).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return P[e]}}))}));var T=r(23);Object.keys(T).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return T[e]}}))}));var O=r(30);Object.keys(O).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return O[e]}}))}));var A=r(62);const D=Promise.resolve().then(()=>(0,i.default)(r(63)));let C;t.ContentHelpers=D;let x=()=>new s.MemoryCryptoStore}).call(this,r(8))},function(e,t,r){"use strict";const n=r(84),{stdout:o,stderr:i}=r(88),{stringReplaceAll:s,stringEncaseCRLFWithFirstIndex:a}=r(89),{isArray:c}=Array,u=["ansi","ansi","ansi256","ansi16m"],l=Object.create(null);class d{constructor(e){return h(e)}}const h=e=>{const t={};return((e,t={})=>{if(t.level&&!(Number.isInteger(t.level)&&t.level>=0&&t.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");const r=o?o.level:0;e.level=void 0===t.level?r:t.level})(t,e),t.template=(...e)=>b(t.template,...e),Object.setPrototypeOf(t,p.prototype),Object.setPrototypeOf(t.template,t),t.template.constructor=()=>{throw new Error("`chalk.constructor()` is deprecated. Use `new chalk.Instance()` instead.")},t.template.Instance=d,t.template};function p(e){return h(e)}for(const[e,t]of Object.entries(n))l[e]={get(){const r=v(this,g(t.open,t.close,this._styler),this._isEmpty);return Object.defineProperty(this,e,{value:r}),r}};l.visible={get(){const e=v(this,this._styler,!0);return Object.defineProperty(this,"visible",{value:e}),e}};const f=["rgb","hex","keyword","hsl","hsv","hwb","ansi","ansi256"];for(const e of f)l[e]={get(){const{level:t}=this;return function(...r){const o=g(n.color[u[t]][e](...r),n.color.close,this._styler);return v(this,o,this._isEmpty)}}};for(const e of f){l["bg"+e[0].toUpperCase()+e.slice(1)]={get(){const{level:t}=this;return function(...r){const o=g(n.bgColor[u[t]][e](...r),n.bgColor.close,this._styler);return v(this,o,this._isEmpty)}}}}const m=Object.defineProperties(()=>{},{...l,level:{enumerable:!0,get(){return this._generator.level},set(e){this._generator.level=e}}}),g=(e,t,r)=>{let n,o;return void 0===r?(n=e,o=t):(n=r.openAll+e,o=t+r.closeAll),{open:e,close:t,openAll:n,closeAll:o,parent:r}},v=(e,t,r)=>{const n=(...e)=>c(e[0])&&c(e[0].raw)?y(n,b(n,...e)):y(n,1===e.length?""+e[0]:e.join(" "));return Object.setPrototypeOf(n,m),n._generator=e,n._styler=t,n._isEmpty=r,n},y=(e,t)=>{if(e.level<=0||!t)return e._isEmpty?"":t;let r=e._styler;if(void 0===r)return t;const{openAll:n,closeAll:o}=r;if(-1!==t.indexOf(""))for(;void 0!==r;)t=s(t,r.close,r.open),r=r.parent;const i=t.indexOf("\n");return-1!==i&&(t=a(t,o,n,i)),n+t+o};let _;const b=(e,...t)=>{const[n]=t;if(!c(n)||!c(n.raw))return t.join(" ");const o=t.slice(1),i=[n.raw[0]];for(let e=1;e<n.length;e++)i.push(String(o[e-1]).replace(/[{}\\]/g,"\\$&"),String(n.raw[e]));return void 0===_&&(_=r(90)),_(e,i.join(""))};Object.defineProperties(p.prototype,l);const E=p();E.supportsColor=o,E.stderr=p({level:i?i.level:0}),E.stderr.supportsColor=i,e.exports=E},function(e,t,r){"use strict";(function(e){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <http://feross.org>
 * @license  MIT
 */
var n=r(110),o=r(111),i=r(112);function s(){return c.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function a(e,t){if(s()<t)throw new RangeError("Invalid typed array length");return c.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=c.prototype:(null===e&&(e=new c(t)),e.length=t),e}function c(e,t,r){if(!(c.TYPED_ARRAY_SUPPORT||this instanceof c))return new c(e,t,r);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return d(this,e)}return u(this,e,t,r)}function u(e,t,r,n){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,r,n){if(t.byteLength,r<0||t.byteLength<r)throw new RangeError("'offset' is out of bounds");if(t.byteLength<r+(n||0))throw new RangeError("'length' is out of bounds");t=void 0===r&&void 0===n?new Uint8Array(t):void 0===n?new Uint8Array(t,r):new Uint8Array(t,r,n);c.TYPED_ARRAY_SUPPORT?(e=t).__proto__=c.prototype:e=h(e,t);return e}(e,t,r,n):"string"==typeof t?function(e,t,r){"string"==typeof r&&""!==r||(r="utf8");if(!c.isEncoding(r))throw new TypeError('"encoding" must be a valid string encoding');var n=0|f(t,r),o=(e=a(e,n)).write(t,r);o!==n&&(e=e.slice(0,o));return e}(e,t,r):function(e,t){if(c.isBuffer(t)){var r=0|p(t.length);return 0===(e=a(e,r)).length||t.copy(e,0,0,r),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(n=t.length)!=n?a(e,0):h(e,t);if("Buffer"===t.type&&i(t.data))return h(e,t.data)}var n;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function l(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function d(e,t){if(l(t),e=a(e,t<0?0:0|p(t)),!c.TYPED_ARRAY_SUPPORT)for(var r=0;r<t;++r)e[r]=0;return e}function h(e,t){var r=t.length<0?0:0|p(t.length);e=a(e,r);for(var n=0;n<r;n+=1)e[n]=255&t[n];return e}function p(e){if(e>=s())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s().toString(16)+" bytes");return 0|e}function f(e,t){if(c.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var r=e.length;if(0===r)return 0;for(var n=!1;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":case void 0:return K(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return B(e).length;default:if(n)return K(e).length;t=(""+t).toLowerCase(),n=!0}}function m(e,t,r){var n=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return O(this,t,r);case"utf8":case"utf-8":return k(this,t,r);case"ascii":return P(this,t,r);case"latin1":case"binary":return T(this,t,r);case"base64":return I(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return A(this,t,r);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function g(e,t,r){var n=e[t];e[t]=e[r],e[r]=n}function v(e,t,r,n,o){if(0===e.length)return-1;if("string"==typeof r?(n=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),r=+r,isNaN(r)&&(r=o?0:e.length-1),r<0&&(r=e.length+r),r>=e.length){if(o)return-1;r=e.length-1}else if(r<0){if(!o)return-1;r=0}if("string"==typeof t&&(t=c.from(t,n)),c.isBuffer(t))return 0===t.length?-1:y(e,t,r,n,o);if("number"==typeof t)return t&=255,c.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?o?Uint8Array.prototype.indexOf.call(e,t,r):Uint8Array.prototype.lastIndexOf.call(e,t,r):y(e,[t],r,n,o);throw new TypeError("val must be string, number or Buffer")}function y(e,t,r,n,o){var i,s=1,a=e.length,c=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;s=2,a/=2,c/=2,r/=2}function u(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(o){var l=-1;for(i=r;i<a;i++)if(u(e,i)===u(t,-1===l?0:i-l)){if(-1===l&&(l=i),i-l+1===c)return l*s}else-1!==l&&(i-=i-l),l=-1}else for(r+c>a&&(r=a-c),i=r;i>=0;i--){for(var d=!0,h=0;h<c;h++)if(u(e,i+h)!==u(t,h)){d=!1;break}if(d)return i}return-1}function _(e,t,r,n){r=Number(r)||0;var o=e.length-r;n?(n=Number(n))>o&&(n=o):n=o;var i=t.length;if(i%2!=0)throw new TypeError("Invalid hex string");n>i/2&&(n=i/2);for(var s=0;s<n;++s){var a=parseInt(t.substr(2*s,2),16);if(isNaN(a))return s;e[r+s]=a}return s}function b(e,t,r,n){return q(K(t,e.length-r),e,r,n)}function E(e,t,r,n){return q(function(e){for(var t=[],r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}(t),e,r,n)}function S(e,t,r,n){return E(e,t,r,n)}function w(e,t,r,n){return q(B(t),e,r,n)}function R(e,t,r,n){return q(function(e,t){for(var r,n,o,i=[],s=0;s<e.length&&!((t-=2)<0);++s)r=e.charCodeAt(s),n=r>>8,o=r%256,i.push(o),i.push(n);return i}(t,e.length-r),e,r,n)}function I(e,t,r){return 0===t&&r===e.length?n.fromByteArray(e):n.fromByteArray(e.slice(t,r))}function k(e,t,r){r=Math.min(e.length,r);for(var n=[],o=t;o<r;){var i,s,a,c,u=e[o],l=null,d=u>239?4:u>223?3:u>191?2:1;if(o+d<=r)switch(d){case 1:u<128&&(l=u);break;case 2:128==(192&(i=e[o+1]))&&(c=(31&u)<<6|63&i)>127&&(l=c);break;case 3:i=e[o+1],s=e[o+2],128==(192&i)&&128==(192&s)&&(c=(15&u)<<12|(63&i)<<6|63&s)>2047&&(c<55296||c>57343)&&(l=c);break;case 4:i=e[o+1],s=e[o+2],a=e[o+3],128==(192&i)&&128==(192&s)&&128==(192&a)&&(c=(15&u)<<18|(63&i)<<12|(63&s)<<6|63&a)>65535&&c<1114112&&(l=c)}null===l?(l=65533,d=1):l>65535&&(l-=65536,n.push(l>>>10&1023|55296),l=56320|1023&l),n.push(l),o+=d}return function(e){var t=e.length;if(t<=4096)return String.fromCharCode.apply(String,e);var r="",n=0;for(;n<t;)r+=String.fromCharCode.apply(String,e.slice(n,n+=4096));return r}(n)}t.Buffer=c,t.SlowBuffer=function(e){+e!=e&&(e=0);return c.alloc(+e)},t.INSPECT_MAX_BYTES=50,c.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),t.kMaxLength=s(),c.poolSize=8192,c._augment=function(e){return e.__proto__=c.prototype,e},c.from=function(e,t,r){return u(null,e,t,r)},c.TYPED_ARRAY_SUPPORT&&(c.prototype.__proto__=Uint8Array.prototype,c.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&c[Symbol.species]===c&&Object.defineProperty(c,Symbol.species,{value:null,configurable:!0})),c.alloc=function(e,t,r){return function(e,t,r,n){return l(t),t<=0?a(e,t):void 0!==r?"string"==typeof n?a(e,t).fill(r,n):a(e,t).fill(r):a(e,t)}(null,e,t,r)},c.allocUnsafe=function(e){return d(null,e)},c.allocUnsafeSlow=function(e){return d(null,e)},c.isBuffer=function(e){return!(null==e||!e._isBuffer)},c.compare=function(e,t){if(!c.isBuffer(e)||!c.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var r=e.length,n=t.length,o=0,i=Math.min(r,n);o<i;++o)if(e[o]!==t[o]){r=e[o],n=t[o];break}return r<n?-1:n<r?1:0},c.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(e,t){if(!i(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return c.alloc(0);var r;if(void 0===t)for(t=0,r=0;r<e.length;++r)t+=e[r].length;var n=c.allocUnsafe(t),o=0;for(r=0;r<e.length;++r){var s=e[r];if(!c.isBuffer(s))throw new TypeError('"list" argument must be an Array of Buffers');s.copy(n,o),o+=s.length}return n},c.byteLength=f,c.prototype._isBuffer=!0,c.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)g(this,t,t+1);return this},c.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)g(this,t,t+3),g(this,t+1,t+2);return this},c.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)g(this,t,t+7),g(this,t+1,t+6),g(this,t+2,t+5),g(this,t+3,t+4);return this},c.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?k(this,0,e):m.apply(this,arguments)},c.prototype.equals=function(e){if(!c.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===c.compare(this,e)},c.prototype.inspect=function(){var e="",r=t.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,r).match(/.{2}/g).join(" "),this.length>r&&(e+=" ... ")),"<Buffer "+e+">"},c.prototype.compare=function(e,t,r,n,o){if(!c.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===r&&(r=e?e.length:0),void 0===n&&(n=0),void 0===o&&(o=this.length),t<0||r>e.length||n<0||o>this.length)throw new RangeError("out of range index");if(n>=o&&t>=r)return 0;if(n>=o)return-1;if(t>=r)return 1;if(this===e)return 0;for(var i=(o>>>=0)-(n>>>=0),s=(r>>>=0)-(t>>>=0),a=Math.min(i,s),u=this.slice(n,o),l=e.slice(t,r),d=0;d<a;++d)if(u[d]!==l[d]){i=u[d],s=l[d];break}return i<s?-1:s<i?1:0},c.prototype.includes=function(e,t,r){return-1!==this.indexOf(e,t,r)},c.prototype.indexOf=function(e,t,r){return v(this,e,t,r,!0)},c.prototype.lastIndexOf=function(e,t,r){return v(this,e,t,r,!1)},c.prototype.write=function(e,t,r,n){if(void 0===t)n="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)n=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(r)?(r|=0,void 0===n&&(n="utf8")):(n=r,r=void 0)}var o=this.length-t;if((void 0===r||r>o)&&(r=o),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var i=!1;;)switch(n){case"hex":return _(this,e,t,r);case"utf8":case"utf-8":return b(this,e,t,r);case"ascii":return E(this,e,t,r);case"latin1":case"binary":return S(this,e,t,r);case"base64":return w(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return R(this,e,t,r);default:if(i)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),i=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function P(e,t,r){var n="";r=Math.min(e.length,r);for(var o=t;o<r;++o)n+=String.fromCharCode(127&e[o]);return n}function T(e,t,r){var n="";r=Math.min(e.length,r);for(var o=t;o<r;++o)n+=String.fromCharCode(e[o]);return n}function O(e,t,r){var n=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>n)&&(r=n);for(var o="",i=t;i<r;++i)o+=L(e[i]);return o}function A(e,t,r){for(var n=e.slice(t,r),o="",i=0;i<n.length;i+=2)o+=String.fromCharCode(n[i]+256*n[i+1]);return o}function D(e,t,r){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}function C(e,t,r,n,o,i){if(!c.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>o||t<i)throw new RangeError('"value" argument is out of bounds');if(r+n>e.length)throw new RangeError("Index out of range")}function x(e,t,r,n){t<0&&(t=65535+t+1);for(var o=0,i=Math.min(e.length-r,2);o<i;++o)e[r+o]=(t&255<<8*(n?o:1-o))>>>8*(n?o:1-o)}function M(e,t,r,n){t<0&&(t=4294967295+t+1);for(var o=0,i=Math.min(e.length-r,4);o<i;++o)e[r+o]=t>>>8*(n?o:3-o)&255}function j(e,t,r,n,o,i){if(r+n>e.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function U(e,t,r,n,i){return i||j(e,0,r,4),o.write(e,t,r,n,23,4),r+4}function N(e,t,r,n,i){return i||j(e,0,r,8),o.write(e,t,r,n,52,8),r+8}c.prototype.slice=function(e,t){var r,n=this.length;if((e=~~e)<0?(e+=n)<0&&(e=0):e>n&&(e=n),(t=void 0===t?n:~~t)<0?(t+=n)<0&&(t=0):t>n&&(t=n),t<e&&(t=e),c.TYPED_ARRAY_SUPPORT)(r=this.subarray(e,t)).__proto__=c.prototype;else{var o=t-e;r=new c(o,void 0);for(var i=0;i<o;++i)r[i]=this[i+e]}return r},c.prototype.readUIntLE=function(e,t,r){e|=0,t|=0,r||D(e,t,this.length);for(var n=this[e],o=1,i=0;++i<t&&(o*=256);)n+=this[e+i]*o;return n},c.prototype.readUIntBE=function(e,t,r){e|=0,t|=0,r||D(e,t,this.length);for(var n=this[e+--t],o=1;t>0&&(o*=256);)n+=this[e+--t]*o;return n},c.prototype.readUInt8=function(e,t){return t||D(e,1,this.length),this[e]},c.prototype.readUInt16LE=function(e,t){return t||D(e,2,this.length),this[e]|this[e+1]<<8},c.prototype.readUInt16BE=function(e,t){return t||D(e,2,this.length),this[e]<<8|this[e+1]},c.prototype.readUInt32LE=function(e,t){return t||D(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},c.prototype.readUInt32BE=function(e,t){return t||D(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},c.prototype.readIntLE=function(e,t,r){e|=0,t|=0,r||D(e,t,this.length);for(var n=this[e],o=1,i=0;++i<t&&(o*=256);)n+=this[e+i]*o;return n>=(o*=128)&&(n-=Math.pow(2,8*t)),n},c.prototype.readIntBE=function(e,t,r){e|=0,t|=0,r||D(e,t,this.length);for(var n=t,o=1,i=this[e+--n];n>0&&(o*=256);)i+=this[e+--n]*o;return i>=(o*=128)&&(i-=Math.pow(2,8*t)),i},c.prototype.readInt8=function(e,t){return t||D(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},c.prototype.readInt16LE=function(e,t){t||D(e,2,this.length);var r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},c.prototype.readInt16BE=function(e,t){t||D(e,2,this.length);var r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},c.prototype.readInt32LE=function(e,t){return t||D(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},c.prototype.readInt32BE=function(e,t){return t||D(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},c.prototype.readFloatLE=function(e,t){return t||D(e,4,this.length),o.read(this,e,!0,23,4)},c.prototype.readFloatBE=function(e,t){return t||D(e,4,this.length),o.read(this,e,!1,23,4)},c.prototype.readDoubleLE=function(e,t){return t||D(e,8,this.length),o.read(this,e,!0,52,8)},c.prototype.readDoubleBE=function(e,t){return t||D(e,8,this.length),o.read(this,e,!1,52,8)},c.prototype.writeUIntLE=function(e,t,r,n){(e=+e,t|=0,r|=0,n)||C(this,e,t,r,Math.pow(2,8*r)-1,0);var o=1,i=0;for(this[t]=255&e;++i<r&&(o*=256);)this[t+i]=e/o&255;return t+r},c.prototype.writeUIntBE=function(e,t,r,n){(e=+e,t|=0,r|=0,n)||C(this,e,t,r,Math.pow(2,8*r)-1,0);var o=r-1,i=1;for(this[t+o]=255&e;--o>=0&&(i*=256);)this[t+o]=e/i&255;return t+r},c.prototype.writeUInt8=function(e,t,r){return e=+e,t|=0,r||C(this,e,t,1,255,0),c.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},c.prototype.writeUInt16LE=function(e,t,r){return e=+e,t|=0,r||C(this,e,t,2,65535,0),c.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):x(this,e,t,!0),t+2},c.prototype.writeUInt16BE=function(e,t,r){return e=+e,t|=0,r||C(this,e,t,2,65535,0),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):x(this,e,t,!1),t+2},c.prototype.writeUInt32LE=function(e,t,r){return e=+e,t|=0,r||C(this,e,t,4,4294967295,0),c.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):M(this,e,t,!0),t+4},c.prototype.writeUInt32BE=function(e,t,r){return e=+e,t|=0,r||C(this,e,t,4,4294967295,0),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):M(this,e,t,!1),t+4},c.prototype.writeIntLE=function(e,t,r,n){if(e=+e,t|=0,!n){var o=Math.pow(2,8*r-1);C(this,e,t,r,o-1,-o)}var i=0,s=1,a=0;for(this[t]=255&e;++i<r&&(s*=256);)e<0&&0===a&&0!==this[t+i-1]&&(a=1),this[t+i]=(e/s>>0)-a&255;return t+r},c.prototype.writeIntBE=function(e,t,r,n){if(e=+e,t|=0,!n){var o=Math.pow(2,8*r-1);C(this,e,t,r,o-1,-o)}var i=r-1,s=1,a=0;for(this[t+i]=255&e;--i>=0&&(s*=256);)e<0&&0===a&&0!==this[t+i+1]&&(a=1),this[t+i]=(e/s>>0)-a&255;return t+r},c.prototype.writeInt8=function(e,t,r){return e=+e,t|=0,r||C(this,e,t,1,127,-128),c.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},c.prototype.writeInt16LE=function(e,t,r){return e=+e,t|=0,r||C(this,e,t,2,32767,-32768),c.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):x(this,e,t,!0),t+2},c.prototype.writeInt16BE=function(e,t,r){return e=+e,t|=0,r||C(this,e,t,2,32767,-32768),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):x(this,e,t,!1),t+2},c.prototype.writeInt32LE=function(e,t,r){return e=+e,t|=0,r||C(this,e,t,4,2147483647,-2147483648),c.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):M(this,e,t,!0),t+4},c.prototype.writeInt32BE=function(e,t,r){return e=+e,t|=0,r||C(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):M(this,e,t,!1),t+4},c.prototype.writeFloatLE=function(e,t,r){return U(this,e,t,!0,r)},c.prototype.writeFloatBE=function(e,t,r){return U(this,e,t,!1,r)},c.prototype.writeDoubleLE=function(e,t,r){return N(this,e,t,!0,r)},c.prototype.writeDoubleBE=function(e,t,r){return N(this,e,t,!1,r)},c.prototype.copy=function(e,t,r,n){if(r||(r=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<r&&(n=r),n===r)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("sourceStart out of bounds");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-r&&(n=e.length-t+r);var o,i=n-r;if(this===e&&r<t&&t<n)for(o=i-1;o>=0;--o)e[o+t]=this[o+r];else if(i<1e3||!c.TYPED_ARRAY_SUPPORT)for(o=0;o<i;++o)e[o+t]=this[o+r];else Uint8Array.prototype.set.call(e,this.subarray(r,r+i),t);return i},c.prototype.fill=function(e,t,r,n){if("string"==typeof e){if("string"==typeof t?(n=t,t=0,r=this.length):"string"==typeof r&&(n=r,r=this.length),1===e.length){var o=e.charCodeAt(0);o<256&&(e=o)}if(void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!c.isEncoding(n))throw new TypeError("Unknown encoding: "+n)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<r)throw new RangeError("Out of range index");if(r<=t)return this;var i;if(t>>>=0,r=void 0===r?this.length:r>>>0,e||(e=0),"number"==typeof e)for(i=t;i<r;++i)this[i]=e;else{var s=c.isBuffer(e)?e:K(new c(e,n).toString()),a=s.length;for(i=0;i<r-t;++i)this[i+t]=s[i%a]}return this};var F=/[^+\/0-9A-Za-z-_]/g;function L(e){return e<16?"0"+e.toString(16):e.toString(16)}function K(e,t){var r;t=t||1/0;for(var n=e.length,o=null,i=[],s=0;s<n;++s){if((r=e.charCodeAt(s))>55295&&r<57344){if(!o){if(r>56319){(t-=3)>-1&&i.push(239,191,189);continue}if(s+1===n){(t-=3)>-1&&i.push(239,191,189);continue}o=r;continue}if(r<56320){(t-=3)>-1&&i.push(239,191,189),o=r;continue}r=65536+(o-55296<<10|r-56320)}else o&&(t-=3)>-1&&i.push(239,191,189);if(o=null,r<128){if((t-=1)<0)break;i.push(r)}else if(r<2048){if((t-=2)<0)break;i.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;i.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;i.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return i}function B(e){return n.toByteArray(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(F,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function q(e,t,r,n){for(var o=0;o<n&&!(o+r>=t.length||o>=e.length);++o)t[o+r]=e[o];return o}}).call(this,r(8))},function(e,t,r){"use strict";(function(e){var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.IndexedDBCryptoStore=void 0;var o=r(3),i=r(114),s=r(35),a=n(r(115)),c=r(31),u=n(r(64));class l{constructor(e,t){this._indexedDB=e,this._dbName=t,this._backendPromise=null,this._backend=null}static exists(e,t){return u.exists(e,t)}startup(){return this._backendPromise||(this._backendPromise=new Promise((e,t)=>{if(!this._indexedDB)return void t(new Error("no indexeddb support available"));o.logger.log("connecting to indexeddb "+this._dbName);const r=this._indexedDB.open(this._dbName,a.VERSION);r.onupgradeneeded=e=>{const t=e.target.result,r=e.oldVersion;a.upgradeDatabase(t,r)},r.onblocked=()=>{o.logger.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},r.onerror=e=>{o.logger.log("Error connecting to indexeddb",e),t(e.target.error)},r.onsuccess=t=>{const r=t.target.result;o.logger.log("connected to indexeddb "+this._dbName),e(new a.Backend(r))}}).then(e=>e.doTxn("readonly",[l.STORE_INBOUND_GROUP_SESSIONS,l.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],t=>{e.getEndToEndInboundGroupSession("","",t,()=>{})}).then(()=>e)).catch(t=>{if("VersionError"===t.name)throw o.logger.warn("Crypto DB is too new for us to use!",t),new c.InvalidCryptoStoreError(c.InvalidCryptoStoreError.TOO_NEW);o.logger.warn("unable to connect to indexeddb "+this._dbName+": falling back to localStorage store: "+t);try{return new i.LocalStorageCryptoStore(e.localStorage)}catch(t){return o.logger.warn("unable to open localStorage: falling back to in-memory store: "+t),new s.MemoryCryptoStore}}).then(e=>{this._backend=e})),this._backendPromise}deleteAllData(){return new Promise((e,t)=>{if(!this._indexedDB)return void t(new Error("no indexeddb support available"));o.logger.log("Removing indexeddb instance: "+this._dbName);const r=this._indexedDB.deleteDatabase(this._dbName);r.onblocked=()=>{o.logger.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},r.onerror=e=>{o.logger.log("Error deleting data from indexeddb",e),t(e.target.error)},r.onsuccess=()=>{o.logger.log("Removed indexeddb instance: "+this._dbName),e()}}).catch(e=>{o.logger.warn("unable to delete IndexedDBCryptoStore: "+e)})}getOrAddOutgoingRoomKeyRequest(e){return this._backend.getOrAddOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequest(e){return this._backend.getOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequestByState(e){return this._backend.getOutgoingRoomKeyRequestByState(e)}getAllOutgoingRoomKeyRequestsByState(e){return this._backend.getAllOutgoingRoomKeyRequestsByState(e)}getOutgoingRoomKeyRequestsByTarget(e,t,r){return this._backend.getOutgoingRoomKeyRequestsByTarget(e,t,r)}updateOutgoingRoomKeyRequest(e,t,r){return this._backend.updateOutgoingRoomKeyRequest(e,t,r)}deleteOutgoingRoomKeyRequest(e,t){return this._backend.deleteOutgoingRoomKeyRequest(e,t)}getAccount(e,t){this._backend.getAccount(e,t)}storeAccount(e,t){this._backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this._backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,r){this._backend.getSecretStorePrivateKey(e,t,r)}storeCrossSigningKeys(e,t){this._backend.storeCrossSigningKeys(e,t)}storeSecretStorePrivateKey(e,t,r){this._backend.storeSecretStorePrivateKey(e,t,r)}countEndToEndSessions(e,t){this._backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,r,n){this._backend.getEndToEndSession(e,t,r,n)}getEndToEndSessions(e,t,r){this._backend.getEndToEndSessions(e,t,r)}getAllEndToEndSessions(e,t){this._backend.getAllEndToEndSessions(e,t)}storeEndToEndSession(e,t,r,n){this._backend.storeEndToEndSession(e,t,r,n)}storeEndToEndSessionProblem(e,t,r){return this._backend.storeEndToEndSessionProblem(e,t,r)}getEndToEndSessionProblem(e,t){return this._backend.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this._backend.filterOutNotifiedErrorDevices(e)}getEndToEndInboundGroupSession(e,t,r,n){this._backend.getEndToEndInboundGroupSession(e,t,r,n)}getAllEndToEndInboundGroupSessions(e,t){this._backend.getAllEndToEndInboundGroupSessions(e,t)}addEndToEndInboundGroupSession(e,t,r,n){this._backend.addEndToEndInboundGroupSession(e,t,r,n)}storeEndToEndInboundGroupSession(e,t,r,n){this._backend.storeEndToEndInboundGroupSession(e,t,r,n)}storeEndToEndInboundGroupSessionWithheld(e,t,r,n){this._backend.storeEndToEndInboundGroupSessionWithheld(e,t,r,n)}storeEndToEndDeviceData(e,t){this._backend.storeEndToEndDeviceData(e,t)}getEndToEndDeviceData(e,t){this._backend.getEndToEndDeviceData(e,t)}storeEndToEndRoom(e,t,r){this._backend.storeEndToEndRoom(e,t,r)}getEndToEndRooms(e,t){this._backend.getEndToEndRooms(e,t)}getSessionsNeedingBackup(e){return this._backend.getSessionsNeedingBackup(e)}countSessionsNeedingBackup(e){return this._backend.countSessionsNeedingBackup(e)}unmarkSessionsNeedingBackup(e,t){return this._backend.unmarkSessionsNeedingBackup(e,t)}markSessionsNeedingBackup(e,t){return this._backend.markSessionsNeedingBackup(e,t)}doTxn(e,t,r){return this._backend.doTxn(e,t,r)}}t.IndexedDBCryptoStore=l,l.STORE_ACCOUNT="account",l.STORE_SESSIONS="sessions",l.STORE_INBOUND_GROUP_SESSIONS="inbound_group_sessions",l.STORE_INBOUND_GROUP_SESSIONS_WITHHELD="inbound_group_sessions_withheld",l.STORE_DEVICE_DATA="device_data",l.STORE_ROOMS="rooms",l.STORE_BACKUP="sessions_needing_backup"}).call(this,r(8))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EventTimeline=o;var n=r(60);function o(e){this._eventTimelineSet=e,this._roomId=e.room?e.room.roomId:null,this._events=[],this._baseIndex=0,this._startState=new n.RoomState(this._roomId),this._startState.paginationToken=null,this._endState=new n.RoomState(this._roomId),this._endState.paginationToken=null,this._prevTimeline=null,this._nextTimeline=null,this._paginationRequests={b:null,f:null},this._name=this._roomId+":"+(new Date).toISOString()}o.BACKWARDS="b",o.FORWARDS="f",o.prototype.initialiseState=function(e){if(this._events.length>0)throw new Error("Cannot initialise state after events are added");for(const t of e)Object.freeze(t);this._startState.setStateEvents(e),this._endState.setStateEvents(e)},o.prototype.forkLive=function(e){const t=this.getState(e),r=new o(this._eventTimelineSet);return r._startState=t.clone(),r._endState=t,this._endState=t.clone(),r},o.prototype.fork=function(e){const t=this.getState(e),r=new o(this._eventTimelineSet);return r._startState=t.clone(),r._endState=t.clone(),r},o.prototype.getRoomId=function(){return this._roomId},o.prototype.getFilter=function(){return this._eventTimelineSet.getFilter()},o.prototype.getTimelineSet=function(){return this._eventTimelineSet},o.prototype.getBaseIndex=function(){return this._baseIndex},o.prototype.getEvents=function(){return this._events},o.prototype.getState=function(e){if(e==o.BACKWARDS)return this._startState;if(e==o.FORWARDS)return this._endState;throw new Error("Invalid direction '"+e+"'")},o.prototype.getPaginationToken=function(e){return this.getState(e).paginationToken},o.prototype.setPaginationToken=function(e,t){this.getState(t).paginationToken=e},o.prototype.getNeighbouringTimeline=function(e){if(e==o.BACKWARDS)return this._prevTimeline;if(e==o.FORWARDS)return this._nextTimeline;throw new Error("Invalid direction '"+e+"'")},o.prototype.setNeighbouringTimeline=function(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==o.BACKWARDS)this._prevTimeline=e;else{if(t!=o.FORWARDS)throw new Error("Invalid direction '"+t+"'");this._nextTimeline=e}this.setPaginationToken(null,t)},o.prototype.addEvent=function(e,t){const r=t?this._startState:this._endState,n=this.getTimelineSet();let i;n.room&&n.room.getUnfilteredTimelineSet()===n&&(o.setEventMetadata(e,r,t),e.isState()&&(r.setStateEvents([e]),e.sender&&("m.room.member"!==e.getType()||t)||o.setEventMetadata(e,r,t))),i=t?0:this._events.length,this._events.splice(i,0,e),t&&this._baseIndex++},o.setEventMetadata=function(e,t,r){e.sender=t.getSentinelMember(e.getSender()),"m.room.member"===e.getType()&&(e.target=t.getSentinelMember(e.getStateKey())),e.isState()&&r&&(e.forwardLooking=!1)},o.prototype.removeEvent=function(e){for(let t=this._events.length-1;t>=0;t--){const r=this._events[t];if(r.getId()==e)return this._events.splice(t,1),t<this._baseIndex&&this._baseIndex--,r}return null},o.prototype.toString=function(){return this._name}},function(e,t,r){"use strict";function n(e,t,r,n){var o=n?" !== ":" === ",i=n?" || ":" && ",s=n?"!":"",a=n?"":"!";switch(e){case"null":return t+o+"null";case"array":return s+"Array.isArray("+t+")";case"object":return"("+s+t+i+"typeof "+t+o+'"object"'+i+a+"Array.isArray("+t+"))";case"integer":return"(typeof "+t+o+'"number"'+i+a+"("+t+" % 1)"+i+t+o+t+(r?i+s+"isFinite("+t+")":"")+")";case"number":return"(typeof "+t+o+'"'+e+'"'+(r?i+s+"isFinite("+t+")":"")+")";default:return"typeof "+t+o+'"'+e+'"'}}e.exports={copy:function(e,t){for(var r in t=t||{},e)t[r]=e[r];return t},checkDataType:n,checkDataTypes:function(e,t,r){switch(e.length){case 1:return n(e[0],t,r,!0);default:var o="",s=i(e);for(var a in s.array&&s.object&&(o=s.null?"(":"(!"+t+" || ",o+="typeof "+t+' !== "object")',delete s.null,delete s.array,delete s.object),s.number&&delete s.integer,s)o+=(o?" && ":"")+n(a,t,r,!0);return o}},coerceToTypes:function(e,t){if(Array.isArray(t)){for(var r=[],n=0;n<t.length;n++){var i=t[n];(o[i]||"array"===e&&"array"===i)&&(r[r.length]=i)}if(r.length)return r}else{if(o[t])return[t];if("array"===e&&"array"===t)return["array"]}},toHash:i,getProperty:c,escapeQuotes:u,equal:r(48),ucs2length:r(146),varOccurences:function(e,t){t+="[^0-9]";var r=e.match(new RegExp(t,"g"));return r?r.length:0},varReplace:function(e,t,r){return t+="([^0-9])",r=r.replace(/\$/g,"$$$$"),e.replace(new RegExp(t,"g"),r+"$1")},schemaHasRules:function(e,t){if("boolean"==typeof e)return!e;for(var r in e)if(t[r])return!0},schemaHasRulesExcept:function(e,t,r){if("boolean"==typeof e)return!e&&"not"!=r;for(var n in e)if(n!=r&&t[n])return!0},schemaUnknownRules:function(e,t){if("boolean"==typeof e)return;for(var r in e)if(!t[r])return r},toQuotedString:l,getPathExpr:function(e,t,r,n){return p(e,r?"'/' + "+t+(n?"":".replace(/~/g, '~0').replace(/\\//g, '~1')"):n?"'[' + "+t+" + ']'":"'[\\'' + "+t+" + '\\']'")},getPath:function(e,t,r){var n=l(r?"/"+f(t):c(t));return p(e,n)},getData:function(e,t,r){var n,o,i,s;if(""===e)return"rootData";if("/"==e[0]){if(!d.test(e))throw new Error("Invalid JSON-pointer: "+e);o=e,i="rootData"}else{if(!(s=e.match(h)))throw new Error("Invalid JSON-pointer: "+e);if(n=+s[1],"#"==(o=s[2])){if(n>=t)throw new Error("Cannot access property/index "+n+" levels up, current level is "+t);return r[t-n]}if(n>t)throw new Error("Cannot access data "+n+" levels up, current level is "+t);if(i="data"+(t-n||""),!o)return i}for(var a=i,u=o.split("/"),l=0;l<u.length;l++){var p=u[l];p&&(i+=c(m(p)),a+=" && "+i)}return a},unescapeFragment:function(e){return m(decodeURIComponent(e))},unescapeJsonPointer:m,escapeFragment:function(e){return encodeURIComponent(f(e))},escapeJsonPointer:f};var o=i(["string","number","integer","boolean","null"]);function i(e){for(var t={},r=0;r<e.length;r++)t[e[r]]=!0;return t}var s=/^[a-z$_][a-z$_0-9]*$/i,a=/'|\\/g;function c(e){return"number"==typeof e?"["+e+"]":s.test(e)?"."+e:"['"+u(e)+"']"}function u(e){return e.replace(a,"\\$&").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\f/g,"\\f").replace(/\t/g,"\\t")}function l(e){return"'"+u(e)+"'"}var d=/^\/(?:[^~]|~0|~1)*$/,h=/^([0-9]+)(#|\/(?:[^~]|~0|~1)*)?$/;function p(e,t){return'""'==e?t:(e+" + "+t).replace(/([^\\])' \+ '/g,"$1")}function f(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}function m(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}},function(e,t,r){var n,o;!function(i,s){"use strict";void 0===(o="function"==typeof(n=function(){var e=function(){},t="undefined"!=typeof window&&void 0!==window.navigator&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"];function n(e,t){var r=e[t];if("function"==typeof r.bind)return r.bind(e);try{return Function.prototype.bind.call(r,e)}catch(t){return function(){return Function.prototype.apply.apply(r,[e,arguments])}}}function o(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function i(r){return"debug"===r&&(r="log"),"undefined"!=typeof console&&("trace"===r&&t?o:void 0!==console[r]?n(console,r):void 0!==console.log?n(console,"log"):e)}function s(t,n){for(var o=0;o<r.length;o++){var i=r[o];this[i]=o<t?e:this.methodFactory(i,t,n)}this.log=this.debug}function a(e,t,r){return function(){"undefined"!=typeof console&&(s.call(this,t,r),this[e].apply(this,arguments))}}function c(e,t,r){return i(e)||a.apply(this,arguments)}function u(e,t,n){var o,i=this,a="loglevel";function u(){var e;if("undefined"!=typeof window){try{e=window.localStorage[a]}catch(e){}if(void 0===e)try{var t=window.document.cookie,r=t.indexOf(encodeURIComponent(a)+"=");-1!==r&&(e=/^([^;]+)/.exec(t.slice(r))[1])}catch(e){}return void 0===i.levels[e]&&(e=void 0),e}}e&&(a+=":"+e),i.name=e,i.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},i.methodFactory=n||c,i.getLevel=function(){return o},i.setLevel=function(t,n){if("string"==typeof t&&void 0!==i.levels[t.toUpperCase()]&&(t=i.levels[t.toUpperCase()]),!("number"==typeof t&&t>=0&&t<=i.levels.SILENT))throw"log.setLevel() called with invalid level: "+t;if(o=t,!1!==n&&function(e){var t=(r[e]||"silent").toUpperCase();if("undefined"!=typeof window){try{return void(window.localStorage[a]=t)}catch(e){}try{window.document.cookie=encodeURIComponent(a)+"="+t+";"}catch(e){}}}(t),s.call(i,t,e),"undefined"==typeof console&&t<i.levels.SILENT)return"No console available for logging"},i.setDefaultLevel=function(e){u()||i.setLevel(e,!1)},i.enableAll=function(e){i.setLevel(i.levels.TRACE,e)},i.disableAll=function(e){i.setLevel(i.levels.SILENT,e)};var l=u();null==l&&(l=null==t?"WARN":t),i.setLevel(l,!1)}var l=new u,d={};l.getLogger=function(e){if("string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=d[e];return t||(t=d[e]=new u(e,l.getLevel(),l.methodFactory)),t};var h="undefined"!=typeof window?window.log:void 0;return l.noConflict=function(){return"undefined"!=typeof window&&window.log===l&&(window.log=h),l},l.getLoggers=function(){return d},l})?n.call(t,r,t,e):n)||(e.exports=o)}()},function(e,t,r){"use strict";var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.User=s;var o=n(r(6)),i=r(10);function s(e){this.userId=e,this.presence="offline",this.presenceStatusMsg=null,this._unstable_statusMessage="",this.displayName=e,this.rawDisplayName=e,this.avatarUrl=null,this.lastActiveAgo=0,this.lastPresenceTs=0,this.currentlyActive=!1,this.events={presence:null,profile:null},this._updateModifiedTime()}o.inherits(s,i.EventEmitter),s.prototype.setPresenceEvent=function(e){if("m.presence"!==e.getType())return;const t=null===this.events.presence;this.events.presence=e;const r=[];(e.getContent().presence!==this.presence||t)&&r.push("User.presence"),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&r.push("User.avatarUrl"),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&r.push("User.displayName"),void 0!==e.getContent().currently_active&&e.getContent().currently_active!==this.currentlyActive&&r.push("User.currentlyActive"),this.presence=e.getContent().presence,r.push("User.lastPresenceTs"),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this._updateModifiedTime();for(let t=0;t<r.length;t++)this.emit(r[t],e,this)},s.prototype.setDisplayName=function(e){const t=this.displayName;this.displayName=e,e!==t&&this._updateModifiedTime()},s.prototype.setRawDisplayName=function(e){this.rawDisplayName=e},s.prototype.setAvatarUrl=function(e){const t=this.avatarUrl;this.avatarUrl=e,e!==t&&this._updateModifiedTime()},s.prototype._updateModifiedTime=function(){this._modified=Date.now()},s.prototype.getLastModifiedTime=function(){return this._modified},s.prototype.getLastActiveTs=function(){return this.lastPresenceTs-this.lastActiveAgo},s.prototype._unstable_updateStatusMessage=function(e){e.getContent()?this._unstable_statusMessage=e.getContent().status:this._unstable_statusMessage="",this._updateModifiedTime(),this.emit("User._unstable_statusMessage",this)}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.newVerificationError=o,t.errorFactory=i,t.errorFromEvent=function(e){const t=e.getContent();if(t){const{code:e,reason:r}=t;return{code:e,reason:r}}return{code:"Unknown error",reason:"m.unknown"}},t.newInvalidMessageError=t.newUserMismatchError=t.newKeyMismatchError=t.newUnexpectedMessageError=t.newUnknownMethodError=t.newUnknownTransactionError=t.newTimeoutError=t.newUserCancelledError=void 0;var n=r(18);function o(e,t,r){const o=Object.assign({},{code:e,reason:t},r);return new n.MatrixEvent({type:"m.key.verification.cancel",content:o})}function i(e,t){return function(r){return o(e,t,r)}}const s=i("m.user","Cancelled by user");t.newUserCancelledError=s;const a=i("m.timeout","Timed out");t.newTimeoutError=a;const c=i("m.unknown_transaction","Unknown transaction");t.newUnknownTransactionError=c;const u=i("m.unknown_method","Unknown method");t.newUnknownMethodError=u;const l=i("m.unexpected_message","Unexpected message");t.newUnexpectedMessageError=l;const d=i("m.key_mismatch","Key mismatch");t.newKeyMismatchError=d;const h=i("m.user_error","User mismatch");t.newUserMismatchError=h;const p=i("m.invalid_message","Invalid message");t.newInvalidMessageError=p},function(e,t,r){"use strict";(function(e){var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixHttpApi=c,t.retryNetworkOperation=async function(e,t){let r=0,n=null;for(;r<e;)try{if(r>0){const e=1e3*Math.pow(2,r);console.log(`network operation failed ${r} times, retrying in ${e}ms...`),await new Promise(t=>setTimeout(t,e))}return await t()}catch(e){if(!(e instanceof d))throw e;r+=1,n=e}throw n},t.AbortError=t.ConnectionError=t.MatrixError=t.PREFIX_MEDIA_R0=t.PREFIX_IDENTITY_V2=t.PREFIX_IDENTITY_V1=t.PREFIX_UNSTABLE=t.PREFIX_R0=void 0;var o=r(101),i=n(r(6)),s=r(3),a=n(r(102));t.PREFIX_R0="/_matrix/client/r0";t.PREFIX_UNSTABLE="/_matrix/client/unstable";t.PREFIX_IDENTITY_V1="/_matrix/identity/api/v1";t.PREFIX_IDENTITY_V2="/_matrix/identity/v2";function c(e,t){i.checkObjectHasKeys(t,["baseUrl","request","prefix"]),t.onlyData=t.onlyData||!1,this.event_emitter=e,this.opts=t,this.useAuthorizationHeader=Boolean(t.useAuthorizationHeader),this.uploads=[]}t.PREFIX_MEDIA_R0="/_matrix/media/r0",c.prototype={setIdBaseUrl:function(e){this.opts.idBaseUrl=e},getContentUri:function(){const e={access_token:this.opts.accessToken};return{base:this.opts.baseUrl,path:"/_matrix/media/r0/upload",params:e}},uploadContent:function(t,r){i.isFunction(r)?r={callback:r}:void 0===r&&(r={});const n=!1!==r.includeFilename,o=r.type||t.type||"application/octet-stream",c=r.name||t.name;let l=t;l.stream&&"function"!=typeof l.stream&&(s.logger.warn("Using `file.stream` as the content to upload. Future versions of the js-sdk will change this to expect `file` to be the content directly."),l=l.stream);let d=r.rawResponse;void 0===d&&(e.XMLHttpRequest?d=!1:(s.logger.warn("Returning the raw JSON from uploadContent(). Future versions of the js-sdk will change this default, to return the parsed object. Set opts.rawResponse=false to change this behaviour now."),d=!0));let p=r.onlyContentUri;d||void 0!==p||(e.XMLHttpRequest?(s.logger.warn("Returning only the content-uri from uploadContent(). Future versions of the js-sdk will change this default, to return the whole response object. Set opts.onlyContentUri=false to change this behaviour now."),p=!0):p=!1);const f={loaded:0,total:0};let m,g=null;if(d||(g=function(e){let t=JSON.parse(e);if(p&&(t=t.content_uri,void 0===t))throw Error("Bad response");return t}),e.XMLHttpRequest){const t=i.defer(),s=new e.XMLHttpRequest;f.xhr=s;const d=u(t,r.callback,this.opts.onlyData),p=function(){s.abort(),d(new Error("Timeout"))};s.timeout_timer=a.setTimeout(p,3e4),s.onreadystatechange=function(){switch(s.readyState){case e.XMLHttpRequest.DONE:var t;a.clearTimeout(s.timeout_timer);try{if(0===s.status)throw new h;if(!s.responseText)throw new Error("No response body.");t=s.responseText,g&&(t=g(t))}catch(e){return e.http_status=s.status,void d(e)}d(void 0,s,t)}},s.upload.addEventListener("progress",(function(e){a.clearTimeout(s.timeout_timer),f.loaded=e.loaded,f.total=e.total,s.timeout_timer=a.setTimeout(p,3e4),r.progressHandler&&r.progressHandler({loaded:e.loaded,total:e.total})}));let v=this.opts.baseUrl+"/_matrix/media/r0/upload";const y=[];n&&c&&y.push("filename="+encodeURIComponent(c)),this.useAuthorizationHeader||y.push("access_token="+encodeURIComponent(this.opts.accessToken)),y.length>0&&(v+="?"+y.join("&")),s.open("POST",v),this.useAuthorizationHeader&&s.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),s.setRequestHeader("Content-Type",o),s.send(l),m=t.promise,m.abort=s.abort.bind(s)}else{const e={};n&&c&&(e.filename=c),m=this.authedRequest(r.callback,"POST","/upload",e,l,{prefix:"/_matrix/media/r0",headers:{"Content-Type":o},json:!1,bodyParser:g})}const v=this,y=m.finally((function(){for(let e=0;e<v.uploads.length;++e)if(v.uploads[e]===f)return void v.uploads.splice(e,1)}));return y.abort=m.abort,f.promise=y,this.uploads.push(f),y},cancelUpload:function(e){return!!e.abort&&(e.abort(),!0)},getCurrentUploads:function(){return this.uploads},idServerRequest:function(e,t,r,n,o,s){if(!this.opts.idBaseUrl)throw new Error("No Identity Server base URL set");const a=this.opts.idBaseUrl+o+r;if(void 0!==e&&!i.isFunction(e))throw Error("Expected callback to be a function but got "+typeof e);const c={uri:a,method:t,withCredentials:!1,json:!0,_matrix_opts:this.opts,headers:{}};"GET"===t?c.qs=n:"object"==typeof n&&(c.json=n),s&&(c.headers.Authorization="Bearer "+s);const l=i.defer();return this.opts.request(c,u(l,e,this.opts.onlyData)),l.promise},authedRequest:function(e,t,r,n,o,i){n||(n={}),this.useAuthorizationHeader?(isFinite(i)&&(i={localTimeoutMs:i}),i||(i={}),i.headers||(i.headers={}),i.headers.Authorization||(i.headers.Authorization="Bearer "+this.opts.accessToken),n.access_token&&delete n.access_token):n.access_token||(n.access_token=this.opts.accessToken);const s=this.request(e,t,r,n,o,i),a=this;return s.catch((function(e){"M_UNKNOWN_TOKEN"==e.errcode?a.event_emitter.emit("Session.logged_out",e):"M_CONSENT_NOT_GIVEN"==e.errcode&&a.event_emitter.emit("no_consent",e.message,e.data.consent_uri)})),s},request:function(e,t,r,n,o,i){const s=void 0!==(i=i||{}).prefix?i.prefix:this.opts.prefix,a=this.opts.baseUrl+s+r;return this.requestOtherUrl(e,t,a,n,o,i)},requestOtherUrl:function(e,t,r,n,o,i){return null==i?i={}:isFinite(i)&&(i={localTimeoutMs:i}),this._request(e,t,r,n,o,i)},getUrl:function(e,t,r){let n="";return t&&(n="?"+i.encodeParams(t)),this.opts.baseUrl+r+e+n},_request:function(e,t,r,n,o,s){if(void 0!==e&&!i.isFunction(e))throw Error("Expected callback to be a function but got "+typeof e);s=s||{};const c=this;if(this.opts.extraParams)for(const e in this.opts.extraParams)this.opts.extraParams.hasOwnProperty(e)&&(n[e]=this.opts.extraParams[e]);const d=i.extend({},s.headers||{}),h=void 0===s.json||s.json;let p=s.bodyParser;h&&(o&&(o=JSON.stringify(o),d["content-type"]="application/json"),d.accept||(d.accept="application/json"),void 0===p&&(p=function(e){return JSON.parse(e)}));const f=i.defer();let m,g,v=!1;const y=s.localTimeoutMs||this.opts.localTimeoutMs,_=()=>{y&&(m&&a.clearTimeout(m),m=a.setTimeout((function(){v=!0,g&&g.abort&&g.abort(),f.reject(new l({error:"Locally timed out waiting for a response",errcode:"ORG.MATRIX.JSSDK_TIMEOUT",timeout:y}))}),y))};_();const b=f.promise;try{g=this.opts.request({uri:r,method:t,withCredentials:!1,qs:n,qsStringifyOptions:s.qsStringifyOptions,useQuerystring:!0,body:o,json:!1,timeout:y,headers:d||{},_matrix_opts:this.opts},(function(t,r,n){if(y&&(a.clearTimeout(m),v))return;u(f,e,c.opts.onlyData,p)(t,r,n)})),g&&("onprogress"in g&&(g.onprogress=e=>{_()}),g.abort&&(b.abort=g.abort.bind(g)))}catch(t){f.reject(t),e&&e(t)}return b}};const u=function(e,t,r,n){return t=t||function(){},function(i,s,a){if(i){"AbortError"===i.name||"aborted"===i||i instanceof l||(i=new d("request failed",i))}if(!i)try{s.statusCode>=400?i=function(e,t){const r=e.statusCode,n=function(e){let t;e.getResponseHeader?t=e.getResponseHeader("Content-Type"):e.headers&&(t=e.headers["content-type"]||null);if(!t)return null;try{return(0,o.parse)(t)}catch(e){throw new Error(`Error parsing Content-Type '${t}': ${e}`)}}(e);let i;if(n)if("application/json"===n.type){const e="object"==typeof t?t:JSON.parse(t);i=new l(e)}else"text/plain"===n.type&&(i=new Error(`Server returned ${r} error: ${t}`));i||(i=new Error(`Server returned ${r} error`));return i.httpStatus=r,i}(s,a):n&&(a=n(a))}catch(e){i=new Error("Error parsing server response: "+e)}if(i)e.reject(i),t(i);else{const n={code:s.statusCode,headers:s.headers,data:a};e.resolve(r?a:n),t(null,r?a:n)}}};class l extends Error{constructor(e){super("MatrixError: "+(e=e||{}).errcode),this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.message=e.error||"Unknown message",this.data=e}}t.MatrixError=l;class d extends Error{constructor(e,t){super(e+(t?": "+t.message:"")),this._cause=t}get name(){return"ConnectionError"}get cause(){return this._cause}}t.ConnectionError=d;class h extends Error{constructor(){super("Operation aborted")}get name(){return"AbortError"}}t.AbortError=h}).call(this,r(8))},function(e,t,r){"use strict";var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.getHttpUriForMxc=function(e,t,r,n,i,s){if("string"!=typeof t||!t)return"";if(0!==t.indexOf("mxc://"))return s?t:"";let a=t.slice(6),c="/_matrix/media/r0/download/";const u={};r&&(u.width=Math.round(r));n&&(u.height=Math.round(n));i&&(u.method=i);o.keys(u).length>0&&(c="/_matrix/media/r0/thumbnail/");const l=a.indexOf("#");let d="";l>=0&&(d=a.substr(l),a=a.substr(0,l));return e+c+a+(0===o.keys(u).length?"":"?"+o.encodeParams(u))+d},t.getIdenticonUri=function(e,t,r,n){if(!t)return null;r||(r=96);n||(n=96);const i={width:r,height:n},s=o.encodeUri("/_matrix/media/unstable/identicon/$ident",{$ident:t});return e+s+(0===o.keys(i).length?"":"?"+o.encodeParams(i))};var o=n(r(6))},function(e,t,r){"use strict";function n(e,t){const r=`Store is invalid because ${e}, please stop the client, delete all data and start the client again`,n=Reflect.construct(Error,[r]);return Reflect.setPrototypeOf(n,Reflect.getPrototypeOf(this)),n.reason=e,n.value=t,n}function o(e){const t=`Crypto store is invalid because ${e}, please stop the client, delete all data and start the client again`,r=Reflect.construct(Error,[t]);return Reflect.setPrototypeOf(r,Reflect.getPrototypeOf(this)),r.reason=e,r.name="InvalidCryptoStoreError",r}Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidStoreError=n,t.InvalidCryptoStoreError=o,t.KeySignatureUploadError=void 0,n.TOGGLED_LAZY_LOADING="TOGGLED_LAZY_LOADING",n.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Reflect.setPrototypeOf(n,Error),o.TOO_NEW="TOO_NEW",o.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Reflect.setPrototypeOf(o,Error);class i extends Error{constructor(e,t){super(e),this.value=t}}t.KeySignatureUploadError=i},function(e,t,r){"use strict";function n(e){Object.defineProperty(this,"deviceId",{enumerable:!0,value:e}),this.algorithms=[],this.keys={},this.verified=o.UNVERIFIED,this.known=!1,this.unsigned={},this.signatures={}}Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceInfo=n,n.fromStorage=function(e,t){const r=new n(t);for(const t in e)e.hasOwnProperty(t)&&(r[t]=e[t]);return r},n.prototype.toStorage=function(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned,signatures:this.signatures}},n.prototype.getFingerprint=function(){return this.keys["ed25519:"+this.deviceId]},n.prototype.getIdentityKey=function(){return this.keys["curve25519:"+this.deviceId]},n.prototype.getDisplayName=function(){return this.unsigned.device_display_name||null},n.prototype.isBlocked=function(){return this.verified==o.BLOCKED},n.prototype.isVerified=function(){return this.verified==o.VERIFIED},n.prototype.isUnverified=function(){return this.verified==o.UNVERIFIED},n.prototype.isKnown=function(){return 1==this.known},n.DeviceVerification={VERIFIED:1,UNVERIFIED:0,BLOCKED:-1};const o=n.DeviceVerification},function(e,t,r){"use strict";(function(e,n){Object.defineProperty(t,"__esModule",{value:!0}),t.createCryptoStoreCacheCallbacks=function(e,t){return{getCrossSigningKeyCache:async function(r,i){const s=await new Promise(t=>e.doTxn("readonly",[a.IndexedDBCryptoStore.STORE_ACCOUNT],n=>{e.getSecretStorePrivateKey(n,t,r)}));if(s&&s.ciphertext){const e=n.from(t._pickleKey),i=await(0,c.decryptAES)(s,e,r);return(0,o.decodeBase64)(i)}return s},storeCrossSigningKeyCache:async function(r,i){if(!(i instanceof Uint8Array))throw new Error("storeCrossSigningKeyCache expects Uint8Array, got "+i);const s=n.from(t._pickleKey);return i=await(0,c.encryptAES)((0,o.encodeBase64)(i),s,r),e.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_ACCOUNT],t=>{e.storeSecretStorePrivateKey(t,r,i)})}}},t.DeviceTrustLevel=t.UserTrustLevel=t.CrossSigningLevel=t.CrossSigningInfo=void 0;var o=r(19),i=r(10),s=r(3),a=r(23),c=r(43);function u(e){return Object.values(e.keys)[0]}class l extends i.EventEmitter{constructor(e,t,r){super(),Object.defineProperty(this,"userId",{enumerable:!0,value:e}),this._callbacks=t||{},this._cacheCallbacks=r||{},this.keys={},this.firstUse=!0,this.crossSigningVerifiedBefore=!1}async getCrossSigningKey(t,r){const n=["self_signing","user_signing"].indexOf(t)>=0;if(!this._callbacks.getCrossSigningKey)throw new Error("No getCrossSigningKey callback supplied");function o(t){if(!t)return;const n=new e.Olm.PkSigning,o=n.init_with_seed(t);if(o===r)return[o,n];n.free()}let i;void 0===r&&(r=this.getId(t)),this._cacheCallbacks.getCrossSigningKeyCache&&n&&(i=await this._cacheCallbacks.getCrossSigningKeyCache(t,r));const s=o(i);if(s)return s;i=await this._callbacks.getCrossSigningKey(t,r);const a=o(i);if(a)return this._cacheCallbacks.storeCrossSigningKeyCache&&n&&await this._cacheCallbacks.storeCrossSigningKeyCache(t,i),a;if(!i)throw new Error("getCrossSigningKey callback for "+t+" returned falsey");throw new Error("Key type "+t+" from getCrossSigningKey callback did not match")}static fromStorage(e,t){const r=new l(t);for(const t in e)e.hasOwnProperty(t)&&(r[t]=e[t]);return r}toStorage(){return{keys:this.keys,firstUse:this.firstUse,crossSigningVerifiedBefore:this.crossSigningVerifiedBefore}}async isStoredInSecretStorage(e){const t=await e.isStored("m.cross_signing.master",!1)||{};function r(e){for(const r of Object.keys(t))e[r]||delete t[r]}for(const t of["self_signing","user_signing"])r(await e.isStored("m.cross_signing."+t,!1)||{});return Object.keys(t).length?t:null}static async storeInSecretStorage(e,t){for(const[r,n]of e){const e=(0,o.encodeBase64)(n);await t.store("m.cross_signing."+r,e)}}static async getFromSecretStorage(e,t){const r=await t.get("m.cross_signing."+e);return(0,o.decodeBase64)(r)}getId(e){if(e=e||"master",!this.keys[e])return null;return u(this.keys[e])}async resetKeys(t){if(!this._callbacks.saveCrossSigningKeys)throw new Error("No saveCrossSigningKeys callback supplied");if(void 0===t||t&d.MASTER||!this.keys.master)t=d.MASTER|d.USER_SIGNING|d.SELF_SIGNING;else if(0===t)return;const r={},n={};let i,s;try{if(t&d.MASTER?(i=new e.Olm.PkSigning,r.master=i.generate_seed(),s=i.init_with_seed(r.master),n.master={user_id:this.userId,usage:["master"],keys:{["ed25519:"+s]:s}}):[s,i]=await this.getCrossSigningKey("master"),t&d.SELF_SIGNING){const t=new e.Olm.PkSigning;try{r.self_signing=t.generate_seed();const e=t.init_with_seed(r.self_signing);n.self_signing={user_id:this.userId,usage:["self_signing"],keys:{["ed25519:"+e]:e}},(0,o.pkSign)(n.self_signing,i,this.userId,s)}finally{t.free()}}if(t&d.USER_SIGNING){const t=new e.Olm.PkSigning;try{r.user_signing=t.generate_seed();const e=t.init_with_seed(r.user_signing);n.user_signing={user_id:this.userId,usage:["user_signing"],keys:{["ed25519:"+e]:e}},(0,o.pkSign)(n.user_signing,i,this.userId,s)}finally{t.free()}}Object.assign(this.keys,n),this._callbacks.saveCrossSigningKeys(r)}finally{i&&i.free()}}clearKeys(){this.keys={}}setKeys(e){const t={};if(e.master){if(e.master.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in master key from "+this.userId;throw s.logger.error(t),new Error(t)}this.keys.master?u(e.master)!==this.getId()&&(this.firstUse=!1):this.firstUse=!0,t.master=e.master}else{if(!this.keys.master)throw new Error("Tried to set cross-signing keys without a master key");t.master=this.keys.master}const r=u(t.master);if(e.user_signing){if(e.user_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in user_signing key from "+this.userId;throw s.logger.error(t),new Error(t)}try{(0,o.pkVerify)(e.user_signing,r,this.userId)}catch(e){throw s.logger.error("invalid signature on user-signing key"),e}}if(e.self_signing){if(e.self_signing.user_id!==this.userId){const t="Mismatched user ID "+e.master.user_id+" in self_signing key from "+this.userId;throw s.logger.error(t),new Error(t)}try{(0,o.pkVerify)(e.self_signing,r,this.userId)}catch(e){throw s.logger.error("invalid signature on self-signing key"),e}}e.master&&(this.keys.master=e.master,this.keys.self_signing=null,this.keys.user_signing=null),e.self_signing&&(this.keys.self_signing=e.self_signing),e.user_signing&&(this.keys.user_signing=e.user_signing)}updateCrossSigningVerifiedBefore(e){!this.crossSigningVerifiedBefore&&e&&(this.crossSigningVerifiedBefore=!0)}async signObject(e,t){if(!this.keys[t])throw new Error("Attempted to sign with "+t+" key but no such key present");const[r,n]=await this.getCrossSigningKey(t);try{return(0,o.pkSign)(e,n,this.userId,r),e}finally{n.free()}}async signUser(e){if(this.keys.user_signing)return this.signObject(e.keys.master,"user_signing");s.logger.info("No user signing key: not signing user")}async signDevice(e,t){if(e!==this.userId)throw new Error(`Trying to sign ${e}'s device; can only sign our own device`);if(this.keys.self_signing)return this.signObject({algorithms:t.algorithms,keys:t.keys,device_id:t.deviceId,user_id:e},"self_signing");s.logger.info("No self signing key: not signing device")}checkUserTrust(e){if(this.userId===e.userId&&this.getId()&&this.getId()===e.getId()&&this.getId("self_signing")&&this.getId("self_signing")===e.getId("self_signing"))return new h(!0,!0,this.firstUse);if(!this.keys.user_signing)return new h(!1,!1,e.firstUse);let t;const r=e.keys.master,n=this.getId("user_signing");try{(0,o.pkVerify)(r,n,this.userId),t=!0}catch(e){t=!1}return new h(t,e.crossSigningVerifiedBefore,e.firstUse)}checkDeviceTrust(e,t,r,n){const i=this.checkUserTrust(e),s=e.keys.self_signing;if(!s)return new p(!1,!1,r,n);const a=function(e,t){return{algorithms:e.algorithms,keys:e.keys,device_id:e.deviceId,user_id:t,signatures:e.signatures}}(t,e.userId);try{return(0,o.pkVerify)(s,e.getId(),e.userId),(0,o.pkVerify)(a,u(s),e.userId),p.fromUserTrustLevel(i,r,n)}catch(e){return new p(!1,!1,r,n)}}getCacheCallbacks(){return this._cacheCallbacks}}t.CrossSigningInfo=l;const d={MASTER:4,USER_SIGNING:2,SELF_SIGNING:1};t.CrossSigningLevel=d;class h{constructor(e,t,r){this._crossSigningVerified=e,this._crossSigningVerifiedBefore=t,this._tofu=r}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this._crossSigningVerified}wasCrossSigningVerified(){return this._crossSigningVerifiedBefore}isTofu(){return this._tofu}}t.UserTrustLevel=h;class p{constructor(e,t,r,n){this._crossSigningVerified=e,this._tofu=t,this._localVerified=r,this._trustCrossSignedDevices=n}static fromUserTrustLevel(e,t,r){return new p(e._crossSigningVerified,e._tofu,t,r)}isVerified(){return Boolean(this.isLocallyVerified()||this._trustCrossSignedDevices&&this.isCrossSigningVerified())}isCrossSigningVerified(){return this._crossSigningVerified}isLocallyVerified(){return this._localVerified}isTofu(){return this._tofu}}t.DeviceTrustLevel=p}).call(this,r(8),r(22).Buffer)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.randomString=function(e){let t="";const r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let n=0;n<e;++n)t+=r.charAt(Math.floor(Math.random()*r.length));return t}},function(e,t,r){"use strict";var n=r(5),o=r(14);Object.defineProperty(t,"__esModule",{value:!0}),t.MemoryCryptoStore=void 0;var i=o(r(2)),s=r(3),a=n(r(6));function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function u(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(Object(r),!0).forEach((function(t){(0,i.default)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}t.MemoryCryptoStore=class{constructor(){this._outgoingRoomKeyRequests=[],this._account=null,this._crossSigningKeys=null,this._privateKeys={},this._backupKeys={},this._sessions={},this._sessionProblems={},this._notifiedErrorDevices={},this._inboundGroupSessions={},this._inboundGroupSessionsWithheld={},this._deviceData=null,this._rooms={},this._sessionsNeedingBackup={}}async startup(){return this}deleteAllData(){return Promise.resolve()}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return a.promiseTry(()=>{const r=this._getOutgoingRoomKeyRequest(t);return r?(s.logger.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),r):(s.logger.log(`enqueueing key request for ${t.room_id} / `+t.session_id),this._outgoingRoomKeyRequests.push(e),e)})}getOutgoingRoomKeyRequest(e){return Promise.resolve(this._getOutgoingRoomKeyRequest(e))}_getOutgoingRoomKeyRequest(e){for(const t of this._outgoingRoomKeyRequests)if(a.deepCompare(t.requestBody,e))return t;return null}getOutgoingRoomKeyRequestByState(e){for(const t of this._outgoingRoomKeyRequests)for(const r of e)if(t.state===r)return Promise.resolve(t);return Promise.resolve(null)}getAllOutgoingRoomKeyRequestsByState(e){return Promise.resolve(this._outgoingRoomKeyRequests.filter(t=>t.state==e))}getOutgoingRoomKeyRequestsByTarget(e,t,r){const n=[];for(const o of this._outgoingRoomKeyRequests)for(const i of r)o.state===i&&o.recipients.includes({userId:e,deviceId:t})&&n.push(o);return Promise.resolve(n)}updateOutgoingRoomKeyRequest(e,t,r){for(const n of this._outgoingRoomKeyRequests)if(n.requestId===e)return n.state!=t?(s.logger.warn(`Cannot update room key request from ${t} as it was already updated to `+n.state),Promise.resolve(null)):(Object.assign(n,r),Promise.resolve(n));return Promise.resolve(null)}deleteOutgoingRoomKeyRequest(e,t){for(let r=0;r<this._outgoingRoomKeyRequests.length;r++){const n=this._outgoingRoomKeyRequests[r];if(n.requestId===e)return n.state!=t?(s.logger.warn(`Cannot delete room key request in state ${n.state} (expected ${t})`),Promise.resolve(null)):(this._outgoingRoomKeyRequests.splice(r,1),Promise.resolve(n))}return Promise.resolve(null)}getAccount(e,t){t(this._account)}storeAccount(e,t){this._account=t}getCrossSigningKeys(e,t){t(this._crossSigningKeys)}getSecretStorePrivateKey(e,t,r){return t(this._privateKeys[r]||null)}storeCrossSigningKeys(e,t){this._crossSigningKeys=t}storeSecretStorePrivateKey(e,t,r){this._privateKeys[t]=r}countEndToEndSessions(e,t){return Object.keys(this._sessions).length}getEndToEndSession(e,t,r,n){n((this._sessions[e]||{})[t]||null)}getEndToEndSessions(e,t,r){r(this._sessions[e]||{})}getAllEndToEndSessions(e,t){Object.entries(this._sessions).forEach(([e,r])=>{Object.entries(r).forEach(([r,n])=>{t(u(u({},n),{},{deviceKey:e,sessionId:r}))})})}storeEndToEndSession(e,t,r,n){let o=this._sessions[e];void 0===o&&(o={},this._sessions[e]=o),o[t]=r}async storeEndToEndSessionProblem(e,t,r){const n=this._sessionProblems[e]=this._sessionProblems[e]||[];n.push({type:t,fixed:r,time:Date.now()}),n.sort((e,t)=>e.time-t.time)}async getEndToEndSessionProblem(e,t){const r=this._sessionProblems[e]||[];if(!r.length)return null;const n=r[r.length-1];for(const e of r)if(e.time>t)return Object.assign({},e,{fixed:n.fixed});return n.fixed?null:n}async filterOutNotifiedErrorDevices(e){const t=this._notifiedErrorDevices,r=[];for(const n of e){const{userId:e,deviceInfo:o}=n;e in t?o.deviceId in t[e]||(r.push(n),t[e][o.deviceId]=!0):(r.push(n),t[e]={[o.deviceId]:!0})}return r}getEndToEndInboundGroupSession(e,t,r,n){const o=e+"/"+t;n(this._inboundGroupSessions[o]||null,this._inboundGroupSessionsWithheld[o]||null)}getAllEndToEndInboundGroupSessions(e,t){for(const e of Object.keys(this._inboundGroupSessions))t({senderKey:e.substr(0,43),sessionId:e.substr(44),sessionData:this._inboundGroupSessions[e]});t(null)}addEndToEndInboundGroupSession(e,t,r,n){const o=e+"/"+t;void 0===this._inboundGroupSessions[o]&&(this._inboundGroupSessions[o]=r)}storeEndToEndInboundGroupSession(e,t,r,n){this._inboundGroupSessions[e+"/"+t]=r}storeEndToEndInboundGroupSessionWithheld(e,t,r,n){const o=e+"/"+t;this._inboundGroupSessionsWithheld[o]=r}getEndToEndDeviceData(e,t){t(this._deviceData)}storeEndToEndDeviceData(e,t){this._deviceData=e}storeEndToEndRoom(e,t,r){this._rooms[e]=t}getEndToEndRooms(e,t){t(this._rooms)}getSessionsNeedingBackup(e){const t=[];for(const r in this._sessionsNeedingBackup)if(this._inboundGroupSessions[r]&&(t.push({senderKey:r.substr(0,43),sessionId:r.substr(44),sessionData:this._inboundGroupSessions[r]}),e&&r.length>=e))break;return Promise.resolve(t)}countSessionsNeedingBackup(){return Promise.resolve(Object.keys(this._sessionsNeedingBackup).length)}unmarkSessionsNeedingBackup(e){for(const t of e){const e=t.senderKey+"/"+t.sessionId;delete this._sessionsNeedingBackup[e]}return Promise.resolve()}markSessionsNeedingBackup(e){for(const t of e){const e=t.senderKey+"/"+t.sessionId;this._sessionsNeedingBackup[e]=!0}return Promise.resolve()}doTxn(e,t,r){return Promise.resolve(r(null))}}},function(e,t,r){"use strict";var n=r(95),o=r(96);function i(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}t.parse=_,t.resolve=function(e,t){return _(e,!1,!0).resolve(t)},t.resolveObject=function(e,t){return e?_(e,!1,!0).resolveObject(t):t},t.format=function(e){o.isString(e)&&(e=_(e));return e instanceof i?e.format():i.prototype.format.call(e)},t.Url=i;var s=/^([a-z0-9.+-]+:)/i,a=/:[0-9]*$/,c=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,u=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),l=["'"].concat(u),d=["%","/","?",";","#"].concat(l),h=["/","?","#"],p=/^[+a-z0-9A-Z_-]{0,63}$/,f=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,m={javascript:!0,"javascript:":!0},g={javascript:!0,"javascript:":!0},v={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},y=r(97);function _(e,t,r){if(e&&o.isObject(e)&&e instanceof i)return e;var n=new i;return n.parse(e,t,r),n}i.prototype.parse=function(e,t,r){if(!o.isString(e))throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var i=e.indexOf("?"),a=-1!==i&&i<e.indexOf("#")?"?":"#",u=e.split(a);u[0]=u[0].replace(/\\/g,"/");var _=e=u.join(a);if(_=_.trim(),!r&&1===e.split("#").length){var b=c.exec(_);if(b)return this.path=_,this.href=_,this.pathname=b[1],b[2]?(this.search=b[2],this.query=t?y.parse(this.search.substr(1)):this.search.substr(1)):t&&(this.search="",this.query={}),this}var E=s.exec(_);if(E){var S=(E=E[0]).toLowerCase();this.protocol=S,_=_.substr(E.length)}if(r||E||_.match(/^\/\/[^@\/]+@[^@\/]+/)){var w="//"===_.substr(0,2);!w||E&&g[E]||(_=_.substr(2),this.slashes=!0)}if(!g[E]&&(w||E&&!v[E])){for(var R,I,k=-1,P=0;P<h.length;P++){-1!==(T=_.indexOf(h[P]))&&(-1===k||T<k)&&(k=T)}-1!==(I=-1===k?_.lastIndexOf("@"):_.lastIndexOf("@",k))&&(R=_.slice(0,I),_=_.slice(I+1),this.auth=decodeURIComponent(R)),k=-1;for(P=0;P<d.length;P++){var T;-1!==(T=_.indexOf(d[P]))&&(-1===k||T<k)&&(k=T)}-1===k&&(k=_.length),this.host=_.slice(0,k),_=_.slice(k),this.parseHost(),this.hostname=this.hostname||"";var O="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!O)for(var A=this.hostname.split(/\./),D=(P=0,A.length);P<D;P++){var C=A[P];if(C&&!C.match(p)){for(var x="",M=0,j=C.length;M<j;M++)C.charCodeAt(M)>127?x+="x":x+=C[M];if(!x.match(p)){var U=A.slice(0,P),N=A.slice(P+1),F=C.match(f);F&&(U.push(F[1]),N.unshift(F[2])),N.length&&(_="/"+N.join(".")+_),this.hostname=U.join(".");break}}}this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),O||(this.hostname=n.toASCII(this.hostname));var L=this.port?":"+this.port:"",K=this.hostname||"";this.host=K+L,this.href+=this.host,O&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==_[0]&&(_="/"+_))}if(!m[S])for(P=0,D=l.length;P<D;P++){var B=l[P];if(-1!==_.indexOf(B)){var q=encodeURIComponent(B);q===B&&(q=escape(B)),_=_.split(B).join(q)}}var $=_.indexOf("#");-1!==$&&(this.hash=_.substr($),_=_.slice(0,$));var V=_.indexOf("?");if(-1!==V?(this.search=_.substr(V),this.query=_.substr(V+1),t&&(this.query=y.parse(this.query)),_=_.slice(0,V)):t&&(this.search="",this.query={}),_&&(this.pathname=_),v[S]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){L=this.pathname||"";var G=this.search||"";this.path=L+G}return this.href=this.format(),this},i.prototype.format=function(){var e=this.auth||"";e&&(e=(e=encodeURIComponent(e)).replace(/%3A/i,":"),e+="@");var t=this.protocol||"",r=this.pathname||"",n=this.hash||"",i=!1,s="";this.host?i=e+this.host:this.hostname&&(i=e+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(i+=":"+this.port)),this.query&&o.isObject(this.query)&&Object.keys(this.query).length&&(s=y.stringify(this.query));var a=this.search||s&&"?"+s||"";return t&&":"!==t.substr(-1)&&(t+=":"),this.slashes||(!t||v[t])&&!1!==i?(i="//"+(i||""),r&&"/"!==r.charAt(0)&&(r="/"+r)):i||(i=""),n&&"#"!==n.charAt(0)&&(n="#"+n),a&&"?"!==a.charAt(0)&&(a="?"+a),t+i+(r=r.replace(/[?#]/g,(function(e){return encodeURIComponent(e)})))+(a=a.replace("#","%23"))+n},i.prototype.resolve=function(e){return this.resolveObject(_(e,!1,!0)).format()},i.prototype.resolveObject=function(e){if(o.isString(e)){var t=new i;t.parse(e,!1,!0),e=t}for(var r=new i,n=Object.keys(this),s=0;s<n.length;s++){var a=n[s];r[a]=this[a]}if(r.hash=e.hash,""===e.href)return r.href=r.format(),r;if(e.slashes&&!e.protocol){for(var c=Object.keys(e),u=0;u<c.length;u++){var l=c[u];"protocol"!==l&&(r[l]=e[l])}return v[r.protocol]&&r.hostname&&!r.pathname&&(r.path=r.pathname="/"),r.href=r.format(),r}if(e.protocol&&e.protocol!==r.protocol){if(!v[e.protocol]){for(var d=Object.keys(e),h=0;h<d.length;h++){var p=d[h];r[p]=e[p]}return r.href=r.format(),r}if(r.protocol=e.protocol,e.host||g[e.protocol])r.pathname=e.pathname;else{for(var f=(e.pathname||"").split("/");f.length&&!(e.host=f.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==f[0]&&f.unshift(""),f.length<2&&f.unshift(""),r.pathname=f.join("/")}if(r.search=e.search,r.query=e.query,r.host=e.host||"",r.auth=e.auth,r.hostname=e.hostname||e.host,r.port=e.port,r.pathname||r.search){var m=r.pathname||"",y=r.search||"";r.path=m+y}return r.slashes=r.slashes||e.slashes,r.href=r.format(),r}var _=r.pathname&&"/"===r.pathname.charAt(0),b=e.host||e.pathname&&"/"===e.pathname.charAt(0),E=b||_||r.host&&e.pathname,S=E,w=r.pathname&&r.pathname.split("/")||[],R=(f=e.pathname&&e.pathname.split("/")||[],r.protocol&&!v[r.protocol]);if(R&&(r.hostname="",r.port=null,r.host&&(""===w[0]?w[0]=r.host:w.unshift(r.host)),r.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===f[0]?f[0]=e.host:f.unshift(e.host)),e.host=null),E=E&&(""===f[0]||""===w[0])),b)r.host=e.host||""===e.host?e.host:r.host,r.hostname=e.hostname||""===e.hostname?e.hostname:r.hostname,r.search=e.search,r.query=e.query,w=f;else if(f.length)w||(w=[]),w.pop(),w=w.concat(f),r.search=e.search,r.query=e.query;else if(!o.isNullOrUndefined(e.search)){if(R)r.hostname=r.host=w.shift(),(O=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=O.shift(),r.host=r.hostname=O.shift());return r.search=e.search,r.query=e.query,o.isNull(r.pathname)&&o.isNull(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.href=r.format(),r}if(!w.length)return r.pathname=null,r.search?r.path="/"+r.search:r.path=null,r.href=r.format(),r;for(var I=w.slice(-1)[0],k=(r.host||e.host||w.length>1)&&("."===I||".."===I)||""===I,P=0,T=w.length;T>=0;T--)"."===(I=w[T])?w.splice(T,1):".."===I?(w.splice(T,1),P++):P&&(w.splice(T,1),P--);if(!E&&!S)for(;P--;P)w.unshift("..");!E||""===w[0]||w[0]&&"/"===w[0].charAt(0)||w.unshift(""),k&&"/"!==w.join("/").substr(-1)&&w.push("");var O,A=""===w[0]||w[0]&&"/"===w[0].charAt(0);R&&(r.hostname=r.host=A?"":w.length?w.shift():"",(O=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=O.shift(),r.host=r.hostname=O.shift()));return(E=E||r.host&&w.length)&&!A&&w.unshift(""),w.length?r.pathname=w.join("/"):(r.pathname=null,r.path=null),o.isNull(r.pathname)&&o.isNull(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.auth=e.auth||r.auth,r.slashes=r.slashes||e.slashes,r.href=r.format(),r},i.prototype.parseHost=function(){var e=this.host,t=a.exec(e);t&&(":"!==(t=t[0])&&(this.port=t.substr(1)),e=e.substr(0,e.length-t.length)),e&&(this.hostname=e)}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PushProcessor=s;var n=r(6);const o=["override","content","room","sender","underride"],i=[{rule_id:".m.rule.tombstone",default:!0,enabled:!0,conditions:[{kind:"event_match",key:"type",pattern:"m.room.tombstone"},{kind:"event_match",key:"state_key",pattern:""}],actions:["notify",{set_tweak:"highlight",value:!0}]},{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:"event_match",key:"type",pattern:"m.reaction"}],actions:["dont_notify"]}];function s(e){const t={},r=(e,t)=>{for(let r=0;r<o.length;++r){const n=o[r],s=t[n];if(s)for(let t=0;t<s.length;++t){const r=s[t];if(!r.enabled)continue;const o=i(n,r);if(o&&this.ruleMatchesEvent(o,e))return r.kind=n,r}}return null},i=function(e,t){const r={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case"underride":case"override":r.conditions=t.conditions;break;case"room":if(!t.rule_id)return null;r.conditions.push({kind:"event_match",key:"room_id",value:t.rule_id});break;case"sender":if(!t.rule_id)return null;r.conditions.push({kind:"event_match",key:"user_id",value:t.rule_id});break;case"content":if(!t.pattern)return null;r.conditions.push({kind:"event_match",key:"content.body",pattern:t.pattern})}return r},a=function(e,t){const r={event_match:d,contains_display_name:l,room_member_count:u,sender_notification_permission:c};return!!r[e.kind]&&r[e.kind](e,t)},c=function(t,r){const n=t.key;if(!n)return!1;const o=e.getRoom(r.getRoomId());return!(!o||!o.currentState)&&o.currentState.mayTriggerNotifOfType(n,r.getSender())},u=function(t,r){if(!t.is)return!1;const n=e.getRoom(r.getRoomId());if(!n||!n.currentState||!n.currentState.members)return!1;const o=n.currentState.getJoinedMemberCount(),i=t.is.match(/^([=<>]*)([0-9]*)$/);if(!i)return!1;const s=i[1],a=parseInt(i[2]);if(isNaN(a))return!1;switch(s){case"":case"==":return o==a;case"<":return o<a;case">":return o>a;case"<=":return o<=a;case">=":return o>=a;default:return!1}},l=function(t,r){let o=r.getContent();if(r.isEncrypted()&&r.getClearContent()&&(o=r.getClearContent()),!o||!o.body||"string"!=typeof o.body)return!1;const i=e.getRoom(r.getRoomId());if(!(i&&i.currentState&&i.currentState.members&&i.currentState.getMember(e.credentials.userId)))return!1;const s=i.currentState.getMember(e.credentials.userId).name,a=new RegExp("(^|\\W)"+(0,n.escapeRegExp)(s)+"(\\W|$)","i");return o.body.search(a)>-1},d=function(e,t){if(!e.key)return!1;const r=p(e.key,t);if("string"!=typeof r)return!1;if(e.value)return e.value===r;let n;return n="content.body"==e.key?h("(^|\\W)",e.pattern,"(\\W|$)"):h("^",e.pattern,"$"),!!r.match(n)},h=function(e,r,o){return t[r]||(t[r]=new RegExp(e+(0,n.globToRegexp)(r)+o,"i")),t[r]},p=function(e,t){const r=e.split(".");let o;const i=r[0];for("content"===i?(o=t.getContent(),r.shift()):"type"===i?(o=t.getType(),r.shift()):o=t.event;r.length>0;){const e=r.shift();if((0,n.isNullOrUndefined)(o[e]))return null;o=o[e]}return o},f=function(t,n){const o=function(t,n){return n?t.getSender()===e.credentials.userId?null:r(t,n.global):null}(t,n);if(!o)return{};const i=s.actionListToActionsObject(o.actions);return void 0===i.tweaks.highlight&&(i.tweaks.highlight="content"==o.kind),i};this.ruleMatchesEvent=function(e,t){let r=!0;for(let n=0;n<e.conditions.length;++n){const o=e.conditions[n];r&=a(o,t)}return r},this.actionsForEvent=function(t){return f(t,e.pushRules)},this.getPushRuleById=function(t){for(const r of["global"])if(void 0!==e.pushRules[r])for(const n of o)if(void 0!==e.pushRules[r][n])for(const o of e.pushRules[r][n])if(o.rule_id===t)return o;return null}}s.actionListToActionsObject=function(e){const t={notify:!1,tweaks:{}};for(let r=0;r<e.length;++r){const n=e[r];"notify"===n?t.notify=!0:"object"==typeof n&&(void 0===n.value&&(n.value=!0),t.tweaks[n.set_tweak]=n.value)}return t},s.rewriteDefaultRules=function(e){let t=JSON.parse(JSON.stringify(e));t||(t={}),t.global||(t.global={}),t.global.override||(t.global.override=[]);const r=t.global.override;for(const e of i){const t=r.find(t=>t.rule_id===e.rule_id);if(t)t.default=e.default,t.conditions=e.conditions,t.actions=e.actions;else{const t=e.rule_id;console.warn("Adding default global override for "+t),r.push(e)}}return t}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Filter=i;var n=r(103);function o(e,t,r){const n=t.split(".");let o=e;for(let e=0;e<n.length-1;e++)o[n[e]]||(o[n[e]]={}),o=o[n[e]];o[n[n.length-1]]=r}function i(e,t){this.userId=e,this.filterId=t,this.definition={}}i.LAZY_LOADING_MESSAGES_FILTER={lazy_load_members:!0},i.prototype.getFilterId=function(){return this.filterId},i.prototype.getDefinition=function(){return this.definition},i.prototype.setDefinition=function(e){this.definition=e;const t=e.room,r={};t&&(t.rooms&&(r.rooms=t.rooms),t.rooms&&(r.not_rooms=t.not_rooms),this._include_leave=t.include_leave||!1),this._room_filter=new n.FilterComponent(r),this._room_timeline_filter=new n.FilterComponent(t&&t.timeline||{})},i.prototype.getRoomTimelineFilterComponent=function(){return this._room_timeline_filter},i.prototype.filterRoomTimeline=function(e){return this._room_timeline_filter.filter(this._room_filter.filter(e))},i.prototype.setTimelineLimit=function(e){o(this.definition,"room.timeline.limit",e)},i.prototype.setLazyLoadMembers=function(e){o(this.definition,"room.state.lazy_load_members",!!e)},i.prototype.setIncludeLeaveRooms=function(e){o(this.definition,"room.include_leave",e)},i.fromJson=function(e,t,r){const n=new i(e,t);return n.setDefinition(r),n}},function(e,t,r){"use strict";var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomMember=a;var o=r(10),i=r(30),s=n(r(6));function a(e,t){this.roomId=e,this.userId=t,this.typing=!1,this.name=t,this.rawDisplayName=t,this.powerLevel=0,this.powerLevelNorm=0,this.user=null,this.membership=null,this.events={member:null},this._isOutOfBand=!1,this._updateModifiedTime()}s.inherits(a,o.EventEmitter),a.prototype.markOutOfBand=function(){this._isOutOfBand=!0},a.prototype.isOutOfBand=function(){return this._isOutOfBand},a.prototype.setMembershipEvent=function(e,t){if("m.room.member"!==e.getType())return;this._isOutOfBand=!1,this.events.member=e;const r=this.membership;this.membership=e.getDirectionalContent().membership;const n=this.name;this.name=function(e,t,r){if(!t||t===e)return e;if(!s.removeHiddenChars(t))return e;if(!r)return t;let n=/@.+:.+/.test(t);n||(n=/[\u200E\u200F\u202A-\u202F]/.test(t));if(!n){const o=r.getUserIdsWithDisplayName(t);n=o.some(t=>t!==e)}if(n)return t+" ("+e+")";return t}(this.userId,e.getDirectionalContent().displayname,t),this.rawDisplayName=e.getDirectionalContent().displayname||this.userId,r!==this.membership&&(this._updateModifiedTime(),this.emit("RoomMember.membership",e,this,r)),n!==this.name&&(this._updateModifiedTime(),this.emit("RoomMember.name",e,this,n))},a.prototype.setPowerLevelEvent=function(e){if("m.room.power_levels"!==e.getType())return;const t=e.getDirectionalContent();let r=t.users_default||0;s.forEach(s.values(t.users),(function(e){r=Math.max(r,e)}));const n=this.powerLevel,o=this.powerLevelNorm;t.users&&void 0!==t.users[this.userId]?this.powerLevel=t.users[this.userId]:void 0!==t.users_default?this.powerLevel=t.users_default:this.powerLevel=0,this.powerLevelNorm=0,r>0&&(this.powerLevelNorm=100*this.powerLevel/r),n===this.powerLevel&&o===this.powerLevelNorm||(this._updateModifiedTime(),this.emit("RoomMember.powerLevel",e,this))},a.prototype.setTypingEvent=function(e){if("m.typing"!==e.getType())return;const t=this.typing;this.typing=!1;const r=e.getContent().user_ids;s.isArray(r)&&(-1!==r.indexOf(this.userId)&&(this.typing=!0),t!==this.typing&&(this._updateModifiedTime(),this.emit("RoomMember.typing",e,this)))},a.prototype._updateModifiedTime=function(){this._modified=Date.now()},a.prototype.getLastModifiedTime=function(){return this._modified},a.prototype.isKicked=function(){return"leave"===this.membership&&this.events.member.getSender()!==this.events.member.getStateKey()},a.prototype.getDMInviter=function(){if(this.events.member){const e=this.events.member;let t=e.getContent(),r=e.getSender();if("join"===t.membership&&(t=e.getPrevContent(),r=e.getUnsigned().prev_sender),"invite"===t.membership&&t.is_direct)return r}},a.prototype.getAvatarUrl=function(e,t,r,n,o,s){void 0===o&&(o=!0);const a=this.getMxcAvatarUrl();if(!a&&!o)return null;const c=(0,i.getHttpUriForMxc)(e,a,t,r,n,s);return c||(o?(0,i.getIdenticonUri)(e,this.userId,t,r):null)},a.prototype.getMxcAvatarUrl=function(){return this.events.member?this.events.member.getDirectionalContent().avatar_url:this.user?this.user.avatarUrl:null}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReEmitter=void 0;t.ReEmitter=class{constructor(e){this.target=e,this.boundHandlers={}}_handleEvent(e,...t){this.target.emit(e,...t)}reEmit(e,t){const r=(t,...r)=>{t(...r,e)};for(const n of t){void 0===this.boundHandlers[n]&&(this.boundHandlers[n]=this._handleEvent.bind(this,n));const t=r.bind(this,this.boundHandlers[n]);e.on(n,t)}}}},function(e,t,r){"use strict";for(var n=/[\\\"\x00-\x1F]/g,o={},i=0;i<32;++i)o[String.fromCharCode(i)]="\\U"+("0000"+i.toString(16)).slice(-4).toUpperCase();function s(e){return n.lastIndex=0,e.replace(n,(function(e){return o[e]}))}function a(e){switch(typeof e){case"string":return'"'+s(e)+'"';case"number":return isFinite(e)?e:"null";case"boolean":return e;case"object":return null===e?"null":Array.isArray(e)?function(e){for(var t="[",r="",n=0;n<e.length;++n)r+=t,t=",",r+=a(e[n]);return","!=t?"[]":r+"]"}(e):function(e){var t="{",r="",n=Object.keys(e);n.sort();for(var o=0;o<n.length;++o){var i=n[o];r+=t+'"'+s(i)+'":',t=",",r+=a(e[i])}return","!=t?"{}":r+"}"}(e);default:throw new Error("Cannot stringify: "+typeof e)}}o["\b"]="\\b",o["\t"]="\\t",o["\n"]="\\n",o["\f"]="\\f",o["\r"]="\\r",o['"']='\\"',o["\\"]="\\\\",e.exports={stringify:a}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.registerAlgorithm=function(e,t,r){n[e]=t,o[e]=r},t.UnknownDeviceError=t.DecryptionError=t.DecryptionAlgorithm=t.EncryptionAlgorithm=t.DECRYPTION_CLASSES=t.ENCRYPTION_CLASSES=void 0;const n={};t.ENCRYPTION_CLASSES=n;const o={};t.DECRYPTION_CLASSES=o;t.EncryptionAlgorithm=class{constructor(e){this._userId=e.userId,this._deviceId=e.deviceId,this._crypto=e.crypto,this._olmDevice=e.olmDevice,this._baseApis=e.baseApis,this._roomId=e.roomId}prepareToEncrypt(e){}onRoomMembership(e,t,r){}};t.DecryptionAlgorithm=class{constructor(e){this._userId=e.userId,this._crypto=e.crypto,this._olmDevice=e.olmDevice,this._baseApis=e.baseApis,this._roomId=e.roomId}onRoomKeyEvent(e){}importRoomKey(e){}hasKeysForKeyRequest(e){return Promise.resolve(!1)}shareKeysWithDevice(e){throw new Error("shareKeysWithDevice not supported for this DecryptionAlgorithm")}async retryDecryptionFromSender(e){}};class i extends Error{constructor(e,t,r){super(t),this.code=e,this.name="DecryptionError",this.detailedString=function(e,t){let r=e.name+"[msg: "+e.message;t&&(r+=", "+Object.keys(t).map(e=>e+": "+t[e]).join(", "));return r+="]",r}(this,r)}}t.DecryptionError=i;class s extends Error{constructor(e,t){super(e),this.name="UnknownDeviceError",this.devices=t}}t.UnknownDeviceError=s},function(e,t,r){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.encryptAES=function(...e){return i?async function(e,t,r,n){let s;n?s=(0,o.decodeBase64)(n):(s=new Uint8Array(16),window.crypto.getRandomValues(s));s[8]&=127;const[a,u]=await c(t,r),l=(new TextEncoder).encode(e),d=await i.encrypt({name:"AES-CTR",counter:s,length:64},a,l),h=await i.sign({name:"HMAC"},u,d);return{iv:(0,o.encodeBase64)(s),ciphertext:(0,o.encodeBase64)(d),mac:(0,o.encodeBase64)(h)}}(...e):async function(e,t,r,i){const s=(0,n.getCrypto)();if(!s)throw new Error("No usable crypto implementation");let c;c=i?(0,o.decodeBase64)(i):s.randomBytes(16);c[8]&=127;const[u,l]=a(t,r),d=s.createCipheriv("aes-256-ctr",u,c),h=d.update(e,"utf-8","base64")+d.final("base64"),p=s.createHmac("sha256",l).update(h,"base64").digest("base64");return{iv:(0,o.encodeBase64)(c),ciphertext:h,mac:p}}(...e)},t.decryptAES=function(...e){return i?async function(e,t,r){const[n,s]=await c(t,r),a=(0,o.decodeBase64)(e.ciphertext);if(!await i.verify({name:"HMAC"},s,(0,o.decodeBase64)(e.mac),a))throw new Error(`Error decrypting secret ${r}: bad MAC`);const u=await i.decrypt({name:"AES-CTR",counter:(0,o.decodeBase64)(e.iv),length:64},n,a);return(new TextDecoder).decode(new Uint8Array(u))}(...e):async function(e,t,r){const i=(0,n.getCrypto)();if(!i)throw new Error("No usable crypto implementation");const[s,c]=a(t,r);if(i.createHmac("sha256",c).update(e.ciphertext,"base64").digest("base64").replace(/=+$/g,"")!==e.mac.replace(/=+$/g,""))throw new Error(`Error decrypting secret ${r}: bad MAC`);const u=i.createDecipheriv("aes-256-ctr",s,(0,o.decodeBase64)(e.iv));return u.update(e.ciphertext,"base64","utf-8")+u.final("utf-8")}(...e)};var n=r(6),o=r(19);const i="undefined"!=typeof window&&window.crypto?window.crypto.subtle||window.crypto.webkitSubtle:null,s=new Uint8Array(8);function a(t,r){const o=(0,n.getCrypto)(),i=o.createHmac("sha256",s).update(t).digest(),a=e.alloc(1,1),c=o.createHmac("sha256",i).update(r,"utf-8").update(a).digest();a[0]=2;return[c,o.createHmac("sha256",i).update(c).update(r,"utf-8").update(a).digest()]}async function c(e,t){const r=await i.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),n=await i.deriveBits({name:"HKDF",salt:s,info:(new TextEncoder).encode(t),hash:"SHA-256"},r,512),o=n.slice(0,32),a=n.slice(32),c=i.importKey("raw",o,{name:"AES-CTR"},!1,["encrypt","decrypt"]),u=i.importKey("raw",a,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return await Promise.all([c,u])}}).call(this,r(22).Buffer)},function(e,t,r){"use strict";var n=r(14);Object.defineProperty(t,"__esModule",{value:!0}),t.VerificationBase=t.SwitchStartEventError=void 0;var o=n(r(2)),i=r(18),s=r(10),a=r(3),c=r(32),u=r(28),l=r(33),d=r(19);const h=new Error("Verification timed out");class p extends Error{constructor(e){super(),this.startEvent=e}}t.SwitchStartEventError=p;class f extends s.EventEmitter{constructor(e,t,r,n,o,i){super(),this._channel=e,this._baseApis=t,this.userId=r,this.deviceId=n,this.startEvent=o,this.request=i,this.cancelled=!1,this._done=!1,this._promise=null,this._transactionTimeoutTimer=null}get initiatedByMe(){if(!this.startEvent)return!0;const e=this.startEvent.getSender(),t=this.startEvent.getContent();return e===this._baseApis.getUserId()&&t.from_device===this._baseApis.getDeviceId()}_resetTimer(){a.logger.info("Refreshing/starting the verification transaction timeout timer"),null!==this._transactionTimeoutTimer&&clearTimeout(this._transactionTimeoutTimer),this._transactionTimeoutTimer=setTimeout(()=>{this._done||this.cancelled||(a.logger.info("Triggering verification timeout"),this.cancel(h))},6e5)}_endTimer(){null!==this._transactionTimeoutTimer&&(clearTimeout(this._transactionTimeoutTimer),this._transactionTimeoutTimer=null)}_send(e,t){return this._channel.send(e,t)}_waitForEvent(e){if(this._done)return Promise.reject(new Error("Verification is already done"));const t=this.request.getEventFromOtherParty(e);return t?Promise.resolve(t):(this._expectedEvent=e,new Promise((e,t)=>{this._resolveEvent=e,this._rejectEvent=t}))}canSwitchStartEvent(){return!1}switchStartEvent(e){if(this.canSwitchStartEvent(e))if(a.logger.log("Verification Base: switching verification start event",{restartingFlow:!!this._rejectEvent}),this._rejectEvent){const t=this._rejectEvent;this._rejectEvent=void 0,t(new p(e))}else this.startEvent=e}handleEvent(e){if(!this._done)if(e.getType()===this._expectedEvent)"m.key.verification.done"!==this._expectedEvent&&(this._expectedEvent=void 0,this._rejectEvent=void 0,this._resetTimer(),this._resolveEvent(e));else if("m.key.verification.cancel"===e.getType()){const t=this._reject;if(this._reject=void 0,t){const r=e.getContent(),{reason:n,code:o}=r;t(new Error(`Other side cancelled verification because ${n} (${o})`))}}else if(this._expectedEvent){const t=new Error("Unexpected message: expecting "+this._expectedEvent+" but got "+e.getType());if(this._expectedEvent=void 0,this._rejectEvent){const e=this._rejectEvent;this._rejectEvent=void 0,e(t)}this.cancel(t)}}done(){if(this._endTimer(),!this._done){if(this.request.onVerifierFinished(),this._resolve(),this._baseApis.getUserId()!==this.userId)return;return console.log("VerificationBase.done: Self-verification done; requesting keys"),new Promise((e,t)=>{const r=this._baseApis,n=r._crypto._crossSigningInfo,o=new l.CrossSigningInfo(n.userId,{getCrossSigningKey:async e=>{console.debug("VerificationBase.done: requesting secret",e,this.deviceId);const{promise:t}=r.requestSecret("m.cross_signing."+e,[this.deviceId]),n=await t,o=(0,d.decodeBase64)(n);return Uint8Array.from(o)}},n._cacheCallbacks);o.keys=n.keys;const i=new Promise((e,t)=>{setTimeout(e,f.keyRequestTimeoutMs,new Error("Timeout"))}),s=new Promise(async e=>{if(!await r._crypto.getSessionBackupPrivateKey()){a.logger.info("No cached backup key found. Requesting...");const e=r.requestSecret("m.megolm_backup.v1",[this.deviceId]),t=await e.promise;a.logger.info("Got key backup key, decoding...");const n=(0,d.decodeBase64)(t);a.logger.info("Decoded backup key, storing..."),r._crypto.storeSessionBackupPrivateKey(Uint8Array.from(n)),a.logger.info("Backup key stored. Starting backup restore...");const o=await r.getKeyBackupVersion();r.restoreKeyBackupWithCache(void 0,void 0,o).then(()=>{a.logger.info("Backup restored.")})}e()});return Promise.race([Promise.all([o.getCrossSigningKey("self_signing"),o.getCrossSigningKey("user_signing"),s]),i]).then(e,t)}).catch(e=>{console.warn("VerificationBase: failure while requesting keys:",e)})}}cancel(e){if(this._endTimer(),!this._done){if(this.cancelled=!0,this.request.onVerifierCancelled(),this.userId&&this.deviceId)if(e===h){const e=(0,u.newTimeoutError)();this._send(e.getType(),e.getContent())}else if(e instanceof i.MatrixEvent){if(e.getSender()!==this.userId){const t=e.getContent();"m.key.verification.cancel"===e.getType()?(t.code=t.code||"m.unknown",t.reason=t.reason||t.body||"Unknown reason",this._send("m.key.verification.cancel",t)):this._send("m.key.verification.cancel",{code:"m.unknown",reason:t.body||"Unknown reason"})}}else this._send("m.key.verification.cancel",{code:"m.unknown",reason:e.toString()});null!==this._promise?this._reject&&this._reject(e):this._promise=Promise.reject(e),this.emit("cancel",e)}}verify(){return this._promise||(this._promise=new Promise((e,t)=>{this._resolve=(...t)=>{this._done=!0,this._endTimer(),e(...t)},this._reject=(...e)=>{this._done=!0,this._endTimer(),t(...e)}}),this._doVerification&&!this._started&&(this._started=!0,this._resetTimer(),Promise.resolve(this._doVerification()).then(this.done.bind(this),this.cancel.bind(this)))),this._promise}async _verifyKeys(e,t,r){const n=[];for(const[o,i]of Object.entries(t)){const t=o.split(":",2)[1],s=this._baseApis.getStoredDevice(e,t);if(s)await r(o,s,i),n.push(t);else{const s=this._baseApis._crypto._deviceList.getStoredCrossSigningForUser(e);s&&s.getId()===t?(await r(o,c.DeviceInfo.fromStorage({keys:{[o]:t}},t),i),n.push(t)):a.logger.warn(`verification: Could not find device ${t} to verify`)}}if(!n.length)throw new Error("No devices could be verified");a.logger.info("Verification completed! Marking devices verified: ",n);for(const t of n)await this._baseApis.setDeviceVerified(e,t)}}t.VerificationBase=f,(0,o.default)(f,"keyRequestTimeoutMs",6e4)},function(e,t,r){"use strict";var n=r(14);Object.defineProperty(t,"__esModule",{value:!0}),t.VerificationRequest=t.PHASE_DONE=t.PHASE_CANCELLED=t.PHASE_STARTED=t.PHASE_READY=t.PHASE_REQUESTED=t.PHASE_UNSENT=t.READY_TYPE=t.DONE_TYPE=t.CANCEL_TYPE=t.START_TYPE=t.REQUEST_TYPE=t.EVENT_PREFIX=void 0;var o=n(r(2)),i=r(3),s=r(10),a=r(28),c=r(67);const u="m.key.verification.";t.EVENT_PREFIX=u;const l=u+"request";t.REQUEST_TYPE=l;const d=u+"start";t.START_TYPE=d;const h=u+"cancel";t.CANCEL_TYPE=h;t.DONE_TYPE="m.key.verification.done";const p=u+"ready";t.READY_TYPE=p;t.PHASE_UNSENT=1;t.PHASE_REQUESTED=2;t.PHASE_READY=3;t.PHASE_STARTED=4;t.PHASE_CANCELLED=5;t.PHASE_DONE=6;class f extends s.EventEmitter{constructor(e,t,r){super(),(0,o.default)(this,"_cancelOnTimeout",()=>{try{this.initiatedByMe?this.cancel({reason:"Other party didn't accept in time",code:"m.timeout"}):this.cancel({reason:"User didn't accept in time",code:"m.timeout"})}catch(e){i.logger.error("Error while cancelling verification request",e)}}),this.channel=e,this.channel._request=this,this._verificationMethods=t,this._client=r,this._commonMethods=[],this._setPhase(1,!1),this._eventsByUs=new Map,this._eventsByThem=new Map,this._observeOnly=!1,this._timeoutTimer=null,this._accepting=!1,this._declining=!1,this._verifierHasFinished=!1,this._cancelled=!1,this._chosenMethod=null,this._qrCodeData=null,this._requestReceivedAt=null}static validateEvent(e,t,r){const n=t.getContent();return!(!e||!e.startsWith(u))&&(n?e!==l&&e!==p||Array.isArray(n.methods)?e!==l&&e!==p&&e!==d||"string"==typeof n.from_device&&0!==n.from_device.length||(i.logger.log("VerificationRequest: validateEvent: fail because from_device"),!1):(i.logger.log("VerificationRequest: validateEvent: fail because methods"),!1):(i.logger.log("VerificationRequest: validateEvent: no content"),!1))}get invalid(){return 1===this.phase}get requested(){return 2===this.phase}get cancelled(){return 5===this.phase}get ready(){return 3===this.phase}get started(){return 4===this.phase}get done(){return 6===this.phase}get methods(){return this._commonMethods}get chosenMethod(){return this._chosenMethod}calculateEventTimeout(e){let t=this.channel.getTimestamp(e)+6e5;if(this._requestReceivedAt&&!this.initiatedByMe&&this.phase<=2){const e=this._requestReceivedAt+12e4;t=Math.min(t,e)}return Math.max(0,t-Date.now())}get timeout(){const e=this._getEventByEither(l);return e?this.calculateEventTimeout(e):0}get requestEvent(){return this._getEventByEither(l)}get phase(){return this._phase}get verifier(){return this._verifier}get canAccept(){return this.phase<3&&!this._accepting&&!this._declining}get accepting(){return this._accepting}get declining(){return this._declining}get pending(){return!this.observeOnly&&6!==this._phase&&5!==this._phase}get qrCodeData(){return this._qrCodeData}otherPartySupportsMethod(e,t=!1){if(!t&&!this.ready&&!this.started)return!1;const r=this._eventsByThem.get(l)||this._eventsByThem.get(p);if(!r){if(this.started&&this.initiatedByMe){const t=this._eventsByUs.get(d),r=t&&t.getContent();return e==(r&&r.method)}return!1}const n=r.getContent();if(!n)return!1;const{methods:o}=n;return!!Array.isArray(o)&&o.includes(e)}get initiatedByMe(){const e=this._eventsByUs.size+this._eventsByThem.size===0;if(1===this._phase&&e)return!0;const t=this._eventsByUs.has(l),r=this._eventsByThem.has(l);if(t&&!r)return!0;if(!t&&r)return!1;const n=this._eventsByUs.has(d),o=this._eventsByThem.has(d);return!(!n||o)}get requestingUserId(){return this.initiatedByMe?this._client.getUserId():this.otherUserId}get receivingUserId(){return this.initiatedByMe?this.otherUserId:this._client.getUserId()}get otherUserId(){return this.channel.userId}get isSelfVerification(){return this._client.getUserId()===this.otherUserId}get cancellingUserId(){const e=this._eventsByUs.get(h),t=this._eventsByThem.get(h);return e&&(!t||e.getId()<t.getId())?e.getSender():t?t.getSender():void 0}get cancellationCode(){const e=this._getEventByEither(h);return e?e.getContent().code:null}get observeOnly(){return this._observeOnly}get targetDevice(){const e=(this._eventsByThem.get(l)||this._eventsByThem.get(p)||this._eventsByThem.get(d)).getContent().from_device;return{userId:this.otherUserId,deviceId:e}}beginKeyVerification(e,t=null){if(!this.observeOnly&&!this._verifier){if(2===this.phase||3===this.phase||1===this.phase&&this.channel.constructor.canCreateRequest(d)){if(this._commonMethods.length&&!this._commonMethods.includes(e))throw(0,a.newUnknownMethodError)();if(this._verifier=this._createVerifier(e,null,t),!this._verifier)throw(0,a.newUnknownMethodError)();this._chosenMethod=e}}return this._verifier}async sendRequest(){if(!this.observeOnly&&1===this._phase){const e=[...this._verificationMethods.keys()];await this.channel.send(l,{methods:e})}}async cancel({reason:e="User declined",code:t="m.user"}={}){if(!this.observeOnly&&5!==this._phase){if(this._declining=!0,this.emit("change"),this._verifier)return this._verifier.cancel((0,a.errorFactory)(t,e)());this._cancellingUserId=this._client.getUserId(),await this.channel.send(h,{code:t,reason:e})}}async accept(){if(!this.observeOnly&&2===this.phase&&!this.initiatedByMe){const e=[...this._verificationMethods.keys()];this._accepting=!0,this.emit("change"),await this.channel.send(p,{methods:e})}}waitFor(e){return new Promise((t,r)=>{const n=()=>{let o=!1;return e(this)?(t(this),o=!0):this.cancelled&&(r(new Error("cancelled")),o=!0),o&&this.off("change",n),o};n()||this.on("change",n)})}_setPhase(e,t=!0){this._phase=e,t&&this.emit("change")}_getEventByEither(e){return this._eventsByThem.get(e)||this._eventsByUs.get(e)}_getEventBy(e,t){return t?this._eventsByThem.get(e):this._eventsByUs.get(e)}_calculatePhaseTransitions(){const e=[{phase:1}],t=()=>e[e.length-1].phase,r=this._eventsByThem.has(l),n=this._getEventBy(l,r);n&&e.push({phase:2,event:n});const o=n&&this._getEventBy(p,!r);let i;if(o&&2===t()&&e.push({phase:3,event:o}),o||!n){const e=this._eventsByThem.get(d),t=this._eventsByUs.get(d);i=e&&t?e.getSender()<t.getSender()?e:t:e||t}else i=this._getEventBy(d,!r);if(i){const r=2===t()&&n.getSender()!==i.getSender(),o=1===t()&&this.channel.constructor.canCreateRequest(d);(r||3===t()||o)&&e.push({phase:4,event:i})}const s=this._eventsByUs.get("m.key.verification.done");(this._verifierHasFinished||s&&4===t())&&e.push({phase:6});const a=this._getEventByEither(h);return(this._cancelled||a)&&6!==t()?(e.push({phase:5,event:a}),e):e}_transitionToPhase(e){const{phase:t,event:r}=e;if((2===t||3===t)&&!this._wasSentByOwnDevice(r)){const e=r.getContent();this._commonMethods=e.methods.filter(e=>this._verificationMethods.has(e))}if(this.observeOnly||2!==t&&4!==t&&3!==t||this.channel.receiveStartFromOtherDevices&&this._wasSentByOwnUser(r)&&!this._wasSentByOwnDevice(r)&&(this._observeOnly=!0),4===t){const{method:e}=r.getContent();this._verifier||this.observeOnly||(this._verifier=this._createVerifier(e,r),this._verifier?this._chosenMethod=e:this.cancel({code:"m.unknown_method",reason:"Unknown method: "+e}))}}_applyPhaseTransitions(){const e=this._calculatePhaseTransitions(),t=e.findIndex(e=>e.phase===this.phase),r=e.slice(t+1);for(const e of r)this._transitionToPhase(e);return r}_isWinningStartRace(e){if(e.getType()!==d)return!1;const t=this._verifier.startEvent;let r,n;if(this.isSelfVerification)if(t){const e=t.getContent();r=e&&e.from_device}else r=this._client.getDeviceId();else r=t?t.getSender():this._client.getUserId();if(this.isSelfVerification){const t=e.getContent();n=t&&t.from_device}else n=e.getSender();return n<r}hasEventId(e){for(const t of this._eventsByUs.values())if(t.getId()===e)return!0;for(const t of this._eventsByThem.values())if(t.getId()===e)return!0;return!1}async handleEvent(e,t,r,n,o){if(this.done||this.cancelled)return;const s=this._observeOnly;if(this._adjustObserveOnly(t,r),!this.observeOnly&&!n&&await this._cancelOnError(e,t))return;if(o?this._eventsByUs.has(e):this._eventsByThem.has(e))return;const a=this.phase;this._addEvent(e,t,o);const u=this._applyPhaseTransitions();try{if(this._verifier&&!this.observeOnly){const r=this._isWinningStartRace(t);this._verifier.canSwitchStartEvent(t)&&r?this._verifier.switchStartEvent(t):n||(e===h||this._verifier.events&&this._verifier.events.includes(e))&&this._verifier.handleEvent(t)}if(u.length){if(r&&u.some(e=>3===e.phase)){this.otherPartySupportsMethod(c.SCAN_QR_CODE_METHOD,!0)&&(this._qrCodeData=await c.QRCodeData.create(this,this._client))}const e=u[u.length-1],{phase:t}=e;this._setupTimeout(t),this._setPhase(t)}else this._observeOnly!==s&&this.emit("change")}finally{i.logger.log(`Verification request ${this.channel.transactionId}: ${e} event with id:${t.getId()}, content:${JSON.stringify(t.getContent())} deviceId:${this.channel.deviceId}, sender:${t.getSender()}, isSentByUs:${o}, isLiveEvent:${r}, isRemoteEcho:${n}, phase:${a}=>${this.phase}, observeOnly:${s}=>${this._observeOnly}`)}}_setupTimeout(e){if(!this._timeoutTimer&&!this.observeOnly&&2===e&&(this._timeoutTimer=setTimeout(this._cancelOnTimeout,this.timeout)),this._timeoutTimer){(4===e||3===e||6===e||5===e)&&(clearTimeout(this._timeoutTimer),this._timeoutTimer=null)}}async _cancelOnError(e,t){if(e===d){const e=t.getContent().method;if(!this._verificationMethods.has(e))return await this.cancel((0,a.errorFromEvent)((0,a.newUnknownMethodError)())),!0}const r=e===l&&1!==this.phase,n=e===p&&2!==this.phase;if(1!==this.phase&&(r||n)){i.logger.warn(`Cancelling, unexpected ${e} verification event from `+t.getSender());const r=`Unexpected ${e} event in phase ${this.phase}`;return await this.cancel((0,a.errorFromEvent)((0,a.newUnexpectedMessageError)({reason:r}))),!0}return!1}_adjustObserveOnly(e,t){t||(this._observeOnly=!0),this.calculateEventTimeout(e)<3e3&&(this._observeOnly=!0)}_addEvent(e,t,r){if(r?this._eventsByUs.set(e,t):this._eventsByThem.set(e,t),e===l){for(const[e,t]of this._eventsByThem.entries())t.getSender()!==this.otherUserId&&this._eventsByThem.delete(e);this._requestReceivedAt=Date.now()}}_createVerifier(e,t=null,r=null){r||(r=this.targetDevice);const{userId:n,deviceId:o}=r,s=this._verificationMethods.get(e);if(s)return new s(this.channel,this._client,n,o,t,this);i.logger.warn("could not find verifier constructor for method",e)}_wasSentByOwnUser(e){return e.getSender()===this._client.getUserId()}_wasSentByOwnDevice(e){if(!this._wasSentByOwnUser(e))return!1;const t=e.getContent();return!(!t||t.from_device!==this._client.getDeviceId())}onVerifierCancelled(){this._cancelled=!0;const e=this._applyPhaseTransitions();e.length&&this._setPhase(e[e.length-1].phase)}onVerifierFinished(){this.channel.send("m.key.verification.done",{}),this._verifierHasFinished=!0;const e=this._applyPhaseTransitions();e.length&&this._setPhase(e[e.length-1].phase)}getEventFromOtherParty(e){return this._eventsByThem.get(e)}}t.VerificationRequest=f},function(e,t,r){"use strict";var n=Object.prototype.hasOwnProperty,o=Array.isArray,i=function(){for(var e=[],t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e}(),s=function(e,t){for(var r=t&&t.plainObjects?Object.create(null):{},n=0;n<e.length;++n)void 0!==e[n]&&(r[n]=e[n]);return r};e.exports={arrayToObject:s,assign:function(e,t){return Object.keys(t).reduce((function(e,r){return e[r]=t[r],e}),e)},combine:function(e,t){return[].concat(e,t)},compact:function(e){for(var t=[{obj:{o:e},prop:"o"}],r=[],n=0;n<t.length;++n)for(var i=t[n],s=i.obj[i.prop],a=Object.keys(s),c=0;c<a.length;++c){var u=a[c],l=s[u];"object"==typeof l&&null!==l&&-1===r.indexOf(l)&&(t.push({obj:s,prop:u}),r.push(l))}return function(e){for(;e.length>1;){var t=e.pop(),r=t.obj[t.prop];if(o(r)){for(var n=[],i=0;i<r.length;++i)void 0!==r[i]&&n.push(r[i]);t.obj[t.prop]=n}}}(t),e},decode:function(e,t,r){var n=e.replace(/\+/g," ");if("iso-8859-1"===r)return n.replace(/%[0-9a-f]{2}/gi,unescape);try{return decodeURIComponent(n)}catch(e){return n}},encode:function(e,t,r){if(0===e.length)return e;var n=e;if("symbol"==typeof e?n=Symbol.prototype.toString.call(e):"string"!=typeof e&&(n=String(e)),"iso-8859-1"===r)return escape(n).replace(/%u[0-9a-f]{4}/gi,(function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"}));for(var o="",s=0;s<n.length;++s){var a=n.charCodeAt(s);45===a||46===a||95===a||126===a||a>=48&&a<=57||a>=65&&a<=90||a>=97&&a<=122?o+=n.charAt(s):a<128?o+=i[a]:a<2048?o+=i[192|a>>6]+i[128|63&a]:a<55296||a>=57344?o+=i[224|a>>12]+i[128|a>>6&63]+i[128|63&a]:(s+=1,a=65536+((1023&a)<<10|1023&n.charCodeAt(s)),o+=i[240|a>>18]+i[128|a>>12&63]+i[128|a>>6&63]+i[128|63&a])}return o},isBuffer:function(e){return!(!e||"object"!=typeof e)&&!!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e))},isRegExp:function(e){return"[object RegExp]"===Object.prototype.toString.call(e)},maybeMap:function(e,t){if(o(e)){for(var r=[],n=0;n<e.length;n+=1)r.push(t(e[n]));return r}return t(e)},merge:function e(t,r,i){if(!r)return t;if("object"!=typeof r){if(o(t))t.push(r);else{if(!t||"object"!=typeof t)return[t,r];(i&&(i.plainObjects||i.allowPrototypes)||!n.call(Object.prototype,r))&&(t[r]=!0)}return t}if(!t||"object"!=typeof t)return[t].concat(r);var a=t;return o(t)&&!o(r)&&(a=s(t,i)),o(t)&&o(r)?(r.forEach((function(r,o){if(n.call(t,o)){var s=t[o];s&&"object"==typeof s&&r&&"object"==typeof r?t[o]=e(s,r,i):t.push(r)}else t[o]=r})),t):Object.keys(r).reduce((function(t,o){var s=r[o];return n.call(t,o)?t[o]=e(t[o],s,i):t[o]=s,t}),a)}}},function(e,t,r){"use strict";var n=r(145),o=r(48),i=r(25),s=r(74),a=r(147);function c(e,t,r){var n=this._refs[r];if("string"==typeof n){if(!this._refs[n])return c.call(this,e,t,n);n=this._refs[n]}if((n=n||this._schemas[r])instanceof s)return f(n.schema,this._opts.inlineRefs)?n.schema:n.validate||this._compile(n);var o,i,a,l=u.call(this,t,r);return l&&(o=l.schema,t=l.root,a=l.baseId),o instanceof s?i=o.validate||e.call(this,o.schema,t,void 0,a):void 0!==o&&(i=f(o,this._opts.inlineRefs)?o:e.call(this,o,t,void 0,a)),i}function u(e,t){var r=n.parse(t),o=g(r),i=m(this._getId(e.schema));if(0===Object.keys(e.schema).length||o!==i){var a=y(o),c=this._refs[a];if("string"==typeof c)return l.call(this,e,c,r);if(c instanceof s)c.validate||this._compile(c),e=c;else{if(!((c=this._schemas[a])instanceof s))return;if(c.validate||this._compile(c),a==y(t))return{schema:c,root:e,baseId:i};e=c}if(!e.schema)return;i=m(this._getId(e.schema))}return h.call(this,r,i,e.schema,e)}function l(e,t,r){var n=u.call(this,e,t);if(n){var o=n.schema,i=n.baseId;e=n.root;var s=this._getId(o);return s&&(i=_(i,s)),h.call(this,r,i,o,e)}}e.exports=c,c.normalizeId=y,c.fullPath=m,c.url=_,c.ids=function(e){var t=y(this._getId(e)),r={"":t},s={"":m(t,!1)},c={},u=this;return a(e,{allKeys:!0},(function(e,t,a,l,d,h,p){if(""!==t){var f=u._getId(e),m=r[l],g=s[l]+"/"+d;if(void 0!==p&&(g+="/"+("number"==typeof p?p:i.escapeFragment(p))),"string"==typeof f){f=m=y(m?n.resolve(m,f):f);var v=u._refs[f];if("string"==typeof v&&(v=u._refs[v]),v&&v.schema){if(!o(e,v.schema))throw new Error('id "'+f+'" resolves to more than one schema')}else if(f!=y(g))if("#"==f[0]){if(c[f]&&!o(e,c[f]))throw new Error('id "'+f+'" resolves to more than one schema');c[f]=e}else u._refs[f]=g}r[t]=m,s[t]=g}})),c},c.inlineRef=f,c.schema=u;var d=i.toHash(["properties","patternProperties","enum","dependencies","definitions"]);function h(e,t,r,n){if(e.fragment=e.fragment||"","/"==e.fragment.slice(0,1)){for(var o=e.fragment.split("/"),s=1;s<o.length;s++){var a=o[s];if(a){if(void 0===(r=r[a=i.unescapeFragment(a)]))break;var c;if(!d[a]&&((c=this._getId(r))&&(t=_(t,c)),r.$ref)){var l=_(t,r.$ref),h=u.call(this,n,l);h&&(r=h.schema,n=h.root,t=h.baseId)}}}return void 0!==r&&r!==n.schema?{schema:r,root:n,baseId:t}:void 0}}var p=i.toHash(["type","format","pattern","maxLength","minLength","maxProperties","minProperties","maxItems","minItems","maximum","minimum","uniqueItems","multipleOf","required","enum"]);function f(e,t){return!1!==t&&(void 0===t||!0===t?function e(t){var r;if(Array.isArray(t)){for(var n=0;n<t.length;n++)if("object"==typeof(r=t[n])&&!e(r))return!1}else for(var o in t){if("$ref"==o)return!1;if("object"==typeof(r=t[o])&&!e(r))return!1}return!0}(e):t?function e(t){var r,n=0;if(Array.isArray(t)){for(var o=0;o<t.length;o++)if("object"==typeof(r=t[o])&&(n+=e(r)),n==1/0)return 1/0}else for(var i in t){if("$ref"==i)return 1/0;if(p[i])n++;else if("object"==typeof(r=t[i])&&(n+=e(r)+1),n==1/0)return 1/0}return n}(e)<=t:void 0)}function m(e,t){return!1!==t&&(e=y(e)),g(n.parse(e))}function g(e){return n.serialize(e).split("#")[0]+"#"}var v=/#\/?$/;function y(e){return e?e.replace(v,""):""}function _(e,t){return t=y(t),n.resolve(e,t)}},function(e,t,r){"use strict";e.exports=function e(t,r){if(t===r)return!0;if(t&&r&&"object"==typeof t&&"object"==typeof r){if(t.constructor!==r.constructor)return!1;var n,o,i;if(Array.isArray(t)){if((n=t.length)!=r.length)return!1;for(o=n;0!=o--;)if(!e(t[o],r[o]))return!1;return!0}if(t.constructor===RegExp)return t.source===r.source&&t.flags===r.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===r.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===r.toString();if((n=(i=Object.keys(t)).length)!==Object.keys(r).length)return!1;for(o=n;0!=o--;)if(!Object.prototype.hasOwnProperty.call(r,i[o]))return!1;for(o=n;0!=o--;){var s=i[o];if(!e(t[s],r[s]))return!1}return!0}return t!=t&&r!=r}},function(e,t,r){"use strict";var n=r(47);function o(e,t,r){this.message=r||o.message(e,t),this.missingRef=n.url(e,t),this.missingSchema=n.normalizeId(n.fullPath(this.missingRef))}function i(e){return e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,e}e.exports={Validation:i((function(e){this.message="validation failed",this.errors=e,this.ajv=this.validation=!0})),MissingRef:i(o)},o.message=function(e,t){return"can't resolve reference "+t+" from id "+e}},function(e,t){function r(t){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?e.exports=r=function(e){return typeof e}:e.exports=r=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(t)}e.exports=r},function(e,t,r){var n,o;void 0===(o="function"==typeof(n=function(e){"use strict";var t,r,n={template:"[%t] %l:",levelFormatter:function(e){return e.toUpperCase()},nameFormatter:function(e){return e||"root"},timestampFormatter:function(e){return e.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1")},format:void 0},o={},i={reg:function(e){if(!e||!e.getLogger)throw new TypeError("Argument is not a root logger");t=e},apply:function(e,r){if(!e||!e.setLevel)throw new TypeError("Argument is not a logger");var i=e.methodFactory,s=e.name||"",a=o[s]||o[""]||n;return o[s]||(e.methodFactory=function(e,t,r){var n=i(e,t,r),a=o[r]||o[""],c=-1!==a.template.indexOf("%t"),u=-1!==a.template.indexOf("%l"),l=-1!==a.template.indexOf("%n");return function(){for(var t="",i=arguments.length,d=Array(i),h=0;h<i;h++)d[h]=arguments[h];if(s||!o[r]){var p=a.timestampFormatter(new Date),f=a.levelFormatter(e),m=a.nameFormatter(r);a.format?t+=a.format(f,m,p):(t+=a.template,c&&(t=t.replace(/%t/,p)),u&&(t=t.replace(/%l/,f)),l&&(t=t.replace(/%n/,m))),d.length&&"string"==typeof d[0]?d[0]=t+" "+d[0]:d.unshift(t)}n.apply(void 0,d)}}),(r=r||{}).template&&(r.format=void 0),o[s]=function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(t in arguments[r])Object.prototype.hasOwnProperty.call(arguments[r],t)&&(e[t]=arguments[r][t]);return e}({},a,r),e.setLevel(e.getLevel()),t||e.warn("It is necessary to call the function reg() of loglevel-plugin-prefix before calling apply. From the next release, it will throw an error. See more: https://github.com/kutuluk/loglevel-plugin-prefix/blob/master/README.md"),e}};return e&&(r=e.prefix,i.noConflict=function(){return e.prefix===i&&(e.prefix=r),i}),i})?n.call(t,r,t,e):n)||(e.exports=o)},function(e,t,r){(function(t){e.exports=function e(t,r,n){function o(s,a){if(!r[s]){if(!t[s]){if(i)return i(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var u=r[s]={exports:{}};t[s][0].call(u.exports,(function(e){var r=t[s][1][e];return o(r||e)}),u,u.exports,e,t,r,n)}return r[s].exports}for(var i=!1,s=0;s<n.length;s++)o(n[s]);return o}({1:[function(e,r,n){(function(e){"use strict";var t,n,o=e.MutationObserver||e.WebKitMutationObserver;if(o){var i=0,s=new o(l),a=e.document.createTextNode("");s.observe(a,{characterData:!0}),t=function(){a.data=i=++i%2}}else if(e.setImmediate||void 0===e.MessageChannel)t="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var t=e.document.createElement("script");t.onreadystatechange=function(){l(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},e.document.documentElement.appendChild(t)}:function(){setTimeout(l,0)};else{var c=new e.MessageChannel;c.port1.onmessage=l,t=function(){c.port2.postMessage(0)}}var u=[];function l(){var e,t;n=!0;for(var r=u.length;r;){for(t=u,u=[],e=-1;++e<r;)t[e]();r=u.length}n=!1}r.exports=function(e){1!==u.push(e)||n||t()}}).call(this,void 0!==t?t:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(e,t,r){"use strict";var n=e(1);function o(){}var i={},s=["REJECTED"],a=["FULFILLED"],c=["PENDING"];function u(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=c,this.queue=[],this.outcome=void 0,e!==o&&p(this,e)}function l(e,t,r){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof r&&(this.onRejected=r,this.callRejected=this.otherCallRejected)}function d(e,t,r){n((function(){var n;try{n=t(r)}catch(t){return i.reject(e,t)}n===e?i.reject(e,new TypeError("Cannot resolve promise with itself")):i.resolve(e,n)}))}function h(e){var t=e&&e.then;if(e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof t)return function(){t.apply(e,arguments)}}function p(e,t){var r=!1;function n(t){r||(r=!0,i.reject(e,t))}function o(t){r||(r=!0,i.resolve(e,t))}var s=f((function(){t(o,n)}));"error"===s.status&&n(s.value)}function f(e,t){var r={};try{r.value=e(t),r.status="success"}catch(e){r.status="error",r.value=e}return r}t.exports=u,u.prototype.catch=function(e){return this.then(null,e)},u.prototype.then=function(e,t){if("function"!=typeof e&&this.state===a||"function"!=typeof t&&this.state===s)return this;var r=new this.constructor(o);return this.state!==c?d(r,this.state===a?e:t,this.outcome):this.queue.push(new l(r,e,t)),r},l.prototype.callFulfilled=function(e){i.resolve(this.promise,e)},l.prototype.otherCallFulfilled=function(e){d(this.promise,this.onFulfilled,e)},l.prototype.callRejected=function(e){i.reject(this.promise,e)},l.prototype.otherCallRejected=function(e){d(this.promise,this.onRejected,e)},i.resolve=function(e,t){var r=f(h,t);if("error"===r.status)return i.reject(e,r.value);var n=r.value;if(n)p(e,n);else{e.state=a,e.outcome=t;for(var o=-1,s=e.queue.length;++o<s;)e.queue[o].callFulfilled(t)}return e},i.reject=function(e,t){e.state=s,e.outcome=t;for(var r=-1,n=e.queue.length;++r<n;)e.queue[r].callRejected(t);return e},u.resolve=function(e){return e instanceof this?e:i.resolve(new this(o),e)},u.reject=function(e){var t=new this(o);return i.reject(t,e)},u.all=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var r=e.length,n=!1;if(!r)return this.resolve([]);for(var s=new Array(r),a=0,c=-1,u=new this(o);++c<r;)l(e[c],c);return u;function l(e,o){t.resolve(e).then((function(e){s[o]=e,++a!==r||n||(n=!0,i.resolve(u,s))}),(function(e){n||(n=!0,i.reject(u,e))}))}},u.race=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var r=e.length,n=!1;if(!r)return this.resolve([]);for(var s,a=-1,c=new this(o);++a<r;)s=e[a],t.resolve(s).then((function(e){n||(n=!0,i.resolve(c,e))}),(function(e){n||(n=!0,i.reject(c,e))}));return c}},{1:1}],3:[function(e,r,n){(function(t){"use strict";"function"!=typeof t.Promise&&(t.Promise=e(2))}).call(this,void 0!==t?t:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{2:2}],4:[function(e,t,r){"use strict";var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(){try{if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof webkitIndexedDB)return webkitIndexedDB;if("undefined"!=typeof mozIndexedDB)return mozIndexedDB;if("undefined"!=typeof OIndexedDB)return OIndexedDB;if("undefined"!=typeof msIndexedDB)return msIndexedDB}catch(e){return}}();function i(e,t){e=e||[],t=t||{};try{return new Blob(e,t)}catch(o){if("TypeError"!==o.name)throw o;for(var r=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),n=0;n<e.length;n+=1)r.append(e[n]);return r.getBlob(t.type)}}"undefined"==typeof Promise&&e(3);var s=Promise;function a(e,t){t&&e.then((function(e){t(null,e)}),(function(e){t(e)}))}function c(e,t,r){"function"==typeof t&&e.then(t),"function"==typeof r&&e.catch(r)}function u(e){return"string"!=typeof e&&(console.warn(e+" used as a key, but it is not a string."),e=String(e)),e}function l(){if(arguments.length&&"function"==typeof arguments[arguments.length-1])return arguments[arguments.length-1]}var d=void 0,h={},p=Object.prototype.toString;function f(e){return"boolean"==typeof d?s.resolve(d):function(e){return new s((function(t){var r=e.transaction("local-forage-detect-blob-support","readwrite"),n=i([""]);r.objectStore("local-forage-detect-blob-support").put(n,"key"),r.onabort=function(e){e.preventDefault(),e.stopPropagation(),t(!1)},r.oncomplete=function(){var e=navigator.userAgent.match(/Chrome\/(\d+)/),r=navigator.userAgent.match(/Edge\//);t(r||!e||parseInt(e[1],10)>=43)}})).catch((function(){return!1}))}(e).then((function(e){return d=e}))}function m(e){var t=h[e.name],r={};r.promise=new s((function(e,t){r.resolve=e,r.reject=t})),t.deferredOperations.push(r),t.dbReady?t.dbReady=t.dbReady.then((function(){return r.promise})):t.dbReady=r.promise}function g(e){var t=h[e.name].deferredOperations.pop();if(t)return t.resolve(),t.promise}function v(e,t){var r=h[e.name].deferredOperations.pop();if(r)return r.reject(t),r.promise}function y(e,t){return new s((function(r,n){if(h[e.name]=h[e.name]||{forages:[],db:null,dbReady:null,deferredOperations:[]},e.db){if(!t)return r(e.db);m(e),e.db.close()}var i=[e.name];t&&i.push(e.version);var s=o.open.apply(o,i);t&&(s.onupgradeneeded=function(t){var r=s.result;try{r.createObjectStore(e.storeName),t.oldVersion<=1&&r.createObjectStore("local-forage-detect-blob-support")}catch(r){if("ConstraintError"!==r.name)throw r;console.warn('The database "'+e.name+'" has been upgraded from version '+t.oldVersion+" to version "+t.newVersion+', but the storage "'+e.storeName+'" already exists.')}}),s.onerror=function(e){e.preventDefault(),n(s.error)},s.onsuccess=function(){r(s.result),g(e)}}))}function _(e){return y(e,!1)}function b(e){return y(e,!0)}function E(e,t){if(!e.db)return!0;var r=!e.db.objectStoreNames.contains(e.storeName),n=e.version<e.db.version,o=e.version>e.db.version;if(n&&(e.version!==t&&console.warn('The database "'+e.name+"\" can't be downgraded from version "+e.db.version+" to version "+e.version+"."),e.version=e.db.version),o||r){if(r){var i=e.db.version+1;i>e.version&&(e.version=i)}return!0}return!1}function S(e){return i([function(e){for(var t=e.length,r=new ArrayBuffer(t),n=new Uint8Array(r),o=0;o<t;o++)n[o]=e.charCodeAt(o);return r}(atob(e.data))],{type:e.type})}function w(e){return e&&e.__local_forage_encoded_blob}function R(e){var t=this,r=t._initReady().then((function(){var e=h[t._dbInfo.name];if(e&&e.dbReady)return e.dbReady}));return c(r,e,e),r}function I(e,t,r,n){void 0===n&&(n=1);try{var o=e.db.transaction(e.storeName,t);r(null,o)}catch(o){if(n>0&&(!e.db||"InvalidStateError"===o.name||"NotFoundError"===o.name))return s.resolve().then((function(){if(!e.db||"NotFoundError"===o.name&&!e.db.objectStoreNames.contains(e.storeName)&&e.version<=e.db.version)return e.db&&(e.version=e.db.version+1),b(e)})).then((function(){return function(e){m(e);for(var t=h[e.name],r=t.forages,n=0;n<r.length;n++){var o=r[n];o._dbInfo.db&&(o._dbInfo.db.close(),o._dbInfo.db=null)}return e.db=null,_(e).then((function(t){return e.db=t,E(e)?b(e):t})).then((function(n){e.db=t.db=n;for(var o=0;o<r.length;o++)r[o]._dbInfo.db=n})).catch((function(t){throw v(e,t),t}))}(e).then((function(){I(e,t,r,n-1)}))})).catch(r);r(o)}}var k={_driver:"asyncStorage",_initStorage:function(e){var t=this,r={db:null};if(e)for(var n in e)r[n]=e[n];var o=h[r.name];o||(o={forages:[],db:null,dbReady:null,deferredOperations:[]},h[r.name]=o),o.forages.push(t),t._initReady||(t._initReady=t.ready,t.ready=R);var i=[];function a(){return s.resolve()}for(var c=0;c<o.forages.length;c++){var u=o.forages[c];u!==t&&i.push(u._initReady().catch(a))}var l=o.forages.slice(0);return s.all(i).then((function(){return r.db=o.db,_(r)})).then((function(e){return r.db=e,E(r,t._defaultConfig.version)?b(r):e})).then((function(e){r.db=o.db=e,t._dbInfo=r;for(var n=0;n<l.length;n++){var i=l[n];i!==t&&(i._dbInfo.db=r.db,i._dbInfo.version=r.version)}}))},_support:function(){try{if(!o||!o.open)return!1;var e="undefined"!=typeof openDatabase&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),t="function"==typeof fetch&&-1!==fetch.toString().indexOf("[native code");return(!e||t)&&"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(e){return!1}}(),iterate:function(e,t){var r=this,n=new s((function(t,n){r.ready().then((function(){I(r._dbInfo,"readonly",(function(o,i){if(o)return n(o);try{var s=i.objectStore(r._dbInfo.storeName).openCursor(),a=1;s.onsuccess=function(){var r=s.result;if(r){var n=r.value;w(n)&&(n=S(n));var o=e(n,r.key,a++);void 0!==o?t(o):r.continue()}else t()},s.onerror=function(){n(s.error)}}catch(e){n(e)}}))})).catch(n)}));return a(n,t),n},getItem:function(e,t){var r=this;e=u(e);var n=new s((function(t,n){r.ready().then((function(){I(r._dbInfo,"readonly",(function(o,i){if(o)return n(o);try{var s=i.objectStore(r._dbInfo.storeName).get(e);s.onsuccess=function(){var e=s.result;void 0===e&&(e=null),w(e)&&(e=S(e)),t(e)},s.onerror=function(){n(s.error)}}catch(e){n(e)}}))})).catch(n)}));return a(n,t),n},setItem:function(e,t,r){var n=this;e=u(e);var o=new s((function(r,o){var i;n.ready().then((function(){return i=n._dbInfo,"[object Blob]"===p.call(t)?f(i.db).then((function(e){return e?t:(r=t,new s((function(e,t){var n=new FileReader;n.onerror=t,n.onloadend=function(t){var n=btoa(t.target.result||"");e({__local_forage_encoded_blob:!0,data:n,type:r.type})},n.readAsBinaryString(r)})));var r})):t})).then((function(t){I(n._dbInfo,"readwrite",(function(i,s){if(i)return o(i);try{var a=s.objectStore(n._dbInfo.storeName);null===t&&(t=void 0);var c=a.put(t,e);s.oncomplete=function(){void 0===t&&(t=null),r(t)},s.onabort=s.onerror=function(){var e=c.error?c.error:c.transaction.error;o(e)}}catch(e){o(e)}}))})).catch(o)}));return a(o,r),o},removeItem:function(e,t){var r=this;e=u(e);var n=new s((function(t,n){r.ready().then((function(){I(r._dbInfo,"readwrite",(function(o,i){if(o)return n(o);try{var s=i.objectStore(r._dbInfo.storeName).delete(e);i.oncomplete=function(){t()},i.onerror=function(){n(s.error)},i.onabort=function(){var e=s.error?s.error:s.transaction.error;n(e)}}catch(e){n(e)}}))})).catch(n)}));return a(n,t),n},clear:function(e){var t=this,r=new s((function(e,r){t.ready().then((function(){I(t._dbInfo,"readwrite",(function(n,o){if(n)return r(n);try{var i=o.objectStore(t._dbInfo.storeName).clear();o.oncomplete=function(){e()},o.onabort=o.onerror=function(){var e=i.error?i.error:i.transaction.error;r(e)}}catch(e){r(e)}}))})).catch(r)}));return a(r,e),r},length:function(e){var t=this,r=new s((function(e,r){t.ready().then((function(){I(t._dbInfo,"readonly",(function(n,o){if(n)return r(n);try{var i=o.objectStore(t._dbInfo.storeName).count();i.onsuccess=function(){e(i.result)},i.onerror=function(){r(i.error)}}catch(e){r(e)}}))})).catch(r)}));return a(r,e),r},key:function(e,t){var r=this,n=new s((function(t,n){e<0?t(null):r.ready().then((function(){I(r._dbInfo,"readonly",(function(o,i){if(o)return n(o);try{var s=i.objectStore(r._dbInfo.storeName),a=!1,c=s.openKeyCursor();c.onsuccess=function(){var r=c.result;r?0===e||a?t(r.key):(a=!0,r.advance(e)):t(null)},c.onerror=function(){n(c.error)}}catch(e){n(e)}}))})).catch(n)}));return a(n,t),n},keys:function(e){var t=this,r=new s((function(e,r){t.ready().then((function(){I(t._dbInfo,"readonly",(function(n,o){if(n)return r(n);try{var i=o.objectStore(t._dbInfo.storeName).openKeyCursor(),s=[];i.onsuccess=function(){var t=i.result;t?(s.push(t.key),t.continue()):e(s)},i.onerror=function(){r(i.error)}}catch(e){r(e)}}))})).catch(r)}));return a(r,e),r},dropInstance:function(e,t){t=l.apply(this,arguments);var r=this.config();(e="function"!=typeof e&&e||{}).name||(e.name=e.name||r.name,e.storeName=e.storeName||r.storeName);var n,i=this;if(e.name){var c=e.name===r.name&&i._dbInfo.db,u=c?s.resolve(i._dbInfo.db):_(e).then((function(t){var r=h[e.name],n=r.forages;r.db=t;for(var o=0;o<n.length;o++)n[o]._dbInfo.db=t;return t}));n=e.storeName?u.then((function(t){if(t.objectStoreNames.contains(e.storeName)){var r=t.version+1;m(e);var n=h[e.name],i=n.forages;t.close();for(var a=0;a<i.length;a++){var c=i[a];c._dbInfo.db=null,c._dbInfo.version=r}return new s((function(t,n){var i=o.open(e.name,r);i.onerror=function(e){i.result.close(),n(e)},i.onupgradeneeded=function(){i.result.deleteObjectStore(e.storeName)},i.onsuccess=function(){var e=i.result;e.close(),t(e)}})).then((function(e){n.db=e;for(var t=0;t<i.length;t++){var r=i[t];r._dbInfo.db=e,g(r._dbInfo)}})).catch((function(t){throw(v(e,t)||s.resolve()).catch((function(){})),t}))}})):u.then((function(t){m(e);var r=h[e.name],n=r.forages;t.close();for(var i=0;i<n.length;i++)n[i]._dbInfo.db=null;return new s((function(t,r){var n=o.deleteDatabase(e.name);n.onerror=n.onblocked=function(e){var t=n.result;t&&t.close(),r(e)},n.onsuccess=function(){var e=n.result;e&&e.close(),t(e)}})).then((function(e){r.db=e;for(var t=0;t<n.length;t++)g(n[t]._dbInfo)})).catch((function(t){throw(v(e,t)||s.resolve()).catch((function(){})),t}))}))}else n=s.reject("Invalid arguments");return a(n,t),n}},P="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",T=/^~~local_forage_type~([^~]+)~/,O="__lfsc__:".length,A=O+"arbf".length,D=Object.prototype.toString;function C(e){var t,r,n,o,i,s=.75*e.length,a=e.length,c=0;"="===e[e.length-1]&&(s--,"="===e[e.length-2]&&s--);var u=new ArrayBuffer(s),l=new Uint8Array(u);for(t=0;t<a;t+=4)r=P.indexOf(e[t]),n=P.indexOf(e[t+1]),o=P.indexOf(e[t+2]),i=P.indexOf(e[t+3]),l[c++]=r<<2|n>>4,l[c++]=(15&n)<<4|o>>2,l[c++]=(3&o)<<6|63&i;return u}function x(e){var t,r=new Uint8Array(e),n="";for(t=0;t<r.length;t+=3)n+=P[r[t]>>2],n+=P[(3&r[t])<<4|r[t+1]>>4],n+=P[(15&r[t+1])<<2|r[t+2]>>6],n+=P[63&r[t+2]];return r.length%3==2?n=n.substring(0,n.length-1)+"=":r.length%3==1&&(n=n.substring(0,n.length-2)+"=="),n}var M={serialize:function(e,t){var r="";if(e&&(r=D.call(e)),e&&("[object ArrayBuffer]"===r||e.buffer&&"[object ArrayBuffer]"===D.call(e.buffer))){var n,o="__lfsc__:";e instanceof ArrayBuffer?(n=e,o+="arbf"):(n=e.buffer,"[object Int8Array]"===r?o+="si08":"[object Uint8Array]"===r?o+="ui08":"[object Uint8ClampedArray]"===r?o+="uic8":"[object Int16Array]"===r?o+="si16":"[object Uint16Array]"===r?o+="ur16":"[object Int32Array]"===r?o+="si32":"[object Uint32Array]"===r?o+="ui32":"[object Float32Array]"===r?o+="fl32":"[object Float64Array]"===r?o+="fl64":t(new Error("Failed to get type for BinaryArray"))),t(o+x(n))}else if("[object Blob]"===r){var i=new FileReader;i.onload=function(){var r="~~local_forage_type~"+e.type+"~"+x(this.result);t("__lfsc__:blob"+r)},i.readAsArrayBuffer(e)}else try{t(JSON.stringify(e))}catch(r){console.error("Couldn't convert value into a JSON string: ",e),t(null,r)}},deserialize:function(e){if("__lfsc__:"!==e.substring(0,O))return JSON.parse(e);var t,r=e.substring(A),n=e.substring(O,A);if("blob"===n&&T.test(r)){var o=r.match(T);t=o[1],r=r.substring(o[0].length)}var s=C(r);switch(n){case"arbf":return s;case"blob":return i([s],{type:t});case"si08":return new Int8Array(s);case"ui08":return new Uint8Array(s);case"uic8":return new Uint8ClampedArray(s);case"si16":return new Int16Array(s);case"ur16":return new Uint16Array(s);case"si32":return new Int32Array(s);case"ui32":return new Uint32Array(s);case"fl32":return new Float32Array(s);case"fl64":return new Float64Array(s);default:throw new Error("Unkown type: "+n)}},stringToBuffer:C,bufferToString:x};function j(e,t,r,n){e.executeSql("CREATE TABLE IF NOT EXISTS "+t.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],r,n)}function U(e,t,r,n,o,i){e.executeSql(r,n,o,(function(e,s){s.code===s.SYNTAX_ERR?e.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[t.storeName],(function(e,a){a.rows.length?i(e,s):j(e,t,(function(){e.executeSql(r,n,o,i)}),i)}),i):i(e,s)}),i)}function N(e,t,r,n){var o=this;e=u(e);var i=new s((function(i,s){o.ready().then((function(){void 0===t&&(t=null);var a=t,c=o._dbInfo;c.serializer.serialize(t,(function(t,u){u?s(u):c.db.transaction((function(r){U(r,c,"INSERT OR REPLACE INTO "+c.storeName+" (key, value) VALUES (?, ?)",[e,t],(function(){i(a)}),(function(e,t){s(t)}))}),(function(t){if(t.code===t.QUOTA_ERR){if(n>0)return void i(N.apply(o,[e,a,r,n-1]));s(t)}}))}))})).catch(s)}));return a(i,r),i}function F(e){return new s((function(t,r){e.transaction((function(n){n.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],(function(r,n){for(var o=[],i=0;i<n.rows.length;i++)o.push(n.rows.item(i).name);t({db:e,storeNames:o})}),(function(e,t){r(t)}))}),(function(e){r(e)}))}))}var L={_driver:"webSQLStorage",_initStorage:function(e){var t=this,r={db:null};if(e)for(var n in e)r[n]="string"!=typeof e[n]?e[n].toString():e[n];var o=new s((function(e,n){try{r.db=openDatabase(r.name,String(r.version),r.description,r.size)}catch(e){return n(e)}r.db.transaction((function(o){j(o,r,(function(){t._dbInfo=r,e()}),(function(e,t){n(t)}))}),n)}));return r.serializer=M,o},_support:"function"==typeof openDatabase,iterate:function(e,t){var r=this,n=new s((function(t,n){r.ready().then((function(){var o=r._dbInfo;o.db.transaction((function(r){U(r,o,"SELECT * FROM "+o.storeName,[],(function(r,n){for(var i=n.rows,s=i.length,a=0;a<s;a++){var c=i.item(a),u=c.value;if(u&&(u=o.serializer.deserialize(u)),void 0!==(u=e(u,c.key,a+1)))return void t(u)}t()}),(function(e,t){n(t)}))}))})).catch(n)}));return a(n,t),n},getItem:function(e,t){var r=this;e=u(e);var n=new s((function(t,n){r.ready().then((function(){var o=r._dbInfo;o.db.transaction((function(r){U(r,o,"SELECT * FROM "+o.storeName+" WHERE key = ? LIMIT 1",[e],(function(e,r){var n=r.rows.length?r.rows.item(0).value:null;n&&(n=o.serializer.deserialize(n)),t(n)}),(function(e,t){n(t)}))}))})).catch(n)}));return a(n,t),n},setItem:function(e,t,r){return N.apply(this,[e,t,r,1])},removeItem:function(e,t){var r=this;e=u(e);var n=new s((function(t,n){r.ready().then((function(){var o=r._dbInfo;o.db.transaction((function(r){U(r,o,"DELETE FROM "+o.storeName+" WHERE key = ?",[e],(function(){t()}),(function(e,t){n(t)}))}))})).catch(n)}));return a(n,t),n},clear:function(e){var t=this,r=new s((function(e,r){t.ready().then((function(){var n=t._dbInfo;n.db.transaction((function(t){U(t,n,"DELETE FROM "+n.storeName,[],(function(){e()}),(function(e,t){r(t)}))}))})).catch(r)}));return a(r,e),r},length:function(e){var t=this,r=new s((function(e,r){t.ready().then((function(){var n=t._dbInfo;n.db.transaction((function(t){U(t,n,"SELECT COUNT(key) as c FROM "+n.storeName,[],(function(t,r){var n=r.rows.item(0).c;e(n)}),(function(e,t){r(t)}))}))})).catch(r)}));return a(r,e),r},key:function(e,t){var r=this,n=new s((function(t,n){r.ready().then((function(){var o=r._dbInfo;o.db.transaction((function(r){U(r,o,"SELECT key FROM "+o.storeName+" WHERE id = ? LIMIT 1",[e+1],(function(e,r){var n=r.rows.length?r.rows.item(0).key:null;t(n)}),(function(e,t){n(t)}))}))})).catch(n)}));return a(n,t),n},keys:function(e){var t=this,r=new s((function(e,r){t.ready().then((function(){var n=t._dbInfo;n.db.transaction((function(t){U(t,n,"SELECT key FROM "+n.storeName,[],(function(t,r){for(var n=[],o=0;o<r.rows.length;o++)n.push(r.rows.item(o).key);e(n)}),(function(e,t){r(t)}))}))})).catch(r)}));return a(r,e),r},dropInstance:function(e,t){t=l.apply(this,arguments);var r=this.config();(e="function"!=typeof e&&e||{}).name||(e.name=e.name||r.name,e.storeName=e.storeName||r.storeName);var n,o=this;return a(n=e.name?new s((function(t){var n;n=e.name===r.name?o._dbInfo.db:openDatabase(e.name,"","",0),e.storeName?t({db:n,storeNames:[e.storeName]}):t(F(n))})).then((function(e){return new s((function(t,r){e.db.transaction((function(n){function o(e){return new s((function(t,r){n.executeSql("DROP TABLE IF EXISTS "+e,[],(function(){t()}),(function(e,t){r(t)}))}))}for(var i=[],a=0,c=e.storeNames.length;a<c;a++)i.push(o(e.storeNames[a]));s.all(i).then((function(){t()})).catch((function(e){r(e)}))}),(function(e){r(e)}))}))})):s.reject("Invalid arguments"),t),n}};function K(e,t){var r=e.name+"/";return e.storeName!==t.storeName&&(r+=e.storeName+"/"),r}function B(){return!function(){try{return localStorage.setItem("_localforage_support_test",!0),localStorage.removeItem("_localforage_support_test"),!1}catch(e){return!0}}()||localStorage.length>0}var q={_driver:"localStorageWrapper",_initStorage:function(e){var t={};if(e)for(var r in e)t[r]=e[r];return t.keyPrefix=K(e,this._defaultConfig),B()?(this._dbInfo=t,t.serializer=M,s.resolve()):s.reject()},_support:function(){try{return"undefined"!=typeof localStorage&&"setItem"in localStorage&&!!localStorage.setItem}catch(e){return!1}}(),iterate:function(e,t){var r=this,n=r.ready().then((function(){for(var t=r._dbInfo,n=t.keyPrefix,o=n.length,i=localStorage.length,s=1,a=0;a<i;a++){var c=localStorage.key(a);if(0===c.indexOf(n)){var u=localStorage.getItem(c);if(u&&(u=t.serializer.deserialize(u)),void 0!==(u=e(u,c.substring(o),s++)))return u}}}));return a(n,t),n},getItem:function(e,t){var r=this;e=u(e);var n=r.ready().then((function(){var t=r._dbInfo,n=localStorage.getItem(t.keyPrefix+e);return n&&(n=t.serializer.deserialize(n)),n}));return a(n,t),n},setItem:function(e,t,r){var n=this;e=u(e);var o=n.ready().then((function(){void 0===t&&(t=null);var r=t;return new s((function(o,i){var s=n._dbInfo;s.serializer.serialize(t,(function(t,n){if(n)i(n);else try{localStorage.setItem(s.keyPrefix+e,t),o(r)}catch(e){"QuotaExceededError"!==e.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==e.name||i(e),i(e)}}))}))}));return a(o,r),o},removeItem:function(e,t){var r=this;e=u(e);var n=r.ready().then((function(){var t=r._dbInfo;localStorage.removeItem(t.keyPrefix+e)}));return a(n,t),n},clear:function(e){var t=this,r=t.ready().then((function(){for(var e=t._dbInfo.keyPrefix,r=localStorage.length-1;r>=0;r--){var n=localStorage.key(r);0===n.indexOf(e)&&localStorage.removeItem(n)}}));return a(r,e),r},length:function(e){var t=this.keys().then((function(e){return e.length}));return a(t,e),t},key:function(e,t){var r=this,n=r.ready().then((function(){var t,n=r._dbInfo;try{t=localStorage.key(e)}catch(e){t=null}return t&&(t=t.substring(n.keyPrefix.length)),t}));return a(n,t),n},keys:function(e){var t=this,r=t.ready().then((function(){for(var e=t._dbInfo,r=localStorage.length,n=[],o=0;o<r;o++){var i=localStorage.key(o);0===i.indexOf(e.keyPrefix)&&n.push(i.substring(e.keyPrefix.length))}return n}));return a(r,e),r},dropInstance:function(e,t){if(t=l.apply(this,arguments),!(e="function"!=typeof e&&e||{}).name){var r=this.config();e.name=e.name||r.name,e.storeName=e.storeName||r.storeName}var n,o=this;return a(n=e.name?new s((function(t){e.storeName?t(K(e,o._defaultConfig)):t(e.name+"/")})).then((function(e){for(var t=localStorage.length-1;t>=0;t--){var r=localStorage.key(t);0===r.indexOf(e)&&localStorage.removeItem(r)}})):s.reject("Invalid arguments"),t),n}},$=function(e,t){for(var r,n,o=e.length,i=0;i<o;){if((r=e[i])===(n=t)||"number"==typeof r&&"number"==typeof n&&isNaN(r)&&isNaN(n))return!0;i++}return!1},V=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},G={},H={},z={INDEXEDDB:k,WEBSQL:L,LOCALSTORAGE:q},W=[z.INDEXEDDB._driver,z.WEBSQL._driver,z.LOCALSTORAGE._driver],Q=["dropInstance"],Y=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(Q),X={description:"",driver:W.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function J(e,t){e[t]=function(){var r=arguments;return e.ready().then((function(){return e[t].apply(e,r)}))}}function Z(){for(var e=1;e<arguments.length;e++){var t=arguments[e];if(t)for(var r in t)t.hasOwnProperty(r)&&(V(t[r])?arguments[0][r]=t[r].slice():arguments[0][r]=t[r])}return arguments[0]}var ee=new(function(){function e(t){for(var r in function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),z)if(z.hasOwnProperty(r)){var n=z[r],o=n._driver;this[r]=o,G[o]||this.defineDriver(n)}this._defaultConfig=Z({},X),this._config=Z({},this._defaultConfig,t),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch((function(){}))}return e.prototype.config=function(e){if("object"===(void 0===e?"undefined":n(e))){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var t in e){if("storeName"===t&&(e[t]=e[t].replace(/\W/g,"_")),"version"===t&&"number"!=typeof e[t])return new Error("Database version must be a number.");this._config[t]=e[t]}return!("driver"in e)||!e.driver||this.setDriver(this._config.driver)}return"string"==typeof e?this._config[e]:this._config},e.prototype.defineDriver=function(e,t,r){var n=new s((function(t,r){try{var n=e._driver,o=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!e._driver)return void r(o);for(var i=Y.concat("_initStorage"),c=0,u=i.length;c<u;c++){var l=i[c];if((!$(Q,l)||e[l])&&"function"!=typeof e[l])return void r(o)}!function(){for(var t=function(e){return function(){var t=new Error("Method "+e+" is not implemented by the current driver"),r=s.reject(t);return a(r,arguments[arguments.length-1]),r}},r=0,n=Q.length;r<n;r++){var o=Q[r];e[o]||(e[o]=t(o))}}();var d=function(r){G[n]&&console.info("Redefining LocalForage driver: "+n),G[n]=e,H[n]=r,t()};"_support"in e?e._support&&"function"==typeof e._support?e._support().then(d,r):d(!!e._support):d(!0)}catch(e){r(e)}}));return c(n,t,r),n},e.prototype.driver=function(){return this._driver||null},e.prototype.getDriver=function(e,t,r){var n=G[e]?s.resolve(G[e]):s.reject(new Error("Driver not found."));return c(n,t,r),n},e.prototype.getSerializer=function(e){var t=s.resolve(M);return c(t,e),t},e.prototype.ready=function(e){var t=this,r=t._driverSet.then((function(){return null===t._ready&&(t._ready=t._initDriver()),t._ready}));return c(r,e,e),r},e.prototype.setDriver=function(e,t,r){var n=this;V(e)||(e=[e]);var o=this._getSupportedDrivers(e);function i(){n._config.driver=n.driver()}function a(e){return n._extend(e),i(),n._ready=n._initStorage(n._config),n._ready}var u=null!==this._driverSet?this._driverSet.catch((function(){return s.resolve()})):s.resolve();return this._driverSet=u.then((function(){var e=o[0];return n._dbInfo=null,n._ready=null,n.getDriver(e).then((function(e){n._driver=e._driver,i(),n._wrapLibraryMethodsWithReady(),n._initDriver=function(e){return function(){var t=0;return function r(){for(;t<e.length;){var o=e[t];return t++,n._dbInfo=null,n._ready=null,n.getDriver(o).then(a).catch(r)}i();var c=new Error("No available storage method found.");return n._driverSet=s.reject(c),n._driverSet}()}}(o)}))})).catch((function(){i();var e=new Error("No available storage method found.");return n._driverSet=s.reject(e),n._driverSet})),c(this._driverSet,t,r),this._driverSet},e.prototype.supports=function(e){return!!H[e]},e.prototype._extend=function(e){Z(this,e)},e.prototype._getSupportedDrivers=function(e){for(var t=[],r=0,n=e.length;r<n;r++){var o=e[r];this.supports(o)&&t.push(o)}return t},e.prototype._wrapLibraryMethodsWithReady=function(){for(var e=0,t=Y.length;e<t;e++)J(this,Y[e])},e.prototype.createInstance=function(t){return new e(t)},e}());t.exports=ee},{3:3}]},{},[4])(4)}).call(this,r(8))},function(module,exports,__webpack_require__){(function(process,global){var __WEBPACK_AMD_DEFINE_RESULT__;
/**
 * [js-sha256]{@link https://github.com/emn178/js-sha256}
 *
 * @version 0.9.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2017
 * @license MIT
 */!function(){"use strict";var ERROR="input is invalid type",WINDOW="object"==typeof window,root=WINDOW?window:{};root.JS_SHA256_NO_WINDOW&&(WINDOW=!1);var WEB_WORKER=!WINDOW&&"object"==typeof self,NODE_JS=!root.JS_SHA256_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node;NODE_JS?root=global:WEB_WORKER&&(root=self);var COMMON_JS=!root.JS_SHA256_NO_COMMON_JS&&"object"==typeof module&&module.exports,AMD=__webpack_require__(180),ARRAY_BUFFER=!root.JS_SHA256_NO_ARRAY_BUFFER&&"undefined"!=typeof ArrayBuffer,HEX_CHARS="0123456789abcdef".split(""),EXTRA=[-2147483648,8388608,32768,128],SHIFT=[24,16,8,0],K=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],OUTPUT_TYPES=["hex","array","digest","arrayBuffer"],blocks=[];!root.JS_SHA256_NO_NODE_JS&&Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),!ARRAY_BUFFER||!root.JS_SHA256_NO_ARRAY_BUFFER_IS_VIEW&&ArrayBuffer.isView||(ArrayBuffer.isView=function(e){return"object"==typeof e&&e.buffer&&e.buffer.constructor===ArrayBuffer});var createOutputMethod=function(e,t){return function(r){return new Sha256(t,!0).update(r)[e]()}},createMethod=function(e){var t=createOutputMethod("hex",e);NODE_JS&&(t=nodeWrap(t,e)),t.create=function(){return new Sha256(e)},t.update=function(e){return t.create().update(e)};for(var r=0;r<OUTPUT_TYPES.length;++r){var n=OUTPUT_TYPES[r];t[n]=createOutputMethod(n,e)}return t},nodeWrap=function(method,is224){var crypto=eval("require('crypto')"),Buffer=eval("require('buffer').Buffer"),algorithm=is224?"sha224":"sha256",nodeMethod=function(e){if("string"==typeof e)return crypto.createHash(algorithm).update(e,"utf8").digest("hex");if(null==e)throw new Error(ERROR);return e.constructor===ArrayBuffer&&(e=new Uint8Array(e)),Array.isArray(e)||ArrayBuffer.isView(e)||e.constructor===Buffer?crypto.createHash(algorithm).update(new Buffer(e)).digest("hex"):method(e)};return nodeMethod},createHmacOutputMethod=function(e,t){return function(r,n){return new HmacSha256(r,t,!0).update(n)[e]()}},createHmacMethod=function(e){var t=createHmacOutputMethod("hex",e);t.create=function(t){return new HmacSha256(t,e)},t.update=function(e,r){return t.create(e).update(r)};for(var r=0;r<OUTPUT_TYPES.length;++r){var n=OUTPUT_TYPES[r];t[n]=createHmacOutputMethod(n,e)}return t};function Sha256(e,t){t?(blocks[0]=blocks[16]=blocks[1]=blocks[2]=blocks[3]=blocks[4]=blocks[5]=blocks[6]=blocks[7]=blocks[8]=blocks[9]=blocks[10]=blocks[11]=blocks[12]=blocks[13]=blocks[14]=blocks[15]=0,this.blocks=blocks):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=e}function HmacSha256(e,t,r){var n,o=typeof e;if("string"===o){var i,s=[],a=e.length,c=0;for(n=0;n<a;++n)(i=e.charCodeAt(n))<128?s[c++]=i:i<2048?(s[c++]=192|i>>6,s[c++]=128|63&i):i<55296||i>=57344?(s[c++]=224|i>>12,s[c++]=128|i>>6&63,s[c++]=128|63&i):(i=65536+((1023&i)<<10|1023&e.charCodeAt(++n)),s[c++]=240|i>>18,s[c++]=128|i>>12&63,s[c++]=128|i>>6&63,s[c++]=128|63&i);e=s}else{if("object"!==o)throw new Error(ERROR);if(null===e)throw new Error(ERROR);if(ARRAY_BUFFER&&e.constructor===ArrayBuffer)e=new Uint8Array(e);else if(!(Array.isArray(e)||ARRAY_BUFFER&&ArrayBuffer.isView(e)))throw new Error(ERROR)}e.length>64&&(e=new Sha256(t,!0).update(e).array());var u=[],l=[];for(n=0;n<64;++n){var d=e[n]||0;u[n]=92^d,l[n]=54^d}Sha256.call(this,t,r),this.update(l),this.oKeyPad=u,this.inner=!0,this.sharedMemory=r}Sha256.prototype.update=function(e){if(!this.finalized){var t,r=typeof e;if("string"!==r){if("object"!==r)throw new Error(ERROR);if(null===e)throw new Error(ERROR);if(ARRAY_BUFFER&&e.constructor===ArrayBuffer)e=new Uint8Array(e);else if(!(Array.isArray(e)||ARRAY_BUFFER&&ArrayBuffer.isView(e)))throw new Error(ERROR);t=!0}for(var n,o,i=0,s=e.length,a=this.blocks;i<s;){if(this.hashed&&(this.hashed=!1,a[0]=this.block,a[16]=a[1]=a[2]=a[3]=a[4]=a[5]=a[6]=a[7]=a[8]=a[9]=a[10]=a[11]=a[12]=a[13]=a[14]=a[15]=0),t)for(o=this.start;i<s&&o<64;++i)a[o>>2]|=e[i]<<SHIFT[3&o++];else for(o=this.start;i<s&&o<64;++i)(n=e.charCodeAt(i))<128?a[o>>2]|=n<<SHIFT[3&o++]:n<2048?(a[o>>2]|=(192|n>>6)<<SHIFT[3&o++],a[o>>2]|=(128|63&n)<<SHIFT[3&o++]):n<55296||n>=57344?(a[o>>2]|=(224|n>>12)<<SHIFT[3&o++],a[o>>2]|=(128|n>>6&63)<<SHIFT[3&o++],a[o>>2]|=(128|63&n)<<SHIFT[3&o++]):(n=65536+((1023&n)<<10|1023&e.charCodeAt(++i)),a[o>>2]|=(240|n>>18)<<SHIFT[3&o++],a[o>>2]|=(128|n>>12&63)<<SHIFT[3&o++],a[o>>2]|=(128|n>>6&63)<<SHIFT[3&o++],a[o>>2]|=(128|63&n)<<SHIFT[3&o++]);this.lastByteIndex=o,this.bytes+=o-this.start,o>=64?(this.block=a[16],this.start=o-64,this.hash(),this.hashed=!0):this.start=o}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},Sha256.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=EXTRA[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},Sha256.prototype.hash=function(){var e,t,r,n,o,i,s,a,c,u=this.h0,l=this.h1,d=this.h2,h=this.h3,p=this.h4,f=this.h5,m=this.h6,g=this.h7,v=this.blocks;for(e=16;e<64;++e)t=((o=v[e-15])>>>7|o<<25)^(o>>>18|o<<14)^o>>>3,r=((o=v[e-2])>>>17|o<<15)^(o>>>19|o<<13)^o>>>10,v[e]=v[e-16]+t+v[e-7]+r<<0;for(c=l&d,e=0;e<64;e+=4)this.first?(this.is224?(i=300032,g=(o=v[0]-1413257819)-150054599<<0,h=o+24177077<<0):(i=704751109,g=(o=v[0]-210244248)-1521486534<<0,h=o+143694565<<0),this.first=!1):(t=(u>>>2|u<<30)^(u>>>13|u<<19)^(u>>>22|u<<10),n=(i=u&l)^u&d^c,g=h+(o=g+(r=(p>>>6|p<<26)^(p>>>11|p<<21)^(p>>>25|p<<7))+(p&f^~p&m)+K[e]+v[e])<<0,h=o+(t+n)<<0),t=(h>>>2|h<<30)^(h>>>13|h<<19)^(h>>>22|h<<10),n=(s=h&u)^h&l^i,m=d+(o=m+(r=(g>>>6|g<<26)^(g>>>11|g<<21)^(g>>>25|g<<7))+(g&p^~g&f)+K[e+1]+v[e+1])<<0,t=((d=o+(t+n)<<0)>>>2|d<<30)^(d>>>13|d<<19)^(d>>>22|d<<10),n=(a=d&h)^d&u^s,f=l+(o=f+(r=(m>>>6|m<<26)^(m>>>11|m<<21)^(m>>>25|m<<7))+(m&g^~m&p)+K[e+2]+v[e+2])<<0,t=((l=o+(t+n)<<0)>>>2|l<<30)^(l>>>13|l<<19)^(l>>>22|l<<10),n=(c=l&d)^l&h^a,p=u+(o=p+(r=(f>>>6|f<<26)^(f>>>11|f<<21)^(f>>>25|f<<7))+(f&m^~f&g)+K[e+3]+v[e+3])<<0,u=o+(t+n)<<0;this.h0=this.h0+u<<0,this.h1=this.h1+l<<0,this.h2=this.h2+d<<0,this.h3=this.h3+h<<0,this.h4=this.h4+p<<0,this.h5=this.h5+f<<0,this.h6=this.h6+m<<0,this.h7=this.h7+g<<0},Sha256.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,n=this.h3,o=this.h4,i=this.h5,s=this.h6,a=this.h7,c=HEX_CHARS[e>>28&15]+HEX_CHARS[e>>24&15]+HEX_CHARS[e>>20&15]+HEX_CHARS[e>>16&15]+HEX_CHARS[e>>12&15]+HEX_CHARS[e>>8&15]+HEX_CHARS[e>>4&15]+HEX_CHARS[15&e]+HEX_CHARS[t>>28&15]+HEX_CHARS[t>>24&15]+HEX_CHARS[t>>20&15]+HEX_CHARS[t>>16&15]+HEX_CHARS[t>>12&15]+HEX_CHARS[t>>8&15]+HEX_CHARS[t>>4&15]+HEX_CHARS[15&t]+HEX_CHARS[r>>28&15]+HEX_CHARS[r>>24&15]+HEX_CHARS[r>>20&15]+HEX_CHARS[r>>16&15]+HEX_CHARS[r>>12&15]+HEX_CHARS[r>>8&15]+HEX_CHARS[r>>4&15]+HEX_CHARS[15&r]+HEX_CHARS[n>>28&15]+HEX_CHARS[n>>24&15]+HEX_CHARS[n>>20&15]+HEX_CHARS[n>>16&15]+HEX_CHARS[n>>12&15]+HEX_CHARS[n>>8&15]+HEX_CHARS[n>>4&15]+HEX_CHARS[15&n]+HEX_CHARS[o>>28&15]+HEX_CHARS[o>>24&15]+HEX_CHARS[o>>20&15]+HEX_CHARS[o>>16&15]+HEX_CHARS[o>>12&15]+HEX_CHARS[o>>8&15]+HEX_CHARS[o>>4&15]+HEX_CHARS[15&o]+HEX_CHARS[i>>28&15]+HEX_CHARS[i>>24&15]+HEX_CHARS[i>>20&15]+HEX_CHARS[i>>16&15]+HEX_CHARS[i>>12&15]+HEX_CHARS[i>>8&15]+HEX_CHARS[i>>4&15]+HEX_CHARS[15&i]+HEX_CHARS[s>>28&15]+HEX_CHARS[s>>24&15]+HEX_CHARS[s>>20&15]+HEX_CHARS[s>>16&15]+HEX_CHARS[s>>12&15]+HEX_CHARS[s>>8&15]+HEX_CHARS[s>>4&15]+HEX_CHARS[15&s];return this.is224||(c+=HEX_CHARS[a>>28&15]+HEX_CHARS[a>>24&15]+HEX_CHARS[a>>20&15]+HEX_CHARS[a>>16&15]+HEX_CHARS[a>>12&15]+HEX_CHARS[a>>8&15]+HEX_CHARS[a>>4&15]+HEX_CHARS[15&a]),c},Sha256.prototype.toString=Sha256.prototype.hex,Sha256.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,n=this.h3,o=this.h4,i=this.h5,s=this.h6,a=this.h7,c=[e>>24&255,e>>16&255,e>>8&255,255&e,t>>24&255,t>>16&255,t>>8&255,255&t,r>>24&255,r>>16&255,r>>8&255,255&r,n>>24&255,n>>16&255,n>>8&255,255&n,o>>24&255,o>>16&255,o>>8&255,255&o,i>>24&255,i>>16&255,i>>8&255,255&i,s>>24&255,s>>16&255,s>>8&255,255&s];return this.is224||c.push(a>>24&255,a>>16&255,a>>8&255,255&a),c},Sha256.prototype.array=Sha256.prototype.digest,Sha256.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(this.is224?28:32),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),t.setUint32(20,this.h5),t.setUint32(24,this.h6),this.is224||t.setUint32(28,this.h7),e},HmacSha256.prototype=new Sha256,HmacSha256.prototype.finalize=function(){if(Sha256.prototype.finalize.call(this),this.inner){this.inner=!1;var e=this.array();Sha256.call(this,this.is224,this.sharedMemory),this.update(this.oKeyPad),this.update(e),Sha256.prototype.finalize.call(this)}};var exports=createMethod();exports.sha256=exports,exports.sha224=createMethod(!0),exports.sha256.hmac=createHmacMethod(),exports.sha224.hmac=createHmacMethod(!0),COMMON_JS?module.exports=exports:(root.sha256=exports.sha256,root.sha224=exports.sha224,AMD&&(__WEBPACK_AMD_DEFINE_RESULT__=function(){return exports}.call(exports,__webpack_require__,exports,module),void 0===__WEBPACK_AMD_DEFINE_RESULT__||(module.exports=__WEBPACK_AMD_DEFINE_RESULT__)))}()}).call(this,__webpack_require__(179),__webpack_require__(8))},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t,r){var n=r(86),o={};for(var i in n)n.hasOwnProperty(i)&&(o[n[i]]=i);var s=e.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var a in s)if(s.hasOwnProperty(a)){if(!("channels"in s[a]))throw new Error("missing channels property: "+a);if(!("labels"in s[a]))throw new Error("missing channel labels property: "+a);if(s[a].labels.length!==s[a].channels)throw new Error("channel and label counts mismatch: "+a);var c=s[a].channels,u=s[a].labels;delete s[a].channels,delete s[a].labels,Object.defineProperty(s[a],"channels",{value:c}),Object.defineProperty(s[a],"labels",{value:u})}s.rgb.hsl=function(e){var t,r,n=e[0]/255,o=e[1]/255,i=e[2]/255,s=Math.min(n,o,i),a=Math.max(n,o,i),c=a-s;return a===s?t=0:n===a?t=(o-i)/c:o===a?t=2+(i-n)/c:i===a&&(t=4+(n-o)/c),(t=Math.min(60*t,360))<0&&(t+=360),r=(s+a)/2,[t,100*(a===s?0:r<=.5?c/(a+s):c/(2-a-s)),100*r]},s.rgb.hsv=function(e){var t,r,n,o,i,s=e[0]/255,a=e[1]/255,c=e[2]/255,u=Math.max(s,a,c),l=u-Math.min(s,a,c),d=function(e){return(u-e)/6/l+.5};return 0===l?o=i=0:(i=l/u,t=d(s),r=d(a),n=d(c),s===u?o=n-r:a===u?o=1/3+t-n:c===u&&(o=2/3+r-t),o<0?o+=1:o>1&&(o-=1)),[360*o,100*i,100*u]},s.rgb.hwb=function(e){var t=e[0],r=e[1],n=e[2];return[s.rgb.hsl(e)[0],100*(1/255*Math.min(t,Math.min(r,n))),100*(n=1-1/255*Math.max(t,Math.max(r,n)))]},s.rgb.cmyk=function(e){var t,r=e[0]/255,n=e[1]/255,o=e[2]/255;return[100*((1-r-(t=Math.min(1-r,1-n,1-o)))/(1-t)||0),100*((1-n-t)/(1-t)||0),100*((1-o-t)/(1-t)||0),100*t]},s.rgb.keyword=function(e){var t=o[e];if(t)return t;var r,i,s,a=1/0;for(var c in n)if(n.hasOwnProperty(c)){var u=n[c],l=(i=e,s=u,Math.pow(i[0]-s[0],2)+Math.pow(i[1]-s[1],2)+Math.pow(i[2]-s[2],2));l<a&&(a=l,r=c)}return r},s.keyword.rgb=function(e){return n[e]},s.rgb.xyz=function(e){var t=e[0]/255,r=e[1]/255,n=e[2]/255;return[100*(.4124*(t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92)+.3576*(r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92)+.1805*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)),100*(.2126*t+.7152*r+.0722*n),100*(.0193*t+.1192*r+.9505*n)]},s.rgb.lab=function(e){var t=s.rgb.xyz(e),r=t[0],n=t[1],o=t[2];return n/=100,o/=108.883,r=(r/=95.047)>.008856?Math.pow(r,1/3):7.787*r+16/116,[116*(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116)-16,500*(r-n),200*(n-(o=o>.008856?Math.pow(o,1/3):7.787*o+16/116))]},s.hsl.rgb=function(e){var t,r,n,o,i,s=e[0]/360,a=e[1]/100,c=e[2]/100;if(0===a)return[i=255*c,i,i];t=2*c-(r=c<.5?c*(1+a):c+a-c*a),o=[0,0,0];for(var u=0;u<3;u++)(n=s+1/3*-(u-1))<0&&n++,n>1&&n--,i=6*n<1?t+6*(r-t)*n:2*n<1?r:3*n<2?t+(r-t)*(2/3-n)*6:t,o[u]=255*i;return o},s.hsl.hsv=function(e){var t=e[0],r=e[1]/100,n=e[2]/100,o=r,i=Math.max(n,.01);return r*=(n*=2)<=1?n:2-n,o*=i<=1?i:2-i,[t,100*(0===n?2*o/(i+o):2*r/(n+r)),100*((n+r)/2)]},s.hsv.rgb=function(e){var t=e[0]/60,r=e[1]/100,n=e[2]/100,o=Math.floor(t)%6,i=t-Math.floor(t),s=255*n*(1-r),a=255*n*(1-r*i),c=255*n*(1-r*(1-i));switch(n*=255,o){case 0:return[n,c,s];case 1:return[a,n,s];case 2:return[s,n,c];case 3:return[s,a,n];case 4:return[c,s,n];case 5:return[n,s,a]}},s.hsv.hsl=function(e){var t,r,n,o=e[0],i=e[1]/100,s=e[2]/100,a=Math.max(s,.01);return n=(2-i)*s,r=i*a,[o,100*(r=(r/=(t=(2-i)*a)<=1?t:2-t)||0),100*(n/=2)]},s.hwb.rgb=function(e){var t,r,n,o,i,s,a,c=e[0]/360,u=e[1]/100,l=e[2]/100,d=u+l;switch(d>1&&(u/=d,l/=d),n=6*c-(t=Math.floor(6*c)),0!=(1&t)&&(n=1-n),o=u+n*((r=1-l)-u),t){default:case 6:case 0:i=r,s=o,a=u;break;case 1:i=o,s=r,a=u;break;case 2:i=u,s=r,a=o;break;case 3:i=u,s=o,a=r;break;case 4:i=o,s=u,a=r;break;case 5:i=r,s=u,a=o}return[255*i,255*s,255*a]},s.cmyk.rgb=function(e){var t=e[0]/100,r=e[1]/100,n=e[2]/100,o=e[3]/100;return[255*(1-Math.min(1,t*(1-o)+o)),255*(1-Math.min(1,r*(1-o)+o)),255*(1-Math.min(1,n*(1-o)+o))]},s.xyz.rgb=function(e){var t,r,n,o=e[0]/100,i=e[1]/100,s=e[2]/100;return r=-.9689*o+1.8758*i+.0415*s,n=.0557*o+-.204*i+1.057*s,t=(t=3.2406*o+-1.5372*i+-.4986*s)>.0031308?1.055*Math.pow(t,1/2.4)-.055:12.92*t,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,[255*(t=Math.min(Math.max(0,t),1)),255*(r=Math.min(Math.max(0,r),1)),255*(n=Math.min(Math.max(0,n),1))]},s.xyz.lab=function(e){var t=e[0],r=e[1],n=e[2];return r/=100,n/=108.883,t=(t/=95.047)>.008856?Math.pow(t,1/3):7.787*t+16/116,[116*(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116)-16,500*(t-r),200*(r-(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116))]},s.lab.xyz=function(e){var t,r,n,o=e[0];t=e[1]/500+(r=(o+16)/116),n=r-e[2]/200;var i=Math.pow(r,3),s=Math.pow(t,3),a=Math.pow(n,3);return r=i>.008856?i:(r-16/116)/7.787,t=s>.008856?s:(t-16/116)/7.787,n=a>.008856?a:(n-16/116)/7.787,[t*=95.047,r*=100,n*=108.883]},s.lab.lch=function(e){var t,r=e[0],n=e[1],o=e[2];return(t=360*Math.atan2(o,n)/2/Math.PI)<0&&(t+=360),[r,Math.sqrt(n*n+o*o),t]},s.lch.lab=function(e){var t,r=e[0],n=e[1];return t=e[2]/360*2*Math.PI,[r,n*Math.cos(t),n*Math.sin(t)]},s.rgb.ansi16=function(e){var t=e[0],r=e[1],n=e[2],o=1 in arguments?arguments[1]:s.rgb.hsv(e)[2];if(0===(o=Math.round(o/50)))return 30;var i=30+(Math.round(n/255)<<2|Math.round(r/255)<<1|Math.round(t/255));return 2===o&&(i+=60),i},s.hsv.ansi16=function(e){return s.rgb.ansi16(s.hsv.rgb(e),e[2])},s.rgb.ansi256=function(e){var t=e[0],r=e[1],n=e[2];return t===r&&r===n?t<8?16:t>248?231:Math.round((t-8)/247*24)+232:16+36*Math.round(t/255*5)+6*Math.round(r/255*5)+Math.round(n/255*5)},s.ansi16.rgb=function(e){var t=e%10;if(0===t||7===t)return e>50&&(t+=3.5),[t=t/10.5*255,t,t];var r=.5*(1+~~(e>50));return[(1&t)*r*255,(t>>1&1)*r*255,(t>>2&1)*r*255]},s.ansi256.rgb=function(e){if(e>=232){var t=10*(e-232)+8;return[t,t,t]}var r;return e-=16,[Math.floor(e/36)/5*255,Math.floor((r=e%36)/6)/5*255,r%6/5*255]},s.rgb.hex=function(e){var t=(((255&Math.round(e[0]))<<16)+((255&Math.round(e[1]))<<8)+(255&Math.round(e[2]))).toString(16).toUpperCase();return"000000".substring(t.length)+t},s.hex.rgb=function(e){var t=e.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!t)return[0,0,0];var r=t[0];3===t[0].length&&(r=r.split("").map((function(e){return e+e})).join(""));var n=parseInt(r,16);return[n>>16&255,n>>8&255,255&n]},s.rgb.hcg=function(e){var t,r=e[0]/255,n=e[1]/255,o=e[2]/255,i=Math.max(Math.max(r,n),o),s=Math.min(Math.min(r,n),o),a=i-s;return t=a<=0?0:i===r?(n-o)/a%6:i===n?2+(o-r)/a:4+(r-n)/a+4,t/=6,[360*(t%=1),100*a,100*(a<1?s/(1-a):0)]},s.hsl.hcg=function(e){var t=e[1]/100,r=e[2]/100,n=1,o=0;return(n=r<.5?2*t*r:2*t*(1-r))<1&&(o=(r-.5*n)/(1-n)),[e[0],100*n,100*o]},s.hsv.hcg=function(e){var t=e[1]/100,r=e[2]/100,n=t*r,o=0;return n<1&&(o=(r-n)/(1-n)),[e[0],100*n,100*o]},s.hcg.rgb=function(e){var t=e[0]/360,r=e[1]/100,n=e[2]/100;if(0===r)return[255*n,255*n,255*n];var o,i=[0,0,0],s=t%1*6,a=s%1,c=1-a;switch(Math.floor(s)){case 0:i[0]=1,i[1]=a,i[2]=0;break;case 1:i[0]=c,i[1]=1,i[2]=0;break;case 2:i[0]=0,i[1]=1,i[2]=a;break;case 3:i[0]=0,i[1]=c,i[2]=1;break;case 4:i[0]=a,i[1]=0,i[2]=1;break;default:i[0]=1,i[1]=0,i[2]=c}return o=(1-r)*n,[255*(r*i[0]+o),255*(r*i[1]+o),255*(r*i[2]+o)]},s.hcg.hsv=function(e){var t=e[1]/100,r=t+e[2]/100*(1-t),n=0;return r>0&&(n=t/r),[e[0],100*n,100*r]},s.hcg.hsl=function(e){var t=e[1]/100,r=e[2]/100*(1-t)+.5*t,n=0;return r>0&&r<.5?n=t/(2*r):r>=.5&&r<1&&(n=t/(2*(1-r))),[e[0],100*n,100*r]},s.hcg.hwb=function(e){var t=e[1]/100,r=t+e[2]/100*(1-t);return[e[0],100*(r-t),100*(1-r)]},s.hwb.hcg=function(e){var t=e[1]/100,r=1-e[2]/100,n=r-t,o=0;return n<1&&(o=(r-n)/(1-n)),[e[0],100*n,100*o]},s.apple.rgb=function(e){return[e[0]/65535*255,e[1]/65535*255,e[2]/65535*255]},s.rgb.apple=function(e){return[e[0]/255*65535,e[1]/255*65535,e[2]/255*65535]},s.gray.rgb=function(e){return[e[0]/100*255,e[0]/100*255,e[0]/100*255]},s.gray.hsl=s.gray.hsv=function(e){return[0,0,e[0]]},s.gray.hwb=function(e){return[0,100,e[0]]},s.gray.cmyk=function(e){return[0,0,0,e[0]]},s.gray.lab=function(e){return[e[0],0,0]},s.gray.hex=function(e){var t=255&Math.round(e[0]/100*255),r=((t<<16)+(t<<8)+t).toString(16).toUpperCase();return"000000".substring(r.length)+r},s.rgb.gray=function(e){return[(e[0]+e[1]+e[2])/3/255*100]}},function(e,t,r){"use strict";var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.MemoryStore=a;var o=r(27),i=n(r(6));function s(e){return"string"==typeof e&&!!e&&"undefined"!==e&&"null"!==e||"number"==typeof e}function a(e){e=e||{},this.rooms={},this.groups={},this.users={},this.syncToken=null,this.filters={},this.accountData={},this.localStorage=e.localStorage,this._oobMembers={},this._clientOptions={}}a.prototype={getSyncToken:function(){return this.syncToken},isNewlyCreated:function(){return Promise.resolve(!0)},setSyncToken:function(e){this.syncToken=e},storeGroup:function(e){this.groups[e.groupId]=e},getGroup:function(e){return this.groups[e]||null},getGroups:function(){return i.values(this.groups)},storeRoom:function(e){this.rooms[e.roomId]=e,e.currentState.on("RoomState.members",this._onRoomMember.bind(this));const t=this;e.currentState.getMembers().forEach((function(r){t._onRoomMember(null,e.currentState,r)}))},_onRoomMember:function(e,t,r){if("invite"===r.membership)return;const n=this.users[r.userId]||new o.User(r.userId);r.name&&(n.setDisplayName(r.name),r.events.member&&n.setRawDisplayName(r.events.member.getDirectionalContent().displayname)),r.events.member&&r.events.member.getContent().avatar_url&&n.setAvatarUrl(r.events.member.getContent().avatar_url),this.users[n.userId]=n},getRoom:function(e){return this.rooms[e]||null},getRooms:function(){return i.values(this.rooms)},removeRoom:function(e){this.rooms[e]&&this.rooms[e].removeListener("RoomState.members",this._onRoomMember),delete this.rooms[e]},getRoomSummaries:function(){return i.map(i.values(this.rooms),(function(e){return e.summary}))},storeUser:function(e){this.users[e.userId]=e},getUser:function(e){return this.users[e]||null},getUsers:function(){return i.values(this.users)},scrollback:function(e,t){return[]},storeEvents:function(e,t,r,n){},storeFilter:function(e){e&&(this.filters[e.userId]||(this.filters[e.userId]={}),this.filters[e.userId][e.filterId]=e)},getFilter:function(e,t){return this.filters[e]&&this.filters[e][t]?this.filters[e][t]:null},getFilterIdByName:function(e){if(!this.localStorage)return null;const t="mxjssdk_memory_filter_"+e;try{const e=this.localStorage.getItem(t);if(s(e))return e}catch(e){}return null},setFilterIdByName:function(e,t){if(!this.localStorage)return;const r="mxjssdk_memory_filter_"+e;try{s(t)?this.localStorage.setItem(r,t):this.localStorage.removeItem(r)}catch(e){}},storeAccountDataEvents:function(e){const t=this;e.forEach((function(e){t.accountData[e.getType()]=e}))},getAccountData:function(e){return this.accountData[e]},setSyncData:function(e){return Promise.resolve()},wantsSave:function(){return!1},save:function(e){},startup:function(){return Promise.resolve()},getSavedSync:function(){return Promise.resolve(null)},getSavedSyncToken:function(){return Promise.resolve(null)},deleteAllData:function(){return this.rooms={},this.users={},this.syncToken=null,this.filters={},this.accountData={},Promise.resolve()},getOutOfBandMembers:function(e){return Promise.resolve(this._oobMembers[e]||null)},setOutOfBandMembers:function(e,t){return this._oobMembers[e]=t,Promise.resolve()},clearOutOfBandMembers:function(){return this._oobMembers={},Promise.resolve()},getClientOptions:function(){return Promise.resolve(this._clientOptions)},storeClientOptions:function(e){return this._clientOptions=Object.assign({},e),Promise.resolve()}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SERVICE_TYPES=void 0;const n=Object.freeze({IS:"SERVICE_TYPE_IS",IM:"SERVICE_TYPE_IM"});t.SERVICE_TYPES=n},function(e,t,r){"use strict";var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.Room=g;var o=r(10),i=r(59),s=r(24),a=r(30),c=n(r(6)),u=r(18),l=r(39),d=r(106),h=r(3),p=r(40);const f=["1","2","3","4","5"];function m(e,t,r){const n={content:{},type:"m.receipt",room_id:t.getRoomId()};return n.content[t.getId()]={},n.content[t.getId()][r]={},n.content[t.getId()][r][e]={ts:t.getTs()},new u.MatrixEvent(n)}function g(e,t,r,n){if((n=n||{}).pendingEventOrdering=n.pendingEventOrdering||"chronological",this.setMaxListeners(100),this.reEmitter=new p.ReEmitter(this),-1===["chronological","detached"].indexOf(n.pendingEventOrdering))throw new Error("opts.pendingEventOrdering MUST be either 'chronological' or 'detached'. Got: '"+n.pendingEventOrdering+"'");this.myUserId=r,this.roomId=e,this.name=e,this.tags={},this.accountData={},this.summary=null,this.storageToken=n.storageToken,this._opts=n,this._txnToEvent={},this._receipts={},this._receiptCacheByEventId={},this._realReceipts={},this._notificationCounts={},this._timelineSets=[new i.EventTimelineSet(this,n)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),["Room.timeline","Room.timelineReset"]),this._fixUpLegacyTimelineFields(),this._filteredTimelineSets={},"detached"==this._opts.pendingEventOrdering&&(this._pendingEventList=[]),this._blacklistUnverifiedDevices=null,this._selfMembership=null,this._summaryHeroes=null,this._client=t,this._opts.lazyLoadMembers?this._membersPromise=null:this._membersPromise=Promise.resolve()}c.inherits(g,o.EventEmitter),g.prototype.getVersion=function(){const e=this.currentState.getStateEvents("m.room.create","");if(!e)return h.logger.warn("Room "+this.roomId+" does not have an m.room.create event"),"1";const t=e.getContent().room_version;return void 0===t?"1":t},g.prototype.shouldUpgradeToVersion=function(){return f.includes(this.getVersion())?null:"5"},g.prototype.getRecommendedVersion=async function(){let e=(await this._client.getCapabilities())["m.room_versions"];if(!e){e={default:"5",available:{}};for(const t of f)e.available[t]="stable"}let t=this._checkVersionAgainstCapability(e);if(t.urgent&&t.needsUpgrade){h.logger.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about.");if(e=(await this._client.getCapabilities(!0))["m.room_versions"],!e)return h.logger.warn("No room version capability - assuming upgrade required."),t;t=this._checkVersionAgainstCapability(e)}return t},g.prototype._checkVersionAgainstCapability=function(e){const t=this.getVersion();h.logger.log(`[${this.roomId}] Current version: ${t}`),h.logger.log(`[${this.roomId}] Version capability: `,e);const r={version:t,needsUpgrade:!1,urgent:!1};if(t===e.default)return r;return Object.keys(e.available).filter(t=>"stable"===e.available[t]).includes(t)||(r.version=e.default,r.needsUpgrade=!0,r.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),r.urgent?h.logger.warn("URGENT upgrade required on "+this.roomId):h.logger.warn("Non-urgent upgrade required on "+this.roomId)),r},g.prototype.userMayUpgradeRoom=function(e){return this.currentState.maySendStateEvent("m.room.tombstone",e)},g.prototype.getPendingEvents=function(){if("detached"!==this._opts.pendingEventOrdering)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this._opts.pendingEventOrdering);return this._pendingEventList},g.prototype.hasPendingEvent=function(e){if("detached"!==this._opts.pendingEventOrdering)throw new Error("Cannot call hasPendingEvent with pendingEventOrdering == "+this._opts.pendingEventOrdering);return this._pendingEventList.some(t=>t.getId()===e)},g.prototype.getLiveTimeline=function(){return this.getUnfilteredTimelineSet().getLiveTimeline()},g.prototype.getLastActiveTimestamp=function(){const e=this.getLiveTimeline().getEvents();if(e.length){return e[e.length-1].getTs()}return Number.MIN_SAFE_INTEGER},g.prototype.getMyMembership=function(){return this._selfMembership},g.prototype.getDMInviter=function(){if(this.myUserId){const e=this.getMember(this.myUserId);if(e)return e.getDMInviter()}if("invite"===this._selfMembership){if(2==this.getInvitedAndJoinedMemberCount()&&this._summaryHeroes.length)return this._summaryHeroes[0]}},g.prototype.guessDMUserId=function(){const e=this.getMember(this.myUserId);if(e){const t=e.getDMInviter();if(t)return t}if(Array.isArray(this._summaryHeroes)&&this._summaryHeroes.length)return this._summaryHeroes[0];const t=this.currentState.getMembers().find(e=>e.userId!==this.myUserId);return t?t.userId:this.myUserId},g.prototype.getAvatarFallbackMember=function(){if(this.getInvitedAndJoinedMemberCount()>2)return;const e=Array.isArray(this._summaryHeroes)&&this._summaryHeroes.length;if(e){const e=this._summaryHeroes.map(e=>this.getMember(e)).find(e=>!!e);if(e)return e}const t=this.currentState.getMembers();if(t.length<=2){const e=t.find(e=>e.userId!==this.myUserId);if(e)return e}if(e){const e=this._summaryHeroes.map(e=>this._client.getUser(e)).find(e=>!!e);if(e){const t=new l.RoomMember(this.roomId,e.userId);return t.user=e,t}}},g.prototype.updateMyMembership=function(e){const t=this._selfMembership;this._selfMembership=e,t!==e&&("leave"===e&&this._cleanupAfterLeaving(),this.emit("Room.myMembership",this,e,t))},g.prototype._loadMembersFromServer=async function(){const e=this._client.store.getSyncToken(),t=c.encodeParams({not_membership:"leave",at:e}),r=c.encodeUri("/rooms/$roomId/members?"+t,{$roomId:this.roomId}),n=this._client._http;return(await n.authedRequest(void 0,"GET",r)).chunk},g.prototype._loadMembers=async function(){let e=!1,t=await this._client.store.getOutOfBandMembers(this.roomId);null===t&&(e=!0,t=await this._loadMembersFromServer(),h.logger.log(`LL: got ${t.length} members from server for room `+this.roomId));return{memberEvents:t.map(this._client.getEventMapper()),fromServer:e}},g.prototype.loadMembersIfNeeded=function(){if(this._membersPromise)return this._membersPromise;this.currentState.markOutOfBandMembersStarted();const e=this._loadMembers().then(e=>(this.currentState.setOutOfBandMembers(e.memberEvents),this._client.isCryptoEnabled()&&this._client.isRoomEncrypted(this.roomId)&&this._client._crypto.trackRoomDevices(this.roomId),e.fromServer)).catch(e=>{throw this._membersPromise=null,this.currentState.markOutOfBandMembersFailed(),e});return e.then(e=>{if(e){const e=this.currentState.getMembers().filter(e=>e.isOutOfBand()).map(e=>e.events.member.event);h.logger.log("LL: telling store to write "+e.length+" members for room "+this.roomId);return this._client.store.setOutOfBandMembers(this.roomId,e).catch(e=>{h.logger.log("LL: storing OOB room members failed, oh well",e)})}}).catch(e=>{h.logger.error(e)}),this._membersPromise=e,this._membersPromise},g.prototype.clearLoadedMembersIfNeeded=async function(){this._opts.lazyLoadMembers&&this._membersPromise&&(await this.loadMembersIfNeeded(),await this._client.store.clearOutOfBandMembers(this.roomId),this.currentState.clearOutOfBandMembers(),this._membersPromise=null)},g.prototype._cleanupAfterLeaving=function(){this.clearLoadedMembersIfNeeded().catch(e=>{h.logger.error(`error after clearing loaded members from room ${this.roomId} after leaving`),h.logger.log(e)})},g.prototype.resetLiveTimeline=function(e,t){for(let r=0;r<this._timelineSets.length;r++)this._timelineSets[r].resetLiveTimeline(e,t);this._fixUpLegacyTimelineFields()},g.prototype._fixUpLegacyTimelineFields=function(){this.timeline=this.getLiveTimeline().getEvents(),this.oldState=this.getLiveTimeline().getState(s.EventTimeline.BACKWARDS),this.currentState=this.getLiveTimeline().getState(s.EventTimeline.FORWARDS)},g.prototype.hasUnverifiedDevices=async function(){if(!this._client.isRoomEncrypted(this.roomId))return!1;const e=await this.getEncryptionTargetMembers();for(const t of e){if(this._client.getStoredDevicesForUser(t.userId).some(e=>e.isUnverified()))return!0}return!1},g.prototype.getTimelineSets=function(){return this._timelineSets},g.prototype.getUnfilteredTimelineSet=function(){return this._timelineSets[0]},g.prototype.getTimelineForEvent=function(e){return this.getUnfilteredTimelineSet().getTimelineForEvent(e)},g.prototype.addTimeline=function(){return this.getUnfilteredTimelineSet().addTimeline()},g.prototype.findEventById=function(e){return this.getUnfilteredTimelineSet().findEventById(e)},g.prototype.getUnreadNotificationCount=function(e){return e=e||"total",this._notificationCounts[e]},g.prototype.setUnreadNotificationCount=function(e,t){this._notificationCounts[e]=t},g.prototype.setSummary=function(e){const t=e["m.heroes"],r=e["m.joined_member_count"],n=e["m.invited_member_count"];Number.isInteger(r)&&this.currentState.setJoinedMemberCount(r),Number.isInteger(n)&&this.currentState.setInvitedMemberCount(n),Array.isArray(t)&&(this._summaryHeroes=t.filter(e=>e!==this.myUserId))},g.prototype.setBlacklistUnverifiedDevices=function(e){this._blacklistUnverifiedDevices=e},g.prototype.getBlacklistUnverifiedDevices=function(){return this._blacklistUnverifiedDevices},g.prototype.getAvatarUrl=function(e,t,r,n,o){const i=this.currentState.getStateEvents("m.room.avatar","");if(void 0===o&&(o=!0),!i&&!o)return null;const s=i?i.getContent().url:null;return s?(0,a.getHttpUriForMxc)(e,s,t,r,n):o?(0,a.getIdenticonUri)(e,this.roomId,t,r):null},g.prototype.getAliases=function(){const e=[],t=this.currentState.getStateEvents("m.room.aliases");if(t)for(let r=0;r<t.length;++r){const n=t[r];if(c.isArray(n.getContent().aliases)){const t=n.getContent().aliases.filter(e=>"string"==typeof e&&("#"===e[0]&&!!e.endsWith(":"+n.getStateKey())));Array.prototype.push.apply(e,t)}}return e},g.prototype.getCanonicalAlias=function(){const e=this.currentState.getStateEvents("m.room.canonical_alias","");return e&&e.getContent().alias||null},g.prototype.getAltAliases=function(){const e=this.currentState.getStateEvents("m.room.canonical_alias","");return e&&e.getContent().alt_aliases||[]},g.prototype.addEventsToTimeline=function(e,t,r,n){r.getTimelineSet().addEventsToTimeline(e,t,r,n)},g.prototype.getMember=function(e){return this.currentState.getMember(e)},g.prototype.getJoinedMembers=function(){return this.getMembersWithMembership("join")},g.prototype.getJoinedMemberCount=function(){return this.currentState.getJoinedMemberCount()},g.prototype.getInvitedMemberCount=function(){return this.currentState.getInvitedMemberCount()},g.prototype.getInvitedAndJoinedMemberCount=function(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()},g.prototype.getMembersWithMembership=function(e){return c.filter(this.currentState.getMembers(),(function(t){return t.membership===e}))},g.prototype.getEncryptionTargetMembers=async function(){await this.loadMembersIfNeeded();let e=this.getMembersWithMembership("join");return this.shouldEncryptForInvitedMembers()&&(e=e.concat(this.getMembersWithMembership("invite"))),e},g.prototype.shouldEncryptForInvitedMembers=function(){const e=this.currentState.getStateEvents("m.room.history_visibility","");return e&&e.getContent()&&"joined"!==e.getContent().history_visibility},g.prototype.getDefaultRoomName=function(e){return y(this,e,!0)},g.prototype.hasMembershipState=function(e,t){const r=this.getMember(e);return!!r&&r.membership===t},g.prototype.getOrCreateFilteredTimelineSet=function(e){if(this._filteredTimelineSets[e.filterId])return this._filteredTimelineSets[e.filterId];const t=Object.assign({filter:e},this._opts),r=new i.EventTimelineSet(this,t);this.reEmitter.reEmit(r,["Room.timeline","Room.timelineReset"]),this._filteredTimelineSets[e.filterId]=r,this._timelineSets.push(r);const n=this.getLiveTimeline();n.getEvents().forEach((function(e){r.addLiveEvent(e)}));let o=n;for(;o.getNeighbouringTimeline(s.EventTimeline.BACKWARDS);)o=o.getNeighbouringTimeline(s.EventTimeline.BACKWARDS);return r.getLiveTimeline().setPaginationToken(o.getPaginationToken(s.EventTimeline.BACKWARDS),s.EventTimeline.BACKWARDS),r},g.prototype.removeFilteredTimelineSet=function(e){const t=this._filteredTimelineSets[e.filterId];delete this._filteredTimelineSets[e.filterId];const r=this._timelineSets.indexOf(t);r>-1&&this._timelineSets.splice(r,1)},g.prototype._addLiveEvent=function(e,t,r){if(e.isRedaction()){const t=e.event.redacts,r=this.getUnfilteredTimelineSet().findEventById(t);if(r){if(r.makeRedacted(e),r.getStateKey()){this.currentState.getStateEvents(r.getType(),r.getStateKey()).getId()===r.getId()&&this.currentState.setStateEvents([r])}this.emit("Room.redaction",e,this)}}if(e.getUnsigned().transaction_id){const t=this._txnToEvent[e.getUnsigned().transaction_id];if(t)return void this._handleRemoteEcho(e,t)}for(let n=0;n<this._timelineSets.length;n++)this._timelineSets[n].addLiveEvent(e,t,r);e.sender&&"m.room.redaction"!==e.getType()&&this.addReceipt(m(e.sender.userId,e,"m.read"),!0)},g.prototype.addPendingEvent=function(e,t){if(e.status!==u.EventStatus.SENDING)throw new Error("addPendingEvent called on an event with status "+e.status);if(this._txnToEvent[t])throw new Error("addPendingEvent called on an event with known txnId "+t);if(s.EventTimeline.setEventMetadata(e,this.getLiveTimeline().getState(s.EventTimeline.FORWARDS),!1),this._txnToEvent[t]=e,"detached"==this._opts.pendingEventOrdering){if(this._pendingEventList.some(e=>e.status===u.EventStatus.NOT_SENT)&&(h.logger.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(u.EventStatus.NOT_SENT)),this._pendingEventList.push(e),e.isRelation()&&this._aggregateNonLiveRelation(e),e.isRedaction()){const t=e.event.redacts;let r=this._pendingEventList&&this._pendingEventList.find(e=>e.getId()===t);r||(r=this.getUnfilteredTimelineSet().findEventById(t)),r&&(r.markLocallyRedacted(e),this.emit("Room.redaction",e,this))}}else for(let t=0;t<this._timelineSets.length;t++){const r=this._timelineSets[t];r.getFilter()?r.getFilter().filterRoomTimeline([e]).length&&r.addEventToTimeline(e,r.getLiveTimeline(),!1):r.addEventToTimeline(e,r.getLiveTimeline(),!1)}this.emit("Room.localEchoUpdated",e,this,null,null)},g.prototype._aggregateNonLiveRelation=function(e){for(let t=0;t<this._timelineSets.length;t++){const r=this._timelineSets[t];r.getFilter()?r.getFilter().filterRoomTimeline([e]).length&&r.aggregateRelations(e):r.aggregateRelations(e)}},g.prototype._handleRemoteEcho=function(e,t){const r=t.getId(),n=e.getId(),o=t.status;h.logger.debug(`Got remote echo for event ${r} -> ${n} old status `+o),delete this._txnToEvent[e.getUnsigned().transaction_id],this._pendingEventList&&c.removeElement(this._pendingEventList,(function(e){return e.getId()==r}),!1),t.handleRemoteEcho(e.event);for(let e=0;e<this._timelineSets.length;e++){this._timelineSets[e].handleRemoteEcho(t,r,n)}this.emit("Room.localEchoUpdated",t,this,r,o)};const v={};function y(e,t,r){if(!r){const t=e.currentState.getStateEvents("m.room.name","");if(t&&t.getContent()&&t.getContent().name)return t.getContent().name}let n=e.getCanonicalAlias();if(!n){const t=e.getAltAliases();t.length&&(n=t[0])}if(n)return n;const o=e.currentState.getJoinedMemberCount()+e.currentState.getInvitedMemberCount()-1;let i=null;if(e._summaryHeroes)i=e._summaryHeroes.map(t=>{const r=e.getMember(t);return r?r.name:t});else{let r=e.currentState.getMembers().filter(e=>e.userId!==t&&("invite"===e.membership||"join"===e.membership));r.sort((e,t)=>e.userId.localeCompare(t.userId)),r=r.slice(0,5),i=r.map(e=>e.name)}if(o)return _(i,o);if("join"==e.getMyMembership()){const t=e.currentState.getStateEvents("m.room.third_party_invite");if(t&&t.length){return"Inviting "+_(t.map(e=>e.getContent().display_name))}}let s=i;return s.length||(s=e.currentState.getMembers().filter(e=>e.userId!==t&&"invite"!==e.membership&&"join"!==e.membership).map(e=>e.name)),s.length?`Empty room (was ${_(s)})`:"Empty room"}function _(e,t=e.length+1){const r=t-1;if(e.length){if(1===e.length&&r<=1)return e[0];if(2===e.length&&r<=2)return`${e[0]} and ${e[1]}`;return r>1?`${e[0]} and ${r} others`:e[0]+" and 1 other"}return"Empty room"}v[u.EventStatus.ENCRYPTING]=[u.EventStatus.SENDING,u.EventStatus.NOT_SENT],v[u.EventStatus.SENDING]=[u.EventStatus.ENCRYPTING,u.EventStatus.QUEUED,u.EventStatus.NOT_SENT,u.EventStatus.SENT],v[u.EventStatus.QUEUED]=[u.EventStatus.SENDING,u.EventStatus.CANCELLED],v[u.EventStatus.SENT]=[],v[u.EventStatus.NOT_SENT]=[u.EventStatus.SENDING,u.EventStatus.QUEUED,u.EventStatus.CANCELLED],v[u.EventStatus.CANCELLED]=[],g.prototype.updatePendingEvent=function(e,t,r){if(h.logger.log(`setting pendingEvent status to ${t} in ${e.getRoomId()} event ID ${e.getId()} -> ${r}`),t==u.EventStatus.SENT&&!r)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==u.EventStatus.SENT){if(this.getUnfilteredTimelineSet().eventIdToTimeline(r))return}const n=e.status,o=e.getId();if(!n)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");const i=v[n];if(!i||i.indexOf(t)<0)throw new Error("Invalid EventStatus transition "+n+"->"+t);if(e.setStatus(t),t==u.EventStatus.SENT){e.replaceLocalEventId(r);for(let e=0;e<this._timelineSets.length;e++)this._timelineSets[e].replaceEventId(o,r)}else if(t==u.EventStatus.CANCELLED){if(this._pendingEventList){const e=this._pendingEventList.findIndex(e=>e.getId()===o);if(-1!==e){const[t]=this._pendingEventList.splice(e,1);t.isRedaction()&&this._revertRedactionLocalEcho(t)}}this.removeEvent(o)}this.emit("Room.localEchoUpdated",e,this,o,n)},g.prototype._revertRedactionLocalEcho=function(e){const t=e.event.redacts;if(!t)return;const r=this.getUnfilteredTimelineSet().findEventById(t);r&&(r.unmarkLocallyRedacted(),this.emit("Room.redactionCancelled",e,this),r.isRelation()&&this._aggregateNonLiveRelation(r))},g.prototype.addLiveEvents=function(e,t,r){let n;if(t&&-1===["replace","ignore"].indexOf(t))throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");for(n=0;n<this._timelineSets.length;n++){const e=this._timelineSets[n].getLiveTimeline();if(e.getPaginationToken(s.EventTimeline.FORWARDS))throw new Error("live timeline "+n+" is no longer live - it has a pagination token ("+e.getPaginationToken(s.EventTimeline.FORWARDS)+")");if(e.getNeighbouringTimeline(s.EventTimeline.FORWARDS))throw new Error("live timeline "+n+" is no longer live - it has a neighbouring timeline")}for(n=0;n<e.length;n++)this._addLiveEvent(e[n],t,r)},g.prototype.addEphemeralEvents=function(e){for(const t of e)"m.typing"===t.getType()?this.currentState.setTypingEvent(t):"m.receipt"===t.getType()&&this.addReceipt(t)},g.prototype.removeEvents=function(e){for(let t=0;t<e.length;++t)this.removeEvent(e[t])},g.prototype.removeEvent=function(e){let t=!1;for(let r=0;r<this._timelineSets.length;r++){const n=this._timelineSets[r].removeEvent(e);n&&(n.isRedaction()&&this._revertRedactionLocalEcho(n),t=!0)}return t},g.prototype.recalculate=function(){const e=this,t=this.currentState.getStateEvents("m.room.member",this.myUserId);if(t&&"invite"===t.getContent().membership){const r=t.event.invite_room_state||[];c.forEach(r,(function(t){e.currentState.getStateEvents(t.type,t.state_key)||e.currentState.setStateEvents([new u.MatrixEvent({type:t.type,state_key:t.state_key,content:t.content,event_id:"$fake"+Date.now(),room_id:e.roomId,user_id:e.myUserId})])}))}const r=this.name;this.name=y(this,this.myUserId),this.summary=new d.RoomSummary(this.roomId,{title:this.name}),r!==this.name&&this.emit("Room.name",this)},g.prototype.getUsersReadUpTo=function(e){return this.getReceiptsForEvent(e).filter((function(e){return"m.read"===e.type})).map((function(e){return e.userId}))},g.prototype.getEventReadUpTo=function(e,t){let r=this._receipts;return t&&(r=this._realReceipts),void 0===r["m.read"]||void 0===r["m.read"][e]?null:r["m.read"][e].eventId},g.prototype.hasUserReadEvent=function(e,t){const r=this.getEventReadUpTo(e,!1);if(r===t)return!0;if(this.timeline.length&&this.timeline[this.timeline.length-1].getSender()&&this.timeline[this.timeline.length-1].getSender()===e)return!0;for(let e=this.timeline.length-1;e>=0;--e){const n=this.timeline[e];if(n.getId()===t)return!1;if(n.getId()===r)return!0}return!1},g.prototype.getReceiptsForEvent=function(e){return this._receiptCacheByEventId[e.getId()]||[]},g.prototype.addReceipt=function(e,t){void 0===t&&(t=!1),t||this._addReceiptsToStructure(e,this._realReceipts),this._addReceiptsToStructure(e,this._receipts),this._receiptCacheByEventId=this._buildReceiptCache(this._receipts),this.emit("Room.receipt",e,this)},g.prototype._addReceiptsToStructure=function(e,t){const r=this;c.keys(e.getContent()).forEach((function(n){c.keys(e.getContent()[n]).forEach((function(o){c.keys(e.getContent()[n][o]).forEach((function(i){const s=e.getContent()[n][o][i];t[o]||(t[o]={});const a=t[o][i];if(a){const e=r.getUnfilteredTimelineSet().compareEventOrdering(a.eventId,n);if(null!==e&&e>=0)return}else t[o][i]={};t[o][i]={eventId:n,data:s}}))}))}))},g.prototype._buildReceiptCache=function(e){const t={};return c.keys(e).forEach((function(r){c.keys(e[r]).forEach((function(n){const o=e[r][n];t[o.eventId]||(t[o.eventId]=[]),t[o.eventId].push({userId:n,type:r,data:o.data})}))})),t},g.prototype._addLocalEchoReceipt=function(e,t,r){this.addReceipt(m(e,t,r),!0)},g.prototype.addTags=function(e){this.tags=e.getContent().tags||{},this.emit("Room.tags",e,this)},g.prototype.addAccountData=function(e){for(let t=0;t<e.length;t++){const r=e[t];"m.tag"===r.getType()&&this.addTags(r);const n=this.accountData[r.getType()];this.accountData[r.getType()]=r,this.emit("Room.accountData",r,this,n)}},g.prototype.getAccountData=function(e){return this.accountData[e]},g.prototype.maySendMessage=function(){return"join"===this.getMyMembership()&&this.currentState.maySendEvent("m.room.message",this.myUserId)}},function(e,t,r){"use strict";var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.EventTimelineSet=d;var o=r(10),i=r(24),s=r(18),a=n(r(6)),c=r(3),u=r(105);let l;function d(e,t){this.room=e,this._timelineSupport=Boolean(t.timelineSupport),this._liveTimeline=new i.EventTimeline(this),this._unstableClientRelationAggregation=!!t.unstableClientRelationAggregation,this._timelines=[this._liveTimeline],this._eventIdToTimeline={},this._filter=t.filter||null,this._unstableClientRelationAggregation&&(this._relations={})}l=c.logger.log.bind(c.logger),a.inherits(d,o.EventEmitter),d.prototype.getTimelines=function(){return this._timelines},d.prototype.getFilter=function(){return this._filter},d.prototype.setFilter=function(e){this._filter=e},d.prototype.getPendingEvents=function(){return this.room?this._filter?this._filter.filterRoomTimeline(this.room.getPendingEvents()):this.room.getPendingEvents():[]},d.prototype.getLiveTimeline=function(){return this._liveTimeline},d.prototype.eventIdToTimeline=function(e){return this._eventIdToTimeline[e]},d.prototype.replaceEventId=function(e,t){const r=this._eventIdToTimeline[e];r&&(delete this._eventIdToTimeline[e],this._eventIdToTimeline[t]=r)},d.prototype.resetLiveTimeline=function(e,t){const r=!this._timelineSupport||!t,n=this._liveTimeline,o=r?n.forkLive(i.EventTimeline.FORWARDS):n.fork(i.EventTimeline.FORWARDS);r?(this._timelines=[o],this._eventIdToTimeline={}):this._timelines.push(o),t&&n.setPaginationToken(t,i.EventTimeline.FORWARDS),o.setPaginationToken(e,i.EventTimeline.BACKWARDS),this._liveTimeline=o,this.emit("Room.timelineReset",this.room,this,r)},d.prototype.getTimelineForEvent=function(e){const t=this._eventIdToTimeline[e];return void 0===t?null:t},d.prototype.findEventById=function(e){const t=this.getTimelineForEvent(e);if(t)return a.findElement(t.getEvents(),(function(t){return t.getId()==e}))},d.prototype.addTimeline=function(){if(!this._timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");const e=new i.EventTimeline(this);return this._timelines.push(e),e},d.prototype.addEventsToTimeline=function(e,t,r,n){if(!r)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&r==this._liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(this._filter&&!(e=this._filter.filterRoomTimeline(e)).length)return;const o=t?i.EventTimeline.BACKWARDS:i.EventTimeline.FORWARDS,s=t?i.EventTimeline.FORWARDS:i.EventTimeline.BACKWARDS;let a=!1,u=!1;for(let n=0;n<e.length;n++){const d=e[n],h=d.getId(),p=this._eventIdToTimeline[h];if(!p){this.addEventToTimeline(d,r,t),u=!0,a=!0;continue}if(u=!1,p==r){l("Event "+h+" already in timeline "+r);continue}const f=r.getNeighbouringTimeline(o);if(f){l(p==f?"Event "+h+" in neighbouring timeline - switching to "+p:"Event "+h+" already in a different timeline "+p),r=p;continue}c.logger.info("Already have timeline for "+h+" - joining timeline "+r+" to "+p);const m=p===this._liveTimeline,g=r===this._liveTimeline,v=o===i.EventTimeline.BACKWARDS&&m,y=o===i.EventTimeline.FORWARDS&&g;v||y?(v&&c.logger.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+p+")"),y&&c.logger.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+r+")")):(r.setNeighbouringTimeline(p,o),p.setNeighbouringTimeline(r,s),r=p,a=!0)}if(u||!a){if(o===i.EventTimeline.FORWARDS&&r===this._liveTimeline)return c.logger.warn({lastEventWasNew:u,didUpdate:a}),void c.logger.warn(`Refusing to set forwards pagination token of live timeline ${r} to ${n}`);r.setPaginationToken(n,o)}},d.prototype.addLiveEvent=function(e,t,r){if(this._filter){if(!this._filter.filterRoomTimeline([e]).length)return}const n=this._eventIdToTimeline[e.getId()];if(n)if("replace"===t){l("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());const t=n.getEvents();for(let r=0;r<t.length;r++)if(t[r].getId()===e.getId()){i.EventTimeline.setEventMetadata(e,n.getState(i.EventTimeline.FORWARDS),!1),t[r].encryptedType||(t[r]=e);break}}else l("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());else this.addEventToTimeline(e,this._liveTimeline,!1,r)},d.prototype.addEventToTimeline=function(e,t,r,n){const o=e.getId();t.addEvent(e,r),this._eventIdToTimeline[o]=t,this.setRelationsTarget(e),this.aggregateRelations(e);const i={timeline:t,liveEvent:!r&&t==this._liveTimeline&&!n};this.emit("Room.timeline",e,this.room,Boolean(r),!1,i)},d.prototype.handleRemoteEcho=function(e,t,r){const n=this._eventIdToTimeline[t];n?(delete this._eventIdToTimeline[t],this._eventIdToTimeline[r]=n):this._filter?this._filter.filterRoomTimeline([e]).length&&this.addEventToTimeline(e,this._liveTimeline,!1):this.addEventToTimeline(e,this._liveTimeline,!1)},d.prototype.removeEvent=function(e){const t=this._eventIdToTimeline[e];if(!t)return null;const r=t.removeEvent(e);if(r){delete this._eventIdToTimeline[e];const n={timeline:t};this.emit("Room.timeline",r,this.room,void 0,!0,n)}return r},d.prototype.compareEventOrdering=function(e,t){if(e==t)return 0;const r=this._eventIdToTimeline[e],n=this._eventIdToTimeline[t];if(void 0===r)return null;if(void 0===n)return null;if(r===n){let n,o;const i=r.getEvents();for(let r=0;r<i.length&&(void 0===n||void 0===o);r++){const s=i[r].getId();s==e&&(n=r),s==t&&(o=r)}return n-o}let o=r;for(;o;){if(o===n)return-1;o=o.getNeighbouringTimeline(i.EventTimeline.FORWARDS)}for(o=r;o;){if(o===n)return 1;o=o.getNeighbouringTimeline(i.EventTimeline.BACKWARDS)}return null},d.prototype.getRelationsForEvent=function(e,t,r){if(!this._unstableClientRelationAggregation)throw new Error("Client-side relation aggregation is disabled");if(!e||!t||!r)throw new Error("Invalid arguments for `getRelationsForEvent`");return((this._relations[e]||{})[t]||{})[r]},d.prototype.setRelationsTarget=function(e){if(!this._unstableClientRelationAggregation)return;const t=this._relations[e.getId()];if(!t)return;const r=t["m.replace"];if(!r)return;const n=r["m.room.message"];n&&n.setTargetEvent(e)},d.prototype.aggregateRelations=function(e){if(!this._unstableClientRelationAggregation)return;if(e.isRedacted()||e.status===s.EventStatus.CANCELLED)return;if(e.isBeingDecrypted())return void e.once("Event.decrypted",()=>{this.aggregateRelations(e)});const t=e.getRelation();if(!t)return;const r=t.event_id,n=t.rel_type,o=e.getType();let i=this._relations[r];i||(i=this._relations[r]={});let a=i[n];a||(a=i[n]={});let c,l=a[o],d=!1;l||(l=a[o]=new u.Relations(n,o,this.room),d=!0,c=this.findEventById(r),c&&l.setTargetEvent(c)),l.addEvent(e),d&&c&&c.emit("Event.relationsCreated",n,o)}},function(e,t,r){"use strict";var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.RoomState=c;var o=r(10),i=r(39),s=r(3),a=n(r(6));function c(e,t){this.roomId=e,this.members={},this.events={},this.paginationToken=null,this._sentinels={},this._updateModifiedTime(),this._displayNameToUserIds={},this._userIdsToDisplayNames={},this._tokenToInvite={},this._joinedMemberCount=null,this._summaryJoinedMemberCount=null,this._invitedMemberCount=null,this._summaryInvitedMemberCount=null,t||(t={status:1}),this._oobMemberFlags=t}function u(e,t,r){const n=e._userIdsToDisplayNames[t];if(delete e._userIdsToDisplayNames[t],n){const r=a.removeHiddenChars(n),o=e._displayNameToUserIds[r];if(o){const n=o.filter(e=>e!==t);e._displayNameToUserIds[r]=n}}e._userIdsToDisplayNames[t]=r;const o=r&&a.removeHiddenChars(r);o&&(e._displayNameToUserIds[o]||(e._displayNameToUserIds[o]=[]),e._displayNameToUserIds[o].push(t))}a.inherits(c,o.EventEmitter),c.prototype.getJoinedMemberCount=function(){return null!==this._summaryJoinedMemberCount?this._summaryJoinedMemberCount:(null===this._joinedMemberCount&&(this._joinedMemberCount=this.getMembers().reduce((e,t)=>"join"===t.membership?e+1:e,0)),this._joinedMemberCount)},c.prototype.setJoinedMemberCount=function(e){this._summaryJoinedMemberCount=e},c.prototype.getInvitedMemberCount=function(){return null!==this._summaryInvitedMemberCount?this._summaryInvitedMemberCount:(null===this._invitedMemberCount&&(this._invitedMemberCount=this.getMembers().reduce((e,t)=>"invite"===t.membership?e+1:e,0)),this._invitedMemberCount)},c.prototype.setInvitedMemberCount=function(e){this._summaryInvitedMemberCount=e},c.prototype.getMembers=function(){return a.values(this.members)},c.prototype.getMembersExcept=function(e){return a.values(this.members).filter(t=>!e.includes(t.userId))},c.prototype.getMember=function(e){return this.members[e]||null},c.prototype.getSentinelMember=function(e){if(!e)return null;let t=this._sentinels[e];if(void 0===t){t=new i.RoomMember(this.roomId,e);const r=this.members[e];r&&t.setMembershipEvent(r.events.member,this),this._sentinels[e]=t}return t},c.prototype.getStateEvents=function(e,t){if(!this.events[e])return void 0===t?[]:null;if(void 0===t)return a.values(this.events[e]);const r=this.events[e][t];return r||null},c.prototype.clone=function(){const e=new c(this.roomId,this._oobMemberFlags),t=this._oobMemberFlags.status;return this._oobMemberFlags.status=1,Object.values(this.events).forEach(t=>{const r=Object.values(t);e.setStateEvents(r)}),this._oobMemberFlags.status=t,null!==this._summaryInvitedMemberCount&&e.setInvitedMemberCount(this.getInvitedMemberCount()),null!==this._summaryJoinedMemberCount&&e.setJoinedMemberCount(this.getJoinedMemberCount()),3==this._oobMemberFlags.status&&this.getMembers().forEach(t=>{if(t.isOutOfBand()){e.getMember(t.userId).markOutOfBand()}}),e},c.prototype.setUnknownStateEvents=function(e){const t=e.filter(e=>void 0===this.events[e.getType()]||void 0===this.events[e.getType()][e.getStateKey()]);this.setStateEvents(t)},c.prototype.setStateEvents=function(e){const t=this;this._updateModifiedTime(),a.forEach(e,(function(e){if(e.getRoomId()!==t.roomId)return;if(!e.isState())return;const r=t._getStateEventMatching(e);t._setStateEvent(e),"m.room.member"===e.getType()&&(u(t,e.getStateKey(),e.getContent().displayname),function(e,t){if(!t.getContent().third_party_invite)return;const r=(t.getContent().third_party_invite.signed||{}).token;if(!r)return;if(!e.getStateEvents("m.room.third_party_invite",r))return;e._tokenToInvite[r]=t}(t,e)),t.emit("RoomState.events",e,t,r)})),a.forEach(e,(function(e){if(e.getRoomId()===t.roomId&&e.isState())if("m.room.member"===e.getType()){const r=e.getStateKey();"leave"!==e.getContent().membership&&"ban"!==e.getContent().membership||(e.getContent().avatar_url=e.getContent().avatar_url||e.getPrevContent().avatar_url,e.getContent().displayname=e.getContent().displayname||e.getPrevContent().displayname);const n=t._getOrCreateMember(r,e);n.setMembershipEvent(e,t),t._updateMember(n),t.emit("RoomState.members",e,t,n)}else if("m.room.power_levels"===e.getType()){const r=a.values(t.members);a.forEach(r,(function(r){r.setPowerLevelEvent(e),t.emit("RoomState.members",e,t,r)})),t._sentinels={}}}))},c.prototype._getOrCreateMember=function(e,t){let r=this.members[e];return r||(r=new i.RoomMember(this.roomId,e),this.members[e]=r,this.emit("RoomState.newMember",t,this,r)),r},c.prototype._setStateEvent=function(e){void 0===this.events[e.getType()]&&(this.events[e.getType()]={}),this.events[e.getType()][e.getStateKey()]=e},c.prototype._getStateEventMatching=function(e){return this.events[e.getType()]?this.events[e.getType()][e.getStateKey()]:null},c.prototype._updateMember=function(e){const t=this.getStateEvents("m.room.power_levels","");t&&e.setPowerLevelEvent(t),delete this._sentinels[e.userId],this.members[e.userId]=e,this._joinedMemberCount=null,this._invitedMemberCount=null},c.prototype.needsOutOfBandMembers=function(){return 1===this._oobMemberFlags.status},c.prototype.markOutOfBandMembersStarted=function(){1===this._oobMemberFlags.status&&(this._oobMemberFlags.status=2)},c.prototype.markOutOfBandMembersFailed=function(){2===this._oobMemberFlags.status&&(this._oobMemberFlags.status=1)},c.prototype.clearOutOfBandMembers=function(){let e=0;Object.keys(this.members).forEach(t=>{this.members[t].isOutOfBand()&&(++e,delete this.members[t])}),s.logger.log(`LL: RoomState removed ${e} members...`),this._oobMemberFlags.status=1},c.prototype.setOutOfBandMembers=function(e){s.logger.log(`LL: RoomState about to set ${e.length} OOB members ...`),2===this._oobMemberFlags.status&&(s.logger.log("LL: RoomState put in OOB_STATUS_FINISHED state ..."),this._oobMemberFlags.status=3,e.forEach(e=>this._setOutOfBandMember(e)))},c.prototype._setOutOfBandMember=function(e){if("m.room.member"!==e.getType())return;const t=e.getStateKey(),r=this.getMember(t);if(r&&!r.isOutOfBand())return;const n=this._getOrCreateMember(t,e);n.setMembershipEvent(e,this),n.markOutOfBand(),u(this,n.userId,n.name),this._setStateEvent(e),this._updateMember(n),this.emit("RoomState.members",e,this,n)},c.prototype.setTypingEvent=function(e){a.forEach(a.values(this.members),(function(t){t.setTypingEvent(e)}))},c.prototype.getInviteForThreePidToken=function(e){return this._tokenToInvite[e]||null},c.prototype._updateModifiedTime=function(){this._modified=Date.now()},c.prototype.getLastModifiedTime=function(){return this._modified},c.prototype.getUserIdsWithDisplayName=function(e){return this._displayNameToUserIds[a.removeHiddenChars(e)]||[]},c.prototype.maySendRedactionForEvent=function(e,t){const r=this.getMember(t);if(!r||"leave"===r.membership)return!1;if(e.status||e.isRedacted())return!1;const n=this.maySendEvent("m.room.redaction",t);return e.getSender()===t?n:this._hasSufficientPowerLevelFor("redact",r.powerLevel)},c.prototype._hasSufficientPowerLevelFor=function(e,t){const r=this.getStateEvents("m.room.power_levels","");let n={};r&&(n=r.getContent());let o=50;return a.isNumber(n[e])&&(o=n[e]),t>=o},c.prototype.maySendMessage=function(e){return this._maySendEventOfType("m.room.message",e,!1)},c.prototype.maySendEvent=function(e,t){return this._maySendEventOfType(e,t,!1)},c.prototype.mayClientSendStateEvent=function(e,t){return!t.isGuest()&&this.maySendStateEvent(e,t.credentials.userId)},c.prototype.maySendStateEvent=function(e,t){return this._maySendEventOfType(e,t,!0)},c.prototype._maySendEventOfType=function(e,t,r){const n=this.getStateEvents("m.room.power_levels","");let o,i={},s=0,a=0,c=0;if(n){o=n.getContent(),i=o.events||{},s=Number.isFinite(o.state_default)?o.state_default:50;const e=o.users&&o.users[t];Number.isFinite(e)?c=e:Number.isFinite(o.users_default)&&(c=o.users_default),Number.isFinite(o.events_default)&&(a=o.events_default)}let u=r?s:a;return Number.isFinite(i[e])&&(u=i[e]),c>=u},c.prototype.mayTriggerNotifOfType=function(e,t){const r=this.getMember(t);if(!r)return!1;const n=this.getStateEvents("m.room.power_levels","");let o=50;return n&&n.getContent()&&n.getContent().notifications&&a.isNumber(n.getContent().notifications[e])&&(o=n.getContent().notifications[e]),r.powerLevel>=o}},function(e,t,r){"use strict";var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.Group=s;var o=n(r(6)),i=r(10);function s(e){this.groupId=e,this.name=null,this.avatarUrl=null,this.myMembership=null,this.inviter=null}o.inherits(s,i.EventEmitter),s.prototype.setProfile=function(e,t){this.name===e&&this.avatarUrl===t||(this.name=e||this.groupId,this.avatarUrl=t,this.emit("Group.profile",this))},s.prototype.setMyMembership=function(e){this.myMembership!==e&&(this.myMembership=e,this.emit("Group.myMembership",this))},s.prototype.setInviter=function(e){this.inviter=e}},function(e,t,r){"use strict";(function(e){var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixCall=a,t.setAudioOutput=function(e){k=e},t.setAudioInput=function(e){P=e},t.setVideoInput=function(e){T=e},t.createNewMatrixCall=function(t,r,n){const i=e.window,s=e.document;if(!i||!s)return null;const c={};c.isOpenWebRTC=function(){const e=s.getElementById("script");if(!e||!e.length)return!1;for(let t=0;t<e.length;t++)if(e[t].src.indexOf("owr.js")>-1)return!0;return!1};const u=i.navigator.getUserMedia||i.navigator.webkitGetUserMedia||i.navigator.mozGetUserMedia;u&&(c.getUserMedia=function(){return u.apply(i.navigator,arguments)});const l=i.navigator.mediaDevices&&i.navigator.mediaDevices.getDisplayMedia||i.navigator.getDisplayMedia;l&&(c.getDisplayMedia=l.bind(i.navigator.mediaDevices));try{c.RtcPeerConnection=i.RTCPeerConnection||i.webkitRTCPeerConnection||i.mozRTCPeerConnection,c.RtcSessionDescription=i.RTCSessionDescription||i.webkitRTCSessionDescription||i.mozRTCSessionDescription,c.RtcIceCandidate=i.RTCIceCandidate||i.webkitRTCIceCandidate||i.mozRTCIceCandidate,c.vendor=null,i.mozRTCPeerConnection?c.vendor="mozilla":i.webkitRTCPeerConnection?c.vendor="webkit":i.RTCPeerConnection&&(c.vendor="generic")}catch(e){return o.logger.error("Failed to set up WebRTC object: possible browser interference?"),o.logger.error(e),null}if(!(c.RtcIceCandidate&&c.RtcSessionDescription&&c.RtcPeerConnection&&c.getUserMedia))return null;const d=!!n&&n.forceTURN;return new a({webRtc:c,client:t,URL:i.URL,roomId:r,turnServers:t.getTurnServers(),forceTURN:t._forceTURN||d})};var o=r(3),i=r(10),s=n(r(6));function a(e){this.roomId=e.roomId,this.client=e.client,this.webRtc=e.webRtc,this.forceTURN=e.forceTURN,this.URL=e.URL,this.turnServers=e.turnServers||[],0===this.turnServers.length&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:[a.FALLBACK_ICE_SERVER]}),s.forEach(this.turnServers,(function(e){s.checkObjectHasKeys(e,["urls"])})),this.callId="c"+(new Date).getTime()+Math.random(),this.state="fledgling",this.didConnect=!1,this.candidateSendQueue=[],this.candidateSendTries=0,this.mediaPromises=Object.create(null),this.screenSharingStream=null,this._answerContent=null}a.CALL_TIMEOUT_MS=6e4,a.FALLBACK_ICE_SERVER="stun:turn.matrix.org",a.ERR_LOCAL_OFFER_FAILED="local_offer_failed",a.ERR_NO_USER_MEDIA="no_user_media",a.ERR_UNKNOWN_DEVICES="unknown_devices",a.ERR_SEND_INVITE="send_invite",a.ERR_SEND_ANSWER="send_answer",s.inherits(a,i.EventEmitter),a.prototype.placeVoiceCall=function(){_("placeVoiceCall"),v(this),E(this,w("voice")),this.type="voice"},a.prototype.placeVideoCall=function(e,t){_("placeVideoCall"),v(this),this.localVideoElement=t,this.remoteVideoElement=e,E(this,w("video")),this.type="video",m(this)},a.prototype.placeScreenSharingCall=async function(e,t){_("placeScreenSharingCall"),v(this),this.localVideoElement=t,this.remoteVideoElement=e;const r=this;try{r.screenSharingStream=await this.webRtc.getDisplayMedia({audio:!1}),_("Got screen stream, requesting audio stream...");const e=w("voice");E(r,e)}catch(e){r.emit("error",y(a.ERR_NO_USER_MEDIA,"Failed to get screen-sharing stream: "+e))}this.type="video",m(this)},a.prototype.playElement=function(e,t){o.logger.log("queuing play on "+t+" and element "+e),this.mediaPromises[t]?this.mediaPromises[t]=this.mediaPromises[t].then((function(){return o.logger.log("previous promise completed for "+t),e.play()}),(function(){return o.logger.log("previous promise failed for "+t),e.play()})):this.mediaPromises[t]=e.play()},a.prototype.pauseElement=function(e,t){o.logger.log("queuing pause on "+t+" and element "+e),this.mediaPromises[t]?this.mediaPromises[t]=this.mediaPromises[t].then((function(){return o.logger.log("previous promise completed for "+t),e.pause()}),(function(){return o.logger.log("previous promise failed for "+t),e.pause()})):this.mediaPromises[t]=e.pause()},a.prototype.assignElement=function(e,t,r){o.logger.log("queuing assign on "+r+" element "+e+" for "+t),this.mediaPromises[r]?this.mediaPromises[r]=this.mediaPromises[r].then((function(){o.logger.log("previous promise completed for "+r),e.srcObject=t}),(function(){o.logger.log("previous promise failed for "+r),e.srcObject=t})):e.srcObject=t},a.prototype.getLocalVideoElement=function(){return this.localVideoElement},a.prototype.getRemoteVideoElement=function(){return this.remoteVideoElement},a.prototype.getRemoteAudioElement=function(){return this.remoteAudioElement},a.prototype.setLocalVideoElement=function(e){if(this.localVideoElement=e,e&&this.localAVStream&&"video"===this.type){e.autoplay=!0,this.assignElement(e,this.localAVStream,"localVideo"),e.muted=!0;const t=this;setTimeout((function(){const e=t.getLocalVideoElement();e.play&&t.playElement(e,"localVideo")}),0)}},a.prototype.setRemoteVideoElement=function(e){this.remoteVideoElement=e,m(this)},a.prototype.setRemoteAudioElement=function(e){this.remoteVideoElement.muted=!0,this.remoteAudioElement=e,this.remoteAudioElement.muted=!1,g(this)},a.prototype._initWithInvite=function(e){this.msg=e.getContent(),this.peerConn=S(this);const t=this;this.peerConn&&this.peerConn.setRemoteDescription(new this.webRtc.RtcSessionDescription(this.msg.offer),R(t,t._onSetRemoteDescriptionSuccess),R(t,t._onSetRemoteDescriptionError)),l(this,"ringing"),this.direction="inbound",this.msg.offer&&this.msg.offer.sdp&&this.msg.offer.sdp.indexOf("m=video")>-1?this.type="video":this.type="voice",e.getAge()&&setTimeout((function(){"ringing"==t.state&&(_("Call invite has expired. Hanging up."),t.hangupParty="remote",l(t,"ended"),f(t),"closed"!=t.peerConn.signalingState&&t.peerConn.close(),t.emit("hangup",t))}),this.msg.lifetime-e.getAge())},a.prototype._initWithHangup=function(e){this.msg=e.getContent(),l(this,"ended")},a.prototype.answer=function(){_("Answering call %s of type %s",this.callId,this.type);const e=this;e._answerContent?e._sendAnswer():this.localAVStream||this.waitForLocalAVStream?this.localAVStream?this._maybeGotUserMediaForAnswer(this.localAVStream):this.waitForLocalAVStream&&l(this,"wait_local_media"):(this.webRtc.getUserMedia(w(this.type),R(e,e._maybeGotUserMediaForAnswer),R(e,e._maybeGotUserMediaForAnswer)),l(this,"wait_local_media"))},a.prototype._replacedBy=function(e){_(this.callId+" being replaced by "+e.callId),"wait_local_media"==this.state?(_("Telling new call to wait for local media"),e.waitForLocalAVStream=!0):("create_offer"==this.state||"invite_sent"==this.state)&&(_("Handing local stream to new call"),e._maybeGotUserMediaForAnswer(this.localAVStream),delete this.localAVStream),e.localVideoElement=this.localVideoElement,e.remoteVideoElement=this.remoteVideoElement,e.remoteAudioElement=this.remoteAudioElement,this.successor=e,this.emit("replaced",e),this.hangup(!0)},a.prototype.hangup=function(e,t){if("ended"==this.state)return;_("Ending call "+this.callId),p(this,"local",e,!t);const r={version:0,call_id:this.callId,reason:e};d(this,"m.call.hangup",r)},a.prototype.setLocalVideoMuted=function(e){this.localAVStream&&c(this.localAVStream.getVideoTracks(),!e)},a.prototype.isLocalVideoMuted=function(){return!!this.localAVStream&&!u(this.localAVStream.getVideoTracks())},a.prototype.setMicrophoneMuted=function(e){this.localAVStream&&c(this.localAVStream.getAudioTracks(),!e)},a.prototype.isMicrophoneMuted=function(){return!!this.localAVStream&&!u(this.localAVStream.getAudioTracks())},a.prototype._maybeGotUserMediaForInvite=function(e){if(this.successor)return void this.successor._maybeGotUserMediaForAnswer(e);if("ended"==this.state)return;_("_maybeGotUserMediaForInvite -> "+this.type);const t=this,r=e,n={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:"video"===t.type}};if(e instanceof MediaStream){const r=this.getLocalVideoElement();r&&"video"==this.type&&(r.autoplay=!0,this.screenSharingStream?(_("Setting screen sharing stream to the local video element"),this.assignElement(r,this.screenSharingStream,"localVideo")):this.assignElement(r,e,"localVideo"),r.muted=!0,setTimeout((function(){const e=t.getLocalVideoElement();e.play&&t.playElement(e,"localVideo")}),0)),this.screenSharingStream&&(this.screenSharingStream.addTrack(e.getAudioTracks()[0]),e=this.screenSharingStream),this.localAVStream=e,c(e.getAudioTracks(),!0),this.peerConn=S(this),this.peerConn.addStream(e)}else{if("PermissionDeniedError"!==r.name)return _("Failed to getUserMedia: "+r.name),void this._getUserMediaFailed(r);_("User denied access to camera/microphone. Or possibly you are using an insecure domain. Receiving only."),this.peerConn=S(this)}this.peerConn.createOffer(R(t,t._gotLocalOffer),R(t,t._getLocalOfferFailed),n),l(t,"create_offer")},a.prototype._sendAnswer=function(e){d(this,"m.call.answer",this._answerContent).then(()=>{l(this,"connecting"),b(this)}).catch(e=>{l(this,"ringing"),this.client.cancelPendingEvent(e.event);let t=a.ERR_SEND_ANSWER,r="Failed to send answer";throw"UnknownDeviceError"==e.name&&(t=a.ERR_UNKNOWN_DEVICES,r="Unknown devices present in the room"),this.emit("error",y(t,r)),e})},a.prototype._maybeGotUserMediaForAnswer=function(e){const t=this;if("ended"==t.state)return;const r=e;if(e instanceof MediaStream){const r=t.getLocalVideoElement();r&&"video"==t.type&&(r.autoplay=!0,this.assignElement(r,e,"localVideo"),r.muted=!0,setTimeout((function(){const e=t.getLocalVideoElement();e.play&&t.playElement(e,"localVideo")}),0)),t.localAVStream=e,c(e.getAudioTracks(),!0),t.peerConn.addStream(e)}else{if("PermissionDeniedError"!==r.name)return _("Failed to getUserMedia: "+r.name),void this._getUserMediaFailed(r);_("User denied access to camera/microphone. Or possibly you are using an insecure domain. Receiving only.")}const n={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:"video"===t.type}};t.peerConn.createAnswer((function(e){_("Created answer: ",e),t.peerConn.setLocalDescription(e,(function(){t._answerContent={version:0,call_id:t.callId,answer:{sdp:t.peerConn.localDescription.sdp,type:t.peerConn.localDescription.type}},t._sendAnswer()}),(function(){_("Error setting local description!")}),n)}),(function(e){_("Failed to create answer: "+e)})),l(t,"create_answer")},a.prototype._gotLocalIceCandidate=function(e){if(e.candidate){if(_("Got local ICE "+e.candidate.sdpMid+" candidate: "+e.candidate.candidate),"ended"==this.state)return;const t={candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex};h(this,t)}},a.prototype._gotRemoteIceCandidate=function(e){"ended"!=this.state&&(_("Got remote ICE "+e.sdpMid+" candidate: "+e.candidate),this.peerConn.addIceCandidate(new this.webRtc.RtcIceCandidate(e),(function(){}),(function(e){})))},a.prototype._receivedAnswer=function(e){if("ended"==this.state)return;this.peerConn.setRemoteDescription(new this.webRtc.RtcSessionDescription(e.answer),R(this,this._onSetRemoteDescriptionSuccess),R(this,this._onSetRemoteDescriptionError)),l(this,"connecting")},a.prototype._gotLocalOffer=function(e){const t=this;_("Created offer: ",e),"ended"!=t.state?t.peerConn.setLocalDescription(e,(function(){const e={version:0,call_id:t.callId,offer:{sdp:t.peerConn.localDescription.sdp,type:t.peerConn.localDescription.type},lifetime:a.CALL_TIMEOUT_MS};d(t,"m.call.invite",e).then(()=>{l(t,"invite_sent"),setTimeout((function(){"invite_sent"==t.state&&t.hangup("invite_timeout")}),a.CALL_TIMEOUT_MS)}).catch(e=>{let r=a.ERR_SEND_INVITE,n="Failed to send invite";throw"UnknownDeviceError"==e.name&&(r=a.ERR_UNKNOWN_DEVICES,n="Unknown devices present in the room"),t.client.cancelPendingEvent(e.event),p(t,"local",r,!1),t.emit("error",y(r,n)),e})}),(function(){_("Error setting local description!")})):_("Ignoring newly created offer on call ID "+t.callId+" because the call has ended")},a.prototype._getLocalOfferFailed=function(e){this.emit("error",y(a.ERR_LOCAL_OFFER_FAILED,"Failed to start audio for call!"))},a.prototype._getUserMediaFailed=function(e){p(this,"local","user_media_failed",!1),this.emit("error",y(a.ERR_NO_USER_MEDIA,"Couldn't start capturing media! Is your microphone set up and does this app have permission?"))},a.prototype._onIceConnectionStateChanged=function(){"ended"!=this.state&&(_("Ice connection state changed to: "+this.peerConn.iceConnectionState),"completed"==this.peerConn.iceConnectionState||"connected"==this.peerConn.iceConnectionState?(l(this,"connected"),this.didConnect=!0):"failed"==this.peerConn.iceConnectionState&&this.hangup("ice_failed"))},a.prototype._onSignallingStateChanged=function(){_("call "+this.callId+": Signalling state changed to: "+this.peerConn.signalingState)},a.prototype._onSetRemoteDescriptionSuccess=function(){_("Set remote description")},a.prototype._onSetRemoteDescriptionError=function(e){_("Failed to set remote description"+e)},a.prototype._onAddStream=function(e){_("Stream id "+e.stream.id+" added");const t=e.stream;t.getVideoTracks().length>0?(this.type="video",this.remoteAVStream=t,this.remoteAStream=t):(this.type="voice",this.remoteAStream=t);const r=this;I(t,(function(e){_("Track id "+e.id+" added"),e.onstarted=R(r,r._onRemoteStreamTrackStarted)})),void 0!==e.stream.oninactive?e.stream.oninactive=R(r,r._onRemoteStreamEnded):e.stream.onended=R(r,r._onRemoteStreamEnded),e.stream.onstarted=R(r,r._onRemoteStreamStarted),"video"===this.type?(m(this),g(this)):g(this)},a.prototype._onRemoteStreamStarted=function(e){l(this,"connected")},a.prototype._onRemoteStreamEnded=function(e){_("Remote stream ended"),this.hangupParty="remote",l(this,"ended"),f(this),"closed"!=this.peerConn.signalingState&&this.peerConn.close(),this.emit("hangup",this)},a.prototype._onRemoteStreamTrackStarted=function(e){l(this,"connected")},a.prototype._onHangupReceived=function(e){_("Hangup received"),p(this,"remote",e.reason,!0)},a.prototype._onAnsweredElsewhere=function(e){_("Answered elsewhere"),p(this,"remote","answered_elsewhere",!0)};const c=function(e,t){for(let r=0;r<e.length;r++)e[r].enabled=t},u=function(e){for(let t=0;t<e.length;t++)if(e[t].enabled)return!0;return!1},l=function(e,t){const r=e.state;e.state=t,e.emit("state",t,r)},d=function(e,t,r){return e.client.sendEvent(e.roomId,t,r)},h=function(e,t){e.candidateSendQueue.push(t),"ringing"!=e.state&&0===e.candidateSendTries&&setTimeout((function(){b(e)}),100)},p=function(e,t,r,n){e.getRemoteVideoElement()&&(e.getRemoteVideoElement().pause&&e.pauseElement(e.getRemoteVideoElement(),"remoteVideo"),e.assignElement(e.getRemoteVideoElement(),null,"remoteVideo")),e.getRemoteAudioElement()&&(e.getRemoteAudioElement().pause&&e.pauseElement(e.getRemoteAudioElement(),"remoteAudio"),e.assignElement(e.getRemoteAudioElement(),null,"remoteAudio")),e.getLocalVideoElement()&&(e.getLocalVideoElement().pause&&e.pauseElement(e.getLocalVideoElement(),"localVideo"),e.assignElement(e.getLocalVideoElement(),null,"localVideo")),e.hangupParty=t,e.hangupReason=r,l(e,"ended"),f(e),e.peerConn&&"closed"!==e.peerConn.signalingState&&e.peerConn.close(),n&&e.emit("hangup",e)},f=function(e){_("stopAllMedia (stream=%s)",e.localAVStream),e.localAVStream&&(I(e.localAVStream,(function(e){e.stop&&e.stop()})),e.localAVStream.stop&&e.localAVStream.stop()),e.screenSharingStream&&(I(e.screenSharingStream,(function(e){e.stop&&e.stop()})),e.screenSharingStream.stop&&e.screenSharingStream.stop()),e.remoteAVStream&&I(e.remoteAVStream,(function(e){e.stop&&e.stop()})),e.remoteAStream&&I(e.remoteAStream,(function(e){e.stop&&e.stop()}))},m=function(e){if(e.getRemoteVideoElement()&&e.remoteAVStream){const t=e.getRemoteVideoElement();t.autoplay=!0,e.assignElement(t,e.remoteAVStream,"remoteVideo"),setTimeout((function(){const t=e.getRemoteVideoElement();t.play&&e.playElement(t,"remoteVideo"),e.webRtc.isOpenWebRTC()&&l(e,"connected")}),0)}},g=async function(e){if(e.getRemoteAudioElement()&&e.remoteAStream){const t=e.getRemoteAudioElement();k&&await t.setSinkId(k),t.autoplay=!0,e.assignElement(t,e.remoteAStream,"remoteAudio"),setTimeout((function(){const t=e.getRemoteAudioElement();t.play&&e.playElement(t,"remoteAudio"),e.webRtc.isOpenWebRTC()&&l(e,"connected")}),0)}},v=function(e){if(0===e.listeners("error").length)throw new Error("You MUST attach an error listener using call.on('error', function() {})")},y=function(e,t){const r=new Error(t);return r.code=e,r},_=function(){o.logger.log(...arguments)},b=function(e){if(0===e.candidateSendQueue.length)return;const t=e.candidateSendQueue;e.candidateSendQueue=[],++e.candidateSendTries;const r={version:0,call_id:e.callId,candidates:t};_("Attempting to send "+t.length+" candidates"),d(e,"m.call.candidates",r).then((function(){e.candidateSendTries=0,b(e)}),(function(r){for(let r=0;r<t.length;r++)e.candidateSendQueue.push(t[r]);if(e.candidateSendTries>5)return _("Failed to send candidates on attempt %s. Giving up for now.",e.candidateSendTries),void(e.candidateSendTries=0);const n=500*Math.pow(2,e.candidateSendTries);++e.candidateSendTries,_("Failed to send candidates. Retrying in "+n+"ms"),setTimeout((function(){b(e)}),n)}))},E=function(e,t){e.client.callList[e.callId]=e,e.webRtc.getUserMedia(t,R(e,e._maybeGotUserMediaForInvite),R(e,e._maybeGotUserMediaForInvite)),l(e,"wait_local_media"),e.direction="outbound",e.config=t},S=function(e){const t=new e.webRtc.RtcPeerConnection({iceTransportPolicy:e.forceTURN?"relay":void 0,iceServers:e.turnServers});return t.oniceconnectionstatechange=R(e,e._onIceConnectionStateChanged),t.onsignalingstatechange=R(e,e._onSignallingStateChanged),t.onicecandidate=R(e,e._gotLocalIceCandidate),t.onaddstream=R(e,e._onAddStream),t},w=function(t){const r=!!e.window.navigator.webkitGetUserMedia;switch(t){case"voice":return{audio:{deviceId:P?{ideal:P}:void 0},video:!1};case"video":return{audio:{deviceId:P?{ideal:P}:void 0},video:{deviceId:T?{ideal:T}:void 0,width:r?{exact:640}:{ideal:640},height:r?{exact:360}:{ideal:360}}}}},R=function(e,t){return function(){return t.apply(e,arguments)}},I=function(e,t){!function(e,t){const r=e.getVideoTracks();for(let e=0;e<r.length;e++)t(r[e])}(e,t),function(e,t){const r=e.getAudioTracks();for(let e=0;e<r.length;e++)t(r[e])}(e,t)};let k,P,T}).call(this,r(8))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.makeHtmlMessage=function(e,t){return{msgtype:"m.text",format:"org.matrix.custom.html",body:e,formatted_body:t}},t.makeHtmlNotice=function(e,t){return{msgtype:"m.notice",format:"org.matrix.custom.html",body:e,formatted_body:t}},t.makeHtmlEmote=function(e,t){return{msgtype:"m.emote",format:"org.matrix.custom.html",body:e,formatted_body:t}},t.makeTextMessage=function(e){return{msgtype:"m.text",body:e}},t.makeNotice=function(e){return{msgtype:"m.notice",body:e}},t.makeEmoteMessage=function(e){return{msgtype:"m.emote",body:e}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.exists=function(e,t){return new Promise((r,n)=>{let o=!0;const i=e.open(t);i.onupgradeneeded=()=>{o=!1},i.onblocked=()=>n(),i.onsuccess=()=>{i.result.close(),o||e.deleteDatabase(t),r(o)},i.onerror=e=>n(e.target.error)})}},function(e,t,r){"use strict";(function(e){var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.OlmDevice=c,t.WITHHELD_MESSAGES=void 0;var o=r(3),i=r(23),s=n(r(66));function a(e){if(void 0===e)throw new Error("payloadString undefined");if(e.length>49152){const t=new Error("Message too long ("+e.length+" bytes). The maximum for an encrypted message is 49152 bytes.");throw t.data={errcode:"M_TOO_LARGE",error:"Payload too large for encrypted message"},t}}function c(e){this._cryptoStore=e,this._pickleKey="DEFAULT_KEY",this.deviceCurve25519Key=null,this.deviceEd25519Key=null,this._maxOneTimeKeys=null,this._outboundGroupSessionStore={},this._inboundGroupSessionMessageIndexes={},this._sessionsInProgress={},this._olmPrekeyPromise=Promise.resolve()}c.prototype.init=async function(t={}){let r;const n=new e.Olm.Account,{pickleKey:o,fromExportedDevice:s}=t;try{s?(o&&console.warn("ignoring opts.pickleKey because opts.fromExportedDevice is present."),this._pickleKey=s.pickleKey,await async function(e,t,r,n){await t.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_ACCOUNT,i.IndexedDBCryptoStore.STORE_SESSIONS],r=>{t.storeAccount(r,e.pickledAccount),e.sessions.forEach(e=>{const{deviceKey:n,sessionId:o}=e,i={session:e.session,lastReceivedMessageTs:e.lastReceivedMessageTs};t.storeEndToEndSession(n,o,i,r)})}),n.unpickle(r,e.pickledAccount)}(s,this._cryptoStore,this._pickleKey,n)):(o&&(this._pickleKey=o),await async function(e,t,r){await e.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_ACCOUNT],n=>{e.getAccount(n,o=>{null!==o?r.unpickle(t,o):(r.create(),o=r.pickle(t),e.storeAccount(n,o))})})}(this._cryptoStore,this._pickleKey,n)),r=JSON.parse(n.identity_keys()),this._maxOneTimeKeys=n.max_number_of_one_time_keys()}finally{n.free()}this.deviceCurve25519Key=r.curve25519,this.deviceEd25519Key=r.ed25519},c.getOlmVersion=function(){return e.Olm.get_library_version()},c.prototype._getAccount=function(t,r){this._cryptoStore.getAccount(t,t=>{const n=new e.Olm.Account;try{n.unpickle(this._pickleKey,t),r(n)}finally{n.free()}})},c.prototype._storeAccount=function(e,t){this._cryptoStore.storeAccount(e,t.pickle(this._pickleKey))},c.prototype.export=async function(){const e={pickleKey:this._pickleKey};return await this._cryptoStore.doTxn("readonly",[i.IndexedDBCryptoStore.STORE_ACCOUNT,i.IndexedDBCryptoStore.STORE_SESSIONS],t=>{this._cryptoStore.getAccount(t,t=>{e.pickledAccount=t}),e.sessions=[],this._cryptoStore.getAllEndToEndSessions(t,t=>{e.sessions.push(t)})}),e},c.prototype._getSession=function(e,t,r,n){this._cryptoStore.getEndToEndSession(e,t,r,e=>{this._unpickleSession(e,n)})},c.prototype._unpickleSession=function(t,r){const n=new e.Olm.Session;try{n.unpickle(this._pickleKey,t.session);r(Object.assign({},t,{session:n}))}finally{n.free()}},c.prototype._saveSession=function(e,t,r){const n=t.session.session_id(),o=Object.assign(t,{session:t.session.pickle(this._pickleKey)});this._cryptoStore.storeEndToEndSession(e,n,o,r)},c.prototype._getUtility=function(t){const r=new e.Olm.Utility;try{return t(r)}finally{r.free()}},c.prototype.sign=async function(e){let t;return await this._cryptoStore.doTxn("readonly",[i.IndexedDBCryptoStore.STORE_ACCOUNT],r=>{this._getAccount(r,r=>{t=r.sign(e)})}),t},c.prototype.getOneTimeKeys=async function(){let e;return await this._cryptoStore.doTxn("readonly",[i.IndexedDBCryptoStore.STORE_ACCOUNT],t=>{this._getAccount(t,t=>{e=JSON.parse(t.one_time_keys())})}),e},c.prototype.maxNumberOfOneTimeKeys=function(){return this._maxOneTimeKeys},c.prototype.markKeysAsPublished=async function(){await this._cryptoStore.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_ACCOUNT],e=>{this._getAccount(e,t=>{t.mark_keys_as_published(),this._storeAccount(e,t)})})},c.prototype.generateOneTimeKeys=function(e){return this._cryptoStore.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_ACCOUNT],t=>{this._getAccount(t,r=>{r.generate_one_time_keys(e),this._storeAccount(t,r)})})},c.prototype.createOutboundSession=async function(t,r){let n;return await this._cryptoStore.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_ACCOUNT,i.IndexedDBCryptoStore.STORE_SESSIONS],o=>{this._getAccount(o,i=>{const s=new e.Olm.Session;try{s.create_outbound(i,t,r),n=s.session_id(),this._storeAccount(o,i);const e={session:s,lastReceivedMessageTs:Date.now()};this._saveSession(t,e,o)}finally{s.free()}})}),n},c.prototype.createInboundSession=async function(t,r,n){if(0!==r)throw new Error("Need messageType == 0 to create inbound session");let o;return await this._cryptoStore.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_ACCOUNT,i.IndexedDBCryptoStore.STORE_SESSIONS],i=>{this._getAccount(i,s=>{const a=new e.Olm.Session;try{a.create_inbound_from(s,t,n),s.remove_one_time_keys(a),this._storeAccount(i,s);const e=a.decrypt(r,n),c={session:a,lastReceivedMessageTs:Date.now()};this._saveSession(t,c,i),o={payload:e,session_id:a.session_id()}}finally{a.free()}})}),o},c.prototype.getSessionIdsForDevice=async function(e){if(this._sessionsInProgress[e]){o.logger.log("waiting for olm session to be created");try{await this._sessionsInProgress[e]}catch(e){}}let t;return await this._cryptoStore.doTxn("readonly",[i.IndexedDBCryptoStore.STORE_SESSIONS],r=>{this._cryptoStore.getEndToEndSessions(e,r,e=>{t=Object.keys(e)})}),t},c.prototype.getSessionIdForDevice=async function(e,t){const r=await this.getSessionInfoForDevice(e,t);if(0===r.length)return null;let n=0;for(let e=1;e<r.length;e++){const t=r[e],o=void 0===t.lastReceivedMessageTs?0:t.lastReceivedMessageTs,i=r[n],s=void 0===i.lastReceivedMessageTs?0:i.lastReceivedMessageTs;(o>s||o===s&&t.sessionId<i.sessionId)&&(n=e)}return r[n].sessionId},c.prototype.getSessionInfoForDevice=async function(e,t){if(this._sessionsInProgress[e]&&!t){o.logger.log("waiting for olm session to be created");try{await this._sessionsInProgress[e]}catch(e){}}const r=[];return await this._cryptoStore.doTxn("readonly",[i.IndexedDBCryptoStore.STORE_SESSIONS],t=>{this._cryptoStore.getEndToEndSessions(e,t,e=>{const t=Object.keys(e).sort();for(const n of t)this._unpickleSession(e[n],e=>{r.push({lastReceivedMessageTs:e.lastReceivedMessageTs,hasReceivedMessage:e.session.has_received_message(),sessionId:n})})})}),r},c.prototype.encryptMessage=async function(e,t,r){let n;return a(r),await this._cryptoStore.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_SESSIONS],i=>{this._getSession(e,t,i,s=>{const a=s.session.describe();o.logger.log("encryptMessage: Olm Session ID "+t+" to "+e+": "+a),n=s.session.encrypt(r),this._saveSession(e,s,i)})}),n},c.prototype.decryptMessage=async function(e,t,r,n){let s;return await this._cryptoStore.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_SESSIONS],i=>{this._getSession(e,t,i,a=>{const c=a.session.describe();o.logger.log("decryptMessage: Olm Session ID "+t+" from "+e+": "+c),s=a.session.decrypt(r,n),a.lastReceivedMessageTs=Date.now(),this._saveSession(e,a,i)})}),s},c.prototype.matchesSession=async function(e,t,r,n){if(0!==r)return!1;let o;return await this._cryptoStore.doTxn("readonly",[i.IndexedDBCryptoStore.STORE_SESSIONS],r=>{this._getSession(e,t,r,e=>{o=e.session.matches_inbound(n)})}),o},c.prototype.recordSessionProblem=async function(e,t,r){await this._cryptoStore.storeEndToEndSessionProblem(e,t,r)},c.prototype.sessionMayHaveProblems=async function(e,t){return await this._cryptoStore.getEndToEndSessionProblem(e,t)},c.prototype.filterOutNotifiedErrorDevices=async function(e){return await this._cryptoStore.filterOutNotifiedErrorDevices(e)},c.prototype._saveOutboundGroupSession=function(e){const t=e.pickle(this._pickleKey);this._outboundGroupSessionStore[e.session_id()]=t},c.prototype._getOutboundGroupSession=function(t,r){const n=this._outboundGroupSessionStore[t];if(void 0===n)throw new Error("Unknown outbound group session "+t);const o=new e.Olm.OutboundGroupSession;try{return o.unpickle(this._pickleKey,n),r(o)}finally{o.free()}},c.prototype.createOutboundGroupSession=function(){const t=new e.Olm.OutboundGroupSession;try{return t.create(),this._saveOutboundGroupSession(t),t.session_id()}finally{t.free()}},c.prototype.encryptGroupMessage=function(e,t){const r=this;return o.logger.log("encrypting msg with megolm session "+e),a(t),this._getOutboundGroupSession(e,(function(e){const n=e.encrypt(t);return r._saveOutboundGroupSession(e),n}))},c.prototype.getOutboundGroupSessionKey=function(e){return this._getOutboundGroupSession(e,(function(e){return{chain_index:e.message_index(),key:e.session_key()}}))},c.prototype._unpickleInboundGroupSession=function(t,r){const n=new e.Olm.InboundGroupSession;try{return n.unpickle(this._pickleKey,t.session),r(n)}finally{n.free()}},c.prototype._getInboundGroupSession=function(e,t,r,n,o){this._cryptoStore.getEndToEndInboundGroupSession(t,r,n,(t,r)=>{if(null!==t){if(null!==e&&e!==t.room_id)throw new Error("Mismatched room_id for inbound group session (expected "+t.room_id+", was "+e+")");this._unpickleInboundGroupSession(t,e=>{o(e,t,r)})}else o(null,null,r)})},c.prototype.addInboundGroupSession=async function(t,r,n,s,a,c,u,l={}){await this._cryptoStore.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,i.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],i=>{this._getInboundGroupSession(t,r,s,i,(d,h)=>{const p=new e.Olm.InboundGroupSession;try{if(u?p.import_session(a):p.create(a),s!=p.session_id())throw new Error("Mismatched group session ID from senderKey: "+r);if(d&&(o.logger.log("Update for megolm session "+r+"/"+s),d.first_known_index()<=p.first_known_index()))return void o.logger.log("Keeping existing megolm session "+s);o.logger.info("Storing megolm session "+r+"/"+s+" with first index "+p.first_known_index());const e=Object.assign({},l,{room_id:t,session:p.pickle(this._pickleKey),keysClaimed:c,forwardingCurve25519KeyChain:n});this._cryptoStore.storeEndToEndInboundGroupSession(r,s,e,i)}finally{p.free()}})})},c.prototype.addInboundGroupSessionWithheld=async function(e,t,r,n,o){await this._cryptoStore.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],i=>{this._cryptoStore.storeEndToEndInboundGroupSessionWithheld(t,r,{room_id:e,code:n,reason:o},i)})};const u={"m.unverified":"The sender has disabled encrypting to unverified devices.","m.blacklisted":"The sender has blocked you.","m.unauthorised":"You are not authorised to read the message.","m.no_olm":"Unable to establish a secure channel."};function l(e){return e.code&&e.code in u?u[e.code]:e.reason?e.reason:"decryption key withheld"}t.WITHHELD_MESSAGES=u,c.prototype.decryptGroupMessage=async function(e,t,r,n,o,a){let c,u;if(await this._cryptoStore.doTxn("readwrite",[i.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,i.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],i=>{this._getInboundGroupSession(e,t,r,i,(e,d,h)=>{if(null===e)return h&&(u=new s.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",l(h),{session:t+"|"+r})),void(c=null);let p;try{p=e.decrypt(n)}catch(e){return void(u=e&&"OLM.UNKNOWN_MESSAGE_INDEX"===e.message&&h?new s.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",l(h),{session:t+"|"+r}):e)}let f=p.plaintext;if(void 0===f)f=p;else{const e=t+"|"+r+"|"+p.message_index;if(e in this._inboundGroupSessionMessageIndexes){const t=this._inboundGroupSessionMessageIndexes[e];if(t.id!==o||t.timestamp!==a)return void(u=new Error("Duplicate message index, possible replay attack: "+e))}this._inboundGroupSessionMessageIndexes[e]={id:o,timestamp:a}}d.session=e.pickle(this._pickleKey),this._cryptoStore.storeEndToEndInboundGroupSession(t,r,d,i),c={result:f,keysClaimed:d.keysClaimed||{},senderKey:t,forwardingCurve25519KeyChain:d.forwardingCurve25519KeyChain||[],untrusted:d.untrusted}})}),u)throw u;return c},c.prototype.hasInboundSessionKeys=async function(e,t,r){let n;return await this._cryptoStore.doTxn("readonly",[i.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,i.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],i=>{this._cryptoStore.getEndToEndInboundGroupSession(t,r,i,i=>{null!==i?e!==i.room_id?(o.logger.warn(`requested keys for inbound group session ${t}|`+r+", with incorrect room_id "+`(expected ${i.room_id}, `+`was ${e})`),n=!1):n=!0:n=!1})}),n},c.prototype.getInboundGroupSessionKey=async function(e,t,r,n){let o;return await this._cryptoStore.doTxn("readonly",[i.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,i.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],i=>{this._getInboundGroupSession(e,t,r,i,(e,t)=>{if(null===e)return void(o=null);void 0===n&&(n=e.first_known_index());const r=e.export_session(n),i=(t.keysClaimed||{}).ed25519||null;o={chain_index:n,key:r,forwarding_curve25519_key_chain:t.forwardingCurve25519KeyChain||[],sender_claimed_ed25519_key:i}})}),o},c.prototype.exportInboundGroupSession=function(e,t,r){return this._unpickleInboundGroupSession(r,n=>{const o=n.first_known_index();return{sender_key:e,sender_claimed_keys:r.keysClaimed,room_id:r.room_id,session_id:t,session_key:n.export_session(o),forwarding_curve25519_key_chain:n.forwardingCurve25519KeyChain||[],first_known_index:n.first_known_index()}})},c.prototype.verifySignature=function(e,t,r){this._getUtility((function(n){n.ed25519_verify(e,t,r)}))}}).call(this,r(8))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),r(117),r(118);var n=r(42);Object.keys(n).forEach((function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return n[e]}})}))},function(e,t,r){"use strict";(function(e,n){Object.defineProperty(t,"__esModule",{value:!0}),t.QRCodeData=t.ReciprocateQRCode=t.SCAN_QR_CODE_METHOD=t.SHOW_QR_CODE_METHOD=void 0;var o=r(44),i=r(28),s=r(19);t.SHOW_QR_CODE_METHOD="m.qr_code.show.v1";t.SCAN_QR_CODE_METHOD="m.qr_code.scan.v1";class a extends o.VerificationBase{static factory(...e){return new a(...e)}static get NAME(){return"m.reciprocate.v1"}async _doVerification(){if(!this.startEvent)throw new Error("It is not currently possible to start verificationwith this method yet.");const{qrCodeData:e}=this.request;if(this.startEvent.getContent().secret!==e.encodedSharedSecret)throw(0,i.newKeyMismatchError)();await new Promise((e,t)=>{this.reciprocateQREvent={confirm:e,cancel:()=>t((0,i.newUserCancelledError)())},this.emit("show_reciprocate_qr",this.reciprocateQREvent)});const t={};switch(e.mode){case c:{const r=e.otherUserMasterKey;t["ed25519:"+r]=r;break}case u:{const r=this.request.targetDevice.deviceId;t["ed25519:"+r]=e.otherDeviceKey;break}case l:{const r=e.myMasterKey;t["ed25519:"+r]=r;break}}await this._verifyKeys(this.userId,t,(e,r,n)=>{const o=t[e];if(!o)throw(0,i.newKeyMismatchError)();if(n!==o)throw console.error("key ID from key info does not match"),(0,i.newKeyMismatchError)();for(const e in r.keys){if(!e.startsWith("ed25519"))continue;const n=t[e];if(!n)throw(0,i.newKeyMismatchError)();if(r.keys[e]!==n)throw console.error("master key does not match"),(0,i.newKeyMismatchError)()}})}}t.ReciprocateQRCode=a;const c=0,u=1,l=2;class d{constructor(e,t,r,n,o,i){this._sharedSecret=t,this._mode=e,this._otherUserMasterKey=r,this._otherDeviceKey=n,this._myMasterKey=o,this._buffer=i}static async create(e,t){const r=d._generateSharedSecret(),n=d._determineMode(e,t);let o=null,i=null,s=null;if(n===c){o=t.getStoredCrossSigningForUser(e.otherUserId).getId("master")}else if(n===u)i=await d._getOtherDeviceKey(e,t);else if(n===l){const e=t.getUserId();s=t.getStoredCrossSigningForUser(e).getId("master")}const a=d._generateQrData(e,t,n,r,o,i,s),h=d._generateBuffer(a);return new d(n,r,o,i,s,h)}get buffer(){return this._buffer}get mode(){return this._mode}get otherDeviceKey(){return this._otherDeviceKey}get otherUserMasterKey(){return this._otherUserMasterKey}get myMasterKey(){return this._myMasterKey}get encodedSharedSecret(){return this._sharedSecret}static _generateSharedSecret(){const t=new Uint8Array(11);return e.crypto.getRandomValues(t),(0,s.encodeUnpaddedBase64)(t)}static async _getOtherDeviceKey(e,t){const r=t.getUserId(),n=e.targetDevice,o=n?n.deviceId:null,i=t.getStoredDevice(r,o);if(!i)throw new Error("could not find device "+o);return i.getFingerprint()}static _determineMode(e,t){const r=t.getUserId(),n=e.otherUserId;let o=c;if(r===n){o=t.checkUserTrust(r).isCrossSigningVerified()?u:l}return o}static _generateQrData(e,t,r,n,o,i,s){const a=t.getUserId(),d={prefix:"MATRIX",version:2,mode:r,transactionId:e.channel.transactionId,firstKeyB64:"",secondKeyB64:"",secretB64:n},h=t.getStoredCrossSigningForUser(a);return r===c?(d.firstKeyB64=h.getId("master"),d.secondKeyB64=o):r===u?(d.firstKeyB64=h.getId("master"),d.secondKeyB64=i):r===l&&(d.firstKeyB64=t.getDeviceEd25519Key(),d.secondKeyB64=s),d}static _generateBuffer(e){let t=n.alloc(0);const r=e=>{const r=n.from([e]);t=n.concat([t,r])},o=(e,r,o=!0)=>{const i=n.from(e,r);o&&(e=>{const r=n.alloc(2);r.writeInt16BE(e,0),t=n.concat([t,r])})(i.byteLength),t=n.concat([t,i])},i=e=>{const r=(0,s.decodeBase64)(e),o=n.from(r);t=n.concat([t,o])};return o(e.prefix,"ascii",!1),r(e.version),r(e.mode),o(e.transactionId,"utf-8"),i(e.firstKeyB64),i(e.secondKeyB64),i(e.secretB64),t}}t.QRCodeData=d}).call(this,r(8),r(22).Buffer)},function(e,t,r){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.keyFromAuthData=async function(t,r){if(!e.Olm)throw new Error("Olm is not available");if(!t.private_key_salt||!t.private_key_iterations)throw new Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");return await o(r,t.private_key_salt,t.private_key_iterations,t.private_key_bits||256)},t.keyFromPassphrase=async function(t){if(!e.Olm)throw new Error("Olm is not available");const r=(0,n.randomString)(32);return{key:await o(t,r,5e5,256),salt:r,iterations:5e5}},t.deriveKey=o;var n=r(34);async function o(t,r,n,o=256){const i=e.crypto.subtle,s=e.TextEncoder;if(!i||!s)throw new Error("Password-based backup is not avaiable on this platform");const a=await i.importKey("raw",(new s).encode(t),{name:"PBKDF2"},!1,["deriveBits"]),c=await i.deriveBits({name:"PBKDF2",salt:(new s).encode(r),iterations:n,hash:"SHA-512"},a,o);return new Uint8Array(c)}}).call(this,r(8))},function(e,t,r){"use strict";(function(e,n){var o=r(14);Object.defineProperty(t,"__esModule",{value:!0}),t.encodeRecoveryKey=function(t){const r=new e(s.length+t.length+1);r.set(s,0),r.set(t,s.length);let n=0;for(let e=0;e<r.length-1;++e)n^=r[e];r[r.length-1]=n;return i.default.encode(r).match(/.{1,4}/g).join(" ")},t.decodeRecoveryKey=function(e){const t=i.default.decode(e.replace(/ /g,""));let r=0;for(const e of t)r^=e;if(0!==r)throw new Error("Incorrect parity");for(let e=0;e<s.length;++e)if(t[e]!==s[e])throw new Error("Incorrect prefix");if(t.length!==s.length+n.Olm.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");return Uint8Array.from(t.slice(s.length,s.length+n.Olm.PRIVATE_KEY_LENGTH))};var i=o(r(124));const s=[139,1]}).call(this,r(22).Buffer,r(8))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AutoDiscovery=void 0;var n=r(3),o=r(36);class i{static get ERROR_INVALID(){return"Invalid homeserver discovery response"}static get ERROR_GENERIC_FAILURE(){return"Failed to get autodiscovery configuration from server"}static get ERROR_INVALID_HS_BASE_URL(){return"Invalid base_url for m.homeserver"}static get ERROR_INVALID_HOMESERVER(){return"Homeserver URL does not appear to be a valid Matrix homeserver"}static get ERROR_INVALID_IS_BASE_URL(){return"Invalid base_url for m.identity_server"}static get ERROR_INVALID_IDENTITY_SERVER(){return"Identity server URL does not appear to be a valid identity server"}static get ERROR_INVALID_IS(){return"Invalid identity server discovery response"}static get ERROR_MISSING_WELLKNOWN(){return"No .well-known JSON file found"}static get ERROR_INVALID_JSON(){return"Invalid JSON"}static get ALL_ERRORS(){return[i.ERROR_INVALID,i.ERROR_GENERIC_FAILURE,i.ERROR_INVALID_HS_BASE_URL,i.ERROR_INVALID_HOMESERVER,i.ERROR_INVALID_IS_BASE_URL,i.ERROR_INVALID_IDENTITY_SERVER,i.ERROR_INVALID_IS,i.ERROR_MISSING_WELLKNOWN,i.ERROR_INVALID_JSON]}static get FAIL_ERROR(){return"FAIL_ERROR"}static get FAIL_PROMPT(){return"FAIL_PROMPT"}static get PROMPT(){return"PROMPT"}static get SUCCESS(){return"SUCCESS"}static async fromDiscoveryConfig(e){const t={"m.homeserver":{state:i.FAIL_ERROR,error:i.ERROR_INVALID,base_url:null},"m.identity_server":{state:i.PROMPT,error:null,base_url:null}};if(!e||!e["m.homeserver"])return n.logger.error("No m.homeserver key in config"),t["m.homeserver"].state=i.FAIL_PROMPT,t["m.homeserver"].error=i.ERROR_INVALID,Promise.resolve(t);if(!e["m.homeserver"].base_url)return n.logger.error("No m.homeserver base_url in config"),t["m.homeserver"].state=i.FAIL_PROMPT,t["m.homeserver"].error=i.ERROR_INVALID_HS_BASE_URL,Promise.resolve(t);const r=this._sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!r)return n.logger.error("Invalid base_url for m.homeserver"),t["m.homeserver"].error=i.ERROR_INVALID_HS_BASE_URL,Promise.resolve(t);const o=await this._fetchWellKnownObject(r+"/_matrix/client/versions");if(!o||!o.raw.versions)return n.logger.error("Invalid /versions response"),t["m.homeserver"].error=i.ERROR_INVALID_HOMESERVER,t["m.homeserver"].base_url=r,Promise.resolve(t);t["m.homeserver"]={state:i.SUCCESS,error:null,base_url:r};let s="";if(e["m.identity_server"]){const r={"m.homeserver":t["m.homeserver"],"m.identity_server":{state:i.FAIL_PROMPT,error:i.ERROR_INVALID_IS,base_url:null}};if(s=this._sanitizeWellKnownUrl(e["m.identity_server"].base_url),!s)return n.logger.error("Invalid base_url for m.identity_server"),r["m.identity_server"].error=i.ERROR_INVALID_IS_BASE_URL,Promise.resolve(r);const o=await this._fetchWellKnownObject(s+"/_matrix/identity/api/v1");if(!o||!o.raw||"SUCCESS"!==o.action)return n.logger.error("Invalid /api/v1 response"),r["m.identity_server"].error=i.ERROR_INVALID_IDENTITY_SERVER,r["m.identity_server"].base_url=s,Promise.resolve(r)}return s&&s.length>0&&(t["m.identity_server"]={state:i.SUCCESS,error:null,base_url:s}),Object.keys(e).map(r=>{if("m.homeserver"===r||"m.identity_server"===r){const n=["error","state","base_url"];for(const o of Object.keys(e[r]))n.includes(o)||(t[r][o]=e[r][o])}else t[r]=e[r]}),Promise.resolve(t)}static async findClientConfig(e){if(!e||"string"!=typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const t={"m.homeserver":{state:i.FAIL_ERROR,error:i.ERROR_INVALID,base_url:null},"m.identity_server":{state:i.PROMPT,error:null,base_url:null}},r=await this._fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return r&&"SUCCESS"===r.action?i.fromDiscoveryConfig(r.raw):(n.logger.error("No response or error when parsing .well-known"),r.reason&&n.logger.error(r.reason),"IGNORE"===r.action?t["m.homeserver"]={state:i.PROMPT,error:null,base_url:null}:(t["m.homeserver"].state=i.FAIL_PROMPT,t["m.homeserver"].error=i.ERROR_INVALID),Promise.resolve(t))}static async getRawClientConfig(e){if(!e||"string"!=typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");const t=await this._fetchWellKnownObject(`https://${e}/.well-known/matrix/client`);return t&&t.raw||{}}static _sanitizeWellKnownUrl(e){if(!e)return!1;try{let t=null;try{t=o.URL?new o.URL(e):new URL(e)}catch(r){t=new URL(e)}if(!t||!t.hostname)return!1;if("http:"!==t.protocol&&"https:"!==t.protocol)return!1;const r=t.port?":"+t.port:"",n=t.pathname?t.pathname:"";let i=`${t.protocol}//${t.hostname}${r}${n}`;return i.endsWith("/")&&(i=i.substring(0,i.length-1)),i}catch(e){return n.logger.error(e),!1}}static async _fetchWellKnownObject(e){return new Promise((function(t,n){const o=r(20).getRequest();if(!o)throw new Error("No request library available");o({method:"GET",uri:e,timeout:5e3},(e,r,n)=>{if(e||r&&(r.statusCode<200||r.statusCode>=300)){let n="FAIL_PROMPT",o=(e?e.message:null)||"General failure";return r&&404===r.statusCode&&(n="IGNORE",o=i.ERROR_MISSING_WELLKNOWN),void t({raw:{},action:n,reason:o,error:e})}try{t({raw:JSON.parse(n),action:"SUCCESS"})}catch(e){let r=i.ERROR_INVALID;"SyntaxError"===e.name&&(r=i.ERROR_INVALID_JSON),t({raw:{},action:"FAIL_PROMPT",reason:r,error:e})}})}))}}t.AutoDiscovery=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SyncAccumulator=void 0;var n=r(3),o=r(6);function i(e,t){null!==t.state_key&&void 0!==t.state_key&&t.type&&(e[t.type]||(e[t.type]=Object.create(null)),e[t.type][t.state_key]=t)}t.SyncAccumulator=class{constructor(e){(e=e||{}).maxTimelineEntries=e.maxTimelineEntries||50,this.opts=e,this.accountData={},this.inviteRooms={},this.joinRooms={},this.nextBatch=null,this.groups={invite:{},join:{},leave:{}}}accumulate(e){this._accumulateRooms(e),this._accumulateGroups(e),this._accumulateAccountData(e),this.nextBatch=e.next_batch}_accumulateAccountData(e){e.account_data&&e.account_data.events&&e.account_data.events.forEach(e=>{this.accountData[e.type]=e})}_accumulateRooms(e){e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach(t=>{this._accumulateRoom(t,"invite",e.rooms.invite[t])}),e.rooms.join&&Object.keys(e.rooms.join).forEach(t=>{this._accumulateRoom(t,"join",e.rooms.join[t])}),e.rooms.leave&&Object.keys(e.rooms.leave).forEach(t=>{this._accumulateRoom(t,"leave",e.rooms.leave[t])}))}_accumulateRoom(e,t,r){switch(t){case"invite":this._accumulateInviteState(e,r);break;case"join":this.inviteRooms[e]&&delete this.inviteRooms[e],this._accumulateJoinState(e,r);break;case"leave":this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:n.logger.error("Unknown cateogory: ",t)}}_accumulateInviteState(e,t){if(!t.invite_state||!t.invite_state.events)return;if(!this.inviteRooms[e])return void(this.inviteRooms[e]={invite_state:t.invite_state});const r=this.inviteRooms[e];t.invite_state.events.forEach(e=>{let t=!1;for(let n=0;n<r.invite_state.events.length;n++){const o=r.invite_state.events[n];o.type===e.type&&o.state_key==e.state_key&&(r.invite_state.events[n]=e,t=!0)}t||r.invite_state.events.push(e)})}_accumulateJoinState(e,t){this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_summary:{},_readReceipts:{}});const r=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach(e=>{r._accountData[e.type]=e}),t.unread_notifications&&(r._unreadNotifications=t.unread_notifications),t.summary){const e="m.heroes",n="m.invited_member_count",o="m.joined_member_count",i=r._summary,s=t.summary;i[e]=s[e]||i[e],i[o]=s[o]||i[o],i[n]=s[n]||i[n]}if(t.ephemeral&&t.ephemeral.events&&t.ephemeral.events.forEach(e=>{"m.receipt"===e.type&&e.content&&Object.keys(e.content).forEach(t=>{e.content[t]["m.read"]&&Object.keys(e.content[t]["m.read"]).forEach(n=>{r._readReceipts[n]={data:e.content[t]["m.read"][n],eventId:t}})})}),t.timeline&&t.timeline.limited&&(r._timeline=[]),t.state&&t.state.events&&t.state.events.forEach(e=>{i(r._currentState,e)}),t.timeline&&t.timeline.events&&t.timeline.events.forEach((e,n)=>{i(r._currentState,e),r._timeline.push({event:e,token:0===n?t.timeline.prev_batch:null})}),r._timeline.length>this.opts.maxTimelineEntries){for(let e=r._timeline.length-this.opts.maxTimelineEntries;e<r._timeline.length;e++)if(r._timeline[e].token){r._timeline=r._timeline.slice(e,r._timeline.length);break}}}_accumulateGroups(e){e.groups&&(e.groups.invite&&Object.keys(e.groups.invite).forEach(t=>{this._accumulateGroup(t,"invite",e.groups.invite[t])}),e.groups.join&&Object.keys(e.groups.join).forEach(t=>{this._accumulateGroup(t,"join",e.groups.join[t])}),e.groups.leave&&Object.keys(e.groups.leave).forEach(t=>{this._accumulateGroup(t,"leave",e.groups.leave[t])}))}_accumulateGroup(e,t,r){for(const t of["invite","join","leave"])delete this.groups[t][e];this.groups[t][e]=r}getJSON(){const e={join:{},invite:{},leave:{}};Object.keys(this.inviteRooms).forEach(t=>{e.invite[t]=this.inviteRooms[t]}),Object.keys(this.joinRooms).forEach(t=>{const r=this.joinRooms[t],n={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:r._unreadNotifications,summary:r._summary};Object.keys(r._accountData).forEach(e=>{n.account_data.events.push(r._accountData[e])});const s={type:"m.receipt",room_id:t,content:{}};Object.keys(r._readReceipts).forEach(e=>{const t=r._readReceipts[e];s.content[t.eventId]||(s.content[t.eventId]={"m.read":{}}),s.content[t.eventId]["m.read"][e]=t.data}),Object.keys(s.content).length>0&&n.ephemeral.events.push(s),r._timeline.forEach(e=>{if(!n.timeline.prev_batch){if(!e.token)return;n.timeline.prev_batch=e.token}n.timeline.events.push(e.event)});const a=Object.create(null);for(let e=n.timeline.events.length-1;e>=0;e--){const t=n.timeline.events[e];if(null===t.state_key||void 0===t.state_key)continue;const r=(0,o.deepCopy)(t);r.unsigned&&(r.unsigned.prev_content&&(r.content=r.unsigned.prev_content),r.unsigned.prev_sender&&(r.sender=r.unsigned.prev_sender)),i(a,r)}Object.keys(r._currentState).forEach(e=>{Object.keys(r._currentState[e]).forEach(t=>{let o=r._currentState[e][t];a[e]&&a[e][t]&&(o=a[e][t]),n.state.events.push(o)})}),e.join[t]=n});const t=[];return Object.keys(this.accountData).forEach(e=>{t.push(this.accountData[e])}),{nextBatch:this.nextBatch,roomsData:e,groupsData:this.groups,accountData:t}}getNextBatchToken(){return this.nextBatch}}},function(e,t,r){"use strict";var n=String.prototype.replace,o=/%20/g,i=r(46),s={RFC1738:"RFC1738",RFC3986:"RFC3986"};e.exports=i.assign({default:s.RFC3986,formatters:{RFC1738:function(e){return n.call(e,o,"+")},RFC3986:function(e){return String(e)}}},s)},function(e,t){e.exports=function(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}},function(e,t,r){"use strict";var n=r(25);e.exports=function(e){n.copy(e,this)}},function(e,t,r){"use strict";e.exports=function(e,t){t||(t={}),"function"==typeof t&&(t={cmp:t});var r,n="boolean"==typeof t.cycles&&t.cycles,o=t.cmp&&(r=t.cmp,function(e){return function(t,n){var o={key:t,value:e[t]},i={key:n,value:e[n]};return r(o,i)}}),i=[];return function e(t){if(t&&t.toJSON&&"function"==typeof t.toJSON&&(t=t.toJSON()),void 0!==t){if("number"==typeof t)return isFinite(t)?""+t:"null";if("object"!=typeof t)return JSON.stringify(t);var r,s;if(Array.isArray(t)){for(s="[",r=0;r<t.length;r++)r&&(s+=","),s+=e(t[r])||"null";return s+"]"}if(null===t)return"null";if(-1!==i.indexOf(t)){if(n)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}var a=i.push(t)-1,c=Object.keys(t).sort(o&&o(t));for(s="",r=0;r<c.length;r++){var u=c[r],l=e(t[u]);l&&(s&&(s+=","),s+=JSON.stringify(u)+":"+l)}return i.splice(a,1),"{"+s+"}"}}(e)}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n="",o=!0===e.schema.$async,i=e.util.schemaHasRulesExcept(e.schema,e.RULES.all,"$ref"),s=e.self._getId(e.schema);if(e.opts.strictKeywords){var a=e.util.schemaUnknownRules(e.schema,e.RULES.keywords);if(a){var c="unknown keyword: "+a;if("log"!==e.opts.strictKeywords)throw new Error(c);e.logger.warn(c)}}if(e.isTop&&(n+=" var validate = ",o&&(e.async=!0,n+="async "),n+="function(data, dataPath, parentData, parentDataProperty, rootData) { 'use strict'; ",s&&(e.opts.sourceCode||e.opts.processCode)&&(n+=" /*# sourceURL="+s+" */ ")),"boolean"==typeof e.schema||!i&&!e.schema.$ref){var u=e.level,l=e.dataLevel,d=e.schema["false schema"],h=e.schemaPath+e.util.getProperty("false schema"),p=e.errSchemaPath+"/false schema",f=!e.opts.allErrors,m="data"+(l||""),g="valid"+u;if(!1===e.schema){e.isTop?f=!0:n+=" var "+g+" = false; ",(X=X||[]).push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'false schema' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(p)+" , params: {} ",!1!==e.opts.messages&&(n+=" , message: 'boolean schema is false' "),e.opts.verbose&&(n+=" , schema: false , parentSchema: validate.schema"+e.schemaPath+" , data: "+m+" "),n+=" } "):n+=" {} ";var v=n;n=X.pop(),!e.compositeRule&&f?e.async?n+=" throw new ValidationError(["+v+"]); ":n+=" validate.errors = ["+v+"]; return false; ":n+=" var err = "+v+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; "}else e.isTop?n+=o?" return data; ":" validate.errors = null; return true; ":n+=" var "+g+" = true; ";return e.isTop&&(n+=" }; return validate; "),n}if(e.isTop){var y=e.isTop;u=e.level=0,l=e.dataLevel=0,m="data";if(e.rootId=e.resolve.fullPath(e.self._getId(e.root.schema)),e.baseId=e.baseId||e.rootId,delete e.isTop,e.dataPathArr=[void 0],void 0!==e.schema.default&&e.opts.useDefaults&&e.opts.strictDefaults){var _="default is ignored in the schema root";if("log"!==e.opts.strictDefaults)throw new Error(_);e.logger.warn(_)}n+=" var vErrors = null; ",n+=" var errors = 0;     ",n+=" if (rootData === undefined) rootData = data; "}else{u=e.level,m="data"+((l=e.dataLevel)||"");if(s&&(e.baseId=e.resolve.url(e.baseId,s)),o&&!e.async)throw new Error("async schema in sync schema");n+=" var errs_"+u+" = errors;"}g="valid"+u,f=!e.opts.allErrors;var b="",E="",S=e.schema.type,w=Array.isArray(S);if(S&&e.opts.nullable&&!0===e.schema.nullable&&(w?-1==S.indexOf("null")&&(S=S.concat("null")):"null"!=S&&(S=[S,"null"],w=!0)),w&&1==S.length&&(S=S[0],w=!1),e.schema.$ref&&i){if("fail"==e.opts.extendRefs)throw new Error('$ref: validation keywords used in schema at path "'+e.errSchemaPath+'" (see option extendRefs)');!0!==e.opts.extendRefs&&(i=!1,e.logger.warn('$ref: keywords ignored in schema at path "'+e.errSchemaPath+'"'))}if(e.schema.$comment&&e.opts.$comment&&(n+=" "+e.RULES.all.$comment.code(e,"$comment")),S){if(e.opts.coerceTypes)var R=e.util.coerceToTypes(e.opts.coerceTypes,S);var I=e.RULES.types[S];if(R||w||!0===I||I&&!J(I)){h=e.schemaPath+".type",p=e.errSchemaPath+"/type",h=e.schemaPath+".type",p=e.errSchemaPath+"/type";var k=w?"checkDataTypes":"checkDataType";if(n+=" if ("+e.util[k](S,m,e.opts.strictNumbers,!0)+") { ",R){var P="dataType"+u,T="coerced"+u;n+=" var "+P+" = typeof "+m+"; ","array"==e.opts.coerceTypes&&(n+=" if ("+P+" == 'object' && Array.isArray("+m+")) "+P+" = 'array'; "),n+=" var "+T+" = undefined; ";var O="",A=R;if(A)for(var D,C=-1,x=A.length-1;C<x;)D=A[C+=1],C&&(n+=" if ("+T+" === undefined) { ",O+="}"),"array"==e.opts.coerceTypes&&"array"!=D&&(n+=" if ("+P+" == 'array' && "+m+".length == 1) { "+T+" = "+m+" = "+m+"[0]; "+P+" = typeof "+m+";  } "),"string"==D?n+=" if ("+P+" == 'number' || "+P+" == 'boolean') "+T+" = '' + "+m+"; else if ("+m+" === null) "+T+" = ''; ":"number"==D||"integer"==D?(n+=" if ("+P+" == 'boolean' || "+m+" === null || ("+P+" == 'string' && "+m+" && "+m+" == +"+m+" ","integer"==D&&(n+=" && !("+m+" % 1)"),n+=")) "+T+" = +"+m+"; "):"boolean"==D?n+=" if ("+m+" === 'false' || "+m+" === 0 || "+m+" === null) "+T+" = false; else if ("+m+" === 'true' || "+m+" === 1) "+T+" = true; ":"null"==D?n+=" if ("+m+" === '' || "+m+" === 0 || "+m+" === false) "+T+" = null; ":"array"==e.opts.coerceTypes&&"array"==D&&(n+=" if ("+P+" == 'string' || "+P+" == 'number' || "+P+" == 'boolean' || "+m+" == null) "+T+" = ["+m+"]; ");n+=" "+O+" if ("+T+" === undefined) {   ",(X=X||[]).push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'type' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(p)+" , params: { type: '",n+=w?""+S.join(","):""+S,n+="' } ",!1!==e.opts.messages&&(n+=" , message: 'should be ",n+=w?""+S.join(","):""+S,n+="' "),e.opts.verbose&&(n+=" , schema: validate.schema"+h+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+m+" "),n+=" } "):n+=" {} ";v=n;n=X.pop(),!e.compositeRule&&f?e.async?n+=" throw new ValidationError(["+v+"]); ":n+=" validate.errors = ["+v+"]; return false; ":n+=" var err = "+v+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",n+=" } else {  ";var M=l?"data"+(l-1||""):"parentData";n+=" "+m+" = "+T+"; ",l||(n+="if ("+M+" !== undefined)"),n+=" "+M+"["+(l?e.dataPathArr[l]:"parentDataProperty")+"] = "+T+"; } "}else{(X=X||[]).push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'type' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(p)+" , params: { type: '",n+=w?""+S.join(","):""+S,n+="' } ",!1!==e.opts.messages&&(n+=" , message: 'should be ",n+=w?""+S.join(","):""+S,n+="' "),e.opts.verbose&&(n+=" , schema: validate.schema"+h+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+m+" "),n+=" } "):n+=" {} ";v=n;n=X.pop(),!e.compositeRule&&f?e.async?n+=" throw new ValidationError(["+v+"]); ":n+=" validate.errors = ["+v+"]; return false; ":n+=" var err = "+v+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; "}n+=" } "}}if(e.schema.$ref&&!i)n+=" "+e.RULES.all.$ref.code(e,"$ref")+" ",f&&(n+=" } if (errors === ",n+=y?"0":"errs_"+u,n+=") { ",E+="}");else{var j=e.RULES;if(j)for(var U=-1,N=j.length-1;U<N;)if(J(I=j[U+=1])){if(I.type&&(n+=" if ("+e.util.checkDataType(I.type,m,e.opts.strictNumbers)+") { "),e.opts.useDefaults)if("object"==I.type&&e.schema.properties){d=e.schema.properties;var F=Object.keys(d);if(F)for(var L,K=-1,B=F.length-1;K<B;){if(void 0!==(V=d[L=F[K+=1]]).default){var q=m+e.util.getProperty(L);if(e.compositeRule){if(e.opts.strictDefaults){_="default is ignored for: "+q;if("log"!==e.opts.strictDefaults)throw new Error(_);e.logger.warn(_)}}else n+=" if ("+q+" === undefined ","empty"==e.opts.useDefaults&&(n+=" || "+q+" === null || "+q+" === '' "),n+=" ) "+q+" = ","shared"==e.opts.useDefaults?n+=" "+e.useDefault(V.default)+" ":n+=" "+JSON.stringify(V.default)+" ",n+="; "}}}else if("array"==I.type&&Array.isArray(e.schema.items)){var $=e.schema.items;if($){C=-1;for(var V,G=$.length-1;C<G;)if(void 0!==(V=$[C+=1]).default){q=m+"["+C+"]";if(e.compositeRule){if(e.opts.strictDefaults){_="default is ignored for: "+q;if("log"!==e.opts.strictDefaults)throw new Error(_);e.logger.warn(_)}}else n+=" if ("+q+" === undefined ","empty"==e.opts.useDefaults&&(n+=" || "+q+" === null || "+q+" === '' "),n+=" ) "+q+" = ","shared"==e.opts.useDefaults?n+=" "+e.useDefault(V.default)+" ":n+=" "+JSON.stringify(V.default)+" ",n+="; "}}}var H=I.rules;if(H)for(var z,W=-1,Q=H.length-1;W<Q;)if(Z(z=H[W+=1])){var Y=z.code(e,z.keyword,I.type);Y&&(n+=" "+Y+" ",f&&(b+="}"))}if(f&&(n+=" "+b+" ",b=""),I.type&&(n+=" } ",S&&S===I.type&&!R)){n+=" else { ";var X;h=e.schemaPath+".type",p=e.errSchemaPath+"/type";(X=X||[]).push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'type' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(p)+" , params: { type: '",n+=w?""+S.join(","):""+S,n+="' } ",!1!==e.opts.messages&&(n+=" , message: 'should be ",n+=w?""+S.join(","):""+S,n+="' "),e.opts.verbose&&(n+=" , schema: validate.schema"+h+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+m+" "),n+=" } "):n+=" {} ";v=n;n=X.pop(),!e.compositeRule&&f?e.async?n+=" throw new ValidationError(["+v+"]); ":n+=" validate.errors = ["+v+"]; return false; ":n+=" var err = "+v+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",n+=" } "}f&&(n+=" if (errors === ",n+=y?"0":"errs_"+u,n+=") { ",E+="}")}}function J(e){for(var t=e.rules,r=0;r<t.length;r++)if(Z(t[r]))return!0}function Z(t){return void 0!==e.schema[t.keyword]||t.implements&&function(t){for(var r=t.implements,n=0;n<r.length;n++)if(void 0!==e.schema[r[n]])return!0}(t)}return f&&(n+=" "+E+" "),y?(o?(n+=" if (errors === 0) return data;           ",n+=" else throw new ValidationError(vErrors); "):(n+=" validate.errors = vErrors; ",n+=" return errors === 0;       "),n+=" }; return validate;"):n+=" var "+g+" = errors === errs_"+u+";",n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n,o=" ",i=e.level,s=e.dataLevel,a=e.schema[t],c=e.schemaPath+e.util.getProperty(t),u=e.errSchemaPath+"/"+t,l=!e.opts.allErrors,d="data"+(s||""),h=e.opts.$data&&a&&a.$data;h?(o+=" var schema"+i+" = "+e.util.getData(a.$data,s,e.dataPathArr)+"; ",n="schema"+i):n=a;var p="maximum"==t,f=p?"exclusiveMaximum":"exclusiveMinimum",m=e.schema[f],g=e.opts.$data&&m&&m.$data,v=p?"<":">",y=p?">":"<",_=void 0;if(!h&&"number"!=typeof a&&void 0!==a)throw new Error(t+" must be number");if(!g&&void 0!==m&&"number"!=typeof m&&"boolean"!=typeof m)throw new Error(f+" must be number or boolean");if(g){var b=e.util.getData(m.$data,s,e.dataPathArr),E="exclusive"+i,S="exclType"+i,w="exclIsNumber"+i,R="' + "+(P="op"+i)+" + '";o+=" var schemaExcl"+i+" = "+b+"; ",o+=" var "+E+"; var "+S+" = typeof "+(b="schemaExcl"+i)+"; if ("+S+" != 'boolean' && "+S+" != 'undefined' && "+S+" != 'number') { ";var I;_=f;(I=I||[]).push(o),o="",!1!==e.createErrors?(o+=" { keyword: '"+(_||"_exclusiveLimit")+"' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(u)+" , params: {} ",!1!==e.opts.messages&&(o+=" , message: '"+f+" should be boolean' "),e.opts.verbose&&(o+=" , schema: validate.schema"+c+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+d+" "),o+=" } "):o+=" {} ";var k=o;o=I.pop(),!e.compositeRule&&l?e.async?o+=" throw new ValidationError(["+k+"]); ":o+=" validate.errors = ["+k+"]; return false; ":o+=" var err = "+k+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",o+=" } else if ( ",h&&(o+=" ("+n+" !== undefined && typeof "+n+" != 'number') || "),o+=" "+S+" == 'number' ? ( ("+E+" = "+n+" === undefined || "+b+" "+v+"= "+n+") ? "+d+" "+y+"= "+b+" : "+d+" "+y+" "+n+" ) : ( ("+E+" = "+b+" === true) ? "+d+" "+y+"= "+n+" : "+d+" "+y+" "+n+" ) || "+d+" !== "+d+") { var op"+i+" = "+E+" ? '"+v+"' : '"+v+"='; ",void 0===a&&(_=f,u=e.errSchemaPath+"/"+f,n=b,h=g)}else{R=v;if((w="number"==typeof m)&&h){var P="'"+R+"'";o+=" if ( ",h&&(o+=" ("+n+" !== undefined && typeof "+n+" != 'number') || "),o+=" ( "+n+" === undefined || "+m+" "+v+"= "+n+" ? "+d+" "+y+"= "+m+" : "+d+" "+y+" "+n+" ) || "+d+" !== "+d+") { "}else{w&&void 0===a?(E=!0,_=f,u=e.errSchemaPath+"/"+f,n=m,y+="="):(w&&(n=Math[p?"min":"max"](m,a)),m===(!w||n)?(E=!0,_=f,u=e.errSchemaPath+"/"+f,y+="="):(E=!1,R+="="));P="'"+R+"'";o+=" if ( ",h&&(o+=" ("+n+" !== undefined && typeof "+n+" != 'number') || "),o+=" "+d+" "+y+" "+n+" || "+d+" !== "+d+") { "}}_=_||t,(I=I||[]).push(o),o="",!1!==e.createErrors?(o+=" { keyword: '"+(_||"_limit")+"' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(u)+" , params: { comparison: "+P+", limit: "+n+", exclusive: "+E+" } ",!1!==e.opts.messages&&(o+=" , message: 'should be "+R+" ",o+=h?"' + "+n:n+"'"),e.opts.verbose&&(o+=" , schema:  ",o+=h?"validate.schema"+c:""+a,o+="         , parentSchema: validate.schema"+e.schemaPath+" , data: "+d+" "),o+=" } "):o+=" {} ";k=o;return o=I.pop(),!e.compositeRule&&l?e.async?o+=" throw new ValidationError(["+k+"]); ":o+=" validate.errors = ["+k+"]; return false; ":o+=" var err = "+k+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",o+=" } ",l&&(o+=" else { "),o}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n,o=" ",i=e.level,s=e.dataLevel,a=e.schema[t],c=e.schemaPath+e.util.getProperty(t),u=e.errSchemaPath+"/"+t,l=!e.opts.allErrors,d="data"+(s||""),h=e.opts.$data&&a&&a.$data;if(h?(o+=" var schema"+i+" = "+e.util.getData(a.$data,s,e.dataPathArr)+"; ",n="schema"+i):n=a,!h&&"number"!=typeof a)throw new Error(t+" must be number");o+="if ( ",h&&(o+=" ("+n+" !== undefined && typeof "+n+" != 'number') || "),o+=" "+d+".length "+("maxItems"==t?">":"<")+" "+n+") { ";var p=t,f=f||[];f.push(o),o="",!1!==e.createErrors?(o+=" { keyword: '"+(p||"_limitItems")+"' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(u)+" , params: { limit: "+n+" } ",!1!==e.opts.messages&&(o+=" , message: 'should NOT have ",o+="maxItems"==t?"more":"fewer",o+=" than ",o+=h?"' + "+n+" + '":""+a,o+=" items' "),e.opts.verbose&&(o+=" , schema:  ",o+=h?"validate.schema"+c:""+a,o+="         , parentSchema: validate.schema"+e.schemaPath+" , data: "+d+" "),o+=" } "):o+=" {} ";var m=o;return o=f.pop(),!e.compositeRule&&l?e.async?o+=" throw new ValidationError(["+m+"]); ":o+=" validate.errors = ["+m+"]; return false; ":o+=" var err = "+m+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",o+="} ",l&&(o+=" else { "),o}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n,o=" ",i=e.level,s=e.dataLevel,a=e.schema[t],c=e.schemaPath+e.util.getProperty(t),u=e.errSchemaPath+"/"+t,l=!e.opts.allErrors,d="data"+(s||""),h=e.opts.$data&&a&&a.$data;if(h?(o+=" var schema"+i+" = "+e.util.getData(a.$data,s,e.dataPathArr)+"; ",n="schema"+i):n=a,!h&&"number"!=typeof a)throw new Error(t+" must be number");var p="maxLength"==t?">":"<";o+="if ( ",h&&(o+=" ("+n+" !== undefined && typeof "+n+" != 'number') || "),!1===e.opts.unicode?o+=" "+d+".length ":o+=" ucs2length("+d+") ",o+=" "+p+" "+n+") { ";var f=t,m=m||[];m.push(o),o="",!1!==e.createErrors?(o+=" { keyword: '"+(f||"_limitLength")+"' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(u)+" , params: { limit: "+n+" } ",!1!==e.opts.messages&&(o+=" , message: 'should NOT be ",o+="maxLength"==t?"longer":"shorter",o+=" than ",o+=h?"' + "+n+" + '":""+a,o+=" characters' "),e.opts.verbose&&(o+=" , schema:  ",o+=h?"validate.schema"+c:""+a,o+="         , parentSchema: validate.schema"+e.schemaPath+" , data: "+d+" "),o+=" } "):o+=" {} ";var g=o;return o=m.pop(),!e.compositeRule&&l?e.async?o+=" throw new ValidationError(["+g+"]); ":o+=" validate.errors = ["+g+"]; return false; ":o+=" var err = "+g+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",o+="} ",l&&(o+=" else { "),o}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n,o=" ",i=e.level,s=e.dataLevel,a=e.schema[t],c=e.schemaPath+e.util.getProperty(t),u=e.errSchemaPath+"/"+t,l=!e.opts.allErrors,d="data"+(s||""),h=e.opts.$data&&a&&a.$data;if(h?(o+=" var schema"+i+" = "+e.util.getData(a.$data,s,e.dataPathArr)+"; ",n="schema"+i):n=a,!h&&"number"!=typeof a)throw new Error(t+" must be number");o+="if ( ",h&&(o+=" ("+n+" !== undefined && typeof "+n+" != 'number') || "),o+=" Object.keys("+d+").length "+("maxProperties"==t?">":"<")+" "+n+") { ";var p=t,f=f||[];f.push(o),o="",!1!==e.createErrors?(o+=" { keyword: '"+(p||"_limitProperties")+"' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(u)+" , params: { limit: "+n+" } ",!1!==e.opts.messages&&(o+=" , message: 'should NOT have ",o+="maxProperties"==t?"more":"fewer",o+=" than ",o+=h?"' + "+n+" + '":""+a,o+=" properties' "),e.opts.verbose&&(o+=" , schema:  ",o+=h?"validate.schema"+c:""+a,o+="         , parentSchema: validate.schema"+e.schemaPath+" , data: "+d+" "),o+=" } "):o+=" {} ";var m=o;return o=f.pop(),!e.compositeRule&&l?e.async?o+=" throw new ValidationError(["+m+"]); ":o+=" validate.errors = ["+m+"]; return false; ":o+=" var err = "+m+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",o+="} ",l&&(o+=" else { "),o}},function(e){e.exports=JSON.parse('{"$schema":"http://json-schema.org/draft-07/schema#","$id":"http://json-schema.org/draft-07/schema#","title":"Core schema meta-schema","definitions":{"schemaArray":{"type":"array","minItems":1,"items":{"$ref":"#"}},"nonNegativeInteger":{"type":"integer","minimum":0},"nonNegativeIntegerDefault0":{"allOf":[{"$ref":"#/definitions/nonNegativeInteger"},{"default":0}]},"simpleTypes":{"enum":["array","boolean","integer","null","number","object","string"]},"stringArray":{"type":"array","items":{"type":"string"},"uniqueItems":true,"default":[]}},"type":["object","boolean"],"properties":{"$id":{"type":"string","format":"uri-reference"},"$schema":{"type":"string","format":"uri"},"$ref":{"type":"string","format":"uri-reference"},"$comment":{"type":"string"},"title":{"type":"string"},"description":{"type":"string"},"default":true,"readOnly":{"type":"boolean","default":false},"examples":{"type":"array","items":true},"multipleOf":{"type":"number","exclusiveMinimum":0},"maximum":{"type":"number"},"exclusiveMaximum":{"type":"number"},"minimum":{"type":"number"},"exclusiveMinimum":{"type":"number"},"maxLength":{"$ref":"#/definitions/nonNegativeInteger"},"minLength":{"$ref":"#/definitions/nonNegativeIntegerDefault0"},"pattern":{"type":"string","format":"regex"},"additionalItems":{"$ref":"#"},"items":{"anyOf":[{"$ref":"#"},{"$ref":"#/definitions/schemaArray"}],"default":true},"maxItems":{"$ref":"#/definitions/nonNegativeInteger"},"minItems":{"$ref":"#/definitions/nonNegativeIntegerDefault0"},"uniqueItems":{"type":"boolean","default":false},"contains":{"$ref":"#"},"maxProperties":{"$ref":"#/definitions/nonNegativeInteger"},"minProperties":{"$ref":"#/definitions/nonNegativeIntegerDefault0"},"required":{"$ref":"#/definitions/stringArray"},"additionalProperties":{"$ref":"#"},"definitions":{"type":"object","additionalProperties":{"$ref":"#"},"default":{}},"properties":{"type":"object","additionalProperties":{"$ref":"#"},"default":{}},"patternProperties":{"type":"object","additionalProperties":{"$ref":"#"},"propertyNames":{"format":"regex"},"default":{}},"dependencies":{"type":"object","additionalProperties":{"anyOf":[{"$ref":"#"},{"$ref":"#/definitions/stringArray"}]}},"propertyNames":{"$ref":"#"},"const":true,"enum":{"type":"array","items":true,"minItems":1,"uniqueItems":true},"type":{"anyOf":[{"$ref":"#/definitions/simpleTypes"},{"type":"array","items":{"$ref":"#/definitions/simpleTypes"},"minItems":1,"uniqueItems":true}]},"format":{"type":"string"},"contentMediaType":{"type":"string"},"contentEncoding":{"type":"string"},"if":{"$ref":"#"},"then":{"$ref":"#"},"else":{"$ref":"#"},"allOf":{"$ref":"#/definitions/schemaArray"},"anyOf":{"$ref":"#/definitions/schemaArray"},"oneOf":{"$ref":"#/definitions/schemaArray"},"not":{"$ref":"#"}},"default":true}')},function(e,t){e.exports=function(e){this.wrapped=e}},function(e,t,r){"use strict";(function(e){var n=r(14),o=r(5);Object.defineProperty(t,"__esModule",{value:!0});var i={};t.default=void 0;var s=o(r(20));Object.keys(s).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(i,e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))}));var a=n(r(136)),c=n(r(137));let u;s.request((function(e,t){return e.qs=c.default.stringify(e.qs||{},e.qsStringifyOptions),(0,a.default)(e,t)}));try{u=e.indexedDB}catch(e){}u&&s.setCryptoStoreFactory((function(){return new s.IndexedDBCryptoStore(u,"matrix-js-sdk:crypto")}));var l=s;t.default=l,e.matrixcs=s}).call(this,r(8))},function(e,t,r){"use strict";(function(e){const t=r(85),n=(e,r)=>function(){const n=e.apply(t,arguments);return`[${n+r}m`},o=(e,r)=>function(){const n=e.apply(t,arguments);return`[${38+r};5;${n}m`},i=(e,r)=>function(){const n=e.apply(t,arguments);return`[${38+r};2;${n[0]};${n[1]};${n[2]}m`};Object.defineProperty(e,"exports",{enumerable:!0,get:function(){const e=new Map,r={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],gray:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};r.color.grey=r.color.gray;for(const t of Object.keys(r)){const n=r[t];for(const t of Object.keys(n)){const o=n[t];r[t]={open:`[${o[0]}m`,close:`[${o[1]}m`},n[t]=r[t],e.set(o[0],o[1])}Object.defineProperty(r,t,{value:n,enumerable:!1}),Object.defineProperty(r,"codes",{value:e,enumerable:!1})}const s=e=>e,a=(e,t,r)=>[e,t,r];r.color.close="[39m",r.bgColor.close="[49m",r.color.ansi={ansi:n(s,0)},r.color.ansi256={ansi256:o(s,0)},r.color.ansi16m={rgb:i(a,0)},r.bgColor.ansi={ansi:n(s,10)},r.bgColor.ansi256={ansi256:o(s,10)},r.bgColor.ansi16m={rgb:i(a,10)};for(let e of Object.keys(t)){if("object"!=typeof t[e])continue;const s=t[e];"ansi16"===e&&(e="ansi"),"ansi16"in s&&(r.color.ansi[e]=n(s.ansi16,0),r.bgColor.ansi[e]=n(s.ansi16,10)),"ansi256"in s&&(r.color.ansi256[e]=o(s.ansi256,0),r.bgColor.ansi256[e]=o(s.ansi256,10)),"rgb"in s&&(r.color.ansi16m[e]=i(s.rgb,0),r.bgColor.ansi16m[e]=i(s.rgb,10))}return r}})}).call(this,r(54)(e))},function(e,t,r){var n=r(55),o=r(87),i={};Object.keys(n).forEach((function(e){i[e]={},Object.defineProperty(i[e],"channels",{value:n[e].channels}),Object.defineProperty(i[e],"labels",{value:n[e].labels});var t=o(e);Object.keys(t).forEach((function(r){var n=t[r];i[e][r]=function(e){var t=function(t){if(null==t)return t;arguments.length>1&&(t=Array.prototype.slice.call(arguments));var r=e(t);if("object"==typeof r)for(var n=r.length,o=0;o<n;o++)r[o]=Math.round(r[o]);return r};return"conversion"in e&&(t.conversion=e.conversion),t}(n),i[e][r].raw=function(e){var t=function(t){return null==t?t:(arguments.length>1&&(t=Array.prototype.slice.call(arguments)),e(t))};return"conversion"in e&&(t.conversion=e.conversion),t}(n)}))})),e.exports=i},function(e,t,r){"use strict";e.exports={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]}},function(e,t,r){var n=r(55);function o(e){var t=function(){for(var e={},t=Object.keys(n),r=t.length,o=0;o<r;o++)e[t[o]]={distance:-1,parent:null};return e}(),r=[e];for(t[e].distance=0;r.length;)for(var o=r.pop(),i=Object.keys(n[o]),s=i.length,a=0;a<s;a++){var c=i[a],u=t[c];-1===u.distance&&(u.distance=t[o].distance+1,u.parent=o,r.unshift(c))}return t}function i(e,t){return function(r){return t(e(r))}}function s(e,t){for(var r=[t[e].parent,e],o=n[t[e].parent][e],s=t[e].parent;t[s].parent;)r.unshift(t[s].parent),o=i(n[t[s].parent][s],o),s=t[s].parent;return o.conversion=r,o}e.exports=function(e){for(var t=o(e),r={},n=Object.keys(t),i=n.length,a=0;a<i;a++){var c=n[a];null!==t[c].parent&&(r[c]=s(c,t))}return r}},function(e,t,r){"use strict";e.exports={stdout:!1,stderr:!1}},function(e,t,r){"use strict";e.exports={stringReplaceAll:(e,t,r)=>{let n=e.indexOf(t);if(-1===n)return e;const o=t.length;let i=0,s="";do{s+=e.substr(i,n-i)+t+r,i=n+o,n=e.indexOf(t,i)}while(-1!==n);return s+=e.substr(i),s},stringEncaseCRLFWithFirstIndex:(e,t,r,n)=>{let o=0,i="";do{const s="\r"===e[n-1];i+=e.substr(o,(s?n-1:n)-o)+t+(s?"\r\n":"\n")+r,o=n+1,n=e.indexOf("\n",o)}while(-1!==n);return i+=e.substr(o),i}}},function(e,t,r){"use strict";const n=/(?:\\(u(?:[a-f\d]{4}|\{[a-f\d]{1,6}\})|x[a-f\d]{2}|.))|(?:\{(~)?(\w+(?:\([^)]*\))?(?:\.\w+(?:\([^)]*\))?)*)(?:[ \t]|(?=\r?\n)))|(\})|((?:.|[\r\n\f])+?)/gi,o=/(?:^|\.)(\w+)(?:\(([^)]*)\))?/g,i=/^(['"])((?:\\.|(?!\1)[^\\])*)\1$/,s=/\\(u(?:[a-f\d]{4}|{[a-f\d]{1,6}})|x[a-f\d]{2}|.)|([^\\])/gi,a=new Map([["n","\n"],["r","\r"],["t","\t"],["b","\b"],["f","\f"],["v","\v"],["0","\0"],["\\","\\"],["e",""],["a",""]]);function c(e){const t="u"===e[0],r="{"===e[1];return t&&!r&&5===e.length||"x"===e[0]&&3===e.length?String.fromCharCode(parseInt(e.slice(1),16)):t&&r?String.fromCodePoint(parseInt(e.slice(2,-1),16)):a.get(e)||e}function u(e,t){const r=[],n=t.trim().split(/\s*,\s*/g);let o;for(const t of n){const n=Number(t);if(Number.isNaN(n)){if(!(o=t.match(i)))throw new Error(`Invalid Chalk template style argument: ${t} (in style '${e}')`);r.push(o[2].replace(s,(e,t,r)=>t?c(t):r))}else r.push(n)}return r}function l(e){o.lastIndex=0;const t=[];let r;for(;null!==(r=o.exec(e));){const e=r[1];if(r[2]){const n=u(e,r[2]);t.push([e].concat(n))}else t.push([e])}return t}function d(e,t){const r={};for(const e of t)for(const t of e.styles)r[t[0]]=e.inverse?null:t.slice(1);let n=e;for(const[e,t]of Object.entries(r))if(Array.isArray(t)){if(!(e in n))throw new Error("Unknown Chalk style: "+e);n=t.length>0?n[e](...t):n[e]}return n}e.exports=(e,t)=>{const r=[],o=[];let i=[];if(t.replace(n,(t,n,s,a,u,h)=>{if(n)i.push(c(n));else if(a){const t=i.join("");i=[],o.push(0===r.length?t:d(e,r)(t)),r.push({inverse:s,styles:l(a)})}else if(u){if(0===r.length)throw new Error("Found extraneous } in Chalk template literal");o.push(d(e,r)(i.join(""))),i=[],r.pop()}else i.push(h)}),o.push(i.join("")),r.length>0){const e=`Chalk template literal is missing ${r.length} closing bracket${1===r.length?"":"s"} (\`}\`)`;throw new Error(e)}return o.join("")}},function(e,t,r){"use strict";var n=r(92);var o=RegExp(Object.keys(n).map((function(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")})).join("|"),"g");function i(e){return n[e]}e.exports=function(e){return e.replace(o,i)}},function(e){e.exports=JSON.parse('{"0":"O","1":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\\u2028":" ","\\u2029":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":"_","":"_","":"_","":"_","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-.","":"","":",","":",","":",","":",","":",","":"","":"","":";","":"","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":"::=","":":","":"!","":"!","":"!","":"!!","":"!?","":"?","":"?","":"?","":"?","":"?","":"?!","":"??","":"","":".","":".","":".","":".","":".","":".","":".","":".","":".","":".,","":"..","":"..","":"...","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"<","":">","":">","":">","":"4","":"b","":"b","":"d","":"J","":"L","":"P","":"U","":"V","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","`":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'","":"\'\'","\\"":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'","":"\'\'\'","":"\'\'\'","":"\'\'\'\'","":"\'B","":"\'D","":"\'n","":"\'P","":"\'T","":"\'Y","":"(","":"(","":"(","":"(","":"(","":"((","":"()","":"(2)","":"(2O)","":"(3)","":"(4)","":"(5)","":"(6)","":"(7)","":"(8)","":"(9)","":"(a)","":"(A)","":"(b)","":"(B)","":"(c)","":"(C)","":"(d)","":"(D)","":"(e)","":"(E)","":"(f)","":"(F)","":"(g)","":"(G)","":"(h)","":"(H)","":"(i)","":"(j)","":"(J)","":"(k)","":"(K)","":"(l)","":"(l)","":"(l)","":"(L)","":"(l2)","":"(l3)","":"(l4)","":"(l5)","":"(l6)","":"(l7)","":"(l8)","":"(l9)","":"(ll)","":"(lO)","":"(M)","":"(n)","":"(N)","":"(o)","":"(O)","":"(p)","":"(P)","":"(q)","":"(Q)","":"(r)","":"(R)","":"(rn)","":"(s)","":"(S)","":"(S)","":"(t)","":"(T)","":"(u)","":"(U)","":"(v)","":"(V)","":"(w)","":"(W)","":"(x)","":"(X)","":"(y)","":"(Y)","":"(z)","":"(Z)","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":")","":")","":")","":")","":")","":"))","":"{","":"{","":"}","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"*","":"*","":"*","":"*","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"//","":"///","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\","":"\\\\\\\\","":"\\\\\\\\","":"\\\\","":"&","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"^","":"^","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"b","":"bi","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"C","":"F","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"","":"<","":"<","":"<","":"<","":"<","":"<","":"<","":"<","":"<","":"<<","":"<<<","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"==","":"===","":"=","":">","":">","":">","":">","":">","":">","":">","":"><","":">>","":">>","":">>>","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"$","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"","":"","":"","":"","":"","":"","":"2","":"2,","":"2.","":"22","":"22","":"23","":"23","":"24","":"24","":"25","":"26","":"27","":"28","":"29","":"2l","":"2l","":"2O.","":"2O","":"2O","":"","":"","":"2","":"2","":"2","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"","":"","":"","":"","":"3","":"3,","":"3.","":"3l","":"3O","":"3","":"3","":"3","":"4","":"4","":"4","":"4","":"4","":"4","":"4","":"4","":"","":"","":"","":"4,","":"4.","":"4","":"4","":"4","":"4","":"5","":"5","":"5","":"5","":"5","":"5","":"5","":"5","":"","":"5,","":"5.","":"5","":"5","":"5","":"6","":"6","":"6","":"6","":"6","":"6","":"6","":"6","":"6","":"6","":"","":"","":"","":"6,","":"6.","":"6","":"6","":"6","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"","":"7,","":"7.","":"7","":"7","":"7","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"","":"","":"8,","":"8.","":"8","":"8","":"8","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"","":"","":"","":"","":"","":"9,","":"9.","":"9","":"9","":"9","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"a","":"","":"","":"","":"","":"","":"a/c","":"a/s","":"aa","":"AA","":"ae","":"ae","":"AE","":"AE","":"ao","":"AO","":"AR","":"au","":"AU","":"av","":"av","":"AV","":"AV","":"ay","":"AY","":"","":"","":"","":"","":"","":"","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b\'","":"bl","":"","":"","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"c","":"c","":"C","":"C","":"c","":"c","":"C","":"C","":"C\'","":"c/o","":"c/u","":"\\t","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"d","":"d","":"d","":"d","":"D","":"D","":"D","":"d","":"","":"d","":"d\'","":"d","":"dz","":"dz","":"Dz","":"DZ","":"d","":"D","":"D","":"d","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"","":"","":"e","":"E","":"e","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"f","":"F","":"f","":"FAX","":"ff","":"ffi","":"ffl","":"fi","":"fl","":"f","":"","":"","":"","":"","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"","":"g","":"","":"","":"","":"g","":"G","":"G\'","":"","":"","":"","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"","":"h","":"h","":"h","":"H","":"H","":"h","":"h","":"h","":"H","":"H","":"H","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"","":"i","":"","":"","":"i","":"i","":"i","":"ii","":"iii","":"ij","":"iv","":"ix","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"j","":"J","":"J","":"","":"","":"","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"k","":"K","":"K","":"K","":"K","":"K","":"K\'","":"l","|":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","I":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"l","":"l","":"l","":"L","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l,","":"l.","":"l\'","":"l2.","":"l2","":"l2","":"l2","":"l3.","":"l3","":"l3","":"l4.","":"l4","":"l4","":"l5.","":"l5","":"l5","":"l6.","":"l6","":"l6","":"l7.","":"l7","":"l7","":"l8.","":"l8","":"l8","":"l9.","":"l9","":"l9","":"lj","":"lJ","":"Lj","":"LJ","":"ll","":"ll","":"ll","":"ll","":"ll","":"ll","":"ll.","":"lll","":"llS","":"ll","":"ll","":"ll","":"lO","":"lO.","":"lO","":"lO","":"lO","":"ls","":"lt","":"lV","":"lX","":"l","":"lz","":"l","":"l","":"l","":"l","":"l","":"l","":"lo","":"l","":"l","":"l","":"","":"","":"","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"MB","":"","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"N","":"n","":"nj","":"Nj","":"NJ","":"No","":"","":"","":"","":"","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"","":"","":"","":"","":"o","":"","":"o","":"o","":"O","":"O","":"O","":"o","":"o","":"o","":"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"o","":"o","":"O,","":"O.","":"o\'","":"O\'","":"O\'","%":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"oe","":"OE","":"o","":"oo","":"oo","":"oo","":"OO","":"OO","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"oo","":"o","":"O","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"e","":"","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"p","":"p","":"p","":"P\'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"q","":"QE","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"r","":"r","":"r","":"r","":"r","":"r\'","":"rn","m":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"Rs","":"","":"","":"","":"","":"","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"s","":"s","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"sss","":"st","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"t","":"T","":"T","":"","":"T","":"T","":"T","":"t","":"T","":"t","":"","":"T3","":"t","":"TEL","":"tf","":"ts","":"t","":"t","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"","":"","":"u","":"u","":"U","":"U","":"U","":"U\'","":"ue","":"uo","":"","":"","":"","":"","":"","":"","":"","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"VB","":"vi","":"vii","":"viii","":"Vl","":"Vll","":"Vlll","":"V","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"w","":"w","":"W","":"w","":"","":"","":"","":"","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"x","":"X","":"X","":"xi","":"xii","":"Xl","":"Xll","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"y","":"y","":"y","":"Y","":"Y","":"Y","":"","":"","":"","":"","":"","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"z","":"z","":"Z","":"z","":"Z","":"z","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"i","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"\'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"\'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":" lo","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":" lo o ","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"l","":"l","":"l","":"l","":"l","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"l","":"l","":"o","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"\'","":"/","":"","":"","":"","":"","":"","":"\'","":"","":"","":"\'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"<","":"b","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"b","":"b","":"d","":"P","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"J","":"","":"","":"","":"","":"","":"","":"","":"J","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""}')},function(e,t,r){"use strict";var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixScheduler=i;var o=n(r(6));r(3);function i(e,t){this.retryAlgorithm=e||i.RETRY_BACKOFF_RATELIMIT,this.queueAlgorithm=t||i.QUEUE_MESSAGES,this._queues={},this._activeQueues=[],this._procFn=null}function s(e){e._procFn&&o.forEach(o.filter(o.keys(e._queues),(function(t){return-1===e._activeQueues.indexOf(t)&&e._queues[t].length>0})),(function(t){e._activeQueues.push(t),c("Spinning up queue: '%s'",t),function e(t,r){const n=function(e,t){const r=e._queues[t];if(!o.isArray(r))return null;return r[0]}(t,r);if(!n){const e=t._activeQueues.indexOf(r);return e>=0&&t._activeQueues.splice(e,1),void c("Stopping queue '%s' as it is now empty",r)}c("Queue '%s' has %s pending events",r,t._queues[r].length),Promise.resolve().then(()=>t._procFn(n.event)).then((function(o){a(t,r),c("Queue '%s' sent event %s",r,n.event.getId()),n.defer.resolve(o),e(t,r)}),(function(o){n.attempts+=1;const i=t.retryAlgorithm(n.event,n.attempts,o);c("retry(%s) err=%s event_id=%s waitTime=%s",n.attempts,o,n.event.getId(),i),-1===i?(c("Queue '%s' giving up on event %s",r,n.event.getId()),a(t,r),n.defer.reject(o),e(t,r)):setTimeout((function(){e(t,r)}),i)}))}(e,t)}))}function a(e,t){const r=e._queues[t];return o.isArray(r)?r.shift():null}function c(){0}i.prototype.getQueueForEvent=function(e){const t=this.queueAlgorithm(e);return t&&this._queues[t]?o.map(this._queues[t],(function(e){return e.event})):null},i.prototype.removeEventFromQueue=function(e){const t=this.queueAlgorithm(e);if(!t||!this._queues[t])return!1;let r=!1;return o.removeElement(this._queues[t],(function(t){if(t.event.getId()===e.getId())return r=!0,!0})),r},i.prototype.setProcessFunction=function(e){this._procFn=e,s(this)},i.prototype.queueEvent=function(e){const t=this.queueAlgorithm(e);if(!t)return null;this._queues[t]||(this._queues[t]=[]);const r=o.defer();return this._queues[t].push({event:e,defer:r,attempts:0}),c("Queue algorithm dumped event %s into queue '%s'",e.getId(),t),s(this),r.promise},i.RETRY_BACKOFF_RATELIMIT=function(e,t,r){if(400===r.httpStatus||403===r.httpStatus||401===r.httpStatus)return-1;if("rejected"===r.cors)return-1;if("M_TOO_LARGE"===r.name)return-1;if("M_LIMIT_EXCEEDED"===r.name){const e=r.data.retry_after_ms;if(e)return e}return t>4?-1:1e3*Math.pow(2,t)},i.QUEUE_MESSAGES=function(e){return"m.room.message"===e.getType()||e.hasAssocation()?"message":null}},function(e,t,r){"use strict";(function(e){var n=r(5),o=r(14);Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixClient=x,t.CRYPTO_ENABLED=void 0;var i=o(r(36)),s=r(10),a=r(100),c=r(38),u=r(104),l=r(18),d=r(24),h=r(107),p=r(109),f=r(62),m=n(r(6)),g=r(29),v=r(30),y=n(r(63)),_=n(r(19)),b=r(40),E=r(113),S=r(3),w=r(116),R=r(69),I=r(68),k=r(34),P=r(37),T=r(27),O=r(70);const A=(0,w.isCryptoAvailable)();t.CRYPTO_ENABLED=A;function D(e,t,r){const n=[];for(const[o,i]of Object.entries(e))try{const e=C(i,t);e.session_id=o,e.room_id=r,n.push(e)}catch(e){S.logger.log("Failed to decrypt megolm session from backup",e)}return n}function C(e,t){return JSON.parse(t.decrypt(e.session_data.ephemeral,e.session_data.mac,e.session_data.ciphertext))}function x(e){e.baseUrl=m.ensureNoTrailingSlash(e.baseUrl),e.idBaseUrl=m.ensureNoTrailingSlash(e.idBaseUrl),a.MatrixBaseApis.call(this,e),this.olmVersion=null,this.reEmitter=new b.ReEmitter(this),this.store=e.store||new p.StubStore,this.deviceId=e.deviceId||null;const t=e.userId||null;if(this.credentials={userId:t},e.deviceToImport?this.deviceId?S.logger.warn("not importing device because device ID is provided to constructor independently of exported data"):this.credentials.userId?S.logger.warn("not importing device because user ID is provided to constructor independently of exported data"):e.deviceToImport.deviceId?(this.deviceId=e.deviceToImport.deviceId,this.credentials.userId=e.deviceToImport.userId,this._exportedOlmDeviceToImport=e.deviceToImport.olmDevice):S.logger.warn("not importing device because no device ID in exported data"):e.pickleKey&&(this.pickleKey=e.pickleKey),this.scheduler=e.scheduler,this.scheduler){const e=this;this.scheduler.setProcessFunction((async function(t){const r=e.getRoom(t.getRoomId());t.status!==l.EventStatus.SENDING&&N(r,t,l.EventStatus.SENDING);const n=await F(e,t);return r&&r.updatePendingEvent(t,l.EventStatus.SENT,n.event_id),n}))}this.clientRunning=!1,this.callList={};const r=(0,f.createNewMatrixCall)(this);this._supportsVoip=!1,r&&(!function(e){const t={};let r=[];function n(){if("SYNCING"===e.getSyncState()){if(r.some(e=>e.isBeingDecrypted()))return;const e={};for(let t=r.length-1;t>=0;t--){const n=r[t];"m.call.answer"!==n.getType()&&"m.call.hangup"!==n.getType()||(e[n.getContent().call_id]="yep")}r.forEach((function(t){"m.call.invite"===t.getType()&&e[t.getContent().call_id]||o(t)})),r=[]}}function o(r){const n=r.getContent();let o,i=n.call_id?e.callList[n.call_id]:void 0;if("m.call.invite"===r.getType()){if(r.getSender()===e.credentials.userId)return;if(r.getAge()>n.lifetime)return;if(i&&"ended"===i.state)return;if(i&&S.logger.log("WARN: Already have a MatrixCall with id %s but got an invite. Clobbering.",n.call_id),i=(0,f.createNewMatrixCall)(e,r.getRoomId(),{forceTURN:e._forceTURN}),!i)return void S.logger.log("Incoming call ID "+n.call_id+" but this client doesn't support WebRTC");if(i.callId=n.call_id,i._initWithInvite(r),e.callList[i.callId]=i,t[i.callId])for(o=0;o<t[i.callId].length;o++)i._gotRemoteIceCandidate(t[i.callId][o]);let s;const a=m.values(e.callList);for(o=0;o<a.length;++o){const e=a[o];if(i.roomId===e.roomId&&"outbound"===e.direction&&-1!==["wait_local_media","create_offer","invite_sent"].indexOf(e.state)){s=e;break}}s?"wait_local_media"===s.state||"create_offer"===s.state||s.callId>i.callId?(S.logger.log("Glare detected: answering incoming call "+i.callId+" and canceling outgoing call "+s.callId),s._replacedBy(i),i.answer()):(S.logger.log("Glare detected: rejecting incoming call "+i.callId+" and keeping outgoing call "+s.callId),i.hangup()):e.emit("Call.incoming",i)}else if("m.call.answer"===r.getType()){if(!i)return;r.getSender()===e.credentials.userId?"ringing"===i.state&&i._onAnsweredElsewhere(n):i._receivedAnswer(n)}else if("m.call.candidates"===r.getType()){if(r.getSender()===e.credentials.userId)return;if(i)for(o=0;o<n.candidates.length;o++)i._gotRemoteIceCandidate(n.candidates[o]);else t[n.call_id]||(t[n.call_id]=[]),t[n.call_id]=t[n.call_id].concat(n.candidates)}else"m.call.hangup"===r.getType()&&(i?"ended"!==i.state&&(i._onHangupReceived(n),delete e.callList[n.call_id]):(i=(0,f.createNewMatrixCall)(e,r.getRoomId()),i&&(i.callId=n.call_id,i._initWithHangup(r),e.callList[n.call_id]=i)))}e.on("sync",n),e.on("event",(function(e){(0===e.getType().indexOf("m.call.")||e.isBeingDecrypted())&&r.push(e),(e.isBeingDecrypted()||e.isDecryptionFailure())&&e.once("Event.decrypted",()=>{-1!==e.getType().indexOf("m.call.")&&(r.includes(e)?n():o(e))})}))}(this),this._supportsVoip=!0),this._syncingRetry=null,this._syncApi=null,this._peekSync=null,this._isGuest=!1,this._ongoingScrollbacks={},this.timelineSupport=Boolean(e.timelineSupport),this.urlPreviewCache={},this._notifTimelineSet=null,this.unstableClientRelationAggregation=!!e.unstableClientRelationAggregation,this._crypto=null,this._cryptoStore=e.cryptoStore,this._sessionStore=e.sessionStore,this._verificationMethods=e.verificationMethods,this._cryptoCallbacks=e.cryptoCallbacks||{},this._forceTURN=e.forceTURN||!1,this._fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this._roomList=new E.RoomList(this._cryptoStore),this._pushProcessor=new P.PushProcessor(this),this._serverVersionsCache=null,this._cachedCapabilities=null,this.on("Event.decrypted",e=>{const t=e.getPushActions(),r=this._pushProcessor.actionsForEvent(e);e.setPushActions(r);const n=this.getRoom(e.getRoomId());if(!n)return;const o=n.getUnreadNotificationCount("highlight"),i=!(!t||!t.tweaks)&&!!t.tweaks.highlight,s=!(!r||!r.tweaks)&&!!r.tweaks.highlight;if((i!==s||o>0)&&!n.hasUserReadEvent(this.getUserId(),e.getId())){let e=o;s&&!i&&e++,!s&&i&&e--,n.setUnreadNotificationCount("highlight",e);n.getUnreadNotificationCount("total")<e&&n.setUnreadNotificationCount("total",e)}}),this.on("Room.receipt",(e,t)=>{if(t&&this.isRoomEncrypted(t.roomId)){const r=e.getContent();if(!(Object.keys(r).filter(e=>Object.keys(r[e]["m.read"]).includes(this.getUserId())).length>0))return;const n=20,o=t.getLiveTimeline().getEvents();let i=0;for(let e=o.length-1;e>=0;e--){if(e===o.length-n)return;const r=o[e];if(t.hasUserReadEvent(this.getUserId(),r.getId()))break;const s=this.getPushActionsForEvent(r);i+=s.tweaks&&s.tweaks.highlight?1:0}t.setUnreadNotificationCount("highlight",i)}})}async function M(e,t,r,n,o,i){if(!e._crypto)throw new Error("End-to-End encryption disabled");await e._crypto.setDeviceVerification(t,r,n,o,i)}function j(e,t){for(const r of t)e.prototype[r]=function(...e){if(!this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto[r](...e)}}function U(e,t,r,n){return Promise.resolve().then((function(){const n=function(e,t,r){if(t.isEncrypted())return null;if(!e.isRoomEncrypted(t.getRoomId()))return null;if("m.reaction"===t.getType())return null;if(!e._crypto)throw new Error("This room is configured to use encryption, but your client does not support encryption.");return e._crypto.encryptEvent(t,r)}(e,r,t);return n?(N(t,r,l.EventStatus.ENCRYPTING),n.then(()=>{N(t,r,l.EventStatus.SENDING)})):null})).then((function(){let n;return e.scheduler&&(n=e.scheduler.queueEvent(r),n&&e.scheduler.getQueueForEvent(r).length>1&&N(t,r,l.EventStatus.QUEUED)),n||(n=F(e,r),t&&(n=n.then(e=>(t.updatePendingEvent(r,l.EventStatus.SENT,e.event_id),e)))),n})).then((function(e){return n&&n(null,e),e}),(function(e){S.logger.error("Error sending event",e.stack||e);try{r.error=e,N(t,r,l.EventStatus.NOT_SENT),e.event=r,n&&n(e)}catch(t){S.logger.error("Exception in error handler!",t.stack||e)}throw e}))}function N(e,t,r){e?e.updatePendingEvent(t,r):t.setStatus(r)}function F(e,t){const r=t._txnId?t._txnId:e.makeTxnId(),n={$roomId:t.getRoomId(),$eventType:t.getWireType(),$stateKey:t.getStateKey(),$txnId:r};let o;if(t.isState()){let e="/rooms/$roomId/state/$eventType";t.getStateKey()&&t.getStateKey().length>0&&(e="/rooms/$roomId/state/$eventType/$stateKey"),o=m.encodeUri(e,n)}else if(t.isRedaction()){const e="/rooms/$roomId/redact/$redactsEventId/$txnId";o=m.encodeUri(e,Object.assign({$redactsEventId:t.event.redacts},n))}else o=m.encodeUri("/rooms/$roomId/send/$eventType/$txnId",n);return e._http.authedRequest(void 0,"PUT",o,void 0,t.getWireContent()).then(e=>(S.logger.log(`Event sent to ${t.getRoomId()} with event id ${e.event_id}`),e))}function L(e,t,r,n,o,i){m.isFunction(o)&&(i=o,o=void 0);const s=m.encodeUri("/rooms/$room_id/$membership",{$room_id:t,$membership:n});return e._http.authedRequest(i,"POST",s,void 0,{user_id:r,reason:o})}function K(e,t,r){e&&e(r),t(r)}function B(e,t,r){e&&e(null,r),t(r)}function q(e,t){const r=Boolean(t&&t.preventReEmit);return function(t){const n=new l.MatrixEvent(t);n.isEncrypted()&&(r||e.reEmitter.reEmit(n,["Event.decrypted"]),n.attemptDecryption(e._crypto));const o=e.getRoom(n.getRoomId());return o&&!r&&o.reEmitter.reEmit(n,["Event.replaced"]),n}}m.inherits(x,s.EventEmitter),m.extend(x.prototype,a.MatrixBaseApis.prototype),x.prototype.exportDevice=async function(){if(this._crypto)return{userId:this.credentials.userId,deviceId:this.deviceId,olmDevice:await this._crypto._olmDevice.export()};S.logger.warn("not exporting device if crypto is not enabled")},x.prototype.clearStores=function(){if(this._clientRunning)throw new Error("Cannot clear stores while client is running");const e=[];return e.push(this.store.deleteAllData()),this._cryptoStore&&e.push(this._cryptoStore.deleteAllData()),Promise.all(e)},x.prototype.getUserId=function(){return this.credentials&&this.credentials.userId?this.credentials.userId:null},x.prototype.getDomain=function(){return this.credentials&&this.credentials.userId?this.credentials.userId.replace(/^.*?:/,""):null},x.prototype.getUserIdLocalpart=function(){return this.credentials&&this.credentials.userId?this.credentials.userId.split(":")[0].substring(1):null},x.prototype.getDeviceId=function(){return this.deviceId},x.prototype.supportsVoip=function(){return this._supportsVoip},x.prototype.setForceTURN=function(e){this._forceTURN=e},x.prototype.getSyncState=function(){return this._syncApi?this._syncApi.getSyncState():null},x.prototype.getSyncStateData=function(){return this._syncApi?this._syncApi.getSyncStateData():null},x.prototype.isInitialSyncComplete=function(){const e=this.getSyncState();return!!e&&("PREPARED"===e||"SYNCING"===e)},x.prototype.isGuest=function(){return this._isGuest},x.prototype.getScheduler=function(){return this.scheduler},x.prototype.setGuest=function(e){this._isGuest=e},x.prototype.retryImmediately=function(){return this._syncApi.retryImmediately()},x.prototype.getNotifTimelineSet=function(){return this._notifTimelineSet},x.prototype.setNotifTimelineSet=function(e){this._notifTimelineSet=e},x.prototype.getCapabilities=function(e=!1){const t=(new Date).getTime();return this._cachedCapabilities&&!e&&t<this._cachedCapabilities.expiration?(S.logger.log("Returning cached capabilities"),Promise.resolve(this._cachedCapabilities.capabilities)):this._http.authedRequest(void 0,"GET","/capabilities").catch(e=>(S.logger.error(e),null)).then(e=>{e||(e={});const r=e.capabilities||{},n=Object.keys(r).length?216e5:6e4+5e3*Math.random();return this._cachedCapabilities={capabilities:r,expiration:t+n},S.logger.log("Caching capabilities: ",r),r})},x.prototype.initCrypto=async function(){if(!(0,w.isCryptoAvailable)())throw new Error("End-to-end encryption not supported in this js-sdk build: did you remember to load the olm library?");if(this._crypto)return void S.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");if(!this._sessionStore)throw new Error("Cannot enable encryption: no sessionStore provided");if(!this._cryptoStore)throw new Error("Cannot enable encryption: no cryptoStore provided");S.logger.log("Crypto: Starting up crypto store..."),await this._cryptoStore.startup(),S.logger.log("Crypto: initialising roomlist..."),await this._roomList.init();const e=this.getUserId();if(null===e)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");if(null===this.deviceId)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");const t=new w.Crypto(this,this._sessionStore,e,this.deviceId,this.store,this._cryptoStore,this._roomList,this._verificationMethods);this.reEmitter.reEmit(t,["crypto.keyBackupFailed","crypto.keyBackupSessionsRemaining","crypto.roomKeyRequest","crypto.roomKeyRequestCancellation","crypto.warning","crypto.devicesUpdated","crypto.willUpdateDevices","deviceVerificationChanged","userTrustStatusChanged","crossSigning.keysChanged"]),S.logger.log("Crypto: initialising crypto object..."),await t.init({exportedOlmDevice:this._exportedOlmDeviceToImport,pickleKey:this.pickleKey}),delete this._exportedOlmDeviceToImport,this.olmVersion=w.Crypto.getOlmVersion(),t.registerEventHandlers(this),this._crypto=t},x.prototype.isCryptoEnabled=function(){return null!==this._crypto},x.prototype.getDeviceEd25519Key=function(){return this._crypto?this._crypto.getDeviceEd25519Key():null},x.prototype.getDeviceCurve25519Key=function(){return this._crypto?this._crypto.getDeviceCurve25519Key():null},x.prototype.uploadKeys=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.uploadDeviceKeys()},x.prototype.downloadKeys=function(e,t){return null===this._crypto?Promise.reject(new Error("End-to-end encryption disabled")):this._crypto.downloadKeys(e,t)},x.prototype.getStoredDevicesForUser=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.getStoredDevicesForUser(e)||[]},x.prototype.getStoredDevice=function(e,t){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.getStoredDevice(e,t)||null},x.prototype.setDeviceVerified=function(e,t,r){void 0===r&&(r=!0);const n=M(this,e,t,r,null);return e==this.credentials.userId&&this._crypto.checkKeyBackup(),n},x.prototype.setDeviceBlocked=function(e,t,r){return void 0===r&&(r=!0),M(this,e,t,null,r)},x.prototype.setDeviceKnown=function(e,t,r){return void 0===r&&(r=!0),M(this,e,t,null,null,r)},x.prototype.requestVerificationDM=function(e,t){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.requestVerificationDM(e,t)},x.prototype.findVerificationRequestDMInProgress=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.findVerificationRequestDMInProgress(e)},x.prototype.getVerificationRequestsToDeviceInProgress=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.getVerificationRequestsToDeviceInProgress(e)},x.prototype.requestVerification=function(e,t){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.requestVerification(e,t)},x.prototype.beginKeyVerification=function(e,t,r){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.beginKeyVerification(e,t,r)},x.prototype.setGlobalBlacklistUnverifiedDevices=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.setGlobalBlacklistUnverifiedDevices(e)},x.prototype.getGlobalBlacklistUnverifiedDevices=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.getGlobalBlacklistUnverifiedDevices()},x.prototype.setGlobalErrorOnUnknownDevices=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.setGlobalErrorOnUnknownDevices(e)},x.prototype.getGlobalErrorOnUnknownDevices=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.getGlobalErrorOnUnknownDevices()},j(x,["getCrossSigningId","getStoredCrossSigningForUser","checkUserTrust","checkDeviceTrust","checkOwnCrossSigningTrust","checkCrossSigningPrivateKey","legacyDeviceVerification","prepareToEncrypt","isCrossSigningReady","getCryptoTrustCrossSignedDevices","setCryptoTrustCrossSignedDevices"]),j(x,["getEventEncryptionInfo","createRecoveryKeyFromPassphrase","bootstrapSecretStorage","addSecretStorageKey","hasSecretStorageKey","storeSecret","getSecret","isSecretStored","requestSecret","getDefaultSecretStorageKeyId","setDefaultSecretStorageKeyId","checkSecretStorageKey","checkSecretStoragePrivateKey"]),x.prototype.getEventSenderDeviceInfo=async function(e){return this._crypto?this._crypto.getEventSenderDeviceInfo(e):null},x.prototype.isEventSenderVerified=async function(e){const t=await this.getEventSenderDeviceInfo(e);return!!t&&t.isVerified()},x.prototype.cancelAndResendEventRoomKeyRequest=function(e){return e.cancelAndResendKeyRequest(this._crypto,this.getUserId())},x.prototype.setRoomEncryption=function(e,t){if(!this._crypto)throw new Error("End-to-End encryption disabled");return this._crypto.setRoomEncryption(e,t)},x.prototype.isRoomEncrypted=function(e){const t=this.getRoom(e);if(!t)return!1;return!!t.currentState.getStateEvents("m.room.encryption","")||this._roomList.isRoomEncrypted(e)},x.prototype.forceDiscardSession=function(e){if(!this._crypto)throw new Error("End-to-End encryption disabled");this._crypto.forceDiscardSession(e)},x.prototype.exportRoomKeys=function(){return this._crypto?this._crypto.exportRoomKeys():Promise.reject(new Error("End-to-end encryption disabled"))},x.prototype.importRoomKeys=function(e,t){if(!this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.importRoomKeys(e,t)},x.prototype.checkKeyBackup=function(){return this._crypto.checkKeyBackup()},x.prototype.getKeyBackupVersion=function(){return this._http.authedRequest(void 0,"GET","/room_keys/version",void 0,void 0,{prefix:g.PREFIX_UNSTABLE}).then(e=>{if(e.algorithm!==_.MEGOLM_BACKUP_ALGORITHM){const t="Unknown backup algorithm: "+e.algorithm;return Promise.reject(t)}if("object"==typeof e.auth_data&&e.auth_data.public_key)return e;{const e="Invalid backup data returned";return Promise.reject(e)}}).catch(e=>{if("M_NOT_FOUND"===e.errcode)return null;throw e})},x.prototype.isKeyBackupTrusted=function(e){return this._crypto.isKeyBackupTrusted(e)},x.prototype.getKeyBackupEnabled=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto._checkedForBackup?Boolean(this._crypto.backupKey):null},x.prototype.enableKeyBackup=function(t){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.backupInfo=t,this._crypto.backupKey&&this._crypto.backupKey.free(),this._crypto.backupKey=new e.Olm.PkEncryption,this._crypto.backupKey.set_recipient_key(t.auth_data.public_key),this.emit("crypto.keyBackupStatus",!0),this._crypto.scheduleKeyBackupSend()},x.prototype.disableKeyBackup=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.backupInfo=null,this._crypto.backupKey&&this._crypto.backupKey.free(),this._crypto.backupKey=null,this.emit("crypto.keyBackupStatus",!1)},x.prototype.prepareKeyBackupVersion=async function(e,{secureSecretStorage:t=!1}={}){if(null===this._crypto)throw new Error("End-to-end encryption disabled");const{keyInfo:r,encodedPrivateKey:n,privateKey:o}=await this.createRecoveryKeyFromPassphrase(e);t&&(await this.storeSecret("m.megolm_backup.v1",(0,_.encodeBase64)(o)),S.logger.info("Key backup private key stored in secret storage"));const i={public_key:r.pubkey};return r.passphrase&&(i.private_key_salt=r.passphrase.salt,i.private_key_iterations=r.passphrase.iterations),{algorithm:_.MEGOLM_BACKUP_ALGORITHM,auth_data:i,recovery_key:n}},x.prototype.isKeyBackupKeyStored=async function(){return this.isSecretStored("m.megolm_backup.v1",!1)},x.prototype.createKeyBackupVersion=async function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");const t={algorithm:e.algorithm,auth_data:e.auth_data};await this._crypto._signObject(t.auth_data),this._cryptoCallbacks.getCrossSigningKey&&this._crypto._crossSigningInfo.getId()&&await this._crypto._crossSigningInfo.signObject(t.auth_data,"master");const r=await this._http.authedRequest(void 0,"POST","/room_keys/version",void 0,t,{prefix:g.PREFIX_UNSTABLE});return await this.checkKeyBackup(),this.getKeyBackupEnabled()||S.logger.error("Key backup not usable even though we just created it"),r},x.prototype.deleteKeyBackupVersion=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.backupInfo&&this._crypto.backupInfo.version===e&&this.disableKeyBackup();const t=m.encodeUri("/room_keys/version/$version",{$version:e});return this._http.authedRequest(void 0,"DELETE",t,void 0,void 0,{prefix:g.PREFIX_UNSTABLE})},x.prototype._makeKeyBackupPath=function(e,t,r){let n;n=void 0!==t?m.encodeUri("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):void 0!==e?m.encodeUri("/room_keys/keys/$roomId",{$roomId:e}):"/room_keys/keys";return{path:n,queryData:void 0===r?void 0:{version:r}}},x.prototype.sendKeyBackup=function(e,t,r,n){if(null===this._crypto)throw new Error("End-to-end encryption disabled");const o=this._makeKeyBackupPath(e,t,r);return this._http.authedRequest(void 0,"PUT",o.path,o.queryData,n,{prefix:g.PREFIX_UNSTABLE})},x.prototype.scheduleAllGroupSessionsForBackup=async function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");await this._crypto.scheduleAllGroupSessionsForBackup()},x.prototype.flagAllGroupSessionsForBackup=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.flagAllGroupSessionsForBackup()},x.prototype.isValidRecoveryKey=function(e){try{return(0,R.decodeRecoveryKey)(e),!0}catch(e){return!1}},x.prototype.keyBackupKeyFromPassword=function(e,t){return(0,I.keyFromAuthData)(t.auth_data,e)},x.prototype.keyBackupKeyFromRecoveryKey=function(e){return(0,R.decodeRecoveryKey)(e)},x.RESTORE_BACKUP_ERROR_BAD_KEY="RESTORE_BACKUP_ERROR_BAD_KEY",x.prototype.restoreKeyBackupWithPassword=async function(e,t,r,n,o){const i=await(0,I.keyFromAuthData)(n.auth_data,e);return this._restoreKeyBackup(i,t,r,n,o)},x.prototype.restoreKeyBackupWithSecretStorage=async function(e,t,r,n){const o=await this.getSecret("m.megolm_backup.v1"),i=(0,w.fixBackupKey)(o);if(i){const[e]=await this._crypto.getSecretStorageKey();await this.storeSecret("m.megolm_backup.v1",i,[e])}const s=(0,_.decodeBase64)(i||o);return this._restoreKeyBackup(s,t,r,e,n)},x.prototype.restoreKeyBackupWithRecoveryKey=function(e,t,r,n,o){const i=(0,R.decodeRecoveryKey)(e);return this._restoreKeyBackup(i,t,r,n,o)},x.prototype.restoreKeyBackupWithCache=async function(e,t,r,n){const o=await this._crypto.getSessionBackupPrivateKey();if(!o)throw new Error("Couldn't get key");return this._restoreKeyBackup(o,e,t,r,n)},x.prototype._restoreKeyBackup=function(t,r,n,o,{cacheCompleteCallback:i,progressCallback:s}={}){if(null===this._crypto)throw new Error("End-to-end encryption disabled");let a=0,c=[];const u=this._makeKeyBackupPath(r,n,o.version),l=new e.Olm.PkDecryption;let d;try{d=l.init_with_private_key(t)}catch(e){throw l.free(),e}return d!==o.auth_data.public_key?Promise.reject({errcode:x.RESTORE_BACKUP_ERROR_BAD_KEY}):(this._crypto.storeSessionBackupPrivateKey(t).catch(e=>{console.warn("Error caching session backup key:",e)}).then(i),s&&s({stage:"fetch"}),this._http.authedRequest(void 0,"GET",u.path,u.queryData,void 0,{prefix:g.PREFIX_UNSTABLE}).then(e=>{if(e.rooms)for(const[t,r]of Object.entries(e.rooms)){if(!r.sessions)continue;a+=Object.keys(r.sessions).length;const e=D(r.sessions,l,t);for(const r of e)r.room_id=t,c.push(r)}else if(e.sessions)a=Object.keys(e.sessions).length,c=D(e.sessions,l,r);else{a=1;try{const t=C(e,l);t.room_id=r,t.session_id=n,c.push(t)}catch(e){S.logger.log("Failed to decrypt megolm session from backup",e)}}return this.importRoomKeys(c,{progressCallback:s,untrusted:!0,source:"backup"})}).then(()=>this._crypto.setTrustedBackupPubKey(d)).then(()=>({total:a,imported:c.length})).finally(()=>{l.free()}))},x.prototype.deleteKeysFromBackup=function(e,t,r){if(null===this._crypto)throw new Error("End-to-end encryption disabled");const n=this._makeKeyBackupPath(e,t,r);return this._http.authedRequest(void 0,"DELETE",n.path,n.queryData,void 0,{prefix:g.PREFIX_UNSTABLE})},x.prototype.getGroup=function(e){return this.store.getGroup(e)},x.prototype.getGroups=function(){return this.store.getGroups()},x.prototype.getMediaConfig=function(e){return this._http.authedRequest(e,"GET","/config",void 0,void 0,{prefix:g.PREFIX_MEDIA_R0})},x.prototype.getRoom=function(e){return this.store.getRoom(e)},x.prototype.getRooms=function(){return this.store.getRooms()},x.prototype.getVisibleRooms=function(){const e=this.store.getRooms(),t=new Set;for(const r of e){const e=r.currentState.getStateEvents("m.room.create","");if(e){const r=e.getContent().predecessor;r&&r.room_id&&t.add(r.room_id)}}return e.filter(e=>!e.currentState.getStateEvents("m.room.tombstone","")||!t.has(e.roomId))},x.prototype.getUser=function(e){return this.store.getUser(e)},x.prototype.getUsers=function(){return this.store.getUsers()},x.prototype.setAccountData=function(e,t,r){const n=m.encodeUri("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e}),o=(0,g.retryNetworkOperation)(5,()=>this._http.authedRequest(void 0,"PUT",n,void 0,t));return r&&o.then(e=>r(null,e),r),o},x.prototype.getAccountData=function(e){return this.store.getAccountData(e)},x.prototype.getAccountDataFromServer=async function(e){if(this.isInitialSyncComplete()){const t=this.store.getAccountData(e);return t?t.getContent():null}const t=m.encodeUri("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});try{return await this._http.authedRequest(void 0,"GET",t,void 0)}catch(e){if(e.data&&"M_NOT_FOUND"===e.data.errcode)return null;throw e}},x.prototype.getIgnoredUsers=function(){const e=this.getAccountData("m.ignored_user_list");return e&&e.getContent()&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]},x.prototype.setIgnoredUsers=function(e,t){const r={ignored_users:{}};return e.map(e=>r.ignored_users[e]={}),this.setAccountData("m.ignored_user_list",r,t)},x.prototype.isUserIgnored=function(e){return-1!==this.getIgnoredUsers().indexOf(e)},x.prototype.joinRoom=function(e,t,r){if(m.isFunction(t))throw new Error("Expected 'opts' object, got function.");void 0===(t=t||{}).syncRoom&&(t.syncRoom=!0);const n=this.getRoom(e);if(n&&n.hasMembershipState(this.credentials.userId,"join"))return Promise.resolve(n);let o=Promise.resolve();t.inviteSignUrl&&(o=this._http.requestOtherUrl(void 0,"POST",t.inviteSignUrl,{mxid:this.credentials.userId}));const i={};t.viaServers&&(i.server_name=t.viaServers);const s={qsStringifyOptions:{arrayFormat:"repeat"}},a=this;return new Promise((n,c)=>{o.then((function(t){const r={};t&&(r.third_party_signed=t);const n=m.encodeUri("/join/$roomid",{$roomid:e});return a._http.authedRequest(void 0,"POST",n,i,r,s)})).then((function(e){const r=e.room_id,n=new u.SyncApi(a,a._clientOpts).createRoom(r);return t.syncRoom,Promise.resolve(n)})).then((function(e){B(r,n,e)}),(function(e){K(r,c,e)}))})},x.prototype.resendEvent=function(e,t){return N(t,e,l.EventStatus.SENDING),U(this,t,e)},x.prototype.cancelPendingEvent=function(e){if([l.EventStatus.QUEUED,l.EventStatus.NOT_SENT].indexOf(e.status)<0)throw new Error("cannot cancel an event with status "+e.status);this.scheduler&&this.scheduler.removeEventFromQueue(e);N(this.getRoom(e.getRoomId()),e,l.EventStatus.CANCELLED)},x.prototype.setRoomName=function(e,t,r){return this.sendStateEvent(e,"m.room.name",{name:t},void 0,r)},x.prototype.setRoomTopic=function(e,t,r){return this.sendStateEvent(e,"m.room.topic",{topic:t},void 0,r)},x.prototype.getRoomTags=function(e,t){const r=m.encodeUri("/user/$userId/rooms/$roomId/tags/",{$userId:this.credentials.userId,$roomId:e});return this._http.authedRequest(t,"GET",r,void 0)},x.prototype.setRoomTag=function(e,t,r,n){const o=m.encodeUri("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this._http.authedRequest(n,"PUT",o,void 0,r)},x.prototype.deleteRoomTag=function(e,t,r){const n=m.encodeUri("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this._http.authedRequest(r,"DELETE",n,void 0,void 0)},x.prototype.setRoomAccountData=function(e,t,r,n){const o=m.encodeUri("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this._http.authedRequest(n,"PUT",o,void 0,r)},x.prototype.setPowerLevel=function(e,t,r,n,o){let i={users:{}};n&&"m.room.power_levels"===n.getType()&&(i=m.deepCopy(n.getContent())),i.users[t]=r;const s=m.encodeUri("/rooms/$roomId/state/m.room.power_levels",{$roomId:e});return this._http.authedRequest(o,"PUT",s,void 0,i)},x.prototype.sendEvent=function(e,t,r,n,o){return this._sendCompleteEvent(e,{type:t,content:r},n,o)},x.prototype._sendCompleteEvent=function(e,t,r,n){m.isFunction(r)&&(n=r,r=void 0),r||(r=this.makeTxnId());const o=new l.MatrixEvent(Object.assign(t,{event_id:"~"+e+":"+r,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:(new Date).getTime()})),i=this.getRoom(e),s=o.getAssociatedId();if(s&&s.startsWith("~")){const e=i.getPendingEvents().find(e=>e.getId()===s);e.once("Event.localEventIdReplaced",()=>{o.updateAssociatedId(e.getId())})}const a=o.getType();return S.logger.log(`sendEvent of type ${a} in ${e} with txnId ${r}`),o._txnId=r,o.setStatus(l.EventStatus.SENDING),i&&i.addPendingEvent(o,r),o.status===l.EventStatus.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):U(this,i,o,n)},x.prototype.redactEvent=function(e,t,r,n){return this._sendCompleteEvent(e,{type:"m.room.redaction",content:{},redacts:t},r,n)},x.prototype.sendMessage=function(e,t,r,n){return m.isFunction(r)&&(n=r,r=void 0),this.sendEvent(e,"m.room.message",t,r,n)},x.prototype.sendTextMessage=function(e,t,r,n){const o=y.makeTextMessage(t);return this.sendMessage(e,o,r,n)},x.prototype.sendNotice=function(e,t,r,n){const o=y.makeNotice(t);return this.sendMessage(e,o,r,n)},x.prototype.sendEmoteMessage=function(e,t,r,n){const o=y.makeEmoteMessage(t);return this.sendMessage(e,o,r,n)},x.prototype.sendImageMessage=function(e,t,r,n,o){m.isFunction(n)&&(o=n,n=void 0),n||(n="Image");const i={msgtype:"m.image",url:t,info:r,body:n};return this.sendMessage(e,i,o)},x.prototype.sendStickerMessage=function(e,t,r,n,o){m.isFunction(n)&&(o=n,n=void 0),n||(n="Sticker");const i={url:t,info:r,body:n};return this.sendEvent(e,"m.sticker",i,o,void 0)},x.prototype.sendHtmlMessage=function(e,t,r,n){const o=y.makeHtmlMessage(t,r);return this.sendMessage(e,o,n)},x.prototype.sendHtmlNotice=function(e,t,r,n){const o=y.makeHtmlNotice(t,r);return this.sendMessage(e,o,n)},x.prototype.sendHtmlEmote=function(e,t,r,n){const o=y.makeHtmlEmote(t,r);return this.sendMessage(e,o,n)},x.prototype.sendReceipt=function(e,t,r,n){if("function"==typeof r&&(n=r,r={}),this.isGuest())return Promise.resolve({});const o=m.encodeUri("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),i=this._http.authedRequest(n,"POST",o,void 0,r||{}),s=this.getRoom(e.getRoomId());return s&&s._addLocalEchoReceipt(this.credentials.userId,e,t),i},x.prototype.sendReadReceipt=async function(e,t,r){"function"==typeof t&&(r=t,t={}),t||(t={});const n=e.getId(),o=this.getRoom(e.getRoomId());if(o&&o.hasPendingEvent(n))throw new Error(`Cannot set read receipt to a pending event (${n})`);const i={"m.hidden":Boolean(t.hidden)};return this.sendReceipt(e,"m.read",i,r)},x.prototype.setRoomReadMarkers=async function(e,t,r,n){const o=this.getRoom(e);if(o&&o.hasPendingEvent(t))throw new Error(`Cannot set read marker to a pending event (${t})`);let i;if(r){if(i=r.getId(),o&&o.hasPendingEvent(i))throw new Error(`Cannot set read receipt to a pending event (${i})`);o&&o._addLocalEchoReceipt(this.credentials.userId,r,"m.read")}return this.setRoomReadMarkersHttpRequest(e,t,i,n)},x.prototype.getUrlPreview=function(e,t,r){const n=(t=6e4*Math.floor(t/6e4))+"_"+e,o=this.urlPreviewCache[n];if(o)return r&&o.then(r).catch(r),o;const i=this._http.authedRequest(r,"GET","/preview_url",{url:e,ts:t},void 0,{prefix:g.PREFIX_MEDIA_R0});return this.urlPreviewCache[n]=i,i},x.prototype.sendTyping=function(e,t,r,n){if(this.isGuest())return Promise.resolve({});const o=m.encodeUri("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.credentials.userId}),i={typing:t};return t&&(i.timeout=r||2e4),this._http.authedRequest(n,"PUT",o,void 0,i)},x.prototype.getRoomUpgradeHistory=function(e,t=!1){let r=this.getRoom(e);if(!r)return[];const n=[r];let o=r.currentState.getStateEvents("m.room.create","");for(;o;){S.logger.log("Looking at "+o.getId());const e=o.getContent().predecessor;if(!e||!e.room_id)break;{S.logger.log("Looking at predecessor "+e.room_id);const r=this.getRoom(e.room_id);if(!r)break;if(t){const e=r.currentState.getStateEvents("m.room.tombstone","");if(!e||e.getContent().replacement_room!==r.roomId)break}n.splice(0,0,r),o=r.currentState.getStateEvents("m.room.create","")}}let i=r.currentState.getStateEvents("m.room.tombstone","");for(;i;){const e=this.getRoom(i.getContent().replacement_room);if(!e)break;if(e.roomId===r.roomId)break;if(t){if(o=e.currentState.getStateEvents("m.room.create",""),!o||!o.getContent().predecessor)break;if(o.getContent().predecessor.room_id!==r.roomId)break}n.push(e);if(new Set(n.map(e=>e.roomId)).size<n.length)return n.slice(0,n.length-1);r=e,i=r.currentState.getStateEvents("m.room.tombstone","")}return n},x.prototype.invite=function(e,t,r){return L(this,e,t,"invite",void 0,r)},x.prototype.inviteByEmail=function(e,t,r){return this.inviteByThreePid(e,"email",t,r)},x.prototype.inviteByThreePid=async function(e,t,r,n){const o=m.encodeUri("/rooms/$roomId/invite",{$roomId:e}),i=this.getIdentityServerUrl(!0);if(!i)return Promise.reject(new g.MatrixError({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));const s={id_server:i,medium:t,address:r};if(this.identityServer&&this.identityServer.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();e&&(s.id_access_token=e)}return this._http.authedRequest(n,"POST",o,void 0,s)},x.prototype.leave=function(e,t){return L(this,e,void 0,"leave",void 0,t)},x.prototype.leaveRoomChain=function(e,t=!0){const r=this.getRoomUpgradeHistory(e);let n=r;if(!t){n=[];for(const t of r)if(n.push(t),t.roomId===e)break}const o={},i=[],s=e=>this.leave(e).then(()=>{o[e]=null}).catch(t=>(o[e]=t,null));for(const e of n)i.push(s(e.roomId));return Promise.all(i).then(()=>o)},x.prototype.ban=function(e,t,r,n){return L(this,e,t,"ban",r,n)},x.prototype.forget=function(e,t,r){void 0===t&&(t=!0);const n=L(this,e,void 0,"forget",void 0,r);if(!t)return n;const o=this;return n.then((function(t){return o.store.removeRoom(e),o.emit("deleteRoom",e),t}))},x.prototype.unban=function(e,t,r){const n=m.encodeUri("/rooms/$roomId/unban",{$roomId:e}),o={user_id:t};return this._http.authedRequest(r,"POST",n,void 0,o)},x.prototype.kick=function(e,t,r,n){return function(e,t,r,n,o,i){m.isFunction(o)&&(i=o,o=void 0);const s=m.encodeUri("/rooms/$roomId/state/m.room.member/$userId",{$roomId:t,$userId:r});return e._http.authedRequest(i,"PUT",s,void 0,{membership:n,reason:o})}(this,e,t,"leave",r,n)},x.prototype.getPushActionsForEvent=function(e){return e.getPushActions()||e.setPushActions(this._pushProcessor.actionsForEvent(e)),e.getPushActions()},x.prototype.setProfileInfo=function(e,t,r){const n=m.encodeUri("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this._http.authedRequest(r,"PUT",n,void 0,t)},x.prototype.setDisplayName=function(e,t){return this.setProfileInfo("displayname",{displayname:e},t)},x.prototype.setAvatarUrl=function(e,t){return this.setProfileInfo("avatar_url",{avatar_url:e},t)},x.prototype.mxcUrlToHttp=function(e,t,r,n,o){return(0,v.getHttpUriForMxc)(this.baseUrl,e,t,r,n,o)},x.prototype._unstable_setStatusMessage=function(e){const t="im.vector.user_status";return Promise.all(this.getRooms().map(r=>{const n="join"===r.getMyMembership(),o=2===r.getInvitedAndJoinedMemberCount();if(!n||!o)return Promise.resolve();return r.currentState.mayClientSendStateEvent(t,this)?this.sendStateEvent(r.roomId,t,{status:e},this.getUserId()):Promise.resolve()}))},x.prototype.setPresence=function(e,t){const r=m.encodeUri("/presence/$userId/status",{$userId:this.credentials.userId});"string"==typeof e&&(e={presence:e});if(-1==["offline","online","unavailable"].indexOf(e.presence))throw new Error("Bad presence value: "+e.presence);return this._http.authedRequest(t,"PUT",r,void 0,e)},x.prototype.scrollback=function(e,t,r){m.isFunction(t)&&(r=t,t=void 0),t=t||30;let n=0,o=this._ongoingScrollbacks[e.roomId]||{};if(o.promise)return o.promise;if(o.errorTs){const e=Date.now()-o.errorTs;n=Math.max(3e3-e,0)}if(null===e.oldState.paginationToken)return Promise.resolve(e);const i=this.store.scrollback(e,t).length;if(i===t)return Promise.resolve(e);t-=i;const s=this,a=new Promise((o,i)=>{(0,m.sleep)(n).then((function(){return s._createMessagesRequest(e.roomId,e.oldState.paginationToken,t,"b")})).then((function(t){const n=m.map(t.chunk,q(s));if(t.state){const r=m.map(t.state,q(s));e.currentState.setUnknownStateEvents(r)}e.addEventsToTimeline(n,!0,e.getLiveTimeline()),e.oldState.paginationToken=t.end,0===t.chunk.length&&(e.oldState.paginationToken=null),s.store.storeEvents(e,n,t.end,!0),s._ongoingScrollbacks[e.roomId]=null,B(r,o,e)}),(function(t){s._ongoingScrollbacks[e.roomId]={errorTs:Date.now()},K(r,i,t)}))});return o={promise:a,errorTs:null},this._ongoingScrollbacks[e.roomId]=o,a},x.prototype.getEventTimeline=function(e,t){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(e.getTimelineForEvent(t))return Promise.resolve(e.getTimelineForEvent(t));const r=m.encodeUri("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t});let n=void 0;this._clientOpts.lazyLoadMembers&&(n={filter:JSON.stringify(c.Filter.LAZY_LOADING_MESSAGES_FILTER)});const o=this;return o._http.authedRequest(void 0,"GET",r,n).then((function(r){if(!r.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);r.events_after.reverse();const n=r.events_after.concat([r.event]).concat(r.events_before),i=m.map(n,o.getEventMapper());let s=e.getTimelineForEvent(i[0].getId());if(s){const e=m.map(r.state,o.getEventMapper());s.getState(d.EventTimeline.BACKWARDS).setUnknownStateEvents(e)}else s=e.addTimeline(),s.initialiseState(m.map(r.state,o.getEventMapper())),s.getState(d.EventTimeline.FORWARDS).paginationToken=r.end;e.addEventsToTimeline(i,!0,s,r.start);return e.getTimelineForEvent(t)||s}))},x.prototype._createMessagesRequest=function(e,t,r,n,o){const i=m.encodeUri("/rooms/$roomId/messages",{$roomId:e});void 0===r&&(r=30);const s={from:t,limit:r,dir:n};let a=null;return this._clientOpts.lazyLoadMembers&&(a=Object.assign({},c.Filter.LAZY_LOADING_MESSAGES_FILTER)),o&&(a=a||{},Object.assign(a,o.getRoomTimelineFilterComponent())),a&&(s.filter=JSON.stringify(a)),this._http.authedRequest(void 0,"GET",i,s)},x.prototype.paginateEventTimeline=function(e,t){const r=e.getTimelineSet()===this._notifTimelineSet,n=(t=t||{}).backwards||!1;if(r&&!n)throw new Error("paginateNotifTimeline can only paginate backwards");const o=n?d.EventTimeline.BACKWARDS:d.EventTimeline.FORWARDS,i=e.getPaginationToken(o);if(!i)return Promise.resolve(!1);const s=e._paginationRequests[o];if(s)return s;let a,c,u;const l=this;if(r)a="/notifications",c={limit:"limit"in t?t.limit:30,only:"highlight"},i&&"end"!==i&&(c.from=i),u=this._http.authedRequest(void 0,"GET","/notifications",c,void 0).then((function(t){const r=t.next_token,i=[];for(let e=0;e<t.notifications.length;e++){const r=t.notifications[e],n=l.getEventMapper()(r.event);n.setPushActions(P.PushProcessor.actionListToActionsObject(r.actions)),n.event.room_id=r.room_id,i[e]=n}return e.getTimelineSet().addEventsToTimeline(i,n,e,r),n&&!t.next_token&&e.setPaginationToken(null,o),!!t.next_token})).finally((function(){e._paginationRequests[o]=null})),e._paginationRequests[o]=u;else{if(!this.getRoom(e.getRoomId()))throw new Error("Unknown room "+e.getRoomId());u=this._createMessagesRequest(e.getRoomId(),i,t.limit,o,e.getFilter()),u.then((function(t){if(t.state){const r=e.getState(o),n=m.map(t.state,l.getEventMapper());r.setUnknownStateEvents(n)}const r=t.end,i=m.map(t.chunk,l.getEventMapper());return e.getTimelineSet().addEventsToTimeline(i,n,e,r),n&&t.end==t.start&&e.setPaginationToken(null,o),t.end!=t.start})).finally((function(){e._paginationRequests[o]=null})),e._paginationRequests[o]=u}return u},x.prototype.resetNotifTimelineSet=function(){this._notifTimelineSet&&this._notifTimelineSet.resetLiveTimeline("end",null)},x.prototype.peekInRoom=function(e){return this._peekSync&&this._peekSync.stopPeeking(),this._peekSync=new u.SyncApi(this,this._clientOpts),this._peekSync.peek(e)},x.prototype.stopPeeking=function(){this._peekSync&&(this._peekSync.stopPeeking(),this._peekSync=null)},x.prototype.setGuestAccess=function(e,t){const r=this.sendStateEvent(e,"m.room.guest_access",{guest_access:t.allowJoin?"can_join":"forbidden"});let n=Promise.resolve();return t.allowRead&&(n=this.sendStateEvent(e,"m.room.history_visibility",{history_visibility:"world_readable"})),Promise.all([n,r])},x.prototype.requestRegisterEmailToken=function(e,t,r,n){return this._requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})},x.prototype.requestRegisterMsisdnToken=function(e,t,r,n,o){return this._requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:o})},x.prototype.requestAdd3pidEmailToken=function(e,t,r,n){return this._requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})},x.prototype.requestAdd3pidMsisdnToken=function(e,t,r,n,o){return this._requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:o})},x.prototype.requestPasswordEmailToken=function(e,t,r,n){return this._requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})},x.prototype.requestPasswordMsisdnToken=function(e,t,r,n,o){return this._requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:o})},x.prototype._requestTokenFromEndpoint=async function(e,t){const r=Object.assign({},t);if(!await this.doesServerSupportSeparateAddAndBind()&&this.idBaseUrl){const e=i.default.parse(this.idBaseUrl);if(!e.host)throw new Error("Invalid ID server URL: "+this.idBaseUrl);if(r.id_server=e.host,this.identityServer&&this.identityServer.getAccessToken&&await this.doesServerAcceptIdentityAccessToken()){const e=await this.identityServer.getAccessToken();e&&(r.id_access_token=e)}}return this._http.request(void 0,"POST",e,void 0,r)},x.prototype.getRoomPushRule=function(e,t){if(!this.pushRules)throw new Error("SyncApi.sync() must be done before accessing to push rules.");for(let r=0;r<this.pushRules[e].room.length;r++){const n=this.pushRules[e].room[r];if(n.rule_id===t)return n}},x.prototype.setRoomMutePushRule=function(e,t,r){const n=this;let o,i;const s=this.getRoomPushRule(e,t);if(s&&0<=s.actions.indexOf("dont_notify")&&(i=!0),r?s?i||(o=m.defer(),this.deletePushRule(e,"room",s.rule_id).then((function(){n.addPushRule(e,"room",t,{actions:["dont_notify"]}).then((function(){o.resolve()}),(function(e){o.reject(e)}))}),(function(e){o.reject(e)})),o=o.promise):o=this.addPushRule(e,"room",t,{actions:["dont_notify"]}):i&&(o=this.deletePushRule(e,"room",s.rule_id)),o)return new Promise((e,t)=>{o.then((function(){n.getPushRules().then((function(t){n.pushRules=t,e()}),(function(e){t(e)}))}),(function(e){n.getPushRules().then((function(r){n.pushRules=r,t(e)}),(function(r){t(e)}))}))})},x.prototype.searchMessageText=function(e,t){const r={search_term:e.query};return"keys"in e&&(r.keys=e.keys),this.search({body:{search_categories:{room_events:r}}},t)},x.prototype.searchRoomEvents=function(e){const t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:"recent",event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},r={_query:t,results:[],highlights:[]};return this.search({body:t}).then(this._processRoomEventsSearch.bind(this,r))},x.prototype.backPaginateRoomEventsSearch=function(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;const t={body:e._query,next_batch:e.next_batch},r=this.search(t).then(this._processRoomEventsSearch.bind(this,e)).finally((function(){e.pendingRequest=null}));return e.pendingRequest=r,r},x.prototype._processRoomEventsSearch=function(e,t){const r=t.search_categories.room_events;e.count=r.count,e.next_batch=r.next_batch;const n={};r.highlights.forEach((function(e){n[e]=1})),e.highlights.forEach((function(e){n[e]=1})),e.highlights=Object.keys(n);for(let t=0;t<r.results.length;t++){const n=h.SearchResult.fromJson(r.results[t],this.getEventMapper());e.results.push(n)}return e},x.prototype.syncLeftRooms=function(){if(this._syncedLeftRooms)return Promise.resolve([]);if(this._syncLeftRoomsPromise)return this._syncLeftRoomsPromise;const e=this,t=new u.SyncApi(this,this._clientOpts);return this._syncLeftRoomsPromise=t.syncLeftRooms(),this._syncLeftRoomsPromise.then((function(t){S.logger.log("Marking success of sync left room request"),e._syncedLeftRooms=!0})).finally((function(){e._syncLeftRoomsPromise=null})),this._syncLeftRoomsPromise},x.prototype.createFilter=function(e){const t=this,r=m.encodeUri("/user/$userId/filter",{$userId:this.credentials.userId});return this._http.authedRequest(void 0,"POST",r,void 0,e).then((function(r){const n=c.Filter.fromJson(t.credentials.userId,r.filter_id,e);return t.store.storeFilter(n),n}))},x.prototype.getFilter=function(e,t,r){if(r){const r=this.store.getFilter(e,t);if(r)return Promise.resolve(r)}const n=this,o=m.encodeUri("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this._http.authedRequest(void 0,"GET",o,void 0,void 0).then((function(r){const o=c.Filter.fromJson(e,t,r);return n.store.storeFilter(o),o}))},x.prototype.getOrCreateFilter=async function(e,t){const r=this.store.getFilterIdByName(e);let n=void 0;if(r){try{const e=await this.getFilter(this.credentials.userId,r,!0);if(e){const o=e.getDefinition(),i=t.getDefinition();m.deepCompare(o,i)&&(n=r)}}catch(e){if("M_UNKNOWN"!==e.errcode&&"M_NOT_FOUND"!==e.errcode)throw e}n||this.store.setFilterIdByName(e,void 0)}if(n)return n;const o=await this.createFilter(t.getDefinition());return this.store.setFilterIdByName(e,o.filterId),o.filterId},x.prototype.getOpenIdToken=function(){const e=m.encodeUri("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this._http.authedRequest(void 0,"POST",e,void 0,{})},x.prototype.turnServer=function(e){return this._http.authedRequest(e,"GET","/voip/turnServer")},x.prototype.getTurnServers=function(){return this._turnServers||[]},x.prototype.setFallbackICEServerAllowed=function(e){this._fallbackICEServerAllowed=e},x.prototype.isFallbackICEServerAllowed=function(){return this._fallbackICEServerAllowed},x.prototype.isSynapseAdministrator=function(){const e=m.encodeUri("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this._http.authedRequest(void 0,"GET",e,void 0,void 0,{prefix:""}).then(e=>e.admin)},x.prototype.whoisSynapseUser=function(e){const t=m.encodeUri("/_synapse/admin/v1/whois/$userId",{$userId:e});return this._http.authedRequest(void 0,"GET",t,void 0,void 0,{prefix:""})},x.prototype.deactivateSynapseUser=function(e){const t=m.encodeUri("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this._http.authedRequest(void 0,"POST",t,void 0,void 0,{prefix:""})},x.prototype.startClient=async function(e){if(this.clientRunning)return;this.clientRunning=!0,"number"==typeof e&&(e={initialSyncLimit:e});const t=this.getUserId();t&&this.store.storeUser(new T.User(t)),this._crypto&&(this._crypto.uploadDeviceKeys(),this._crypto.start()),function e(t){if(!t._supportsVoip)return;t.turnServer().then((function(r){if(r.uris){S.logger.log("Got TURN URIs: "+r.uris+" refresh in "+r.ttl+" secs");const n={urls:r.uris,username:r.username,credential:r.password};t._turnServers=[n],t._checkTurnServersTimeoutID=setTimeout(()=>{e(t)},1e3*(r.ttl||3600)*.9)}}),(function(r){S.logger.error("Failed to get TURN URIs"),t._checkTurnServersTimeoutID=setTimeout((function(){e(t)}),6e4)}))}(this),this._syncApi&&(S.logger.error("Still have sync object whilst not running: stopping old one"),this._syncApi.stop()),(e=Object.assign({},e)).crypto=this._crypto,e.canResetEntireTimeline=e=>!!this._canResetTimelineCallback&&this._canResetTimelineCallback(e),this._clientOpts=e,this._syncApi=new u.SyncApi(this,e),this._syncApi.sync(),void 0!==e.clientWellKnownPollPeriod&&(this._clientWellKnownIntervalID=setInterval(()=>{this._fetchClientWellKnown()},1e3*e.clientWellKnownPollPeriod),this._fetchClientWellKnown())},x.prototype._fetchClientWellKnown=async function(){try{this._clientWellKnown=await O.AutoDiscovery.getRawClientConfig(this.getDomain()),this.emit("WellKnown.client",this._clientWellKnown)}catch(e){S.logger.error("Failed to get client well-known",e),this._clientWellKnown=void 0,this.emit("WellKnown.error",e)}},x.prototype.getClientWellKnown=function(){return this._clientWellKnown},x.prototype._storeClientOptions=function(){const e=["boolean","string","number"],t=Object.entries(this._clientOpts).filter(([t,r])=>e.includes(typeof r)).reduce((e,[t,r])=>(e[t]=r,e),{});return this.store.storeClientOptions(t)},x.prototype.stopClient=function(){S.logger.log("stopping MatrixClient"),this.clientRunning=!1,this._syncApi&&(this._syncApi.stop(),this._syncApi=null),this._crypto&&this._crypto.stop(),this._peekSync&&this._peekSync.stopPeeking(),e.clearTimeout(this._checkTurnServersTimeoutID),void 0!==this._clientWellKnownIntervalID&&e.clearInterval(this._clientWellKnownIntervalID)},x.prototype.getVersions=async function(){return null===this._serverVersionsCache&&(this._serverVersionsCache=await this._http.request(void 0,"GET","/_matrix/client/versions",void 0,void 0,{prefix:""})),this._serverVersionsCache},x.prototype.isVersionSupported=async function(e){const{versions:t}=await this.getVersions();return t&&t.includes(e)},x.prototype.doesServerSupportLazyLoading=async function(){const e=await this.getVersions();if(!e)return!1;const t=e.versions,r=e.unstable_features;return t&&t.includes("r0.5.0")||r&&r["m.lazy_load_members"]},x.prototype.doesServerRequireIdServerParam=async function(){const e=await this.getVersions();if(!e)return!0;const t=e.versions;if(t&&t.includes("r0.6.0"))return!1;const r=e.unstable_features;return!r||(void 0===r["m.require_identity_server"]||r["m.require_identity_server"])},x.prototype.doesServerAcceptIdentityAccessToken=async function(){const e=await this.getVersions();if(!e)return!1;const t=e.versions,r=e.unstable_features;return t&&t.includes("r0.6.0")||r&&r["m.id_access_token"]},x.prototype.doesServerSupportSeparateAddAndBind=async function(){const e=await this.getVersions();if(!e)return!1;const t=e.versions,r=e.unstable_features;return t&&t.includes("r0.6.0")||r&&r["m.separate_add_and_bind"]},x.prototype.doesServerSupportUnstableFeature=async function(e){const t=await this.getVersions();if(!t)return!1;const r=t.unstable_features;return r&&!!r[e]},x.prototype.hasLazyLoadMembersEnabled=function(){return!!this._clientOpts.lazyLoadMembers},x.prototype.setCanResetTimelineCallback=function(e){this._canResetTimelineCallback=e},x.prototype.getCanResetTimelineCallback=function(){return this._canResetTimelineCallback},x.prototype.relations=async function(e,t,r,n,o={}){const i=function(e,t,r){return"m.reaction"===r?r:e.isRoomEncrypted(t)?"m.room.encrypted":r}(this,e,n),s=await this.fetchRelations(e,t,r,i,o),a=this.getEventMapper();let c;s.original_event&&(c=a(s.original_event));let u=s.chunk.map(a);if("m.room.encrypted"===i){const e=c?u.concat(c):u;await Promise.all(e.map(e=>new Promise(t=>e.once("Event.decrypted",t)))),u=u.filter(e=>e.getType()===n)}return{originalEvent:c,events:u,nextBatch:s.next_batch}},x.prototype.getEventMapper=function(e){return q(this,e)},x.prototype.getCrossSigningCacheCallbacks=function(){return this._crypto&&this._crypto._crossSigningInfo.getCacheCallbacks()},x.prototype.generateClientSecret=function(){return(0,k.randomString)(32)}}).call(this,r(8))},function(e,t,r){(function(e,n){var o;/*! https://mths.be/punycode v1.4.1 by @mathias */!function(i){t&&t.nodeType,e&&e.nodeType;var s="object"==typeof n&&n;s.global!==s&&s.window!==s&&s.self;var a,c=2147483647,u=/^xn--/,l=/[^\x20-\x7E]/,d=/[\x2E\u3002\uFF0E\uFF61]/g,h={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},p=Math.floor,f=String.fromCharCode;function m(e){throw new RangeError(h[e])}function g(e,t){for(var r=e.length,n=[];r--;)n[r]=t(e[r]);return n}function v(e,t){var r=e.split("@"),n="";return r.length>1&&(n=r[0]+"@",e=r[1]),n+g((e=e.replace(d,".")).split("."),t).join(".")}function y(e){for(var t,r,n=[],o=0,i=e.length;o<i;)(t=e.charCodeAt(o++))>=55296&&t<=56319&&o<i?56320==(64512&(r=e.charCodeAt(o++)))?n.push(((1023&t)<<10)+(1023&r)+65536):(n.push(t),o--):n.push(t);return n}function _(e){return g(e,(function(e){var t="";return e>65535&&(t+=f((e-=65536)>>>10&1023|55296),e=56320|1023&e),t+=f(e)})).join("")}function b(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function E(e,t,r){var n=0;for(e=r?p(e/700):e>>1,e+=p(e/t);e>455;n+=36)e=p(e/35);return p(n+36*e/(e+38))}function S(e){var t,r,n,o,i,s,a,u,l,d,h,f=[],g=e.length,v=0,y=128,b=72;for((r=e.lastIndexOf("-"))<0&&(r=0),n=0;n<r;++n)e.charCodeAt(n)>=128&&m("not-basic"),f.push(e.charCodeAt(n));for(o=r>0?r+1:0;o<g;){for(i=v,s=1,a=36;o>=g&&m("invalid-input"),((u=(h=e.charCodeAt(o++))-48<10?h-22:h-65<26?h-65:h-97<26?h-97:36)>=36||u>p((c-v)/s))&&m("overflow"),v+=u*s,!(u<(l=a<=b?1:a>=b+26?26:a-b));a+=36)s>p(c/(d=36-l))&&m("overflow"),s*=d;b=E(v-i,t=f.length+1,0==i),p(v/t)>c-y&&m("overflow"),y+=p(v/t),v%=t,f.splice(v++,0,y)}return _(f)}function w(e){var t,r,n,o,i,s,a,u,l,d,h,g,v,_,S,w=[];for(g=(e=y(e)).length,t=128,r=0,i=72,s=0;s<g;++s)(h=e[s])<128&&w.push(f(h));for(n=o=w.length,o&&w.push("-");n<g;){for(a=c,s=0;s<g;++s)(h=e[s])>=t&&h<a&&(a=h);for(a-t>p((c-r)/(v=n+1))&&m("overflow"),r+=(a-t)*v,t=a,s=0;s<g;++s)if((h=e[s])<t&&++r>c&&m("overflow"),h==t){for(u=r,l=36;!(u<(d=l<=i?1:l>=i+26?26:l-i));l+=36)S=u-d,_=36-d,w.push(f(b(d+S%_,0))),u=p(S/_);w.push(f(b(u,0))),i=E(r,v,n==o),r=0,++n}++r,++t}return w.join("")}a={version:"1.4.1",ucs2:{decode:y,encode:_},decode:S,encode:w,toASCII:function(e){return v(e,(function(e){return l.test(e)?"xn--"+w(e):e}))},toUnicode:function(e){return v(e,(function(e){return u.test(e)?S(e.slice(4).toLowerCase()):e}))}},void 0===(o=function(){return a}.call(t,r,t,e))||(e.exports=o)}()}).call(this,r(54)(e),r(8))},function(e,t,r){"use strict";e.exports={isString:function(e){return"string"==typeof e},isObject:function(e){return"object"==typeof e&&null!==e},isNull:function(e){return null===e},isNullOrUndefined:function(e){return null==e}}},function(e,t,r){"use strict";t.decode=t.parse=r(98),t.encode=t.stringify=r(99)},function(e,t,r){"use strict";function n(e,t){return Object.prototype.hasOwnProperty.call(e,t)}e.exports=function(e,t,r,i){t=t||"&",r=r||"=";var s={};if("string"!=typeof e||0===e.length)return s;var a=/\+/g;e=e.split(t);var c=1e3;i&&"number"==typeof i.maxKeys&&(c=i.maxKeys);var u=e.length;c>0&&u>c&&(u=c);for(var l=0;l<u;++l){var d,h,p,f,m=e[l].replace(a,"%20"),g=m.indexOf(r);g>=0?(d=m.substr(0,g),h=m.substr(g+1)):(d=m,h=""),p=decodeURIComponent(d),f=decodeURIComponent(h),n(s,p)?o(s[p])?s[p].push(f):s[p]=[s[p],f]:s[p]=f}return s};var o=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)}},function(e,t,r){"use strict";var n=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}};e.exports=function(e,t,r,a){return t=t||"&",r=r||"=",null===e&&(e=void 0),"object"==typeof e?i(s(e),(function(s){var a=encodeURIComponent(n(s))+r;return o(e[s])?i(e[s],(function(e){return a+encodeURIComponent(n(e))})).join(t):a+encodeURIComponent(n(e[s]))})).join(t):a?encodeURIComponent(n(a))+r+encodeURIComponent(n(e)):""};var o=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};function i(e,t){if(e.map)return e.map(t);for(var r=[],n=0;n<e.length;n++)r.push(t(e[n],n));return r}var s=Object.keys||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.push(r);return t}},function(e,t,r){"use strict";(function(e){var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixBaseApis=l;var o=r(57),i=r(3),s=r(37),a=n(r(6)),c=r(29);function u(e,t){switch(e){case o.SERVICE_TYPES.IS:return t+c.PREFIX_IDENTITY_V2+"/terms";case o.SERVICE_TYPES.IM:return t+"/_matrix/integrations/v1/terms";default:throw new Error("Unsupported service type")}}function l(e){a.checkObjectHasKeys(e,["baseUrl","request"]),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer;const t={baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,request:e.request,prefix:c.PREFIX_R0,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader};this._http=new c.MatrixHttpApi(this,t),this._txnCtr=0}l.prototype.getHomeserverUrl=function(){return this.baseUrl},l.prototype.getIdentityServerUrl=function(e=!1){return e&&(this.idBaseUrl.startsWith("http://")||this.idBaseUrl.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl},l.prototype.setIdentityServerUrl=function(e){this.idBaseUrl=a.ensureNoTrailingSlash(e),this._http.setIdBaseUrl(this.idBaseUrl)},l.prototype.getAccessToken=function(){return this._http.opts.accessToken||null},l.prototype.isLoggedIn=function(){return void 0!==this._http.opts.accessToken},l.prototype.makeTxnId=function(){return"m"+(new Date).getTime()+"."+this._txnCtr++},l.prototype.isUsernameAvailable=function(e){return this._http.authedRequest(void 0,"GET","/register/available",{username:e}).then(e=>e.available)},l.prototype.register=function(e,t,r,n,o,i,s,a){!0===o?o={email:!0}:null==o&&(o={}),"function"==typeof s&&(a=s,s=void 0),r&&(n.session=r);const c={auth:n};return null!=e&&(c.username=e),null!=t&&(c.password=t),o.email&&(c.bind_email=!0),o.msisdn&&(c.bind_msisdn=!0),null!=i&&(c.guest_access_token=i),null!=s&&(c.inhibit_login=s),null!=t&&(c.x_show_msisdn=!0),this.registerRequest(c,void 0,a)},l.prototype.registerGuest=function(e,t){return(e=e||{}).body=e.body||{},this.registerRequest(e.body,"guest",t)},l.prototype.registerRequest=function(e,t,r){const n={};return t&&(n.kind=t),this._http.request(r,"POST","/register",n,e)},l.prototype.loginFlows=function(e){return this._http.request(e,"GET","/login")},l.prototype.login=function(e,t,r){const n={type:e};return a.extend(n,t),this._http.authedRequest((e,t)=>{t&&t.access_token&&t.user_id&&(this._http.opts.accessToken=t.access_token,this.credentials={userId:t.user_id}),r&&r(e,t)},"POST","/login",void 0,n)},l.prototype.loginWithPassword=function(e,t,r){return this.login("m.login.password",{user:e,password:t},r)},l.prototype.loginWithSAML2=function(e,t){return this.login("m.login.saml2",{relay_state:e},t)},l.prototype.getCasLoginUrl=function(e){return this.getSsoLoginUrl(e,"cas")},l.prototype.getSsoLoginUrl=function(e,t){return void 0===t&&(t="sso"),this._http.getUrl("/login/"+t+"/redirect",{redirectUrl:e},c.PREFIX_R0)},l.prototype.loginWithToken=function(e,t){return this.login("m.login.token",{token:e},t)},l.prototype.logout=function(e){return this._http.authedRequest(e,"POST","/logout")},l.prototype.deactivateAccount=function(e,t){if("function"==typeof t)throw new Error("deactivateAccount no longer accepts a callback parameter");const r={};return e&&(r.auth=e),void 0!==t&&(r.erase=t),this._http.authedRequest(void 0,"POST","/account/deactivate",void 0,r)},l.prototype.getFallbackAuthUrl=function(e,t){const r=a.encodeUri("/auth/$loginType/fallback/web",{$loginType:e});return this._http.getUrl(r,{session:t},c.PREFIX_R0)},l.prototype.createRoom=function(e,t){return this._http.authedRequest(t,"POST","/createRoom",void 0,e)},l.prototype.fetchRelations=async function(e,t,r,n,o){const i={};o.from&&(i.from=o.from);const s=a.encodeParams(i),u=a.encodeUri("/rooms/$roomId/relations/$eventId/$relationType/$eventType?"+s,{$roomId:e,$eventId:t,$relationType:r,$eventType:n});return await this._http.authedRequest(void 0,"GET",u,null,null,{prefix:c.PREFIX_UNSTABLE})},l.prototype.roomState=function(e,t){const r=a.encodeUri("/rooms/$roomId/state",{$roomId:e});return this._http.authedRequest(t,"GET",r)},l.prototype.fetchRoomEvent=function(e,t,r){const n=a.encodeUri("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this._http.authedRequest(r,"GET",n)},l.prototype.members=function(e,t,r,n,o){const i={};t&&(i.membership=t),r&&(i.not_membership=r),n&&(i.at=n);const s=a.encodeParams(i),c=a.encodeUri("/rooms/$roomId/members?"+s,{$roomId:e});return this._http.authedRequest(o,"GET",c)},l.prototype.upgradeRoom=function(e,t){const r=a.encodeUri("/rooms/$roomId/upgrade",{$roomId:e});return this._http.authedRequest(void 0,"POST",r,void 0,{new_version:t})},l.prototype.getGroupSummary=function(e){const t=a.encodeUri("/groups/$groupId/summary",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},l.prototype.getGroupProfile=function(e){const t=a.encodeUri("/groups/$groupId/profile",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},l.prototype.setGroupProfile=function(e,t){const r=a.encodeUri("/groups/$groupId/profile",{$groupId:e});return this._http.authedRequest(void 0,"POST",r,void 0,t)},l.prototype.setGroupJoinPolicy=function(e,t){const r=a.encodeUri("/groups/$groupId/settings/m.join_policy",{$groupId:e});return this._http.authedRequest(void 0,"PUT",r,void 0,{"m.join_policy":t})},l.prototype.getGroupUsers=function(e){const t=a.encodeUri("/groups/$groupId/users",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},l.prototype.getGroupInvitedUsers=function(e){const t=a.encodeUri("/groups/$groupId/invited_users",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},l.prototype.getGroupRooms=function(e){const t=a.encodeUri("/groups/$groupId/rooms",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},l.prototype.inviteUserToGroup=function(e,t){const r=a.encodeUri("/groups/$groupId/admin/users/invite/$userId",{$groupId:e,$userId:t});return this._http.authedRequest(void 0,"PUT",r,void 0,{})},l.prototype.removeUserFromGroup=function(e,t){const r=a.encodeUri("/groups/$groupId/admin/users/remove/$userId",{$groupId:e,$userId:t});return this._http.authedRequest(void 0,"PUT",r,void 0,{})},l.prototype.addUserToGroupSummary=function(e,t,r){const n=a.encodeUri(r?"/groups/$groupId/summary/$roleId/users/$userId":"/groups/$groupId/summary/users/$userId",{$groupId:e,$roleId:r,$userId:t});return this._http.authedRequest(void 0,"PUT",n,void 0,{})},l.prototype.removeUserFromGroupSummary=function(e,t){const r=a.encodeUri("/groups/$groupId/summary/users/$userId",{$groupId:e,$userId:t});return this._http.authedRequest(void 0,"DELETE",r,void 0,{})},l.prototype.addRoomToGroupSummary=function(e,t,r){const n=a.encodeUri(r?"/groups/$groupId/summary/$categoryId/rooms/$roomId":"/groups/$groupId/summary/rooms/$roomId",{$groupId:e,$categoryId:r,$roomId:t});return this._http.authedRequest(void 0,"PUT",n,void 0,{})},l.prototype.removeRoomFromGroupSummary=function(e,t){const r=a.encodeUri("/groups/$groupId/summary/rooms/$roomId",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"DELETE",r,void 0,{})},l.prototype.addRoomToGroup=function(e,t,r){void 0===r&&(r=!0);const n=a.encodeUri("/groups/$groupId/admin/rooms/$roomId",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"PUT",n,void 0,{"m.visibility":{type:r?"public":"private"}})},l.prototype.updateGroupRoomVisibility=function(e,t,r){const n=a.encodeUri("/groups/$groupId/admin/rooms/$roomId/config/m.visibility",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"PUT",n,void 0,{type:r?"public":"private"})},l.prototype.removeRoomFromGroup=function(e,t){const r=a.encodeUri("/groups/$groupId/admin/rooms/$roomId",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"DELETE",r,void 0,{})},l.prototype.acceptGroupInvite=function(e,t=null){const r=a.encodeUri("/groups/$groupId/self/accept_invite",{$groupId:e});return this._http.authedRequest(void 0,"PUT",r,void 0,t||{})},l.prototype.joinGroup=function(e){const t=a.encodeUri("/groups/$groupId/self/join",{$groupId:e});return this._http.authedRequest(void 0,"PUT",t,void 0,{})},l.prototype.leaveGroup=function(e){const t=a.encodeUri("/groups/$groupId/self/leave",{$groupId:e});return this._http.authedRequest(void 0,"PUT",t,void 0,{})},l.prototype.getJoinedGroups=function(){const e=a.encodeUri("/joined_groups");return this._http.authedRequest(void 0,"GET",e)},l.prototype.createGroup=function(e){const t=a.encodeUri("/create_group");return this._http.authedRequest(void 0,"POST",t,void 0,e)},l.prototype.getPublicisedGroups=function(e){const t=a.encodeUri("/publicised_groups");return this._http.authedRequest(void 0,"POST",t,void 0,{user_ids:e})},l.prototype.setGroupPublicity=function(e,t){const r=a.encodeUri("/groups/$groupId/self/update_publicity",{$groupId:e});return this._http.authedRequest(void 0,"PUT",r,void 0,{publicise:t})},l.prototype.getStateEvent=function(e,t,r,n){const o={$roomId:e,$eventType:t,$stateKey:r};let i=a.encodeUri("/rooms/$roomId/state/$eventType",o);return void 0!==r&&(i=a.encodeUri(i+"/$stateKey",o)),this._http.authedRequest(n,"GET",i)},l.prototype.sendStateEvent=function(e,t,r,n,o){const i={$roomId:e,$eventType:t,$stateKey:n};let s=a.encodeUri("/rooms/$roomId/state/$eventType",i);return void 0!==n&&(s=a.encodeUri(s+"/$stateKey",i)),this._http.authedRequest(o,"PUT",s,void 0,r)},l.prototype.roomInitialSync=function(e,t,r){a.isFunction(t)&&(r=t,t=void 0);const n=a.encodeUri("/rooms/$roomId/initialSync",{$roomId:e});return t||(t=30),this._http.authedRequest(r,"GET",n,{limit:t})},l.prototype.setRoomReadMarkersHttpRequest=function(e,t,r,n){const o=a.encodeUri("/rooms/$roomId/read_markers",{$roomId:e}),i={"m.fully_read":t,"m.read":r,"m.hidden":Boolean(!!n&&n.hidden)};return this._http.authedRequest(void 0,"POST",o,void 0,i)},l.prototype.getJoinedRooms=function(){const e=a.encodeUri("/joined_rooms");return this._http.authedRequest(void 0,"GET",e)},l.prototype.getJoinedRoomMembers=function(e){const t=a.encodeUri("/rooms/$roomId/joined_members",{$roomId:e});return this._http.authedRequest(void 0,"GET",t)},l.prototype.publicRooms=function(e,t){"function"==typeof e&&(t=e,e={}),void 0===e&&(e={});const r={};return e.server&&(r.server=e.server,delete e.server),0===Object.keys(e).length&&0===Object.keys(r).length?this._http.authedRequest(t,"GET","/publicRooms"):this._http.authedRequest(t,"POST","/publicRooms",r,e)},l.prototype.createAlias=function(e,t,r){const n=a.encodeUri("/directory/room/$alias",{$alias:e}),o={room_id:t};return this._http.authedRequest(r,"PUT",n,void 0,o)},l.prototype.deleteAlias=function(e,t){const r=a.encodeUri("/directory/room/$alias",{$alias:e});return this._http.authedRequest(t,"DELETE",r,void 0,void 0)},l.prototype.unstableGetLocalAliases=function(e,t){const r=a.encodeUri("/rooms/$roomId/aliases",{$roomId:e}),n=c.PREFIX_UNSTABLE+"/org.matrix.msc2432";return this._http.authedRequest(t,"GET",r,null,null,{prefix:n})},l.prototype.getRoomIdForAlias=function(e,t){const r=a.encodeUri("/directory/room/$alias",{$alias:e});return this._http.authedRequest(t,"GET",r)},l.prototype.resolveRoomAlias=function(e,t){const r=a.encodeUri("/directory/room/$alias",{$alias:e});return this._http.request(t,"GET",r)},l.prototype.getRoomDirectoryVisibility=function(e,t){const r=a.encodeUri("/directory/list/room/$roomId",{$roomId:e});return this._http.authedRequest(t,"GET",r)},l.prototype.setRoomDirectoryVisibility=function(e,t,r){const n=a.encodeUri("/directory/list/room/$roomId",{$roomId:e});return this._http.authedRequest(r,"PUT",n,void 0,{visibility:t})},l.prototype.setRoomDirectoryVisibilityAppService=function(e,t,r,n){const o=a.encodeUri("/directory/list/appservice/$networkId/$roomId",{$networkId:e,$roomId:t});return this._http.authedRequest(n,"PUT",o,void 0,{visibility:r})},l.prototype.searchUserDirectory=function(e){const t={search_term:e.term};return void 0!==e.limit&&(t.limit=e.limit),this._http.authedRequest(void 0,"POST","/user_directory/search",void 0,t)},l.prototype.uploadContent=function(e,t){return this._http.uploadContent(e,t)},l.prototype.cancelUpload=function(e){return this._http.cancelUpload(e)},l.prototype.getCurrentUploads=function(){return this._http.getCurrentUploads()},l.prototype.getProfileInfo=function(e,t,r){a.isFunction(t)&&(r=t,t=void 0);const n=t?a.encodeUri("/profile/$userId/$info",{$userId:e,$info:t}):a.encodeUri("/profile/$userId",{$userId:e});return this._http.authedRequest(r,"GET",n)},l.prototype.getThreePids=function(e){return this._http.authedRequest(e,"GET","/account/3pid",void 0,void 0)},l.prototype.addThreePid=function(e,t,r){const n={threePidCreds:e,bind:t};return this._http.authedRequest(r,"POST","/account/3pid",null,n)},l.prototype.addThreePidOnly=async function(e){const t=await this.isVersionSupported("r0.6.0")?c.PREFIX_R0:c.PREFIX_UNSTABLE;return this._http.authedRequest(void 0,"POST","/account/3pid/add",null,e,{prefix:t})},l.prototype.bindThreePid=async function(e){const t=await this.isVersionSupported("r0.6.0")?c.PREFIX_R0:c.PREFIX_UNSTABLE;return this._http.authedRequest(void 0,"POST","/account/3pid/bind",null,e,{prefix:t})},l.prototype.unbindThreePid=async function(e,t){const r={medium:e,address:t,id_server:this.getIdentityServerUrl(!0)},n=await this.isVersionSupported("r0.6.0")?c.PREFIX_R0:c.PREFIX_UNSTABLE;return this._http.authedRequest(void 0,"POST","/account/3pid/unbind",null,r,{prefix:n})},l.prototype.deleteThreePid=function(e,t){const r={medium:e,address:t};return this._http.authedRequest(void 0,"POST","/account/3pid/delete",null,r)},l.prototype.setPassword=function(e,t,r){const n={auth:e,new_password:t};return this._http.authedRequest(r,"POST","/account/password",null,n)},l.prototype.getDevices=function(){return this._http.authedRequest(void 0,"GET","/devices",void 0,void 0)},l.prototype.setDeviceDetails=function(e,t){const r=a.encodeUri("/devices/$device_id",{$device_id:e});return this._http.authedRequest(void 0,"PUT",r,void 0,t)},l.prototype.deleteDevice=function(e,t){const r=a.encodeUri("/devices/$device_id",{$device_id:e}),n={};return t&&(n.auth=t),this._http.authedRequest(void 0,"DELETE",r,void 0,n)},l.prototype.deleteMultipleDevices=function(e,t){const r={devices:e};t&&(r.auth=t);return this._http.authedRequest(void 0,"POST","/delete_devices",void 0,r)},l.prototype.getPushers=function(e){return this._http.authedRequest(e,"GET","/pushers",void 0,void 0)},l.prototype.setPusher=function(e,t){return this._http.authedRequest(t,"POST","/pushers/set",null,e)},l.prototype.getPushRules=function(e){return this._http.authedRequest(e,"GET","/pushrules/").then(e=>s.PushProcessor.rewriteDefaultRules(e))},l.prototype.addPushRule=function(e,t,r,n,o){const i=a.encodeUri("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this._http.authedRequest(o,"PUT",i,void 0,n)},l.prototype.deletePushRule=function(e,t,r,n){const o=a.encodeUri("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this._http.authedRequest(n,"DELETE",o)},l.prototype.setPushRuleEnabled=function(e,t,r,n,o){const i=a.encodeUri("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:r});return this._http.authedRequest(o,"PUT",i,void 0,{enabled:n})},l.prototype.setPushRuleActions=function(e,t,r,n,o){const i=a.encodeUri("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:r});return this._http.authedRequest(o,"PUT",i,void 0,{actions:n})},l.prototype.search=function(e,t){const r={};return e.next_batch&&(r.next_batch=e.next_batch),this._http.authedRequest(t,"POST","/search",r,e.body)},l.prototype.uploadKeysRequest=function(e,t,r){return this._http.authedRequest(r,"POST","/keys/upload",void 0,e)},l.prototype.uploadKeySignatures=function(e){return this._http.authedRequest(void 0,"POST","/keys/signatures/upload",void 0,e,{prefix:c.PREFIX_UNSTABLE})},l.prototype.downloadKeysForUsers=function(e,t){if(a.isFunction(t))throw new Error("downloadKeysForUsers no longer accepts a callback parameter");const r={device_keys:{}};return"token"in(t=t||{})&&(r.token=t.token),e.forEach(e=>{r.device_keys[e]=[]}),this._http.authedRequest(void 0,"POST","/keys/query",void 0,r)},l.prototype.claimOneTimeKeys=function(e,t,r){const n={};void 0===t&&(t="signed_curve25519");for(let r=0;r<e.length;++r){const o=e[r][0],i=e[r][1],s=n[o]||{};n[o]=s,s[i]=t}const o={one_time_keys:n};r&&(o.timeout=r);return this._http.authedRequest(void 0,"POST","/keys/claim",void 0,o)},l.prototype.getKeyChanges=function(e,t){const r={from:e,to:t};return this._http.authedRequest(void 0,"GET","/keys/changes",r,void 0)},l.prototype.uploadDeviceSigningKeys=function(e,t){const r=Object.assign({},t);return e&&Object.assign(r,{auth:e}),this._http.authedRequest(void 0,"POST","/keys/device_signing/upload",void 0,r,{prefix:c.PREFIX_UNSTABLE})},l.prototype.registerWithIdentityServer=function(e){if(!this.idBaseUrl)throw new Error("No Identity Server base URL set");const t=this.idBaseUrl+c.PREFIX_IDENTITY_V2+"/account/register";return this._http.requestOtherUrl(void 0,"POST",t,null,e)},l.prototype.requestEmailToken=async function(e,t,r,n,o,i){const s={client_secret:t,email:e,send_attempt:r,next_link:n};return await this._http.idServerRequest(o,"POST","/validate/email/requestToken",s,c.PREFIX_IDENTITY_V2,i)},l.prototype.requestMsisdnToken=async function(e,t,r,n,o,i,s){const a={client_secret:r,country:e,phone_number:t,send_attempt:n,next_link:o};return await this._http.idServerRequest(i,"POST","/validate/msisdn/requestToken",a,c.PREFIX_IDENTITY_V2,s)},l.prototype.submitMsisdnToken=async function(e,t,r,n){const o={sid:e,client_secret:t,token:r};return await this._http.idServerRequest(void 0,"POST","/validate/msisdn/submitToken",o,c.PREFIX_IDENTITY_V2,n)},l.prototype.submitMsisdnTokenOtherUrl=function(e,t,r,n){const o={sid:t,client_secret:r,token:n};return this._http.requestOtherUrl(void 0,"POST",e,void 0,o)},l.prototype.getIdentityHashDetails=function(e){return this._http.idServerRequest(void 0,"GET","/hash_details",null,c.PREFIX_IDENTITY_V2,e)},l.prototype.identityHashedLookup=async function(t,r){const n={},o=await this.getIdentityHashDetails(r);if(!o||!o.lookup_pepper||!o.algorithms)throw new Error("Unsupported identity server: bad response");n.pepper=o.lookup_pepper;const i={};if(o.algorithms.includes("sha256")){const r=new e.Olm.Utility;n.addresses=t.map(e=>{const t=e[0].toLowerCase(),o=e[1].toLowerCase(),s=r.sha256(`${t} ${o} ${n.pepper}`).replace(/\+/g,"-").replace(/\//g,"_");return i[s]=e[0],s}),n.algorithm="sha256"}else{if(!o.algorithms.includes("none"))throw new Error("Unsupported identity server: unknown hash algorithm");n.addresses=t.map(e=>{const t=`${e[0].toLowerCase()} ${e[1].toLowerCase()}`;return i[t]=e[0],t}),n.algorithm="none"}const s=await this._http.idServerRequest(void 0,"POST","/lookup",n,c.PREFIX_IDENTITY_V2,r);if(!s||!s.mappings)return[];const a=[];for(const e of Object.keys(s.mappings)){const t=s.mappings[e],r=i[e];if(!r)throw new Error("Identity server returned more results than expected");a.push({address:r,mxid:t})}return a},l.prototype.lookupThreePid=async function(e,t,r,n){const o=(await this.identityHashedLookup([[t,e]],n)).find(e=>e.address===t);if(!o)return r&&r(null,{}),{};const i={address:t,medium:e,mxid:o.mxid};return r&&r(null,i),i},l.prototype.bulkLookupThreePids=async function(e,t){const r=await this.identityHashedLookup(e.map(e=>[e[1],e[0]]),t),n=[];for(const t of r){const r=e.find(e=>e[1]===t.address);if(!r)throw new Error("Identity sever returned unexpected results");n.push([r[0],t.address,t.mxid])}return{threepids:n}},l.prototype.getIdentityAccount=function(e){return this._http.idServerRequest(void 0,"GET","/account",void 0,c.PREFIX_IDENTITY_V2,e)},l.prototype.sendToDevice=function(e,t,r){const n=a.encodeUri("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:r||this.makeTxnId()}),o={messages:t},s=Object.keys(t).reduce((e,r)=>(e[r]=Object.keys(t[r]),e),{});return i.logger.log("PUT "+n,s),this._http.authedRequest(void 0,"PUT",n,void 0,o)},l.prototype.getThirdpartyProtocols=function(){return this._http.authedRequest(void 0,"GET","/thirdparty/protocols",void 0,void 0).then(e=>{if(!e||"object"!=typeof e)throw new Error("/thirdparty/protocols did not return an object: "+e);return e})},l.prototype.getThirdpartyLocation=function(e,t){const r=a.encodeUri("/thirdparty/location/$protocol",{$protocol:e});return this._http.authedRequest(void 0,"GET",r,t,void 0)},l.prototype.getThirdpartyUser=function(e,t){const r=a.encodeUri("/thirdparty/user/$protocol",{$protocol:e});return this._http.authedRequest(void 0,"GET",r,t,void 0)},l.prototype.getTerms=function(e,t){const r=u(e,t);return this._http.requestOtherUrl(void 0,"GET",r)},l.prototype.agreeToTerms=function(e,t,r,n){const o=u(e,t),i={Authorization:"Bearer "+r};return this._http.requestOtherUrl(void 0,"POST",o,null,{user_accepts:n},{headers:i})},l.prototype.reportEvent=function(e,t,r,n){const o=a.encodeUri("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this._http.authedRequest(void 0,"POST",o,null,{score:r,reason:n})}}).call(this,r(8))},function(e,t,r){"use strict";
/*!
 * content-type
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */var n=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,o=/^[\u000b\u0020-\u007e\u0080-\u00ff]+$/,i=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,s=/\\([\u000b\u0020-\u00ff])/g,a=/([\\"])/g,c=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;function u(e){var t=String(e);if(i.test(t))return t;if(t.length>0&&!o.test(t))throw new TypeError("invalid parameter value");return'"'+t.replace(a,"\\$1")+'"'}function l(e){this.parameters=Object.create(null),this.type=e}t.format=function(e){if(!e||"object"!=typeof e)throw new TypeError("argument obj is required");var t=e.parameters,r=e.type;if(!r||!c.test(r))throw new TypeError("invalid type");var n=r;if(t&&"object"==typeof t)for(var o,s=Object.keys(t).sort(),a=0;a<s.length;a++){if(o=s[a],!i.test(o))throw new TypeError("invalid parameter name");n+="; "+o+"="+u(t[o])}return n},t.parse=function(e){if(!e)throw new TypeError("argument string is required");var t="object"==typeof e?function(e){var t;"function"==typeof e.getHeader?t=e.getHeader("content-type"):"object"==typeof e.headers&&(t=e.headers&&e.headers["content-type"]);if("string"!=typeof t)throw new TypeError("content-type header is missing from object");return t}(e):e;if("string"!=typeof t)throw new TypeError("argument string is required to be a string");var r=t.indexOf(";"),o=-1!==r?t.substr(0,r).trim():t.trim();if(!c.test(o))throw new TypeError("invalid media type");var i=new l(o.toLowerCase());if(-1!==r){var a,u,d;for(n.lastIndex=r;u=n.exec(t);){if(u.index!==r)throw new TypeError("invalid parameter format");r+=u[0].length,a=u[1].toLowerCase(),'"'===(d=u[2])[0]&&(d=d.substr(1,d.length-2).replace(s,"$1")),i.parameters[a]=d}if(r!==t.length)throw new TypeError("invalid parameter format")}return i}},function(e,t,r){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.setNow=function(e){a=e||Date.now},t.setTimeout=function(e,t){(t=t||0)<0&&(t=0);const r=Array.prototype.slice.call(arguments,2),n=a()+t,o=i++;const u={runAt:n,func:e,params:r,key:o},d=l(s,(function(e){return e.runAt-n}));return s.splice(d,0,u),c(),o},t.clearTimeout=function(e){if(0===s.length)return;let t;for(t=0;t<s.length;t++){if(s[t].key==e){s.splice(t,1);break}}0===t&&c()};var n=r(3);let o,i=0;const s=[];let a=Date.now;function c(){o&&e.clearTimeout(o);const t=s[0];if(!t)return;const r=a(),n=Math.min(t.runAt-r,1e3);o=e.setTimeout(u,n)}function u(){let t;const r=a(),o=[];for(;;){const e=s[0];if(!e||e.runAt>r)break;t=s.shift(),t.key,o.push(t)}c();for(let r=0;r<o.length;r++){t=o[r];try{t.func.apply(e,t.params)}catch(e){n.logger.error("Uncaught exception in callback function",e.stack||e)}}}function l(e,t){let r=0,n=e.length;for(;r<n;){const o=r+n>>1;t(e[o])>0?n=o:r=o+1}return r}}).call(this,r(8))},function(e,t,r){"use strict";function n(e){this.filter_json=e,this.types=e.types||null,this.not_types=e.not_types||[],this.rooms=e.rooms||null,this.not_rooms=e.not_rooms||[],this.senders=e.senders||null,this.not_senders=e.not_senders||[],this.contains_url=e.contains_url||null}Object.defineProperty(t,"__esModule",{value:!0}),t.FilterComponent=n,n.prototype.check=function(e){return this._checkFields(e.getRoomId(),e.getSender(),e.getType(),!!e.getContent()&&void 0!==e.getContent().url)},n.prototype._checkFields=function(e,t,r,n){const o={rooms:function(t){return e===t},senders:function(e){return t===e},types:function(e){return function(e,t){if(t.endsWith("*")){const r=t.slice(0,-1);return e.substr(0,r.length)===r}return e===t}(r,e)}},i=this;for(let e=0;e<Object.keys(o).length;e++){const t=Object.keys(o)[e],r=o[t];if(i["not_"+t].filter(r).length>0)return!1;const n=i[t];if(n&&n.length>0){if(!n.some(r))return!1}}const s=this.filter_json.contains_url;return void 0===s||s===n},n.prototype.filter=function(e){return e.filter(this.check,this)},n.prototype.limit=function(){return void 0!==this.filter_json.limit?this.filter_json.limit:10}},function(e,t,r){"use strict";(function(e){var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.SyncApi=m;var o=r(27),i=r(58),s=r(61),a=n(r(6)),c=r(38),u=r(24),l=r(37),d=r(3),h=r(31);function p(e,t){return"FILTER_SYNC_"+e+(t?"_"+t:"")}function f(...e){d.logger.log(...e)}function m(e,t){this.client=e,(t=t||{}).initialSyncLimit=void 0===t.initialSyncLimit?8:t.initialSyncLimit,t.resolveInvitesToProfiles=t.resolveInvitesToProfiles||!1,t.pollTimeout=t.pollTimeout||3e4,t.pendingEventOrdering=t.pendingEventOrdering||"chronological",t.canResetEntireTimeline||(t.canResetEntireTimeline=function(e){return!1}),this.opts=t,this._peekRoomId=null,this._currentSyncRequest=null,this._syncState=null,this._syncStateData=null,this._catchingUp=!1,this._running=!1,this._keepAliveTimer=null,this._connectionReturnedDefer=null,this._notifEvents=[],this._failedSyncCount=0,this._storeIsInvalid=!1,e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),["Room.timeline","Room.timelineReset"])}function g(e,t){const r=new o.User(t);return e.reEmitter.reEmit(r,["User.avatarUrl","User.displayName","User.presence","User.currentlyActive","User.lastPresenceTs"]),r}m.prototype.createRoom=function(e){const t=this.client,{timelineSupport:r,unstableClientRelationAggregation:n}=t,o=new i.Room(e,t,t.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:r,unstableClientRelationAggregation:n});return t.reEmitter.reEmit(o,["Room.name","Room.timeline","Room.redaction","Room.redactionCancelled","Room.receipt","Room.tags","Room.timelineReset","Room.localEchoUpdated","Room.accountData","Room.myMembership","Room.replaceEvent"]),this._registerStateListeners(o),o},m.prototype.createGroup=function(e){const t=this.client,r=new s.Group(e);return t.reEmitter.reEmit(r,["Group.profile","Group.myMembership"]),t.store.storeGroup(r),r},m.prototype._registerStateListeners=function(e){const t=this.client;t.reEmitter.reEmit(e.currentState,["RoomState.events","RoomState.members","RoomState.newMember"]),e.currentState.on("RoomState.newMember",(function(e,r,n){n.user=t.getUser(n.userId),t.reEmitter.reEmit(n,["RoomMember.name","RoomMember.typing","RoomMember.powerLevel","RoomMember.membership"])}))},m.prototype._deregisterStateListeners=function(e){e.currentState.removeAllListeners("RoomState.events"),e.currentState.removeAllListeners("RoomState.members"),e.currentState.removeAllListeners("RoomState.newMember")},m.prototype.syncLeftRooms=function(){const e=this.client,t=this,r=new c.Filter(this.client.credentials.userId);r.setTimelineLimit(1),r.setIncludeLeaveRooms(!0);const n=this.opts.pollTimeout+8e4,o={timeout:0};return e.getOrCreateFilter(p(e.credentials.userId,"LEFT_ROOMS"),r).then((function(t){return o.filter=t,e._http.authedRequest(void 0,"GET","/sync",o,void 0,n)})).then((function(r){let n=[];r.rooms&&r.rooms.leave&&(n=t._mapSyncResponseToRoomArray(r.rooms.leave));const o=[];return n.forEach((function(r){const n=r.room;if(o.push(n),!r.isBrandNewRoom)return;r.timeline=r.timeline||{};const i=t._mapSyncEventsFormat(r.timeline,n),s=t._mapSyncEventsFormat(r.state,n);n.getLiveTimeline().setPaginationToken(r.timeline.prev_batch,u.EventTimeline.BACKWARDS),t._processRoomEvents(n,s,i),n.recalculate(),e.store.storeRoom(n),e.emit("Room",n),t._processEventsForNotifs(n,i)})),o}))},m.prototype.peek=function(e){const t=this,r=this.client;return this._peekRoomId=e,this.client.roomInitialSync(e,20).then((function(n){n.messages=n.messages||{},n.messages.chunk=n.messages.chunk||[],n.state=n.state||[];const o=t.createRoom(e),i=a.map(a.deepCopy(n.state),r.getEventMapper()),s=a.map(n.state,r.getEventMapper()),c=a.map(n.messages.chunk,r.getEventMapper());return n.presence&&a.isArray(n.presence)&&n.presence.map(r.getEventMapper()).forEach((function(e){let t=r.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):(t=g(r,e.getContent().user_id),t.setPresenceEvent(e),r.store.storeUser(t)),r.emit("event",e)})),n.messages.start&&(o.oldState.paginationToken=n.messages.start),o.oldState.setStateEvents(i),o.currentState.setStateEvents(s),t._resolveInvites(o),o.recalculate(),o.addEventsToTimeline(c.reverse(),!0,o.getLiveTimeline(),n.messages.start),r.store.storeRoom(o),r.emit("Room",o),t._peekPoll(o),o}))},m.prototype.stopPeeking=function(){this._peekRoomId=null},m.prototype._peekPoll=function(e,t){if(this._peekRoomId!==e.roomId)return void f("Stopped peeking in room %s",e.roomId);const r=this;this.client._http.authedRequest(void 0,"GET","/events",{room_id:e.roomId,timeout:3e4,from:t},void 0,5e4).then((function(t){if(r._peekRoomId!==e.roomId)return void f("Stopped peeking in room %s",e.roomId);t.chunk.filter((function(e){return"m.presence"===e.type})).map(r.client.getEventMapper()).forEach((function(e){let t=r.client.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):(t=g(r.client,e.getContent().user_id),t.setPresenceEvent(e),r.client.store.storeUser(t)),r.client.emit("event",e)}));const n=t.chunk.filter((function(t){return t.room_id===e.roomId&&t.event_id})).map(r.client.getEventMapper());e.addLiveEvents(n),r._peekPoll(e,t.end)}),(function(n){d.logger.error("[%s] Peek poll failed: %s",e.roomId,n),setTimeout((function(){r._peekPoll(e,t)}),3e4)}))},m.prototype.getSyncState=function(){return this._syncState},m.prototype.getSyncStateData=function(){return this._syncStateData},m.prototype.recoverFromSyncStartupError=async function(e,t){await e;const r=this._startKeepAlives();this._updateSyncState("ERROR",{error:t}),await r},m.prototype._wasLazyLoadingToggled=async function(e){e=!!e;let t=!1;if(!await this.client.store.isNewlyCreated()){const r=await this.client.store.getClientOptions();return r&&(t=!!r.lazyLoadMembers),t!==e}return!1},m.prototype._shouldAbortSync=function(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(d.logger.warn("Token no longer valid - assuming logout"),this.stop(),!0)},m.prototype.sync=function(){const t=this.client,r=this;this._running=!0,e.document&&(this._onOnlineBound=this._onOnline.bind(this),e.document.addEventListener("online",this._onOnlineBound,!1));let n=Promise.resolve(),o=null;function i(){const e=new c.Filter(t.credentials.userId);return e.setTimelineLimit(r.opts.initialSyncLimit),e}const s=async()=>{if(f("Checking lazy load status..."),this.opts.lazyLoadMembers&&t.isGuest()&&(this.opts.lazyLoadMembers=!1),this.opts.lazyLoadMembers){f("Checking server lazy load support...");await t.doesServerSupportLazyLoading()?(f("Enabling lazy load on sync filter..."),this.opts.filter||(this.opts.filter=i()),this.opts.filter.setLazyLoadMembers(!0)):(f("LL: lazy loading requested but not supported by server, so disabling"),this.opts.lazyLoadMembers=!1)}f("Checking whether lazy loading has changed in store...");if(await this._wasLazyLoadingToggled(this.opts.lazyLoadMembers)){this._storeIsInvalid=!0;const e=h.InvalidStoreError.TOGGLED_LAZY_LOADING,t=new h.InvalidStoreError(e,!!this.opts.lazyLoadMembers);return this._updateSyncState("ERROR",{error:t}),void d.logger.warn("InvalidStoreError: store is not usable: stopping sync.")}this.opts.lazyLoadMembers&&this.opts.crypto&&this.opts.crypto.enableLazyLoading();try{f("Storing client options..."),await this.client._storeClientOptions(),f("Stored client options")}catch(e){throw d.logger.error("Storing client options failed",e),e}!async function e(){let s,a;f("Getting filter..."),s=r.opts.filter?r.opts.filter:i();try{a=await t.getOrCreateFilter(p(t.credentials.userId),s)}catch(t){if(d.logger.error("Getting filter failed",t),r._shouldAbortSync(t))return;return f("Waiting for saved sync before retrying filter..."),await r.recoverFromSyncStartupError(n,t),void e()}t.resetNotifTimelineSet(),null===r._currentSyncRequest&&(f("Sending first sync request..."),r._currentSyncRequest=r._doSyncRequest({filterId:a},o));f("Waiting for saved sync before starting sync processing..."),await n,r._sync({filterId:a})}()};t.isGuest()?r._sync({}):(f("Getting saved sync token..."),n=t.store.getSavedSyncToken().then(e=>(f("Got saved sync token"),o=e,f("Getting saved sync..."),t.store.getSavedSync())).then(e=>{if(f("Got reply from saved sync, exists? "+!!e),e)return r._syncFromCache(e)}).catch(e=>{d.logger.error("Getting saved sync failed",e)}),async function e(){try{f("Getting push rules...");const e=await t.getPushRules();f("Got push rules"),t.pushRules=e}catch(t){if(d.logger.error("Getting push rules failed",t),r._shouldAbortSync(t))return;return f("Waiting for saved sync before retrying push rules..."),await r.recoverFromSyncStartupError(n,t),void e()}s()}())},m.prototype.stop=function(){f("SyncApi.stop"),e.document&&(e.document.removeEventListener("online",this._onOnlineBound,!1),this._onOnlineBound=void 0),this._running=!1,this._currentSyncRequest&&this._currentSyncRequest.abort(),this._keepAliveTimer&&(clearTimeout(this._keepAliveTimer),this._keepAliveTimer=null)},m.prototype.retryImmediately=function(){return!!this._connectionReturnedDefer&&(this._startKeepAlives(0),!0)},m.prototype._syncFromCache=async function(e){f("sync(): not doing HTTP hit, instead returning stored /sync data");const t=e.nextBatch;this.client.store.setSyncToken(t);const r={oldSyncToken:null,nextSyncToken:t,catchingUp:!1,fromCache:!0},n={next_batch:t,rooms:e.roomsData,groups:e.groupsData,account_data:{events:e.accountData}};try{await this._processSyncResponse(r,n)}catch(e){d.logger.error("Error processing cached sync",e.stack||e)}this._storeIsInvalid||this._updateSyncState("PREPARED",r)},m.prototype._sync=async function(e){const t=this.client;if(!this._running)return f("Sync no longer running: exiting."),this._connectionReturnedDefer&&(this._connectionReturnedDefer.reject(),this._connectionReturnedDefer=null),void this._updateSyncState("STOPPED");const r=t.store.getSyncToken();let n;try{null===this._currentSyncRequest&&(this._currentSyncRequest=this._doSyncRequest(e,r)),n=await this._currentSyncRequest}catch(t){return void this._onSyncError(t,e)}finally{this._currentSyncRequest=null}t.store.setSyncToken(n.next_batch),this._failedSyncCount=0,await t.store.setSyncData(n);const o={oldSyncToken:r,nextSyncToken:n.next_batch,catchingUp:this._catchingUp};this.opts.crypto&&await this.opts.crypto.onSyncWillProcess(o);try{await this._processSyncResponse(o,n)}catch(e){d.logger.error("Caught /sync error",e.stack||e),this.client.emit("sync.unexpectedError",e)}o.catchingUp=this._catchingUp,e.hasSyncedBefore||(this._updateSyncState("PREPARED",o),e.hasSyncedBefore=!0),this.opts.crypto&&await this.opts.crypto.onSyncCompleted(o),this._updateSyncState("SYNCING",o),t.store.wantsSave()&&(this.opts.crypto&&await this.opts.crypto.saveDeviceList(0),t.store.save()),this._sync(e)},m.prototype._doSyncRequest=function(e,t){const r=this._getSyncParams(e,t);return this.client._http.authedRequest(void 0,"GET","/sync",r,void 0,r.timeout+8e4)},m.prototype._getSyncParams=function(e,t){let r=this.opts.pollTimeout;("SYNCING"!==this.getSyncState()||this._catchingUp)&&(this._catchingUp=!0,r=0);let n=e.filterId;this.client.isGuest()&&!n&&(n=this._getGuestFilter());const o={filter:n,timeout:r};return this.opts.disablePresence&&(o.set_presence="offline"),t?o.since=t:o._cacheBuster=Date.now(),"ERROR"!=this.getSyncState()&&"RECONNECTING"!=this.getSyncState()||(o.timeout=0),o},m.prototype._onSyncError=function(e,t){if(!this._running)return f("Sync no longer running: exiting"),this._connectionReturnedDefer&&(this._connectionReturnedDefer.reject(),this._connectionReturnedDefer=null),void this._updateSyncState("STOPPED");d.logger.error("/sync error %s",e),d.logger.error(e),this._shouldAbortSync(e)||(this._failedSyncCount++,d.logger.log("Number of consecutive failed sync requests:",this._failedSyncCount),f("Starting keep-alive"),this._startKeepAlives().then(e=>{e&&"ERROR"===this.getSyncState()&&this._updateSyncState("CATCHUP",{oldSyncToken:null,nextSyncToken:null,catchingUp:!0}),this._sync(t)}),this._currentSyncRequest=null,this._updateSyncState(this._failedSyncCount>=3?"ERROR":"RECONNECTING",{error:e}))},m.prototype._processSyncResponse=async function(e,t){const r=this.client,n=this;if(t.presence&&a.isArray(t.presence.events)&&t.presence.events.map(r.getEventMapper()).forEach((function(e){let t=r.store.getUser(e.getSender());t?t.setPresenceEvent(e):(t=g(r,e.getSender()),t.setPresenceEvent(e),r.store.storeUser(t)),r.emit("event",e)})),t.account_data&&a.isArray(t.account_data.events)){const e=t.account_data.events.map(r.getEventMapper()),n=e.reduce((e,t)=>(e[t.getId()]=r.store.getAccountData(t.getType()),e),{});r.store.storeAccountDataEvents(e),e.forEach((function(e){if("m.push_rules"===e.getType()){const t=e.getContent();r.pushRules=l.PushProcessor.rewriteDefaultRules(t)}const t=n[e.getId()];return r.emit("accountData",e,t),e}))}if(t.to_device&&a.isArray(t.to_device.events)&&t.to_device.events.length>0){const e=[];t.to_device.events.map(r.getEventMapper()).map(t=>{if("m.key.verification.cancel"===t.getType()){const r=t.getContent().transaction_id;r&&e.push(r)}return t}).forEach((function(t){const n=t.getContent();if("m.room.message"!=t.getType()||"m.bad.encrypted"!=n.msgtype){if("m.key.verification.start"===t.getType()||"m.key.verification.request"===t.getType()){const r=n.transaction_id;e.includes(r)&&t.flagCancelled()}r.emit("toDeviceEvent",t)}else d.logger.log("Ignoring undecryptable to-device event from "+t.getSender())}))}else this._catchingUp=!1;t.groups&&(t.groups.invite&&this._processGroupSyncEntry(t.groups.invite,"invite"),t.groups.join&&this._processGroupSyncEntry(t.groups.join,"join"),t.groups.leave&&this._processGroupSyncEntry(t.groups.leave,"leave"));let o=[],i=[],s=[];if(t.rooms&&(t.rooms.invite&&(o=this._mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(i=this._mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(s=this._mapSyncResponseToRoomArray(t.rooms.leave))),this._notifEvents=[],o.forEach((function(e){const t=e.room,o=n._mapSyncEventsFormat(e.invite_state,t);n._processRoomEvents(t,o),e.isBrandNewRoom&&(t.recalculate(),r.store.storeRoom(t),r.emit("Room",t)),o.forEach((function(e){r.emit("event",e)})),t.updateMyMembership("invite")})),await a.promiseMapSeries(i,(async function(t){const o=t.room,i=n._mapSyncEventsFormat(t.state,o),s=n._mapSyncEventsFormat(t.timeline,o),c=n._mapSyncEventsFormat(t.ephemeral),l=n._mapSyncEventsFormat(t.account_data);if(t.unread_notifications){o.setUnreadNotificationCount("total",t.unread_notifications.notification_count);const e=r.isRoomEncrypted(o.roomId);(!e||e&&o.getUnreadNotificationCount("highlight")<=0)&&o.setUnreadNotificationCount("highlight",t.unread_notifications.highlight_count)}if(t.timeline=t.timeline||{},t.isBrandNewRoom)o.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,u.EventTimeline.BACKWARDS);else if(t.timeline.limited){let i=!0;for(let e=s.length-1;e>=0;e--){const t=s[e].getId();if(o.getTimelineForEvent(t)){f("Already have event "+t+" in limited sync - not resetting"),i=!1,s.splice(0,e);break}}i&&(n._deregisterStateListeners(o),o.resetLiveTimeline(t.timeline.prev_batch,n.opts.canResetEntireTimeline(o.roomId)?null:e.oldSyncToken),r.resetNotifTimelineSet(),n._registerStateListeners(o))}async function d(e){if(r.emit("event",e),e.isState()&&"m.room.encryption"==e.getType()&&n.opts.crypto&&await n.opts.crypto.onCryptoEvent(e),e.isState()&&"im.vector.user_status"===e.getType()){let t=r.store.getUser(e.getStateKey());t?t._unstable_updateStatusMessage(e):(t=g(r,e.getStateKey()),t._unstable_updateStatusMessage(e),r.store.storeUser(t))}}n._processRoomEvents(o,i,s,e.fromCache),t.summary&&o.setSummary(t.summary),o.addEphemeralEvents(c),o.addAccountData(l),o.recalculate(),t.isBrandNewRoom&&(r.store.storeRoom(o),r.emit("Room",o)),n._processEventsForNotifs(o,s),await a.promiseMapSeries(i,d),await a.promiseMapSeries(s,d),c.forEach((function(e){r.emit("event",e)})),l.forEach((function(e){r.emit("event",e)})),o.updateMyMembership("join")})),s.forEach((function(e){const t=e.room,o=n._mapSyncEventsFormat(e.state,t),i=n._mapSyncEventsFormat(e.timeline,t),s=n._mapSyncEventsFormat(e.account_data);n._processRoomEvents(t,o,i),t.addAccountData(s),t.recalculate(),e.isBrandNewRoom&&(r.store.storeRoom(t),r.emit("Room",t)),n._processEventsForNotifs(t,i),o.forEach((function(e){r.emit("event",e)})),i.forEach((function(e){r.emit("event",e)})),s.forEach((function(e){r.emit("event",e)})),t.updateMyMembership("leave")})),e.oldSyncToken&&this._notifEvents.length&&(this._notifEvents.sort((function(e,t){return e.getTs()-t.getTs()})),this._notifEvents.forEach((function(e){r.getNotifTimelineSet().addLiveEvent(e)}))),t.device_lists&&this.opts.crypto&&await this.opts.crypto.handleDeviceListChanges(e,t.device_lists),this.opts.crypto&&t.device_one_time_keys_count){const e=t.device_one_time_keys_count.signed_curve25519||0;this.opts.crypto.updateOneTimeKeyCount(e)}},m.prototype._startKeepAlives=function(e){void 0===e&&(e=2e3+Math.floor(5e3*Math.random())),null!==this._keepAliveTimer&&clearTimeout(this._keepAliveTimer);const t=this;return e>0?t._keepAliveTimer=setTimeout(t._pokeKeepAlive.bind(t),e):t._pokeKeepAlive(),this._connectionReturnedDefer||(this._connectionReturnedDefer=a.defer()),this._connectionReturnedDefer.promise},m.prototype._pokeKeepAlive=function(e){void 0===e&&(e=!1);const t=this;function r(){clearTimeout(t._keepAliveTimer),t._connectionReturnedDefer&&(t._connectionReturnedDefer.resolve(e),t._connectionReturnedDefer=null)}this.client._http.request(void 0,"GET","/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15e3}).then((function(){r()}),(function(n){400==n.httpStatus||404==n.httpStatus?t._keepAliveTimer=setTimeout(r,2e3):(e=!0,t._keepAliveTimer=setTimeout(t._pokeKeepAlive.bind(t,e),5e3+Math.floor(5e3*Math.random())),t._updateSyncState("ERROR",{error:n}))}))},m.prototype._processGroupSyncEntry=function(e,t){for(const r of Object.keys(e)){const n=e[r];let o=this.client.store.getGroup(r);const i=null===o;null===o&&(o=this.createGroup(r)),n.profile&&o.setProfile(n.profile.name,n.profile.avatar_url),n.inviter&&o.setInviter({userId:n.inviter}),o.setMyMembership(t),i&&this.client.emit("Group",o)}},m.prototype._mapSyncResponseToRoomArray=function(e){const t=this.client,r=this;return a.keys(e).map((function(n){const o=e[n];let i=t.store.getRoom(n),s=!1;return i||(i=r.createRoom(n),s=!0),o.room=i,o.isBrandNewRoom=s,o}))},m.prototype._mapSyncEventsFormat=function(e,t){if(!e||!a.isArray(e.events))return[];const r=this.client.getEventMapper();return e.events.map((function(e){return t&&(e.room_id=t.roomId),r(e)}))},m.prototype._resolveInvites=function(e){if(!e||!this.opts.resolveInvitesToProfiles)return;const t=this.client;e.getMembersWithMembership("invite").forEach((function(r){if(r._requestedProfileInfo)return;r._requestedProfileInfo=!0;const n=t.getUser(r.userId);let o;o=n?Promise.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):t.getProfileInfo(r.userId),o.then((function(t){const n=r.events.member;"invite"===n.getContent().membership&&(n.getContent().avatar_url=t.avatar_url,n.getContent().displayname=t.displayname,r.setMembershipEvent(n,e.currentState))}),(function(e){}))}))},m.prototype._processRoomEvents=function(e,t,r,n){const o=e.getLiveTimeline(),i=0==o.getEvents().length;if(i){for(const e of t)this.client.getPushActionsForEvent(e);o.initialiseState(t)}this._resolveInvites(e),e.recalculate(),i||(e.oldState.setStateEvents(t||[]),e.currentState.setStateEvents(t||[])),e.addLiveEvents(r||[],null,n)},m.prototype._processEventsForNotifs=function(e,t){if(this.client.getNotifTimelineSet())for(let e=0;e<t.length;e++){const r=this.client.getPushActionsForEvent(t[e]);r&&r.notify&&r.tweaks&&r.tweaks.highlight&&this._notifEvents.push(t[e])}},m.prototype._getGuestFilter=function(){return this.client._guestRooms?JSON.stringify({room:{timeline:{limit:20}}}):"{}"},m.prototype._updateSyncState=function(e,t){const r=this._syncState;this._syncState=e,this._syncStateData=t,this.client.emit("sync",this._syncState,r,t)},m.prototype._onOnline=function(){f("Browser thinks we are back online"),this._startKeepAlives(0)}}).call(this,r(8))},function(e,t,r){"use strict";var n=r(14);Object.defineProperty(t,"__esModule",{value:!0}),t.Relations=void 0;var o=n(r(2)),i=r(10),s=r(18);class a extends i.EventEmitter{constructor(e,t,r){super(),(0,o.default)(this,"_onEventStatus",(e,t)=>{e.isSending()?t===s.EventStatus.CANCELLED&&(e.removeListener("Event.status",this._onEventStatus),this._removeEvent(e)):e.removeListener("Event.status",this._onEventStatus)}),(0,o.default)(this,"_onBeforeRedaction",e=>{this._relations.has(e)&&(this._relations.delete(e),"m.annotation"===this.relationType?this._removeAnnotationFromAggregation(e):"m.replace"===this.relationType&&this._targetEvent&&this._targetEvent.makeReplaced(this.getLastReplacement()),e.removeListener("Event.beforeRedaction",this._onBeforeRedaction),this.emit("Relations.redaction",e))}),this.relationType=e,this.eventType=t,this._relations=new Set,this._annotationsByKey={},this._annotationsBySender={},this._sortedAnnotationsByKey=[],this._targetEvent=null}addEvent(e){if(this._relations.has(e))return;const t=e.getRelation();if(!t)return void console.error("Event must have relation info");const r=t.rel_type,n=e.getType();this.relationType===r&&this.eventType===n?(e.isSending()&&e.on("Event.status",this._onEventStatus),this._relations.add(e),"m.annotation"===this.relationType?this._addAnnotationToAggregation(e):"m.replace"===this.relationType&&this._targetEvent&&this._targetEvent.makeReplaced(this.getLastReplacement()),e.on("Event.beforeRedaction",this._onBeforeRedaction),this.emit("Relations.add",e)):console.error("Event relation info doesn't match this container")}_removeEvent(e){if(!this._relations.has(e))return;const t=e.getRelation();if(!t)return void console.error("Event must have relation info");const r=t.rel_type,n=e.getType();this.relationType===r&&this.eventType===n?(this._relations.delete(e),"m.annotation"===this.relationType?this._removeAnnotationFromAggregation(e):"m.replace"===this.relationType&&this._targetEvent&&this._targetEvent.makeReplaced(this.getLastReplacement()),this.emit("Relations.remove",e)):console.error("Event relation info doesn't match this container")}getRelations(){return[...this._relations]}_addAnnotationToAggregation(e){const{key:t}=e.getRelation();if(!t)return;let r=this._annotationsByKey[t];r||(r=this._annotationsByKey[t]=new Set,this._sortedAnnotationsByKey.push([t,r])),r.add(e),this._sortedAnnotationsByKey.sort((e,t)=>{const r=e[1];return t[1].size-r.size});const n=e.getSender();let o=this._annotationsBySender[n];o||(o=this._annotationsBySender[n]=new Set),o.add(e)}_removeAnnotationFromAggregation(e){const{key:t}=e.getRelation();if(!t)return;const r=this._annotationsByKey[t];r&&(r.delete(e),this._sortedAnnotationsByKey.sort((e,t)=>{const r=e[1];return t[1].size-r.size}));const n=e.getSender(),o=this._annotationsBySender[n];o&&o.delete(e)}getSortedAnnotationsByKey(){return"m.annotation"!==this.relationType?null:this._sortedAnnotationsByKey}getAnnotationsBySender(){return"m.annotation"!==this.relationType?null:this._annotationsBySender}getLastReplacement(){if("m.replace"!==this.relationType)return null;if(!this._targetEvent)return null;const e=this._targetEvent.getServerAggregatedRelation("m.replace"),t=e&&e.origin_server_ts;return this.getRelations().reduce((e,r)=>r.getSender()!==this._targetEvent.getSender()||t&&t>r.getTs()||e&&e.getTs()>r.getTs()?e:r,null)}setTargetEvent(e){if(!this._targetEvent&&(this._targetEvent=e,"m.replace"===this.relationType)){const e=this.getLastReplacement();e&&this._targetEvent.makeReplaced(e)}}}t.Relations=a},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RoomSummary=function(e,t){this.roomId=e,this.info=t}},function(e,t,r){"use strict";var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.SearchResult=s;var o=n(r(6)),i=r(108);function s(e,t){this.rank=e,this.context=t}s.fromJson=function(e,t){const r=e.context||{},n=r.events_before||[],a=r.events_after||[],c=new i.EventContext(t(e.result));return c.setPaginateToken(r.start,!0),c.addEvents(o.map(n,t),!0),c.addEvents(o.map(a,t),!1),c.setPaginateToken(r.end,!1),new s(e.rank,c)}},function(e,t,r){"use strict";function n(e){this._timeline=[e],this._ourEventIndex=0,this._paginateTokens={b:null,f:null},this._paginateRequests={b:null,f:null}}Object.defineProperty(t,"__esModule",{value:!0}),t.EventContext=n,n.prototype.getEvent=function(){return this._timeline[this._ourEventIndex]},n.prototype.getTimeline=function(){return this._timeline},n.prototype.getOurEventIndex=function(){return this._ourEventIndex},n.prototype.getPaginateToken=function(e){return this._paginateTokens[e?"b":"f"]},n.prototype.setPaginateToken=function(e,t){this._paginateTokens[t?"b":"f"]=e},n.prototype.addEvents=function(e,t){t?(this._timeline=e.concat(this._timeline),this._ourEventIndex+=e.length):this._timeline=this._timeline.concat(e)}},function(e,t,r){"use strict";function n(){this.fromToken=null}Object.defineProperty(t,"__esModule",{value:!0}),t.StubStore=n,n.prototype={isNewlyCreated:function(){return Promise.resolve(!0)},getSyncToken:function(){return this.fromToken},setSyncToken:function(e){this.fromToken=e},storeGroup:function(e){},getGroup:function(e){return null},getGroups:function(){return[]},storeRoom:function(e){},getRoom:function(e){return null},getRooms:function(){return[]},removeRoom:function(e){},getRoomSummaries:function(){return[]},storeUser:function(e){},getUser:function(e){return null},getUsers:function(){return[]},scrollback:function(e,t){return[]},storeEvents:function(e,t,r,n){},storeFilter:function(e){},getFilter:function(e,t){return null},getFilterIdByName:function(e){return null},setFilterIdByName:function(e,t){},storeAccountDataEvents:function(e){},getAccountData:function(e){},setSyncData:function(e){return Promise.resolve()},wantsSave:function(){return!1},save:function(){},startup:function(){return Promise.resolve()},getSavedSync:function(){return Promise.resolve(null)},getSavedSyncToken:function(){return Promise.resolve(null)},deleteAllData:function(){return Promise.resolve()},getOutOfBandMembers:function(){return Promise.resolve(null)},setOutOfBandMembers:function(){return Promise.resolve()},clearOutOfBandMembers:function(){return Promise.resolve()},getClientOptions:function(){return Promise.resolve()},storeClientOptions:function(){return Promise.resolve()}}},function(e,t,r){"use strict";t.byteLength=function(e){var t=u(e),r=t[0],n=t[1];return 3*(r+n)/4-n},t.toByteArray=function(e){var t,r,n=u(e),s=n[0],a=n[1],c=new i(function(e,t,r){return 3*(t+r)/4-r}(0,s,a)),l=0,d=a>0?s-4:s;for(r=0;r<d;r+=4)t=o[e.charCodeAt(r)]<<18|o[e.charCodeAt(r+1)]<<12|o[e.charCodeAt(r+2)]<<6|o[e.charCodeAt(r+3)],c[l++]=t>>16&255,c[l++]=t>>8&255,c[l++]=255&t;2===a&&(t=o[e.charCodeAt(r)]<<2|o[e.charCodeAt(r+1)]>>4,c[l++]=255&t);1===a&&(t=o[e.charCodeAt(r)]<<10|o[e.charCodeAt(r+1)]<<4|o[e.charCodeAt(r+2)]>>2,c[l++]=t>>8&255,c[l++]=255&t);return c},t.fromByteArray=function(e){for(var t,r=e.length,o=r%3,i=[],s=0,a=r-o;s<a;s+=16383)i.push(l(e,s,s+16383>a?a:s+16383));1===o?(t=e[r-1],i.push(n[t>>2]+n[t<<4&63]+"==")):2===o&&(t=(e[r-2]<<8)+e[r-1],i.push(n[t>>10]+n[t>>4&63]+n[t<<2&63]+"="));return i.join("")};for(var n=[],o=[],i="undefined"!=typeof Uint8Array?Uint8Array:Array,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0,c=s.length;a<c;++a)n[a]=s[a],o[s.charCodeAt(a)]=a;function u(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");return-1===r&&(r=t),[r,r===t?0:4-r%4]}function l(e,t,r){for(var o,i,s=[],a=t;a<r;a+=3)o=(e[a]<<16&16711680)+(e[a+1]<<8&65280)+(255&e[a+2]),s.push(n[(i=o)>>18&63]+n[i>>12&63]+n[i>>6&63]+n[63&i]);return s.join("")}o["-".charCodeAt(0)]=62,o["_".charCodeAt(0)]=63},function(e,t){t.read=function(e,t,r,n,o){var i,s,a=8*o-n-1,c=(1<<a)-1,u=c>>1,l=-7,d=r?o-1:0,h=r?-1:1,p=e[t+d];for(d+=h,i=p&(1<<-l)-1,p>>=-l,l+=a;l>0;i=256*i+e[t+d],d+=h,l-=8);for(s=i&(1<<-l)-1,i>>=-l,l+=n;l>0;s=256*s+e[t+d],d+=h,l-=8);if(0===i)i=1-u;else{if(i===c)return s?NaN:1/0*(p?-1:1);s+=Math.pow(2,n),i-=u}return(p?-1:1)*s*Math.pow(2,i-n)},t.write=function(e,t,r,n,o,i){var s,a,c,u=8*i-o-1,l=(1<<u)-1,d=l>>1,h=23===o?Math.pow(2,-24)-Math.pow(2,-77):0,p=n?0:i-1,f=n?1:-1,m=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=l):(s=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-s))<1&&(s--,c*=2),(t+=s+d>=1?h/c:h*Math.pow(2,1-d))*c>=2&&(s++,c/=2),s+d>=l?(a=0,s=l):s+d>=1?(a=(t*c-1)*Math.pow(2,o),s+=d):(a=t*Math.pow(2,d-1)*Math.pow(2,o),s=0));o>=8;e[r+p]=255&a,p+=f,a/=256,o-=8);for(s=s<<o|a,u+=o;u>0;e[r+p]=255&s,p+=f,s/=256,u-=8);e[r+p-f]|=128*m}},function(e,t){var r={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==r.call(e)}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RoomList=void 0;var n=r(23);t.RoomList=class{constructor(e){this._cryptoStore=e,this._roomEncryption={}}async init(){await this._cryptoStore.doTxn("readwrite",[n.IndexedDBCryptoStore.STORE_ROOMS],e=>{this._cryptoStore.getEndToEndRooms(e,e=>{this._roomEncryption=e})})}getRoomEncryption(e){return this._roomEncryption[e]||null}isRoomEncrypted(e){return Boolean(this.getRoomEncryption(e))}async setRoomEncryption(e,t){this._roomEncryption[e]=t,await this._cryptoStore.doTxn("readwrite",[n.IndexedDBCryptoStore.STORE_ROOMS],r=>{this._cryptoStore.storeEndToEndRoom(e,t,r)})}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LocalStorageCryptoStore=void 0;var n=r(3),o=r(35);function i(e){return"crypto.sessions/"+e}function s(e){return"crypto.session.problems/"+e}function a(e,t){return"crypto.inboundgroupsessions/"+e+"/"+t}function c(e,t){return"crypto.inboundgroupsessions.withheld/"+e+"/"+t}function u(e){return"crypto.rooms/"+e}class l extends o.MemoryCryptoStore{constructor(e){super(),this.store=e}static exists(e){const t=e.length;for(let r=0;r<t;r++)if(e.key(r).startsWith("crypto."))return!0;return!1}countEndToEndSessions(e,t){let r=0;for(let e=0;e<this.store.length;++e)this.store.key(e).startsWith(i(""))&&++r;t(r)}_getEndToEndSessions(e,t,r){const n=d(this.store,i(e)),o={};for(const[e,t]of Object.entries(n||{}))o[e]="string"==typeof t?{session:t}:t;return o}getEndToEndSession(e,t,r,n){n(this._getEndToEndSessions(e)[t]||{})}getEndToEndSessions(e,t,r){r(this._getEndToEndSessions(e)||{})}getAllEndToEndSessions(e,t){for(let e=0;e<this.store.length;++e)if(this.store.key(e).startsWith(i(""))){const r=this.store.key(e).split("/")[1];for(const e of Object.values(this._getEndToEndSessions(r)))t(e)}}storeEndToEndSession(e,t,r,n){const o=this._getEndToEndSessions(e)||{};o[t]=r,h(this.store,i(e),o)}async storeEndToEndSessionProblem(e,t,r){const n=s(e),o=d(this.store,n)||[];o.push({type:t,fixed:r,time:Date.now()}),o.sort((e,t)=>e.time-t.time),h(this.store,n,o)}async getEndToEndSessionProblem(e,t){const r=s(e),n=d(this.store,r)||[];if(!n.length)return null;const o=n[n.length-1];for(const e of n)if(e.time>t)return Object.assign({},e,{fixed:o.fixed});return o.fixed?null:o}async filterOutNotifiedErrorDevices(e){const t=d(this.store,"crypto.notified_error_devices")||{},r=[];for(const n of e){const{userId:e,deviceInfo:o}=n;e in t?o.deviceId in t[e]||(r.push(n),t[e][o.deviceId]=!0):(r.push(n),t[e]={[o.deviceId]:!0})}return h(this.store,"crypto.notified_error_devices",t),r}getEndToEndInboundGroupSession(e,t,r,n){n(d(this.store,a(e,t)),d(this.store,c(e,t)))}getAllEndToEndInboundGroupSessions(e,t){for(let e=0;e<this.store.length;++e){const r=this.store.key(e);r.startsWith("crypto.inboundgroupsessions/")&&t({senderKey:r.substr("crypto.inboundgroupsessions/".length,43),sessionId:r.substr("crypto.inboundgroupsessions/".length+44),sessionData:d(this.store,r)})}t(null)}addEndToEndInboundGroupSession(e,t,r,n){d(this.store,a(e,t))||this.storeEndToEndInboundGroupSession(e,t,r,n)}storeEndToEndInboundGroupSession(e,t,r,n){h(this.store,a(e,t),r)}storeEndToEndInboundGroupSessionWithheld(e,t,r,n){h(this.store,c(e,t),r)}getEndToEndDeviceData(e,t){t(d(this.store,"crypto.device_data"))}storeEndToEndDeviceData(e,t){h(this.store,"crypto.device_data",e)}storeEndToEndRoom(e,t,r){h(this.store,u(e),t)}getEndToEndRooms(e,t){const r={},n=u("");for(let e=0;e<this.store.length;++e){const t=this.store.key(e);if(t.startsWith(n)){r[t.substr(n.length)]=d(this.store,t)}}t(r)}getSessionsNeedingBackup(e){const t=d(this.store,"crypto.sessionsneedingbackup")||{},r=[];for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)){const t=n.substr(0,43),o=n.substr(44);if(this.getEndToEndInboundGroupSession(t,o,null,e=>{r.push({senderKey:t,sessionId:o,sessionData:e})}),e&&n.length>=e)break}return Promise.resolve(r)}countSessionsNeedingBackup(){const e=d(this.store,"crypto.sessionsneedingbackup")||{};return Promise.resolve(Object.keys(e).length)}unmarkSessionsNeedingBackup(e){const t=d(this.store,"crypto.sessionsneedingbackup")||{};for(const r of e)delete t[r.senderKey+"/"+r.sessionId];return h(this.store,"crypto.sessionsneedingbackup",t),Promise.resolve()}markSessionsNeedingBackup(e){const t=d(this.store,"crypto.sessionsneedingbackup")||{};for(const r of e)t[r.senderKey+"/"+r.sessionId]=!0;return h(this.store,"crypto.sessionsneedingbackup",t),Promise.resolve()}deleteAllData(){return this.store.removeItem("crypto.account"),Promise.resolve()}getAccount(e,t){t(d(this.store,"crypto.account"))}storeAccount(e,t){h(this.store,"crypto.account",t)}getCrossSigningKeys(e,t){t(d(this.store,"crypto.cross_signing_keys"))}getSecretStorePrivateKey(e,t,r){t(d(this.store,"crypto.ssss_cache."+r))}storeCrossSigningKeys(e,t){h(this.store,"crypto.cross_signing_keys",t)}storeSecretStorePrivateKey(e,t,r){h(this.store,"crypto.ssss_cache."+t,r)}doTxn(e,t,r){return Promise.resolve(r(null))}}function d(e,t){try{return JSON.parse(e.getItem(t))}catch(e){n.logger.log("Error: Failed to get key %s: %s",t,e.stack||e),n.logger.log(e.stack)}return null}function h(e,t,r){e.setItem(t,JSON.stringify(r))}t.LocalStorageCryptoStore=l},function(e,t,r){"use strict";var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.upgradeDatabase=function(e,t){o.logger.log("Upgrading IndexedDBCryptoStore from version "+t+" to 9"),t<1&&function(e){const t=e.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});t.createIndex("session",["requestBody.room_id","requestBody.session_id"]),t.createIndex("state","state")}(e);t<2&&e.createObjectStore("account");if(t<3){e.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]}).createIndex("deviceKey","deviceKey")}t<4&&e.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]});t<5&&e.createObjectStore("device_data");t<6&&e.createObjectStore("rooms");t<7&&e.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]});t<8&&e.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]});if(t<9){e.createObjectStore("session_problems",{keyPath:["deviceKey","time"]}).createIndex("deviceKey","deviceKey"),e.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})}},t.Backend=t.VERSION=void 0;var o=r(3),i=n(r(6));t.VERSION=9;function s(e,t){e._mx_abortexception=t;try{e.abort()}catch(t){}}function a(e){return new Promise((t,r)=>{e.oncomplete=()=>{void 0!==e._mx_abortexception&&r(e._mx_abortexception),t()},e.onerror=t=>{void 0!==e._mx_abortexception?r(e._mx_abortexception):(o.logger.log("Error performing indexeddb txn",t),r(t.target.error))},e.onabort=t=>{void 0!==e._mx_abortexception?r(e._mx_abortexception):(o.logger.log("Error performing indexeddb txn",t),r(t.target.error))}})}t.Backend=class{constructor(e){this._db=e,e.onversionchange=t=>{o.logger.log(`versionchange for indexeddb ${this._dbName}: closing`),e.close()}}getOrAddOutgoingRoomKeyRequest(e){const t=e.requestBody;return new Promise((r,n)=>{const i=this._db.transaction("outgoingRoomKeyRequests","readwrite");i.onerror=n,this._getOutgoingRoomKeyRequest(i,t,n=>{if(n)return o.logger.log(`already have key request outstanding for ${t.room_id} / ${t.session_id}: not sending another`),void r(n);o.logger.log(`enqueueing key request for ${t.room_id} / `+t.session_id),i.oncomplete=()=>{r(e)};i.objectStore("outgoingRoomKeyRequests").add(e)})})}getOutgoingRoomKeyRequest(e){return new Promise((t,r)=>{const n=this._db.transaction("outgoingRoomKeyRequests","readonly");n.onerror=r,this._getOutgoingRoomKeyRequest(n,e,e=>{t(e)})})}_getOutgoingRoomKeyRequest(e,t,r){e.objectStore("outgoingRoomKeyRequests").index("session").openCursor([t.room_id,t.session_id]).onsuccess=e=>{const n=e.target.result;if(!n)return void r(null);const o=n.value;i.deepCompare(o.requestBody,t)?r(o):n.continue()}}getOutgoingRoomKeyRequestByState(e){if(0===e.length)return Promise.resolve(null);let t,r=0;const n=this._db.transaction("outgoingRoomKeyRequests","readonly"),o=n.objectStore("outgoingRoomKeyRequests"),i=e[r];return o.index("state").openCursor(i).onsuccess=function n(o){const i=o.target.result;if(i)return void(t=i.value);if(r++,r>=e.length)return;const s=e[r];o.target.source.openCursor(s).onsuccess=n},a(n).then(()=>t)}getAllOutgoingRoomKeyRequestsByState(e){return new Promise((t,r)=>{const n=this._db.transaction("outgoingRoomKeyRequests","readonly").objectStore("outgoingRoomKeyRequests").index("state").getAll(e);n.onsuccess=e=>t(e.target.result),n.onerror=e=>r(e.target.error)})}getOutgoingRoomKeyRequestsByTarget(e,t,r){let n=0;const o=[];const i=this._db.transaction("outgoingRoomKeyRequests","readonly"),s=i.objectStore("outgoingRoomKeyRequests"),c=r[n];return s.index("state").openCursor(c).onsuccess=function i(s){const a=s.target.result;if(a){const r=a.value;r.recipients.includes({userId:e,deviceId:t})&&o.push(r),a.continue()}else{if(n++,n>=r.length)return;const e=r[n];s.target.source.openCursor(e).onsuccess=i}},a(i).then(()=>o)}updateOutgoingRoomKeyRequest(e,t,r){let n=null;const i=this._db.transaction("outgoingRoomKeyRequests","readwrite");return i.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=function(e){const i=e.target.result;if(!i)return;const s=i.value;s.state==t?(Object.assign(s,r),i.update(s),n=s):o.logger.warn(`Cannot update room key request from ${t} as it was already updated to `+s.state)},a(i).then(()=>n)}deleteOutgoingRoomKeyRequest(e,t){const r=this._db.transaction("outgoingRoomKeyRequests","readwrite");return r.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=e=>{const r=e.target.result;if(!r)return;const n=r.value;n.state==t?r.delete():o.logger.warn(`Cannot delete room key request in state ${n.state} (expected ${t})`)},a(r)}getAccount(e,t){const r=e.objectStore("account").get("-");r.onsuccess=function(){try{t(r.result||null)}catch(t){s(e,t)}}}storeAccount(e,t){e.objectStore("account").put(t,"-")}getCrossSigningKeys(e,t){const r=e.objectStore("account").get("crossSigningKeys");r.onsuccess=function(){try{t(r.result||null)}catch(t){s(e,t)}}}getSecretStorePrivateKey(e,t,r){const n=e.objectStore("account").get("ssss_cache:"+r);n.onsuccess=function(){try{t(n.result||null)}catch(t){s(e,t)}}}storeCrossSigningKeys(e,t){e.objectStore("account").put(t,"crossSigningKeys")}storeSecretStorePrivateKey(e,t,r){e.objectStore("account").put(r,"ssss_cache:"+t)}countEndToEndSessions(e,t){const r=e.objectStore("sessions").count();r.onsuccess=function(){try{t(r.result)}catch(t){s(e,t)}}}getEndToEndSessions(e,t,r){const n=t.objectStore("sessions").index("deviceKey").openCursor(e),o={};n.onsuccess=function(){const e=n.result;if(e)o[e.value.sessionId]={session:e.value.session,lastReceivedMessageTs:e.value.lastReceivedMessageTs},e.continue();else try{r(o)}catch(e){s(t,e)}}}getEndToEndSession(e,t,r,n){const o=r.objectStore("sessions").get([e,t]);o.onsuccess=function(){try{o.result?n({session:o.result.session,lastReceivedMessageTs:o.result.lastReceivedMessageTs}):n(null)}catch(e){s(r,e)}}}getAllEndToEndSessions(e,t){const r=e.objectStore("sessions").openCursor();r.onsuccess=function(){try{const e=r.result;e?(t(e.value),e.continue()):t(null)}catch(t){s(e,t)}}}storeEndToEndSession(e,t,r,n){n.objectStore("sessions").put({deviceKey:e,sessionId:t,session:r.session,lastReceivedMessageTs:r.lastReceivedMessageTs})}async storeEndToEndSessionProblem(e,t,r){const n=this._db.transaction("session_problems","readwrite");return n.objectStore("session_problems").put({deviceKey:e,type:t,fixed:r,time:Date.now()}),a(n)}async getEndToEndSessionProblem(e,t){let r;const n=this._db.transaction("session_problems","readwrite"),o=n.objectStore("session_problems").index("deviceKey").getAll(e);return o.onsuccess=e=>{const n=o.result;if(!n.length)return void(r=null);n.sort((e,t)=>e.time-t.time);const i=n[n.length-1];for(const e of n)if(e.time>t)return void(r=Object.assign({},e,{fixed:i.fixed}));r=i.fixed?null:i},await a(n),r}async filterOutNotifiedErrorDevices(e){const t=this._db.transaction("notified_error_devices","readwrite").objectStore("notified_error_devices"),r=[];return await Promise.all(e.map(e=>new Promise(n=>{const{userId:o,deviceInfo:i}=e,s=t.get([o,i.deviceId]);s.onsuccess=function(){s.result||(t.put({userId:o,deviceId:i.deviceId}),r.push(e)),n()}}))),r}getEndToEndInboundGroupSession(e,t,r,n){let o=!1,i=!1;const a=r.objectStore("inbound_group_sessions").get([e,t]);a.onsuccess=function(){try{o=a.result?a.result.session:null,!1!==i&&n(o,i)}catch(e){s(r,e)}};const c=r.objectStore("inbound_group_sessions_withheld").get([e,t]);c.onsuccess=function(){try{i=c.result?c.result.session:null,!1!==o&&n(o,i)}catch(e){s(r,e)}}}getAllEndToEndInboundGroupSessions(e,t){const r=e.objectStore("inbound_group_sessions").openCursor();r.onsuccess=function(){const n=r.result;if(n){try{t({senderKey:n.value.senderCurve25519Key,sessionId:n.value.sessionId,sessionData:n.value.session})}catch(t){s(e,t)}n.continue()}else try{t(null)}catch(t){s(e,t)}}}addEndToEndInboundGroupSession(e,t,r,n){const i=n.objectStore("inbound_group_sessions").add({senderCurve25519Key:e,sessionId:t,session:r});i.onerror=r=>{"ConstraintError"===i.error.name?(r.stopPropagation(),r.preventDefault(),o.logger.log("Ignoring duplicate inbound group session: "+e+" / "+t)):s(n,new Error("Failed to add inbound group session: "+i.error))}}storeEndToEndInboundGroupSession(e,t,r,n){n.objectStore("inbound_group_sessions").put({senderCurve25519Key:e,sessionId:t,session:r})}storeEndToEndInboundGroupSessionWithheld(e,t,r,n){n.objectStore("inbound_group_sessions_withheld").put({senderCurve25519Key:e,sessionId:t,session:r})}getEndToEndDeviceData(e,t){const r=e.objectStore("device_data").get("-");r.onsuccess=function(){try{t(r.result||null)}catch(t){s(e,t)}}}storeEndToEndDeviceData(e,t){t.objectStore("device_data").put(e,"-")}storeEndToEndRoom(e,t,r){r.objectStore("rooms").put(t,e)}getEndToEndRooms(e,t){const r={},n=e.objectStore("rooms").openCursor();n.onsuccess=function(){const o=n.result;if(o)r[o.key]=o.value,o.continue();else try{t(r)}catch(t){s(e,t)}}}getSessionsNeedingBackup(e){return new Promise((t,r)=>{const n=[],o=this._db.transaction(["sessions_needing_backup","inbound_group_sessions"],"readonly");o.onerror=r,o.oncomplete=function(){t(n)};const i=o.objectStore("sessions_needing_backup"),s=o.objectStore("inbound_group_sessions"),a=i.openCursor();a.onsuccess=function(){const t=a.result;if(t){const r=s.get(t.key);r.onsuccess=function(){n.push({senderKey:r.result.senderCurve25519Key,sessionId:r.result.sessionId,sessionData:r.result.session})},(!e||n.length<e)&&t.continue()}}})}countSessionsNeedingBackup(e){e||(e=this._db.transaction("sessions_needing_backup","readonly"));const t=e.objectStore("sessions_needing_backup");return new Promise((e,r)=>{const n=t.count();n.onerror=r,n.onsuccess=()=>e(n.result)})}unmarkSessionsNeedingBackup(e,t){t||(t=this._db.transaction("sessions_needing_backup","readwrite"));const r=t.objectStore("sessions_needing_backup");return Promise.all(e.map(e=>new Promise((t,n)=>{const o=r.delete([e.senderKey,e.sessionId]);o.onsuccess=t,o.onerror=n})))}markSessionsNeedingBackup(e,t){t||(t=this._db.transaction("sessions_needing_backup","readwrite"));const r=t.objectStore("sessions_needing_backup");return Promise.all(e.map(e=>new Promise((t,n)=>{const o=r.put({senderCurve25519Key:e.senderKey,sessionId:e.sessionId});o.onsuccess=t,o.onerror=n})))}doTxn(e,t,r){const n=this._db.transaction(t,e),o=a(n),i=r(n);return o.then(()=>i)}}},function(e,t,r){"use strict";(function(e,n){var o=r(5),i=r(14);Object.defineProperty(t,"__esModule",{value:!0}),t.isCryptoAvailable=function(){return Boolean(e.Olm)},t.Crypto=M,t.fixBackupKey=j,t.verificationMethods=void 0;var s=i(r(41)),a=r(10),c=r(40),u=r(3),l=o(r(6)),d=r(65),h=o(r(19)),p=r(119),f=r(32),m=o(r(66)),g=r(33),v=r(120),y=r(121),_=r(122),b=r(23),E=r(67),S=r(123),w=r(68),R=r(69),I=r(45),k=r(127),P=r(128),T=r(129),O=r(31),A=r(43);const D=f.DeviceInfo.DeviceVerification,C={[E.ReciprocateQRCode.NAME]:E.ReciprocateQRCode,[S.SAS.NAME]:S.SAS,[E.SHOW_QR_CODE_METHOD]:T.IllegalMethod,[E.SCAN_QR_CODE_METHOD]:T.IllegalMethod},x={RECIPROCATE_QR_CODE:E.ReciprocateQRCode.NAME,SAS:S.SAS.NAME};t.verificationMethods=x;function M(e,t,r,n,o,i,s,a){if(this._onDeviceListUserCrossSigningUpdated=this._onDeviceListUserCrossSigningUpdated.bind(this),this._trustCrossSignedDevices=!0,this._reEmitter=new c.ReEmitter(this),this._baseApis=e,this._sessionStore=t,this._userId=r,this._deviceId=n,this._clientStore=o,this._cryptoStore=i,this._roomList=s,a){this._verificationMethods=new Map;for(const e of a)"string"==typeof e?C[e]&&this._verificationMethods.set(e,C[e]):e.NAME?this._verificationMethods.set(e.NAME,e):console.warn("Excluding unknown verification method "+e)}else this._verificationMethods=C;this.backupInfo=null,this.backupKey=null,this._checkedForBackup=!1,this._sendingBackups=!1,this._olmDevice=new d.OlmDevice(i),this._deviceList=new p.DeviceList(e,i,this._olmDevice),this._deviceList.on("userCrossSigningUpdated",this._onDeviceListUserCrossSigningUpdated),this._reEmitter.reEmit(this._deviceList,["crypto.devicesUpdated","crypto.willUpdateDevices"]),this._lastOneTimeKeyCheck=null,this._oneTimeKeyCheckInProgress=!1,this._roomEncryptors={},this._roomDecryptors={},this._supportedAlgorithms=l.keys(m.DECRYPTION_CLASSES),this._deviceKeys={},this._globalBlacklistUnverifiedDevices=!1,this._globalErrorOnUnknownDevices=!0,this._outgoingRoomKeyRequestManager=new _.OutgoingRoomKeyRequestManager(e,this._deviceId,this._cryptoStore),this._receivedRoomKeyRequests=[],this._receivedRoomKeyRequestCancellations=[],this._processingRoomKeyRequests=!1,this._lazyLoadMembers=!1,this._roomDeviceTrackingState={},this._lastNewSessionForced={},this._toDeviceVerificationRequests=new P.ToDeviceRequests,this._inRoomVerificationRequests=new k.InRoomRequests,this._sendKeyRequestsImmediately=!1;const u=this._baseApis._cryptoCallbacks||{},h=(0,g.createCryptoStoreCacheCallbacks)(i,this._olmDevice);this._crossSigningInfo=new g.CrossSigningInfo(r,u,h),this._secretStorage=new y.SecretStorage(e,u),!u.getCrossSigningKey&&u.getSecretStorageKey&&(u.getCrossSigningKey=async e=>g.CrossSigningInfo.getFromSecretStorage(e,this._secretStorage))}function j(e){if("string"!=typeof e||e.indexOf(",")<0)return null;const t=Uint8Array.from(e.split(","),e=>parseInt(e));return h.encodeBase64(t)}function U(e){if(e._oneTimeKeyCheckInProgress)return;const t=Date.now();if(null!==e._lastOneTimeKeyCheck&&t-e._lastOneTimeKeyCheck<6e4)return;e._lastOneTimeKeyCheck=t;const r=e._olmDevice.maxNumberOfOneTimeKeys(),n=Math.floor(r/2);function o(t){if(n<=t)return Promise.resolve();const r=Math.min(n-t,5);return e._olmDevice.generateOneTimeKeys(r).then(()=>async function(e){const t=await e._olmDevice.getOneTimeKeys(),r={},n=[];for(const o in t.curve25519)if(t.curve25519.hasOwnProperty(o)){const i={key:t.curve25519[o]};r["signed_curve25519:"+o]=i,n.push(e._signObject(i))}await Promise.all(n);const o=await e._baseApis.uploadKeysRequest({one_time_keys:r});return await e._olmDevice.markKeysAsPublished(),o}(e)).then(e=>{if(e.one_time_key_counts&&e.one_time_key_counts.signed_curve25519)return o(e.one_time_key_counts.signed_curve25519);throw new Error("response for uploading keys does not contain one_time_key_counts.signed_curve25519")})}e._oneTimeKeyCheckInProgress=!0,Promise.resolve().then(()=>void 0!==e._oneTimeKeyCount?Promise.resolve(e._oneTimeKeyCount):e._baseApis.uploadKeysRequest({}).then(e=>e.one_time_key_counts.signed_curve25519||0)).then(e=>o(e)).catch(e=>{u.logger.error("Error uploading one-time keys",e.stack||e)}).finally(()=>{e._oneTimeKeyCount=void 0,e._oneTimeKeyCheckInProgress=!1})}l.inherits(M,a.EventEmitter),M.prototype.init=async function(t){const{exportedOlmDevice:r,pickleKey:n}=t||{};u.logger.log("Crypto: initialising Olm..."),await e.Olm.init(),u.logger.log(r?"Crypto: initialising Olm device from exported device...":"Crypto: initialising Olm device..."),await this._olmDevice.init({fromExportedDevice:r,pickleKey:n}),u.logger.log("Crypto: loading device list..."),await this._deviceList.load(),this._deviceKeys["ed25519:"+this._deviceId]=this._olmDevice.deviceEd25519Key,this._deviceKeys["curve25519:"+this._deviceId]=this._olmDevice.deviceCurve25519Key,u.logger.log("Crypto: fetching own devices...");let o=this._deviceList.getRawStoredDevicesForUser(this._userId);if(o||(o={}),!o[this._deviceId]){u.logger.log("Crypto: adding this device to the store...");const e={keys:this._deviceKeys,algorithms:this._supportedAlgorithms,verified:D.VERIFIED,known:!0};o[this._deviceId]=e,this._deviceList.storeDevicesForUser(this._userId,o),this._deviceList.saveIfDirty()}await this._cryptoStore.doTxn("readonly",[b.IndexedDBCryptoStore.STORE_ACCOUNT],e=>{this._cryptoStore.getCrossSigningKeys(e,e=>{e&&0!==Object.keys(e).length&&(u.logger.log("Loaded cross-signing public keys from crypto store"),this._crossSigningInfo.setKeys(e))})}),this._deviceList.startTrackingDeviceList(this._userId),u.logger.log("Crypto: checking for key backup..."),this._checkAndStartKeyBackup()},M.prototype.getCryptoTrustCrossSignedDevices=function(){return this._trustCrossSignedDevices},M.prototype.setCryptoTrustCrossSignedDevices=function(e){this._trustCrossSignedDevices=e;for(const e of this._deviceList.getKnownUserIds()){const t=this._deviceList.getRawStoredDevicesForUser(e);for(const r of Object.keys(t)){const t=this.checkDeviceTrust(e,r);if(!t.isLocallyVerified()&&t.isCrossSigningVerified()){const t=this._deviceList.getStoredDevice(e,r);this.emit("deviceVerificationChanged",e,r,t)}}}},M.prototype.createRecoveryKeyFromPassphrase=async function(t){const r=new e.Olm.PkDecryption;try{const e={};if(t){const n=await(0,w.keyFromPassphrase)(t);e.passphrase={algorithm:"m.pbkdf2",iterations:n.iterations,salt:n.salt},e.pubkey=r.init_with_private_key(n.key)}else e.pubkey=r.generate_key();const n=r.get_private_key();return{keyInfo:e,encodedPrivateKey:(0,R.encodeRecoveryKey)(n),privateKey:n}}finally{r&&r.free()}},M.prototype.isCrossSigningReady=async function(){const e=this._crossSigningInfo.getId(),t=await this._crossSigningInfo.isStoredInSecretStorage(this._secretStorage),r=await this._secretStorage.hasKey();return e&&t&&r},M.prototype.bootstrapSecretStorage=async function({authUploadDeviceSigningKeys:e,createSecretStorageKey:t=(async()=>({})),keyBackupInfo:r,setupNewKeyBackup:n,setupNewSecretStorage:o,getKeyBackupPassphrase:i}={}){u.logger.log("Bootstrapping Secure Secret Storage");const s=this._baseApis._cryptoCallbacks,a=new v.EncryptionSetupBuilder(this._baseApis.store.accountData,s),c=new y.SecretStorage(a.accountDataClientAdapter,a.ssssCryptoCallbacks),l=new g.CrossSigningInfo(this._userId,a.crossSigningCallbacks,a.crossSigningCallbacks);let d=null;const p=async(e,t)=>{e=e||{},t&&(e.key=t);const r=await c.addKey(y.SECRET_STORAGE_ALGORITHM_V1_AES,e);return t&&a.ssssCryptoCallbacks.addPrivateKey(r,t),await c.setDefaultKeyId(r),r},f=async()=>{l.resetKeys(),await this._signObject(l.keys.master),await e(e=>e?(a.addCrossSigningKeys(e,l.keys),Promise.resolve()):this._baseApis.uploadDeviceSigningKeys(null,{}));const t=this._deviceList.getStoredDevice(this._userId,this._deviceId),n=await l.signDevice(this._userId,t);a.addKeySignature(this._userId,this._deviceId,n),r&&(await l.signObject(r.auth_data,"master"),a.addSessionBackup(r))},m=async(e,t)=>{if(!t.mac){const r=await this._baseApis._cryptoCallbacks.getSecretStorageKey({keys:{[e]:t}},"");if(r){const n=r[1];a.ssssCryptoCallbacks.addPrivateKey(e,n);const{iv:o,mac:i}=await y.SecretStorage._calculateKeyCheck(n);t.iv=o,t.mac=i,await a.setAccountData("m.secret_storage.key."+e,t)}}},_=await this.getSecretStorageKey(),[b,E]=_||[null,null],S=await this._crossSigningInfo.isStoredInSecretStorage(this._secretStorage),w=!o&&S;if(w||r)if(!w&&r){u.logger.log("Secret storage default key not found, using key backup key");const e=await this.getSessionBackupPrivateKey()||await i();await f();const t={};r.auth_data.private_key_salt&&r.auth_data.private_key_iterations&&(t.passphrase={algorithm:"m.pbkdf2",iterations:r.auth_data.private_key_iterations,salt:r.auth_data.private_key_salt,bits:256}),d=await p(t,e),await c.store("m.megolm_backup.v1",h.encodeBase64(e),[d]),u.logger.log("Adding cross signing signature to key backup"),await l.signObject(r.auth_data,"master"),a.addSessionBackup(r)}else this._crossSigningInfo.getId()?(u.logger.log("Cross signing keys are present in secret storage"),E&&E.algorithm===y.SECRET_STORAGE_ALGORITHM_V1_AES&&await m(b,E)):(u.logger.log("Cross-signing private keys found in secret storage"),await this.checkOwnCrossSigningTrust(),E&&E.algorithm===y.SECRET_STORAGE_ALGORITHM_V1_AES&&await m(b,E));else if(u.logger.log("Cross-signing private keys not found in secret storage, creating new keys"),await f(),o||!E||E.algorithm!==y.SECRET_STORAGE_ALGORITHM_V1_AES){const{keyInfo:e,privateKey:r}=await t();d=await p(e,r)}const I=a.crossSigningCallbacks.privateKeys;if(I.size&&(u.logger.log("Storing cross-signing private keys in secret storage"),this._baseApis._cryptoCallbacks.saveCrossSigningKeys||await g.CrossSigningInfo.storeInSecretStorage(I,c)),n&&!r){const e=await this._baseApis.prepareKeyBackupVersion(null,{secureSecretStorage:!1}),t=(0,R.decodeRecoveryKey)(e.recovery_key);await c.store("m.megolm_backup.v1",h.encodeBase64(t));const r={algorithm:e.algorithm,auth_data:e.auth_data};await l.signObject(r.auth_data,"master"),await this._signObject(r.auth_data),a.addSessionBackup(r)}const k=await c.get("m.megolm_backup.v1");if(k){u.logger.info("Got session backup key from secret storage: caching");const e=j(k);e&&await c.store("m.megolm_backup.v1",e,[d||b]);const t=new Uint8Array(h.decodeBase64(e||k));await a.addSessionBackupPrivateKeyToCache(t)}const P=a.buildOperation();await P.apply(this),await a.persist(this),u.logger.log("Secure Secret Storage ready")},M.prototype.addSecretStorageKey=function(e,t,r){return this._secretStorage.addKey(e,t,r)},M.prototype.hasSecretStorageKey=function(e){return this._secretStorage.hasKey(e)},M.prototype.getSecretStorageKey=function(e){return this._secretStorage.getKey(e)},M.prototype.storeSecret=function(e,t,r){return this._secretStorage.store(e,t,r)},M.prototype.getSecret=function(e){return this._secretStorage.get(e)},M.prototype.isSecretStored=function(e,t){return this._secretStorage.isStored(e,t)},M.prototype.requestSecret=function(e,t){return t||(t=Object.keys(this._deviceList.getRawStoredDevicesForUser(this._userId))),this._secretStorage.request(e,t)},M.prototype.getDefaultSecretStorageKeyId=function(){return this._secretStorage.getDefaultKeyId()},M.prototype.setDefaultSecretStorageKeyId=function(e){return this._secretStorage.setDefaultKeyId(e)},M.prototype.checkSecretStorageKey=function(e,t){return this._secretStorage.checkKey(e,t)},M.prototype.checkSecretStoragePrivateKey=function(t,r){let n=null;try{n=new e.Olm.PkDecryption;return n.init_with_private_key(t)===r}finally{n&&n.free()}},M.prototype.getSessionBackupPrivateKey=async function(){let e=await new Promise(e=>{this._cryptoStore.doTxn("readonly",[b.IndexedDBCryptoStore.STORE_ACCOUNT],t=>{this._cryptoStore.getSecretStorePrivateKey(t,e,"m.megolm_backup.v1")})});if(e&&"string"==typeof e&&(e=new Uint8Array(h.decodeBase64(j(e)||e)),await this.storeSessionBackupPrivateKey(e)),e&&e.ciphertext){const t=n.from(this._olmDevice._pickleKey),r=await(0,A.decryptAES)(e,t,"m.megolm_backup.v1");e=h.decodeBase64(r)}return e},M.prototype.storeSessionBackupPrivateKey=async function(e){if(!(e instanceof Uint8Array))throw new Error("storeSessionBackupPrivateKey expects Uint8Array, got "+e);const t=n.from(this._olmDevice._pickleKey);return e=await(0,A.encryptAES)(h.encodeBase64(e),t,"m.megolm_backup.v1"),this._cryptoStore.doTxn("readwrite",[b.IndexedDBCryptoStore.STORE_ACCOUNT],t=>{this._cryptoStore.storeSecretStorePrivateKey(t,"m.megolm_backup.v1",e)})},M.prototype.checkCrossSigningPrivateKey=function(t,r){let n=null;try{n=new e.Olm.PkSigning;return n.init_with_seed(t)===r}finally{n&&n.free()}},M.prototype._afterCrossSigningLocalKeyChange=async function(){u.logger.info("Starting cross-signing key change post-processing");const e=this._deviceList.getStoredDevice(this._userId,this._deviceId),t=await this._crossSigningInfo.signDevice(this._userId,e);u.logger.info("Starting background key sig upload for "+this._deviceId);const r=({shouldEmit:e})=>this._baseApis.uploadKeySignatures({[this._userId]:{[this._deviceId]:t}}).then(t=>{const{failures:n}=t||{};if(Object.keys(n||[]).length>0)throw e&&this._baseApis.emit("crypto.keySignatureUploadFailure",n,"_afterCrossSigningLocalKeyChange",r),new O.KeySignatureUploadError("Key upload failed",{failures:n});u.logger.info("Finished background key sig upload for "+this._deviceId)}).catch(e=>{u.logger.error("Error during background key sig upload for "+this._deviceId,e)});r({shouldEmit:!0});const n=this._baseApis._cryptoCallbacks.shouldUpgradeDeviceVerifications;if(n){u.logger.info("Starting device verification upgrade");const e={};for(const[t,r]of Object.entries(this._deviceList._crossSigningInfo)){const n=await this._checkForDeviceVerificationUpgrade(t,g.CrossSigningInfo.fromStorage(r,t));n&&(e[t]=n)}if(Object.keys(e).length>0){u.logger.info(`Found ${Object.keys(e).length} verif users to upgrade`);try{const t=await n({users:e});if(t)for(const r of t)r in e&&await this._baseApis.setDeviceVerified(r,e[r].crossSigningInfo.getId())}catch(e){u.logger.log("shouldUpgradeDeviceVerifications threw an error: not upgrading",e)}}u.logger.info("Finished device verification upgrade")}u.logger.info("Finished cross-signing key change post-processing")},M.prototype._checkForDeviceVerificationUpgrade=async function(e,t){const r=this._crossSigningInfo.checkUserTrust(t);if(t.firstUse&&!r.verified){const r=this._deviceList.getRawStoredDevicesForUser(e),n=await this._checkForValidDeviceSignature(e,t.keys.master,r);if(n.length)return{devices:n.map(e=>f.DeviceInfo.fromStorage(r[e],e)),crossSigningInfo:t}}},M.prototype._checkForValidDeviceSignature=async function(e,t,r){const n=[];if(r&&t.signatures&&t.signatures[e])for(const o of Object.keys(t.signatures[e])){const[,i]=o.split(":",2);if(i in r&&r[i].verified===D.VERIFIED)try{await h.verifySignature(this._olmDevice,t,e,i,r[i].keys[o]),n.push(i)}catch(e){}}return n},M.prototype.getCrossSigningId=function(e){return this._crossSigningInfo.getId(e)},M.prototype.getStoredCrossSigningForUser=function(e){return this._deviceList.getStoredCrossSigningForUser(e)},M.prototype.checkUserTrust=function(e){const t=this._deviceList.getStoredCrossSigningForUser(e);return t?this._crossSigningInfo.checkUserTrust(t):new g.UserTrustLevel(!1,!1,!1)},M.prototype.checkDeviceTrust=function(e,t){const r=this._deviceList.getStoredDevice(e,t);return this._checkDeviceInfoTrust(e,r)},M.prototype._checkDeviceInfoTrust=function(e,t){const r=!(!t||!t.isVerified()),n=this._deviceList.getStoredCrossSigningForUser(e);if(t&&n){const o=this._trustCrossSignedDevices||e===this._userId;return this._crossSigningInfo.checkDeviceTrust(n,t,r,o)}return new g.DeviceTrustLevel(!1,!1,r,!1)},M.prototype._onDeviceListUserCrossSigningUpdated=async function(e){if(e===this._userId){const t=this._deviceList.getStoredCrossSigningForUser(e),r=t?t.getId():null,n=this._crossSigningInfo.getId(),o=n!==r;n&&r&&!o?await this.checkOwnCrossSigningTrust():(this._storeTrustedSelfKeys(null),this.emit("crossSigning.keysChanged",{}),this.emit("userTrustStatusChanged",this._userId,this.checkUserTrust(e)))}else{await this._checkDeviceVerifications(e);const t=this._deviceList.getStoredCrossSigningForUser(e);t&&(t.updateCrossSigningVerifiedBefore(this.checkUserTrust(e).isCrossSigningVerified()),this._deviceList.setRawStoredCrossSigningForUser(e,t.toStorage())),this.emit("userTrustStatusChanged",e,this.checkUserTrust(e))}},M.prototype.checkOwnCrossSigningTrust=async function(){const e=this._userId;await this.downloadKeys([this._userId]);const t=this._deviceList.getStoredCrossSigningForUser(e);if(!t)return void u.logger.error("Got cross-signing update event for user "+e+" but no new cross-signing information found!");const r=t.getId(),n=this._crossSigningInfo.getId()!==r;if(n){u.logger.info("Got new master public key",r);let e=null;try{if(e=(await this._crossSigningInfo.getCrossSigningKey("master",r))[1],!e)throw new Error("Cross-signing master private key not available")}finally{e&&e.free()}u.logger.info("Got matching private key from callback for new public master key")}const o=this._crossSigningInfo.getId("self_signing"),i=this._crossSigningInfo.getId("user_signing");this._storeTrustedSelfKeys(t.keys);const s={};if(o!==t.getId("self_signing")){u.logger.info("Got new self-signing key",t.getId("self_signing"));const e=this._deviceList.getStoredDevice(this._userId,this._deviceId),r=await this._crossSigningInfo.signDevice(this._userId,e);s[this._deviceId]=r}if(i!==t.getId("user_signing")&&u.logger.info("Got new user-signing key",t.getId("user_signing")),n){const e=this._crossSigningInfo.keys.master;await this._signObject(e);const t=e.signatures[this._userId]["ed25519:"+this._deviceId];s[this._crossSigningInfo.getId()]=Object.assign({},e,{signatures:{[this._userId]:{["ed25519:"+this._deviceId]:t}}})}const a=Object.keys(s);if(a.length){const e=({shouldEmit:t})=>(u.logger.info("Starting background key sig upload for "+a),this._baseApis.uploadKeySignatures({[this._userId]:s}).then(r=>{const{failures:n}=r||{};if(u.logger.info("Finished background key sig upload for "+a),Object.keys(n||[]).length>0)throw t&&this._baseApis.emit("crypto.keySignatureUploadFailure",n,"checkOwnCrossSigningTrust",e),new O.KeySignatureUploadError("Key upload failed",{failures:n})}).catch(e=>{u.logger.error("Error during background key sig upload for "+a,e)}));e({shouldEmit:!0})}this.emit("userTrustStatusChanged",e,this.checkUserTrust(e)),n&&(this._baseApis.emit("crossSigning.keysChanged",{}),await this._afterCrossSigningLocalKeyChange()),await this.checkKeyBackup()},M.prototype._storeTrustedSelfKeys=async function(e){e?this._crossSigningInfo.setKeys(e):this._crossSigningInfo.clearKeys(),await this._cryptoStore.doTxn("readwrite",[b.IndexedDBCryptoStore.STORE_ACCOUNT],e=>{this._cryptoStore.storeCrossSigningKeys(e,this._crossSigningInfo.keys)})},M.prototype._checkDeviceVerifications=async function(e){const t=this._baseApis._cryptoCallbacks.shouldUpgradeDeviceVerifications;if(t){if(u.logger.info("Starting device verification upgrade for "+e),this._crossSigningInfo.keys.user_signing){const r=this._deviceList.getStoredCrossSigningForUser(e);if(r){const n=await this._checkForDeviceVerificationUpgrade(e,r);if(n){(await t({users:{[e]:n}})).includes(e)&&await this._baseApis.setDeviceVerified(e,r.getId())}}}u.logger.info("Finished device verification upgrade for "+e)}},M.prototype._checkAndStartKeyBackup=async function(){if(u.logger.log("Checking key backup status..."),this._baseApis.isGuest())return u.logger.log("Skipping key backup check since user is guest"),this._checkedForBackup=!0,null;let e;try{e=await this._baseApis.getKeyBackupVersion()}catch(e){return u.logger.log("Error checking for active key backup",e),404===e.httpStatus&&(this._checkedForBackup=!0),null}this._checkedForBackup=!0;const t=await this.isKeyBackupTrusted(e);return t.usable&&!this.backupInfo?(u.logger.log("Found usable key backup v"+e.version+": enabling key backups"),this._baseApis.enableKeyBackup(e)):!t.usable&&this.backupInfo?(u.logger.log("No usable key backup: disabling key backup"),this._baseApis.disableKeyBackup()):t.usable||this.backupInfo?t.usable&&this.backupInfo&&(e.version!==this.backupInfo.version?(u.logger.log("On backup version "+this.backupInfo.version+" but found version "+e.version+": switching."),this._baseApis.disableKeyBackup(),this._baseApis.enableKeyBackup(e)):u.logger.log("Backup version "+e.version+" still current")):u.logger.log("No usable key backup: not enabling key backup"),{backupInfo:e,trustInfo:t}},M.prototype.setTrustedBackupPubKey=async function(e){this._sessionStore.setLocalTrustedBackupPubKey(e),await this.checkKeyBackup()},M.prototype.checkKeyBackup=async function(){return this._checkedForBackup=!1,this._checkAndStartKeyBackup()},M.prototype.isKeyBackupTrusted=async function(e){const t={usable:!1,trusted_locally:!1,sigs:[]};if(!(e&&e.algorithm&&e.auth_data&&e.auth_data.public_key&&e.auth_data.signatures))return u.logger.info("Key backup is absent or missing required data"),t;const r=this._sessionStore.getLocalTrustedBackupPubKey();e.auth_data.public_key===r&&(u.logger.info("Backup public key "+r+" is trusted locally"),t.trusted_locally=!0);const n=e.auth_data.signatures[this._userId]||[];for(const r of Object.keys(n)){const n=r.split(":");if("ed25519"!==n[0]){u.logger.log("Ignoring unknown signature type: "+n[0]);continue}const o={deviceId:n[1]},i=this._crossSigningInfo.getId();if(i===o.deviceId){o.crossSigningId=!0;try{await h.verifySignature(this._olmDevice,e.auth_data,this._userId,o.deviceId,i),o.valid=!0}catch(e){u.logger.warning("Bad signature from cross signing key "+i,e),o.valid=!1}t.sigs.push(o);continue}const s=this._deviceList.getStoredDevice(this._userId,o.deviceId);if(s){o.device=s,o.deviceTrust=await this.checkDeviceTrust(this._userId,o.deviceId);try{await h.verifySignature(this._olmDevice,e.auth_data,this._userId,s.deviceId,s.getFingerprint()),o.valid=!0}catch(t){u.logger.info("Bad signature from key ID "+r+" userID "+this._userId+" device ID "+s.deviceId+" fingerprint: "+s.getFingerprint(),e.auth_data,t),o.valid=!1}}else o.valid=null,u.logger.info("Ignoring signature from unknown key "+r);t.sigs.push(o)}return t.usable=t.sigs.some(e=>e.valid&&(e.device&&e.deviceTrust.isVerified()||e.crossSigningId)),t.usable|=t.trusted_locally,t},M.prototype.enableLazyLoading=function(){this._lazyLoadMembers=!0},M.prototype.registerEventHandlers=function(e){const t=this;e.on("RoomMember.membership",(function(e,r,n){try{t._onRoomMembership(e,r,n)}catch(e){u.logger.error("Error handling membership change:",e)}})),e.on("toDeviceEvent",t._onToDeviceEvent.bind(t));const r=t._onTimelineEvent.bind(t);e.on("Room.timeline",r),e.on("Event.decrypted",r)},M.prototype.start=function(){this._outgoingRoomKeyRequestManager.start()},M.prototype.stop=function(){this._outgoingRoomKeyRequestManager.stop(),this._deviceList.stop()},M.getOlmVersion=function(){return d.OlmDevice.getOlmVersion()},M.prototype.getDeviceEd25519Key=function(){return this._olmDevice.deviceEd25519Key},M.prototype.getDeviceCurve25519Key=function(){return this._olmDevice.deviceCurve25519Key},M.prototype.setGlobalBlacklistUnverifiedDevices=function(e){this._globalBlacklistUnverifiedDevices=e},M.prototype.getGlobalBlacklistUnverifiedDevices=function(){return this._globalBlacklistUnverifiedDevices},M.prototype.setGlobalErrorOnUnknownDevices=function(e){this._globalErrorOnUnknownDevices=e},M.prototype.getGlobalErrorOnUnknownDevices=function(){return this._globalErrorOnUnknownDevices},M.prototype.uploadDeviceKeys=function(){const e=this,t=e._userId,r=e._deviceId,n={algorithms:e._supportedAlgorithms,device_id:r,keys:e._deviceKeys,user_id:t};return e._signObject(n).then(()=>e._baseApis.uploadKeysRequest({device_keys:n}))},M.prototype.updateOneTimeKeyCount=function(e){if(!isFinite(e))throw new TypeError("Parameter for updateOneTimeKeyCount has to be a number");this._oneTimeKeyCount=e},M.prototype.downloadKeys=function(e,t){return this._deviceList.downloadKeys(e,t)},M.prototype.getStoredDevicesForUser=function(e){return this._deviceList.getStoredDevicesForUser(e)},M.prototype.getStoredDevice=function(e,t){return this._deviceList.getStoredDevice(e,t)},M.prototype.saveDeviceList=function(e){return this._deviceList.saveIfDirty(e)},M.prototype.setDeviceVerification=async function(e,t,r,n,o){void 0===r&&(r=null),void 0===n&&(n=null),void 0===o&&(o=null);const i=this._deviceList.getStoredCrossSigningForUser(e);if(i&&i.getId()===t){if(null!==n||null!==o)throw new Error("Cannot set blocked or known for a cross-signing key");if(!r)throw new Error("Cannot set a cross-signing key as unverified");if(this._crossSigningInfo.getId()||e!==this._crossSigningInfo.userId||(this._storeTrustedSelfKeys(i.keys),this.emit("userTrustStatusChanged",this._userId,this.checkUserTrust(e))),e!==this._userId){u.logger.info("Master key "+i.getId()+" for "+e+" marked verified. Signing...");const r=await this._crossSigningInfo.signUser(i);if(r){const n=async({shouldEmit:o})=>{u.logger.info("Uploading signature for "+e+"...");const i=await this._baseApis.uploadKeySignatures({[e]:{[t]:r}}),{failures:s}=i||{};if(Object.keys(s||[]).length>0)throw o&&this._baseApis.emit("crypto.keySignatureUploadFailure",s,"setDeviceVerification",n),new O.KeySignatureUploadError("Key upload failed",{failures:s})};await n({shouldEmit:!0})}return r}return i}const s=this._deviceList.getRawStoredDevicesForUser(e);if(!s||!s[t])throw new Error("Unknown device "+e+":"+t);const a=s[t];let c=a.verified;r?c=D.VERIFIED:null!==r&&c==D.VERIFIED&&(c=D.UNVERIFIED),n?c=D.BLOCKED:null!==n&&c==D.BLOCKED&&(c=D.UNVERIFIED);let l=a.known;if(null!==o&&(l=o),a.verified===c&&a.known===l||(a.verified=c,a.known=l,this._deviceList.storeDevicesForUser(e,s),this._deviceList.saveIfDirty()),r&&e===this._userId){u.logger.info("Own device "+t+" marked verified: signing");const r=await this._crossSigningInfo.signDevice(e,f.DeviceInfo.fromStorage(a,t));if(r){const n=async({shouldEmit:o})=>{u.logger.info("Uploading signature for "+t);const i=await this._baseApis.uploadKeySignatures({[e]:{[t]:r}}),{failures:s}=i||{};if(Object.keys(s||[]).length>0)throw o&&this._baseApis.emit("crypto.keySignatureUploadFailure",s,"setDeviceVerification",n),new O.KeySignatureUploadError("Key upload failed",{failures:s})};await n({shouldEmit:!0})}}const d=f.DeviceInfo.fromStorage(a,t);return this.emit("deviceVerificationChanged",e,t,d),d},M.prototype.findVerificationRequestDMInProgress=function(e){return this._inRoomVerificationRequests.findRequestInProgress(e)},M.prototype.getVerificationRequestsToDeviceInProgress=function(e){return this._toDeviceVerificationRequests.getRequestsInProgress(e)},M.prototype.requestVerificationDM=function(e,t){const r=this._inRoomVerificationRequests.findRequestInProgress(t);if(r)return Promise.resolve(r);const n=new k.InRoomChannel(this._baseApis,t,e);return this._requestVerificationWithChannel(e,n,this._inRoomVerificationRequests)},M.prototype.requestVerification=function(e,t){t||(t=Object.keys(this._deviceList.getRawStoredDevicesForUser(e)));const r=this._toDeviceVerificationRequests.findRequestInProgress(e,t);if(r)return Promise.resolve(r);const n=new P.ToDeviceChannel(this._baseApis,e,t,P.ToDeviceChannel.makeTransactionId());return this._requestVerificationWithChannel(e,n,this._toDeviceVerificationRequests)},M.prototype._requestVerificationWithChannel=async function(e,t,r){let n=new I.VerificationRequest(t,this._verificationMethods,this._baseApis);t.transactionId&&r.setRequestByChannel(t,n),await n.sendRequest();const o=r.getRequestByChannel(t);return o?n=o:(u.logger.log(`Crypto: adding new request to requestsByTxnId with id ${t.transactionId} ${t.roomId}`),r.setRequestByChannel(t,n)),n},M.prototype.beginKeyVerification=function(e,t,r,n=null){let o;if(n){if(o=this._toDeviceVerificationRequests.getRequestBySenderAndTxnId(t,n),!o)throw new Error(`No request found for user ${t} with transactionId `+n)}else{n=P.ToDeviceChannel.makeTransactionId();const e=new P.ToDeviceChannel(this._baseApis,t,[r],n,r);o=new I.VerificationRequest(e,this._verificationMethods,this._baseApis),this._toDeviceVerificationRequests.setRequestBySenderAndTxnId(t,n,o)}return o.beginKeyVerification(e,{userId:t,deviceId:r})},M.prototype.legacyDeviceVerification=async function(e,t,r){const n=P.ToDeviceChannel.makeTransactionId(),o=new P.ToDeviceChannel(this._baseApis,e,[t],n,t),i=new I.VerificationRequest(o,this._verificationMethods,this._baseApis);this._toDeviceVerificationRequests.setRequestBySenderAndTxnId(e,n,i);const s=i.beginKeyVerification(r,{userId:e,deviceId:t});return await Promise.race([s.verify(),i.waitFor(e=>e.started)]),i},M.prototype.getOlmSessionsForUser=async function(e){const t=this.getStoredDevicesForUser(e)||[],r={};for(let e=0;e<t.length;++e){const n=t[e],o=n.getIdentityKey(),i=await this._olmDevice.getSessionInfoForDevice(o);r[n.deviceId]={deviceIdKey:o,sessions:i}}return r},M.prototype.getEventSenderDeviceInfo=function(e){const t=e.getSenderKey(),r=e.getWireContent().algorithm;if(!t||!r)return null;if(e.getForwardingCurve25519KeyChain().length>0)return null;if(e.isKeySourceUntrusted())return null;const n=this._deviceList.getDeviceByIdentityKey(r,t);if(null===n)return null;const o=e.getClaimedEd25519Key();return o?o!==n.getFingerprint()?(u.logger.warn("Event "+e.getId()+" claims ed25519 key "+o+"but sender device has key "+n.getFingerprint()),null):n:(u.logger.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),null)},M.prototype.getEventEncryptionInfo=function(e){const t={};if(t.senderKey=e.getSenderKey(),t.algorithm=e.getWireContent().algorithm,!t.senderKey||!t.algorithm)return t.encrypted=!1,t;t.encrypted=!0;e.getForwardingCurve25519KeyChain().length>0||e.isKeySourceUntrusted()?t.authenticated=!1:t.authenticated=!0,t.sender=this._deviceList.getDeviceByIdentityKey(t.algorithm,t.senderKey);const r=e.getClaimedEd25519Key();return r||(u.logger.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),t.mismatchedSender=!0),t.sender&&r!==t.sender.getFingerprint()&&(u.logger.warn("Event "+e.getId()+" claims ed25519 key "+r+"but sender device has key "+t.sender.getFingerprint()),t.mismatchedSender=!0),t},M.prototype.forceDiscardSession=function(e){const t=this._roomEncryptors[e];if(void 0===t)throw new Error("Room not encrypted");if(void 0===t.forceDiscardSession)throw new Error("Room encryption algorithm doesn't support session discarding");t.forceDiscardSession()},M.prototype.setRoomEncryption=async function(e,t,r){if(!t.algorithm)return void u.logger.log("Ignoring setRoomEncryption with no algorithm");const n=this._roomList.getRoomEncryption(e);if(n&&JSON.stringify(n)!=JSON.stringify(t))return void u.logger.error("Ignoring m.room.encryption event which requests a change of config in "+e);if(this._roomEncryptors[e])return;let o=null;n||(o=this._roomList.setRoomEncryption(e,t));const i=m.ENCRYPTION_CLASSES[t.algorithm];if(!i)throw new Error("Unable to encrypt with "+t.algorithm);const s=new i({userId:this._userId,deviceId:this._deviceId,crypto:this,olmDevice:this._olmDevice,baseApis:this._baseApis,roomId:e,config:t});this._roomEncryptors[e]=s,o&&await o,this._lazyLoadMembers?u.logger.log("Enabling encryption in "+e):(u.logger.log("Enabling encryption in "+e+"; starting to track device lists for all users therein"),await this.trackRoomDevices(e),this.inhibitDeviceQuery||this._deviceList.refreshOutdatedDeviceLists())},M.prototype.trackRoomDevices=function(e){const t=async()=>{if(!this._roomEncryptors[e])return;const t=this._clientStore.getRoom(e);if(!t)throw new Error("Unable to start tracking devices in unknown room "+e);u.logger.log(`Starting to track devices for room ${e} ...`);(await t.getEncryptionTargetMembers()).forEach(e=>{this._deviceList.startTrackingDeviceList(e.userId)})};let r=this._roomDeviceTrackingState[e];return r||(r=t(),this._roomDeviceTrackingState[e]=r),r},M.prototype.ensureOlmSessionsForUsers=function(e){const t={};for(let r=0;r<e.length;++r){const n=e[r];t[n]=[];const o=this.getStoredDevicesForUser(n)||[];for(let e=0;e<o.length;++e){const r=o[e];r.getIdentityKey()!=this._olmDevice.deviceCurve25519Key&&(r.verified!=D.BLOCKED&&t[n].push(r))}}return h.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,t)},M.prototype.exportRoomKeys=async function(){const e=[];return await this._cryptoStore.doTxn("readonly",[b.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS],t=>{this._cryptoStore.getAllEndToEndInboundGroupSessions(t,t=>{if(null===t)return;const r=this._olmDevice.exportInboundGroupSession(t.senderKey,t.sessionId,t.sessionData);delete r.first_known_index,r.algorithm=h.MEGOLM_ALGORITHM,e.push(r)})}),e},M.prototype.importRoomKeys=function(e,t={}){let r=0,n=0;const o=e.length;function i(){t.progressCallback({stage:"load_keys",successes:r,failures:n,total:o})}return Promise.all(e.map(e=>{if(!e.room_id||!e.algorithm)return u.logger.warn("ignoring room key entry with missing fields",e),n++,t.progressCallback&&i(),null;return this._getRoomDecryptor(e.room_id,e.algorithm).importRoomKey(e,t).finally(e=>{r++,t.progressCallback&&i()})}))},M.prototype.scheduleKeyBackupSend=async function(e=1e4){if(!this._sendingBackups){this._sendingBackups=!0;try{const t=Math.random()*e;await(0,l.sleep)(t);let r=0;for(;;){if(!this.backupKey)return;try{if(0===await this._backupPendingKeys(200))return;r=0}catch(e){if(r++,u.logger.log("Key backup request failed",e),e.data&&("M_NOT_FOUND"==e.data.errcode||"M_WRONG_ROOM_KEYS_VERSION"==e.data.errcode))throw await this.checkKeyBackup(),this.emit("crypto.keyBackupFailed",e.data.errcode),e}r&&await(0,l.sleep)(1e3*Math.pow(2,Math.min(r-1,4)))}}finally{this._sendingBackups=!1}}},M.prototype._backupPendingKeys=async function(e){const t=await this._cryptoStore.getSessionsNeedingBackup(e);if(!t.length)return 0;let r=await this._cryptoStore.countSessionsNeedingBackup();this.emit("crypto.keyBackupSessionsRemaining",r);const n={};for(const e of t){const t=e.sessionData.room_id;void 0===n[t]&&(n[t]={sessions:{}});const r=await this._olmDevice.exportInboundGroupSession(e.senderKey,e.sessionId,e.sessionData);r.algorithm=h.MEGOLM_ALGORITHM,delete r.session_id,delete r.room_id;const o=r.first_known_index;delete r.first_known_index;const i=this.backupKey.encrypt(JSON.stringify(r)),s=(r.forwarding_curve25519_key_chain||[]).length,a=this._deviceList.getUserByIdentityKey(h.MEGOLM_ALGORITHM,e.senderKey),c=this._deviceList.getDeviceByIdentityKey(h.MEGOLM_ALGORITHM,e.senderKey),u=this._checkDeviceInfoTrust(a,c).isVerified();n[t].sessions[e.sessionId]={first_message_index:o,forwarded_count:s,is_verified:u,session_data:i}}return await this._baseApis.sendKeyBackup(void 0,void 0,this.backupInfo.version,{rooms:n}),await this._cryptoStore.unmarkSessionsNeedingBackup(t),r=await this._cryptoStore.countSessionsNeedingBackup(),this.emit("crypto.keyBackupSessionsRemaining",r),t.length},M.prototype.backupGroupSession=async function(e,t,r,n,o,i,s){if(!this.backupInfo)throw new Error("Key backups are not enabled");await this._cryptoStore.markSessionsNeedingBackup([{senderKey:t,sessionId:n}]),this.scheduleKeyBackupSend()},M.prototype.scheduleAllGroupSessionsForBackup=async function(){await this.flagAllGroupSessionsForBackup(),this.scheduleKeyBackupSend(0)},M.prototype.flagAllGroupSessionsForBackup=async function(){await this._cryptoStore.doTxn("readwrite",[b.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,b.IndexedDBCryptoStore.STORE_BACKUP],e=>{this._cryptoStore.getAllEndToEndInboundGroupSessions(e,t=>{null!==t&&this._cryptoStore.markSessionsNeedingBackup([t],e)})});const e=await this._cryptoStore.countSessionsNeedingBackup();return this.emit("crypto.keyBackupSessionsRemaining",e),e},M.prototype.prepareToEncrypt=function(e){const t=e.roomId,r=this._roomEncryptors[t];r&&r.prepareToEncrypt(e)},M.prototype.encryptEvent=async function(e,t){if(!t)throw new Error("Cannot send encrypted messages in unknown rooms");const r=e.getRoomId(),n=this._roomEncryptors[r];if(!n)throw new Error("Room was previously configured to use encryption, but is no longer. Perhaps the homeserver is hiding the configuration event.");this._roomDeviceTrackingState[r]||this.trackRoomDevices(r),await this._roomDeviceTrackingState[r];let o=e.getContent();const i=o["m.relates_to"];i&&(o=Object.assign({},o),delete o["m.relates_to"]);const s=await n.encryptMessage(t,e.getType(),o);i&&(s["m.relates_to"]=i),e.makeEncrypted("m.room.encrypted",s,this._olmDevice.deviceCurve25519Key,this._olmDevice.deviceEd25519Key)},M.prototype.decryptEvent=function(e){if(e.isRedacted())return Promise.resolve({clearEvent:{room_id:e.getRoomId(),type:"m.room.message",content:{}}});const t=e.getWireContent();return this._getRoomDecryptor(e.getRoomId(),t.algorithm).decryptEvent(e)},M.prototype.handleDeviceListChanges=async function(e,t){e.oldSyncToken&&await this._evalDeviceListChanges(t)},M.prototype.requestRoomKey=function(e,t,r=!1){return this._outgoingRoomKeyRequestManager.queueRoomKeyRequest(e,t,r).then(()=>{this._sendKeyRequestsImmediately&&this._outgoingRoomKeyRequestManager.sendQueuedRequests()}).catch(e=>{u.logger.error("Error requesting key for event",e)})},M.prototype.cancelRoomKeyRequest=function(e){this._outgoingRoomKeyRequestManager.cancelRoomKeyRequest(e).catch(e=>{u.logger.warn("Error clearing pending room key requests",e)})},M.prototype.cancelAndResendAllOutgoingKeyRequests=function(){return this._outgoingRoomKeyRequestManager.cancelAndResendAllOutgoingRequests()},M.prototype.onCryptoEvent=async function(e){const t=e.getRoomId(),r=e.getContent();try{await this.setRoomEncryption(t,r,!0)}catch(e){u.logger.error("Error configuring encryption in room "+t+":",e)}},M.prototype.onSyncWillProcess=async function(e){e.oldSyncToken||(u.logger.log("Initial sync performed - resetting device tracking state"),this._deviceList.stopTrackingAllDeviceLists(),this._deviceList.startTrackingDeviceList(this._userId),this._roomDeviceTrackingState={}),this._sendKeyRequestsImmediately=!1},M.prototype.onSyncCompleted=async function(e){const t=e.nextSyncToken;this._deviceList.setSyncToken(e.nextSyncToken),this._deviceList.saveIfDirty(),this._deviceList.lastKnownSyncToken=t,this._deviceList.startTrackingDeviceList(this._userId),this._deviceList.refreshOutdatedDeviceLists(),e.catchingUp||(U(this),this._processReceivedRoomKeyRequests(),this._outgoingRoomKeyRequestManager.sendQueuedRequests(),this._sendKeyRequestsImmediately=!0)},M.prototype._evalDeviceListChanges=async function(e){if(e.changed&&Array.isArray(e.changed)&&e.changed.forEach(e=>{this._deviceList.invalidateUserDeviceList(e)}),e.left&&Array.isArray(e.left)&&e.left.length){const t=new Set(await this._getTrackedE2eUsers());e.left.forEach(e=>{t.has(e)||this._deviceList.stopTrackingDeviceList(e)})}},M.prototype._getTrackedE2eUsers=async function(){const e=[];for(const t of this._getTrackedE2eRooms()){const r=await t.getEncryptionTargetMembers();for(const t of r)e.push(t.userId)}return e},M.prototype._getTrackedE2eRooms=function(){return this._clientStore.getRooms().filter(e=>{if(!this._roomEncryptors[e.roomId])return!1;if(!this._roomDeviceTrackingState[e.roomId])return!1;const t=e.getMyMembership();return"join"===t||"invite"===t})},M.prototype._onToDeviceEvent=function(e){try{u.logger.log(`received to_device ${e.getType()} from: ${e.getSender()} id: ${e.getId()}`),"m.room_key"==e.getType()||"m.forwarded_room_key"==e.getType()?this._onRoomKeyEvent(e):"m.room_key_request"==e.getType()?this._onRoomKeyRequestEvent(e):"m.secret.request"===e.getType()?this._secretStorage._onRequestReceived(e):"m.secret.send"===e.getType()?this._secretStorage._onSecretReceived(e):"org.matrix.room_key.withheld"===e.getType()?this._onRoomKeyWithheldEvent(e):e.getContent().transaction_id?this._onKeyVerificationMessage(e):"m.bad.encrypted"===e.getContent().msgtype?this._onToDeviceBadEncrypted(e):e.isBeingDecrypted()&&e.once("Event.decrypted",e=>{this._onToDeviceEvent(e)})}catch(e){u.logger.error("Error handling toDeviceEvent:",e)}},M.prototype._onRoomKeyEvent=function(e){const t=e.getContent();if(!t.room_id||!t.algorithm)return void u.logger.error("key event is missing fields");this._checkedForBackup||this._checkAndStartKeyBackup();this._getRoomDecryptor(t.room_id,t.algorithm).onRoomKeyEvent(e)},M.prototype._onRoomKeyWithheldEvent=function(e){const t=e.getContent();if(!(("m.no_olm"===t.code||t.room_id&&t.session_id)&&t.algorithm&&t.sender_key))return void u.logger.error("key withheld event is missing fields");u.logger.info(`Got room key withheld event from ${e.getSender()} (${t.sender_key}) for ${t.algorithm}/${t.room_id}/${t.session_id} with reason ${t.code} (${t.reason})`);const r=this._getRoomDecryptor(t.room_id,t.algorithm);if(r.onRoomKeyWithheldEvent&&r.onRoomKeyWithheldEvent(e),!t.room_id){const e=this._getRoomDecryptors(t.algorithm);for(const r of e)r.retryDecryptionFromSender(t.sender_key)}},M.prototype._onKeyVerificationMessage=function(e){if(!P.ToDeviceChannel.validateEvent(e,this._baseApis))return;this._handleVerificationEvent(e,this._toDeviceVerificationRequests,e=>{if(!P.ToDeviceChannel.canCreateRequest(P.ToDeviceChannel.getEventType(e)))return;const t=e.getContent(),r=t&&t.from_device;if(!r)return;const n=e.getSender(),o=new P.ToDeviceChannel(this._baseApis,n,[r]);return new I.VerificationRequest(o,this._verificationMethods,this._baseApis)})},M.prototype._onTimelineEvent=function(e,t,r,n,{liveEvent:o}={}){if(!k.InRoomChannel.validateEvent(e,this._baseApis))return;this._handleVerificationEvent(e,this._inRoomVerificationRequests,e=>{const t=new k.InRoomChannel(this._baseApis,e.getRoomId());return new I.VerificationRequest(t,this._verificationMethods,this._baseApis)},o)},M.prototype._handleVerificationEvent=async function(e,t,r,n=!0){let o=t.getRequest(e),i=!1;if(!o){if(o=r(e),!o)return void u.logger.log("Crypto: could not find VerificationRequest for "+e.getType()+", and could not create one, so ignoring.");i=!0,t.setRequest(e,o)}e.setVerificationRequest(o);try{await o.channel.handleEvent(e,o,n)}catch(e){u.logger.error("error while handling verification event: "+e.message)}i&&!o.initiatedByMe&&!o.invalid&&!o.observeOnly&&this._baseApis.emit("crypto.verification.request",o)},M.prototype._onToDeviceBadEncrypted=async function(e){const t=e.getWireContent(),r=e.getSender(),n=t.algorithm,o=t.sender_key,i=()=>{const e=this._getRoomDecryptors(h.MEGOLM_ALGORITHM);for(const t of e)t.retryDecryptionFromSender(o)};if(void 0===r||void 0===o||void 0===o)return;this._lastNewSessionForced[r]=this._lastNewSessionForced[r]||{};const s=this._lastNewSessionForced[r][o]||0;if(s+36e5>Date.now())return u.logger.debug("New session already forced with device "+r+":"+o+" at "+s+": not forcing another"),await this._olmDevice.recordSessionProblem(o,"wedged",!0),void i();let a=this._deviceList.getDeviceByIdentityKey(n,o);if(!a&&(await this.downloadKeys([r],!1),a=this._deviceList.getDeviceByIdentityKey(n,o),!a))return u.logger.info("Couldn't find device for identity key "+o+": not re-establishing session"),await this._olmDevice.recordSessionProblem(o,"wedged",!1),void i();const c={};c[r]=[a],await h.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,c,!0),this._lastNewSessionForced[r][o]=Date.now();const l={algorithm:h.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}};await h.encryptMessageForDevice(l.ciphertext,this._userId,this._deviceId,this._olmDevice,r,a,{type:"m.dummy"}),await this._olmDevice.recordSessionProblem(o,"wedged",!0),i(),await this._baseApis.sendToDevice("m.room.encrypted",{[r]:{[a.deviceId]:l}});const d=await this._outgoingRoomKeyRequestManager.getOutgoingSentRoomKeyRequest(r,a.deviceId);for(const e of d)this.requestRoomKey(e.requestBody,e.recipients,!0)},M.prototype._onRoomMembership=function(e,t,r){const n=t.roomId,o=this._roomEncryptors[n];o&&(this._roomDeviceTrackingState[n]&&("join"==t.membership?(u.logger.log("Join event for "+t.userId+" in "+n),this._deviceList.startTrackingDeviceList(t.userId)):"invite"==t.membership&&this._clientStore.getRoom(n).shouldEncryptForInvitedMembers()&&(u.logger.log("Invite event for "+t.userId+" in "+n),this._deviceList.startTrackingDeviceList(t.userId))),o.onRoomMembership(e,t,r))},M.prototype._onRoomKeyRequestEvent=function(e){const t=e.getContent();if("request"===t.action){const t=new N(e);this._receivedRoomKeyRequests.push(t)}else if("request_cancellation"===t.action){const t=new F(e);this._receivedRoomKeyRequestCancellations.push(t)}},M.prototype._processReceivedRoomKeyRequests=async function(){if(!this._processingRoomKeyRequests){this._processingRoomKeyRequests=!0;try{const e=this._receivedRoomKeyRequests;this._receivedRoomKeyRequests=[];const t=this._receivedRoomKeyRequestCancellations;this._receivedRoomKeyRequestCancellations=[],await Promise.all(e.map(e=>this._processReceivedRoomKeyRequest(e))),await Promise.all(t.map(e=>this._processReceivedRoomKeyRequestCancellation(e)))}catch(e){u.logger.error("Error processing room key requsts: "+e)}finally{this._processingRoomKeyRequests=!1}}},M.prototype._processReceivedRoomKeyRequest=async function(e){const t=e.userId,r=e.deviceId,n=e.requestBody,o=n.room_id,i=n.algorithm;if(u.logger.log(`m.room_key_request from ${t}:${r} for ${o} / ${n.session_id} (id ${e.requestId})`),t!==this._userId){if(!this._roomEncryptors[o])return void u.logger.debug("room key request for unencrypted room "+o);const e=this._roomEncryptors[o],i=this._deviceList.getStoredDevice(t,r);if(!i)return void u.logger.debug(`Ignoring keyshare for unknown device ${t}:${r}`);try{await e.reshareKeyWithDevice(n.sender_key,n.session_id,t,i)}catch(e){u.logger.warn("Failed to re-share keys for session "+n.session_id+" with device "+t+":"+i.deviceId,e)}return}if(r===this._deviceId)return void u.logger.log("Ignoring room key request from ourselves");if(!this._roomDecryptors[o])return void u.logger.log("room key request for unencrypted room "+o);const s=this._roomDecryptors[o][i];if(s)if(await s.hasKeysForKeyRequest(e)){if(e.share=()=>{s.shareKeysWithDevice(e)},this.checkDeviceTrust(t,r).isVerified())return u.logger.log("device is already verified: sharing keys"),void e.share();this.emit("crypto.roomKeyRequest",e)}else u.logger.log(`room key request for unknown session ${o} / `+n.session_id);else u.logger.log(`room key request for unknown alg ${i} in room ${o}`)},M.prototype._processReceivedRoomKeyRequestCancellation=async function(e){u.logger.log(`m.room_key_request cancellation for ${e.userId}:${e.deviceId} (id ${e.requestId})`),this.emit("crypto.roomKeyRequestCancellation",e)},M.prototype._getRoomDecryptor=function(e,t){let r,n;if((e=e||null)&&(r=this._roomDecryptors[e],r||(this._roomDecryptors[e]=r={}),n=r[t],n))return n;const o=m.DECRYPTION_CLASSES[t];if(!o)throw new m.DecryptionError("UNKNOWN_ENCRYPTION_ALGORITHM",'Unknown encryption algorithm "'+t+'".');return n=new o({userId:this._userId,crypto:this,olmDevice:this._olmDevice,baseApis:this._baseApis,roomId:e}),r&&(r[t]=n),n},M.prototype._getRoomDecryptors=function(e){const t=[];for(const r of Object.values(this._roomDecryptors))e in r&&t.push(r[e]);return t},M.prototype._signObject=async function(e){const t=e.signatures||{},r=e.unsigned;delete e.signatures,delete e.unsigned,t[this._userId]=t[this._userId]||{},t[this._userId]["ed25519:"+this._deviceId]=await this._olmDevice.sign(s.default.stringify(e)),e.signatures=t,void 0!==r&&(e.unsigned=r)};class N{constructor(e){const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id,this.requestBody=t.body||{},this.share=()=>{throw new Error("don't know how to share keys for this request yet")}}}class F{constructor(e){const t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id}}}).call(this,r(8),r(22).Buffer)},function(e,t,r){"use strict";var n=r(5),o=r(3),i=n(r(6)),s=n(r(19)),a=r(32),c=r(42);const u=a.DeviceInfo.DeviceVerification;function l(e){(0,i.polyfillSuper)(this,c.EncryptionAlgorithm,e),this._sessionPrepared=!1,this._prepPromise=null}function d(e){(0,i.polyfillSuper)(this,c.DecryptionAlgorithm,e)}i.inherits(l,c.EncryptionAlgorithm),l.prototype._ensureSession=function(e){if(this._prepPromise)return this._prepPromise;if(this._sessionPrepared)return Promise.resolve();const t=this;return this._prepPromise=t._crypto.downloadKeys(e).then((function(r){return t._crypto.ensureOlmSessionsForUsers(e)})).then((function(){t._sessionPrepared=!0})).finally((function(){t._prepPromise=null})),this._prepPromise},l.prototype.encryptMessage=async function(e,t,r){const n=await e.getEncryptionTargetMembers(),o=i.map(n,(function(e){return e.userId})),a=this;await this._ensureSession(o);const c={room_id:e.roomId,type:t,content:r},l={algorithm:s.OLM_ALGORITHM,sender_key:a._olmDevice.deviceCurve25519Key,ciphertext:{}},d=[];for(let e=0;e<o.length;++e){const t=o[e],r=a._crypto.getStoredDevicesForUser(t);for(let e=0;e<r.length;++e){const n=r[e];n.getIdentityKey()!=a._olmDevice.deviceCurve25519Key&&(n.verified!=u.BLOCKED&&d.push(s.encryptMessageForDevice(l.ciphertext,a._userId,a._deviceId,a._olmDevice,t,n,c)))}}return await Promise.all(d).then(()=>l)},i.inherits(d,c.DecryptionAlgorithm),d.prototype.decryptEvent=async function(e){const t=e.getWireContent(),r=t.sender_key,n=t.ciphertext;if(!n)throw new c.DecryptionError("OLM_MISSING_CIPHERTEXT","Missing ciphertext");if(!(this._olmDevice.deviceCurve25519Key in n))throw new c.DecryptionError("OLM_NOT_INCLUDED_IN_RECIPIENTS","Not included in recipients");const o=n[this._olmDevice.deviceCurve25519Key];let i;try{i=await this._decryptMessage(r,o)}catch(e){throw new c.DecryptionError("OLM_BAD_ENCRYPTED_MESSAGE","Bad Encrypted Message",{sender:r,err:e})}const s=JSON.parse(i);if(s.recipient!=this._userId)throw new c.DecryptionError("OLM_BAD_RECIPIENT","Message was intented for "+s.recipient);if(s.recipient_keys.ed25519!=this._olmDevice.deviceEd25519Key)throw new c.DecryptionError("OLM_BAD_RECIPIENT_KEY","Message not intended for this device",{intended:s.recipient_keys.ed25519,our_key:this._olmDevice.deviceEd25519Key});if(s.sender!=e.getSender())throw new c.DecryptionError("OLM_FORWARDED_MESSAGE","Message forwarded from "+s.sender,{reported_sender:e.getSender()});if(s.room_id!==e.getRoomId())throw new c.DecryptionError("OLM_BAD_ROOM","Message intended for room "+s.room_id,{reported_room:e.room_id});return{clearEvent:s,senderCurve25519Key:r,claimedEd25519Key:(s.keys||{}).ed25519||null}},d.prototype._decryptMessage=async function(e,t){if(0!==t.type)return this._reallyDecryptMessage(e,t);{const r=this._olmDevice._olmPrekeyPromise.then(()=>this._reallyDecryptMessage(e,t));return this._olmDevice._olmPrekeyPromise=r.catch(()=>{}),await r}},d.prototype._reallyDecryptMessage=async function(e,t){const r=await this._olmDevice.getSessionIdsForDevice(e),n={};for(let i=0;i<r.length;i++){const s=r[i];try{const r=await this._olmDevice.decryptMessage(e,s,t.type,t.body);return o.logger.log("Decrypted Olm message from "+e+" with session "+s),r}catch(r){if(await this._olmDevice.matchesSession(e,s,t.type,t.body))throw new Error("Error decrypting prekey message with existing session id "+s+": "+r.message);n[s]=r.message}}if(0!==t.type){if(0===r.length)throw new Error("No existing sessions");throw new Error("Error decrypting non-prekey message with existing sessions: "+JSON.stringify(n))}let i;try{i=await this._olmDevice.createInboundSession(e,t.type,t.body)}catch(e){throw n["(new)"]=e.message,new Error("Error decrypting prekey message: "+JSON.stringify(n))}return o.logger.log("created new inbound Olm session ID "+i.session_id+" with "+e),i.payload},(0,c.registerAlgorithm)(s.OLM_ALGORITHM,l,d)},function(e,t,r){"use strict";var n=r(5),o=r(3),i=n(r(6)),s=n(r(19)),a=r(42),c=r(65);function u(e){this.sessionId=e,this.useCount=0,this.creationTime=(new Date).getTime(),this.sharedWithDevices={},this.blockedDevicesNotified={}}function l(e){(0,i.polyfillSuper)(this,a.EncryptionAlgorithm,e),this._setupPromise=Promise.resolve(),this._outboundSessions={},this._sessionRotationPeriodMsgs=100,this._sessionRotationPeriodMs=6048e5,void 0!==e.config.rotation_period_ms&&(this._sessionRotationPeriodMs=e.config.rotation_period_ms),void 0!==e.config.rotation_period_msgs&&(this._sessionRotationPeriodMsgs=e.config.rotation_period_msgs)}function d(e){(0,i.polyfillSuper)(this,a.DecryptionAlgorithm,e),this._pendingEvents={},this.olmlib=s}u.prototype.needsRotation=function(e,t){const r=(new Date).getTime()-this.creationTime;return(this.useCount>=e||r>=t)&&(o.logger.log("Rotating megolm session after "+this.useCount+" messages, "+r+"ms"),!0)},u.prototype.markSharedWithDevice=function(e,t,r){this.sharedWithDevices[e]||(this.sharedWithDevices[e]={}),this.sharedWithDevices[e][t]=r},u.prototype.markNotifiedBlockedDevice=function(e,t){this.blockedDevicesNotified[e]||(this.blockedDevicesNotified[e]={}),this.blockedDevicesNotified[e][t]=!0},u.prototype.sharedWithTooManyDevices=function(e){for(const t in this.sharedWithDevices)if(this.sharedWithDevices.hasOwnProperty(t)){if(!e.hasOwnProperty(t))return o.logger.log("Starting new megolm session because we shared with "+t),!0;for(const r in this.sharedWithDevices[t])if(this.sharedWithDevices[t].hasOwnProperty(r)&&!e[t].hasOwnProperty(r))return o.logger.log("Starting new megolm session because we shared with "+t+":"+r),!0}},i.inherits(l,a.EncryptionAlgorithm),l.prototype._ensureOutboundSession=async function(e,t,r){let n;function i(){return n}const a=this._setupPromise.then(async i=>{n=i,n&&n.needsRotation(this._sessionRotationPeriodMsgs,this._sessionRotationPeriodMs)&&(o.logger.log("Starting new megolm session because we need to rotate."),n=null),n&&n.sharedWithTooManyDevices(e)&&(n=null),n||(o.logger.log("Starting new megolm session for room "+this._roomId),n=await this._prepareNewSession(),o.logger.log(`Started new megolm session ${n.sessionId} for room `+this._roomId),this._outboundSessions[n.sessionId]=n);const a={};for(const[t,r]of Object.entries(e))for(const[e,o]of Object.entries(r)){o.getIdentityKey()!=this._olmDevice.deviceCurve25519Key&&(n.sharedWithDevices[t]&&void 0!==n.sharedWithDevices[t][e]||(a[t]=a[t]||[],a[t].push(o)))}const c=this._olmDevice.getOutboundGroupSessionKey(n.sessionId),u={type:"m.room_key",content:{algorithm:s.MEGOLM_ALGORITHM,room_id:this._roomId,session_id:n.sessionId,session_key:c.key,chain_index:c.chain_index}},[l,d]=await s.getExistingOlmSessions(this._olmDevice,this._baseApis,a);await Promise.all([(async()=>{await this._shareKeyWithOlmSessions(n,c,u,d)})(),(async()=>{const e=[],t=Date.now(),o=[];await this._shareKeyWithDevices(n,c,u,l,e,r?1e4:2e3,o),!r&&Date.now()-t<1e4?(async()=>{const t={},r=new Set;for(const e of o)r.add(e);const i=[];for(const{userId:n,deviceInfo:o}of e){const e=n.slice(n.indexOf(":")+1);r.has(e)?(t[n]=t[n]||[],t[n].push(o)):i.push({userId:n,deviceInfo:o})}await this._shareKeyWithDevices(n,c,u,t,i,3e4),await this._notifyFailedOlmDevices(n,c,i)})():await this._notifyFailedOlmDevices(n,c,e)})(),(async()=>{const e={};for(const[r,o]of Object.entries(t))for(const[t,i]of Object.entries(o))n.blockedDevicesNotified[r]&&void 0!==n.blockedDevicesNotified[r][t]||(e[r]=e[r]||{},e[r][t]={device:i});await this._notifyBlockedDevices(n,e)})()])});return this._setupPromise=a.then(i,i),a.then(i)},l.prototype._prepareNewSession=async function(){const e=this._olmDevice.createOutboundGroupSession(),t=this._olmDevice.getOutboundGroupSessionKey(e);return await this._olmDevice.addInboundGroupSession(this._roomId,this._olmDevice.deviceCurve25519Key,[],e,t.key,{ed25519:this._olmDevice.deviceEd25519Key}),this._crypto.backupInfo&&this._crypto.backupGroupSession(this._roomId,this._olmDevice.deviceCurve25519Key,[],e,t.key).catch(e=>{o.logger.log("Failed to back up megolm session",e)}),new u(e)},l.prototype._getDevicesWithoutSessions=function(e,t,r){r=r||[];for(const[n,o]of Object.entries(t)){const t=e[n];for(const e of o){const o=e.deviceId;t[o].sessionId||(r.push({userId:n,deviceInfo:e}),delete t[o])}}return r},l.prototype._splitDevices=function(e){let t=[];const r=[t];for(const[n,o]of Object.entries(e)){for(const e of Object.values(o))t.push({userId:n,deviceInfo:e.device});t.length>20&&(t=[],r.push(t))}return 0===t.length&&r.pop(),r},l.prototype._encryptAndSendKeysToDevices=function(e,t,r,n){const i={},a=[];for(let e=0;e<r.length;e++){const t={algorithm:s.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}},o=r[e],c=o.userId,u=o.deviceInfo,l=u.deviceId;i[c]||(i[c]={}),i[c][l]=t,a.push(s.encryptMessageForDevice(t.ciphertext,this._userId,this._deviceId,this._olmDevice,c,u,n))}return Promise.all(a).then(()=>{for(const e of Object.keys(i)){for(const t of Object.keys(i[e]))0===Object.keys(i[e][t].ciphertext).length&&(o.logger.log("No ciphertext for device "+e+":"+t+": pruning"),delete i[e][t]);0===Object.keys(i[e]).length&&(o.logger.log("Pruned all devices for user "+e),delete i[e])}if(0!==Object.keys(i).length)return this._baseApis.sendToDevice("m.room.encrypted",i).then(()=>{for(const r of Object.keys(i))for(const n of Object.keys(i[r]))e.markSharedWithDevice(r,n,t)});o.logger.log("No users left to send to: aborting")})},l.prototype._sendBlockedNotificationsToDevices=async function(e,t,r){const n={};for(const e of t){const t=e.userId,o=e.deviceInfo,i=o.deviceInfo.deviceId,s=Object.assign({},r);s.code=o.code,s.reason=o.reason,"m.no_olm"===s.code&&(delete s.room_id,delete s.session_id),n[t]||(n[t]={}),n[t][i]=s}await this._baseApis.sendToDevice("org.matrix.room_key.withheld",n);for(const t of Object.keys(n))for(const r of Object.keys(n[t]))e.markNotifiedBlockedDevice(t,r)},l.prototype.reshareKeyWithDevice=async function(e,t,r,n){const i=this._outboundSessions[t];if(!i)return void o.logger.debug(`megolm session ${t} not found: not re-sharing keys`);if(void 0===i.sharedWithDevices[r])return void o.logger.debug(`megolm session ${t} never shared with user ${r}`);const a=i.sharedWithDevices[r][n.deviceId];if(void 0===a)return void o.logger.debug("megolm session ID "+t+" never shared with device "+r+":"+n.deviceId);const c=await this._olmDevice.getInboundGroupSessionKey(this._roomId,e,t,a);if(!c)return void o.logger.warn(`No inbound session key found for megolm ${t}: not re-sharing keys`);await s.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,{[r]:[n]});const u={type:"m.forwarded_room_key",content:{algorithm:s.MEGOLM_ALGORITHM,room_id:this._roomId,session_id:t,session_key:c.key,chain_index:c.chain_index,sender_key:e,sender_claimed_ed25519_key:c.sender_claimed_ed25519_key,forwarding_curve25519_key_chain:c.forwarding_curve25519_key_chain}},l={algorithm:s.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}};await s.encryptMessageForDevice(l.ciphertext,this._userId,this._deviceId,this._olmDevice,r,n,u),await this._baseApis.sendToDevice("m.room.encrypted",{[r]:{[n.deviceId]:l}}),o.logger.debug(`Re-shared key for megolm session ${t} with ${r}:${n.deviceId}`)},l.prototype._shareKeyWithDevices=async function(e,t,r,n,o,i,a){const c=await s.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,n,i,a);this._getDevicesWithoutSessions(c,n,o),await this._shareKeyWithOlmSessions(e,t,r,c)},l.prototype._shareKeyWithOlmSessions=async function(e,t,r,n){const i=this._splitDevices(n);for(let n=0;n<i.length;n++)try{await this._encryptAndSendKeysToDevices(e,t.chain_index,i[n],r),o.logger.log(`Completed megolm keyshare for ${e.sessionId} in ${this._roomId} (slice ${n+1}/${i.length})`)}catch(t){throw o.logger.log(`megolm keyshare for ${e.sessionId} in ${this._roomId} (slice ${n+1}/${i.length}) failed`),t}},l.prototype._notifyFailedOlmDevices=async function(e,t,r){for(const{userId:n,deviceInfo:o}of r){const r=o.deviceId;e.markSharedWithDevice(n,r,t.chain_index)}const n=await this._olmDevice.filterOutNotifiedErrorDevices(r),o={};for(const{userId:e,deviceInfo:t}of n)o[e]=o[e]||{},o[e][t.deviceId]={device:{code:"m.no_olm",reason:c.WITHHELD_MESSAGES["m.no_olm"],deviceInfo:t}};await this._notifyBlockedDevices(e,o)},l.prototype._notifyBlockedDevices=async function(e,t){const r={room_id:this._roomId,session_id:e.sessionId,algorithm:s.MEGOLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key},n=this._splitDevices(t);for(let t=0;t<n.length;t++)try{await this._sendBlockedNotificationsToDevices(e,n[t],r),o.logger.log(`Completed blacklist notification for ${e.sessionId} in ${this._roomId} (slice ${t+1}/${n.length})`)}catch(r){throw o.logger.log(`blacklist notification for ${e.sessionId} in ${this._roomId} (slice ${t+1}/${n.length}) failed`),r}},l.prototype.prepareToEncrypt=function(e){this.encryptionPreparation||(o.logger.debug("Preparing to encrypt events for "+this._roomId),this.encryptionPreparation=(async()=>{const[t,r]=await this._getDevicesInRoom(e);this._crypto.getGlobalErrorOnUnknownDevices()&&this._removeUnknownDevices(t),await this._ensureOutboundSession(t,r,!0),delete this.encryptionPreparation})())},l.prototype.encryptMessage=async function(e,t,r){if(o.logger.log("Starting to encrypt event for "+this._roomId),this.encryptionPreparation)try{await this.encryptionPreparation}catch(e){}const[n,i]=await this._getDevicesInRoom(e);this._crypto.getGlobalErrorOnUnknownDevices()&&this._checkForUnknownDevices(n);const a=await this._ensureOutboundSession(n,i),c={room_id:this._roomId,type:t,content:r},u=this._olmDevice.encryptGroupMessage(a.sessionId,JSON.stringify(c)),l={algorithm:s.MEGOLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:u,session_id:a.sessionId,device_id:this._deviceId};return a.useCount++,l},l.prototype.forceDiscardSession=function(){this._setupPromise=this._setupPromise.then(()=>null)},l.prototype._checkForUnknownDevices=function(e){const t={};if(Object.keys(e).forEach(r=>{Object.keys(e[r]).forEach(n=>{const o=e[r][n];o.isUnverified()&&!o.isKnown()&&(t[r]||(t[r]={}),t[r][n]=o)})}),Object.keys(t).length)throw new a.UnknownDeviceError("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",t)},l.prototype._removeUnknownDevices=function(e){for(const[t,r]of Object.entries(e)){for(const[e,t]of Object.entries(r))t.isUnverified()&&!t.isKnown()&&delete r[e];0===Object.keys(r).length&&delete e[t]}},l.prototype._getDevicesInRoom=async function(e){const t=await e.getEncryptionTargetMembers(),r=i.map(t,(function(e){return e.userId}));let n=this._crypto.getGlobalBlacklistUnverifiedDevices();"boolean"==typeof e.getBlacklistUnverifiedDevices()&&(n=e.getBlacklistUnverifiedDevices());const o=await this._crypto.downloadKeys(r,!1),s={};for(const e in o){if(!o.hasOwnProperty(e))continue;const t=o[e];for(const r in t){if(!t.hasOwnProperty(r))continue;const o=this._crypto.checkDeviceTrust(e,r);if(t[r].isBlocked()||!o.isVerified()&&n){s[e]||(s[e]={});const n=t[r].isBlocked()?{code:"m.blacklisted",reason:c.WITHHELD_MESSAGES["m.blacklisted"]}:{code:"m.unverified",reason:c.WITHHELD_MESSAGES["m.unverified"]};n.deviceInfo=t[r],s[e][r]=n,delete t[r]}}}return[o,s]},i.inherits(d,a.DecryptionAlgorithm);const h={no_olm:"The sender was unable to establish a secure channel.",unknown:"The secure channel with the sender was corrupted."};d.prototype.decryptEvent=async function(e){const t=e.getWireContent();if(!t.sender_key||!t.session_id||!t.ciphertext)throw new a.DecryptionError("MEGOLM_MISSING_FIELDS","Missing fields in input");let r;this._addEventToPendingList(e);try{r=await this._olmDevice.decryptGroupMessage(e.getRoomId(),t.sender_key,t.session_id,t.ciphertext,e.getId(),e.getTs())}catch(r){if("DecryptionError"===r.name)throw r;let n="OLM_DECRYPT_GROUP_MESSAGE_ERROR";throw r&&"OLM.UNKNOWN_MESSAGE_INDEX"===r.message&&(this._requestKeysForEvent(e),n="OLM_UNKNOWN_MESSAGE_INDEX"),new a.DecryptionError(n,r?r.toString():"Unknown Error: Error is undefined",{session:t.sender_key+"|"+t.session_id})}if(null===r){this._requestKeysForEvent(e);const r=await this._olmDevice.sessionMayHaveProblems(t.sender_key,e.getTs()-12e4);if(r){let e=h[r.type]||h.unknown;throw r.fixed&&(e+=" Trying to create a new secure channel and re-requesting the keys."),new a.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",e,{session:t.sender_key+"|"+t.session_id})}throw new a.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID","The sender's device has not sent us the keys for this message.",{session:t.sender_key+"|"+t.session_id})}this._removeEventFromPendingList(e);const n=JSON.parse(r.result);if(n.room_id!==e.getRoomId())throw new a.DecryptionError("MEGOLM_BAD_ROOM","Message intended for room "+n.room_id);return{clearEvent:n,senderCurve25519Key:r.senderKey,claimedEd25519Key:r.keysClaimed.ed25519,forwardingCurve25519KeyChain:r.forwardingCurve25519KeyChain,untrusted:r.untrusted}},d.prototype._requestKeysForEvent=function(e){const t=e.getWireContent(),r=e.getKeyRequestRecipients(this._userId);this._crypto.requestRoomKey({room_id:e.getRoomId(),algorithm:t.algorithm,sender_key:t.sender_key,session_id:t.session_id},r)},d.prototype._addEventToPendingList=function(e){const t=e.getWireContent(),r=t.sender_key,n=t.session_id;this._pendingEvents[r]||(this._pendingEvents[r]=new Map);const o=this._pendingEvents[r];o.has(n)||o.set(n,new Set),o.get(n).add(e)},d.prototype._removeEventFromPendingList=function(e){const t=e.getWireContent(),r=t.sender_key,n=t.session_id,o=this._pendingEvents[r],i=o&&o.get(n);i&&(i.delete(e),0===i.size&&o.delete(r),0===o.size&&delete this._pendingEvents[r])},d.prototype.onRoomKeyEvent=function(e){const t=e.getContent(),r=t.session_id;let n,s=e.getSenderKey(),a=[],c=!1;if(t.room_id&&r&&t.session_key){if(s){if("m.forwarded_room_key"==e.getType()){if(c=!0,a=t.forwarding_curve25519_key_chain,i.isArray(a)||(a=[]),a=a.slice(),a.push(s),s=t.sender_key,!s)return void o.logger.error("forwarded_room_key event is missing sender_key field");const e=t.sender_claimed_ed25519_key;if(!e)return void o.logger.error("forwarded_room_key_event is missing sender_claimed_ed25519_key field");n={ed25519:e}}else n=e.getKeysClaimed();return this._olmDevice.addInboundGroupSession(t.room_id,s,a,r,t.session_key,n,c).then(()=>{this._retryDecryption(s,r).then(e=>{e&&this._crypto.cancelRoomKeyRequest({algorithm:t.algorithm,room_id:t.room_id,session_id:t.session_id,sender_key:s})})}).then(()=>{this._crypto.backupInfo&&this._crypto.backupGroupSession(t.room_id,s,a,t.session_id,t.session_key,n,c).catch(e=>{o.logger.log("Failed to back up megolm session",e)})}).catch(e=>{o.logger.error("Error handling m.room_key_event: "+e)})}o.logger.error("key event has no sender key (not encrypted?)")}else o.logger.error("key event is missing fields")},d.prototype.onRoomKeyWithheldEvent=async function(e){const t=e.getContent(),r=t.sender_key;if("m.no_olm"===t.code){const n=e.getSender();if(o.logger.warn(`${n}:${r} was unable to establish an olm session with us`),await this._olmDevice.getSessionIdForDevice(r))return o.logger.debug("New session already created.  Not creating a new one."),await this._olmDevice.recordSessionProblem(r,"no_olm",!0),void this.retryDecryptionFromSender(r);let i=this._crypto._deviceList.getDeviceByIdentityKey(t.algorithm,r);if(!i&&(await this._crypto.downloadKeys([n],!1),i=this._crypto._deviceList.getDeviceByIdentityKey(t.algorithm,r),!i))return o.logger.info("Couldn't find device for identity key "+r+": not establishing session"),await this._olmDevice.recordSessionProblem(r,"no_olm",!1),void this.retryDecryptionFromSender(r);await s.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,{[n]:[i]},!1);const a={algorithm:s.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}};await s.encryptMessageForDevice(a.ciphertext,this._userId,this._deviceId,this._olmDevice,n,i,{type:"m.dummy"}),await this._olmDevice.recordSessionProblem(r,"no_olm",!0),this.retryDecryptionFromSender(r),await this._baseApis.sendToDevice("m.room.encrypted",{[n]:{[i.deviceId]:a}})}else await this._olmDevice.addInboundGroupSessionWithheld(t.room_id,r,t.session_id,t.code,t.reason)},d.prototype.hasKeysForKeyRequest=function(e){const t=e.requestBody;return this._olmDevice.hasInboundSessionKeys(t.room_id,t.sender_key,t.session_id)},d.prototype.shareKeysWithDevice=function(e){const t=e.userId,r=e.deviceId,n=this._crypto.getStoredDevice(t,r),i=e.requestBody;this.olmlib.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,{[t]:[n]}).then(e=>e[t][r].sessionId?(o.logger.log("sharing keys for session "+i.sender_key+"|"+i.session_id+" with device "+t+":"+r),this._buildKeyForwardingMessage(i.room_id,i.sender_key,i.session_id)):null).then(e=>{const o={algorithm:s.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}};return this.olmlib.encryptMessageForDevice(o.ciphertext,this._userId,this._deviceId,this._olmDevice,t,n,e).then(()=>{const e={[t]:{[r]:o}};return this._baseApis.sendToDevice("m.room.encrypted",e)})})},d.prototype._buildKeyForwardingMessage=async function(e,t,r){const n=await this._olmDevice.getInboundGroupSessionKey(e,t,r);return{type:"m.forwarded_room_key",content:{algorithm:s.MEGOLM_ALGORITHM,room_id:e,sender_key:t,sender_claimed_ed25519_key:n.sender_claimed_ed25519_key,session_id:r,session_key:n.key,chain_index:n.chain_index,forwarding_curve25519_key_chain:n.forwarding_curve25519_key_chain}}},d.prototype.importRoomKey=function(e,t={}){return this._olmDevice.addInboundGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0,t.untrusted?{untrusted:t.untrusted}:{}).then(()=>{this._crypto.backupInfo&&"backup"!==t.source&&this._crypto.backupGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0).catch(e=>{o.logger.log("Failed to back up megolm session",e)}),this._retryDecryption(e.sender_key,e.session_id)})},d.prototype._retryDecryption=async function(e,t){const r=this._pendingEvents[e];if(!r)return!0;const n=r.get(t);return!n||(o.logger.debug("Retrying decryption on events",[...n]),await Promise.all([...n].map(async e=>{try{await e.attemptDecryption(this._crypto,!0)}catch(e){}})),!(this._pendingEvents[e]||{})[t])},d.prototype.retryDecryptionFromSender=async function(e){const t=this._pendingEvents[e];return!t||(delete this._pendingEvents[e],await Promise.all([...t].map(async([e,t])=>{await Promise.all([...t].map(async e=>{try{await e.attemptDecryption(this._crypto)}catch(e){}}))})),!this._pendingEvents[e])},(0,a.registerAlgorithm)(s.MEGOLM_ALGORITHM,l,d)},function(e,t,r){"use strict";var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceList=void 0;var o=r(10),i=r(3),s=r(32),a=r(33),c=n(r(19)),u=r(23),l=r(6);class d extends o.EventEmitter{constructor(e,t,r){super(),this._cryptoStore=t,this._devices={},this._crossSigningInfo={},this._userByIdentityKey={},this._deviceTrackingStatus={},this._syncToken=null,this._serialiser=new h(e,r,this),this._keyDownloadsInProgressByUser={},this._dirty=!1,this._savePromise=null,this._resolveSavePromise=null,this._savePromiseTime=null,this._saveTimer=null,this._hasFetched=null}async load(){await this._cryptoStore.doTxn("readonly",[u.IndexedDBCryptoStore.STORE_DEVICE_DATA],e=>{this._cryptoStore.getEndToEndDeviceData(e,e=>{this._hasFetched=Boolean(e&&e.devices),this._devices=e?e.devices:{},this._crossSigningInfo=e&&e.crossSigningInfo||{},this._deviceTrackingStatus=e?e.trackingStatus:{},this._syncToken=e?e.syncToken:null,this._userByIdentityKey={};for(const e of Object.keys(this._devices)){const t=this._devices[e];for(const r of Object.keys(t)){const n=t[r].keys["curve25519:"+r];void 0!==n&&(this._userByIdentityKey[n]=e)}}})});for(const e of Object.keys(this._deviceTrackingStatus))2==this._deviceTrackingStatus[e]&&(this._deviceTrackingStatus[e]=1)}stop(){null!==this._saveTimer&&clearTimeout(this._saveTimer)}async saveIfDirty(e){if(!this._dirty)return Promise.resolve(!1);void 0===e&&(e=500);const t=Date.now+e;this._savePromiseTime&&t<this._savePromiseTime&&(clearTimeout(this._saveTimer),this._saveTimer=null,this._savePromiseTime=null);let r=this._savePromise;if(null===r&&(r=new Promise((e,t)=>{this._resolveSavePromise=e}),this._savePromise=r),null===this._saveTimer){const r=this._resolveSavePromise;this._savePromiseTime=t,this._saveTimer=setTimeout(()=>{i.logger.log("Saving device tracking data",this._syncToken),this._savePromiseTime=null,this._saveTimer=null,this._savePromise=null,this._resolveSavePromise=null,this._cryptoStore.doTxn("readwrite",[u.IndexedDBCryptoStore.STORE_DEVICE_DATA],e=>{this._cryptoStore.storeEndToEndDeviceData({devices:this._devices,crossSigningInfo:this._crossSigningInfo,trackingStatus:this._deviceTrackingStatus,syncToken:this._syncToken},e)}).then(()=>{this._dirty=!1,r()},e=>{i.logger.error("Failed to save device tracking data",this._syncToken),i.logger.error(e)})},e)}return r}getSyncToken(){return this._syncToken}setSyncToken(e){this._syncToken=e}downloadKeys(e,t){const r=[],n=[];if(e.forEach(e=>{const o=this._deviceTrackingStatus[e];this._keyDownloadsInProgressByUser[e]?(i.logger.log("downloadKeys: already have a download in progress for "+e+": awaiting its result"),n.push(this._keyDownloadsInProgressByUser[e])):(t||3!=o)&&r.push(e)}),0!=r.length){i.logger.log("downloadKeys: downloading for",r);const e=this._doKeyDownload(r);n.push(e)}return 0===n.length&&i.logger.log("downloadKeys: already have all necessary keys"),Promise.all(n).then(()=>this._getDevicesFromStore(e))}_getDevicesFromStore(e){const t={},r=this;return e.map((function(e){t[e]={};(r.getStoredDevicesForUser(e)||[]).map((function(r){t[e][r.deviceId]=r}))})),t}getKnownUserIds(){return Object.keys(this._devices)}getStoredDevicesForUser(e){const t=this._devices[e];if(!t)return null;const r=[];for(const e in t)t.hasOwnProperty(e)&&r.push(s.DeviceInfo.fromStorage(t[e],e));return r}getRawStoredDevicesForUser(e){return this._devices[e]}getStoredCrossSigningForUser(e){return this._crossSigningInfo[e]?a.CrossSigningInfo.fromStorage(this._crossSigningInfo[e],e):null}storeCrossSigningForUser(e,t){this._crossSigningInfo[e]=t,this._dirty=!0}getStoredDevice(e,t){const r=this._devices[e];if(r&&r[t])return s.DeviceInfo.fromStorage(r[t],t)}getUserByIdentityKey(e,t){return e!==c.OLM_ALGORITHM&&e!==c.MEGOLM_ALGORITHM?null:this._userByIdentityKey[t]}getDeviceByIdentityKey(e,t){const r=this.getUserByIdentityKey(e,t);if(!r)return null;const n=this._devices[r];if(!n)return null;for(const e in n){if(!n.hasOwnProperty(e))continue;const r=n[e];for(const n in r.keys){if(!r.keys.hasOwnProperty(n))continue;if(0!==n.indexOf("curve25519:"))continue;if(r.keys[n]==t)return s.DeviceInfo.fromStorage(r,e)}}return null}storeDevicesForUser(e,t){if(void 0!==this._devices[e])for(const[t,r]of Object.entries(this._devices[e])){const e=r.keys["curve25519:"+t];delete this._userByIdentityKey[e]}this._devices[e]=t;for(const[r,n]of Object.entries(t)){const t=n.keys["curve25519:"+r];this._userByIdentityKey[t]=e}this._dirty=!0}startTrackingDeviceList(e){if("string"!=typeof e)throw new Error("userId must be a string; was "+e);this._deviceTrackingStatus[e]||(i.logger.log("Now tracking device list for "+e),this._deviceTrackingStatus[e]=1,this._dirty=!0)}stopTrackingDeviceList(e){this._deviceTrackingStatus[e]&&(i.logger.log("No longer tracking device list for "+e),this._deviceTrackingStatus[e]=0,this._dirty=!0)}stopTrackingAllDeviceLists(){for(const e of Object.keys(this._deviceTrackingStatus))this._deviceTrackingStatus[e]=0;this._dirty=!0}invalidateUserDeviceList(e){this._deviceTrackingStatus[e]&&(i.logger.log("Marking device list outdated for",e),this._deviceTrackingStatus[e]=1,this._dirty=!0)}refreshOutdatedDeviceLists(){this.saveIfDirty();const e=[];for(const t of Object.keys(this._deviceTrackingStatus)){1==this._deviceTrackingStatus[t]&&e.push(t)}return this._doKeyDownload(e)}_setRawStoredDevicesForUser(e,t){if(void 0!==this._devices[e])for(const[t,r]of Object.entries(this._devices[e])){const e=r.keys["curve25519:"+t];delete this._userByIdentityKey[e]}this._devices[e]=t;for(const[r,n]of Object.entries(t)){const t=n.keys["curve25519:"+r];this._userByIdentityKey[t]=e}}setRawStoredCrossSigningForUser(e,t){this._crossSigningInfo[e]=t}_doKeyDownload(e){if(0===e.length)return Promise.resolve();const t=this._serialiser.updateDevicesForUsers(e,this._syncToken).then(()=>{r(!0)},t=>{throw i.logger.error("Error downloading keys for "+e+":",t),r(!1),t});e.forEach(e=>{this._keyDownloadsInProgressByUser[e]=t;1==this._deviceTrackingStatus[e]&&(this._deviceTrackingStatus[e]=2)});const r=r=>{this.emit("crypto.willUpdateDevices",e,!this._hasFetched),e.forEach(e=>{if(this._dirty=!0,this._keyDownloadsInProgressByUser[e]!==t)return void i.logger.log("Another update in the queue for",e,"- not marking up-to-date");delete this._keyDownloadsInProgressByUser[e];2==this._deviceTrackingStatus[e]&&(r?(this._deviceTrackingStatus[e]=3,i.logger.log("Device list for",e,"now up to date")):this._deviceTrackingStatus[e]=1)}),this.saveIfDirty(),this.emit("crypto.devicesUpdated",e,!this._hasFetched),this._hasFetched=!0};return t}}t.DeviceList=d;class h{constructor(e,t,r){this._baseApis=e,this._olmDevice=t,this._deviceList=r,this._downloadInProgress=!1,this._keyDownloadsQueuedByUser={},this._queuedQueryDeferred=null,this._syncToken=null}updateDevicesForUsers(e,t){return e.forEach(e=>{this._keyDownloadsQueuedByUser[e]=!0}),this._queuedQueryDeferred||(this._queuedQueryDeferred=(0,l.defer)()),this._syncToken=t,this._downloadInProgress?(i.logger.log("Queued key download for",e),this._queuedQueryDeferred.promise):this._doQueuedQueries()}_doQueuedQueries(){if(this._downloadInProgress)throw new Error("DeviceListUpdateSerialiser._doQueuedQueries called with request active");const e=Object.keys(this._keyDownloadsQueuedByUser);this._keyDownloadsQueuedByUser={};const t=this._queuedQueryDeferred;this._queuedQueryDeferred=null,i.logger.log("Starting key download for",e),this._downloadInProgress=!0;const r={};return this._syncToken&&(r.token=this._syncToken),this._baseApis.downloadKeysForUsers(e,r).then(async t=>{const r=t.device_keys||{},n=t.master_keys||{},o=t.self_signing_keys||{},s=t.user_signing_keys||{};for(const t of e){await(0,l.sleep)(5);try{await this._processQueryResponseForUser(t,r[t],{master:n[t],self_signing:o[t],user_signing:s[t]})}catch(e){i.logger.error(`Error processing keys for ${t}:`,e)}}}).then(()=>{i.logger.log("Completed key download for "+e),this._downloadInProgress=!1,t.resolve(),this._queuedQueryDeferred&&this._doQueuedQueries()},r=>{i.logger.warn("Error downloading keys for "+e+":",r),this._downloadInProgress=!1,t.reject(r)}),t.promise}async _processQueryResponseForUser(e,t,r){i.logger.log("got device keys for "+e+":",t),i.logger.log("got cross-signing keys for "+e+":",r);{const r={},n=this._deviceList.getRawStoredDevicesForUser(e);n&&Object.keys(n).forEach(e=>{const t=s.DeviceInfo.fromStorage(n[e],e);r[e]=t}),await async function(e,t,r,n){let o=!1;for(const e in r)r.hasOwnProperty(e)&&(e in n||(i.logger.log("Device "+t+":"+e+" has been removed"),delete r[e],o=!0));for(const s in n){if(!n.hasOwnProperty(s))continue;const a=n[s];a.user_id===t?a.device_id===s?await p(e,r,a)&&(o=!0):i.logger.warn("Mismatched device_id "+a.device_id+" in keys from "+t+":"+s):i.logger.warn("Mismatched user_id "+a.user_id+" in keys from "+t+":"+s)}return o}(this._olmDevice,e,r,t||{});const o={};Object.keys(r).forEach(e=>{o[e]=r[e].toStorage()}),this._deviceList._setRawStoredDevicesForUser(e,o)}if(r&&(r.master||r.self_signing||r.user_signing)){const t=this._deviceList.getStoredCrossSigningForUser(e)||new a.CrossSigningInfo(e);t.setKeys(r),this._deviceList.setRawStoredCrossSigningForUser(e,t.toStorage()),this._deviceList.emit("userCrossSigningUpdated",e)}}}async function p(e,t,r){if(!r.keys)return!1;const n=r.device_id,o=r.user_id,a="ed25519:"+n,u=r.keys[a];if(!u)return i.logger.warn("Device "+o+":"+n+" has no ed25519 key"),!1;const l=r.unsigned||{},d=r.signatures||{};try{await c.verifySignature(e,r,o,n,u)}catch(e){return i.logger.warn("Unable to verify signature on device "+o+":"+n+":"+e),!1}let h;if(n in t){if(h=t[n],h.getFingerprint()!=u)return i.logger.warn("Ed25519 key for device "+o+":"+n+" has changed"),!1}else t[n]=h=new s.DeviceInfo(n);return h.keys=r.keys||{},h.algorithms=r.algorithms||[],h.unsigned=l,h.signatures=d,!0}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EncryptionSetupOperation=t.EncryptionSetupBuilder=void 0;var n=r(18),o=r(10),i=r(33),s=r(23),a=r(29);t.EncryptionSetupBuilder=class{constructor(e,t){this.accountDataClientAdapter=new u(e),this.crossSigningCallbacks=new l,this.ssssCryptoCallbacks=new d(t),this._crossSigningKeys=null,this._keySignatures=null,this._keyBackupInfo=null}addCrossSigningKeys(e,t){this._crossSigningKeys={auth:e,keys:t}}addSessionBackup(e){this._keyBackupInfo=e}addSessionBackupPrivateKeyToCache(e){this._sessionBackupPrivateKey=e}addKeySignature(e,t,r){this._keySignatures||(this._keySignatures={});const n=this._keySignatures[e]||{};this._keySignatures[e]=n,n[t]=r}setAccountData(e,t){return this.accountDataClientAdapter.setAccountData(e,t)}buildOperation(){const e=this.accountDataClientAdapter._values;return new c(e,this._crossSigningKeys,this._keyBackupInfo,this._keySignatures)}async persist(e){if(this._crossSigningKeys){const t=(0,i.createCryptoStoreCacheCallbacks)(e._cryptoStore,e._olmDevice);for(const e of["self_signing","user_signing"]){const r=this.crossSigningCallbacks.privateKeys.get(e);await t.storeCrossSigningKeyCache(e,r)}await e._cryptoStore.doTxn("readwrite",[s.IndexedDBCryptoStore.STORE_ACCOUNT],t=>{e._cryptoStore.storeCrossSigningKeys(t,this._crossSigningKeys.keys)})}this._sessionBackupPrivateKey&&await e.storeSessionBackupPrivateKey(this._sessionBackupPrivateKey)}};class c{constructor(e,t,r,n){this._accountData=e,this._crossSigningKeys=t,this._keyBackupInfo=r,this._keySignatures=n}async apply(e){const t=e._baseApis;if(this._accountData)for(const[e,r]of this._accountData)await t.setAccountData(e,r);if(this._crossSigningKeys){const r={};for(const[e,t]of Object.entries(this._crossSigningKeys.keys))r[e+"_key"]=t;await t.uploadDeviceSigningKeys(this._crossSigningKeys.auth,r),e._crossSigningInfo.setKeys(this._crossSigningKeys.keys)}this._keySignatures&&await t.uploadKeySignatures(this._keySignatures),this._keyBackupInfo&&(this._keyBackupInfo.version?await t._http.authedRequest(void 0,"PUT","/room_keys/version/"+this._keyBackupInfo.version,void 0,{algorithm:this._keyBackupInfo.algorithm,auth_data:this._keyBackupInfo.auth_data},{prefix:a.PREFIX_UNSTABLE}):await t._http.authedRequest(void 0,"POST","/room_keys/version",void 0,this._keyBackupInfo,{prefix:a.PREFIX_UNSTABLE}))}}t.EncryptionSetupOperation=c;class u extends o.EventEmitter{constructor(e){super(),this._existingValues=e,this._values=new Map}getAccountDataFromServer(e){return Promise.resolve(this.getAccountData(e))}getAccountData(e){const t=this._values.get(e);if(t)return t;const r=this._existingValues[e];return r?r.getContent():null}setAccountData(e,t){const r=this._values.get(e);return this._values.set(e,t),Promise.resolve().then(()=>{const o=new n.MatrixEvent({type:e,content:t});this.emit("accountData",o,r)})}}class l{constructor(){this.privateKeys=new Map}getCrossSigningKeyCache(e,t){return this.getCrossSigningKey(e,t)}storeCrossSigningKeyCache(e,t){return this.privateKeys.set(e,t),Promise.resolve()}getCrossSigningKey(e,t){return Promise.resolve(this.privateKeys.get(e))}saveCrossSigningKeys(e){for(const[t,r]of Object.entries(e))this.privateKeys.set(t,r)}}class d{constructor(e){this._privateKeys=new Map,this._delegateCryptoCallbacks=e}async getSecretStorageKey({keys:e},t){for(const t of Object.keys(e)){const e=this._privateKeys.get(t);if(e)return[t,e]}if(this._delegateCryptoCallbacks){const r=await this._delegateCryptoCallbacks.getSecretStorageKey({keys:e},t);if(r){const[e,t]=r;this._privateKeys.set(e,t)}return r}}addPrivateKey(e,t){this._privateKeys.set(e,t)}}},function(e,t,r){"use strict";var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.SecretStorage=t.SECRET_STORAGE_ALGORITHM_V1_AES=void 0;var o=r(10),i=r(3),s=n(r(19)),a=r(34),c=r(43);t.SECRET_STORAGE_ALGORITHM_V1_AES="m.secret_storage.v1.aes-hmac-sha2";class u extends o.EventEmitter{constructor(e,t){super(),this._baseApis=e,this._cryptoCallbacks=t,this._requests={},this._incomingRequests={}}async getDefaultKeyId(){const e=await this._baseApis.getAccountDataFromServer("m.secret_storage.default_key");return e?e.key:null}setDefaultKeyId(e){return new Promise(async(t,r)=>{const n=r=>{"m.secret_storage.default_key"===r.getType()&&r.getContent().key===e&&(this._baseApis.removeListener("accountData",n),t())};this._baseApis.on("accountData",n);try{await this._baseApis.setAccountData("m.secret_storage.default_key",{key:e})}catch(e){this._baseApis.removeListener("accountData",n),r(e)}})}async addKey(e,t,r){const n={algorithm:e};if(t||(t={}),t.name&&(n.name=t.name),"m.secret_storage.v1.aes-hmac-sha2"!==e)throw new Error("Unknown key algorithm "+t.algorithm);if(t.passphrase&&(n.passphrase=t.passphrase),t.key){const{iv:e,mac:r}=await u._calculateKeyCheck(t.key);n.iv=e,n.mac=r}if(!r)do{r=(0,a.randomString)(32)}while(await this._baseApis.getAccountDataFromServer("m.secret_storage.key."+r));return await this._baseApis.setAccountData("m.secret_storage.key."+r,n),r}async getKey(e){if(e||(e=await this.getDefaultKeyId()),!e)return null;const t=await this._baseApis.getAccountDataFromServer("m.secret_storage.key."+e);return t?[e,t]:null}async hasKey(e){return!!await this.getKey(e)}async checkKey(e,t){if("m.secret_storage.v1.aes-hmac-sha2"===t.algorithm){if(t.mac){const{mac:r}=await u._calculateKeyCheck(e,t.iv);return t.mac.replace(/=+$/g,"")===r.replace(/=+$/g,"")}return!0}throw new Error("Unknown algorithm")}static async _calculateKeyCheck(e,t){return await(0,c.encryptAES)("\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0",e,"",t)}async store(e,t,r){const n={};if(!r){const e=await this.getDefaultKeyId();if(!e)throw new Error("No keys specified and no default key present");r=[e]}if(0===r.length)throw new Error("Zero keys given to encrypt with!");for(const o of r){const r=await this._baseApis.getAccountDataFromServer("m.secret_storage.key."+o);if(!r)throw new Error("Unknown key: "+o);if("m.secret_storage.v1.aes-hmac-sha2"===r.algorithm){const i={[o]:r},[,s]=await this._getSecretStorageKey(i,e);n[o]=await s.encrypt(t)}else i.logger.warn("unknown algorithm for secret storage key "+o+": "+r.algorithm)}await this._baseApis.setAccountData(e,{encrypted:n})}async _fixupStoredSecret(e,t){const r=Object.keys(t);if(1===r.length&&"encrypted"!==r[0]&&t[r[0]].passthrough){if(await this.hasKey(r[0])){console.log("Fixing up passthrough secret: "+e),await this.storePassthrough(e,r[0]);return await this._baseApis.getAccountDataFromServer(e)}}return null}async get(e){let t=await this._baseApis.getAccountDataFromServer(e);if(!t)return;if(!t.encrypted&&(t=await this._fixupStoredSecret(e,t),!t||!t.encrypted))throw new Error("Content is not encrypted!");const r={};for(const e of Object.keys(t.encrypted)){const n=await this._baseApis.getAccountDataFromServer("m.secret_storage.key."+e),o=t.encrypted[e];"m.secret_storage.v1.aes-hmac-sha2"===n.algorithm&&o.iv&&o.ciphertext&&o.mac&&(r[e]=n)}if(0===Object.keys(r).length)throw new Error(`Could not decrypt ${e} because none of the keys it is encrypted with are for a supported algorithm`);let n,o;try{[n,o]=await this._getSecretStorageKey(r,e);const i=t.encrypted[n];return i.passthrough?(0,s.encodeBase64)(o.get_private_key()):await o.decrypt(i)}finally{o&&o.free&&o.free()}}async isStored(e,t){let r=await this._baseApis.getAccountDataFromServer(e);if(!r)return null;if(!r.encrypted&&(r=await this._fixupStoredSecret(e,r),!r||!r.encrypted))return null;void 0===t&&(t=!0);const n={};for(const e of Object.keys(r.encrypted)){const t=await this._baseApis.getAccountDataFromServer("m.secret_storage.key."+e);if(!t)continue;const o=r.encrypted[e];"m.secret_storage.v1.aes-hmac-sha2"===t.algorithm&&o.iv&&o.ciphertext&&o.mac&&(n[e]=t)}return Object.keys(n).length?n:null}request(e,t){const r=this._baseApis.makeTxnId(),n=this._requests[r]={devices:t},o=new Promise((e,t)=>{n.resolve=e,n.reject=t}),s={name:e,action:"request",requesting_device_id:this._baseApis.deviceId,request_id:r},a={};for(const e of t)a[e]=s;return i.logger.info(`Request secret ${e} from ${t}, id ${r}`),this._baseApis.sendToDevice("m.secret.request",{[this._baseApis.getUserId()]:a}),{request_id:r,promise:o,cancel:e=>{const o={action:"request_cancellation",requesting_device_id:this._baseApis.deviceId,request_id:r},i={};for(const e of t)i[e]=o;this._baseApis.sendToDevice("m.secret.request",{[this._baseApis.getUserId()]:i}),n.reject(new Error(e||"Cancelled"))}}}async _onRequestReceived(e){const t=e.getSender(),r=e.getContent();if(t!==this._baseApis.getUserId()||!(r.name&&r.action&&r.requesting_device_id&&r.request_id))return;const n=r.requesting_device_id;if("request_cancellation"===r.action)this._incomingRequests[n]&&this._incomingRequests[n][r.request_id]&&(i.logger.info("received request cancellation for secret ("+t+", "+n+", "+r.request_id+")"),this.baseApis.emit("crypto.secrets.requestCancelled",{user_id:t,device_id:n,request_id:r.request_id}));else if("request"===r.action){if(n===this._baseApis.deviceId)return;if(i.logger.info("received request for secret ("+t+", "+n+", "+r.request_id+")"),!this._cryptoCallbacks.onSecretRequested)return;const e=await this._cryptoCallbacks.onSecretRequested({user_id:t,device_id:n,request_id:r.request_id,name:r.name,device_trust:this._baseApis.checkDeviceTrust(t,n)});if(e){i.logger.info(`Preparing ${r.name} secret for ${n}`);const o={type:"m.secret.send",content:{request_id:r.request_id,secret:e}},a={algorithm:s.OLM_ALGORITHM,sender_key:this._baseApis._crypto._olmDevice.deviceCurve25519Key,ciphertext:{}};await s.ensureOlmSessionsForDevices(this._baseApis._crypto._olmDevice,this._baseApis,{[t]:[this._baseApis.getStoredDevice(t,n)]}),await s.encryptMessageForDevice(a.ciphertext,this._baseApis.getUserId(),this._baseApis.deviceId,this._baseApis._crypto._olmDevice,t,this._baseApis.getStoredDevice(t,n),o);const c={[t]:{[n]:a}};i.logger.info(`Sending ${r.name} secret for ${n}`),this._baseApis.sendToDevice("m.room.encrypted",c)}else i.logger.info(`Request denied for ${r.name} secret for ${n}`)}}_onSecretReceived(e){if(e.getSender()!==this._baseApis.getUserId())return;const t=e.getContent();i.logger.log("got secret share for request",t.request_id);const r=this._requests[t.request_id];if(r){const n=this._baseApis._crypto._deviceList.getDeviceByIdentityKey(s.OLM_ALGORITHM,e.getSenderKey());if(!n)return void i.logger.log("secret share from unknown device with key",e.getSenderKey());if(!r.devices.includes(n.deviceId))return void i.logger.log("unsolicited secret share from device",n.deviceId);r.resolve(t.secret)}}async _getSecretStorageKey(e,t){if(!this._cryptoCallbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");const r=await this._cryptoCallbacks.getSecretStorageKey({keys:e},t);if(!r)throw new Error("getSecretStorageKey callback returned falsey");if(r.length<2)throw new Error("getSecretStorageKey callback returned invalid data");const[n,o]=r;if(!e[n])throw new Error("App returned unknown key from getSecretStorageKey!");if("m.secret_storage.v1.aes-hmac-sha2"===e[n].algorithm){return[n,{encrypt:async function(e){return await(0,c.encryptAES)(e,o,t)},decrypt:async function(e){return await(0,c.decryptAES)(e,o,t)}}]}throw new Error("Unknown key type: "+e[n].algorithm)}}t.SecretStorage=u},function(e,t,r){"use strict";(function(e){var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.OutgoingRoomKeyRequestManager=t.ROOM_KEY_REQUEST_STATES=void 0;var o=r(3),i=n(r(6));const s={UNSENT:0,SENT:1,CANCELLATION_PENDING:2,CANCELLATION_PENDING_AND_WILL_RESEND:3};t.ROOM_KEY_REQUEST_STATES=s;function a(e){return e.room_id+" / "+e.session_id}function c(e){return"["+i.map(e,e=>`${e.userId}:${e.deviceId}`).join(",")+"]"}t.OutgoingRoomKeyRequestManager=class{constructor(e,t,r){this._baseApis=e,this._deviceId=t,this._cryptoStore=r,this._sendOutgoingRoomKeyRequestsTimer=null,this._sendOutgoingRoomKeyRequestsRunning=!1,this._clientRunning=!1}start(){this._clientRunning=!0}stop(){o.logger.log("stopping OutgoingRoomKeyRequestManager"),this._clientRunning=!1}sendQueuedRequests(){this._startTimer()}async queueRoomKeyRequest(e,t,r=!1){const n=await this._cryptoStore.getOutgoingRoomKeyRequest(e);if(n)switch(n.state){case s.CANCELLATION_PENDING_AND_WILL_RESEND:case s.UNSENT:return;case s.CANCELLATION_PENDING:{const e=r?s.CANCELLATION_PENDING_AND_WILL_RESEND:s.SENT;await this._cryptoStore.updateOutgoingRoomKeyRequest(n.requestId,s.CANCELLATION_PENDING,{state:e,cancellationTxnId:this._baseApis.makeTxnId()});break}case s.SENT:if(r){const i=s.CANCELLATION_PENDING_AND_WILL_RESEND,a=await this._cryptoStore.updateOutgoingRoomKeyRequest(n.requestId,s.SENT,{state:i,cancellationTxnId:this._baseApis.makeTxnId(),requestTxnId:this._baseApis.makeTxnId()});if(!a)return await this.queueRoomKeyRequest(e,t,r);try{await this._sendOutgoingRoomKeyRequestCancellation(a,!0)}catch(e){o.logger.error("Error sending room key request cancellation; will retry later.",e)}}break;default:throw new Error("unhandled state: "+n.state)}else await this._cryptoStore.getOrAddOutgoingRoomKeyRequest({requestBody:e,recipients:t,requestId:this._baseApis.makeTxnId(),state:s.UNSENT})}cancelRoomKeyRequest(e){return this._cryptoStore.getOutgoingRoomKeyRequest(e).then(t=>{if(t)switch(t.state){case s.CANCELLATION_PENDING:case s.CANCELLATION_PENDING_AND_WILL_RESEND:return;case s.UNSENT:return o.logger.log("deleting unnecessary room key request for "+a(e)),this._cryptoStore.deleteOutgoingRoomKeyRequest(t.requestId,s.UNSENT);case s.SENT:return this._cryptoStore.updateOutgoingRoomKeyRequest(t.requestId,s.SENT,{state:s.CANCELLATION_PENDING,cancellationTxnId:this._baseApis.makeTxnId()}).then(t=>{t?this._sendOutgoingRoomKeyRequestCancellation(t).catch(e=>{o.logger.error("Error sending room key request cancellation; will retry later.",e),this._startTimer()}):o.logger.log("Tried to cancel room key request for "+a(e)+" but it was already cancelled in another tab")});default:throw new Error("unhandled state: "+t.state)}})}getOutgoingSentRoomKeyRequest(e,t){return this._cryptoStore.getOutgoingRoomKeyRequestsByTarget(e,t,[s.SENT])}async cancelAndResendAllOutgoingRequests(){const e=await this._cryptoStore.getAllOutgoingRoomKeyRequestsByState(s.SENT);return Promise.all(e.map(({requestBody:e,recipients:t})=>this.queueRoomKeyRequest(e,t,!0)))}_startTimer(){if(this._sendOutgoingRoomKeyRequestsTimer)return;this._sendOutgoingRoomKeyRequestsTimer=e.setTimeout(()=>{if(this._sendOutgoingRoomKeyRequestsRunning)throw new Error("RoomKeyRequestSend already in progress!");this._sendOutgoingRoomKeyRequestsRunning=!0,this._sendOutgoingRoomKeyRequests().finally(()=>{this._sendOutgoingRoomKeyRequestsRunning=!1}).catch(e=>{o.logger.warn("error in OutgoingRoomKeyRequestManager: "+e)})},500)}_sendOutgoingRoomKeyRequests(){return this._clientRunning?this._cryptoStore.getOutgoingRoomKeyRequestByState([s.CANCELLATION_PENDING,s.CANCELLATION_PENDING_AND_WILL_RESEND,s.UNSENT]).then(e=>{if(!e)return void(this._sendOutgoingRoomKeyRequestsTimer=null);let t;switch(e.state){case s.UNSENT:t=this._sendOutgoingRoomKeyRequest(e);break;case s.CANCELLATION_PENDING:t=this._sendOutgoingRoomKeyRequestCancellation(e);break;case s.CANCELLATION_PENDING_AND_WILL_RESEND:t=this._sendOutgoingRoomKeyRequestCancellation(e,!0)}return t.then(()=>this._sendOutgoingRoomKeyRequests()).catch(e=>{o.logger.error("Error sending room key request; will retry later.",e),this._sendOutgoingRoomKeyRequestsTimer=null})}):(this._sendOutgoingRoomKeyRequestsTimer=null,Promise.resolve())}_sendOutgoingRoomKeyRequest(e){o.logger.log("Requesting keys for "+a(e.requestBody)+" from "+c(e.recipients)+`(id ${e.requestId})`);const t={action:"request",requesting_device_id:this._deviceId,request_id:e.requestId,body:e.requestBody};return this._sendMessageToDevices(t,e.recipients,e.requestTxnId||e.requestId).then(()=>this._cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,s.UNSENT,{state:s.SENT}))}_sendOutgoingRoomKeyRequestCancellation(e,t){o.logger.log("Sending cancellation for key request for "+a(e.requestBody)+" to "+c(e.recipients)+" "+`(cancellation id ${e.cancellationTxnId})`);const r={action:"request_cancellation",requesting_device_id:this._deviceId,request_id:e.requestId};return this._sendMessageToDevices(r,e.recipients,e.cancellationTxnId).then(()=>t?this._cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,s.CANCELLATION_PENDING_AND_WILL_RESEND,{state:s.UNSENT}):this._cryptoStore.deleteOutgoingRoomKeyRequest(e.requestId,s.CANCELLATION_PENDING))}_sendMessageToDevices(e,t,r){const n={};for(const r of t)n[r.userId]||(n[r.userId]={}),n[r.userId][r.deviceId]=e;return this._baseApis.sendToDevice("m.room_key_request",n,r)}}}).call(this,r(8))},function(e,t,r){"use strict";(function(e){var n=r(14);Object.defineProperty(t,"__esModule",{value:!0}),t.SAS=void 0;var o=r(44),i=n(r(41)),s=r(28),a=r(3);const c="m.key.verification.start",u=["m.key.verification.accept","m.key.verification.key","m.key.verification.mac"];let l;const d=(0,s.errorFactory)("m.mismatched_sas","Mismatched short authentication string"),h=(0,s.errorFactory)("m.mismatched_commitment","Mismatched commitment");const p=[["","dog"],["","cat"],["","lion"],["","horse"],["","unicorn"],["","pig"],["","elephant"],["","rabbit"],["","panda"],["","rooster"],["","penguin"],["","turtle"],["","fish"],["","octopus"],["","butterfly"],["","flower"],["","tree"],["","cactus"],["","mushroom"],["","globe"],["","moon"],["","cloud"],["","fire"],["","banana"],["","apple"],["","strawberry"],["","corn"],["","pizza"],["","cake"],["","heart"],["","smiley"],["","robot"],["","hat"],["","glasses"],["","spanner"],["","santa"],["","thumbs up"],["","umbrella"],["","hourglass"],["","clock"],["","gift"],["","light bulb"],["","book"],["","pencil"],["","paperclip"],["","scissors"],["","lock"],["","key"],["","hammer"],["","telephone"],["","flag"],["","train"],["","bicycle"],["","aeroplane"],["","rocket"],["","trophy"],["","ball"],["","guitar"],["","trumpet"],["","bell"],["","anchor"],["","headphones"],["","folder"],["","pin"]];const f={decimal:function(e){return[1e3+(e[0]<<5|e[1]>>3),1e3+((7&e[1])<<10|e[2]<<2|e[3]>>6),1e3+((63&e[3])<<7|e[4]>>1)]},emoji:function(e){return[e[0]>>2,(3&e[0])<<4|e[1]>>4,(15&e[1])<<2|e[2]>>6,63&e[2],e[3]>>2,(3&e[3])<<4|e[4]>>4,(15&e[4])<<2|e[5]>>6].map(e=>p[e])}};function m(e,t){const r={};for(const n of t)n in f&&(r[n]=f[n](e));return r}const g={"hkdf-hmac-sha256":"calculate_mac","hmac-sha256":"calculate_mac_long_kdf"};function v(e,t){return function(...r){const n=e[g[t]].apply(e,r);return a.logger.log("SAS calculateMAC:",t,r,n),n}}const y={"curve25519-hkdf-sha256":function(e,t,r){const n=`${e._baseApis.getUserId()}|${e._baseApis.deviceId}|`+e.ourSASPubKey+"|",o=`${e.userId}|${e.deviceId}|${e.theirSASPubKey}|`,i="MATRIX_KEY_VERIFICATION_SAS|"+(e.initiatedByMe?n+o:o+n)+e._channel.transactionId;return t.generate_bytes(i,r)},curve25519:function(e,t,r){const n=`${e._baseApis.getUserId()}${e._baseApis.deviceId}`,o=`${e.userId}${e.deviceId}`,i="MATRIX_KEY_VERIFICATION_SAS"+(e.initiatedByMe?n+o:o+n)+e._channel.transactionId;return t.generate_bytes(i,r)}},_=["curve25519-hkdf-sha256","curve25519"],b=["sha256"],E=["hkdf-hmac-sha256","hmac-sha256"],S=Object.keys(f),w=new Set(_),R=new Set(b),I=new Set(E),k=new Set(S);function P(e,t){return e instanceof Array?e.filter(e=>t.has(e)):[]}class T extends o.VerificationBase{static get NAME(){return"m.sas.v1"}get events(){return u}async _doVerification(){await e.Olm.init(),l=l||new e.Olm.Utility,await this._baseApis.downloadKeys([this.userId]);let t=!1;do{try{return this.initiatedByMe?await this._doSendVerification():await this._doRespondVerification()}catch(e){if(!(e instanceof o.SwitchStartEventError))throw e;this.startEvent=e.startEvent,t=!0}}while(t)}canSwitchStartEvent(e){if(e.getType()!==c)return!1;const t=e.getContent();return t&&t.method===T.NAME&&this._waitingForAccept}async _sendStart(){const e=this._channel.completeContent(c,{method:T.NAME,from_device:this._baseApis.deviceId,key_agreement_protocols:_,hashes:b,message_authentication_codes:E,short_authentication_string:S});return await this._channel.sendCompleted(c,e),e}async _doSendVerification(){let t,r;if(this._waitingForAccept=!0,t=this.startEvent?this._channel.completedContentFromEvent(this.startEvent):await this._sendStart(),!this.initiatedByMe)throw new o.SwitchStartEventError(this.startEvent);try{r=await this._waitForEvent("m.key.verification.accept")}finally{this._waitingForAccept=!1}let n=r.getContent();const a=P(n.short_authentication_string,k);if(!(w.has(n.key_agreement_protocol)&&R.has(n.hash)&&I.has(n.message_authentication_code)&&a.length))throw(0,s.newUnknownMethodError)();if("string"!=typeof n.commitment)throw(0,s.newInvalidMessageError)();const c=n.key_agreement_protocol,u=n.message_authentication_code,p=n.commitment,f=new e.Olm.SAS;try{this.ourSASPubKey=f.get_pubkey(),await this._send("m.key.verification.key",{key:this.ourSASPubKey}),r=await this._waitForEvent("m.key.verification.key"),n=r.getContent();const e=n.key+i.default.stringify(t);if(l.sha256(e)!==p)throw h();this.theirSASPubKey=n.key,f.set_their_key(n.key);const o=y[c](this,f,6),g=new Promise((e,t)=>{this.sasEvent={sas:m(o,a),confirm:async()=>{try{await this._sendMAC(f,u),e()}catch(e){t(e)}},cancel:()=>t((0,s.newUserCancelledError)()),mismatch:()=>t(d())},this.emit("show_sas",this.sasEvent)});[r]=await Promise.all([this._waitForEvent("m.key.verification.mac").then(e=>(this._expectedEvent="m.key.verification.done",e)),g]),n=r.getContent(),await this._checkMAC(f,n,u)}finally{f.free()}}async _doRespondVerification(){let t=this._channel.completedContentFromEvent(this.startEvent);const r=P(_,new Set(t.key_agreement_protocols))[0],n=P(b,new Set(t.hashes))[0],o=P(E,new Set(t.message_authentication_codes))[0],a=P(t.short_authentication_string,k);if(void 0===r||void 0===n||void 0===o||!a.length)throw(0,s.newUnknownMethodError)();const c=new e.Olm.SAS;try{const e=c.get_pubkey()+i.default.stringify(t);await this._send("m.key.verification.accept",{key_agreement_protocol:r,hash:n,message_authentication_code:o,short_authentication_string:a,commitment:l.sha256(e)});let u=await this._waitForEvent("m.key.verification.key");t=u.getContent(),this.theirSASPubKey=t.key,c.set_their_key(t.key),this.ourSASPubKey=c.get_pubkey(),await this._send("m.key.verification.key",{key:this.ourSASPubKey});const h=y[r](this,c,6),p=new Promise((e,t)=>{this.sasEvent={sas:m(h,a),confirm:async()=>{try{await this._sendMAC(c,o),e()}catch(e){t(e)}},cancel:()=>t((0,s.newUserCancelledError)()),mismatch:()=>t(d())},this.emit("show_sas",this.sasEvent)});[u]=await Promise.all([this._waitForEvent("m.key.verification.mac").then(e=>(this._expectedEvent="m.key.verification.done",e)),p]),t=u.getContent(),await this._checkMAC(c,t,o)}finally{c.free()}}_sendMAC(e,t){const r={},n=[],o="MATRIX_KEY_VERIFICATION_MAC"+this._baseApis.getUserId()+this._baseApis.deviceId+this.userId+this.deviceId+this._channel.transactionId,i="ed25519:"+this._baseApis.deviceId;r[i]=v(e,t)(this._baseApis.getDeviceEd25519Key(),o+i),n.push(i);const s=this._baseApis.getCrossSigningId();if(s){const i="ed25519:"+s;r[i]=v(e,t)(s,o+i),n.push(i)}const a=v(e,t)(n.sort().join(","),o+"KEY_IDS");return this._send("m.key.verification.mac",{mac:r,keys:a})}async _checkMAC(e,t,r){const n="MATRIX_KEY_VERIFICATION_MAC"+this.userId+this.deviceId+this._baseApis.getUserId()+this._baseApis.deviceId+this._channel.transactionId;if(t.keys!==v(e,r)(Object.keys(t.mac).sort().join(","),n+"KEY_IDS"))throw(0,s.newKeyMismatchError)();await this._verifyKeys(this.userId,t.mac,(t,o,i)=>{if(i!==v(e,r)(o.keys[t],n+t))throw(0,s.newKeyMismatchError)()})}}t.SAS=T}).call(this,r(8))},function(e,t,r){var n=r(125);e.exports=n("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz")},function(e,t,r){"use strict";var n=r(126).Buffer;e.exports=function(e){if(e.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),r=0;r<t.length;r++)t[r]=255;for(var o=0;o<e.length;o++){var i=e.charAt(o),s=i.charCodeAt(0);if(255!==t[s])throw new TypeError(i+" is ambiguous");t[s]=o}var a=e.length,c=e.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(e){if("string"!=typeof e)throw new TypeError("Expected String");if(0===e.length)return n.alloc(0);var r=0;if(" "!==e[r]){for(var o=0,i=0;e[r]===c;)o++,r++;for(var s=(e.length-r)*u+1>>>0,l=new Uint8Array(s);e[r];){var d=t[e.charCodeAt(r)];if(255===d)return;for(var h=0,p=s-1;(0!==d||h<i)&&-1!==p;p--,h++)d+=a*l[p]>>>0,l[p]=d%256>>>0,d=d/256>>>0;if(0!==d)throw new Error("Non-zero carry");i=h,r++}if(" "!==e[r]){for(var f=s-i;f!==s&&0===l[f];)f++;var m=n.allocUnsafe(o+(s-f));m.fill(0,0,o);for(var g=o;f!==s;)m[g++]=l[f++];return m}}}return{encode:function(t){if((Array.isArray(t)||t instanceof Uint8Array)&&(t=n.from(t)),!n.isBuffer(t))throw new TypeError("Expected Buffer");if(0===t.length)return"";for(var r=0,o=0,i=0,s=t.length;i!==s&&0===t[i];)i++,r++;for(var u=(s-i)*l+1>>>0,d=new Uint8Array(u);i!==s;){for(var h=t[i],p=0,f=u-1;(0!==h||p<o)&&-1!==f;f--,p++)h+=256*d[f]>>>0,d[f]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");o=p,i++}for(var m=u-o;m!==u&&0===d[m];)m++;for(var g=c.repeat(r);m<u;++m)g+=e.charAt(d[m]);return g},decodeUnsafe:d,decode:function(e){var t=d(e);if(t)return t;throw new Error("Non-base"+a+" character")}}}},function(e,t,r){
/*! safe-buffer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */
var n=r(22),o=n.Buffer;function i(e,t){for(var r in e)t[r]=e[r]}function s(e,t,r){return o(e,t,r)}o.from&&o.alloc&&o.allocUnsafe&&o.allocUnsafeSlow?e.exports=n:(i(n,t),t.Buffer=s),s.prototype=Object.create(o.prototype),i(o,s),s.from=function(e,t,r){if("number"==typeof e)throw new TypeError("Argument must not be a number");return o(e,t,r)},s.alloc=function(e,t,r){if("number"!=typeof e)throw new TypeError("Argument must be a number");var n=o(e);return void 0!==t?"string"==typeof r?n.fill(t,r):n.fill(t):n.fill(0),n},s.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return o(e)},s.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return n.SlowBuffer(e)}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InRoomRequests=t.InRoomChannel=void 0;var n=r(45),o=r(3);class i{constructor(e,t,r=null){this._client=e,this._roomId=t,this.userId=r,this._requestEventId=null}get receiveStartFromOtherDevices(){return!0}get roomId(){return this._roomId}get transactionId(){return this._requestEventId}static getOtherPartyUserId(e,t){if(i.getEventType(e)!==n.REQUEST_TYPE)return;const r=t.getUserId(),o=e.getSender(),s=e.getContent().to;return o===r?s:s===r?o:void 0}getTimestamp(e){return e.getTs()}static canCreateRequest(e){return e===n.REQUEST_TYPE}static getTransactionId(e){if(i.getEventType(e)===n.REQUEST_TYPE)return e.getId();{const t=e.getRelation();if(t&&"m.reference"===t.rel_type)return t.event_id}}static validateEvent(e,t){const r=i.getTransactionId(e);if("string"!=typeof r||0===r.length)return!1;const s=i.getEventType(e),a=e.getContent();if(s===n.REQUEST_TYPE){if(!a||"string"!=typeof a.to||!a.to.length)return o.logger.log("InRoomChannel: validateEvent: no valid to "+(a&&a.to)),!1;if(!i.getOtherPartyUserId(e,t))return o.logger.log("InRoomChannel: validateEvent: not directed to or sent by me: "+e.getSender()+", "+(a&&a.to)),!1}return n.VerificationRequest.validateEvent(s,e,t)}static getEventType(e){const t=e.getType();if("m.room.message"===t){const t=e.getContent();if(t){const{msgtype:e}=t;if(e===n.REQUEST_TYPE)return n.REQUEST_TYPE}}return t&&t!==n.REQUEST_TYPE?t:""}async handleEvent(e,t,r){if(t.hasEventId(e.getId()))return;const n=i.getEventType(e);if(e.getRoomId()!==this._roomId)return;if(null===this.userId){const t=i.getOtherPartyUserId(e,this._client);t&&(this.userId=t)}const s=this._client.getUserId(),a=e.getSender();if(null!==this.userId&&a!==s&&a!==this.userId)return void o.logger.log("InRoomChannel: ignoring verification event from non-participating sender "+a);null===this._requestEventId&&(this._requestEventId=i.getTransactionId(e));const c=!!e.getUnsigned().transaction_id,u=e.getSender()===this._client.getUserId();return await t.handleEvent(n,e,r,c,u)}completedContentFromEvent(e){const t=Object.assign({},e.getContent());return t["m.relates_to"]=e.getRelation(),t}completeContent(e,t){return t=Object.assign({},t),e!==n.REQUEST_TYPE&&e!==n.READY_TYPE&&e!==n.START_TYPE||(t.from_device=this._client.getDeviceId()),e===n.REQUEST_TYPE?t={body:this._client.getUserId()+" is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.",msgtype:n.REQUEST_TYPE,to:this.userId,from_device:t.from_device,methods:t.methods}:t["m.relates_to"]={rel_type:"m.reference",event_id:this.transactionId},t}send(e,t){const r=this.completeContent(e,t);return this.sendCompleted(e,r)}async sendCompleted(e,t){let r=e;e===n.REQUEST_TYPE&&(r="m.room.message");const o=await this._client.sendEvent(this._roomId,r,t);e===n.REQUEST_TYPE&&(this._requestEventId=o.event_id)}}t.InRoomChannel=i;t.InRoomRequests=class{constructor(){this._requestsByRoomId=new Map}getRequest(e){const t=e.getRoomId(),r=i.getTransactionId(e);return this._getRequestByTxnId(t,r)}getRequestByChannel(e){return this._getRequestByTxnId(e.roomId,e.transactionId)}_getRequestByTxnId(e,t){const r=this._requestsByRoomId.get(e);if(r)return r.get(t)}setRequest(e,t){this._setRequest(e.getRoomId(),i.getTransactionId(e),t)}setRequestByChannel(e,t){this._setRequest(e.roomId,e.transactionId,t)}_setRequest(e,t,r){let n=this._requestsByRoomId.get(e);n||(n=new Map,this._requestsByRoomId.set(e,n)),n.set(t,r)}removeRequest(e){const t=e.getRoomId(),r=this._requestsByRoomId.get(t);r&&(r.delete(i.getTransactionId(e)),0===r.size&&this._requestsByRoomId.delete(t))}findRequestInProgress(e){const t=this._requestsByRoomId.get(e);if(t)for(const e of t.values())if(e.pending)return e}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ToDeviceRequests=t.ToDeviceChannel=void 0;var n=r(34),o=r(3),i=r(45),s=r(28),a=r(18);class c{constructor(e,t,r,n=null,o=null){this._client=e,this.userId=t,this._devices=r,this.transactionId=n,this._deviceId=o}isToDevices(e){if(e.length===this._devices.length){for(const t of e){if(!this._devices.find(e=>e.deviceId===t.deviceId))return!1}return!0}return!1}get deviceId(){return this._deviceId}static getEventType(e){return e.getType()}static getTransactionId(e){const t=e.getContent();return t&&t.transaction_id}static canCreateRequest(e){return e===i.REQUEST_TYPE||e===i.START_TYPE}static validateEvent(e,t){if(e.isCancelled())return o.logger.warn("Ignoring flagged verification request from "+e.getSender()),!1;const r=e.getContent();if(!r)return o.logger.warn("ToDeviceChannel.validateEvent: invalid: no content"),!1;if(!r.transaction_id)return o.logger.warn("ToDeviceChannel.validateEvent: invalid: no transaction_id"),!1;const n=e.getType();if(n===i.REQUEST_TYPE){if(!Number.isFinite(r.timestamp))return o.logger.warn("ToDeviceChannel.validateEvent: invalid: no timestamp"),!1;if(e.getSender()===t.getUserId()&&r.from_device==t.getDeviceId())return o.logger.warn("ToDeviceChannel.validateEvent: invalid: from own device"),!1}return i.VerificationRequest.validateEvent(n,e,t)}getTimestamp(e){const t=e.getContent();return t&&t.timestamp}async handleEvent(e,t,r){const n=e.getType(),o=e.getContent();if(n===i.REQUEST_TYPE||n===i.READY_TYPE||n===i.START_TYPE){this.transactionId||(this.transactionId=o.transaction_id);const e=o.from_device;if(!this._deviceId&&this._devices.includes(e)&&(this._deviceId=e),!this._deviceId||this._deviceId!==e){const t=this.completeContent((0,s.errorFromEvent)((0,s.newUnexpectedMessageError)()));return this._sendToDevices(i.CANCEL_TYPE,t,[e])}}const a=t.phase===i.PHASE_STARTED||t.phase===i.PHASE_READY;await t.handleEvent(e.getType(),e,r,!1,!1);const c=t.phase===i.PHASE_STARTED||t.phase===i.PHASE_READY;if((n===i.START_TYPE||n===i.READY_TYPE)&&!a&&c&&this._deviceId){const e=this._devices.filter(e=>e!==this._deviceId);if(e.length){const t=this.completeContent({code:"m.accepted",reason:"Verification request accepted by another device"});await this._sendToDevices(i.CANCEL_TYPE,t,e)}}}completedContentFromEvent(e){return e.getContent()}completeContent(e,t){return t=Object.assign({},t),this.transactionId&&(t.transaction_id=this.transactionId),e!==i.REQUEST_TYPE&&e!==i.READY_TYPE&&e!==i.START_TYPE||(t.from_device=this._client.getDeviceId()),e===i.REQUEST_TYPE&&(t.timestamp=Date.now()),t}send(e,t={}){e!==i.REQUEST_TYPE&&e!==i.START_TYPE||this.transactionId||(this.transactionId=c.makeTransactionId());const r=this.completeContent(e,t);return this.sendCompleted(e,r)}async sendCompleted(e,t){let r;r=e===i.REQUEST_TYPE?await this._sendToDevices(e,t,this._devices):await this._sendToDevices(e,t,[this._deviceId]);const n=new a.MatrixEvent({sender:this._client.getUserId(),content:t,type:e});return await this._request.handleEvent(e,n,!0,!0,!0),r}_sendToDevices(e,t,r){if(r.length){const n={};for(const e of r)n[e]=t;return this._client.sendToDevice(e,{[this.userId]:n})}return Promise.resolve()}static makeTransactionId(){return(0,n.randomString)(32)}}t.ToDeviceChannel=c;t.ToDeviceRequests=class{constructor(){this._requestsByUserId=new Map}getRequest(e){return this.getRequestBySenderAndTxnId(e.getSender(),c.getTransactionId(e))}getRequestByChannel(e){return this.getRequestBySenderAndTxnId(e.userId,e.transactionId)}getRequestBySenderAndTxnId(e,t){const r=this._requestsByUserId.get(e);if(r)return r.get(t)}setRequest(e,t){this.setRequestBySenderAndTxnId(e.getSender(),c.getTransactionId(e),t)}setRequestByChannel(e,t){this.setRequestBySenderAndTxnId(e.userId,e.transactionId,t)}setRequestBySenderAndTxnId(e,t,r){let n=this._requestsByUserId.get(e);n||(n=new Map,this._requestsByUserId.set(e,n)),n.set(t,r)}removeRequest(e){const t=e.getSender(),r=this._requestsByUserId.get(t);r&&(r.delete(c.getTransactionId(e)),0===r.size&&this._requestsByUserId.delete(t))}findRequestInProgress(e,t){const r=this._requestsByUserId.get(e);if(r)for(const e of r.values())if(e.pending&&e.channel.isToDevices(t))return e}getRequestsInProgress(e){const t=this._requestsByUserId.get(e);return t?Array.from(t.values()).filter(e=>e.pending):[]}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IllegalMethod=void 0;var n=r(44);class o extends n.VerificationBase{static factory(...e){return new o(...e)}static get NAME(){return"org.matrix.illegal_method"}async _doVerification(){throw new Error("Verification is not possible with this method")}}t.IllegalMethod=o},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TimelineWindow=i,t.TimelineIndex=s;var n=r(24);r(3);const o=function(){};function i(e,t,r){r=r||{},this._client=e,this._timelineSet=t,this._start=null,this._end=null,this._eventCount=0,this._windowLimit=r.windowLimit||1e3}function s(e,t){this.timeline=e,this.index=t}i.prototype.load=function(e,t){const r=this;t=t||20;const n=function(n){let o;const i=n.getEvents();if(e){for(let t=0;t<i.length;t++)if(i[t].getId()==e){o=t;break}if(void 0===o)throw new Error("getEventTimeline result didn't include requested event")}else o=i.length;const a=Math.min(i.length,o+Math.ceil(t/2)),c=Math.max(0,a-t);r._start=new s(n,c-n.getBaseIndex()),r._end=new s(n,a-n.getBaseIndex()),r._eventCount=a-c};if(e){const t=this._timelineSet.getTimelineForEvent(e);if(t)return n(t),Promise.resolve(t);return this._client.getEventTimeline(this._timelineSet,e).then(n)}return n(this._timelineSet.getLiveTimeline()),Promise.resolve()},i.prototype.getTimelineIndex=function(e){if(e==n.EventTimeline.BACKWARDS)return this._start;if(e==n.EventTimeline.FORWARDS)return this._end;throw new Error("Invalid direction '"+e+"'")},i.prototype.extend=function(e,t){const r=this.getTimelineIndex(e);if(!r)return o("TimelineWindow: no timeline yet"),!1;const i=e==n.EventTimeline.BACKWARDS?r.retreat(t):r.advance(t);if(i){this._eventCount+=i,o("TimelineWindow: increased cap by "+i+" (now "+this._eventCount+")");const t=this._eventCount-this._windowLimit;return t>0&&this.unpaginate(t,e!=n.EventTimeline.BACKWARDS),!0}return!1},i.prototype.canPaginate=function(e){const t=this.getTimelineIndex(e);if(!t)return o("TimelineWindow: no timeline yet"),!1;if(e==n.EventTimeline.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;return Boolean(t.timeline.getNeighbouringTimeline(e)||t.timeline.getPaginationToken(e))},i.prototype.paginate=function(e,t,r,i){void 0===r&&(r=!0),void 0===i&&(i=5);const s=this.getTimelineIndex(e);if(!s)return o("TimelineWindow: no timeline yet"),Promise.resolve(!1);if(s.pendingPaginate)return s.pendingPaginate;if(this.extend(e,t))return Promise.resolve(!0);if(!r||0===i)return Promise.resolve(!1);if(!s.timeline.getPaginationToken(e))return o("TimelineWindow: no token"),Promise.resolve(!1);o("TimelineWindow: starting request");const a=this,c=this._client.paginateEventTimeline(s.timeline,{backwards:e==n.EventTimeline.BACKWARDS,limit:t}).finally((function(){s.pendingPaginate=null})).then((function(r){return o("TimelineWindow: request completed with result "+r),!!r&&a.paginate(e,t,!0,i-1)}));return s.pendingPaginate=c,c},i.prototype.unpaginate=function(e,t){const r=t?this._start:this._end;if(e>this._eventCount||e<0)throw new Error("Attemting to unpaginate "+e+" events, but only have "+this._eventCount+" in the timeline");for(;e>0;){const n=t?r.advance(e):r.retreat(e);if(n<=0)throw new Error("Unable to unpaginate any further, but still have "+this._eventCount+" events");e-=n,this._eventCount-=n,o("TimelineWindow.unpaginate: dropped "+n+" (now "+this._eventCount+")")}},i.prototype.getEvents=function(){if(!this._start)return[];const e=[];let t=this._start.timeline;for(;;){const r=t.getEvents();let o=0,i=r.length;t===this._start.timeline&&(o=this._start.index+t.getBaseIndex()),t===this._end.timeline&&(i=this._end.index+t.getBaseIndex());for(let t=o;t<i;t++)e.push(r[t]);if(t===this._end.timeline)break;t=t.getNeighbouringTimeline(n.EventTimeline.FORWARDS)}return e},s.prototype.minIndex=function(){return-1*this.timeline.getBaseIndex()},s.prototype.maxIndex=function(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()},s.prototype.advance=function(e){if(!e)return 0;let t;if(e<0){if(t=Math.max(e,this.minIndex()-this.index),t<0)return this.index+=t,t}else if(t=Math.min(e,this.maxIndex()-this.index),t>0)return this.index+=t,t;const r=this.timeline.getNeighbouringTimeline(e<0?n.EventTimeline.BACKWARDS:n.EventTimeline.FORWARDS);return r?(this.timeline=r,this.index=e<0?this.maxIndex():this.minIndex(),o("paginate: switched to new neighbour"),this.advance(e)):0},s.prototype.retreat=function(e){return-1*this.advance(-1*e)}},function(e,t,r){"use strict";var n=r(5),o=r(14);Object.defineProperty(t,"__esModule",{value:!0}),t.InteractiveAuth=c;var i=o(r(36)),s=n(r(6)),a=r(3);function c(e){this._matrixClient=e.matrixClient,this._data=e.authData||{},this._requestCallback=e.doRequest,this._busyChangedCallback=e.busyChanged,this._stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this._resolveFunc=null,this._rejectFunc=null,this._inputs=e.inputs||{},this._requestEmailTokenCallback=e.requestEmailToken,e.sessionId&&(this._data.session=e.sessionId),this._clientSecret=e.clientSecret||this._matrixClient.generateClientSecret(),this._emailSid=e.emailSid,void 0===this._emailSid&&(this._emailSid=null),this._requestingEmailToken=!1,this._chosenFlow=null,this._currentStage=null,this._submitPromise=null}c.prototype={attemptAuth:function(){return new Promise((e,t)=>{this._resolveFunc=e,this._rejectFunc=t;if(this._data&&this._data.flows)this._startNextAuthStage();else{this._busyChangedCallback&&this._busyChangedCallback(!0);let e=null;this._data.session&&(e={session:this._data.session}),this._doRequest(e).finally(()=>{this._busyChangedCallback&&this._busyChangedCallback(!1)})}})},poll:async function(){if(!this._data.session)return;if(!this._resolveFunc)return;if(this._submitPromise)return;let e={};if("m.login.email.identity"==this._currentStage&&this._emailSid){const t={sid:this._emailSid,client_secret:this._clientSecret};if(await this._matrixClient.doesServerRequireIdServerParam()){const e=i.default.parse(this._matrixClient.getIdentityServerUrl());t.id_server=e.host}e={type:"m.login.email.identity",threepid_creds:t,threepidCreds:t}}this.submitAuthDict(e,!0)},getSessionId:function(){return this._data?this._data.session:void 0},getClientSecret:function(){return this._clientSecret},getStageParams:function(e){let t={};return this._data&&this._data.params&&(t=this._data.params),t[e]},getChosenFlow(){return this._chosenFlow},submitAuthDict:async function(e,t){if(!this._resolveFunc)throw new Error("submitAuthDict() called before attemptAuth()");for(!t&&this._busyChangedCallback&&this._busyChangedCallback(!0);this._submitPromise;)try{await this._submitPromise}catch(e){}let r;this._data.session?(r={session:this._data.session},s.extend(r,e)):r=e;try{this._submitPromise=this._doRequest(r,t),await this._submitPromise}finally{this._submitPromise=null,!t&&this._busyChangedCallback&&this._busyChangedCallback(!1)}},getEmailSid:function(){return this._emailSid},setEmailSid:function(e){this._emailSid=e},_doRequest:async function(e,t){try{const r=await this._requestCallback(e,t);this._resolveFunc(r),this._resolveFunc=null,this._rejectFunc=null}catch(e){const r=e.data?e.data.flows:null,n=this._data.flows||Boolean(r);401===e.httpStatus&&e.data&&n||(t?a.logger.log("Background poll request failed doing UI auth: ignoring",e):this._rejectFunc(e)),e.data.flows||e.data.completed||e.data.session||(e.data.flows=this._data.flows,e.data.completed=this._data.completed,e.data.session=this._data.session),this._data=e.data;try{this._startNextAuthStage()}catch(e){this._rejectFunc(e),this._resolveFunc=null,this._rejectFunc=null}if(!this._emailSid&&!this._requestingEmailToken&&this._chosenFlow.stages.includes("m.login.email.identity")){this._requestingEmailToken=!0;try{const e=await this._requestEmailTokenCallback(this._inputs.emailAddress,this._clientSecret,1,this._data.session);this._emailSid=e.sid}catch(e){this._rejectFunc(e),this._resolveFunc=null,this._rejectFunc=null}finally{this._requestingEmailToken=!1}}}},_startNextAuthStage:function(){const e=this._chooseStage();if(!e)throw new Error("No incomplete flows from the server");if(this._currentStage=e,"m.login.dummy"===e)return void this.submitAuthDict({type:"m.login.dummy"});if(this._data&&this._data.errcode||this._data.error)return void this._stateUpdatedCallback(e,{errcode:this._data.errcode||"",error:this._data.error||""});const t={};"m.login.email.identity"==e&&(t.emailSid=this._emailSid),this._stateUpdatedCallback(e,t)},_chooseStage:function(){null===this._chosenFlow&&(this._chosenFlow=this._chooseFlow()),a.logger.log("Active flow => %s",JSON.stringify(this._chosenFlow));const e=this._firstUncompletedStage(this._chosenFlow);return a.logger.log("Next stage: %s",e),e},_chooseFlow:function(){const e=this._data.flows||[],t=Boolean(this._inputs.emailAddress)||Boolean(this._emailSid),r=Boolean(this._inputs.phoneCountry)&&Boolean(this._inputs.phoneNumber);for(const n of e){let e=!1,o=!1;for(const t of n.stages)"m.login.email.identity"===t?e=!0:"m.login.msisdn"==t&&(o=!0);if(e==t&&o==r)return n}const n=new Error("No appropriate authentication flow found");throw n.name="NoAuthFlowFoundError",n.required_stages=[],t&&n.required_stages.push("m.login.email.identity"),r&&n.required_stages.push("m.login.msisdn"),n.available_flows=e,n},_firstUncompletedStage:function(e){const t=(this._data||{}).completed||[];for(let r=0;r<e.stages.length;++r){const n=e.stages[r];if(-1===t.indexOf(n))return n}}}},function(e,t,r){"use strict";(function(e){var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.IndexedDBStore=h;var o=r(56),i=n(r(6)),s=r(10),a=r(133),c=r(134),u=r(27),l=r(18),d=r(3);function h(t){if(o.MemoryStore.call(this,t),!t.indexedDB)throw new Error("Missing required option: indexedDB");if(t.workerScript){let r=t.workerApi;r||(r=e.Worker),this.backend=new c.RemoteIndexedDBStoreBackend(t.workerScript,t.dbName,r)}else this.backend=new a.LocalIndexedDBStoreBackend(t.indexedDB,t.dbName);this.startedUp=!1,this._syncTs=0,this._userModifiedMap={}}function p(e,t){return async function(...r){try{return await e.call(this,...r)}catch(e){d.logger.error("IndexedDBStore failure, degrading to MemoryStore",e),this.emit("degraded",e);try{d.logger.log("IndexedDBStore trying to delete degraded data"),await this.backend.clearDatabase(),d.logger.log("IndexedDBStore delete after degrading succeeeded")}catch(e){d.logger.warn("IndexedDBStore delete after degrading failed",e)}if(Object.setPrototypeOf(this,o.MemoryStore.prototype),t)return await o.MemoryStore.prototype[t].call(this,...r)}}}i.inherits(h,o.MemoryStore),i.extend(h.prototype,s.EventEmitter.prototype),h.exists=function(e,t){return a.LocalIndexedDBStoreBackend.exists(e,t)},h.prototype.startup=function(){return this.startedUp?(d.logger.log("IndexedDBStore.startup: already started"),Promise.resolve()):(d.logger.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect().then(()=>(d.logger.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents())).then(e=>{d.logger.log("IndexedDBStore.startup: processing presence events"),e.forEach(([e,t])=>{const r=new u.User(e);t&&r.setPresenceEvent(new l.MatrixEvent(t)),this._userModifiedMap[r.userId]=r.getLastModifiedTime(),this.storeUser(r)})}))},h.prototype.getSavedSync=p((function(){return this.backend.getSavedSync()}),"getSavedSync"),h.prototype.isNewlyCreated=p((function(){return this.backend.isNewlyCreated()}),"isNewlyCreated"),h.prototype.getSavedSyncToken=p((function(){return this.backend.getNextBatchToken()}),"getSavedSyncToken"),h.prototype.deleteAllData=p((function(){return o.MemoryStore.prototype.deleteAllData.call(this),this.backend.clearDatabase().then(()=>{d.logger.log("Deleted indexeddb data.")},e=>{throw d.logger.error("Failed to delete indexeddb data: "+e),e})})),h.prototype.wantsSave=function(){return Date.now()-this._syncTs>3e5},h.prototype.save=function(e){return e||this.wantsSave()?this._reallySave():Promise.resolve()},h.prototype._reallySave=p((function(){this._syncTs=Date.now();const e=[];for(const t of this.getUsers())this._userModifiedMap[t.userId]!==t.getLastModifiedTime()&&t.events.presence&&(e.push([t.userId,t.events.presence.event]),this._userModifiedMap[t.userId]=t.getLastModifiedTime());return this.backend.syncToDatabase(e)})),h.prototype.setSyncData=p((function(e){return this.backend.setSyncData(e)}),"setSyncData"),h.prototype.getOutOfBandMembers=p((function(e){return this.backend.getOutOfBandMembers(e)}),"getOutOfBandMembers"),h.prototype.setOutOfBandMembers=p((function(e,t){return o.MemoryStore.prototype.setOutOfBandMembers.call(this,e,t),this.backend.setOutOfBandMembers(e,t)}),"setOutOfBandMembers"),h.prototype.clearOutOfBandMembers=p((function(e){return o.MemoryStore.prototype.clearOutOfBandMembers.call(this),this.backend.clearOutOfBandMembers(e)}),"clearOutOfBandMembers"),h.prototype.getClientOptions=p((function(){return this.backend.getClientOptions()}),"getClientOptions"),h.prototype.storeClientOptions=p((function(e){return o.MemoryStore.prototype.storeClientOptions.call(this,e),this.backend.storeClientOptions(e)}),"storeClientOptions")}).call(this,r(8))},function(e,t,r){"use strict";var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.LocalIndexedDBStoreBackend=h;var o=r(71),i=n(r(6)),s=n(r(64)),a=r(3);function c(e,t,r){const n=e.openCursor(t);return new Promise((e,t)=>{const o=[];n.onerror=e=>{t(new Error("Query failed: "+e.target.errorCode))},n.onsuccess=t=>{const n=t.target.result;n?(o.push(r(n)),n.continue()):e(o)}})}function u(e){return new Promise((t,r)=>{e.oncomplete=function(e){t(e)},e.onerror=function(e){r(e.target.error)}})}function l(e){return new Promise((t,r)=>{e.onsuccess=function(e){t(e)},e.onerror=function(e){r(e.target.error)}})}function d(e){return l(e).then(e=>e.target.result)}function h(e,t){this.indexedDB=e,this._dbName="matrix-js-sdk:"+(t||"default"),this.db=null,this._disconnected=!0,this._syncAccumulator=new o.SyncAccumulator,this._isNewlyCreated=!1}h.exists=function(e,t){return t="matrix-js-sdk:"+(t||"default"),s.exists(e,t)},h.prototype={connect:function(){if(!this._disconnected)return a.logger.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this._disconnected=!1,a.logger.log("LocalIndexedDBStoreBackend.connect: connecting...");const e=this.indexedDB.open(this._dbName,3);return e.onupgradeneeded=e=>{const t=e.target.result,r=e.oldVersion;a.logger.log("LocalIndexedDBStoreBackend.connect: upgrading from "+r),r<1&&(this._isNewlyCreated=!0,function(e){e.createObjectStore("users",{keyPath:["userId"]}),e.createObjectStore("accountData",{keyPath:["type"]}),e.createObjectStore("sync",{keyPath:["clobber"]})}(t)),r<2&&function(e){e.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]}).createIndex("room","room_id")}(t),r<3&&function(e){e.createObjectStore("client_options",{keyPath:["clobber"]})}(t)},e.onblocked=()=>{a.logger.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},a.logger.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),l(e).then(e=>(a.logger.log("LocalIndexedDBStoreBackend.connect: connected"),this.db=e.target.result,this.db.onversionchange=()=>{this.db.close()},this._init()))},isNewlyCreated:function(){return Promise.resolve(this._isNewlyCreated)},_init:function(){return Promise.all([this._loadAccountData(),this._loadSyncData()]).then(([e,t])=>{a.logger.log("LocalIndexedDBStoreBackend: loaded initial data"),this._syncAccumulator.accumulate({next_batch:t.nextBatch,rooms:t.roomsData,groups:t.groupsData,account_data:{events:e}})})},getOutOfBandMembers:function(e){return new Promise((t,r)=>{const n=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),o=IDBKeyRange.only(e),i=n.openCursor(o),s=[];let a=!1;i.onsuccess=e=>{const r=e.target.result;if(!r)return s.length||a?t(s):t(null);const n=r.value;n.oob_written?a=!0:s.push(n),r.continue()},i.onerror=e=>{r(e)}}).then(t=>(a.logger.log("LL: got "+(t&&t.length)+` membershipEvents from storage for room ${e} ...`),t))},setOutOfBandMembers:async function(e,t){a.logger.log("LL: backend about to store "+t.length+" members for "+e);const r=this.db.transaction(["oob_membership_events"],"readwrite"),n=r.objectStore("oob_membership_events");t.forEach(e=>{n.put(e)});const o={room_id:e,oob_written:!0,state_key:0};n.put(o),await u(r),a.logger.log(`LL: backend done storing for ${e}!`)},clearOutOfBandMembers:async function(e){const t=this.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),r=IDBKeyRange.only(e),n=d(t.openKeyCursor(r,"next")).then(e=>e&&e.primaryKey[1]),o=d(t.openKeyCursor(r,"prev")).then(e=>e&&e.primaryKey[1]),[i,s]=await Promise.all([n,o]),c=this.db.transaction(["oob_membership_events"],"readwrite").objectStore("oob_membership_events"),u=IDBKeyRange.bound([e,i],[e,s]);var l;a.logger.log(`LL: Deleting all users + marker in storage for room ${e}, with key range:`,[e,i],[e,s]),await(l=c.delete(u),new Promise((e,t)=>{l.onsuccess=()=>e(l),l.onerror=e=>t(e)}))},clearDatabase:function(){return new Promise((e,t)=>{a.logger.log("Removing indexeddb instance: "+this._dbName);const r=this.indexedDB.deleteDatabase(this._dbName);r.onblocked=()=>{a.logger.log("can't yet delete indexeddb "+this._dbName+" because it is open elsewhere")},r.onerror=t=>{a.logger.warn("unable to delete js-sdk store indexeddb: "+t.target.error),e()},r.onsuccess=()=>{a.logger.log("Removed indexeddb instance: "+this._dbName),e()}})},getSavedSync:function(e){void 0===e&&(e=!0);const t=this._syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(i.deepCopy(t)):Promise.resolve(t):Promise.resolve(null)},getNextBatchToken:function(){return Promise.resolve(this._syncAccumulator.getNextBatchToken())},setSyncData:function(e){return Promise.resolve().then(()=>{this._syncAccumulator.accumulate(e)})},syncToDatabase:function(e){const t=this._syncAccumulator.getJSON();return Promise.all([this._persistUserPresenceEvents(e),this._persistAccountData(t.accountData),this._persistSyncData(t.nextBatch,t.roomsData,t.groupsData)])},_persistSyncData:function(e,t,r){return a.logger.log("Persisting sync data up to ",e),i.promiseTry(()=>{const n=this.db.transaction(["sync"],"readwrite");return n.objectStore("sync").put({clobber:"-",nextBatch:e,roomsData:t,groupsData:r}),u(n)})},_persistAccountData:function(e){return i.promiseTry(()=>{const t=this.db.transaction(["accountData"],"readwrite"),r=t.objectStore("accountData");for(let t=0;t<e.length;t++)r.put(e[t]);return u(t)})},_persistUserPresenceEvents:function(e){return i.promiseTry(()=>{const t=this.db.transaction(["users"],"readwrite"),r=t.objectStore("users");for(const t of e)r.put({userId:t[0],event:t[1]});return u(t)})},getUserPresenceEvents:function(){return i.promiseTry(()=>c(this.db.transaction(["users"],"readonly").objectStore("users"),void 0,e=>[e.value.userId,e.value.event]))},_loadAccountData:function(){return a.logger.log("LocalIndexedDBStoreBackend: loading account data..."),i.promiseTry(()=>c(this.db.transaction(["accountData"],"readonly").objectStore("accountData"),void 0,e=>e.value).then(e=>(a.logger.log("LocalIndexedDBStoreBackend: loaded account data"),e)))},_loadSyncData:function(){return a.logger.log("LocalIndexedDBStoreBackend: loading sync data..."),i.promiseTry(()=>c(this.db.transaction(["sync"],"readonly").objectStore("sync"),void 0,e=>e.value).then(e=>(a.logger.log("LocalIndexedDBStoreBackend: loaded sync data"),e.length>1&&a.logger.warn("loadSyncData: More than 1 sync row found."),e.length>0?e[0]:{})))},getClientOptions:function(){return Promise.resolve().then(()=>c(this.db.transaction(["client_options"],"readonly").objectStore("client_options"),void 0,e=>{if(e.value&&e.value&&e.value.options)return e.value.options}).then(e=>e[0]))},storeClientOptions:async function(e){const t=this.db.transaction(["client_options"],"readwrite");t.objectStore("client_options").put({clobber:"-",options:e}),await u(t)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RemoteIndexedDBStoreBackend=i;var n=r(3),o=r(6);function i(e,t,r){this._workerScript=e,this._dbName=t,this._workerApi=r,this._worker=null,this._nextSeq=0,this._inFlight={},this._startPromise=null}i.prototype={connect:function(){return this._ensureStarted().then(()=>this._doCmd("connect"))},clearDatabase:function(){return this._ensureStarted().then(()=>this._doCmd("clearDatabase"))},isNewlyCreated:function(){return this._doCmd("isNewlyCreated")},getSavedSync:function(){return this._doCmd("getSavedSync")},getNextBatchToken:function(){return this._doCmd("getNextBatchToken")},setSyncData:function(e){return this._doCmd("setSyncData",[e])},syncToDatabase:function(e){return this._doCmd("syncToDatabase",[e])},getOutOfBandMembers:function(e){return this._doCmd("getOutOfBandMembers",[e])},setOutOfBandMembers:function(e,t){return this._doCmd("setOutOfBandMembers",[e,t])},clearOutOfBandMembers:function(e){return this._doCmd("clearOutOfBandMembers",[e])},getClientOptions:function(){return this._doCmd("getClientOptions")},storeClientOptions:function(e){return this._doCmd("storeClientOptions",[e])},getUserPresenceEvents:function(){return this._doCmd("getUserPresenceEvents")},_ensureStarted:function(){return null===this._startPromise&&(this._worker=new this._workerApi(this._workerScript),this._worker.onmessage=this._onWorkerMessage.bind(this),this._startPromise=this._doCmd("_setupWorker",[this._dbName]).then(()=>{n.logger.log("IndexedDB worker is ready")})),this._startPromise},_doCmd:function(e,t){return Promise.resolve().then(()=>{const r=this._nextSeq++,n=(0,o.defer)();return this._inFlight[r]=n,this._worker.postMessage({command:e,seq:r,args:t}),n.promise})},_onWorkerMessage:function(e){const t=e.data;if("cmd_success"==t.command||"cmd_fail"==t.command){if(void 0===t.seq)return void n.logger.error("Got reply from worker with no seq");const e=this._inFlight[t.seq];if(void 0===e)return void n.logger.error("Got reply for unknown seq "+t.seq);if(delete this._inFlight[t.seq],"cmd_success"==t.command)e.resolve(t.result);else{const r=new Error(t.error.message);r.name=t.error.name,e.reject(r)}}else n.logger.warn("Unrecognised message from worker: "+t)}}},function(e,t,r){"use strict";var n=r(5);Object.defineProperty(t,"__esModule",{value:!0}),t.WebStorageSessionStore=s;var o=n(r(6));r(3);const i="session.e2e.";function s(e){if(this.store=e,!(o.isFunction(e.getItem)&&o.isFunction(e.setItem)&&o.isFunction(e.removeItem)&&o.isFunction(e.key)&&"number"==typeof e.length))throw new Error("Supplied webStore does not meet the WebStorage API interface")}s.prototype={removeEndToEndAccount:function(){this.store.removeItem(a)},getEndToEndAccount:function(){return this.store.getItem(a)},getAllEndToEndDevices:function(){const e=d(""),t={};for(let r=0;r<this.store.length;++r){const n=this.store.key(r),o=n.substr(e.length);n.startsWith(e)&&(t[o]=f(this.store,n))}return t},getEndToEndDeviceTrackingStatus:function(){return f(this.store,u)},getEndToEndDeviceSyncToken:function(){return f(this.store,c)},removeEndToEndDeviceData:function(){g(this.store,d("")),g(this.store,u),g(this.store,c)},getEndToEndSessions:function(e){return f(this.store,h(e))},getAllEndToEndSessions:function(){const e=m(this.store,h("")),t={};for(const r of e){t[r.substr(h("").length)]=f(this.store,r)}return t},removeAllEndToEndSessions:function(){g(this.store,h(""))},getAllEndToEndInboundGroupSessionKeys:function(){const e=i+"inboundgroupsessions/",t=[];for(let r=0;r<this.store.length;r++){const n=this.store.key(r);n.startsWith(e)&&t.push({senderKey:n.substr(e.length,43),sessionId:n.substr(e.length+44)})}return t},getEndToEndInboundGroupSession:function(e,t){const r=function(e,t){return i+"inboundgroupsessions/"+e+"/"+t}(e,t);return this.store.getItem(r)},removeAllEndToEndInboundGroupSessions:function(){g(this.store,i+"inboundgroupsessions/")},getAllEndToEndRooms:function(){const e=m(this.store,p("")),t={};for(const r of e){t[r.substr(p("").length)]=f(this.store,r)}return t},removeAllEndToEndRooms:function(){g(this.store,p(""))},setLocalTrustedBackupPubKey:function(e){this.store.setItem(l,e)},getLocalTrustedBackupPubKey:function(){return this.store.getItem(l)}};const a=i+"account",c=i+"device_sync_token",u=i+"device_tracking",l=i+"trusted_backup_pubkey";function d(e){return i+"devices/"+e}function h(e){return i+"sessions/"+e}function p(e){return i+"rooms/"+e}function f(e,t){try{return JSON.parse(e.getItem(t))}catch(e){v("Failed to get key %s: %s",t,e),v(e.stack)}return null}function m(e,t){const r=[];for(let n=0;n<e.length;++n){const o=e.key(n);o.startsWith(t)&&r.push(o)}return r}function g(e,t){const r=[];for(let n=0;n<e.length;++n){const o=e.key(n);o.startsWith(t)&&r.push(o)}for(const t of r)e.removeItem(t)}function v(){0}},function(e,t,r){var n,o,i;o=[],void 0===(i="function"==typeof(n=function(){var e=XMLHttpRequest;if(!e)throw new Error("missing XMLHttpRequest");function t(i,s){if("function"!=typeof s)throw new Error("Bad callback given: "+s);if(!i)throw new Error("No options given");var a=i.onResponse;if((i="string"==typeof i?{uri:i}:JSON.parse(JSON.stringify(i))).onResponse=a,i.verbose&&(t.log=function(){var e,t,r={},i=["trace","debug","info","warn","error"];for(t=0;t<i.length;t++)r[e=i[t]]=n,"undefined"!=typeof console&&console&&console[e]&&(r[e]=o(console,e));return r}()),i.url&&(i.uri=i.url,delete i.url),!i.uri&&""!==i.uri)throw new Error("options.uri is a required argument");if("string"!=typeof i.uri)throw new Error("options.uri must be a string");for(var c=["proxy","_redirectsFollowed","maxRedirects","followRedirect"],u=0;u<c.length;u++)if(i[c[u]])throw new Error("options."+c[u]+" is not supported");if(i.callback=s,i.method=i.method||"GET",i.headers=i.headers||{},i.body=i.body||null,i.timeout=i.timeout||t.DEFAULT_TIMEOUT,i.headers.host)throw new Error("Options.headers.host is not supported");i.json&&(i.headers.accept=i.headers.accept||"application/json","GET"!==i.method&&(i.headers["content-type"]="application/json"),"boolean"!=typeof i.json?i.body=JSON.stringify(i.json):"string"!=typeof i.body&&(i.body=JSON.stringify(i.body)));var l=function(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&t.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t.join("&")};if(i.qs){var d="string"==typeof i.qs?i.qs:l(i.qs);-1!==i.uri.indexOf("?")?i.uri=i.uri+"&"+d:i.uri=i.uri+"?"+d}if(i.form){if("string"==typeof i.form)throw"form name unsupported";if("POST"===i.method){var h=(i.encoding||"application/x-www-form-urlencoded").toLowerCase();switch(i.headers["content-type"]=h,h){case"application/x-www-form-urlencoded":i.body=l(i.form).replace(/%20/g,"+");break;case"multipart/form-data":var p=function(e){var t={};t.boundry="-------------------------------"+Math.floor(1e9*Math.random());var r=[];for(var n in e)e.hasOwnProperty(n)&&r.push("--"+t.boundry+'\nContent-Disposition: form-data; name="'+n+'"\n\n'+e[n]+"\n");return r.push("--"+t.boundry+"--"),t.body=r.join(""),t.length=t.body.length,t.type="multipart/form-data; boundary="+t.boundry,t}(i.form);i.body=p.body,i.headers["content-type"]=p.type;break;default:throw new Error("unsupported encoding:"+h)}}}return i.onResponse=i.onResponse||n,!0===i.onResponse&&(i.onResponse=s,i.callback=n),!i.headers.authorization&&i.auth&&(i.headers.authorization="Basic "+function(e){var t,r,n,o,i,s,a,c,u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l=0,d=0,h="",p=[];if(!e)return e;do{t=e.charCodeAt(l++),r=e.charCodeAt(l++),n=e.charCodeAt(l++),o=(c=t<<16|r<<8|n)>>18&63,i=c>>12&63,s=c>>6&63,a=63&c,p[d++]=u.charAt(o)+u.charAt(i)+u.charAt(s)+u.charAt(a)}while(l<e.length);switch(h=p.join(""),e.length%3){case 1:h=h.slice(0,-2)+"==";break;case 2:h=h.slice(0,-1)+"="}return h}(i.auth.username+":"+i.auth.password)),function(n){var o=new e,i=!1,s=function(e){var t,r=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/;try{t=location.href}catch(e){(t=document.createElement("a")).href="",t=t.href}var n=r.exec(t.toLowerCase())||[],o=r.exec(e.toLowerCase());return!(!o||o[1]==n[1]&&o[2]==n[2]&&(o[3]||("http:"===o[1]?80:443))==(n[3]||("http:"===n[1]?80:443)))}(n.uri),a="withCredentials"in o;if(r+=1,o.seq_id=r,o.id=r+": "+n.method+" "+n.uri,o._id=o.id,s&&!a){var c=new Error("Browser does not support cross-origin request: "+n.uri);return c.cors="unsupported",n.callback(c,o)}o.timeoutTimer=setTimeout((function(){i=!0;var e=new Error("ETIMEDOUT");return e.code="ETIMEDOUT",e.duration=n.timeout,t.log.error("Timeout",{id:o._id,milliseconds:n.timeout}),n.callback(e,o)}),n.timeout);var u={response:!1,loading:!1,end:!1};return o.onreadystatechange=function(r){if(i)return t.log.debug("Ignoring timed out state change",{state:o.readyState,id:o.id});if(t.log.debug("State change",{state:o.readyState,id:o.id,timed_out:i}),o.readyState===e.OPENED)for(var s in t.log.debug("Request started",{id:o.id}),n.headers)o.setRequestHeader(s,n.headers[s]);else o.readyState===e.HEADERS_RECEIVED?l():o.readyState===e.LOADING?(l(),d()):o.readyState===e.DONE&&(l(),d(),function(){if(u.end)return;if(u.end=!0,t.log.debug("Request done",{id:o.id}),o.body=o.responseText,n.json)try{o.body=JSON.parse(o.responseText)}catch(e){return n.callback(e,o)}n.callback(null,o,o.body)}())},o.open(n.method,n.uri,!0),s&&(o.withCredentials=!!n.withCredentials),o.send(n.body),o;function l(){if(!u.response){if(u.response=!0,t.log.debug("Got response",{id:o.id,status:o.status}),clearTimeout(o.timeoutTimer),o.statusCode=o.status,s&&0==o.statusCode){var e=new Error("CORS request rejected: "+n.uri);return e.cors="rejected",u.loading=!0,u.end=!0,n.callback(e,o)}n.onResponse(null,o)}}function d(){u.loading||(u.loading=!0,t.log.debug("Response body loading",{id:o.id}))}}(i)}t.log={trace:n,debug:n,info:n,warn:n,error:n};var r=0;function n(){}function o(e,t){return function(r,n){return"object"==typeof n&&(r+=" "+JSON.stringify(n)),e[t].call(e,r)}}return t.withCredentials=!1,t.DEFAULT_TIMEOUT=18e4,t.defaults=function(e,r){var n=function(t){return function(r,n){for(var o in r="string"==typeof r?{uri:r}:JSON.parse(JSON.stringify(r)),e)void 0===r[o]&&(r[o]=e[o]);return t(r,n)}},o=n(t);return o.get=n(t.get),o.post=n(t.post),o.put=n(t.put),o.head=n(t.head),o},["get","put","post","head"].forEach((function(e){var r=e.toUpperCase();t[e.toLowerCase()]=function(e){"string"==typeof e?e={method:r,uri:e}:(e=JSON.parse(JSON.stringify(e))).method=r;var n=[e].concat(Array.prototype.slice.apply(arguments,[1]));return t.apply(this,n)}})),t.couch=function(e,r){return"string"==typeof e&&(e={uri:e}),e.json=!0,e.body&&(e.json=e.body),delete e.body,r=r||n,t(e,(function(e,t,n){if(e)return r(e,t,n);if((t.statusCode<200||t.statusCode>299)&&n.error){for(var o in e=new Error("CouchDB error: "+(n.error.reason||n.error.error)),n)e[o]=n[o];return r(e,t,n)}return r(e,t,n)}))},t})?n.apply(t,o):n)||(e.exports=i)},function(e,t,r){"use strict";var n=r(138),o=r(139),i=r(72);e.exports={formats:i,parse:o,stringify:n}},function(e,t,r){"use strict";var n=r(46),o=r(72),i=Object.prototype.hasOwnProperty,s={brackets:function(e){return e+"[]"},comma:"comma",indices:function(e,t){return e+"["+t+"]"},repeat:function(e){return e}},a=Array.isArray,c=Array.prototype.push,u=function(e,t){c.apply(e,a(t)?t:[t])},l=Date.prototype.toISOString,d=o.default,h={addQueryPrefix:!1,allowDots:!1,charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encoder:n.encode,encodeValuesOnly:!1,format:d,formatter:o.formatters[d],indices:!1,serializeDate:function(e){return l.call(e)},skipNulls:!1,strictNullHandling:!1},p=function e(t,r,o,i,s,c,l,d,p,f,m,g,v){var y,_=t;if("function"==typeof l?_=l(r,_):_ instanceof Date?_=f(_):"comma"===o&&a(_)&&(_=n.maybeMap(_,(function(e){return e instanceof Date?f(e):e})).join(",")),null===_){if(i)return c&&!g?c(r,h.encoder,v,"key"):r;_=""}if("string"==typeof(y=_)||"number"==typeof y||"boolean"==typeof y||"symbol"==typeof y||"bigint"==typeof y||n.isBuffer(_))return c?[m(g?r:c(r,h.encoder,v,"key"))+"="+m(c(_,h.encoder,v,"value"))]:[m(r)+"="+m(String(_))];var b,E=[];if(void 0===_)return E;if(a(l))b=l;else{var S=Object.keys(_);b=d?S.sort(d):S}for(var w=0;w<b.length;++w){var R=b[w],I=_[R];if(!s||null!==I){var k=a(_)?"function"==typeof o?o(r,R):r:r+(p?"."+R:"["+R+"]");u(E,e(I,k,o,i,s,c,l,d,p,f,m,g,v))}}return E};e.exports=function(e,t){var r,n=e,c=function(e){if(!e)return h;if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");var t=e.charset||h.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var r=o.default;if(void 0!==e.format){if(!i.call(o.formatters,e.format))throw new TypeError("Unknown format option provided.");r=e.format}var n=o.formatters[r],s=h.filter;return("function"==typeof e.filter||a(e.filter))&&(s=e.filter),{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:h.addQueryPrefix,allowDots:void 0===e.allowDots?h.allowDots:!!e.allowDots,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:h.charsetSentinel,delimiter:void 0===e.delimiter?h.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:h.encode,encoder:"function"==typeof e.encoder?e.encoder:h.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:h.encodeValuesOnly,filter:s,formatter:n,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:h.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:h.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:h.strictNullHandling}}(t);"function"==typeof c.filter?n=(0,c.filter)("",n):a(c.filter)&&(r=c.filter);var l,d=[];if("object"!=typeof n||null===n)return"";l=t&&t.arrayFormat in s?t.arrayFormat:t&&"indices"in t?t.indices?"indices":"repeat":"indices";var f=s[l];r||(r=Object.keys(n)),c.sort&&r.sort(c.sort);for(var m=0;m<r.length;++m){var g=r[m];c.skipNulls&&null===n[g]||u(d,p(n[g],g,f,c.strictNullHandling,c.skipNulls,c.encode?c.encoder:null,c.filter,c.sort,c.allowDots,c.serializeDate,c.formatter,c.encodeValuesOnly,c.charset))}var v=d.join(c.delimiter),y=!0===c.addQueryPrefix?"?":"";return c.charsetSentinel&&("iso-8859-1"===c.charset?y+="utf8=%26%2310003%3B&":y+="utf8=%E2%9C%93&"),v.length>0?y+v:""}},function(e,t,r){"use strict";var n=r(46),o=Object.prototype.hasOwnProperty,i=Array.isArray,s={allowDots:!1,allowPrototypes:!1,arrayLimit:20,charset:"utf-8",charsetSentinel:!1,comma:!1,decoder:n.decode,delimiter:"&",depth:5,ignoreQueryPrefix:!1,interpretNumericEntities:!1,parameterLimit:1e3,parseArrays:!0,plainObjects:!1,strictNullHandling:!1},a=function(e){return e.replace(/&#(\d+);/g,(function(e,t){return String.fromCharCode(parseInt(t,10))}))},c=function(e,t){return e&&"string"==typeof e&&t.comma&&e.indexOf(",")>-1?e.split(","):e},u=function(e,t,r,n){if(e){var i=r.allowDots?e.replace(/\.([^.[]+)/g,"[$1]"):e,s=/(\[[^[\]]*])/g,a=r.depth>0&&/(\[[^[\]]*])/.exec(i),u=a?i.slice(0,a.index):i,l=[];if(u){if(!r.plainObjects&&o.call(Object.prototype,u)&&!r.allowPrototypes)return;l.push(u)}for(var d=0;r.depth>0&&null!==(a=s.exec(i))&&d<r.depth;){if(d+=1,!r.plainObjects&&o.call(Object.prototype,a[1].slice(1,-1))&&!r.allowPrototypes)return;l.push(a[1])}return a&&l.push("["+i.slice(a.index)+"]"),function(e,t,r,n){for(var o=n?t:c(t,r),i=e.length-1;i>=0;--i){var s,a=e[i];if("[]"===a&&r.parseArrays)s=[].concat(o);else{s=r.plainObjects?Object.create(null):{};var u="["===a.charAt(0)&&"]"===a.charAt(a.length-1)?a.slice(1,-1):a,l=parseInt(u,10);r.parseArrays||""!==u?!isNaN(l)&&a!==u&&String(l)===u&&l>=0&&r.parseArrays&&l<=r.arrayLimit?(s=[])[l]=o:s[u]=o:s={0:o}}o=s}return o}(l,t,r,n)}};e.exports=function(e,t){var r=function(e){if(!e)return s;if(null!==e.decoder&&void 0!==e.decoder&&"function"!=typeof e.decoder)throw new TypeError("Decoder has to be a function.");if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var t=void 0===e.charset?s.charset:e.charset;return{allowDots:void 0===e.allowDots?s.allowDots:!!e.allowDots,allowPrototypes:"boolean"==typeof e.allowPrototypes?e.allowPrototypes:s.allowPrototypes,arrayLimit:"number"==typeof e.arrayLimit?e.arrayLimit:s.arrayLimit,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:s.charsetSentinel,comma:"boolean"==typeof e.comma?e.comma:s.comma,decoder:"function"==typeof e.decoder?e.decoder:s.decoder,delimiter:"string"==typeof e.delimiter||n.isRegExp(e.delimiter)?e.delimiter:s.delimiter,depth:"number"==typeof e.depth||!1===e.depth?+e.depth:s.depth,ignoreQueryPrefix:!0===e.ignoreQueryPrefix,interpretNumericEntities:"boolean"==typeof e.interpretNumericEntities?e.interpretNumericEntities:s.interpretNumericEntities,parameterLimit:"number"==typeof e.parameterLimit?e.parameterLimit:s.parameterLimit,parseArrays:!1!==e.parseArrays,plainObjects:"boolean"==typeof e.plainObjects?e.plainObjects:s.plainObjects,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:s.strictNullHandling}}(t);if(""===e||null==e)return r.plainObjects?Object.create(null):{};for(var l="string"==typeof e?function(e,t){var r,u={},l=t.ignoreQueryPrefix?e.replace(/^\?/,""):e,d=t.parameterLimit===1/0?void 0:t.parameterLimit,h=l.split(t.delimiter,d),p=-1,f=t.charset;if(t.charsetSentinel)for(r=0;r<h.length;++r)0===h[r].indexOf("utf8=")&&("utf8=%E2%9C%93"===h[r]?f="utf-8":"utf8=%26%2310003%3B"===h[r]&&(f="iso-8859-1"),p=r,r=h.length);for(r=0;r<h.length;++r)if(r!==p){var m,g,v=h[r],y=v.indexOf("]="),_=-1===y?v.indexOf("="):y+1;-1===_?(m=t.decoder(v,s.decoder,f,"key"),g=t.strictNullHandling?null:""):(m=t.decoder(v.slice(0,_),s.decoder,f,"key"),g=n.maybeMap(c(v.slice(_+1),t),(function(e){return t.decoder(e,s.decoder,f,"value")}))),g&&t.interpretNumericEntities&&"iso-8859-1"===f&&(g=a(g)),v.indexOf("[]=")>-1&&(g=i(g)?[g]:g),o.call(u,m)?u[m]=n.combine(u[m],g):u[m]=g}return u}(e,r):e,d=r.plainObjects?Object.create(null):{},h=Object.keys(l),p=0;p<h.length;++p){var f=h[p],m=u(f,l[f],r,"string"==typeof e);d=n.merge(d,m,r)}return n.compact(d)}},function(e,t,r){var n=r(73);e.exports=function(e){if(Array.isArray(e))return n(e)}},function(e,t){e.exports=function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}},function(e,t,r){var n=r(73);e.exports=function(e,t){if(e){if("string"==typeof e)return n(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?n(e,t):void 0}}},function(e,t){e.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}},function(e,t,r){"use strict";var n=r(47),o=r(25),i=r(49),s=r(75),a=r(76),c=o.ucs2length,u=r(48),l=i.Validation;function d(e,t,r){var n=p.call(this,e,t,r);return n>=0?{index:n,compiling:!0}:(n=this._compilations.length,this._compilations[n]={schema:e,root:t,baseId:r},{index:n,compiling:!1})}function h(e,t,r){var n=p.call(this,e,t,r);n>=0&&this._compilations.splice(n,1)}function p(e,t,r){for(var n=0;n<this._compilations.length;n++){var o=this._compilations[n];if(o.schema==e&&o.root==t&&o.baseId==r)return n}return-1}function f(e,t){return"var pattern"+e+" = new RegExp("+o.toQuotedString(t[e])+");"}function m(e){return"var default"+e+" = defaults["+e+"];"}function g(e,t){return void 0===t[e]?"":"var refVal"+e+" = refVal["+e+"];"}function v(e){return"var customRule"+e+" = customRules["+e+"];"}function y(e,t){if(!e.length)return"";for(var r="",n=0;n<e.length;n++)r+=t(n,e);return r}e.exports=function e(t,r,p,_){var b=this,E=this._opts,S=[void 0],w={},R=[],I={},k=[],P={},T=[];r=r||{schema:t,refVal:S,refs:w};var O=d.call(this,t,r,_),A=this._compilations[O.index];if(O.compiling)return A.callValidate=function e(){var t=A.validate,r=t.apply(this,arguments);return e.errors=t.errors,r};var D=this._formats,C=this.RULES;try{var x=j(t,r,p,_);A.validate=x;var M=A.callValidate;return M&&(M.schema=x.schema,M.errors=null,M.refs=x.refs,M.refVal=x.refVal,M.root=x.root,M.$async=x.$async,E.sourceCode&&(M.source=x.source)),x}finally{h.call(this,t,r,_)}function j(t,s,d,h){var p=!s||s&&s.schema==t;if(s.schema!=r.schema)return e.call(b,t,s,d,h);var _,I=!0===t.$async,P=a({isTop:!0,schema:t,isRoot:p,baseId:h,root:s,schemaPath:"",errSchemaPath:"#",errorPath:'""',MissingRefError:i.MissingRef,RULES:C,validate:a,util:o,resolve:n,resolveRef:U,usePattern:L,useDefault:K,useCustomRule:B,opts:E,formats:D,logger:b.logger,self:b});P=y(S,g)+y(R,f)+y(k,m)+y(T,v)+P,E.processCode&&(P=E.processCode(P,t));try{_=new Function("self","RULES","formats","root","refVal","defaults","customRules","equal","ucs2length","ValidationError",P)(b,C,D,r,S,k,T,u,c,l),S[0]=_}catch(e){throw b.logger.error("Error compiling schema, function code:",P),e}return _.schema=t,_.errors=null,_.refs=w,_.refVal=S,_.root=p?_:s,I&&(_.$async=!0),!0===E.sourceCode&&(_.source={code:P,patterns:R,defaults:k}),_}function U(t,o,i){o=n.url(t,o);var s,a,c=w[o];if(void 0!==c)return F(s=S[c],a="refVal["+c+"]");if(!i&&r.refs){var u=r.refs[o];if(void 0!==u)return F(s=r.refVal[u],a=N(o,s))}a=N(o);var l=n.call(b,j,r,o);if(void 0===l){var d=p&&p[o];d&&(l=n.inlineRef(d,E.inlineRefs)?d:e.call(b,d,r,p,t))}if(void 0!==l)return function(e,t){var r=w[e];S[r]=t}(o,l),F(l,a);!function(e){delete w[e]}(o)}function N(e,t){var r=S.length;return S[r]=t,w[e]=r,"refVal"+r}function F(e,t){return"object"==typeof e||"boolean"==typeof e?{code:t,schema:e,inline:!0}:{code:t,$async:e&&!!e.$async}}function L(e){var t=I[e];return void 0===t&&(t=I[e]=R.length,R[t]=e),"pattern"+t}function K(e){switch(typeof e){case"boolean":case"number":return""+e;case"string":return o.toQuotedString(e);case"object":if(null===e)return"null";var t=s(e),r=P[t];return void 0===r&&(r=P[t]=k.length,k[r]=e),"default"+r}}function B(e,t,r,n){if(!1!==b._opts.validateSchema){var o=e.definition.dependencies;if(o&&!o.every((function(e){return Object.prototype.hasOwnProperty.call(r,e)})))throw new Error("parent schema must have all required keywords: "+o.join(","));var i=e.definition.validateSchema;if(i)if(!i(t)){var s="keyword schema is invalid: "+b.errorsText(i.errors);if("log"!=b._opts.validateSchema)throw new Error(s);b.logger.error(s)}}var a,c=e.definition.compile,u=e.definition.inline,l=e.definition.macro;if(c)a=c.call(b,t,r,n);else if(l)a=l.call(b,t,r,n),!1!==E.validateSchema&&b.validateSchema(a,!0);else if(u)a=u.call(b,n,e.keyword,t,r);else if(!(a=e.definition.validate))return;if(void 0===a)throw new Error('custom keyword "'+e.keyword+'"failed to compile');var d=T.length;return T[d]=a,{code:"customRule"+d,validate:a}}}},function(e,t,r){
/** @license URI.js v4.2.1 (c) 2011 Gary Court. License: http://github.com/garycourt/uri-js */
!function(e){"use strict";function t(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];if(t.length>1){t[0]=t[0].slice(0,-1);for(var n=t.length-1,o=1;o<n;++o)t[o]=t[o].slice(1,-1);return t[n]=t[n].slice(1),t.join("")}return t[0]}function r(e){return"(?:"+e+")"}function n(e){return void 0===e?"undefined":null===e?"null":Object.prototype.toString.call(e).split(" ").pop().split("]").shift().toLowerCase()}function o(e){return e.toUpperCase()}function i(e){var n=t("[0-9]","[A-Fa-f]"),o=r(r("%[EFef]"+n+"%"+n+n+"%"+n+n)+"|"+r("%[89A-Fa-f]"+n+"%"+n+n)+"|"+r("%"+n+n)),i="[\\!\\$\\&\\'\\(\\)\\*\\+\\,\\;\\=]",s=t("[\\:\\/\\?\\#\\[\\]\\@]",i),a=e?"[\\uE000-\\uF8FF]":"[]",c=t("[A-Za-z]","[0-9]","[\\-\\.\\_\\~]",e?"[\\xA0-\\u200D\\u2010-\\u2029\\u202F-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF]":"[]"),u=r("[A-Za-z]"+t("[A-Za-z]","[0-9]","[\\+\\-\\.]")+"*"),l=r(r(o+"|"+t(c,i,"[\\:]"))+"*"),d=(r(r("25[0-5]")+"|"+r("2[0-4][0-9]")+"|"+r("1[0-9][0-9]")+"|"+r("[1-9][0-9]")+"|[0-9]"),r(r("25[0-5]")+"|"+r("2[0-4][0-9]")+"|"+r("1[0-9][0-9]")+"|"+r("0?[1-9][0-9]")+"|0?0?[0-9]")),h=r(d+"\\."+d+"\\."+d+"\\."+d),p=r(n+"{1,4}"),f=r(r(p+"\\:"+p)+"|"+h),m=r(r(p+"\\:")+"{6}"+f),g=r("\\:\\:"+r(p+"\\:")+"{5}"+f),v=r(r(p)+"?\\:\\:"+r(p+"\\:")+"{4}"+f),y=r(r(r(p+"\\:")+"{0,1}"+p)+"?\\:\\:"+r(p+"\\:")+"{3}"+f),_=r(r(r(p+"\\:")+"{0,2}"+p)+"?\\:\\:"+r(p+"\\:")+"{2}"+f),b=r(r(r(p+"\\:")+"{0,3}"+p)+"?\\:\\:"+p+"\\:"+f),E=r(r(r(p+"\\:")+"{0,4}"+p)+"?\\:\\:"+f),S=r(r(r(p+"\\:")+"{0,5}"+p)+"?\\:\\:"+p),w=r(r(r(p+"\\:")+"{0,6}"+p)+"?\\:\\:"),R=r([m,g,v,y,_,b,E,S,w].join("|")),I=r(r(c+"|"+o)+"+"),k=(r(R+"\\%25"+I),r(R+r("\\%25|\\%(?!"+n+"{2})")+I)),P=r("[vV]"+n+"+\\."+t(c,i,"[\\:]")+"+"),T=r("\\["+r(k+"|"+R+"|"+P)+"\\]"),O=r(r(o+"|"+t(c,i))+"*"),A=r(T+"|"+h+"(?!"+O+")|"+O),D=r("[0-9]*"),C=r(r(l+"@")+"?"+A+r("\\:"+D)+"?"),x=r(o+"|"+t(c,i,"[\\:\\@]")),M=r(x+"*"),j=r(x+"+"),U=r(r(o+"|"+t(c,i,"[\\@]"))+"+"),N=r(r("\\/"+M)+"*"),F=r("\\/"+r(j+N)+"?"),L=r(U+N),K=r(j+N),B="(?!"+x+")",q=(r(N+"|"+F+"|"+L+"|"+K+"|"+B),r(r(x+"|"+t("[\\/\\?]",a))+"*")),$=r(r(x+"|[\\/\\?]")+"*"),V=r(r("\\/\\/"+C+N)+"|"+F+"|"+K+"|"+B),G=r(u+"\\:"+V+r("\\?"+q)+"?"+r("\\#"+$)+"?"),H=r(r("\\/\\/"+C+N)+"|"+F+"|"+L+"|"+B),z=r(H+r("\\?"+q)+"?"+r("\\#"+$)+"?");return r(G+"|"+z),r(u+"\\:"+V+r("\\?"+q)+"?"),r(r("\\/\\/("+r("("+l+")@")+"?("+A+")"+r("\\:("+D+")")+"?)")+"?("+N+"|"+F+"|"+K+"|"+B+")"),r("\\?("+q+")"),r("\\#("+$+")"),r(r("\\/\\/("+r("("+l+")@")+"?("+A+")"+r("\\:("+D+")")+"?)")+"?("+N+"|"+F+"|"+L+"|"+B+")"),r("\\?("+q+")"),r("\\#("+$+")"),r(r("\\/\\/("+r("("+l+")@")+"?("+A+")"+r("\\:("+D+")")+"?)")+"?("+N+"|"+F+"|"+K+"|"+B+")"),r("\\?("+q+")"),r("\\#("+$+")"),r("("+l+")@"),r("\\:("+D+")"),{NOT_SCHEME:new RegExp(t("[^]","[A-Za-z]","[0-9]","[\\+\\-\\.]"),"g"),NOT_USERINFO:new RegExp(t("[^\\%\\:]",c,i),"g"),NOT_HOST:new RegExp(t("[^\\%\\[\\]\\:]",c,i),"g"),NOT_PATH:new RegExp(t("[^\\%\\/\\:\\@]",c,i),"g"),NOT_PATH_NOSCHEME:new RegExp(t("[^\\%\\/\\@]",c,i),"g"),NOT_QUERY:new RegExp(t("[^\\%]",c,i,"[\\:\\@\\/\\?]",a),"g"),NOT_FRAGMENT:new RegExp(t("[^\\%]",c,i,"[\\:\\@\\/\\?]"),"g"),ESCAPE:new RegExp(t("[^]",c,i),"g"),UNRESERVED:new RegExp(c,"g"),OTHER_CHARS:new RegExp(t("[^\\%]",c,s),"g"),PCT_ENCODED:new RegExp(o,"g"),IPV4ADDRESS:new RegExp("^("+h+")$"),IPV6ADDRESS:new RegExp("^\\[?("+R+")"+r(r("\\%25|\\%(?!"+n+"{2})")+"("+I+")")+"?\\]?$")}}var s=i(!1),a=i(!0),c=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var r=[],n=!0,o=!1,i=void 0;try{for(var s,a=e[Symbol.iterator]();!(n=(s=a.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){o=!0,i=e}finally{try{!n&&a.return&&a.return()}finally{if(o)throw i}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},u=2147483647,l=/^xn--/,d=/[^\0-\x7E]/,h=/[\x2E\u3002\uFF0E\uFF61]/g,p={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},f=Math.floor,m=String.fromCharCode;function g(e){throw new RangeError(p[e])}function v(e,t){var r=e.split("@"),n="";r.length>1&&(n=r[0]+"@",e=r[1]);var o=function(e,t){for(var r=[],n=e.length;n--;)r[n]=t(e[n]);return r}((e=e.replace(h,".")).split("."),t).join(".");return n+o}function y(e){for(var t=[],r=0,n=e.length;r<n;){var o=e.charCodeAt(r++);if(o>=55296&&o<=56319&&r<n){var i=e.charCodeAt(r++);56320==(64512&i)?t.push(((1023&o)<<10)+(1023&i)+65536):(t.push(o),r--)}else t.push(o)}return t}var _=function(e,t){return e+22+75*(e<26)-((0!=t)<<5)},b=function(e,t,r){var n=0;for(e=r?f(e/700):e>>1,e+=f(e/t);e>455;n+=36)e=f(e/35);return f(n+36*e/(e+38))},E=function(e){var t,r=[],n=e.length,o=0,i=128,s=72,a=e.lastIndexOf("-");a<0&&(a=0);for(var c=0;c<a;++c)e.charCodeAt(c)>=128&&g("not-basic"),r.push(e.charCodeAt(c));for(var l=a>0?a+1:0;l<n;){for(var d=o,h=1,p=36;;p+=36){l>=n&&g("invalid-input");var m=(t=e.charCodeAt(l++))-48<10?t-22:t-65<26?t-65:t-97<26?t-97:36;(m>=36||m>f((u-o)/h))&&g("overflow"),o+=m*h;var v=p<=s?1:p>=s+26?26:p-s;if(m<v)break;var y=36-v;h>f(u/y)&&g("overflow"),h*=y}var _=r.length+1;s=b(o-d,_,0==d),f(o/_)>u-i&&g("overflow"),i+=f(o/_),o%=_,r.splice(o++,0,i)}return String.fromCodePoint.apply(String,r)},S=function(e){var t=[],r=(e=y(e)).length,n=128,o=0,i=72,s=!0,a=!1,c=void 0;try{for(var l,d=e[Symbol.iterator]();!(s=(l=d.next()).done);s=!0){var h=l.value;h<128&&t.push(m(h))}}catch(e){a=!0,c=e}finally{try{!s&&d.return&&d.return()}finally{if(a)throw c}}var p=t.length,v=p;for(p&&t.push("-");v<r;){var E=u,S=!0,w=!1,R=void 0;try{for(var I,k=e[Symbol.iterator]();!(S=(I=k.next()).done);S=!0){var P=I.value;P>=n&&P<E&&(E=P)}}catch(e){w=!0,R=e}finally{try{!S&&k.return&&k.return()}finally{if(w)throw R}}var T=v+1;E-n>f((u-o)/T)&&g("overflow"),o+=(E-n)*T,n=E;var O=!0,A=!1,D=void 0;try{for(var C,x=e[Symbol.iterator]();!(O=(C=x.next()).done);O=!0){var M=C.value;if(M<n&&++o>u&&g("overflow"),M==n){for(var j=o,U=36;;U+=36){var N=U<=i?1:U>=i+26?26:U-i;if(j<N)break;var F=j-N,L=36-N;t.push(m(_(N+F%L,0))),j=f(F/L)}t.push(m(_(j,0))),i=b(o,T,v==p),o=0,++v}}}catch(e){A=!0,D=e}finally{try{!O&&x.return&&x.return()}finally{if(A)throw D}}++o,++n}return t.join("")},w=function(e){return v(e,(function(e){return d.test(e)?"xn--"+S(e):e}))},R=function(e){return v(e,(function(e){return l.test(e)?E(e.slice(4).toLowerCase()):e}))},I={};function k(e){var t=e.charCodeAt(0);return t<16?"%0"+t.toString(16).toUpperCase():t<128?"%"+t.toString(16).toUpperCase():t<2048?"%"+(t>>6|192).toString(16).toUpperCase()+"%"+(63&t|128).toString(16).toUpperCase():"%"+(t>>12|224).toString(16).toUpperCase()+"%"+(t>>6&63|128).toString(16).toUpperCase()+"%"+(63&t|128).toString(16).toUpperCase()}function P(e){for(var t="",r=0,n=e.length;r<n;){var o=parseInt(e.substr(r+1,2),16);if(o<128)t+=String.fromCharCode(o),r+=3;else if(o>=194&&o<224){if(n-r>=6){var i=parseInt(e.substr(r+4,2),16);t+=String.fromCharCode((31&o)<<6|63&i)}else t+=e.substr(r,6);r+=6}else if(o>=224){if(n-r>=9){var s=parseInt(e.substr(r+4,2),16),a=parseInt(e.substr(r+7,2),16);t+=String.fromCharCode((15&o)<<12|(63&s)<<6|63&a)}else t+=e.substr(r,9);r+=9}else t+=e.substr(r,3),r+=3}return t}function T(e,t){function r(e){var r=P(e);return r.match(t.UNRESERVED)?r:e}return e.scheme&&(e.scheme=String(e.scheme).replace(t.PCT_ENCODED,r).toLowerCase().replace(t.NOT_SCHEME,"")),void 0!==e.userinfo&&(e.userinfo=String(e.userinfo).replace(t.PCT_ENCODED,r).replace(t.NOT_USERINFO,k).replace(t.PCT_ENCODED,o)),void 0!==e.host&&(e.host=String(e.host).replace(t.PCT_ENCODED,r).toLowerCase().replace(t.NOT_HOST,k).replace(t.PCT_ENCODED,o)),void 0!==e.path&&(e.path=String(e.path).replace(t.PCT_ENCODED,r).replace(e.scheme?t.NOT_PATH:t.NOT_PATH_NOSCHEME,k).replace(t.PCT_ENCODED,o)),void 0!==e.query&&(e.query=String(e.query).replace(t.PCT_ENCODED,r).replace(t.NOT_QUERY,k).replace(t.PCT_ENCODED,o)),void 0!==e.fragment&&(e.fragment=String(e.fragment).replace(t.PCT_ENCODED,r).replace(t.NOT_FRAGMENT,k).replace(t.PCT_ENCODED,o)),e}function O(e){return e.replace(/^0*(.*)/,"$1")||"0"}function A(e,t){var r=e.match(t.IPV4ADDRESS)||[],n=c(r,2)[1];return n?n.split(".").map(O).join("."):e}function D(e,t){var r=e.match(t.IPV6ADDRESS)||[],n=c(r,3),o=n[1],i=n[2];if(o){for(var s=o.toLowerCase().split("::").reverse(),a=c(s,2),u=a[0],l=a[1],d=l?l.split(":").map(O):[],h=u.split(":").map(O),p=t.IPV4ADDRESS.test(h[h.length-1]),f=p?7:8,m=h.length-f,g=Array(f),v=0;v<f;++v)g[v]=d[v]||h[m+v]||"";p&&(g[f-1]=A(g[f-1],t));var y=g.reduce((function(e,t,r){if(!t||"0"===t){var n=e[e.length-1];n&&n.index+n.length===r?n.length++:e.push({index:r,length:1})}return e}),[]).sort((function(e,t){return t.length-e.length}))[0],_=void 0;if(y&&y.length>1){var b=g.slice(0,y.index),E=g.slice(y.index+y.length);_=b.join(":")+"::"+E.join(":")}else _=g.join(":");return i&&(_+="%"+i),_}return e}var C=/^(?:([^:\/?#]+):)?(?:\/\/((?:([^\/?#@]*)@)?(\[[^\/?#\]]+\]|[^\/?#:]*)(?:\:(\d*))?))?([^?#]*)(?:\?([^#]*))?(?:#((?:.|\n|\r)*))?/i,x=void 0==="".match(/(){0}/)[1];function M(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r={},n=!1!==t.iri?a:s;"suffix"===t.reference&&(e=(t.scheme?t.scheme+":":"")+"//"+e);var o=e.match(C);if(o){x?(r.scheme=o[1],r.userinfo=o[3],r.host=o[4],r.port=parseInt(o[5],10),r.path=o[6]||"",r.query=o[7],r.fragment=o[8],isNaN(r.port)&&(r.port=o[5])):(r.scheme=o[1]||void 0,r.userinfo=-1!==e.indexOf("@")?o[3]:void 0,r.host=-1!==e.indexOf("//")?o[4]:void 0,r.port=parseInt(o[5],10),r.path=o[6]||"",r.query=-1!==e.indexOf("?")?o[7]:void 0,r.fragment=-1!==e.indexOf("#")?o[8]:void 0,isNaN(r.port)&&(r.port=e.match(/\/\/(?:.|\n)*\:(?:\/|\?|\#|$)/)?o[4]:void 0)),r.host&&(r.host=D(A(r.host,n),n)),void 0!==r.scheme||void 0!==r.userinfo||void 0!==r.host||void 0!==r.port||r.path||void 0!==r.query?void 0===r.scheme?r.reference="relative":void 0===r.fragment?r.reference="absolute":r.reference="uri":r.reference="same-document",t.reference&&"suffix"!==t.reference&&t.reference!==r.reference&&(r.error=r.error||"URI is not a "+t.reference+" reference.");var i=I[(t.scheme||r.scheme||"").toLowerCase()];if(t.unicodeSupport||i&&i.unicodeSupport)T(r,n);else{if(r.host&&(t.domainHost||i&&i.domainHost))try{r.host=w(r.host.replace(n.PCT_ENCODED,P).toLowerCase())}catch(e){r.error=r.error||"Host's domain name can not be converted to ASCII via punycode: "+e}T(r,s)}i&&i.parse&&i.parse(r,t)}else r.error=r.error||"URI can not be parsed.";return r}function j(e,t){var r=!1!==t.iri?a:s,n=[];return void 0!==e.userinfo&&(n.push(e.userinfo),n.push("@")),void 0!==e.host&&n.push(D(A(String(e.host),r),r).replace(r.IPV6ADDRESS,(function(e,t,r){return"["+t+(r?"%25"+r:"")+"]"}))),"number"==typeof e.port&&(n.push(":"),n.push(e.port.toString(10))),n.length?n.join(""):void 0}var U=/^\.\.?\//,N=/^\/\.(\/|$)/,F=/^\/\.\.(\/|$)/,L=/^\/?(?:.|\n)*?(?=\/|$)/;function K(e){for(var t=[];e.length;)if(e.match(U))e=e.replace(U,"");else if(e.match(N))e=e.replace(N,"/");else if(e.match(F))e=e.replace(F,"/"),t.pop();else if("."===e||".."===e)e="";else{var r=e.match(L);if(!r)throw new Error("Unexpected dot segment condition");var n=r[0];e=e.slice(n.length),t.push(n)}return t.join("")}function B(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=t.iri?a:s,n=[],o=I[(t.scheme||e.scheme||"").toLowerCase()];if(o&&o.serialize&&o.serialize(e,t),e.host)if(r.IPV6ADDRESS.test(e.host));else if(t.domainHost||o&&o.domainHost)try{e.host=t.iri?R(e.host):w(e.host.replace(r.PCT_ENCODED,P).toLowerCase())}catch(r){e.error=e.error||"Host's domain name can not be converted to "+(t.iri?"Unicode":"ASCII")+" via punycode: "+r}T(e,r),"suffix"!==t.reference&&e.scheme&&(n.push(e.scheme),n.push(":"));var i=j(e,t);if(void 0!==i&&("suffix"!==t.reference&&n.push("//"),n.push(i),e.path&&"/"!==e.path.charAt(0)&&n.push("/")),void 0!==e.path){var c=e.path;t.absolutePath||o&&o.absolutePath||(c=K(c)),void 0===i&&(c=c.replace(/^\/\//,"/%2F")),n.push(c)}return void 0!==e.query&&(n.push("?"),n.push(e.query)),void 0!==e.fragment&&(n.push("#"),n.push(e.fragment)),n.join("")}function q(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments[3],o={};return n||(e=M(B(e,r),r),t=M(B(t,r),r)),!(r=r||{}).tolerant&&t.scheme?(o.scheme=t.scheme,o.userinfo=t.userinfo,o.host=t.host,o.port=t.port,o.path=K(t.path||""),o.query=t.query):(void 0!==t.userinfo||void 0!==t.host||void 0!==t.port?(o.userinfo=t.userinfo,o.host=t.host,o.port=t.port,o.path=K(t.path||""),o.query=t.query):(t.path?("/"===t.path.charAt(0)?o.path=K(t.path):(void 0===e.userinfo&&void 0===e.host&&void 0===e.port||e.path?e.path?o.path=e.path.slice(0,e.path.lastIndexOf("/")+1)+t.path:o.path=t.path:o.path="/"+t.path,o.path=K(o.path)),o.query=t.query):(o.path=e.path,void 0!==t.query?o.query=t.query:o.query=e.query),o.userinfo=e.userinfo,o.host=e.host,o.port=e.port),o.scheme=e.scheme),o.fragment=t.fragment,o}function $(e,t){return e&&e.toString().replace(t&&t.iri?a.PCT_ENCODED:s.PCT_ENCODED,P)}var V={scheme:"http",domainHost:!0,parse:function(e,t){return e.host||(e.error=e.error||"HTTP URIs must have a host."),e},serialize:function(e,t){return e.port!==("https"!==String(e.scheme).toLowerCase()?80:443)&&""!==e.port||(e.port=void 0),e.path||(e.path="/"),e}},G={scheme:"https",domainHost:V.domainHost,parse:V.parse,serialize:V.serialize},H={},z="[A-Za-z0-9\\-\\.\\_\\~\\xA0-\\u200D\\u2010-\\u2029\\u202F-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF]",W="[0-9A-Fa-f]",Q=r(r("%[EFef]"+W+"%"+W+W+"%"+W+W)+"|"+r("%[89A-Fa-f]"+W+"%"+W+W)+"|"+r("%"+W+W)),Y=t("[\\!\\$\\%\\'\\(\\)\\*\\+\\,\\-\\.0-9\\<\\>A-Z\\x5E-\\x7E]",'[\\"\\\\]'),X=new RegExp(z,"g"),J=new RegExp(Q,"g"),Z=new RegExp(t("[^]","[A-Za-z0-9\\!\\$\\%\\'\\*\\+\\-\\^\\_\\`\\{\\|\\}\\~]","[\\.]",'[\\"]',Y),"g"),ee=new RegExp(t("[^]",z,"[\\!\\$\\'\\(\\)\\*\\+\\,\\;\\:\\@]"),"g"),te=ee;function re(e){var t=P(e);return t.match(X)?t:e}var ne={scheme:"mailto",parse:function(e,t){var r=e,n=r.to=r.path?r.path.split(","):[];if(r.path=void 0,r.query){for(var o=!1,i={},s=r.query.split("&"),a=0,c=s.length;a<c;++a){var u=s[a].split("=");switch(u[0]){case"to":for(var l=u[1].split(","),d=0,h=l.length;d<h;++d)n.push(l[d]);break;case"subject":r.subject=$(u[1],t);break;case"body":r.body=$(u[1],t);break;default:o=!0,i[$(u[0],t)]=$(u[1],t)}}o&&(r.headers=i)}r.query=void 0;for(var p=0,f=n.length;p<f;++p){var m=n[p].split("@");if(m[0]=$(m[0]),t.unicodeSupport)m[1]=$(m[1],t).toLowerCase();else try{m[1]=w($(m[1],t).toLowerCase())}catch(e){r.error=r.error||"Email address's domain name can not be converted to ASCII via punycode: "+e}n[p]=m.join("@")}return r},serialize:function(e,t){var r,n=e,i=null!=(r=e.to)?r instanceof Array?r:"number"!=typeof r.length||r.split||r.setInterval||r.call?[r]:Array.prototype.slice.call(r):[];if(i){for(var s=0,a=i.length;s<a;++s){var c=String(i[s]),u=c.lastIndexOf("@"),l=c.slice(0,u).replace(J,re).replace(J,o).replace(Z,k),d=c.slice(u+1);try{d=t.iri?R(d):w($(d,t).toLowerCase())}catch(e){n.error=n.error||"Email address's domain name can not be converted to "+(t.iri?"Unicode":"ASCII")+" via punycode: "+e}i[s]=l+"@"+d}n.path=i.join(",")}var h=e.headers=e.headers||{};e.subject&&(h.subject=e.subject),e.body&&(h.body=e.body);var p=[];for(var f in h)h[f]!==H[f]&&p.push(f.replace(J,re).replace(J,o).replace(ee,k)+"="+h[f].replace(J,re).replace(J,o).replace(te,k));return p.length&&(n.query=p.join("&")),n}},oe=/^([^\:]+)\:(.*)/,ie={scheme:"urn",parse:function(e,t){var r=e.path&&e.path.match(oe),n=e;if(r){var o=t.scheme||n.scheme||"urn",i=r[1].toLowerCase(),s=r[2],a=o+":"+(t.nid||i),c=I[a];n.nid=i,n.nss=s,n.path=void 0,c&&(n=c.parse(n,t))}else n.error=n.error||"URN can not be parsed.";return n},serialize:function(e,t){var r=t.scheme||e.scheme||"urn",n=e.nid,o=r+":"+(t.nid||n),i=I[o];i&&(e=i.serialize(e,t));var s=e,a=e.nss;return s.path=(n||t.nid)+":"+a,s}},se=/^[0-9A-Fa-f]{8}(?:\-[0-9A-Fa-f]{4}){3}\-[0-9A-Fa-f]{12}$/,ae={scheme:"urn:uuid",parse:function(e,t){var r=e;return r.uuid=r.nss,r.nss=void 0,t.tolerant||r.uuid&&r.uuid.match(se)||(r.error=r.error||"UUID is not valid."),r},serialize:function(e,t){var r=e;return r.nss=(e.uuid||"").toLowerCase(),r}};I[V.scheme]=V,I[G.scheme]=G,I[ne.scheme]=ne,I[ie.scheme]=ie,I[ae.scheme]=ae,e.SCHEMES=I,e.pctEncChar=k,e.pctDecChars=P,e.parse=M,e.removeDotSegments=K,e.serialize=B,e.resolveComponents=q,e.resolve=function(e,t,r){var n=function(e,t){var r=e;if(t)for(var n in t)r[n]=t[n];return r}({scheme:"null"},r);return B(q(M(e,n),M(t,n),n,!0),n)},e.normalize=function(e,t){return"string"==typeof e?e=B(M(e,t),t):"object"===n(e)&&(e=M(B(e,t),t)),e},e.equal=function(e,t,r){return"string"==typeof e?e=B(M(e,r),r):"object"===n(e)&&(e=B(e,r)),"string"==typeof t?t=B(M(t,r),r):"object"===n(t)&&(t=B(t,r)),e===t},e.escapeComponent=function(e,t){return e&&e.toString().replace(t&&t.iri?a.ESCAPE:s.ESCAPE,k)},e.unescapeComponent=$,Object.defineProperty(e,"__esModule",{value:!0})}(t)},function(e,t,r){"use strict";e.exports=function(e){for(var t,r=0,n=e.length,o=0;o<n;)r++,(t=e.charCodeAt(o++))>=55296&&t<=56319&&o<n&&56320==(64512&(t=e.charCodeAt(o)))&&o++;return r}},function(e,t,r){"use strict";var n=e.exports=function(e,t,r){"function"==typeof t&&(r=t,t={}),function e(t,r,o,i,s,a,c,u,l,d){if(i&&"object"==typeof i&&!Array.isArray(i)){for(var h in r(i,s,a,c,u,l,d),i){var p=i[h];if(Array.isArray(p)){if(h in n.arrayKeywords)for(var f=0;f<p.length;f++)e(t,r,o,p[f],s+"/"+h+"/"+f,a,s,h,i,f)}else if(h in n.propsKeywords){if(p&&"object"==typeof p)for(var m in p)e(t,r,o,p[m],s+"/"+h+"/"+m.replace(/~/g,"~0").replace(/\//g,"~1"),a,s,h,i,m)}else(h in n.keywords||t.allKeys&&!(h in n.skipKeywords))&&e(t,r,o,p,s+"/"+h,a,s,h,i)}o(i,s,a,c,u,l,d)}}(t,"function"==typeof(r=t.cb||r)?r:r.pre||function(){},r.post||function(){},e,"",e)};n.keywords={additionalItems:!0,items:!0,contains:!0,additionalProperties:!0,propertyNames:!0,not:!0},n.arrayKeywords={items:!0,allOf:!0,anyOf:!0,oneOf:!0},n.propsKeywords={definitions:!0,properties:!0,patternProperties:!0,dependencies:!0},n.skipKeywords={default:!0,enum:!0,const:!0,required:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0}},function(e,t,r){"use strict";var n=e.exports=function(){this._cache={}};n.prototype.put=function(e,t){this._cache[e]=t},n.prototype.get=function(e){return this._cache[e]},n.prototype.del=function(e){delete this._cache[e]},n.prototype.clear=function(){this._cache={}}},function(e,t,r){"use strict";var n=r(25),o=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,i=[0,31,28,31,30,31,30,31,31,30,31,30,31],s=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,a=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,c=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,u=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,l=/^(?:(?:http[s\u017F]?|ftp):\/\/)(?:(?:[\0-\x08\x0E-\x1F!-\x9F\xA1-\u167F\u1681-\u1FFF\u200B-\u2027\u202A-\u202E\u2030-\u205E\u2060-\u2FFF\u3001-\uD7FF\uE000-\uFEFE\uFF00-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])+(?::(?:[\0-\x08\x0E-\x1F!-\x9F\xA1-\u167F\u1681-\u1FFF\u200B-\u2027\u202A-\u202E\u2030-\u205E\u2060-\u2FFF\u3001-\uD7FF\uE000-\uFEFE\uFF00-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*)?@)?(?:(?!10(?:\.[0-9]{1,3}){3})(?!127(?:\.[0-9]{1,3}){3})(?!169\.254(?:\.[0-9]{1,3}){2})(?!192\.168(?:\.[0-9]{1,3}){2})(?!172\.(?:1[6-9]|2[0-9]|3[01])(?:\.[0-9]{1,3}){2})(?:[1-9][0-9]?|1[0-9][0-9]|2[01][0-9]|22[0-3])(?:\.(?:1?[0-9]{1,2}|2[0-4][0-9]|25[0-5])){2}(?:\.(?:[1-9][0-9]?|1[0-9][0-9]|2[0-4][0-9]|25[0-4]))|(?:(?:(?:[0-9KSa-z\xA1-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])+-?)*(?:[0-9KSa-z\xA1-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])+)(?:\.(?:(?:[0-9KSa-z\xA1-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])+-?)*(?:[0-9KSa-z\xA1-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])+)*(?:\.(?:(?:[KSa-z\xA1-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]){2,})))(?::[0-9]{2,5})?(?:\/(?:[\0-\x08\x0E-\x1F!-\x9F\xA1-\u167F\u1681-\u1FFF\u200B-\u2027\u202A-\u202E\u2030-\u205E\u2060-\u2FFF\u3001-\uD7FF\uE000-\uFEFE\uFF00-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*)?$/i,d=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,h=/^(?:\/(?:[^~/]|~0|~1)*)*$/,p=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,f=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/;function m(e){return e="full"==e?"full":"fast",n.copy(m[e])}function g(e){var t=e.match(o);if(!t)return!1;var r=+t[1],n=+t[2],s=+t[3];return n>=1&&n<=12&&s>=1&&s<=(2==n&&function(e){return e%4==0&&(e%100!=0||e%400==0)}(r)?29:i[n])}function v(e,t){var r=e.match(s);if(!r)return!1;var n=r[1],o=r[2],i=r[3],a=r[5];return(n<=23&&o<=59&&i<=59||23==n&&59==o&&60==i)&&(!t||a)}e.exports=m,m.fast={date:/^\d\d\d\d-[0-1]\d-[0-3]\d$/,time:/^(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)?$/i,"date-time":/^\d\d\d\d-[0-1]\d-[0-3]\d[t\s](?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)$/i,uri:/^(?:[a-z][a-z0-9+-.]*:)(?:\/?\/)?[^\s]*$/i,"uri-reference":/^(?:(?:[a-z][a-z0-9+-.]*:)?\/?\/)?(?:[^\\\s#][^\s#]*)?(?:#[^\\\s]*)?$/i,"uri-template":u,url:l,email:/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?)*$/i,hostname:a,ipv4:/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,ipv6:/^\s*(?:(?:(?:[0-9a-f]{1,4}:){7}(?:[0-9a-f]{1,4}|:))|(?:(?:[0-9a-f]{1,4}:){6}(?::[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(?:(?:[0-9a-f]{1,4}:){5}(?:(?:(?::[0-9a-f]{1,4}){1,2})|:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(?:(?:[0-9a-f]{1,4}:){4}(?:(?:(?::[0-9a-f]{1,4}){1,3})|(?:(?::[0-9a-f]{1,4})?:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(?:(?:[0-9a-f]{1,4}:){3}(?:(?:(?::[0-9a-f]{1,4}){1,4})|(?:(?::[0-9a-f]{1,4}){0,2}:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(?:(?:[0-9a-f]{1,4}:){2}(?:(?:(?::[0-9a-f]{1,4}){1,5})|(?:(?::[0-9a-f]{1,4}){0,3}:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(?:(?:[0-9a-f]{1,4}:){1}(?:(?:(?::[0-9a-f]{1,4}){1,6})|(?:(?::[0-9a-f]{1,4}){0,4}:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(?::(?:(?:(?::[0-9a-f]{1,4}){1,7})|(?:(?::[0-9a-f]{1,4}){0,5}:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(?:%.+)?\s*$/i,regex:E,uuid:d,"json-pointer":h,"json-pointer-uri-fragment":p,"relative-json-pointer":f},m.full={date:g,time:v,"date-time":function(e){var t=e.split(y);return 2==t.length&&g(t[0])&&v(t[1],!0)},uri:function(e){return _.test(e)&&c.test(e)},"uri-reference":/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,"uri-template":u,url:l,email:/^[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$/i,hostname:a,ipv4:/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,ipv6:/^\s*(?:(?:(?:[0-9a-f]{1,4}:){7}(?:[0-9a-f]{1,4}|:))|(?:(?:[0-9a-f]{1,4}:){6}(?::[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(?:(?:[0-9a-f]{1,4}:){5}(?:(?:(?::[0-9a-f]{1,4}){1,2})|:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(?:(?:[0-9a-f]{1,4}:){4}(?:(?:(?::[0-9a-f]{1,4}){1,3})|(?:(?::[0-9a-f]{1,4})?:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(?:(?:[0-9a-f]{1,4}:){3}(?:(?:(?::[0-9a-f]{1,4}){1,4})|(?:(?::[0-9a-f]{1,4}){0,2}:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(?:(?:[0-9a-f]{1,4}:){2}(?:(?:(?::[0-9a-f]{1,4}){1,5})|(?:(?::[0-9a-f]{1,4}){0,3}:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(?:(?:[0-9a-f]{1,4}:){1}(?:(?:(?::[0-9a-f]{1,4}){1,6})|(?:(?::[0-9a-f]{1,4}){0,4}:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(?::(?:(?:(?::[0-9a-f]{1,4}){1,7})|(?:(?::[0-9a-f]{1,4}){0,5}:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(?:%.+)?\s*$/i,regex:E,uuid:d,"json-pointer":h,"json-pointer-uri-fragment":p,"relative-json-pointer":f};var y=/t|\s/i;var _=/\/|:/;var b=/[^\\]\\Z/;function E(e){if(b.test(e))return!1;try{return new RegExp(e),!0}catch(e){return!1}}},function(e,t,r){"use strict";var n=r(151),o=r(25).toHash;e.exports=function(){var e=[{type:"number",rules:[{maximum:["exclusiveMaximum"]},{minimum:["exclusiveMinimum"]},"multipleOf","format"]},{type:"string",rules:["maxLength","minLength","pattern","format"]},{type:"array",rules:["maxItems","minItems","items","contains","uniqueItems"]},{type:"object",rules:["maxProperties","minProperties","required","dependencies","propertyNames",{properties:["additionalProperties","patternProperties"]}]},{rules:["$ref","const","enum","not","anyOf","oneOf","allOf","if"]}],t=["type","$comment"];return e.all=o(t),e.types=o(["number","integer","string","array","object","boolean","null"]),e.forEach((function(r){r.rules=r.rules.map((function(r){var o;if("object"==typeof r){var i=Object.keys(r)[0];o=r[i],r=i,o.forEach((function(r){t.push(r),e.all[r]=!0}))}return t.push(r),e.all[r]={keyword:r,code:n[r],implements:o}})),e.all.$comment={keyword:"$comment",code:n.$comment},r.type&&(e.types[r.type]=r)})),e.keywords=o(t.concat(["$schema","$id","id","$data","$async","title","description","default","definitions","examples","readOnly","writeOnly","contentMediaType","contentEncoding","additionalItems","then","else"])),e.custom={},e}},function(e,t,r){"use strict";e.exports={$ref:r(152),allOf:r(153),anyOf:r(154),$comment:r(155),const:r(156),contains:r(157),dependencies:r(158),enum:r(159),format:r(160),if:r(161),items:r(162),maximum:r(77),minimum:r(77),maxItems:r(78),minItems:r(78),maxLength:r(79),minLength:r(79),maxProperties:r(80),minProperties:r(80),multipleOf:r(163),not:r(164),oneOf:r(165),pattern:r(166),properties:r(167),propertyNames:r(168),required:r(169),uniqueItems:r(170),validate:r(76)}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n,o,i=" ",s=e.level,a=e.dataLevel,c=e.schema[t],u=e.errSchemaPath+"/"+t,l=!e.opts.allErrors,d="data"+(a||""),h="valid"+s;if("#"==c||"#/"==c)e.isRoot?(n=e.async,o="validate"):(n=!0===e.root.schema.$async,o="root.refVal[0]");else{var p=e.resolveRef(e.baseId,c,e.isRoot);if(void 0===p){var f=e.MissingRefError.message(e.baseId,c);if("fail"==e.opts.missingRefs){e.logger.error(f),(y=y||[]).push(i),i="",!1!==e.createErrors?(i+=" { keyword: '$ref' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(u)+" , params: { ref: '"+e.util.escapeQuotes(c)+"' } ",!1!==e.opts.messages&&(i+=" , message: 'can\\'t resolve reference "+e.util.escapeQuotes(c)+"' "),e.opts.verbose&&(i+=" , schema: "+e.util.toQuotedString(c)+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+d+" "),i+=" } "):i+=" {} ";var m=i;i=y.pop(),!e.compositeRule&&l?e.async?i+=" throw new ValidationError(["+m+"]); ":i+=" validate.errors = ["+m+"]; return false; ":i+=" var err = "+m+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",l&&(i+=" if (false) { ")}else{if("ignore"!=e.opts.missingRefs)throw new e.MissingRefError(e.baseId,c,f);e.logger.warn(f),l&&(i+=" if (true) { ")}}else if(p.inline){var g=e.util.copy(e);g.level++;var v="valid"+g.level;g.schema=p.schema,g.schemaPath="",g.errSchemaPath=c,i+=" "+e.validate(g).replace(/validate\.schema/g,p.code)+" ",l&&(i+=" if ("+v+") { ")}else n=!0===p.$async||e.async&&!1!==p.$async,o=p.code}if(o){var y;(y=y||[]).push(i),i="",e.opts.passContext?i+=" "+o+".call(this, ":i+=" "+o+"( ",i+=" "+d+", (dataPath || '')",'""'!=e.errorPath&&(i+=" + "+e.errorPath);var _=i+=" , "+(a?"data"+(a-1||""):"parentData")+" , "+(a?e.dataPathArr[a]:"parentDataProperty")+", rootData)  ";if(i=y.pop(),n){if(!e.async)throw new Error("async schema referenced by sync schema");l&&(i+=" var "+h+"; "),i+=" try { await "+_+"; ",l&&(i+=" "+h+" = true; "),i+=" } catch (e) { if (!(e instanceof ValidationError)) throw e; if (vErrors === null) vErrors = e.errors; else vErrors = vErrors.concat(e.errors); errors = vErrors.length; ",l&&(i+=" "+h+" = false; "),i+=" } ",l&&(i+=" if ("+h+") { ")}else i+=" if (!"+_+") { if (vErrors === null) vErrors = "+o+".errors; else vErrors = vErrors.concat("+o+".errors); errors = vErrors.length; } ",l&&(i+=" else { ")}return i}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.schema[t],i=e.schemaPath+e.util.getProperty(t),s=e.errSchemaPath+"/"+t,a=!e.opts.allErrors,c=e.util.copy(e),u="";c.level++;var l="valid"+c.level,d=c.baseId,h=!0,p=o;if(p)for(var f,m=-1,g=p.length-1;m<g;)f=p[m+=1],(e.opts.strictKeywords?"object"==typeof f&&Object.keys(f).length>0:e.util.schemaHasRules(f,e.RULES.all))&&(h=!1,c.schema=f,c.schemaPath=i+"["+m+"]",c.errSchemaPath=s+"/"+m,n+="  "+e.validate(c)+" ",c.baseId=d,a&&(n+=" if ("+l+") { ",u+="}"));return a&&(n+=h?" if (true) { ":" "+u.slice(0,-1)+" "),n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="valid"+o,h="errs__"+o,p=e.util.copy(e),f="";p.level++;var m="valid"+p.level;if(s.every((function(t){return e.opts.strictKeywords?"object"==typeof t&&Object.keys(t).length>0:e.util.schemaHasRules(t,e.RULES.all)}))){var g=p.baseId;n+=" var "+h+" = errors; var "+d+" = false;  ";var v=e.compositeRule;e.compositeRule=p.compositeRule=!0;var y=s;if(y)for(var _,b=-1,E=y.length-1;b<E;)_=y[b+=1],p.schema=_,p.schemaPath=a+"["+b+"]",p.errSchemaPath=c+"/"+b,n+="  "+e.validate(p)+" ",p.baseId=g,n+=" "+d+" = "+d+" || "+m+"; if (!"+d+") { ",f+="}";e.compositeRule=p.compositeRule=v,n+=" "+f+" if (!"+d+") {   var err =   ",!1!==e.createErrors?(n+=" { keyword: 'anyOf' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: {} ",!1!==e.opts.messages&&(n+=" , message: 'should match some schema in anyOf' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ",n+=";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",!e.compositeRule&&u&&(e.async?n+=" throw new ValidationError(vErrors); ":n+=" validate.errors = vErrors; return false; "),n+=" } else {  errors = "+h+"; if (vErrors !== null) { if ("+h+") vErrors.length = "+h+"; else vErrors = null; } ",e.opts.allErrors&&(n+=" } ")}else u&&(n+=" if (true) { ");return n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.schema[t],i=e.errSchemaPath+"/"+t,s=(e.opts.allErrors,e.util.toQuotedString(o));return!0===e.opts.$comment?n+=" console.log("+s+");":"function"==typeof e.opts.$comment&&(n+=" self._opts.$comment("+s+", "+e.util.toQuotedString(i)+", validate.root.schema);"),n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="valid"+o,h=e.opts.$data&&s&&s.$data;h&&(n+=" var schema"+o+" = "+e.util.getData(s.$data,i,e.dataPathArr)+"; "),h||(n+=" var schema"+o+" = validate.schema"+a+";"),n+="var "+d+" = equal("+l+", schema"+o+"); if (!"+d+") {   ";var p=p||[];p.push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'const' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { allowedValue: schema"+o+" } ",!1!==e.opts.messages&&(n+=" , message: 'should be equal to constant' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ";var f=n;return n=p.pop(),!e.compositeRule&&u?e.async?n+=" throw new ValidationError(["+f+"]); ":n+=" validate.errors = ["+f+"]; return false; ":n+=" var err = "+f+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",n+=" }",u&&(n+=" else { "),n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="valid"+o,h="errs__"+o,p=e.util.copy(e);p.level++;var f="valid"+p.level,m="i"+o,g=p.dataLevel=e.dataLevel+1,v="data"+g,y=e.baseId,_=e.opts.strictKeywords?"object"==typeof s&&Object.keys(s).length>0:e.util.schemaHasRules(s,e.RULES.all);if(n+="var "+h+" = errors;var "+d+";",_){var b=e.compositeRule;e.compositeRule=p.compositeRule=!0,p.schema=s,p.schemaPath=a,p.errSchemaPath=c,n+=" var "+f+" = false; for (var "+m+" = 0; "+m+" < "+l+".length; "+m+"++) { ",p.errorPath=e.util.getPathExpr(e.errorPath,m,e.opts.jsonPointers,!0);var E=l+"["+m+"]";p.dataPathArr[g]=m;var S=e.validate(p);p.baseId=y,e.util.varOccurences(S,v)<2?n+=" "+e.util.varReplace(S,v,E)+" ":n+=" var "+v+" = "+E+"; "+S+" ",n+=" if ("+f+") break; }  ",e.compositeRule=p.compositeRule=b,n+="  if (!"+f+") {"}else n+=" if ("+l+".length == 0) {";var w=w||[];w.push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'contains' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: {} ",!1!==e.opts.messages&&(n+=" , message: 'should contain a valid item' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ";var R=n;return n=w.pop(),!e.compositeRule&&u?e.async?n+=" throw new ValidationError(["+R+"]); ":n+=" validate.errors = ["+R+"]; return false; ":n+=" var err = "+R+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",n+=" } else { ",_&&(n+="  errors = "+h+"; if (vErrors !== null) { if ("+h+") vErrors.length = "+h+"; else vErrors = null; } "),e.opts.allErrors&&(n+=" } "),n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="errs__"+o,h=e.util.copy(e),p="";h.level++;var f="valid"+h.level,m={},g={},v=e.opts.ownProperties;for(E in s)if("__proto__"!=E){var y=s[E],_=Array.isArray(y)?g:m;_[E]=y}n+="var "+d+" = errors;";var b=e.errorPath;for(var E in n+="var missing"+o+";",g)if((_=g[E]).length){if(n+=" if ( "+l+e.util.getProperty(E)+" !== undefined ",v&&(n+=" && Object.prototype.hasOwnProperty.call("+l+", '"+e.util.escapeQuotes(E)+"') "),u){n+=" && ( ";var S=_;if(S)for(var w=-1,R=S.length-1;w<R;){A=S[w+=1],w&&(n+=" || "),n+=" ( ( "+(M=l+(x=e.util.getProperty(A)))+" === undefined ",v&&(n+=" || ! Object.prototype.hasOwnProperty.call("+l+", '"+e.util.escapeQuotes(A)+"') "),n+=") && (missing"+o+" = "+e.util.toQuotedString(e.opts.jsonPointers?A:x)+") ) "}n+=")) {  ";var I="missing"+o,k="' + "+I+" + '";e.opts._errorDataPathProperty&&(e.errorPath=e.opts.jsonPointers?e.util.getPathExpr(b,I,!0):b+" + "+I);var P=P||[];P.push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'dependencies' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { property: '"+e.util.escapeQuotes(E)+"', missingProperty: '"+k+"', depsCount: "+_.length+", deps: '"+e.util.escapeQuotes(1==_.length?_[0]:_.join(", "))+"' } ",!1!==e.opts.messages&&(n+=" , message: 'should have ",1==_.length?n+="property "+e.util.escapeQuotes(_[0]):n+="properties "+e.util.escapeQuotes(_.join(", ")),n+=" when property "+e.util.escapeQuotes(E)+" is present' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ";var T=n;n=P.pop(),!e.compositeRule&&u?e.async?n+=" throw new ValidationError(["+T+"]); ":n+=" validate.errors = ["+T+"]; return false; ":n+=" var err = "+T+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; "}else{n+=" ) { ";var O=_;if(O)for(var A,D=-1,C=O.length-1;D<C;){A=O[D+=1];var x=e.util.getProperty(A),M=(k=e.util.escapeQuotes(A),l+x);e.opts._errorDataPathProperty&&(e.errorPath=e.util.getPath(b,A,e.opts.jsonPointers)),n+=" if ( "+M+" === undefined ",v&&(n+=" || ! Object.prototype.hasOwnProperty.call("+l+", '"+e.util.escapeQuotes(A)+"') "),n+=") {  var err =   ",!1!==e.createErrors?(n+=" { keyword: 'dependencies' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { property: '"+e.util.escapeQuotes(E)+"', missingProperty: '"+k+"', depsCount: "+_.length+", deps: '"+e.util.escapeQuotes(1==_.length?_[0]:_.join(", "))+"' } ",!1!==e.opts.messages&&(n+=" , message: 'should have ",1==_.length?n+="property "+e.util.escapeQuotes(_[0]):n+="properties "+e.util.escapeQuotes(_.join(", ")),n+=" when property "+e.util.escapeQuotes(E)+" is present' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ",n+=";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; } "}}n+=" }   ",u&&(p+="}",n+=" else { ")}e.errorPath=b;var j=h.baseId;for(var E in m){y=m[E];(e.opts.strictKeywords?"object"==typeof y&&Object.keys(y).length>0:e.util.schemaHasRules(y,e.RULES.all))&&(n+=" "+f+" = true; if ( "+l+e.util.getProperty(E)+" !== undefined ",v&&(n+=" && Object.prototype.hasOwnProperty.call("+l+", '"+e.util.escapeQuotes(E)+"') "),n+=") { ",h.schema=y,h.schemaPath=a+e.util.getProperty(E),h.errSchemaPath=c+"/"+e.util.escapeFragment(E),n+="  "+e.validate(h)+" ",h.baseId=j,n+=" }  ",u&&(n+=" if ("+f+") { ",p+="}"))}return u&&(n+="   "+p+" if ("+d+" == errors) {"),n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="valid"+o,h=e.opts.$data&&s&&s.$data;h&&(n+=" var schema"+o+" = "+e.util.getData(s.$data,i,e.dataPathArr)+"; ");var p="i"+o,f="schema"+o;h||(n+=" var "+f+" = validate.schema"+a+";"),n+="var "+d+";",h&&(n+=" if (schema"+o+" === undefined) "+d+" = true; else if (!Array.isArray(schema"+o+")) "+d+" = false; else {"),n+=d+" = false;for (var "+p+"=0; "+p+"<"+f+".length; "+p+"++) if (equal("+l+", "+f+"["+p+"])) { "+d+" = true; break; }",h&&(n+="  }  "),n+=" if (!"+d+") {   ";var m=m||[];m.push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'enum' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { allowedValues: schema"+o+" } ",!1!==e.opts.messages&&(n+=" , message: 'should be equal to one of the allowed values' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ";var g=n;return n=m.pop(),!e.compositeRule&&u?e.async?n+=" throw new ValidationError(["+g+"]); ":n+=" validate.errors = ["+g+"]; return false; ":n+=" var err = "+g+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",n+=" }",u&&(n+=" else { "),n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||"");if(!1===e.opts.format)return u&&(n+=" if (true) { "),n;var d,h=e.opts.$data&&s&&s.$data;h?(n+=" var schema"+o+" = "+e.util.getData(s.$data,i,e.dataPathArr)+"; ",d="schema"+o):d=s;var p=e.opts.unknownFormats,f=Array.isArray(p);if(h){n+=" var "+(m="format"+o)+" = formats["+d+"]; var "+(g="isObject"+o)+" = typeof "+m+" == 'object' && !("+m+" instanceof RegExp) && "+m+".validate; var "+(v="formatType"+o)+" = "+g+" && "+m+".type || 'string'; if ("+g+") { ",e.async&&(n+=" var async"+o+" = "+m+".async; "),n+=" "+m+" = "+m+".validate; } if (  ",h&&(n+=" ("+d+" !== undefined && typeof "+d+" != 'string') || "),n+=" (","ignore"!=p&&(n+=" ("+d+" && !"+m+" ",f&&(n+=" && self._opts.unknownFormats.indexOf("+d+") == -1 "),n+=") || "),n+=" ("+m+" && "+v+" == '"+r+"' && !(typeof "+m+" == 'function' ? ",e.async?n+=" (async"+o+" ? await "+m+"("+l+") : "+m+"("+l+")) ":n+=" "+m+"("+l+") ",n+=" : "+m+".test("+l+"))))) {"}else{var m;if(!(m=e.formats[s])){if("ignore"==p)return e.logger.warn('unknown format "'+s+'" ignored in schema at path "'+e.errSchemaPath+'"'),u&&(n+=" if (true) { "),n;if(f&&p.indexOf(s)>=0)return u&&(n+=" if (true) { "),n;throw new Error('unknown format "'+s+'" is used in schema at path "'+e.errSchemaPath+'"')}var g,v=(g="object"==typeof m&&!(m instanceof RegExp)&&m.validate)&&m.type||"string";if(g){var y=!0===m.async;m=m.validate}if(v!=r)return u&&(n+=" if (true) { "),n;if(y){if(!e.async)throw new Error("async format in sync schema");n+=" if (!(await "+(_="formats"+e.util.getProperty(s)+".validate")+"("+l+"))) { "}else{n+=" if (! ";var _="formats"+e.util.getProperty(s);g&&(_+=".validate"),n+="function"==typeof m?" "+_+"("+l+") ":" "+_+".test("+l+") ",n+=") { "}}var b=b||[];b.push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'format' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { format:  ",n+=h?""+d:""+e.util.toQuotedString(s),n+="  } ",!1!==e.opts.messages&&(n+=" , message: 'should match format \"",n+=h?"' + "+d+" + '":""+e.util.escapeQuotes(s),n+="\"' "),e.opts.verbose&&(n+=" , schema:  ",n+=h?"validate.schema"+a:""+e.util.toQuotedString(s),n+="         , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ";var E=n;return n=b.pop(),!e.compositeRule&&u?e.async?n+=" throw new ValidationError(["+E+"]); ":n+=" validate.errors = ["+E+"]; return false; ":n+=" var err = "+E+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",n+=" } ",u&&(n+=" else { "),n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="valid"+o,h="errs__"+o,p=e.util.copy(e);p.level++;var f="valid"+p.level,m=e.schema.then,g=e.schema.else,v=void 0!==m&&(e.opts.strictKeywords?"object"==typeof m&&Object.keys(m).length>0:e.util.schemaHasRules(m,e.RULES.all)),y=void 0!==g&&(e.opts.strictKeywords?"object"==typeof g&&Object.keys(g).length>0:e.util.schemaHasRules(g,e.RULES.all)),_=p.baseId;if(v||y){var b;p.createErrors=!1,p.schema=s,p.schemaPath=a,p.errSchemaPath=c,n+=" var "+h+" = errors; var "+d+" = true;  ";var E=e.compositeRule;e.compositeRule=p.compositeRule=!0,n+="  "+e.validate(p)+" ",p.baseId=_,p.createErrors=!0,n+="  errors = "+h+"; if (vErrors !== null) { if ("+h+") vErrors.length = "+h+"; else vErrors = null; }  ",e.compositeRule=p.compositeRule=E,v?(n+=" if ("+f+") {  ",p.schema=e.schema.then,p.schemaPath=e.schemaPath+".then",p.errSchemaPath=e.errSchemaPath+"/then",n+="  "+e.validate(p)+" ",p.baseId=_,n+=" "+d+" = "+f+"; ",v&&y?n+=" var "+(b="ifClause"+o)+" = 'then'; ":b="'then'",n+=" } ",y&&(n+=" else { ")):n+=" if (!"+f+") { ",y&&(p.schema=e.schema.else,p.schemaPath=e.schemaPath+".else",p.errSchemaPath=e.errSchemaPath+"/else",n+="  "+e.validate(p)+" ",p.baseId=_,n+=" "+d+" = "+f+"; ",v&&y?n+=" var "+(b="ifClause"+o)+" = 'else'; ":b="'else'",n+=" } "),n+=" if (!"+d+") {   var err =   ",!1!==e.createErrors?(n+=" { keyword: 'if' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { failingKeyword: "+b+" } ",!1!==e.opts.messages&&(n+=" , message: 'should match \"' + "+b+" + '\" schema' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ",n+=";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",!e.compositeRule&&u&&(e.async?n+=" throw new ValidationError(vErrors); ":n+=" validate.errors = vErrors; return false; "),n+=" }   ",u&&(n+=" else { ")}else u&&(n+=" if (true) { ");return n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="valid"+o,h="errs__"+o,p=e.util.copy(e),f="";p.level++;var m="valid"+p.level,g="i"+o,v=p.dataLevel=e.dataLevel+1,y="data"+v,_=e.baseId;if(n+="var "+h+" = errors;var "+d+";",Array.isArray(s)){var b=e.schema.additionalItems;if(!1===b){n+=" "+d+" = "+l+".length <= "+s.length+"; ";var E=c;c=e.errSchemaPath+"/additionalItems",n+="  if (!"+d+") {   ";var S=S||[];S.push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'additionalItems' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { limit: "+s.length+" } ",!1!==e.opts.messages&&(n+=" , message: 'should NOT have more than "+s.length+" items' "),e.opts.verbose&&(n+=" , schema: false , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ";var w=n;n=S.pop(),!e.compositeRule&&u?e.async?n+=" throw new ValidationError(["+w+"]); ":n+=" validate.errors = ["+w+"]; return false; ":n+=" var err = "+w+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",n+=" } ",c=E,u&&(f+="}",n+=" else { ")}var R=s;if(R)for(var I,k=-1,P=R.length-1;k<P;)if(I=R[k+=1],e.opts.strictKeywords?"object"==typeof I&&Object.keys(I).length>0:e.util.schemaHasRules(I,e.RULES.all)){n+=" "+m+" = true; if ("+l+".length > "+k+") { ";var T=l+"["+k+"]";p.schema=I,p.schemaPath=a+"["+k+"]",p.errSchemaPath=c+"/"+k,p.errorPath=e.util.getPathExpr(e.errorPath,k,e.opts.jsonPointers,!0),p.dataPathArr[v]=k;var O=e.validate(p);p.baseId=_,e.util.varOccurences(O,y)<2?n+=" "+e.util.varReplace(O,y,T)+" ":n+=" var "+y+" = "+T+"; "+O+" ",n+=" }  ",u&&(n+=" if ("+m+") { ",f+="}")}if("object"==typeof b&&(e.opts.strictKeywords?"object"==typeof b&&Object.keys(b).length>0:e.util.schemaHasRules(b,e.RULES.all))){p.schema=b,p.schemaPath=e.schemaPath+".additionalItems",p.errSchemaPath=e.errSchemaPath+"/additionalItems",n+=" "+m+" = true; if ("+l+".length > "+s.length+") {  for (var "+g+" = "+s.length+"; "+g+" < "+l+".length; "+g+"++) { ",p.errorPath=e.util.getPathExpr(e.errorPath,g,e.opts.jsonPointers,!0);T=l+"["+g+"]";p.dataPathArr[v]=g;O=e.validate(p);p.baseId=_,e.util.varOccurences(O,y)<2?n+=" "+e.util.varReplace(O,y,T)+" ":n+=" var "+y+" = "+T+"; "+O+" ",u&&(n+=" if (!"+m+") break; "),n+=" } }  ",u&&(n+=" if ("+m+") { ",f+="}")}}else if(e.opts.strictKeywords?"object"==typeof s&&Object.keys(s).length>0:e.util.schemaHasRules(s,e.RULES.all)){p.schema=s,p.schemaPath=a,p.errSchemaPath=c,n+="  for (var "+g+" = 0; "+g+" < "+l+".length; "+g+"++) { ",p.errorPath=e.util.getPathExpr(e.errorPath,g,e.opts.jsonPointers,!0);T=l+"["+g+"]";p.dataPathArr[v]=g;O=e.validate(p);p.baseId=_,e.util.varOccurences(O,y)<2?n+=" "+e.util.varReplace(O,y,T)+" ":n+=" var "+y+" = "+T+"; "+O+" ",u&&(n+=" if (!"+m+") break; "),n+=" }"}return u&&(n+=" "+f+" if ("+h+" == errors) {"),n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n,o=" ",i=e.level,s=e.dataLevel,a=e.schema[t],c=e.schemaPath+e.util.getProperty(t),u=e.errSchemaPath+"/"+t,l=!e.opts.allErrors,d="data"+(s||""),h=e.opts.$data&&a&&a.$data;if(h?(o+=" var schema"+i+" = "+e.util.getData(a.$data,s,e.dataPathArr)+"; ",n="schema"+i):n=a,!h&&"number"!=typeof a)throw new Error(t+" must be number");o+="var division"+i+";if (",h&&(o+=" "+n+" !== undefined && ( typeof "+n+" != 'number' || "),o+=" (division"+i+" = "+d+" / "+n+", ",e.opts.multipleOfPrecision?o+=" Math.abs(Math.round(division"+i+") - division"+i+") > 1e-"+e.opts.multipleOfPrecision+" ":o+=" division"+i+" !== parseInt(division"+i+") ",o+=" ) ",h&&(o+="  )  "),o+=" ) {   ";var p=p||[];p.push(o),o="",!1!==e.createErrors?(o+=" { keyword: 'multipleOf' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(u)+" , params: { multipleOf: "+n+" } ",!1!==e.opts.messages&&(o+=" , message: 'should be multiple of ",o+=h?"' + "+n:n+"'"),e.opts.verbose&&(o+=" , schema:  ",o+=h?"validate.schema"+c:""+a,o+="         , parentSchema: validate.schema"+e.schemaPath+" , data: "+d+" "),o+=" } "):o+=" {} ";var f=o;return o=p.pop(),!e.compositeRule&&l?e.async?o+=" throw new ValidationError(["+f+"]); ":o+=" validate.errors = ["+f+"]; return false; ":o+=" var err = "+f+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",o+="} ",l&&(o+=" else { "),o}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="errs__"+o,h=e.util.copy(e);h.level++;var p="valid"+h.level;if(e.opts.strictKeywords?"object"==typeof s&&Object.keys(s).length>0:e.util.schemaHasRules(s,e.RULES.all)){h.schema=s,h.schemaPath=a,h.errSchemaPath=c,n+=" var "+d+" = errors;  ";var f,m=e.compositeRule;e.compositeRule=h.compositeRule=!0,h.createErrors=!1,h.opts.allErrors&&(f=h.opts.allErrors,h.opts.allErrors=!1),n+=" "+e.validate(h)+" ",h.createErrors=!0,f&&(h.opts.allErrors=f),e.compositeRule=h.compositeRule=m,n+=" if ("+p+") {   ";var g=g||[];g.push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'not' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: {} ",!1!==e.opts.messages&&(n+=" , message: 'should NOT be valid' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ";var v=n;n=g.pop(),!e.compositeRule&&u?e.async?n+=" throw new ValidationError(["+v+"]); ":n+=" validate.errors = ["+v+"]; return false; ":n+=" var err = "+v+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",n+=" } else {  errors = "+d+"; if (vErrors !== null) { if ("+d+") vErrors.length = "+d+"; else vErrors = null; } ",e.opts.allErrors&&(n+=" } ")}else n+="  var err =   ",!1!==e.createErrors?(n+=" { keyword: 'not' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: {} ",!1!==e.opts.messages&&(n+=" , message: 'should NOT be valid' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ",n+=";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",u&&(n+=" if (false) { ");return n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="valid"+o,h="errs__"+o,p=e.util.copy(e),f="";p.level++;var m="valid"+p.level,g=p.baseId,v="prevValid"+o,y="passingSchemas"+o;n+="var "+h+" = errors , "+v+" = false , "+d+" = false , "+y+" = null; ";var _=e.compositeRule;e.compositeRule=p.compositeRule=!0;var b=s;if(b)for(var E,S=-1,w=b.length-1;S<w;)E=b[S+=1],(e.opts.strictKeywords?"object"==typeof E&&Object.keys(E).length>0:e.util.schemaHasRules(E,e.RULES.all))?(p.schema=E,p.schemaPath=a+"["+S+"]",p.errSchemaPath=c+"/"+S,n+="  "+e.validate(p)+" ",p.baseId=g):n+=" var "+m+" = true; ",S&&(n+=" if ("+m+" && "+v+") { "+d+" = false; "+y+" = ["+y+", "+S+"]; } else { ",f+="}"),n+=" if ("+m+") { "+d+" = "+v+" = true; "+y+" = "+S+"; }";return e.compositeRule=p.compositeRule=_,n+=f+"if (!"+d+") {   var err =   ",!1!==e.createErrors?(n+=" { keyword: 'oneOf' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { passingSchemas: "+y+" } ",!1!==e.opts.messages&&(n+=" , message: 'should match exactly one schema in oneOf' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ",n+=";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",!e.compositeRule&&u&&(e.async?n+=" throw new ValidationError(vErrors); ":n+=" validate.errors = vErrors; return false; "),n+="} else {  errors = "+h+"; if (vErrors !== null) { if ("+h+") vErrors.length = "+h+"; else vErrors = null; }",e.opts.allErrors&&(n+=" } "),n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n,o=" ",i=e.level,s=e.dataLevel,a=e.schema[t],c=e.schemaPath+e.util.getProperty(t),u=e.errSchemaPath+"/"+t,l=!e.opts.allErrors,d="data"+(s||""),h=e.opts.$data&&a&&a.$data;h?(o+=" var schema"+i+" = "+e.util.getData(a.$data,s,e.dataPathArr)+"; ",n="schema"+i):n=a,o+="if ( ",h&&(o+=" ("+n+" !== undefined && typeof "+n+" != 'string') || "),o+=" !"+(h?"(new RegExp("+n+"))":e.usePattern(a))+".test("+d+") ) {   ";var p=p||[];p.push(o),o="",!1!==e.createErrors?(o+=" { keyword: 'pattern' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(u)+" , params: { pattern:  ",o+=h?""+n:""+e.util.toQuotedString(a),o+="  } ",!1!==e.opts.messages&&(o+=" , message: 'should match pattern \"",o+=h?"' + "+n+" + '":""+e.util.escapeQuotes(a),o+="\"' "),e.opts.verbose&&(o+=" , schema:  ",o+=h?"validate.schema"+c:""+e.util.toQuotedString(a),o+="         , parentSchema: validate.schema"+e.schemaPath+" , data: "+d+" "),o+=" } "):o+=" {} ";var f=o;return o=p.pop(),!e.compositeRule&&l?e.async?o+=" throw new ValidationError(["+f+"]); ":o+=" validate.errors = ["+f+"]; return false; ":o+=" var err = "+f+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",o+="} ",l&&(o+=" else { "),o}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="errs__"+o,h=e.util.copy(e),p="";h.level++;var f="valid"+h.level,m="key"+o,g="idx"+o,v=h.dataLevel=e.dataLevel+1,y="data"+v,_="dataProperties"+o,b=Object.keys(s||{}).filter(x),E=e.schema.patternProperties||{},S=Object.keys(E).filter(x),w=e.schema.additionalProperties,R=b.length||S.length,I=!1===w,k="object"==typeof w&&Object.keys(w).length,P=e.opts.removeAdditional,T=I||k||P,O=e.opts.ownProperties,A=e.baseId,D=e.schema.required;if(D&&(!e.opts.$data||!D.$data)&&D.length<e.opts.loopRequired)var C=e.util.toHash(D);function x(e){return"__proto__"!==e}if(n+="var "+d+" = errors;var "+f+" = true;",O&&(n+=" var "+_+" = undefined;"),T){if(n+=O?" "+_+" = "+_+" || Object.keys("+l+"); for (var "+g+"=0; "+g+"<"+_+".length; "+g+"++) { var "+m+" = "+_+"["+g+"]; ":" for (var "+m+" in "+l+") { ",R){if(n+=" var isAdditional"+o+" = !(false ",b.length)if(b.length>8)n+=" || validate.schema"+a+".hasOwnProperty("+m+") ";else{var M=b;if(M)for(var j=-1,U=M.length-1;j<U;)Q=M[j+=1],n+=" || "+m+" == "+e.util.toQuotedString(Q)+" "}if(S.length){var N=S;if(N)for(var F=-1,L=N.length-1;F<L;)ie=N[F+=1],n+=" || "+e.usePattern(ie)+".test("+m+") "}n+=" ); if (isAdditional"+o+") { "}if("all"==P)n+=" delete "+l+"["+m+"]; ";else{var K=e.errorPath,B="' + "+m+" + '";if(e.opts._errorDataPathProperty&&(e.errorPath=e.util.getPathExpr(e.errorPath,m,e.opts.jsonPointers)),I)if(P)n+=" delete "+l+"["+m+"]; ";else{n+=" "+f+" = false; ";var q=c;c=e.errSchemaPath+"/additionalProperties",(re=re||[]).push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'additionalProperties' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { additionalProperty: '"+B+"' } ",!1!==e.opts.messages&&(n+=" , message: '",e.opts._errorDataPathProperty?n+="is an invalid additional property":n+="should NOT have additional properties",n+="' "),e.opts.verbose&&(n+=" , schema: false , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ";var $=n;n=re.pop(),!e.compositeRule&&u?e.async?n+=" throw new ValidationError(["+$+"]); ":n+=" validate.errors = ["+$+"]; return false; ":n+=" var err = "+$+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",c=q,u&&(n+=" break; ")}else if(k)if("failing"==P){n+=" var "+d+" = errors;  ";var V=e.compositeRule;e.compositeRule=h.compositeRule=!0,h.schema=w,h.schemaPath=e.schemaPath+".additionalProperties",h.errSchemaPath=e.errSchemaPath+"/additionalProperties",h.errorPath=e.opts._errorDataPathProperty?e.errorPath:e.util.getPathExpr(e.errorPath,m,e.opts.jsonPointers);var G=l+"["+m+"]";h.dataPathArr[v]=m;var H=e.validate(h);h.baseId=A,e.util.varOccurences(H,y)<2?n+=" "+e.util.varReplace(H,y,G)+" ":n+=" var "+y+" = "+G+"; "+H+" ",n+=" if (!"+f+") { errors = "+d+"; if (validate.errors !== null) { if (errors) validate.errors.length = errors; else validate.errors = null; } delete "+l+"["+m+"]; }  ",e.compositeRule=h.compositeRule=V}else{h.schema=w,h.schemaPath=e.schemaPath+".additionalProperties",h.errSchemaPath=e.errSchemaPath+"/additionalProperties",h.errorPath=e.opts._errorDataPathProperty?e.errorPath:e.util.getPathExpr(e.errorPath,m,e.opts.jsonPointers);G=l+"["+m+"]";h.dataPathArr[v]=m;H=e.validate(h);h.baseId=A,e.util.varOccurences(H,y)<2?n+=" "+e.util.varReplace(H,y,G)+" ":n+=" var "+y+" = "+G+"; "+H+" ",u&&(n+=" if (!"+f+") break; ")}e.errorPath=K}R&&(n+=" } "),n+=" }  ",u&&(n+=" if ("+f+") { ",p+="}")}var z=e.opts.useDefaults&&!e.compositeRule;if(b.length){var W=b;if(W)for(var Q,Y=-1,X=W.length-1;Y<X;){var J=s[Q=W[Y+=1]];if(e.opts.strictKeywords?"object"==typeof J&&Object.keys(J).length>0:e.util.schemaHasRules(J,e.RULES.all)){var Z=e.util.getProperty(Q),ee=(G=l+Z,z&&void 0!==J.default);h.schema=J,h.schemaPath=a+Z,h.errSchemaPath=c+"/"+e.util.escapeFragment(Q),h.errorPath=e.util.getPath(e.errorPath,Q,e.opts.jsonPointers),h.dataPathArr[v]=e.util.toQuotedString(Q);H=e.validate(h);if(h.baseId=A,e.util.varOccurences(H,y)<2){H=e.util.varReplace(H,y,G);var te=G}else{te=y;n+=" var "+y+" = "+G+"; "}if(ee)n+=" "+H+" ";else{if(C&&C[Q]){n+=" if ( "+te+" === undefined ",O&&(n+=" || ! Object.prototype.hasOwnProperty.call("+l+", '"+e.util.escapeQuotes(Q)+"') "),n+=") { "+f+" = false; ";K=e.errorPath,q=c;var re,ne=e.util.escapeQuotes(Q);e.opts._errorDataPathProperty&&(e.errorPath=e.util.getPath(K,Q,e.opts.jsonPointers)),c=e.errSchemaPath+"/required",(re=re||[]).push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'required' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { missingProperty: '"+ne+"' } ",!1!==e.opts.messages&&(n+=" , message: '",e.opts._errorDataPathProperty?n+="is a required property":n+="should have required property \\'"+ne+"\\'",n+="' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ";$=n;n=re.pop(),!e.compositeRule&&u?e.async?n+=" throw new ValidationError(["+$+"]); ":n+=" validate.errors = ["+$+"]; return false; ":n+=" var err = "+$+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",c=q,e.errorPath=K,n+=" } else { "}else u?(n+=" if ( "+te+" === undefined ",O&&(n+=" || ! Object.prototype.hasOwnProperty.call("+l+", '"+e.util.escapeQuotes(Q)+"') "),n+=") { "+f+" = true; } else { "):(n+=" if ("+te+" !== undefined ",O&&(n+=" &&   Object.prototype.hasOwnProperty.call("+l+", '"+e.util.escapeQuotes(Q)+"') "),n+=" ) { ");n+=" "+H+" } "}}u&&(n+=" if ("+f+") { ",p+="}")}}if(S.length){var oe=S;if(oe)for(var ie,se=-1,ae=oe.length-1;se<ae;){J=E[ie=oe[se+=1]];if(e.opts.strictKeywords?"object"==typeof J&&Object.keys(J).length>0:e.util.schemaHasRules(J,e.RULES.all)){h.schema=J,h.schemaPath=e.schemaPath+".patternProperties"+e.util.getProperty(ie),h.errSchemaPath=e.errSchemaPath+"/patternProperties/"+e.util.escapeFragment(ie),n+=O?" "+_+" = "+_+" || Object.keys("+l+"); for (var "+g+"=0; "+g+"<"+_+".length; "+g+"++) { var "+m+" = "+_+"["+g+"]; ":" for (var "+m+" in "+l+") { ",n+=" if ("+e.usePattern(ie)+".test("+m+")) { ",h.errorPath=e.util.getPathExpr(e.errorPath,m,e.opts.jsonPointers);G=l+"["+m+"]";h.dataPathArr[v]=m;H=e.validate(h);h.baseId=A,e.util.varOccurences(H,y)<2?n+=" "+e.util.varReplace(H,y,G)+" ":n+=" var "+y+" = "+G+"; "+H+" ",u&&(n+=" if (!"+f+") break; "),n+=" } ",u&&(n+=" else "+f+" = true; "),n+=" }  ",u&&(n+=" if ("+f+") { ",p+="}")}}}return u&&(n+=" "+p+" if ("+d+" == errors) {"),n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="errs__"+o,h=e.util.copy(e);h.level++;var p="valid"+h.level;if(n+="var "+d+" = errors;",e.opts.strictKeywords?"object"==typeof s&&Object.keys(s).length>0:e.util.schemaHasRules(s,e.RULES.all)){h.schema=s,h.schemaPath=a,h.errSchemaPath=c;var f="key"+o,m="idx"+o,g="i"+o,v="' + "+f+" + '",y="data"+(h.dataLevel=e.dataLevel+1),_="dataProperties"+o,b=e.opts.ownProperties,E=e.baseId;b&&(n+=" var "+_+" = undefined; "),n+=b?" "+_+" = "+_+" || Object.keys("+l+"); for (var "+m+"=0; "+m+"<"+_+".length; "+m+"++) { var "+f+" = "+_+"["+m+"]; ":" for (var "+f+" in "+l+") { ",n+=" var startErrs"+o+" = errors; ";var S=f,w=e.compositeRule;e.compositeRule=h.compositeRule=!0;var R=e.validate(h);h.baseId=E,e.util.varOccurences(R,y)<2?n+=" "+e.util.varReplace(R,y,S)+" ":n+=" var "+y+" = "+S+"; "+R+" ",e.compositeRule=h.compositeRule=w,n+=" if (!"+p+") { for (var "+g+"=startErrs"+o+"; "+g+"<errors; "+g+"++) { vErrors["+g+"].propertyName = "+f+"; }   var err =   ",!1!==e.createErrors?(n+=" { keyword: 'propertyNames' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { propertyName: '"+v+"' } ",!1!==e.opts.messages&&(n+=" , message: 'property name \\'"+v+"\\' is invalid' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ",n+=";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",!e.compositeRule&&u&&(e.async?n+=" throw new ValidationError(vErrors); ":n+=" validate.errors = vErrors; return false; "),u&&(n+=" break; "),n+=" } }"}return u&&(n+="  if ("+d+" == errors) {"),n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n=" ",o=e.level,i=e.dataLevel,s=e.schema[t],a=e.schemaPath+e.util.getProperty(t),c=e.errSchemaPath+"/"+t,u=!e.opts.allErrors,l="data"+(i||""),d="valid"+o,h=e.opts.$data&&s&&s.$data;h&&(n+=" var schema"+o+" = "+e.util.getData(s.$data,i,e.dataPathArr)+"; ");var p="schema"+o;if(!h)if(s.length<e.opts.loopRequired&&e.schema.properties&&Object.keys(e.schema.properties).length){var f=[],m=s;if(m)for(var g,v=-1,y=m.length-1;v<y;){g=m[v+=1];var _=e.schema.properties[g];_&&(e.opts.strictKeywords?"object"==typeof _&&Object.keys(_).length>0:e.util.schemaHasRules(_,e.RULES.all))||(f[f.length]=g)}}else f=s;if(h||f.length){var b=e.errorPath,E=h||f.length>=e.opts.loopRequired,S=e.opts.ownProperties;if(u)if(n+=" var missing"+o+"; ",E){h||(n+=" var "+p+" = validate.schema"+a+"; ");var w="' + "+(O="schema"+o+"["+(k="i"+o)+"]")+" + '";e.opts._errorDataPathProperty&&(e.errorPath=e.util.getPathExpr(b,O,e.opts.jsonPointers)),n+=" var "+d+" = true; ",h&&(n+=" if (schema"+o+" === undefined) "+d+" = true; else if (!Array.isArray(schema"+o+")) "+d+" = false; else {"),n+=" for (var "+k+" = 0; "+k+" < "+p+".length; "+k+"++) { "+d+" = "+l+"["+p+"["+k+"]] !== undefined ",S&&(n+=" &&   Object.prototype.hasOwnProperty.call("+l+", "+p+"["+k+"]) "),n+="; if (!"+d+") break; } ",h&&(n+="  }  "),n+="  if (!"+d+") {   ",(T=T||[]).push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'required' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { missingProperty: '"+w+"' } ",!1!==e.opts.messages&&(n+=" , message: '",e.opts._errorDataPathProperty?n+="is a required property":n+="should have required property \\'"+w+"\\'",n+="' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ";var R=n;n=T.pop(),!e.compositeRule&&u?e.async?n+=" throw new ValidationError(["+R+"]); ":n+=" validate.errors = ["+R+"]; return false; ":n+=" var err = "+R+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",n+=" } else { "}else{n+=" if ( ";var I=f;if(I)for(var k=-1,P=I.length-1;k<P;){D=I[k+=1],k&&(n+=" || "),n+=" ( ( "+(j=l+(M=e.util.getProperty(D)))+" === undefined ",S&&(n+=" || ! Object.prototype.hasOwnProperty.call("+l+", '"+e.util.escapeQuotes(D)+"') "),n+=") && (missing"+o+" = "+e.util.toQuotedString(e.opts.jsonPointers?D:M)+") ) "}n+=") {  ";var T;w="' + "+(O="missing"+o)+" + '";e.opts._errorDataPathProperty&&(e.errorPath=e.opts.jsonPointers?e.util.getPathExpr(b,O,!0):b+" + "+O),(T=T||[]).push(n),n="",!1!==e.createErrors?(n+=" { keyword: 'required' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { missingProperty: '"+w+"' } ",!1!==e.opts.messages&&(n+=" , message: '",e.opts._errorDataPathProperty?n+="is a required property":n+="should have required property \\'"+w+"\\'",n+="' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ";R=n;n=T.pop(),!e.compositeRule&&u?e.async?n+=" throw new ValidationError(["+R+"]); ":n+=" validate.errors = ["+R+"]; return false; ":n+=" var err = "+R+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",n+=" } else { "}else if(E){h||(n+=" var "+p+" = validate.schema"+a+"; ");var O;w="' + "+(O="schema"+o+"["+(k="i"+o)+"]")+" + '";e.opts._errorDataPathProperty&&(e.errorPath=e.util.getPathExpr(b,O,e.opts.jsonPointers)),h&&(n+=" if ("+p+" && !Array.isArray("+p+")) {  var err =   ",!1!==e.createErrors?(n+=" { keyword: 'required' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { missingProperty: '"+w+"' } ",!1!==e.opts.messages&&(n+=" , message: '",e.opts._errorDataPathProperty?n+="is a required property":n+="should have required property \\'"+w+"\\'",n+="' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ",n+=";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; } else if ("+p+" !== undefined) { "),n+=" for (var "+k+" = 0; "+k+" < "+p+".length; "+k+"++) { if ("+l+"["+p+"["+k+"]] === undefined ",S&&(n+=" || ! Object.prototype.hasOwnProperty.call("+l+", "+p+"["+k+"]) "),n+=") {  var err =   ",!1!==e.createErrors?(n+=" { keyword: 'required' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { missingProperty: '"+w+"' } ",!1!==e.opts.messages&&(n+=" , message: '",e.opts._errorDataPathProperty?n+="is a required property":n+="should have required property \\'"+w+"\\'",n+="' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ",n+=";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; } } ",h&&(n+="  }  ")}else{var A=f;if(A)for(var D,C=-1,x=A.length-1;C<x;){D=A[C+=1];var M=e.util.getProperty(D),j=(w=e.util.escapeQuotes(D),l+M);e.opts._errorDataPathProperty&&(e.errorPath=e.util.getPath(b,D,e.opts.jsonPointers)),n+=" if ( "+j+" === undefined ",S&&(n+=" || ! Object.prototype.hasOwnProperty.call("+l+", '"+e.util.escapeQuotes(D)+"') "),n+=") {  var err =   ",!1!==e.createErrors?(n+=" { keyword: 'required' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(c)+" , params: { missingProperty: '"+w+"' } ",!1!==e.opts.messages&&(n+=" , message: '",e.opts._errorDataPathProperty?n+="is a required property":n+="should have required property \\'"+w+"\\'",n+="' "),e.opts.verbose&&(n+=" , schema: validate.schema"+a+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+l+" "),n+=" } "):n+=" {} ",n+=";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; } "}}e.errorPath=b}else u&&(n+=" if (true) {");return n}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n,o=" ",i=e.level,s=e.dataLevel,a=e.schema[t],c=e.schemaPath+e.util.getProperty(t),u=e.errSchemaPath+"/"+t,l=!e.opts.allErrors,d="data"+(s||""),h="valid"+i,p=e.opts.$data&&a&&a.$data;if(p?(o+=" var schema"+i+" = "+e.util.getData(a.$data,s,e.dataPathArr)+"; ",n="schema"+i):n=a,(a||p)&&!1!==e.opts.uniqueItems){p&&(o+=" var "+h+"; if ("+n+" === false || "+n+" === undefined) "+h+" = true; else if (typeof "+n+" != 'boolean') "+h+" = false; else { "),o+=" var i = "+d+".length , "+h+" = true , j; if (i > 1) { ";var f=e.schema.items&&e.schema.items.type,m=Array.isArray(f);if(!f||"object"==f||"array"==f||m&&(f.indexOf("object")>=0||f.indexOf("array")>=0))o+=" outer: for (;i--;) { for (j = i; j--;) { if (equal("+d+"[i], "+d+"[j])) { "+h+" = false; break outer; } } } ";else{o+=" var itemIndices = {}, item; for (;i--;) { var item = "+d+"[i]; ";var g="checkDataType"+(m?"s":"");o+=" if ("+e.util[g](f,"item",e.opts.strictNumbers,!0)+") continue; ",m&&(o+=" if (typeof item == 'string') item = '\"' + item; "),o+=" if (typeof itemIndices[item] == 'number') { "+h+" = false; j = itemIndices[item]; break; } itemIndices[item] = i; } "}o+=" } ",p&&(o+="  }  "),o+=" if (!"+h+") {   ";var v=v||[];v.push(o),o="",!1!==e.createErrors?(o+=" { keyword: 'uniqueItems' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(u)+" , params: { i: i, j: j } ",!1!==e.opts.messages&&(o+=" , message: 'should NOT have duplicate items (items ## ' + j + ' and ' + i + ' are identical)' "),e.opts.verbose&&(o+=" , schema:  ",o+=p?"validate.schema"+c:""+a,o+="         , parentSchema: validate.schema"+e.schemaPath+" , data: "+d+" "),o+=" } "):o+=" {} ";var y=o;o=v.pop(),!e.compositeRule&&l?e.async?o+=" throw new ValidationError(["+y+"]); ":o+=" validate.errors = ["+y+"]; return false; ":o+=" var err = "+y+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",o+=" } ",l&&(o+=" else { ")}else l&&(o+=" if (true) { ");return o}},function(e,t,r){"use strict";var n=["multipleOf","maximum","exclusiveMaximum","minimum","exclusiveMinimum","maxLength","minLength","pattern","additionalItems","maxItems","minItems","uniqueItems","maxProperties","minProperties","required","additionalProperties","enum","format","const"];e.exports=function(e,t){for(var r=0;r<t.length;r++){e=JSON.parse(JSON.stringify(e));var o,i=t[r].split("/"),s=e;for(o=1;o<i.length;o++)s=s[i[o]];for(o=0;o<n.length;o++){var a=n[o],c=s[a];c&&(s[a]={anyOf:[c,{$ref:"https://raw.githubusercontent.com/ajv-validator/ajv/master/lib/refs/data.json#"}]})}}return e}},function(e,t,r){"use strict";var n=r(49).MissingRef;e.exports=function e(t,r,o){var i=this;if("function"!=typeof this._opts.loadSchema)throw new Error("options.loadSchema should be a function");"function"==typeof r&&(o=r,r=void 0);var s=a(t).then((function(){var e=i._addSchema(t,void 0,r);return e.validate||function e(t){try{return i._compile(t)}catch(e){if(e instanceof n)return o(e);throw e}function o(n){var o=n.missingSchema;if(u(o))throw new Error("Schema "+o+" is loaded but "+n.missingRef+" cannot be resolved");var s=i._loadingSchemas[o];return s||(s=i._loadingSchemas[o]=i._opts.loadSchema(o)).then(c,c),s.then((function(e){if(!u(o))return a(e).then((function(){u(o)||i.addSchema(e,o,void 0,r)}))})).then((function(){return e(t)}));function c(){delete i._loadingSchemas[o]}function u(e){return i._refs[e]||i._schemas[e]}}}(e)}));o&&s.then((function(e){o(null,e)}),o);return s;function a(t){var r=t.$schema;return r&&!i.getSchema(r)?e.call(i,{$ref:r},!0):Promise.resolve()}}},function(e,t,r){"use strict";var n=/^[a-z_$][a-z0-9_$-]*$/i,o=r(174),i=r(175);e.exports={add:function(e,t){var r=this.RULES;if(r.keywords[e])throw new Error("Keyword "+e+" is already defined");if(!n.test(e))throw new Error("Keyword "+e+" is not a valid identifier");if(t){this.validateKeyword(t,!0);var i=t.type;if(Array.isArray(i))for(var s=0;s<i.length;s++)c(e,i[s],t);else c(e,i,t);var a=t.metaSchema;a&&(t.$data&&this._opts.$data&&(a={anyOf:[a,{$ref:"https://raw.githubusercontent.com/ajv-validator/ajv/master/lib/refs/data.json#"}]}),t.validateSchema=this.compile(a,!0))}function c(e,t,n){for(var i,s=0;s<r.length;s++){var a=r[s];if(a.type==t){i=a;break}}i||(i={type:t,rules:[]},r.push(i));var c={keyword:e,definition:n,custom:!0,code:o,implements:n.implements};i.rules.push(c),r.custom[e]=c}return r.keywords[e]=r.all[e]=!0,this},get:function(e){var t=this.RULES.custom[e];return t?t.definition:this.RULES.keywords[e]||!1},remove:function(e){var t=this.RULES;delete t.keywords[e],delete t.all[e],delete t.custom[e];for(var r=0;r<t.length;r++)for(var n=t[r].rules,o=0;o<n.length;o++)if(n[o].keyword==e){n.splice(o,1);break}return this},validate:function e(t,r){e.errors=null;var n=this._validateKeyword=this._validateKeyword||this.compile(i,!0);if(n(t))return!0;if(e.errors=n.errors,r)throw new Error("custom keyword definition is invalid: "+this.errorsText(n.errors));return!1}}},function(e,t,r){"use strict";e.exports=function(e,t,r){var n,o,i=" ",s=e.level,a=e.dataLevel,c=e.schema[t],u=e.schemaPath+e.util.getProperty(t),l=e.errSchemaPath+"/"+t,d=!e.opts.allErrors,h="data"+(a||""),p="valid"+s,f="errs__"+s,m=e.opts.$data&&c&&c.$data;m?(i+=" var schema"+s+" = "+e.util.getData(c.$data,a,e.dataPathArr)+"; ",o="schema"+s):o=c;var g,v,y,_,b,E="definition"+s,S=this.definition,w="";if(m&&S.$data){b="keywordValidate"+s;var R=S.validateSchema;i+=" var "+E+" = RULES.custom['"+t+"'].definition; var "+b+" = "+E+".validate;"}else{if(!(_=e.useCustomRule(this,c,e.schema,e)))return;o="validate.schema"+u,b=_.code,g=S.compile,v=S.inline,y=S.macro}var I=b+".errors",k="i"+s,P="ruleErr"+s,T=S.async;if(T&&!e.async)throw new Error("async keyword in sync schema");if(v||y||(i+=I+" = null;"),i+="var "+f+" = errors;var "+p+";",m&&S.$data&&(w+="}",i+=" if ("+o+" === undefined) { "+p+" = true; } else { ",R&&(w+="}",i+=" "+p+" = "+E+".validateSchema("+o+"); if ("+p+") { ")),v)S.statements?i+=" "+_.validate+" ":i+=" "+p+" = "+_.validate+"; ";else if(y){var O=e.util.copy(e);w="";O.level++;var A="valid"+O.level;O.schema=_.validate,O.schemaPath="";var D=e.compositeRule;e.compositeRule=O.compositeRule=!0;var C=e.validate(O).replace(/validate\.schema/g,b);e.compositeRule=O.compositeRule=D,i+=" "+C}else{(U=U||[]).push(i),i="",i+="  "+b+".call( ",e.opts.passContext?i+="this":i+="self",g||!1===S.schema?i+=" , "+h+" ":i+=" , "+o+" , "+h+" , validate.schema"+e.schemaPath+" ",i+=" , (dataPath || '')",'""'!=e.errorPath&&(i+=" + "+e.errorPath);var x=a?"data"+(a-1||""):"parentData",M=a?e.dataPathArr[a]:"parentDataProperty",j=i+=" , "+x+" , "+M+" , rootData )  ";i=U.pop(),!1===S.errors?(i+=" "+p+" = ",T&&(i+="await "),i+=j+"; "):i+=T?" var "+(I="customErrors"+s)+" = null; try { "+p+" = await "+j+"; } catch (e) { "+p+" = false; if (e instanceof ValidationError) "+I+" = e.errors; else throw e; } ":" "+I+" = null; "+p+" = "+j+"; "}if(S.modifying&&(i+=" if ("+x+") "+h+" = "+x+"["+M+"];"),i+=""+w,S.valid)d&&(i+=" if (true) { ");else{var U;i+=" if ( ",void 0===S.valid?(i+=" !",i+=y?""+A:""+p):i+=" "+!S.valid+" ",i+=") { ",n=this.keyword,(U=U||[]).push(i),i="",(U=U||[]).push(i),i="",!1!==e.createErrors?(i+=" { keyword: '"+(n||"custom")+"' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(l)+" , params: { keyword: '"+this.keyword+"' } ",!1!==e.opts.messages&&(i+=" , message: 'should pass \""+this.keyword+"\" keyword validation' "),e.opts.verbose&&(i+=" , schema: validate.schema"+u+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+h+" "),i+=" } "):i+=" {} ";var N=i;i=U.pop(),!e.compositeRule&&d?e.async?i+=" throw new ValidationError(["+N+"]); ":i+=" validate.errors = ["+N+"]; return false; ":i+=" var err = "+N+";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ";var F=i;i=U.pop(),v?S.errors?"full"!=S.errors&&(i+="  for (var "+k+"="+f+"; "+k+"<errors; "+k+"++) { var "+P+" = vErrors["+k+"]; if ("+P+".dataPath === undefined) "+P+".dataPath = (dataPath || '') + "+e.errorPath+"; if ("+P+".schemaPath === undefined) { "+P+'.schemaPath = "'+l+'"; } ',e.opts.verbose&&(i+=" "+P+".schema = "+o+"; "+P+".data = "+h+"; "),i+=" } "):!1===S.errors?i+=" "+F+" ":(i+=" if ("+f+" == errors) { "+F+" } else {  for (var "+k+"="+f+"; "+k+"<errors; "+k+"++) { var "+P+" = vErrors["+k+"]; if ("+P+".dataPath === undefined) "+P+".dataPath = (dataPath || '') + "+e.errorPath+"; if ("+P+".schemaPath === undefined) { "+P+'.schemaPath = "'+l+'"; } ',e.opts.verbose&&(i+=" "+P+".schema = "+o+"; "+P+".data = "+h+"; "),i+=" } } "):y?(i+="   var err =   ",!1!==e.createErrors?(i+=" { keyword: '"+(n||"custom")+"' , dataPath: (dataPath || '') + "+e.errorPath+" , schemaPath: "+e.util.toQuotedString(l)+" , params: { keyword: '"+this.keyword+"' } ",!1!==e.opts.messages&&(i+=" , message: 'should pass \""+this.keyword+"\" keyword validation' "),e.opts.verbose&&(i+=" , schema: validate.schema"+u+" , parentSchema: validate.schema"+e.schemaPath+" , data: "+h+" "),i+=" } "):i+=" {} ",i+=";  if (vErrors === null) vErrors = [err]; else vErrors.push(err); errors++; ",!e.compositeRule&&d&&(e.async?i+=" throw new ValidationError(vErrors); ":i+=" validate.errors = vErrors; return false; ")):!1===S.errors?i+=" "+F+" ":(i+=" if (Array.isArray("+I+")) { if (vErrors === null) vErrors = "+I+"; else vErrors = vErrors.concat("+I+"); errors = vErrors.length;  for (var "+k+"="+f+"; "+k+"<errors; "+k+"++) { var "+P+" = vErrors["+k+"]; if ("+P+".dataPath === undefined) "+P+".dataPath = (dataPath || '') + "+e.errorPath+";  "+P+'.schemaPath = "'+l+'";  ',e.opts.verbose&&(i+=" "+P+".schema = "+o+"; "+P+".data = "+h+"; "),i+=" } } else { "+F+" } "),i+=" } ",d&&(i+=" else { ")}return i}},function(e,t,r){"use strict";var n=r(81);e.exports={$id:"https://github.com/ajv-validator/ajv/blob/master/lib/definition_schema.js",definitions:{simpleTypes:n.definitions.simpleTypes},type:"object",dependencies:{schema:["validate"],$data:["validate"],statements:["inline"],valid:{not:{required:["macro"]}}},properties:{type:n.properties.type,schema:{type:"boolean"},statements:{type:"boolean"},dependencies:{type:"array",items:{type:"string"}},metaSchema:{type:"object"},modifying:{type:"boolean"},valid:{type:"boolean"},$data:{type:"boolean"},async:{type:"boolean"},errors:{anyOf:[{type:"boolean"},{const:"full"}]}}}},function(e){e.exports=JSON.parse('{"$schema":"http://json-schema.org/draft-07/schema#","$id":"https://raw.githubusercontent.com/ajv-validator/ajv/master/lib/refs/data.json#","description":"Meta-schema for $data reference (JSON Schema extension proposal)","type":"object","required":["$data"],"properties":{"$data":{"type":"string","anyOf":[{"format":"relative-json-pointer"},{"format":"json-pointer"}]}},"additionalProperties":false}')},function(e,t,r){var n=function(e){"use strict";var t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},o=n.iterator||"@@iterator",i=n.asyncIterator||"@@asyncIterator",s=n.toStringTag||"@@toStringTag";function a(e,t,r,n){var o=t&&t.prototype instanceof l?t:l,i=Object.create(o.prototype),s=new S(n||[]);return i._invoke=function(e,t,r){var n="suspendedStart";return function(o,i){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===o)throw i;return R()}for(r.method=o,r.arg=i;;){var s=r.delegate;if(s){var a=_(s,r);if(a){if(a===u)continue;return a}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var l=c(e,t,r);if("normal"===l.type){if(n=r.done?"completed":"suspendedYield",l.arg===u)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(n="completed",r.method="throw",r.arg=l.arg)}}}(e,r,s),i}function c(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=a;var u={};function l(){}function d(){}function h(){}var p={};p[o]=function(){return this};var f=Object.getPrototypeOf,m=f&&f(f(w([])));m&&m!==t&&r.call(m,o)&&(p=m);var g=h.prototype=l.prototype=Object.create(p);function v(e){["next","throw","return"].forEach((function(t){e[t]=function(e){return this._invoke(t,e)}}))}function y(e,t){var n;this._invoke=function(o,i){function s(){return new t((function(n,s){!function n(o,i,s,a){var u=c(e[o],e,i);if("throw"!==u.type){var l=u.arg,d=l.value;return d&&"object"==typeof d&&r.call(d,"__await")?t.resolve(d.__await).then((function(e){n("next",e,s,a)}),(function(e){n("throw",e,s,a)})):t.resolve(d).then((function(e){l.value=e,s(l)}),(function(e){return n("throw",e,s,a)}))}a(u.arg)}(o,i,n,s)}))}return n=n?n.then(s,s):s()}}function _(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,_(e,t),"throw"===t.method))return u;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return u}var n=c(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,u;var o=n.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,u):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,u)}function b(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function E(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(b,this),this.reset(!0)}function w(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,i=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return i.next=i}}return{next:R}}function R(){return{value:void 0,done:!0}}return d.prototype=g.constructor=h,h.constructor=d,h[s]=d.displayName="GeneratorFunction",e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===d||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,h):(e.__proto__=h,s in e||(e[s]="GeneratorFunction")),e.prototype=Object.create(g),e},e.awrap=function(e){return{__await:e}},v(y.prototype),y.prototype[i]=function(){return this},e.AsyncIterator=y,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var s=new y(a(t,r,n,o),i);return e.isGeneratorFunction(r)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},v(g),g[s]="Generator",g[o]=function(){return this},g.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=w,S.prototype={constructor:S,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(E),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return s.type="throw",s.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],s=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var a=r.call(i,"catchLoc"),c=r.call(i,"finallyLoc");if(a&&c){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(a){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var s=i?i.completion:{};return s.type=e,s.arg=t,i?(this.method="next",this.next=i.finallyLoc,u):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),u},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),E(r),u}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;E(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:w(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),u}},e}(e.exports);try{regeneratorRuntime=n}catch(e){Function("r","regeneratorRuntime = r")(n)}},function(e,t,r){var n=r(82);function o(e){var t,r;function o(t,r){try{var s=e[t](r),a=s.value,c=a instanceof n;Promise.resolve(c?a.wrapped:a).then((function(e){c?o("return"===t?"return":"next",e):i(s.done?"return":"normal",e)}),(function(e){o("throw",e)}))}catch(e){i("throw",e)}}function i(e,n){switch(e){case"return":t.resolve({value:n,done:!0});break;case"throw":t.reject(n);break;default:t.resolve({value:n,done:!1})}(t=t.next)?o(t.key,t.arg):r=null}this._invoke=function(e,n){return new Promise((function(i,s){var a={key:e,arg:n,resolve:i,reject:s,next:null};r?r=r.next=a:(t=r=a,o(e,n))}))},"function"!=typeof e.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(o.prototype[Symbol.asyncIterator]=function(){return this}),o.prototype.next=function(e){return this._invoke("next",e)},o.prototype.throw=function(e){return this._invoke("throw",e)},o.prototype.return=function(e){return this._invoke("return",e)},e.exports=o},function(e,t){var r,n,o=e.exports={};function i(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function a(e){if(r===setTimeout)return setTimeout(e,0);if((r===i||!r)&&setTimeout)return r=setTimeout,setTimeout(e,0);try{return r(e,0)}catch(t){try{return r.call(null,e,0)}catch(t){return r.call(this,e,0)}}}!function(){try{r="function"==typeof setTimeout?setTimeout:i}catch(e){r=i}try{n="function"==typeof clearTimeout?clearTimeout:s}catch(e){n=s}}();var c,u=[],l=!1,d=-1;function h(){l&&c&&(l=!1,c.length?u=c.concat(u):d=-1,u.length&&p())}function p(){if(!l){var e=a(h);l=!0;for(var t=u.length;t;){for(c=u,u=[];++d<t;)c&&c[d].run();d=-1,t=u.length}c=null,l=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===s||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function f(e,t){this.fun=e,this.array=t}function m(){}o.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];u.push(new f(e,t)),1!==u.length||l||a(p)},f.prototype.run=function(){this.fun.apply(null,this.array)},o.title="browser",o.browser=!0,o.env={},o.argv=[],o.version="",o.versions={},o.on=m,o.addListener=m,o.once=m,o.off=m,o.removeListener=m,o.removeAllListeners=m,o.emit=m,o.prependListener=m,o.prependOnceListener=m,o.listeners=function(e){return[]},o.binding=function(e){throw new Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(e){throw new Error("process.chdir is not supported")},o.umask=function(){return 0}},function(e,t){(function(t){e.exports=t}).call(this,{})},function(e,t,r){"use strict";r.r(t),r.d(t,"worker",(function(){return Wt}));var n,o,i,s,a,c=r(26),u=r.n(c),l=r(51),d=r.n(l),h=r(21),p=r.n(h),f=r(83),m=r.n(f),g=r(52),v=r(15),y=r.n(v),_=r(11),b=r.n(_),E=r(12),S=r.n(E),w=r(2),R=r.n(w),I=r(4),k=r.n(I),P=r(0),T=r(16),O=r.n(T);function A(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return D(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return D(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,i=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw i}}}}function D(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function C(e){var t=e.service.prototype;do{var r,n=A(Object.getOwnPropertyNames(t));try{for(n.s();!(r=n.n()).done;){var o=t[r.value];o&&o[P.RpcFunctionAddress]&&"function"==typeof o&&(o[P.RpcFunctionAddress]=[].concat(y()(e.id),y()(o[P.RpcFunctionAddress])))}}catch(e){n.e(e)}finally{n.f()}}while(t=Object.getPrototypeOf(t));return e}(o=n||(n={})).Schema={type:"array",items:{type:"number"},minItems:3,maxItems:3},o.toString=function(e){return"v".concat(e[0],".").concat(e[1],".").concat(e[2])},(s=i||(i={})).Schema={type:"array",items:{type:"number"},minItems:2,maxItems:3},s.toString=function(e){return"v".concat(e[0],".").concat(e[1],".*")},(a||(a={})).Schema={type:"object",properties:{id:{type:"array",items:{type:"string"}},versions:{type:"array",items:i.Schema}},required:["id","versions"]};var x=r(1),M=r.n(x),j=r(9),U=r.n(j),N=r(7),F=r.n(N),L=r(13),K=r.n(L),B=r(17),q=r.n(B);function $(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:16,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){return!1};do{e="";for(var n=0;n<t;n++)e+=Math.floor(255*Math.random()).toString(16).padStart(2,"0")}while(r(e));return e}function V(e,t){return G.apply(this,arguments)}function G(){return(G=U()(M.a.mark((function e(t,r){var n,o,i,s,a,c;return M.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=!0,o=!1,e.prev=2,s=q()(t);case 4:return e.next=6,s.next();case 6:return a=e.sent,n=a.done,e.next=10,a.value;case 10:if(c=e.sent,n){e.next=17;break}r(c);case 14:n=!0,e.next=4;break;case 17:e.next=23;break;case 19:e.prev=19,e.t0=e.catch(2),o=!0,i=e.t0;case 23:if(e.prev=23,e.prev=24,n||null==s.return){e.next=28;break}return e.next=28,s.return();case 28:if(e.prev=28,!o){e.next=31;break}throw i;case 31:return e.finish(28);case 32:return e.finish(23);case 33:case"end":return e.stop()}}),e,null,[[2,19,23,33],[24,,28,32]])})))).apply(this,arguments)}var H,z,W,Q,Y,X,J,Z,ee,te=function(){function e(t){b()(this,e),R()(this,"callbacks",new Set),this._value=t}return S()(e,[{key:"pushUpdate",value:function(){this.callbacks.forEach((function(e){return e()})),this.callbacks.clear()}},{key:"generate",value:function(){var e=this;return K()(M.a.mark((function t(){var r;return M.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=new Promise((function(t){return e.callbacks.add((function(){return t()}))})),t.next=4,e._value;case 4:return t.next=6,F()(r);case 6:t.next=0;break;case 8:case"end":return t.stop()}}),t)})))()}},{key:"value",get:function(){return this._value},set:function(e){var t=this._value!==e;this._value=e,t&&this.pushUpdate()}}]),e}(),re=function(){function e(){b()(this,e),R()(this,"map",{}),R()(this,"callbacks",new Set),R()(this,"key_callbacks",{}),R()(this,"map_callbacks",new Set)}return S()(e,[{key:"pushKeyUpdate",value:function(){this.callbacks.forEach((function(e){return e()})),this.callbacks.clear()}},{key:"pushUpdate",value:function(e){this.key_callbacks[e]&&(this.key_callbacks[e].forEach((function(e){return e()})),delete this.key_callbacks[e]),this.map_callbacks.forEach((function(e){return e()})),this.map_callbacks.clear()}},{key:"generateKeys",value:function(){var e=this;return K()(M.a.mark((function t(){var r;return M.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=new Promise((function(t){return e.callbacks.add((function(){return t()}))})),t.next=4,Object.keys(e.map);case 4:return t.next=6,F()(r);case 6:t.next=0;break;case 8:case"end":return t.stop()}}),t)})))()}},{key:"generateMap",value:function(){var e=this;return K()(M.a.mark((function t(){var r;return M.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=new Promise((function(t){return e.map_callbacks.add((function(){return t()}))})),t.next=4,e.value;case 4:return t.next=6,F()(r);case 6:t.next=0;break;case 8:case"end":return t.stop()}}),t)})))()}},{key:"generate",value:function(e){var t=this;return K()(M.a.mark((function r(){var n;return M.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return t.key_callbacks[e]||(t.key_callbacks[e]=new Set),n=new Promise((function(r){return t.key_callbacks[e].add((function(){return r()}))})),r.next=5,t.map[e];case 5:return r.next=7,F()(n);case 7:r.next=0;break;case 9:case"end":return r.stop()}}),r)})))()}},{key:"value",get:function(){var e=this,t=function(t,r){var n=e.map[t];r?e.map[t]=r:delete e.map[t],r!==n&&((r?!n:n)&&e.pushKeyUpdate(),e.pushUpdate(t))};return new Proxy(e.map,{ownKeys:function(){return Object.keys(e.map)},has:function(t,r){return r in e.map},get:function(t,r){return e.map[r]},deleteProperty:function(e,r){return t(r,void 0),!0},set:function(e,r,n){return t(r,n),!0}})}}]),e}();function ne(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return oe(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return oe(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,i=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw i}}}}function oe(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var ie,se,ae=function(){function e(t,r){b()(this,e),this.uid=t,this.parent=r}var t;return S()(e,[{key:"storageGet",value:function(e){return this.parent.parent.storage_backend.get("accounts/".concat(this.uid,"/").concat(e))}},{key:"storageSet",value:function(e,t){return this.parent.parent.storage_backend.set("accounts/".concat(this.uid,"/").concat(e),t)}},{key:"storageGetSchema",value:(t=U()(M.a.mark((function e(t,r,n){var o,i,s,a;return M.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageGet(t);case 2:if(i=e.sent,(s=this.parent.known_data_schema_validators.get(r)||this.parent.parent.ajv.compile(r))(i),!(null===(o=s.errors)||void 0===o?void 0:o.length)){e.next=13;break}if(a=new T.ValidationError(y()(s.errors)),s.errors.length=0,void 0!==n){e.next=12;break}throw a;case 12:return e.abrupt("return",n);case 13:return e.abrupt("return",i);case 14:case"end":return e.stop()}}),e,this)}))),function(e,r,n){return t.apply(this,arguments)})}]),e}(),ce=C({id:["net","kb1rd","accounts"],service:(H=P.RpcAddress(["v0","lazyLoadAccounts"]),z=P.RemapArguments(["drop","drop"]),W=P.RpcAddress(["v0","saveAccountList"]),Q=P.RpcAddress(["v0","createAccount"]),Y=P.RpcAddress(["v0","getAccounts"]),X=P.RpcAddress(["v0","listenAccounts"]),J=P.RpcAddress(["v0",void 0,"exists"]),Z=P.RemapArguments(["drop","expand"]),ee=function(){function e(t,r){b()(this,e),R()(this,"map",new te({})),R()(this,"has_lazy_loaded",!1),R()(this,"known_data_schema_validators",new WeakMap),this.parent=t,this.log=r}var t,r,n,o,i;return S()(e,[{key:"lazyLoadAccounts",value:(i=U()(M.a.mark((function e(){var t,r,n,o,i,s=arguments;return M.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=s.length>0&&void 0!==s[0]&&s[0],this.has_lazy_loaded&&!t){e.next=8;break}return this.has_lazy_loaded=!0,this.log.info("Loading accounts from storage..."),e.next=6,this.parent.storage_backend.get("accounts.list");case 6:if(r=e.sent,Array.isArray(r)){this.log.info("Found ".concat(r?r.length:0," accounts in storage")),n=ne(r);try{for(n.s();!(o=n.n()).done;)"string"!=typeof(i=o.value)||this.map.value[i]||(this.map.value[i]=new ae(i,this))}catch(e){n.e(e)}finally{n.f()}this.map.pushUpdate()}else this.log.info("Found empty or corrupt account list");case 8:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"saveAccountList",value:(o=U()(M.a.mark((function e(){return M.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.log.info("Saving account list to storage"),e.next=3,this.parent.storage_backend.set("accounts.list",Object.keys(this.map.value));case 3:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"createAccount",value:(n=U()(M.a.mark((function e(){var t,r=this;return M.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.lazyLoadAccounts();case 2:return t=$(16,(function(e){return Boolean(r.map.value[e])})),this.map.value[t]=new ae(t,this),this.map.pushUpdate(),e.next=7,this.saveAccountList();case 7:return this.log.info("Created new account UID ".concat(t)),e.abrupt("return",t);case 9:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"getAccounts",value:(r=U()(M.a.mark((function e(){return M.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.lazyLoadAccounts();case 2:return e.abrupt("return",Object.keys(this.map.value));case 3:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"listenAccounts",value:function(){var e=this;return K()(M.a.mark((function t(){var r,n,o,i,s,a,c;return M.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,F()(e.lazyLoadAccounts());case 2:r=!0,n=!1,t.prev=4,i=q()(e.map.generate());case 6:return t.next=8,F()(i.next());case 8:return s=t.sent,r=s.done,t.next=12,F()(s.value);case 12:if(a=t.sent,r){t.next=20;break}return c=a,t.next=17,Object.keys(c);case 17:r=!0,t.next=6;break;case 20:t.next=26;break;case 22:t.prev=22,t.t0=t.catch(4),n=!0,o=t.t0;case 26:if(t.prev=26,t.prev=27,r||null==i.return){t.next=31;break}return t.next=31,F()(i.return());case 31:if(t.prev=31,!n){t.next=34;break}throw o;case 34:return t.finish(31);case 35:return t.finish(26);case 36:case"end":return t.stop()}}),t,null,[[4,22,26,36],[27,,31,35]])})))()}},{key:"exists",value:(t=U()(M.a.mark((function e(t){return M.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.lazyLoadAccounts();case 2:return e.abrupt("return",Boolean(this.map.value[t]));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"getAccount",value:function(e){return this.map.value[e]}}]),e}(),k()(ee.prototype,"lazyLoadAccounts",[H,z],Object.getOwnPropertyDescriptor(ee.prototype,"lazyLoadAccounts"),ee.prototype),k()(ee.prototype,"saveAccountList",[W],Object.getOwnPropertyDescriptor(ee.prototype,"saveAccountList"),ee.prototype),k()(ee.prototype,"createAccount",[Q],Object.getOwnPropertyDescriptor(ee.prototype,"createAccount"),ee.prototype),k()(ee.prototype,"getAccounts",[Y],Object.getOwnPropertyDescriptor(ee.prototype,"getAccounts"),ee.prototype),k()(ee.prototype,"listenAccounts",[X],Object.getOwnPropertyDescriptor(ee.prototype,"listenAccounts"),ee.prototype),k()(ee.prototype,"exists",[J,Z],Object.getOwnPropertyDescriptor(ee.prototype,"exists"),ee.prototype),ee),versions:[{version:[0,1,0]}]}),ue=r(20),le=r(53),de="org.matrix.msc1840";function he(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function pe(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?he(Object(r),!0).forEach((function(t){R()(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):he(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}!function(e){var t;(t||(t=e.Base||(e.Base={}))).Schema={type:"object",properties:{account_id:{type:"string"},app_id:{type:"string"},room_id:{type:"string"}}};e.Schema=pe(pe({},t.Schema),{},{required:["account_id","app_id"]})}(se||(se={}));var fe,me,ge,ve,ye,_e,be=["net","kb1rd","mxbindings","v0"],Ee=pe({},(ie={},R()(ie,"a.services.request",{grantOn:function(e){e.put(["net","kb1rd","services","requestServices"],P.AccessPolicy.ALLOW)},inherits:[]}),R()(ie,"a.openroom.displayinfo",{grantOn:function(e,t){var r=t.room_id,n=t.account_id;if(!r)throw new TypeError("Tried to grant room permissions in context without room");e.put([].concat(be,[n,"room",r,"listenDetails"]),P.AccessPolicy.ALLOW)},inherits:[]}),R()(ie,"a.openroom.state.get",{grantOn:function(e,t){var r=t.account_id,n=t.room_id;if(!n)throw new TypeError("Tried to grant room permissions in context without room");var o=function(t,o){return e.put([].concat(be,[r,"room",n,"state",o,"listen"]),t)};o(P.AccessPolicy.ALLOW,void 0),o(P.AccessPolicy.DENY,"m.room.member"),o(P.AccessPolicy.DENY,"m.room.power_levels"),o(P.AccessPolicy.DENY,"m.room.third_party_invite"),o(P.AccessPolicy.DENY,"m.room.server_acl")},inherits:["a.openroom.displayinfo"]}),R()(ie,"a.openroom.state.set",{grantOn:function(e,t){var r=t.account_id,n=t.room_id;if(!n)throw new TypeError("Tried to grant room permissions in context without room");var o=function(t,o){return e.put([].concat(be,[r,"room",n,"state",o,"set"]),t)};o(P.AccessPolicy.ALLOW,void 0),o(P.AccessPolicy.DENY,"m.room.join_rules"),o(P.AccessPolicy.DENY,"m.room.member"),o(P.AccessPolicy.DENY,"m.room.power_levels"),o(P.AccessPolicy.DENY,"m.room.history_visibility"),o(P.AccessPolicy.DENY,"m.room.third_party_invite"),o(P.AccessPolicy.DENY,"m.room.guest_access"),o(P.AccessPolicy.DENY,"m.room.server_acl"),o(P.AccessPolicy.DENY,"m.room.tombstone")},inherits:["a.openroom.state.get"]}),ie)),Se=r(50),we=r.n(Se);ge=fe||(fe={}),(me=ve||(ve=ge.LocalizedObject||(ge.LocalizedObject={}))).getLocalized=function(e){var t=Object.keys(e);if(t.length){for(var r=arguments.length,n=new Array(r>1?r-1:0),o=1;o<r;o++)n[o-1]=arguments[o];for(var i=function(){var r=a[s];if(e[r])return{v:e[r]};var n=r.split("-")[0];if(e[n])return{v:e[n]};var o=t.filter((function(e){return e.startsWith(n)}));return o.length?{v:e[o[0]]}:void 0},s=0,a=n;s<a.length;s++){var c=i();if("object"===we()(c))return c.v}return e[t[0]]}},me.Schema={type:"object",additionalProperties:{type:"string"}},(ye||(ye=ge.V0||(ge.V0={}))).Schema={type:"object",properties:{manifest_version:{type:"number",minimum:0,maximum:0},default_locale:{type:"string"},title:ve.Schema,version:n.Schema,description:ve.Schema,entry_points:{type:"object",properties:{"net.kb1rd.openroom":{type:"object",properties:{to:{type:"string"},types:{type:"array",items:{type:"string"}}},required:["to"]}},additionalProperties:{type:"object",properties:{to:{type:"string"}},required:["to"]}},request_permissions:{type:"array",items:{type:"string"}}},required:["manifest_version","title","version","entry_points","request_permissions"]},(_e||(_e=ge.Known||(ge.Known={}))).Schema={type:"object",oneOf:[ye.Schema]};var Re,Ie,ke,Pe,Te,Oe,Ae,De,Ce,xe,Me,je,Ue,Ne,Fe,Le,Ke,Be,qe,$e,Ve,Ge,He,ze,We,Qe,Ye,Xe,Je,Ze=fe;function et(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}var tt=function(){function e(t,r){b()(this,e),R()(this,"permissions",new te([])),this.manifest_url=t,this.cached_manifest=r}return S()(e,[{key:"getLocalized",value:function(e){var t,r=this.cached_manifest.default_locale,n=[];return r&&n.push(r),n.push("en-US"),(t=Ze.LocalizedObject).getLocalized.apply(t,[e].concat(n))||"APP MANIFEST MISSING TRANSLATION"}},{key:"getTitle",value:function(){return this.getLocalized(this.cached_manifest.title)}},{key:"getDescription",value:function(){var e=this.cached_manifest.description;return e&&this.getLocalized(e)}},{key:"getVersion",value:function(){return this.cached_manifest.version}},{key:"copyTo",value:function(e){e.permissions.value=this.permissions.value.slice()}},{key:"toJSON",value:function(){var e=this.manifest_url,t=this.cached_manifest;return{permissions:this.permissions.value,manifest_url:e,cached_manifest:t}}}]),e}();(tt||(tt={})).Schema={type:"object",properties:{permissions:{type:"array",items:{type:"string"}},manifest_url:{type:"string"},cached_manifest:Ze.Known.Schema},required:["permissions","manifest_url","cached_manifest"]};var rt,nt,ot,it,st,at,ct,ut,lt,dt,ht,pt,ft,mt,gt,vt,yt,_t,bt,Et,St,wt,Rt,It,kt,Pt,Tt,Ot,At,Dt,Ct,xt,Mt,jt=C({id:["net","kb1rd","apps"],service:(Re=P.RpcAddress(["v0","app",void 0,"fetchAndVerifyManifest"]),Ie=P.RemapArguments(["drop","expand"]),ke=P.RpcAddress(["v0",void 0,"userapp",void 0,"setup"]),Pe=P.RemapArguments(["drop","expand","expand","pass"]),Te=P.EnforceMethodArgSchema({type:"array",items:[{type:"string"},{type:"string"},Ze.Known.Schema]}),Oe=P.RpcAddress(["v0",void 0,"userapp","listen"]),Ae=P.RemapArguments(["drop","expand"]),De=P.RpcAddress(["v0",void 0,"userapp",void 0,"manifest","listen"]),Ce=P.RemapArguments(["drop","expand","expand"]),xe=P.RpcAddress(["v0",void 0,"userapp",void 0,"listen"]),Me=P.RemapArguments(["drop","expand","expand"]),je=P.RpcAddress(["v0",void 0,"userapp",void 0,"perms","set"]),Ue=P.RemapArguments(["drop","expand","expand","pass"]),Ne=P.EnforceMethodArgSchema({type:"array",items:[{type:"string"},{type:"string"},{type:"object",additionalProperties:{type:"boolean"}}]}),Fe=P.RpcAddress(["v0",void 0,"userapp",void 0,"perms","listen"]),Le=P.RemapArguments(["drop","expand","expand"]),Ke=P.RpcAddress(["v0",void 0,"assoc",void 0,"set"]),Be=P.RemapArguments(["drop","expand","expand"]),qe=P.EnforceMethodArgSchema({type:"array",additionalItems:{type:"string"},minItems:2,maxItems:3}),$e=P.RpcAddress(["v0",void 0,"assoc",void 0,"listen"]),Ve=P.RemapArguments(["drop","expand","expand"]),Ge=P.RpcAddress(["v0",void 0,"assoc","listen"]),He=P.RemapArguments(["drop","expand"]),ze=P.RpcAddress(["v0",void 0,"userapp",void 0,"entry",void 0,"setup"]),We=P.RemapArguments(["drop","expand","expand","expand","pass"]),Qe=P.EnforceMethodArgSchema({type:"array",items:[{type:"string"},{type:"string"},{type:"string"},se.Base.Schema]}),Ye=P.RpcAddress(["v0","redeemToken",void 0]),Xe=P.RemapArguments(["drop","expand"]),Je=function(){function e(t,r){b()(this,e),R()(this,"validateManifest",void 0),R()(this,"validateAppConfig",void 0),R()(this,"known_apps",{}),R()(this,"associations",{}),R()(this,"app_tokens",new Map),this.parent=t,this.log=r,this.validateManifest=t.ajv.compile(Ze.Known.Schema),this.validateAppConfig=t.ajv.compile(tt.Schema)}var t;return S()(e,[{key:"getAccount",value:function(e){return this.known_apps[e]||(this.known_apps[e]=new re),this.known_apps[e]}},{key:"getAssocTable",value:function(e){return this.associations[e]||(this.associations[e]=new re),this.associations[e]}},{key:"pushApp",value:function(e,t){this.getAccount(e).value[t.manifest_url]=t}},{key:"fetchAndVerifyManifest",value:function(e){var t=this;return new Promise((function(r,n){t.parent.request({method:"GET",uri:e,timeout:5e3},(function(e,o,i){if(e)n(e);else try{var s,a=JSON.parse(i);if(t.validateManifest(a),null===(s=t.validateManifest.errors)||void 0===s?void 0:s.length){var c=new T.ValidationError(y()(t.validateManifest.errors));throw t.validateManifest.errors.length=0,c}var u={manifest:a,known_permissions:{},unknown_permissions:[]};u.manifest.request_permissions.forEach((function e(t){var r=Ee[t];r?u.known_permissions[t]||(u.known_permissions[t]={inherits:r.inherits},r.inherits.forEach(e)):u.unknown_permissions.push(t)})),r(u)}catch(e){n(e)}}))}))}},{key:"setupApp",value:(t=U()(M.a.mark((function e(t,r,n){var o,i;return M.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o=this.getAccount(t),i=new tt(r,n),o.value[r]&&o.value[r].copyTo(i),o.value[r]=i;case 4:case"end":return e.stop()}}),e,this)}))),function(e,r,n){return t.apply(this,arguments)})},{key:"listenApps",value:function(e){return this.getAccount(e).generateKeys()}},{key:"listenAppManifest",value:function(e,t){var r=this;return K()(M.a.mark((function n(){var o,i,s,a,c,u,l,d;return M.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:o=r.getAccount(e),i=!0,s=!1,n.prev=3,c=q()(o.generate(t));case 5:return n.next=7,F()(c.next());case 7:return u=n.sent,i=u.done,n.next=11,F()(u.value);case 11:if(l=n.sent,i){n.next=24;break}if(d=l){n.next=19;break}return void(n.next=17);case 17:n.next=21;break;case 19:return n.next=21,d.cached_manifest;case 21:i=!0,n.next=5;break;case 24:n.next=30;break;case 26:n.prev=26,n.t0=n.catch(3),s=!0,a=n.t0;case 30:if(n.prev=30,n.prev=31,i||null==c.return){n.next=35;break}return n.next=35,F()(c.return());case 35:if(n.prev=35,!s){n.next=38;break}throw a;case 38:return n.finish(35);case 39:return n.finish(30);case 40:case"end":return n.stop()}}),n,null,[[3,26,30,40],[31,,35,39]])})))()}},{key:"listenAppDetails",value:function(e,t){var r=this;return K()(M.a.mark((function n(){var o,i,s,a,c,u,l,d;return M.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:o=r.getAccount(e),i=!0,s=!1,n.prev=3,c=q()(o.generate(t));case 5:return n.next=7,F()(c.next());case 7:return u=n.sent,i=u.done,n.next=11,F()(u.value);case 11:if(l=n.sent,i){n.next=24;break}if(d=l){n.next=19;break}return void(n.next=17);case 17:n.next=21;break;case 19:return n.next=21,{version:d.getVersion(),title:d.getTitle(),description:d.getDescription()};case 21:i=!0,n.next=5;break;case 24:n.next=30;break;case 26:n.prev=26,n.t0=n.catch(3),s=!0,a=n.t0;case 30:if(n.prev=30,n.prev=31,i||null==c.return){n.next=35;break}return n.next=35,F()(c.return());case 35:if(n.prev=35,!s){n.next=38;break}throw a;case 38:return n.finish(35);case 39:return n.finish(30);case 40:case"end":return n.stop()}}),n,null,[[3,26,30,40],[31,,35,39]])})))()}},{key:"setPermissions",value:function(e,t,r){if(!this.getAccount(e).value[t])throw new TypeError("App not registered on account");var n=this.known_apps[e].value[t];Object.keys(r).forEach((function(e){r[e]?(n.permissions.value.includes(e)||n.permissions.value.push(e),n.permissions.pushUpdate()):n.permissions.value.includes(e)&&(n.permissions.value.splice(n.permissions.value.indexOf(e),1),n.permissions.pushUpdate())}))}},{key:"listenPermissions",value:function(e,t){var r=this;return K()(M.a.mark((function n(){var o,i,s,a,c;return M.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:o=r.getAccount(e);case 1:if(s=null===(i=o.value[t])||void 0===i?void 0:i.permissions,a=o.generate(t),c=s&&s.generate(),a.next(),s&&c.next(),!s){n.next=12;break}return n.next=10,s.value;case 10:n.next=14;break;case 12:return n.next=14,[];case 14:return n.next=16,F()(Promise.race([a.next(),c.next()]));case 16:n.next=1;break;case 18:case"end":return n.stop()}}),n)})))()}},{key:"setAssociation",value:function(e,t,r){var n=this.getAssocTable(e);r?n.value[t]={to:r}:delete n.value[t]}},{key:"listenAssociation",value:function(e,t){return this.getAssocTable(e).generate(t)}},{key:"listenAssociations",value:function(e){return this.getAssocTable(e).generateMap()}},{key:"setupEntryChannel",value:function(e,t,r,n){var o=this,i=this.getAccount(e).value[t];if(!i)throw new TypeError("App has not been registered");this.log.info("Entering app ".concat(t," under account ").concat(e," via point ").concat(r));var s=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?et(Object(r),!0).forEach((function(t){R()(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):et(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({account_id:e,app_url:t},n),a=new MessageChannel,c=this.parent.getRpcChannel(a.port1,P.AccessPolicy.DENY),u=new Set,l=function e(r){var n=Ee[r];if(n){if(!u.has(n)){u.add(n),n.inherits.forEach(e);try{n.grantOn(c.access,s)}catch(e){o.log.warn("Failed to grant permission ".concat(r),e)}}}else o.log.warn("Permission ".concat(r," not known, but added to app ").concat(t))};i.permissions.value.forEach(l),l("a.services.request");var d,h=$(32,(function(e){return o.app_tokens.has(e)})),p=this,f=function(){p.app_tokens.delete(h),clearTimeout(d)};return d=setTimeout(f,3e4),this.app_tokens.set(h,{port:a.port2,context:s,clear:f}),{token:h,timeout:3e4}}},{key:"redeemEntryToken",value:function(e){var t=this.app_tokens.get(e);if(!t)throw new TypeError("Token does not exist or has expired");return t.clear(),{port:t.port,context:t.context}}}]),e}(),k()(Je.prototype,"fetchAndVerifyManifest",[Re,Ie],Object.getOwnPropertyDescriptor(Je.prototype,"fetchAndVerifyManifest"),Je.prototype),k()(Je.prototype,"setupApp",[ke,Pe,Te],Object.getOwnPropertyDescriptor(Je.prototype,"setupApp"),Je.prototype),k()(Je.prototype,"listenApps",[Oe,Ae],Object.getOwnPropertyDescriptor(Je.prototype,"listenApps"),Je.prototype),k()(Je.prototype,"listenAppManifest",[De,Ce],Object.getOwnPropertyDescriptor(Je.prototype,"listenAppManifest"),Je.prototype),k()(Je.prototype,"listenAppDetails",[xe,Me],Object.getOwnPropertyDescriptor(Je.prototype,"listenAppDetails"),Je.prototype),k()(Je.prototype,"setPermissions",[je,Ue,Ne],Object.getOwnPropertyDescriptor(Je.prototype,"setPermissions"),Je.prototype),k()(Je.prototype,"listenPermissions",[Fe,Le],Object.getOwnPropertyDescriptor(Je.prototype,"listenPermissions"),Je.prototype),k()(Je.prototype,"setAssociation",[Ke,Be,qe],Object.getOwnPropertyDescriptor(Je.prototype,"setAssociation"),Je.prototype),k()(Je.prototype,"listenAssociation",[$e,Ve],Object.getOwnPropertyDescriptor(Je.prototype,"listenAssociation"),Je.prototype),k()(Je.prototype,"listenAssociations",[Ge,He],Object.getOwnPropertyDescriptor(Je.prototype,"listenAssociations"),Je.prototype),k()(Je.prototype,"setupEntryChannel",[ze,We,Qe],Object.getOwnPropertyDescriptor(Je.prototype,"setupEntryChannel"),Je.prototype),k()(Je.prototype,"redeemEntryToken",[Ye,Xe],Object.getOwnPropertyDescriptor(Je.prototype,"redeemEntryToken"),Je.prototype),Je),versions:[{version:[0,1,0]}]}),Ut={type:"object",properties:{mxid:{type:"string"},token:{type:"string"},hs:{type:"string"},display_name:{type:"string"},avatar_base64:{type:"string"}},required:["mxid","token","hs"]},Nt=function(e){var t,r,n,o=null===(t=e.getLiveTimeline().getState("f").getStateEvents(de,""))||void 0===t||null===(r=t.event)||void 0===r||null===(n=r.content)||void 0===n?void 0:n.type;return"string"==typeof o?o:void 0},Ft=function(e,t,r){var n,o;return{id:e.roomId,name:e.name,canon_alias:e.getCanonicalAlias()||void 0,avatar_url:e.getAvatarUrl(t.client.getHomeserverUrl(),(null===(n=r.avatar)||void 0===n?void 0:n.width)||256,(null===(o=r.avatar)||void 0===o?void 0:o.height)||256,"scale",!1)||void 0,type:Nt(e)||void 0}},Lt=function(){function e(t,r){b()(this,e),R()(this,"client",void 0),R()(this,"room_list",new re),R()(this,"user_ad",new re),R()(this,"app_list_gen",void 0),R()(this,"app_gens",{}),this.parent=t,this.account_id=r}return S()(e,[{key:"getAdGenerator",value:function(e){return this.user_ad.generate(e)}},{key:"_processAppConfig",value:function(e,t){try{var r;if(this.parent.validateAppConfig(t),null===(r=this.parent.validateAppConfig.errors)||void 0===r?void 0:r.length){var n=new T.ValidationError(y()(this.parent.validateAppConfig.errors));throw this.parent.validateAppConfig.errors.length=0,n}}catch(e){return void this.parent.log.warn("Error processing app config ".concat(e))}var o=t;if(e===Object(le.sha256)(o.manifest_url).toLowerCase()){var i=new tt(o.manifest_url,o.cached_manifest);i.permissions.value=y()(o.permissions),this.parent.log.info("Matrix updated app ".concat(o.manifest_url," on account ").concat(this.account_id)),this.parent.apps_svc.pushApp(this.account_id,i)}else this.parent.log.warn("App ID had invalid hash for manifest URL")}},{key:"_setupRoomList",value:function(){var e=this;if(!this.client)throw new TypeError("Client undefined");var t=function(){var t=e.client.getRooms(),r=new Set;t.forEach((function(t){e.room_list.value[t.roomId]===t?e.room_list.pushUpdate(t.roomId):e.room_list.value[t.roomId]=t,r.add(t.roomId)})),Object.keys(e.room_list.value).forEach((function(t){r.has(t)||delete e.room_list.value[t]}))};this.client.on("Room",t),this.client.on("Room.name",t),this.client.on("RoomState.events",t),this.client.on("deleteRoom",t)}},{key:"onAppUpdate",value:function(e,t){if(this.client){var r=this.parent.apps_svc.getAccount(this.account_id).value[e];(r||t)&&(this.client.setAccountData("net.kb1rd.app.v0.".concat(Object(le.sha256)(e).toLowerCase()),r?r.toJSON():{}),this.parent.log.info("Updated account data for app ".concat(e," on account ").concat(this.account_id)))}}},{key:"_setupAppAdUpdater",value:function(){var e=this;this.app_list_gen=this.parent.apps_svc.listenApps(this.account_id),V(this.app_list_gen,(function(t){Object.keys(e.app_gens).forEach((function(r){t.includes(r)||(e.app_gens[r].detailgen.return(),e.app_gens[r].permgen.return(),delete e.app_gens[r],e.onAppUpdate(r,!0))})),t.forEach((function(t){e.app_gens[t]||(e.app_gens[t]={detailgen:e.parent.apps_svc.listenAppDetails(e.account_id,t),permgen:e.parent.apps_svc.listenPermissions(e.account_id,t)},V(e.app_gens[t].detailgen,(function(){return e.onAppUpdate(t,!1)})),V(e.app_gens[t].permgen,(function(){return e.onAppUpdate(t,!1)})))}))}))}},{key:"_setupAccountData",value:function(){var e=this;if(!this.client)throw new TypeError("Client undefined");this.client.on("accountData",(function(t){var r=t.getType();e.user_ad.value[r]=t.event.content}))}},{key:"createClient",value:function(e){return this.client=ue.createClient(e),this._setupRoomList(),this._setupAccountData(),this.client}},{key:"stopClient",value:function(){var e=this;this.client&&(this.client.stopClient(),delete this.client,Object.keys(this.room_list.value).forEach((function(t){return delete e.room_list.value[t]}))),this.app_list_gen&&this.app_list_gen.return(),Object.keys(this.app_gens).forEach((function(t){e.app_gens[t].detailgen.return(),e.app_gens[t].permgen.return(),delete e.app_gens[t]}))}},{key:"active",get:function(){return Boolean(this.client)}}]),e}(),Kt=C({id:["net","kb1rd","mxbindings"],service:(rt=P.RpcAddress(["v0","getHsUrl",void 0]),nt=P.RemapArguments(["drop","expand"]),ot=P.RpcAddress(["v0","fromToken",void 0]),it=P.RemapArguments(["drop","expand","pass"]),st=P.EnforceMethodArgSchema({type:"array",items:[{type:"string"},{type:"string"}],additionalItems:{type:"string"}}),at=P.RpcAddress(["v0","fromPass",void 0]),ct=P.RemapArguments(["drop","expand","pass"]),ut=P.EnforceMethodArgSchema({type:"array",items:[{type:"string"},{type:"string"}],additionalItems:{type:"string"}}),lt=P.RpcAddress(["v0",void 0,"start"]),dt=P.RemapArguments(["drop","expand"]),ht=P.RpcAddress(["v0",void 0,"stop"]),pt=P.RemapArguments(["drop","expand"]),ft=P.RpcAddress(["v0",void 0,"listenUserState"]),mt=P.RemapArguments(["drop","expand"]),gt=P.RpcAddress(["v0",void 0,"listenRoomList"]),vt=P.RemapArguments(["drop","expand"]),yt=P.EnforceMethodArgSchema({type:"array",items:[{type:"string"}],maxItems:2,additionalItems:{type:"object",properties:{avatar:{type:"object",properties:{width:{type:"number",minimum:1,maximum:4096},height:{type:"number",minimum:1,maximum:4096}},required:["width","height"]}}}}),_t=P.RpcAddress(["v0",void 0,"room",void 0,"listenDetails"]),bt=P.RemapArguments(["drop","expand","expand"]),Et=P.EnforceMethodArgSchema({type:"array",items:[{type:"string"},{type:"string"}],maxItems:2,additionalItems:{type:"object",properties:{avatar:{type:"object",properties:{width:{type:"number",minimum:1,maximum:4096},height:{type:"number",minimum:1,maximum:4096}},required:["width","height"]}}}}),St=P.RpcAddress(["v0",void 0,"account_data",void 0,"set"]),wt=P.RemapArguments(["drop","expand","expand"]),Rt=P.EnforceMethodArgSchema({type:"array",items:[{type:"string"},{type:"string"}],minItems:3}),It=P.RpcAddress(["v0",void 0,"account_data","listen"]),kt=P.RemapArguments(["drop","expand"]),Pt=P.RpcAddress(["v0",void 0,"account_data",void 0,"listen"]),Tt=P.RemapArguments(["drop","expand","expand"]),Ot=P.EnforceMethodArgSchema({type:"array",items:[{type:"string"},{type:"string"}]}),At=function(){function e(t,r){b()(this,e),R()(this,"account_svc",void 0),R()(this,"apps_svc",void 0),R()(this,"state_listeners",{}),R()(this,"instances",{}),R()(this,"validateAppConfig",void 0),this.parent=t,this.log=r,this.account_svc=t.getServiceDependency(["net","kb1rd","accounts"],[0,1]),this.apps_svc=t.getServiceDependency(["net","kb1rd","apps"],[0,1]),ue.request(t.request),r.warn("Note: The Matrix service changed the global request function used by the JS SDK. This is because the SDK does not support custom request functions for .well-known resolution."),this.validateAppConfig=this.apps_svc.validateAppConfig}var t,r,n,o,i,s,a,c;return S()(e,[{key:"getInstance",value:function(e){return this.instances[e]||(this.instances[e]=new Lt(this,e)),this.instances[e]}},{key:"getHsUrl",value:(c=U()(M.a.mark((function e(t){var r,n,o,i,s;return M.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((o=t.split(":")).shift(),t.startsWith("@")&&1===o.length){e.next=4;break}throw new TypeError("Invald mxid");case 4:return e.next=6,ue.AutoDiscovery.findClientConfig(o.join(":"));case 6:i=e.sent,(s=null===(r=i["m.homeserver"])||void 0===r?void 0:r.base_url)||(s="https://".concat(o.join(":"))),e.t0=null===(n=i["m.homeserver"])||void 0===n?void 0:n.state,e.next=e.t0===ue.AutoDiscovery.PROMPT?12:e.t0===ue.AutoDiscovery.FAIL_PROMPT?14:e.t0===ue.AutoDiscovery.FAIL_ERROR?16:20;break;case 12:return this.log.info("Well-known lookup for MXID ".concat(t," did not return HS URL. ")+"The returned domain will be the default (".concat(s,")")),e.abrupt("break",20);case 14:return this.log.warn("Well-known lookup for MXID ".concat(t," failed. The returned domain ")+"will be the default (".concat(s,")")),e.abrupt("break",20);case 16:if(this.log.error("Well-known lookup for MXID ".concat(t," critically failed. Error thrown")),!i["m.homeserver"].error){e.next=19;break}throw new Error("Matrix error: "+i["m.homeserver"].error);case 19:throw new Error("Unknown fatal error in .well-known discovery");case 20:return e.abrupt("return",s);case 21:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"fromToken",value:(a=U()(M.a.mark((function e(t,r,n){var o;return M.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n){e.next=4;break}return e.next=3,this.getHsUrl(t);case 3:n=e.sent;case 4:return e.next=6,this.account_svc.createAccount();case 6:return o=e.sent,this.account_svc.getAccount(o).storageSet("net.kb1rd.mxbindings.credentials",{mxid:t,token:r,hs:n}),e.abrupt("return",o);case 10:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return a.apply(this,arguments)})},{key:"fromPass",value:(s=U()(M.a.mark((function e(t,r,n){var o,i,s;return M.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n){e.next=4;break}return e.next=3,this.getHsUrl(t);case 3:n=e.sent;case 4:return e.next=6,ue.createClient(n).login("m.login.password",{user:t,password:r});case 6:if(o=e.sent,i=o.access_token,s=o.well_known,i){e.next=11;break}throw new Error("Response did not return access token");case 11:return s&&s["m.homeserver"]&&s["m.homeserver"].base_url&&(n=s["m.homeserver"].base_url),e.next=14,this.fromToken(t,i,n);case 14:return e.abrupt("return",e.sent);case 15:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return s.apply(this,arguments)})},{key:"start",value:(i=U()(M.a.mark((function e(t){var r,n,o,i,s,a,c=this;return M.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.getInstance(t).active){e.next=8;break}if((n=null===(r=this.state_listeners[t])||void 0===r?void 0:r.value)&&"INACTIVE"!==n&&"UNAUTHENTICATED"!==n){e.next=7;break}this.log.warn("Possible corrupt account state: Client is defined while state isinactive"),this.stop(t),e.next=8;break;case 7:return e.abrupt("return");case 8:if(o=this.account_svc.getAccount(t)){e.next=11;break}throw new TypeError("Account does not exist");case 11:return e.next=13,this.ensureAccountStateExists(t);case 13:return e.prev=13,e.next=16,o.storageGetSchema("net.kb1rd.mxbindings.credentials",Ut);case 16:i=e.sent,e.next=26;break;case 19:if(e.prev=19,e.t0=e.catch(13),!(e.t0 instanceof T.ValidationError)){e.next=25;break}throw new TypeError("User has no/corrupt credentials. Log the user in first");case 25:throw e.t0;case 26:return this.state_listeners[t].value="STARTING",s=this.getInstance(t),(a=s.createClient({userId:i.mxid,baseUrl:i.hs,accessToken:i.token,timelineSupport:!0,useAuthorizationHeader:!0,request:this.parent.request})).on("sync",(function(e){switch(e){case"PREPARED":case"SYNCING":return void(c.state_listeners[t].value="ACTIVE");case"ERROR":case"RECONNECTING":return void(c.state_listeners[t].value="OFFLINE");case"CATCHUP":return void(c.state_listeners[t].value="STARTING");case"STOPPED":return void(c.state_listeners[t].value="INACTIVE")}})),e.next=32,a.startClient({initialSyncLimit:10,lazyLoadMembers:!0});case 32:case"end":return e.stop()}}),e,this,[[13,19]])}))),function(e){return i.apply(this,arguments)})},{key:"stop",value:(o=U()(M.a.mark((function e(t){var r;return M.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureAccountStateExists(t);case 2:if(!(r=this.instances[t])){e.next=8;break}return e.next=6,r.stopClient();case 6:return this.state_listeners[t].value="INACTIVE",e.abrupt("return",!0);case 8:return e.abrupt("return",!1);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"ensureAccountStateExists",value:(n=U()(M.a.mark((function e(t){var r,n;return M.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.state_listeners[t]){e.next=12;break}return r=this.account_svc.getAccount(t),n=void 0,e.prev=3,e.next=6,r.storageGetSchema("net.kb1rd.mxbindings.credentials",Ut);case 6:n=e.sent,e.next=11;break;case 9:e.prev=9,e.t0=e.catch(3);case 11:this.state_listeners[t]=new te(n?"INACTIVE":"UNAUTHENTICATED");case 12:case"end":return e.stop()}}),e,this,[[3,9]])}))),function(e){return n.apply(this,arguments)})},{key:"updateAccountState",value:(r=U()(M.a.mark((function e(t,r){return M.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureAccountStateExists(t);case 2:r&&(this.state_listeners[t].value=r);case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return r.apply(this,arguments)})},{key:"listenUserState",value:function(e){var t=this;return K()(M.a.mark((function r(){var n,o,i,s,a,c,u,l,d;return M.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,F()(t.ensureAccountStateExists(e));case 2:if(n=t.account_svc.getAccount(e)){r.next=5;break}throw new TypeError("Account '".concat(e,"' does not exist"));case 5:o=!0,i=!1,r.prev=7,a=q()(t.state_listeners[e].generate());case 9:return r.next=11,F()(a.next());case 11:return c=r.sent,o=c.done,r.next=15,F()(c.value);case 15:if(u=r.sent,o){r.next=42;break}return l=u,d=void 0,r.prev=19,r.next=22,F()(n.storageGetSchema("net.kb1rd.mxbindings.credentials",Ut));case 22:d=r.sent,r.next=32;break;case 25:if(r.prev=25,r.t0=r.catch(19),!(r.t0 instanceof T.ValidationError)){r.next=31;break}d=void 0,r.next=32;break;case 31:throw r.t0;case 32:if(d){r.next=37;break}return r.next=35,{state:"UNAUTHENTICATED"};case 35:r.next=39;break;case 37:return r.next=39,{id:e,mxid:d.mxid,display_name:d.display_name||d.mxid,avatar:void 0,state:l};case 39:o=!0,r.next=9;break;case 42:r.next=48;break;case 44:r.prev=44,r.t1=r.catch(7),i=!0,s=r.t1;case 48:if(r.prev=48,r.prev=49,o||null==a.return){r.next=53;break}return r.next=53,F()(a.return());case 53:if(r.prev=53,!i){r.next=56;break}throw s;case 56:return r.finish(53);case 57:return r.finish(48);case 58:case"end":return r.stop()}}),r,null,[[7,44,48,58],[19,25],[49,,53,57]])})))()}},{key:"listenRoomList",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return K()(M.a.mark((function n(){var o,i,s,a,c,u,l,d;return M.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:o=t.getInstance(e),i=!0,s=!1,n.prev=3,c=M.a.mark((function e(){var t;return M.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=d,e.next=3,Object.keys(t).map((function(e){return t[e]})).map((function(e){return Ft(e,o,r)}));case 3:case"end":return e.stop()}}),e)})),u=q()(o.room_list.generateMap());case 6:return n.next=8,F()(u.next());case 8:return l=n.sent,i=l.done,n.next=12,F()(l.value);case 12:if(d=n.sent,i){n.next=18;break}return n.delegateYield(c(),"t0",15);case 15:i=!0,n.next=6;break;case 18:n.next=24;break;case 20:n.prev=20,n.t1=n.catch(3),s=!0,a=n.t1;case 24:if(n.prev=24,n.prev=25,i||null==u.return){n.next=29;break}return n.next=29,F()(u.return());case 29:if(n.prev=29,!s){n.next=32;break}throw a;case 32:return n.finish(29);case 33:return n.finish(24);case 34:case"end":return n.stop()}}),n,null,[[3,20,24,34],[25,,29,33]])})))()}},{key:"listenRoomDetails",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return K()(M.a.mark((function o(){var i,s,a,c,u,l,d,h;return M.a.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:i=r.getInstance(e),s=!0,a=!1,o.prev=3,u=q()(i.room_list.generate(t));case 5:return o.next=7,F()(u.next());case 7:return l=o.sent,s=l.done,o.next=11,F()(l.value);case 11:if(d=o.sent,s){o.next=19;break}return h=d,o.next=16,h&&Ft(h,i,n);case 16:s=!0,o.next=5;break;case 19:o.next=25;break;case 21:o.prev=21,o.t0=o.catch(3),a=!0,c=o.t0;case 25:if(o.prev=25,o.prev=26,s||null==u.return){o.next=30;break}return o.next=30,F()(u.return());case 30:if(o.prev=30,!a){o.next=33;break}throw c;case 33:return o.finish(30);case 34:return o.finish(25);case 35:case"end":return o.stop()}}),o,null,[[3,21,25,35],[26,,30,34]])})))()}},{key:"sendAccountData",value:(t=U()(M.a.mark((function e(t,r,n){var o,i;return M.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=this.getInstance(t),i=o.client){e.next=3;break}throw new TypeError("Client not set up");case 3:return e.next=5,i.setAccountData(r,n);case 5:case"end":return e.stop()}}),e,this)}))),function(e,r,n){return t.apply(this,arguments)})},{key:"listenAccountDataKeys",value:function(e){return this.getInstance(e).user_ad.generateKeys()}},{key:"listenAccountData",value:function(e,t){return this.getInstance(e).getAdGenerator(t)}}]),e}(),k()(At.prototype,"getHsUrl",[rt,nt],Object.getOwnPropertyDescriptor(At.prototype,"getHsUrl"),At.prototype),k()(At.prototype,"fromToken",[ot,it,st],Object.getOwnPropertyDescriptor(At.prototype,"fromToken"),At.prototype),k()(At.prototype,"fromPass",[at,ct,ut],Object.getOwnPropertyDescriptor(At.prototype,"fromPass"),At.prototype),k()(At.prototype,"start",[lt,dt],Object.getOwnPropertyDescriptor(At.prototype,"start"),At.prototype),k()(At.prototype,"stop",[ht,pt],Object.getOwnPropertyDescriptor(At.prototype,"stop"),At.prototype),k()(At.prototype,"listenUserState",[ft,mt],Object.getOwnPropertyDescriptor(At.prototype,"listenUserState"),At.prototype),k()(At.prototype,"listenRoomList",[gt,vt,yt],Object.getOwnPropertyDescriptor(At.prototype,"listenRoomList"),At.prototype),k()(At.prototype,"listenRoomDetails",[_t,bt,Et],Object.getOwnPropertyDescriptor(At.prototype,"listenRoomDetails"),At.prototype),k()(At.prototype,"sendAccountData",[St,wt,Rt],Object.getOwnPropertyDescriptor(At.prototype,"sendAccountData"),At.prototype),k()(At.prototype,"listenAccountDataKeys",[It,kt],Object.getOwnPropertyDescriptor(At.prototype,"listenAccountDataKeys"),At.prototype),k()(At.prototype,"listenAccountData",[Pt,Tt,Ot],Object.getOwnPropertyDescriptor(At.prototype,"listenAccountData"),At.prototype),At),versions:[{version:[0,3,0]}]}),Bt=function(){function e(t){b()(this,e),R()(this,"cache",{}),this.origin=t}var t;return S()(e,[{key:"get",value:function(e){return this.cache[e]&&Promise.resolve(this.cache[e])||this.origin.get(e)}},{key:"set",value:(t=U()(M.a.mark((function e(t,r){return M.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.origin.set(t,r);case 2:null==r?delete this.cache[t]:this.cache[t]=r;case 3:case"end":return e.stop()}}),e,this)}))),function(e,r){return t.apply(this,arguments)})}]),e}();function qt(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return $t(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return $t(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){throw e})),f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){a=!0,i=e})),f:function(){try{s||null==r.return||r.return()}finally{if(a)throw i}}}}function $t(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var Vt=function(e){return e.map((function(e){return e.includes(".")||e.includes("[")||e.includes("]")?"[".concat(e,"]"):e})).join(".")};function Gt(e,t){return e.length===t.length&&e.every((function(e,r){return t[r]===e}))}var Ht=(Dt=P.RpcAddress(["net","kb1rd","services","requestServices"]),Ct=P.RemapArguments(["drop","drop"]),xt=P.EnforceMethodArgSchema({type:"array",items:a.Schema}),Mt=function(){function e(t){var r=t.createLog,n=void 0===r?function(e){return c.getLogger(e)}:r,o=t.storage_backend,i=t.request;b()(this,e),R()(this,"ajv",new O.a),R()(this,"log",void 0),R()(this,"registry",new P.RpcHandlerRegistry),R()(this,"channels",new Map),R()(this,"services",new Set),R()(this,"services_active",new Set),R()(this,"service_instaces",new Map),R()(this,"createLog",void 0),R()(this,"storage_backend",void 0),R()(this,"request",void 0),R()(this,"validateMsg",void 0),this.request=i,this.createLog=n,this.storage_backend=new Bt(o),this.log=n("CORE"),this.log.info("Starting worker core..."),this.log.debug("Compiling schemas...");try{this.validateMsg=this.ajv.compile(P.RpcMessage.Schema)}catch(e){throw this.log.error("Failed to compile schema:",e),e}this.log.debug("Done compiling schemas"),this.log.debug("Registering services..."),this.registry.registerAll(this),this.registerService(ce),this.registerService(Kt),this.registerService(jt),this.log.debug("Done registering services"),this.log.info("Done starting worker core")}return S()(e,[{key:"getRpcChannel",value:function(e,t){var r=this,n=new P.RpcChannel((function(t,n){e.postMessage(t,n),r.log.debug("Sent message to handler ".concat(Vt(t.to)))}),t,this.registry);return e.onmessage=function(e){var t;if(r.validateMsg(e.data),null===(t=r.validateMsg.errors)||void 0===t?void 0:t.length){var o=new O.a.ValidationError(y()(r.validateMsg.errors));return r.validateMsg.errors.length=0,void r.log.warn("Received invalid message. Schema error:",o)}var i=e.data;r.log.debug("Received message to handler ".concat(Vt(i.to))),n.receive(i)},this.channels.set(e,n),n}},{key:"onconnect",value:function(e){this.getRpcChannel(e,P.AccessPolicy.ALLOW)}},{key:"ondisconnect",value:function(e){e.close(),this.channels.delete(e)}},{key:"onmessage",value:function(e){e.data instanceof MessagePort?(this.onconnect(e.data),e.origin?this.log.info("Connected to MessagePort provided by '".concat(e.origin,"'")):this.log.info("Connected to MessagePort provided by unknown origin")):e.origin?this.log.info("Invalid port addition message from '".concat(e.origin,"'")):this.log.info("Invalid port addition message from unknown origin")}},{key:"onmessageerror",value:function(e){this.log.warn("Message error from ".concat(e.origin))}},{key:"onoffline",value:function(){this.log.info("Browser reports network offline")}},{key:"ononline",value:function(){this.log.info("Browser reports network online")}},{key:"registerService",value:function(e){this.services.forEach((function(t){if(Gt(t.id,e.id))throw new TypeError("Service ".concat(Vt(e.id)," already registered"))}));var t=new Set;e.versions.forEach((function(r){var n=r.version;if(t.has(n[0]))throw new TypeError("Service ".concat(Vt(e.id)," has duplicate major versions"))})),this.services.add(e),this.log.debug("Registered service with ID ".concat(Vt(e.id)))}},{key:"setupServiceVersion",value:function(e,t){this.services.has(e)||this.registerService(e);var r,o=void 0,i=qt(e.versions);try{for(i.s();!(r=i.n()).done;){var s=r.value;s.version[0]===t[0]&&s.version[1]>=t[1]&&(o=s)}}catch(e){i.e(e)}finally{i.f()}if(o){if(this.services_active.has(o))return o.version;if(!this.service_instaces.has(e.service)){var a=this,c=new e.service(this,this.createLog(Vt(e.id)),{createChildLogger:function(t){return a.createLog(Vt(e.id)+"."+t)}});this.service_instaces.set(e.service,c),this.registry.registerAll(c),this.log.info("Set up service ".concat(Vt(e.id)))}return this.log.info("Set up service version ".concat(n.toString(o.version))),this.services_active.add(o),o.version}}},{key:"getService",value:function(e){var t=void 0;return this.services.forEach((function(r){Gt(e,r.id)&&(t=r)})),t}},{key:"getServiceDependency",value:function(e,t){var r,o,s=this.getService(e);if(!s)throw new TypeError("Service ".concat(Vt(e)," requested, but not found"));if(!this.setupServiceVersion(s,t)){throw new TypeError("Version ".concat((r=t,3===r.length?n.toString(r):i.toString(r))," or applicable for ").concat(Vt(s.id)," ")+"not found")}if(!s||!(o=this.service_instaces.get(s.service)))throw new TypeError("Service ".concat(Vt(e)," set up, but not found"));return o}},{key:"requestServices",value:function(){var e=this;function t(e){return 3===e.length?n.toString(e):i.toString(e)}for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return this.log.info("Recieved request for services "+o.map((function(e){var r=e.id,n=e.versions;return"".concat(Vt(r)," version (")+n.map((function(e){return t(e)})).join(" or ")+")"})).join(", ")),o.map((function(t){var r=t.id,n=t.versions,o=e.getService(r);if(!o)throw new TypeError("Service ".concat(Vt(r)," not registered"));var i=void 0;if(n.some((function(t){i=e.setupServiceVersion(o,t)})),!i)throw new TypeError("Unable to find suitable version for ".concat(Vt(r)));return{id:r,version:i}}))}}]),e}(),k()(Mt.prototype,"requestServices",[Dt,Ct,xt],Object.getOwnPropertyDescriptor(Mt.prototype,"requestServices"),Mt.prototype),Mt),zt={TRACE:p.a.magenta,DEBUG:p.a.cyan,INFO:p.a.blue,WARN:p.a.yellow,ERROR:p.a.red};d.a.reg(u.a);var Wt=new Ht({createLog:function(e){var t=u.a.getLogger(e);return t.setLevel("INFO"),function(e){d.a.apply(e,{format:function(e,t,r){return p.a.gray("["+r+"] ")+p.a.green(t)+" "+zt[e.toUpperCase()](e)+":"}})}(t),t},storage_backend:{get:function(e){return g.getItem(e)},set:function(e,t){return g.setItem(e,t).then()}},request:m.a.getRequest()});Wt.ononline();try{onoffline=function(){Wt.onoffline()},ononline=function(){Wt.ononline()}}catch(e){console.warn("Failed to set up worker online/offline listeners")}onconnect=null,onconnect=function(e){e.ports&&e.ports[0]&&Wt.onconnect(e.ports[0])}}])}));
//# sourceMappingURL=mx-host-core-worker-sharedworker.min.js.map